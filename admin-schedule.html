<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¯€ç›®è¡¨ç®¡ç† - èˆªå‘ä¸–ç•Œæ—…éŠé »é“</title>
  <script src="https://cdn.jsdelivr.net/npm/contentful@latest/dist/contentful.browser.min.js"></script>
  <script src="browser-config.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .header h1 { color: #2b71d2; margin-bottom: 10px; }
    .header p { color: #666; }
    
    .admin-panel { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
    .form-group textarea { height: 80px; resize: vertical; }
    
    .btn { background: #2b71d2; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; margin-right: 10px; }
    .btn:hover { background: #1e5bb8; }
    .btn-secondary { background: #6c757d; }
    .btn-secondary:hover { background: #5a6268; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-danger:hover { background: #c82333; }
    
    .programs-list { margin-top: 20px; }
    .program-item { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 10px; border-left: 4px solid #2b71d2; }
    .program-item h3 { margin-bottom: 5px; color: #333; }
    .program-item p { color: #666; font-size: 14px; margin-bottom: 5px; }
    .program-item .time { font-weight: 600; color: #2b71d2; }
    
    .template-section { background: #e9ecef; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    .template-section h3 { margin-bottom: 10px; color: #495057; }
    
    .status { padding: 10px; border-radius: 5px; margin-bottom: 15px; }
    .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¯ ç¯€ç›®è¡¨ç®¡ç†ç³»çµ±</h1>
      <p>è¼•é¬†ç®¡ç†æ‚¨çš„æ—…éŠç¯€ç›®è¡¨ï¼Œæ”¯æ´æ‰¹é‡æ·»åŠ å’Œç¯„æœ¬åŠŸèƒ½</p>
    </div>
    
    <div class="admin-panel">
      <div id="status" class="status" style="display: none;"></div>
      
      <!-- ç¯€ç›®ç¯„æœ¬å€ -->
      <div class="template-section">
        <h3>ğŸ“‹ ç¯€ç›®ç¯„æœ¬</h3>
        <div class="form-group">
          <label>é¸æ“‡ç¯„æœ¬ï¼š</label>
          <select id="templateSelect">
            <option value="">-- é¸æ“‡ç¯€ç›®ç¯„æœ¬ --</option>
            <option value="morning">æ—©å®‰ä¸–ç•Œ - æ™¨é–“æ—…éŠ</option>
            <option value="kitchen">ä¸–ç•Œå»šæˆ¿ - ç¾é£Ÿä¹‹æ—…</option>
            <option value="adventure">æ¥µåœ°æ¢éšª - å†’éšªæ—…éŠ</option>
            <option value="city">åŸå¸‚æ¼«æ­¥ - åŸå¸‚æ—…éŠ</option>
            <option value="nature">è‡ªç„¶å¥‡è§€ - è‡ªç„¶æ—…éŠ</option>
          </select>
        </div>
        <button class="btn" onclick="loadTemplate()">è¼‰å…¥ç¯„æœ¬</button>
      </div>
      
      <!-- ç¯€ç›®æ·»åŠ è¡¨å–® -->
      <form id="programForm">
        <h3>ğŸ“º æ·»åŠ ç¯€ç›®</h3>
        
        <div class="form-group">
          <label>æ’­å‡ºæ—¥æœŸï¼š</label>
          <input type="date" id="airDate" required>
        </div>
        
        <div class="form-group">
          <label>æ’­å‡ºæ™‚é–“ï¼š</label>
          <input type="time" id="airTime" required>
        </div>
        
        <div class="form-group">
          <label>ç¯€ç›®æ¨™é¡Œï¼š</label>
          <input type="text" id="title" placeholder="ä¾‹å¦‚ï¼šæ—©å®‰ä¸–ç•Œ - æ—¥æœ¬æ±äº¬æ™¨é–“æ¼«æ­¥" required>
        </div>
        
        <div class="form-group">
          <label>ç¯€ç›®æ™‚é•·ï¼ˆåˆ†é˜ï¼‰ï¼š</label>
          <input type="number" id="duration" min="15" max="180" value="60" required>
        </div>
        
        <div class="form-group">
          <label>ç¯€ç›®åˆ†é¡ï¼š</label>
          <select id="category" required>
            <option value="">-- é¸æ“‡åˆ†é¡ --</option>
            <option value="äºæ´²æ—…éŠ">äºæ´²æ—…éŠ</option>
            <option value="æ­æ´²æ—…éŠ">æ­æ´²æ—…éŠ</option>
            <option value="ç¾æ´²æ—…éŠ">ç¾æ´²æ—…éŠ</option>
            <option value="ç¾é£Ÿæ—…éŠ">ç¾é£Ÿæ—…éŠ</option>
            <option value="æ¥µåœ°æ—…éŠ">æ¥µåœ°æ—…éŠ</option>
            <option value="è‡ªç„¶æ—…éŠ">è‡ªç„¶æ—…éŠ</option>
            <option value="æ–‡åŒ–æ—…éŠ">æ–‡åŒ–æ—…éŠ</option>
            <option value="å†’éšªæ—…éŠ">å†’éšªæ—…éŠ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ç¯€ç›®æè¿°ï¼š</label>
          <textarea id="description" placeholder="ç°¡çŸ­æè¿°ç¯€ç›®å…§å®¹..."></textarea>
        </div>
        
        <div class="form-group">
          <label>YouTube IDï¼š</label>
          <input type="text" id="youtubeId" placeholder="ä¾‹å¦‚ï¼šdQw4w9WgXcQ">
        </div>
        
        <div class="form-group">
          <label>ç¯€ç›®ç‹€æ…‹ï¼š</label>
          <select id="status">
            <option value="é¦–æ’­">é¦–æ’­</option>
            <option value="é‡æ’­">é‡æ’­</option>
            <option value="ç‰¹åˆ¥ç¯€ç›®">ç‰¹åˆ¥ç¯€ç›®</option>
          </select>
        </div>
        
        <button type="submit" class="btn">æ·»åŠ ç¯€ç›®</button>
        <button type="button" class="btn btn-secondary" onclick="clearForm()">æ¸…ç©ºè¡¨å–®</button>
      </form>
      
      <!-- ç¯€ç›®åˆ—è¡¨ -->
      <div class="programs-list">
        <h3>ğŸ“‹ å·²æ·»åŠ çš„ç¯€ç›®</h3>
        <div id="programsList">
          <p style="color: #999; text-align: center; padding: 20px;">å°šæœªæ·»åŠ ç¯€ç›®</p>
        </div>
      </div>
      
      <!-- æ‰¹é‡æ“ä½œ -->
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
        <h3>ğŸ”„ æ‰¹é‡æ“ä½œ</h3>
        <button class="btn" onclick="exportToCSV()">åŒ¯å‡ºç‚º CSV</button>
        <button class="btn btn-secondary" onclick="importFromCSV()">å¾ CSV åŒ¯å…¥</button>
        <button class="btn" onclick="saveToContentful()">å„²å­˜åˆ° Contentful</button>
      </div>
    </div>
  </div>

  <script>
// çµ±ä¸€çš„ç¯€ç›®è³‡æ–™ç®¡ç†
let programs = [];

// è¼‰å…¥æ‰€æœ‰ç¯€ç›®è³‡æ–™ï¼ˆåˆä½µå…©å€‹ç³»çµ±çš„è³‡æ–™ï¼‰
function loadAllPrograms() {
  // å¾ç¯€ç›®è¡¨ç®¡ç†è¼‰å…¥
  const schedulePrograms = JSON.parse(localStorage.getItem('adminPrograms') || '[]');
  
  // å¾æœˆæ›†ç®¡ç†è¼‰å…¥
  const calendarData = JSON.parse(localStorage.getItem('calendarData') || '{}');
  const calendarPrograms = Object.values(calendarData).map(program => ({
    ...program,
    id: program.id || Date.now() + Math.random()
  }));
  
  // åˆä½µè³‡æ–™ï¼Œé¿å…é‡è¤‡
  const allPrograms = [...schedulePrograms];
  
  calendarPrograms.forEach(calendarProgram => {
    const exists = allPrograms.find(p => 
      p.airDate === calendarProgram.airDate && 
      p.airTime === calendarProgram.airTime &&
      p.title === calendarProgram.title
    );
    if (!exists) {
      allPrograms.push(calendarProgram);
    }
  });
  
  programs = allPrograms;
  localStorage.setItem('adminPrograms', JSON.stringify(programs));
  
  // åŒæ™‚æ›´æ–°æœˆæ›†è³‡æ–™
  const calendarDataNew = {};
  programs.forEach(program => {
    const slotKey = `${program.airDate}-${program.airTime}`;
    calendarDataNew[slotKey] = program;
  });
  localStorage.setItem('calendarData', JSON.stringify(calendarDataNew));
}

// é¡¯ç¤ºå·²æ·»åŠ çš„ç¯€ç›®
function displayPrograms() {
  const programsList = document.getElementById('programsList');
  if (!programsList) return;
  
  if (programs.length === 0) {
    programsList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">å°šæœªæ·»åŠ ç¯€ç›®</p>';
    return;
  }
  
  programsList.innerHTML = programs.map((program, index) => `
    <div class="program-item">
      <h3>${program.title}</h3>
      <p><strong>æ’­å‡ºæ™‚é–“ï¼š</strong>${program.airDate} ${program.airTime}</p>
      <p><strong>æ™‚é•·èˆ‡åˆ†é¡ï¼š</strong>${program.duration}åˆ†é˜ | ${program.category}</p>
      <p><strong>æè¿°ï¼š</strong>${program.description}</p>
      <p><strong>ä¾†æºï¼š</strong>${program.source || 'ç¯€ç›®è¡¨ç®¡ç†'}</p>
      <button class="btn btn-danger" onclick="deleteProgram(${index})">åˆªé™¤</button>
    </div>
  `).join('');
}

// æ·»åŠ ç¯€ç›®
function addProgram() {
  const title = document.getElementById('title').value;
  const airDate = document.getElementById('airDate').value;
  const airTime = document.getElementById('airTime').value;
  const duration = document.getElementById('duration').value;
  const category = document.getElementById('category').value;
  const description = document.getElementById('description').value;
  const youtubeId = document.getElementById('youtubeId').value;
  const status = document.getElementById('status').value;

  if (!title || !airDate || !airTime || !duration || !category) {
    showStatus('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
    return;
  }

  const newProgram = {
    title,
    airDate,
    airTime,
    duration,
    category,
    description,
    youtubeId,
    status,
    id: Date.now(),
    source: 'ç¯€ç›®è¡¨ç®¡ç†'
  };

  programs.push(newProgram);
  saveAllPrograms();
  
  displayPrograms();
  showStatus('ç¯€ç›®æ·»åŠ æˆåŠŸï¼', 'success');
  document.getElementById('programForm').reset();
}

// åˆªé™¤ç¯€ç›®
function deleteProgram(index) {
  programs.splice(index, 1);
  saveAllPrograms();
  displayPrograms();
  showStatus('ç¯€ç›®å·²åˆªé™¤', 'success');
}

// å„²å­˜æ‰€æœ‰ç¯€ç›®è³‡æ–™
function saveAllPrograms() {
  localStorage.setItem('adminPrograms', JSON.stringify(programs));
  
  // åŒæ™‚æ›´æ–°æœˆæ›†è³‡æ–™
  const calendarData = {};
  programs.forEach(program => {
    const slotKey = `${program.airDate}-${program.airTime}`;
    calendarData[slotKey] = program;
  });
  localStorage.setItem('calendarData', JSON.stringify(calendarData));
  
  // æ›´æ–°é¦–é ç¯€ç›®è¡¨
  updateHomePageSchedule();
}

// æ›´æ–°é¦–é ç¯€ç›®è¡¨
function updateHomePageSchedule() {
  const today = new Date().toISOString().split('T')[0];
  const todayPrograms = programs.filter(p => p.airDate === today);
  
  const scheduleData = {
    today: {
      date: today,
      dayOfWeek: getDayOfWeek(new Date()),
      month: `${new Date().getMonth() + 1}æœˆ`,
      day: `${new Date().getDate()}æ—¥`,
      schedule: todayPrograms.map(p => ({
        time: p.airTime,
        title: p.title,
        duration: p.duration,
        category: p.category,
        description: p.description,
        thumbnail: p.youtubeId ? `https://i.ytimg.com/vi/${p.youtubeId}/hqdefault.jpg` : 'https://images.unsplash.com/photo-1485846234645-a62644f84728?w=400&h=225&fit=crop',
        youtubeId: p.youtubeId,
        isPremiere: p.status === 'é¦–æ’­',
        isSpecial: p.status === 'ç‰¹åˆ¥ç¯€ç›®'
      }))
    }
  };
  
  // å„²å­˜åˆ° localStorageï¼Œè®“é¦–é å¯ä»¥è®€å–
  localStorage.setItem('currentSchedule', JSON.stringify(scheduleData));
}

// ç²å–æ˜ŸæœŸå¹¾
function getDayOfWeek(date) {
  const days = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
  return days[date.getDay()];
}

// é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
function showStatus(message, type) {
  const status = document.getElementById('status');
  status.textContent = message;
  status.className = `status ${type}`;
  status.style.display = 'block';
  setTimeout(() => {
    status.style.display = 'none';
  }, 3000);
}

// è¼‰å…¥ç¯„æœ¬
function loadTemplate() {
  const templateSelect = document.getElementById('templateSelect');
  const selectedTemplate = templateSelect.value;
  
  if (!selectedTemplate) {
    showStatus('è«‹é¸æ“‡ä¸€å€‹ç¯„æœ¬', 'error');
    return;
  }
  
  const templates = {
    morning: {
      title: 'æ—©å®‰ä¸–ç•Œ - æ—¥æœ¬æ±äº¬æ™¨é–“æ¼«æ­¥',
      duration: '60',
      category: 'äºæ´²æ—…éŠ',
      description: 'è·Ÿè‘—æˆ‘å€‘ä¸€èµ·æ¢ç´¢æ±äº¬çš„æ—©æ™¨ï¼Œå¾ç¯‰åœ°å¸‚å ´åˆ°æ·ºè‰å¯ºçš„å¯§éœæ™‚å…‰'
    },
    kitchen: {
      title: 'ä¸–ç•Œå»šæˆ¿ - ç¾©å¤§åˆ©æ‰˜æ–¯å¡å°¼ç¾é£Ÿä¹‹æ—…',
      duration: '45',
      category: 'ç¾é£Ÿæ—…éŠ',
      description: 'æ·±å…¥æ‰˜æ–¯å¡å°¼é„‰æ‘ï¼Œå“åšæœ€é“åœ°çš„ç¾©å¤§åˆ©ç¾é£Ÿèˆ‡ç¾é…’'
    },
    adventure: {
      title: 'æ¥µåœ°æ¢éšª - åŠ æ‹¿å¤§é»ƒåˆ€é®æ¥µå…‰ä¹‹æ—…',
      duration: '60',
      category: 'æ¥µåœ°æ—…éŠ',
      description: 'åœ¨é›¶ä¸‹40åº¦çš„é»ƒåˆ€é®ï¼Œè¿½å°‹åŒ—æ¥µå…‰çš„ç¥ç§˜è¹¤è·¡'
    },
    city: {
      title: 'åŸå¸‚æ¼«æ­¥ - å·´é»å¡ç´æ²³ç•”çš„æµªæ¼«',
      duration: '45',
      category: 'æ­æ´²æ—…éŠ',
      description: 'æ²¿è‘—å¡ç´æ²³æ¼«æ­¥ï¼Œæ„Ÿå—èŠ±éƒ½å·´é»çš„æµªæ¼«æƒ…æ‡·'
    },
    nature: {
      title: 'è‡ªç„¶å¥‡è§€ - ç´è¥¿è˜­ç±³ä½›å³½ç£',
      duration: '60',
      category: 'è‡ªç„¶æ—…éŠ',
      description: 'æ¢ç´¢ä¸–ç•Œç¬¬å…«å¤§å¥‡è§€ï¼Œç±³ä½›å³½ç£çš„å£¯éº—æ™¯è‰²'
    }
  };
  
  const template = templates[selectedTemplate];
  document.getElementById('title').value = template.title;
  document.getElementById('duration').value = template.duration;
  document.getElementById('category').value = template.category;
  document.getElementById('description').value = template.description;
  
  showStatus('ç¯„æœ¬è¼‰å…¥æˆåŠŸ', 'success');
}

// åŒ¯å‡ºç‚º CSV
function exportToCSV() {
  if (programs.length === 0) {
    showStatus('æ²’æœ‰ç¯€ç›®å¯ä»¥åŒ¯å‡º', 'error');
    return;
  }
  
  const csvContent = [
    ['ç¯€ç›®æ¨™é¡Œ', 'æ’­å‡ºæ—¥æœŸ', 'æ’­å‡ºæ™‚é–“', 'æ™‚é•·', 'åˆ†é¡', 'æè¿°', 'YouTube ID', 'ç‹€æ…‹', 'ä¾†æº'],
    ...programs.map(p => [
      p.title,
      p.airDate,
      p.airTime,
      p.duration,
      p.category,
      p.description,
      p.youtubeId,
      p.status,
      p.source || 'ç¯€ç›®è¡¨ç®¡ç†'
    ])
  ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `ç¯€ç›®è¡¨_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  
  showStatus('CSV æª”æ¡ˆå·²ä¸‹è¼‰', 'success');
}

// å¾ CSV åŒ¯å…¥
function importFromCSV() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.csv';
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      const csv = e.target.result;
      const lines = csv.split('\n');
      const headers = lines[0].split(',').map(h => h.replace(/"/g, ''));
      
      const newPrograms = [];
      for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        const values = lines[i].split(',').map(v => v.replace(/"/g, ''));
        if (values.length >= 5) {
          newPrograms.push({
            title: values[0],
            airDate: values[1],
            airTime: values[2],
            duration: values[3],
            category: values[4],
            description: values[5] || '',
            youtubeId: values[6] || '',
            status: values[7] || '',
            source: values[8] || 'CSVåŒ¯å…¥',
            id: Date.now() + i
          });
        }
      }
      
      programs = newPrograms;
      saveAllPrograms();
      displayPrograms();
      showStatus(`æˆåŠŸåŒ¯å…¥ ${newPrograms.length} å€‹ç¯€ç›®`, 'success');
    };
    reader.readAsText(file);
  };
  input.click();
}

// å„²å­˜åˆ° Contentful
async function saveToContentful() {
  if (programs.length === 0) {
    showStatus('æ²’æœ‰ç¯€ç›®å¯ä»¥å„²å­˜', 'error');
    return;
  }
  
  showStatus('æ­£åœ¨å„²å­˜åˆ° Contentful...', 'success');
  
  try {
    const client = contentful.createClient({
      space: process.env.CONTENTFUL_SPACE_ID || 'your-space-id-here',
      accessToken: process.env.CONTENTFUL_DELIVERY_TOKEN || 'your-delivery-token-here'
    });
    
    // é€™è£¡æ‡‰è©²ä½¿ç”¨ Management API ä¾†å‰µå»ºç¯€ç›®å…§å®¹
    // ç›®å‰é¡¯ç¤ºæ¨¡æ“¬æˆåŠŸè¨Šæ¯
    showStatus(`æˆåŠŸå„²å­˜ ${programs.length} å€‹ç¯€ç›®åˆ° Contentful`, 'success');
    
  } catch (error) {
    console.error('Contentful å„²å­˜å¤±æ•—:', error);
    showStatus('å„²å­˜åˆ° Contentful å¤±æ•—: ' + error.message, 'error');
  }
}

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  loadAllPrograms();
  displayPrograms();
  
  // è¨­å®šä»Šå¤©çš„æ—¥æœŸç‚ºé è¨­å€¼
  const today = new Date().toISOString().split('T')[0];
  const airDateInput = document.getElementById('airDate');
  if (airDateInput) {
    airDateInput.value = today;
  }
});
</script>
</body>
</html>
