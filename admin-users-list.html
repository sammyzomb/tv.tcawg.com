<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å“¡åˆ—è¡¨ - æ—…éŠå½±ç‰‡ç®¡ç†ç³»çµ±</title>
    
    <!-- AdminLTE 3 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #f4f6f9;
            min-height: 100vh;
        }

        .content-wrapper {
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            overflow: hidden;
        }

        .header {
            background: #007bff;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.75rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            margin: 0;
        }

        .user-info {
            background: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dee2e6;
        }

        .user-details {
            color: #495057;
            font-weight: 600;
            font-size: 1rem;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .nav-btn:hover {
            background: #0056b3;
        }

        .nav-btn.secondary {
            background: #6c757d;
        }

        .nav-btn.secondary:hover {
            background: #5a6268;
        }

        .content {
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            border-left: 4px solid #007bff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .admin-table {
            background: white;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        }

        .table-header {
            background: #343a40;
            color: white;
            padding: 12px 15px;
            display: grid;
            grid-template-columns: 50px 1fr 200px 120px 100px 150px;
            gap: 15px;
            font-weight: 600;
            align-items: center;
        }

        .admin-row {
            padding: 15px 20px;
            display: grid;
            grid-template-columns: 50px 1fr 200px 120px 100px 150px;
            gap: 15px;
            border-bottom: 1px solid #eee;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .admin-row:hover {
            background-color: #f8f9fa;
        }

        .admin-row:last-child {
            border-bottom: none;
        }

        .admin-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #007bff;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .admin-info {
            display: flex;
            flex-direction: column;
        }

        .admin-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .admin-email {
            color: #666;
            font-size: 0.9rem;
        }

        .role-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
        }

        .role-super {
            background: #dc3545;
            color: white;
        }

        .role-admin {
            background: #17a2b8;
            color: white;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
        }

        .status-active {
            background: #51cf66;
            color: white;
        }

        .status-inactive {
            background: #adb5bd;
            color: white;
        }

        .admin-actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: #ffc107;
            color: #212529;
        }

        .btn-edit:hover {
            background: #e0a800;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .btn-toggle {
            background: #6c757d;
            color: white;
        }

        .btn-toggle:hover {
            background: #5a6268;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }

        @media (max-width: 768px) {
            .table-header,
            .admin-row {
                grid-template-columns: 1fr;
                gap: 10px;
                text-align: left;
            }

            .admin-actions {
                justify-content: flex-start;
            }
        }

        /* å¯†ç¢¼ä¿®æ”¹å°è©±æ¡†æ¨£å¼ */
        .password-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .password-dialog-content {
            background: white;
            padding: 30px;
            border-radius: 4px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .password-dialog h3 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1.4rem;
        }

        .password-dialog p {
            color: #666;
            margin-bottom: 20px;
        }

        .password-dialog .form-group {
            margin-bottom: 20px;
        }

        .password-dialog label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .password-dialog input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .password-dialog input:focus {
            outline: none;
            border-color: #2b71d2;
            box-shadow: 0 0 0 3px rgba(43, 113, 210, 0.1);
        }

        .password-strength {
            margin-top: 8px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .strength-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }

        .strength-fill {
            height: 100%;
            transition: all 0.3s ease;
            border-radius: 4px;
        }

        .strength-weak { background: #dc3545; width: 25%; }
        .strength-medium { background: #ffc107; width: 50%; }
        .strength-strong { background: #28a745; width: 75%; }
        .strength-very-strong { background: #20c997; width: 100%; }

        .password-requirements {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }

        .password-requirements h4 {
            color: #1565c0;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .password-requirements ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .password-requirements li {
            margin-bottom: 5px;
            color: #333;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .password-requirements li::before {
            content: 'âœ“';
            color: #28a745;
            font-weight: bold;
        }

        .dialog-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .btn-primary {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* å¯†ç¢¼æŒ‰éˆ•æ¨£å¼ */
        .btn-password {
            background: #17a2b8;
            color: white;
        }

        .btn-password:hover {
            background: #138496;
            color: white;
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <div class="content-wrapper">
    <div class="container">
        <div class="header">
                    <h1><i class="fas fa-users"></i> ç®¡ç†å“¡åˆ—è¡¨</h1>
            <p>ç®¡ç†ç³»çµ±æ‰€æœ‰ç®¡ç†å“¡å¸³è™Ÿ</p>
        </div>

        <div class="user-info">
            <div class="user-details" id="userDetails">
                è¼‰å…¥ä¸­...
            </div>
            <div class="nav-buttons">
                <button class="nav-btn" onclick="openSyncFixTool()" style="background: #ffc107; color: #212529;"><i class="fas fa-tools"></i> åŒæ­¥ä¿®å¾©</button>
                <button class="nav-btn" onclick="openAddAdminModal()"><i class="fas fa-user-plus"></i> æ–°å¢ç®¡ç†å“¡</button>
                <a href="admin-dashboard.html" class="nav-btn secondary"><i class="fas fa-arrow-left"></i> è¿”å›ä¸»æ§å°</a>
            </div>
        </div>

        <div class="content">
            <div class="message" id="message"></div>

            <!-- çµ±è¨ˆè³‡è¨Š -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalAdmins">0</div>
                    <div class="stat-label">ç¸½ç®¡ç†å“¡æ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeAdmins">0</div>
                    <div class="stat-label">æ´»èºç®¡ç†å“¡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="superAdmins">0</div>
                    <div class="stat-label">è¶…ç´šç®¡ç†å“¡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="regularAdmins">0</div>
                    <div class="stat-label">æ™®é€šç®¡ç†å“¡</div>
                </div>
            </div>

            <!-- ç®¡ç†å“¡åˆ—è¡¨ -->
            <div class="admin-table">
                <div class="table-header">
                    <div>é ­åƒ</div>
                    <div>ç®¡ç†å“¡è³‡è¨Š</div>
                    <div>é›»å­éƒµä»¶</div>
                    <div>è§’è‰²</div>
                    <div>ç‹€æ…‹</div>
                    <div>æ“ä½œ</div>
                </div>
                <div id="adminList">
                    <!-- ç®¡ç†å“¡åˆ—è¡¨å°‡ç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE 3 -->
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB5MLyG5H1sCflHFU7WeKQCmC0Ft5TIqjM",
            authDomain: "tv-tcawg-com.firebaseapp.com",
            projectId: "tv-tcawg-com",
            storageBucket: "tv-tcawg-com.firebasestorage.app",
            messagingSenderId: "313251141126",
            appId: "1:313251141126:web:88ef97ce28798c0a2e9587",
            measurementId: "G-83Z5VTRTZH"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // è¨­å®šå…¨åŸŸè®Šæ•¸
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseApp = app;
        window.firebase9Loaded = true;
        
        console.log('Firebase å·²åˆå§‹åŒ–');
    </script>

    <!-- ç®¡ç†å“¡å¸³è™Ÿæœå‹™ -->
    <script src="admin-accounts-service.js"></script>

    <script>
        // åˆå§‹åŒ–ç®¡ç†å“¡æœå‹™
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–ç®¡ç†å“¡æœå‹™
            const initAdminService = () => {
                if (window.AdminAccountsService && !window.adminAccountsService) {
                    window.adminAccountsService = new AdminAccountsService();
                    console.log('ç®¡ç†å“¡å¸³è™Ÿæœå‹™å·²åˆå§‹åŒ–');
                        // è¼‰å…¥ç®¡ç†å“¡æ•¸æ“š
                        loadAllAdmins();
                } else if (!window.AdminAccountsService) {
                    // å¦‚æœæœå‹™é‚„æ²’è¼‰å…¥ï¼Œç­‰å¾…ä¸€ä¸‹å†è©¦
                    setTimeout(initAdminService, 500);
                }
            };
            
            // é–‹å§‹åˆå§‹åŒ–
            initAdminService();
        });

        // æª¢æŸ¥è¶…ç´šç®¡ç†å“¡æ¬Šé™
        function checkSuperAdminAuth() {
            const user = JSON.parse(sessionStorage.getItem('adminUser') || 'null');
            
            if (!user) {
                window.location.href = 'admin-login.html';
                return false;
            }
            
            if (user.role !== 'super_admin') {
                alert('âš ï¸ æ¬Šé™ä¸è¶³\n\nåªæœ‰è¶…ç´šç®¡ç†å“¡æ‰èƒ½ç®¡ç†å…¶ä»–ç®¡ç†å“¡ã€‚');
                window.location.href = 'admin-dashboard.html';
                return false;
            }
            
            return user;
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(text, type = 'success') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }
        }

        // è¼‰å…¥æ‰€æœ‰ç®¡ç†å“¡
        async function loadAllAdmins() {
            const currentUser = checkSuperAdminAuth();
            if (!currentUser) return;

            // è¼‰å…¥æœ¬åœ°ç®¡ç†å“¡ï¼ˆlocalStorageï¼‰
            const systemAdmins = JSON.parse(localStorage.getItem('system_admins') || '[]');
            console.log('å¾ localStorage è¼‰å…¥çš„ç®¡ç†å“¡:', systemAdmins.length, 'å€‹');
            
            // ç¢ºå®šè¶…ç´šç®¡ç†å“¡çš„åç¨±
            let superAdminName = currentUser.name || 'Sammy Zomb';
            if (currentUser.email === 'sammyzomb@gmail.com') {
                superAdminName = 'Sammy Zomb';
            }
            
            // å»ºç«‹ç®¡ç†å“¡é›†åˆï¼ˆä½¿ç”¨ Map é¿å…é‡è¤‡ï¼‰
            const adminMap = new Map();
            
            // 1. å…ˆæ·»åŠ è¶…ç´šç®¡ç†å“¡ï¼ˆç¡¬ç·¨ç¢¼ï¼‰
            adminMap.set(currentUser.email, {
                email: currentUser.email,
                name: superAdminName,
                role: 'super_admin',
                status: 'active',
                createdAt: '2024-01-01T00:00:00Z',
                createdBy: 'system',
                isSystem: true // æ¨™è¨˜ç‚ºç³»çµ±ç®¡ç†å“¡ï¼Œä¸å¯åˆªé™¤
            });
            
            // 2. æ·»åŠ æœ¬åœ°ç®¡ç†å“¡ï¼ˆlocalStorageï¼‰
            systemAdmins.forEach(admin => {
                if (admin.email && admin.email !== 'undefined' && admin.email.trim() !== '') {
                    // å¦‚æœ email å·²å­˜åœ¨ï¼Œè·³éï¼ˆè¶…ç´šç®¡ç†å“¡å„ªå…ˆï¼‰
                    if (!adminMap.has(admin.email)) {
                        adminMap.set(admin.email, {
                            ...admin,
                            isSystem: false
                        });
                    }
                }
            });

            // 3. å„ªå…ˆè®€å–æœ¬åœ° admin-accounts.jsonï¼ˆåŒ…å«æœ€æ–°è³‡æ–™ï¼‰
            try {
                console.log('ğŸ“„ å˜—è©¦è®€å–æœ¬åœ° admin-accounts.json...');
                const localResponse = await fetch('admin-accounts.json?t=' + Date.now());
                if (localResponse.ok) {
                    const localData = await localResponse.json();
                    console.log(`âœ… å¾æœ¬åœ°æª”æ¡ˆè®€å–åˆ° ${localData.accounts.length} å€‹ç®¡ç†å“¡`);
                    
                    // æ·»åŠ æœ¬åœ°æª”æ¡ˆä¸­çš„ç®¡ç†å“¡
                    localData.accounts.forEach(admin => {
                        if (admin.email && admin.email !== 'undefined' && admin.email.trim() !== '') {
                            const existing = adminMap.get(admin.email);
                            if (existing && existing.isSystem) {
                                // ä¿ç•™ç³»çµ±ç®¡ç†å“¡æ¨™è¨˜ï¼Œä½†æ›´æ–°å…¶ä»–è³‡æ–™
                                adminMap.set(admin.email, {
                                    ...admin,
                                    isSystem: existing.isSystem
                                });
                            } else if (!existing) {
                                // æ–°å¢ç®¡ç†å“¡
                                adminMap.set(admin.email, {
                                    ...admin,
                                    isSystem: false
                                });
                            } else {
                                // æ›´æ–°ç¾æœ‰ç®¡ç†å“¡
                                adminMap.set(admin.email, {
                                    ...admin,
                                    isSystem: existing.isSystem
                                });
                            }
                        }
                    });
                }
            } catch (e) {
                console.warn('ç„¡æ³•è®€å–æœ¬åœ°æª”æ¡ˆ:', e);
            }

            try {
                // 4. å˜—è©¦å¾ Firebase/GitHub è¼‰å…¥ç®¡ç†å“¡æ•¸æ“šï¼ˆå¼·åˆ¶åˆ·æ–°å¿«å–ï¼‰
                if (window.adminAccountsService) {
                    console.log('å¾æœå‹™è¼‰å…¥ç®¡ç†å“¡æ•¸æ“šï¼ˆå¼·åˆ¶åˆ·æ–°ï¼‰...');
                    // å¼·åˆ¶åˆ·æ–°å¿«å–
                    await window.adminAccountsService.forceRefresh();
                    const accountsData = await window.adminAccountsService.fetchAccountsData();
                    const remoteAdmins = accountsData.accounts || [];
                    
                    console.log('å¾é ç«¯è¼‰å…¥çš„ç®¡ç†å“¡:', remoteAdmins.length, 'å€‹');
                    
                    // æ·»åŠ é ç«¯ç®¡ç†å“¡ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                    remoteAdmins.forEach(admin => {
                        if (admin.email && admin.email !== 'undefined' && admin.email.trim() !== '') {
                            // å¦‚æœ email å·²å­˜åœ¨ï¼Œæ›´æ–°è³‡æ–™ï¼ˆé ç«¯å„ªå…ˆï¼Œä½†ä¿ç•™ isSystem æ¨™è¨˜ï¼‰
                            const existing = adminMap.get(admin.email);
                            if (existing && existing.isSystem) {
                                // ä¿ç•™ç³»çµ±ç®¡ç†å“¡æ¨™è¨˜
                                adminMap.set(admin.email, {
                                    ...admin,
                                    isSystem: existing.isSystem
                                });
                            } else if (!existing) {
                                // æ–°å¢ç®¡ç†å“¡
                                adminMap.set(admin.email, {
                                    ...admin,
                                    isSystem: false
                                });
                            } else {
                                // æ›´æ–°ç¾æœ‰ç®¡ç†å“¡ï¼ˆé ç«¯è³‡æ–™å„ªå…ˆï¼‰
                                adminMap.set(admin.email, {
                                    ...admin,
                                    isSystem: existing.isSystem
                                });
                            }
                        }
                    });
                }
            } catch (error) {
                console.warn('å¾é ç«¯è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°æ•¸æ“š:', error);
            }

            // è½‰æ› Map ç‚ºé™£åˆ—
            const allAdmins = Array.from(adminMap.values());
            
            // éæ¿¾æ‰æœ‰å•é¡Œçš„å¸³è™Ÿ
                    const validAdmins = allAdmins.filter(admin => {
                        const isValid = admin.email && admin.email !== 'undefined' && admin.email.trim() !== '';
                        if (!isValid) {
                            console.warn('éæ¿¾æ‰ç„¡æ•ˆå¸³è™Ÿ:', admin);
                        }
                        return isValid;
                    });
            
            // ç¢ºä¿è¶…ç´šç®¡ç†å“¡çš„åç¨±æ­£ç¢º
            validAdmins.forEach(admin => {
                if (admin.email === 'sammyzomb@gmail.com' && admin.role === 'super_admin') {
                    admin.name = 'Sammy Zomb';
                }
            });
            
            console.log('ç¸½ç®¡ç†å“¡æ•¸é‡:', validAdmins.length);
            console.log('ç®¡ç†å“¡åˆ—è¡¨:', validAdmins.map(admin => ({ 
                email: admin.email, 
                name: admin.name, 
                role: admin.role,
                status: admin.status,
                source: admin.isSystem ? 'ç³»çµ±' : 'å…¶ä»–'
            })));
            
            // æ›´æ–°çµ±è¨ˆ
            updateStats(validAdmins);

            // æ¸²æŸ“ç®¡ç†å“¡åˆ—è¡¨
            renderAdminList(validAdmins);
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStats(admins) {
            const totalAdmins = admins.length;
            const activeAdmins = admins.filter(admin => admin.status === 'active').length;
            const superAdmins = admins.filter(admin => admin.role === 'super_admin').length;
            const regularAdmins = admins.filter(admin => admin.role === 'admin').length;

            document.getElementById('totalAdmins').textContent = totalAdmins;
            document.getElementById('activeAdmins').textContent = activeAdmins;
            document.getElementById('superAdmins').textContent = superAdmins;
            document.getElementById('regularAdmins').textContent = regularAdmins;
        }

        // æ¸²æŸ“ç®¡ç†å“¡åˆ—è¡¨
        function renderAdminList(admins) {
            const adminListDiv = document.getElementById('adminList');
            
            if (admins.length === 0) {
                adminListDiv.innerHTML = `
                    <div class="empty-state">
                        <h3>æš«ç„¡ç®¡ç†å“¡</h3>
                        <p>é»æ“Šä¸Šæ–¹"æ–°å¢ç®¡ç†å“¡"æŒ‰éˆ•ä¾†å‰µå»ºç¬¬ä¸€å€‹ç®¡ç†å“¡</p>
                    </div>
                `;
                return;
            }

            adminListDiv.innerHTML = admins.map(admin => {
                const initials = (admin.name && admin.name.charAt) ? admin.name.charAt(0).toUpperCase() : 
                                (admin.email && admin.email.charAt) ? admin.email.charAt(0).toUpperCase() : '?';
                const roleText = admin.role === 'super_admin' ? 'è¶…ç´šç®¡ç†å“¡' : 'æ™®é€šç®¡ç†å“¡';
                const roleClass = admin.role === 'super_admin' ? 'role-super' : 'role-admin';
                const statusText = admin.status === 'active' ? 'å•Ÿç”¨' : 'åœç”¨';
                const statusClass = admin.status === 'active' ? 'status-active' : 'status-inactive';
                
                return `
                    <div class="admin-row">
                        <div class="admin-avatar">${initials}</div>
                        <div class="admin-info">
                            <div class="admin-name">${admin.name || 'æœªè¨­å®šå§“å'}</div>
                            <div class="admin-email">${admin.email}</div>
                        </div>
                        <div>${admin.email}</div>
                        <div>
                            <span class="role-badge ${roleClass}">${roleText}</span>
                        </div>
                        <div>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="admin-actions">
                            ${!admin.isSystem ? `
                                <button class="action-btn btn-edit" onclick="editAdmin('${admin.email}')">
                                    âœï¸ ç·¨è¼¯
                                </button>
                                <button class="action-btn btn-password" onclick="changeAdminPassword('${admin.email}')">
                                    ğŸ” å¯†ç¢¼
                                </button>
                                <button class="action-btn btn-toggle" onclick="toggleAdminStatus('${admin.email}')">
                                    ${admin.status === 'active' ? 'åœç”¨' : 'å•Ÿç”¨'}
                                </button>
                                <button class="action-btn btn-delete" onclick="deleteAdmin('${admin.email}')">
                                    ğŸ—‘ï¸ åˆªé™¤
                                </button>
                            ` : `
                                <span style="color: #666; font-size: 0.8rem;">ç³»çµ±å¸³è™Ÿ</span>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ç·¨è¼¯ç®¡ç†å“¡
        function editAdmin(email) {
            const systemAdmins = JSON.parse(localStorage.getItem('system_admins') || '[]');
            const admin = systemAdmins.find(a => a.email === email);
            
            if (!admin) {
                showMessage('æ‰¾ä¸åˆ°è©²ç®¡ç†å“¡', 'error');
                return;
            }

            const newName = prompt('è«‹è¼¸å…¥æ–°çš„å§“å:', admin.name);
            if (newName === null) return; // ç”¨æˆ¶å–æ¶ˆ

            if (newName.trim() === '') {
                showMessage('å§“åä¸èƒ½ç‚ºç©º', 'error');
                return;
            }

            // æ›´æ–°ç®¡ç†å“¡è³‡è¨Š
            admin.name = newName.trim();
            admin.updatedAt = new Date().toISOString();
            
            // å„²å­˜æ›´æ–°
            localStorage.setItem('system_admins', JSON.stringify(systemAdmins));
            
            showMessage(`âœ… ç®¡ç†å“¡ ${admin.email} è³‡è¨Šæ›´æ–°æˆåŠŸ`);
            loadAllAdmins(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
        }

        // ä¿®æ”¹ç®¡ç†å“¡å¯†ç¢¼
        async function changeAdminPassword(email) {
            console.log('ä¿®æ”¹å¯†ç¢¼æŒ‰éˆ•è¢«é»æ“Šï¼Œç›®æ¨™å¸³è™Ÿ:', email);
            
            try {
                // é¦–å…ˆå˜—è©¦å¾ Firebase ç²å–ç®¡ç†å“¡è³‡æ–™
                let admin = null;
                if (window.adminAccountsService) {
                    console.log('å˜—è©¦å¾ Firebase ç²å–ç®¡ç†å“¡è³‡æ–™...');
                    const accountsData = await window.adminAccountsService.fetchAccountsData();
                    console.log('æ‰€æœ‰å¸³è™Ÿè³‡æ–™:', accountsData.accounts);
                    admin = accountsData.accounts.find(a => a.email === email);
                    console.log('å¾ Firebase æ‰¾åˆ°çš„ç®¡ç†å“¡:', admin);
                }
                
                // å¦‚æœ Firebase æ‰¾ä¸åˆ°ï¼Œå˜—è©¦æœ¬åœ°è³‡æ–™
                if (!admin) {
                    console.log('Firebase æ‰¾ä¸åˆ°ï¼Œå˜—è©¦æœ¬åœ°è³‡æ–™...');
                    const systemAdmins = JSON.parse(localStorage.getItem('system_admins') || '[]');
                    console.log('æœ¬åœ°ç®¡ç†å“¡è³‡æ–™:', systemAdmins);
                    admin = systemAdmins.find(a => a.email === email);
                    console.log('å¾æœ¬åœ°æ‰¾åˆ°çš„ç®¡ç†å“¡:', admin);
                }
                
                // å¦‚æœé‚„æ˜¯æ‰¾ä¸åˆ°ï¼Œå˜—è©¦å¾ç•¶å‰é¡¯ç¤ºçš„å¸³è™Ÿåˆ—è¡¨ä¸­æŸ¥æ‰¾
                if (!admin) {
                    console.log('æœ¬åœ°ä¹Ÿæ‰¾ä¸åˆ°ï¼Œå˜—è©¦å¾ç•¶å‰é¡¯ç¤ºçš„å¸³è™Ÿåˆ—è¡¨ä¸­æŸ¥æ‰¾...');
                    // é€™è£¡æˆ‘å€‘éœ€è¦å¾é é¢ä¸Šå·²ç¶“è¼‰å…¥çš„å¸³è™Ÿä¸­æŸ¥æ‰¾
                    const currentAdmins = JSON.parse(localStorage.getItem('admin_accounts_backup') || '{}');
                    if (currentAdmins.accounts) {
                        admin = currentAdmins.accounts.find(a => a.email === email);
                        console.log('å¾å‚™ä»½ä¸­æ‰¾åˆ°çš„ç®¡ç†å“¡:', admin);
                    }
                }
                
                if (!admin) {
                    showMessage('æ‰¾ä¸åˆ°è©²ç®¡ç†å“¡', 'error');
                    return;
                }

                // å‰µå»ºå¯†ç¢¼ä¿®æ”¹å°è©±æ¡†
                const passwordDialog = document.createElement('div');
                passwordDialog.className = 'password-dialog';
                passwordDialog.innerHTML = `
                    <div class="password-dialog-content">
                        <h3>ğŸ” ä¿®æ”¹å¯†ç¢¼ - ${admin.name || admin.email}</h3>
                        <p>ç‚ºç®¡ç†å“¡ ${admin.email} è¨­å®šæ–°å¯†ç¢¼</p>
                        
                        <div class="form-group">
                            <label for="newPassword">æ–°å¯†ç¢¼ *</label>
                            <input type="password" id="newPassword" placeholder="è‡³å°‘6å€‹å­—ç¬¦ï¼ŒåŒ…å«å¤§å°å¯«å­—æ¯å’Œæ•¸å­—" 
                                   oninput="checkPasswordStrength(this.value)">
                            <div class="password-strength" id="passwordStrength" style="display: none;">
                                <small>å¯†ç¢¼å¼·åº¦ï¼š<span id="strengthText">å¼±</span></small>
                                <div class="strength-bar">
                                    <div class="strength-fill" id="strengthFill"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirmPassword">ç¢ºèªæ–°å¯†ç¢¼ *</label>
                            <input type="password" id="confirmPassword" placeholder="å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼"
                                   oninput="checkPasswordMatchForChange()">
                            <div id="passwordMatchMessageChange" style="margin-top: 5px; font-size: 12px; min-height: 18px;"></div>
                        </div>
                        
                        <div class="password-requirements">
                            <h4>ğŸ”’ å¯†ç¢¼è¦æ±‚</h4>
                            <ul>
                                <li>è‡³å°‘ 6 å€‹å­—ç¬¦</li>
                                <li>åŒ…å«å¤§å¯«å­—æ¯ (A-Z)</li>
                                <li>åŒ…å«å°å¯«å­—æ¯ (a-z)</li>
                                <li>åŒ…å«æ•¸å­— (0-9)</li>
                            </ul>
                        </div>
                        
                        <div class="dialog-buttons">
                            <button class="btn btn-secondary" onclick="closePasswordDialog()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="confirmPasswordChange('${email}')">ç¢ºèªä¿®æ”¹</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(passwordDialog);
                
                // é¡¯ç¤ºå°è©±æ¡†
                setTimeout(() => {
                    passwordDialog.style.display = 'flex';
                }, 100);
                
            } catch (error) {
                console.error('ä¿®æ”¹å¯†ç¢¼æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showMessage('ä¿®æ”¹å¯†ç¢¼æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message, 'error');
            }
        }

        // æª¢æŸ¥å¯†ç¢¼å¼·åº¦
        function checkPasswordStrength(password) {
            const strengthDiv = document.getElementById('passwordStrength');
            const strengthText = document.getElementById('strengthText');
            const strengthFill = document.getElementById('strengthFill');
            
            if (!password) {
                strengthDiv.style.display = 'none';
                return;
            }
            
            strengthDiv.style.display = 'block';
            
            let score = 0;
            
            // é•·åº¦æª¢æŸ¥ï¼ˆè‡³å°‘ 6 å€‹å­—ç¬¦ï¼‰
            if (password.length >= 6) score += 1;
            if (password.length >= 10) score += 1;
            
            // å­—ç¬¦é¡å‹æª¢æŸ¥ï¼ˆå¿…é ˆåŒ…å«å¤§å°å¯«å’Œæ•¸å­—ï¼‰
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);
            
            if (hasUpperCase) score += 1;
            if (hasLowerCase) score += 1;
            if (hasNumbers) score += 1;
            
            // è¤‡é›œåº¦æª¢æŸ¥ï¼ˆåŒæ™‚åŒ…å«å¤§å°å¯«å’Œæ•¸å­—ï¼‰
            if (password.length >= 6 && hasUpperCase && hasLowerCase && hasNumbers) {
                score += 1;
            }
            
            // è¨­å®šå¼·åº¦ç­‰ç´š
            let strength, className;
            if (score <= 2) {
                strength = 'å¼±';
                className = 'strength-weak';
            } else if (score <= 4) {
                strength = 'ä¸­ç­‰';
                className = 'strength-medium';
            } else if (score <= 5) {
                strength = 'å¼·';
                className = 'strength-strong';
            } else {
                strength = 'éå¸¸å¼·';
                className = 'strength-very-strong';
            }
            
            strengthText.textContent = strength;
            strengthFill.className = `strength-fill ${className}`;
        }
        
        // æª¢æŸ¥å¯†ç¢¼æ˜¯å¦ä¸€è‡´ï¼ˆç”¨æ–¼ä¿®æ”¹å¯†ç¢¼ï¼‰
        function checkPasswordMatchForChange() {
            const password = document.getElementById('newPassword').value;
            const passwordConfirm = document.getElementById('confirmPassword').value;
            const messageDiv = document.getElementById('passwordMatchMessageChange');
            
            if (passwordConfirm.length === 0) {
                messageDiv.innerHTML = '';
                return;
            }
            
            if (password === passwordConfirm) {
                messageDiv.innerHTML = '<span style="color: #28a745;">âœ“ å¯†ç¢¼ä¸€è‡´</span>';
                document.getElementById('confirmPassword').style.borderColor = '#28a745';
            } else {
                messageDiv.innerHTML = '<span style="color: #dc3545;">âœ— å¯†ç¢¼ä¸ä¸€è‡´</span>';
                document.getElementById('confirmPassword').style.borderColor = '#dc3545';
            }
        }

        // ç¢ºèªå¯†ç¢¼ä¿®æ”¹
        async function confirmPasswordChange(email) {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // é©—è­‰å¯†ç¢¼é•·åº¦ï¼ˆè‡³å°‘ 6 å€‹å­—ç¬¦ï¼‰
            if (newPassword.length < 6) {
                showMessage('å¯†ç¢¼è‡³å°‘éœ€è¦ 6 å€‹å­—ç¬¦', 'error');
                return;
            }
            
            // é©—è­‰å¯†ç¢¼æ˜¯å¦ä¸€è‡´
            if (newPassword !== confirmPassword) {
                showMessage('å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´', 'error');
                return;
            }
            
            // é©—è­‰å¯†ç¢¼å¼·åº¦ï¼ˆå¿…é ˆåŒ…å«å¤§å°å¯«å­—æ¯å’Œæ•¸å­—ï¼‰
            const hasUpperCase = /[A-Z]/.test(newPassword);
            const hasLowerCase = /[a-z]/.test(newPassword);
            const hasNumbers = /\d/.test(newPassword);
            
            if (!hasUpperCase) {
                showMessage('å¯†ç¢¼å¿…é ˆåŒ…å«è‡³å°‘ä¸€å€‹å¤§å¯«å­—æ¯ (A-Z)', 'error');
                return;
            }
            
            if (!hasLowerCase) {
                showMessage('å¯†ç¢¼å¿…é ˆåŒ…å«è‡³å°‘ä¸€å€‹å°å¯«å­—æ¯ (a-z)', 'error');
                return;
            }
            
            if (!hasNumbers) {
                showMessage('å¯†ç¢¼å¿…é ˆåŒ…å«è‡³å°‘ä¸€å€‹æ•¸å­— (0-9)', 'error');
                return;
            }
            
            try {
                console.log('é–‹å§‹æ›´æ–°å¯†ç¢¼:', email);
                
                // é¦–å…ˆå˜—è©¦æ›´æ–° Firebase
                if (window.adminAccountsService) {
                    console.log('å˜—è©¦æ›´æ–° Firebase å¯†ç¢¼...');
                    
                    // ç²å–å¸³è™Ÿè³‡æ–™
                    const accountsData = await window.adminAccountsService.fetchAccountsData();
                    const admin = accountsData.accounts.find(a => a.email === email);
                    
                    if (admin) {
                        // é›œæ¹Šæ–°å¯†ç¢¼
                        const hashedPassword = await window.adminAccountsService.hashPassword(newPassword);
                        
                        // æ›´æ–°å¯†ç¢¼é›œæ¹Š
                        admin.password_hash = hashedPassword;
                        admin.updatedAt = new Date().toISOString();
                        
                        // ç´” Firebase æ¨¡å¼ï¼Œä¸å„²å­˜æœ¬åœ°å‚™ä»½
                        
                        // åŒæ­¥åˆ° Firebase
                        const syncResult = await window.adminAccountsService.syncToFirebase();
                        if (syncResult) {
                            console.log('Firebase å¯†ç¢¼æ›´æ–°æˆåŠŸ');
                            showMessage(`âœ… ç®¡ç†å“¡ ${email} å¯†ç¢¼ä¿®æ”¹æˆåŠŸ (å·²åŒæ­¥åˆ° Firebase)`);
                        } else {
                            console.warn('Firebase åŒæ­¥å¤±æ•—ï¼Œä½†æœ¬åœ°å·²æ›´æ–°');
                            showMessage(`âœ… ç®¡ç†å“¡ ${email} å¯†ç¢¼ä¿®æ”¹æˆåŠŸ (æœ¬åœ°æ›´æ–°)`);
                        }
                        
                        closePasswordDialog();
                        loadAllAdmins(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
                        return;
                    }
                }
                
                // å‚™ç”¨æ–¹æ¡ˆï¼šæ›´æ–°æœ¬åœ°è³‡æ–™
                console.log('ä½¿ç”¨æœ¬åœ°å‚™ç”¨æ–¹æ¡ˆæ›´æ–°å¯†ç¢¼...');
                const systemAdmins = JSON.parse(localStorage.getItem('system_admins') || '[]');
                const admin = systemAdmins.find(a => a.email === email);
                
                if (admin) {
                    admin.password = newPassword;
                    admin.updatedAt = new Date().toISOString();
                    localStorage.setItem('system_admins', JSON.stringify(systemAdmins));
                    
                    // è¨˜éŒ„å¯†ç¢¼ä¿®æ”¹æ­·å²
                    const passwordHistory = JSON.parse(localStorage.getItem('password_history') || '[]');
                    const currentUser = JSON.parse(sessionStorage.getItem('adminUser') || '{}');
                    passwordHistory.push({
                        email: admin.email,
                        role: admin.role,
                        changedAt: new Date().toISOString(),
                        changedBy: currentUser.email || 'system'
                    });
                    localStorage.setItem('password_history', JSON.stringify(passwordHistory));
                    
                    showMessage(`âœ… ç®¡ç†å“¡ ${admin.email} å¯†ç¢¼ä¿®æ”¹æˆåŠŸ (æœ¬åœ°æ›´æ–°)`);
                    closePasswordDialog();
                    loadAllAdmins(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
                } else {
                    showMessage('æ‰¾ä¸åˆ°è©²ç®¡ç†å“¡', 'error');
                }
                
            } catch (error) {
                console.error('å¯†ç¢¼ä¿®æ”¹å¤±æ•—:', error);
                showMessage('å¯†ç¢¼ä¿®æ”¹å¤±æ•—: ' + error.message, 'error');
            }
        }

        // é—œé–‰å¯†ç¢¼ä¿®æ”¹å°è©±æ¡†
        function closePasswordDialog() {
            const dialog = document.querySelector('.password-dialog');
            if (dialog) {
                dialog.remove();
            }
        }

        // åˆ‡æ›ç®¡ç†å“¡ç‹€æ…‹
        async function toggleAdminStatus(email) {
            try {
                // å˜—è©¦å¾ Firebase æ›´æ–°ç‹€æ…‹
                if (window.adminAccountsService) {
                    console.log('å¾ Firebase æ›´æ–°ç®¡ç†å“¡ç‹€æ…‹:', email);
                    const result = await window.adminAccountsService.updateAdminStatus(email);
                    if (result) {
                        showMessage(`âœ… ç®¡ç†å“¡ ${email} ç‹€æ…‹å·²æ›´æ–°`);
                        loadAllAdmins(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
                        return;
                    }
                }
            } catch (error) {
                console.warn('å¾ Firebase æ›´æ–°ç‹€æ…‹å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°æ›´æ–°:', error);
            }

            // å‚™ç”¨æ–¹æ¡ˆï¼šæœ¬åœ°æ›´æ–°
            const systemAdmins = JSON.parse(localStorage.getItem('system_admins') || '[]');
            const admin = systemAdmins.find(a => a.email === email);
            
            if (!admin) {
                showMessage('æ‰¾ä¸åˆ°è©²ç®¡ç†å“¡', 'error');
                return;
            }

            const newStatus = admin.status === 'active' ? 'inactive' : 'active';
            const action = newStatus === 'active' ? 'å•Ÿç”¨' : 'åœç”¨';
            
            if (!confirm(`ç¢ºå®šè¦${action}ç®¡ç†å“¡ ${admin.email} å—ï¼Ÿ`)) {
                return;
            }

            admin.status = newStatus;
            admin.updatedAt = new Date().toISOString();
            
            localStorage.setItem('system_admins', JSON.stringify(systemAdmins));
            
            showMessage(`âœ… ç®¡ç†å“¡ ${admin.email} å·²${action}`);
            loadAllAdmins(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
        }

        // åˆªé™¤ç®¡ç†å“¡
        async function deleteAdmin(email) {
            if (!confirm(`âš ï¸ ç¢ºå®šè¦åˆªé™¤ç®¡ç†å“¡ ${email} å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼`)) {
                return;
            }

            try {
                // å˜—è©¦å¾ Firebase åˆªé™¤
                if (window.adminAccountsService) {
                    console.log('å¾ Firebase åˆªé™¤ç®¡ç†å“¡:', email);
                    const result = await window.adminAccountsService.deleteAdminAccount(email);
                    if (result) {
                        showMessage(`âœ… ç®¡ç†å“¡ ${email} å·²å¾ Firebase åˆªé™¤`);
                        loadAllAdmins(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
                        return;
                    }
                }
            } catch (error) {
                console.warn('å¾ Firebase åˆªé™¤å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°åˆªé™¤:', error);
            }

            // å‚™ç”¨æ–¹æ¡ˆï¼šæœ¬åœ°åˆªé™¤
            let systemAdmins = JSON.parse(localStorage.getItem('system_admins') || '[]');
            const originalLength = systemAdmins.length;
            
            systemAdmins = systemAdmins.filter(admin => admin.email !== email);
            
            if (systemAdmins.length === originalLength) {
                showMessage('æ‰¾ä¸åˆ°è©²ç®¡ç†å“¡', 'error');
                return;
            }

            localStorage.setItem('system_admins', JSON.stringify(systemAdmins));
            
            showMessage(`âœ… ç®¡ç†å“¡ ${email} å·²å¾æœ¬åœ°åˆªé™¤`);
            loadAllAdmins(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
        }

        // é–‹å•ŸåŒæ­¥ä¿®å¾©å·¥å…·
        function openSyncFixTool() {
            // å‰µå»ºæ¨¡æ…‹æ¡†
            const modal = document.createElement('div');
            modal.className = 'password-dialog';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="password-dialog-content" style="max-width: 800px;">
                    <h3>ğŸ”§ åŒæ­¥ä¿®å¾©å·¥å…·</h3>
                    <p>ä¿®å¾©ç®¡ç†å“¡å¸³è™ŸåŒæ­¥å•é¡Œï¼Œç¢ºä¿è·¨è¨­å‚™è³‡æ–™ä¸€è‡´æ€§</p>
                    
                    <div style="margin: 20px 0;">
                        <button class="btn btn-primary" onclick="startSyncFix()" style="margin-right: 10px;">ğŸš€ é–‹å§‹ä¿®å¾©</button>
                        <button class="btn btn-secondary" onclick="syncToFirebase()" style="margin-right: 10px; background: #ff9800;">ğŸ”¥ åŒæ­¥åˆ° Firebase</button>
                        <button class="btn btn-secondary" onclick="syncToGitHub()" style="margin-right: 10px;">â˜ï¸ åŒæ­¥åˆ° GitHub</button>
                        <button class="btn btn-secondary" onclick="testSystem()" style="margin-right: 10px;">ğŸ§ª æ¸¬è©¦ç³»çµ±</button>
                        <button class="btn btn-secondary" onclick="clearCache()">ğŸ§¹ æ¸…é™¤å¿«å–</button>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4>ğŸ“Š ç³»çµ±ç‹€æ…‹</h4>
                        <div id="syncStatus" style="padding: 10px; background: #f8f9fa; border-radius: 5px; margin: 10px 0;">
                            ç­‰å¾…æ“ä½œ...
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4>ğŸ”¥ Firestore å¸³è™Ÿåˆ—è¡¨</h4>
                        <div id="firestoreAccounts" style="max-height: 200px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            é»æ“Šã€Œé–‹å§‹ä¿®å¾©ã€æŸ¥çœ‹ Firestore ä¸­çš„å¸³è™Ÿ
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4>ğŸ“ æ“ä½œæ—¥èªŒ</h4>
                        <div id="fixLog" style="background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; white-space: pre-wrap;">ç­‰å¾…æ“ä½œ...\n</div>
                    </div>
                    
                    <div class="dialog-buttons">
                        <button class="btn btn-secondary" onclick="this.closest('.password-dialog').remove()">é—œé–‰</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            setupSyncFixTool();
        }

        // è¨­ç½®åŒæ­¥ä¿®å¾©å·¥å…·
        function setupSyncFixTool() {
            const logArea = document.getElementById('fixLog');
            const statusArea = document.getElementById('syncStatus');
            const accountsArea = document.getElementById('firestoreAccounts');
            
            // ç¶å®šäº‹ä»¶
            window.startSyncFix = async function() {
                log('ğŸš€ é–‹å§‹ä¿®å¾©ç®¡ç†å“¡åŒæ­¥å•é¡Œ...');
                try {
                    // æª¢æŸ¥ç®¡ç†å“¡æœå‹™æ˜¯å¦å·²åˆå§‹åŒ–
                    if (!window.adminAccountsService) {
                        log('åˆå§‹åŒ–ç®¡ç†å“¡æœå‹™...');
                        if (window.AdminAccountsService) {
                            window.adminAccountsService = new AdminAccountsService();
                            log('âœ… ç®¡ç†å“¡æœå‹™åˆå§‹åŒ–æˆåŠŸ');
                        } else {
                            log('âŒ ç®¡ç†å“¡æœå‹™é¡åˆ¥æœªè¼‰å…¥');
                            updateStatus('error', 'ç®¡ç†å“¡æœå‹™æœªè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                            return;
                        }
                    } else {
                        log('âœ… ç®¡ç†å“¡æœå‹™å·²è¼‰å…¥');
                    }
                    
                    // æª¢æŸ¥æ‰€æœ‰è³‡æ–™ä¾†æº
                    log('\nğŸ“Š æª¢æŸ¥æ‰€æœ‰è³‡æ–™ä¾†æº...');
                    
                    // 1. æª¢æŸ¥ localStorage çš„ system_admins
                    const systemAdmins = JSON.parse(localStorage.getItem('system_admins') || '[]');
                    log(`ğŸ“¦ localStorage (system_admins): ${systemAdmins.length} å€‹ç®¡ç†å“¡`);
                    if (systemAdmins.length > 0) {
                        systemAdmins.forEach((admin, index) => {
                            log(`   ${index + 1}. ${admin.name || 'æœªå‘½å'} (${admin.email})`);
                        });
                    }
                    
                    // 2. æª¢æŸ¥ localStorage çš„ admin_accounts_backup
                    const backupData = localStorage.getItem('admin_accounts_backup');
                    if (backupData) {
                        try {
                            const backup = JSON.parse(backupData);
                            const backupAccounts = backup.accounts || [];
                            log(`ğŸ’¾ localStorage (admin_accounts_backup): ${backupAccounts.length} å€‹ç®¡ç†å“¡`);
                            if (backupAccounts.length > 0) {
                                backupAccounts.forEach((admin, index) => {
                                    log(`   ${index + 1}. ${admin.name || 'æœªå‘½å'} (${admin.email})`);
                                });
                            }
                        } catch (e) {
                            log(`âš ï¸ æœ¬åœ°å‚™ä»½è³‡æ–™è§£æå¤±æ•—: ${e.message}`);
                        }
                    } else {
                        log('ğŸ’¾ localStorage (admin_accounts_backup): ç„¡å‚™ä»½è³‡æ–™');
                    }
                    
                    // 3. å¾æœå‹™è®€å–ç®¡ç†å“¡è³‡æ–™ï¼ˆGitHubï¼‰
                    log('\nğŸŒ å¾ GitHub æœå‹™è®€å–ç®¡ç†å“¡è³‡æ–™...');
                    const accountsData = await window.adminAccountsService.fetchAccountsData();
                    const remoteAccounts = accountsData.accounts || [];
                    log(`âœ… å¾ GitHub è®€å–åˆ° ${remoteAccounts.length} å€‹ç®¡ç†å“¡å¸³è™Ÿ`);
                    if (remoteAccounts.length > 0) {
                        remoteAccounts.forEach((admin, index) => {
                            log(`   ${index + 1}. ${admin.name || 'æœªå‘½å'} (${admin.email}) - ${admin.role}`);
                        });
                    }
                    
                    // 4. åˆä½µæ‰€æœ‰ä¾†æº
                    log('\nğŸ”„ åˆä½µæ‰€æœ‰è³‡æ–™ä¾†æº...');
                    const adminMap = new Map();
                    
                    // æ·»åŠ é ç«¯ç®¡ç†å“¡ï¼ˆGitHubï¼‰
                    remoteAccounts.forEach(admin => {
                        if (admin.email && admin.email.trim() !== '') {
                            adminMap.set(admin.email, {
                                ...admin,
                                source: 'GitHub'
                            });
                        }
                    });
                    
                    // æ·»åŠ æœ¬åœ°ç®¡ç†å“¡ï¼ˆsystem_adminsï¼‰
                    systemAdmins.forEach(admin => {
                        if (admin.email && admin.email.trim() !== '') {
                            if (!adminMap.has(admin.email)) {
                                adminMap.set(admin.email, {
                                    ...admin,
                                    source: 'localStorage'
                                });
                            }
                        }
                    });
                    
                    const allAccounts = Array.from(adminMap.values());
                    log(`âœ… åˆä½µå¾Œç¸½å…± ${allAccounts.length} å€‹ç®¡ç†å“¡`);
                    
                    // é¡¯ç¤ºå¸³è™Ÿåˆ—è¡¨
                    displayFirestoreAccounts(allAccounts);
                    
                    log('\nâœ… ä¿®å¾©å®Œæˆï¼ç®¡ç†å“¡ç³»çµ±ç¾åœ¨æ‡‰è©²å¯ä»¥æ­£å¸¸å·¥ä½œäº†');
                    log('è«‹é‡æ–°æ•´ç†é é¢æŸ¥çœ‹å®Œæ•´çš„ç®¡ç†å“¡åˆ—è¡¨');
                    updateStatus('success', `ä¿®å¾©å®Œæˆï¼æ‰¾åˆ° ${allAccounts.length} å€‹ç®¡ç†å“¡ï¼ˆGitHub: ${remoteAccounts.length}, æœ¬åœ°: ${systemAdmins.length}ï¼‰`);
                    
                } catch (error) {
                    log('âŒ ä¿®å¾©å¤±æ•—: ' + error.message);
                    console.error('ä¿®å¾©éŒ¯èª¤è©³æƒ…:', error);
                    updateStatus('error', 'ä¿®å¾©å¤±æ•—: ' + error.message);
                }
            };
            
            window.syncToFirebase = async function() {
                log('ğŸ”¥ é–‹å§‹åŒæ­¥ç®¡ç†å“¡åˆ° Firebase Firestore...');
                try {
                    if (!window.adminAccountsService) {
                        log('âŒ ç®¡ç†å“¡æœå‹™æœªè¼‰å…¥');
                        updateStatus('error', 'ç®¡ç†å“¡æœå‹™æœªè¼‰å…¥');
                        return;
                    }
                    
                    // æª¢æŸ¥ Firebase æ˜¯å¦å·²åˆå§‹åŒ–
                    if (!window.firebaseDb || !window.firebase9Loaded) {
                        log('âŒ Firebase æœªåˆå§‹åŒ–');
                        log('è«‹é‡æ–°æ•´ç†é é¢ä»¥åˆå§‹åŒ– Firebase');
                        updateStatus('error', 'Firebase æœªåˆå§‹åŒ–');
                        return;
                    }
                    
                    // 1. å…ˆå˜—è©¦è®€å–æœ¬åœ° admin-accounts.jsonï¼ˆåŒ…å«æœ€æ–°è³‡æ–™ï¼‰
                    log('ğŸ“„ è®€å–æœ¬åœ° admin-accounts.json...');
                    let accountsData = null;
                    try {
                        const localResponse = await fetch('admin-accounts.json');
                        if (localResponse.ok) {
                            accountsData = await localResponse.json();
                            log(`âœ… å¾æœ¬åœ°æª”æ¡ˆè®€å–åˆ° ${accountsData.accounts.length} å€‹ç®¡ç†å“¡`);
                        }
                    } catch (e) {
                        log('âš ï¸ ç„¡æ³•è®€å–æœ¬åœ°æª”æ¡ˆï¼Œå°‡å¾æœå‹™ç²å–');
                    }
                    
                    // 2. å¦‚æœæœ¬åœ°æª”æ¡ˆè®€å–å¤±æ•—ï¼Œå¾æœå‹™ç²å–
                    if (!accountsData || !accountsData.accounts || accountsData.accounts.length === 0) {
                        log('ğŸ“¥ å¾æœå‹™ç²å–ç®¡ç†å“¡è³‡æ–™...');
                        accountsData = await window.adminAccountsService.fetchAccountsData();
                        log(`âœ… å¾æœå‹™ç²å–åˆ° ${accountsData.accounts.length} å€‹ç®¡ç†å“¡`);
                    }
                    
                    // 3. åŒæ­¥åˆ° Firebaseï¼ˆå‚³å…¥æœ¬åœ°è®€å–çš„è³‡æ–™ï¼‰
                    log('ğŸ”¥ æ­£åœ¨åŒæ­¥åˆ° Firebase Firestore...');
                    const syncResult = await window.adminAccountsService.syncToFirebase(accountsData);
                    
                    if (syncResult) {
                        log(`âœ… åŒæ­¥åˆ° Firebase æˆåŠŸï¼å·²åŒæ­¥ ${accountsData.accounts.length} å€‹ç®¡ç†å“¡`);
                        log('æ‰€æœ‰ç®¡ç†å“¡å¸³è™Ÿå·²å„²å­˜åˆ° Firestore');
                        updateStatus('success', `åŒæ­¥æˆåŠŸï¼å·²åŒæ­¥ ${accountsData.accounts.length} å€‹ç®¡ç†å“¡åˆ° Firebase`);
                        
                        // é‡æ–°è¼‰å…¥ç®¡ç†å“¡åˆ—è¡¨
                        setTimeout(() => {
                            loadAllAdmins();
                        }, 1000);
                    } else {
                        throw new Error('åŒæ­¥åˆ° Firebase å¤±æ•—');
                    }
                } catch (error) {
                    log('âŒ åŒæ­¥å¤±æ•—: ' + error.message);
                    console.error('åŒæ­¥éŒ¯èª¤è©³æƒ…:', error);
                    updateStatus('error', 'åŒæ­¥å¤±æ•—: ' + error.message);
                }
            };
            
            window.syncToGitHub = async function() {
                log('â˜ï¸ é–‹å§‹åŒæ­¥ç®¡ç†å“¡åˆ° GitHub...');
                try {
                    if (!window.adminAccountsService) {
                        log('âŒ ç®¡ç†å“¡æœå‹™æœªè¼‰å…¥');
                        updateStatus('error', 'ç®¡ç†å“¡æœå‹™æœªè¼‰å…¥');
                        return;
                    }
                    
                    // æª¢æŸ¥ GitHub Token
                    const githubToken = localStorage.getItem('github_token');
                    if (!githubToken) {
                        log('âŒ æœªè¨­å®š GitHub Token');
                        log('è«‹å…ˆåˆ°ã€ŒGitHub Token è¨­å®šã€é é¢è¨­å®š Token');
                        updateStatus('error', 'æœªè¨­å®š GitHub Token');
                        return;
                    }
                    
                    // 1. å…ˆå¾æœå‹™ç²å–æœ€æ–°è³‡æ–™ï¼ˆæœƒè‡ªå‹•åˆä½µæœ¬åœ°å’Œé ç«¯ï¼‰
                    log('ğŸ“¥ å¾æœå‹™ç²å–æœ€æ–°ç®¡ç†å“¡è³‡æ–™...');
                    const accountsData = await window.adminAccountsService.fetchAccountsData();
                    log(`âœ… ç²å–åˆ° ${accountsData.accounts.length} å€‹ç®¡ç†å“¡`);
                    
                    // 2. æª¢æŸ¥æœ¬åœ° admin-accounts.json æ˜¯å¦æœ‰æ–°ç®¡ç†å“¡
                    log('ğŸ“„ æª¢æŸ¥æœ¬åœ° admin-accounts.json...');
                    try {
                        const localResponse = await fetch('admin-accounts.json');
                        if (localResponse.ok) {
                            const localData = await localResponse.json();
                            log(`ğŸ“„ æœ¬åœ°æª”æ¡ˆæœ‰ ${localData.accounts.length} å€‹ç®¡ç†å“¡`);
                            
                            // åˆä½µæœ¬åœ°æ–°ç®¡ç†å“¡åˆ°è³‡æ–™ä¸­
                            localData.accounts.forEach(localAdmin => {
                                const exists = accountsData.accounts.find(acc => acc.email === localAdmin.email);
                                if (!exists) {
                                    log(`â• ç™¼ç¾æ–°ç®¡ç†å“¡: ${localAdmin.email}ï¼Œå°‡æ·»åŠ åˆ°åŒæ­¥åˆ—è¡¨`);
                                    accountsData.accounts.push(localAdmin);
                                }
                            });
                            
                            log(`âœ… åˆä½µå¾Œç¸½å…± ${accountsData.accounts.length} å€‹ç®¡ç†å“¡`);
                        }
                    } catch (e) {
                        log('âš ï¸ ç„¡æ³•è®€å–æœ¬åœ°æª”æ¡ˆï¼Œå°‡ä½¿ç”¨æœå‹™è³‡æ–™');
                    }
                    
                    // 3. æ›´æ–° last_updated æ™‚é–“
                    accountsData.last_updated = new Date().toISOString();
                    
                    // 4. åŒæ­¥åˆ° GitHub
                    log('â˜ï¸ æ­£åœ¨åŒæ­¥åˆ° GitHub...');
                    const syncResult = await window.adminAccountsService.updateGitHubAccounts(accountsData);
                    
                    if (syncResult) {
                        log('âœ… åŒæ­¥åˆ° GitHub æˆåŠŸï¼');
                        log('æ‰€æœ‰è¨­å‚™å°‡åœ¨ä¸‹æ¬¡è¼‰å…¥æ™‚è‡ªå‹•ç²å–æœ€æ–°è³‡æ–™');
                        updateStatus('success', `åŒæ­¥æˆåŠŸï¼å·²åŒæ­¥ ${accountsData.accounts.length} å€‹ç®¡ç†å“¡åˆ° GitHub`);
                        
                        // å¼·åˆ¶åˆ·æ–°æœå‹™å¿«å–
                        await window.adminAccountsService.forceRefresh();
                        log('âœ… å·²åˆ·æ–°æœå‹™å¿«å–');
                        
                        // é‡æ–°è¼‰å…¥ç®¡ç†å“¡åˆ—è¡¨
                        setTimeout(() => {
                            loadAllAdmins();
                        }, 1000);
                    } else {
                        throw new Error('åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ GitHub Token æ˜¯å¦æœ‰æ•ˆ');
                    }
                } catch (error) {
                    log('âŒ åŒæ­¥å¤±æ•—: ' + error.message);
                    console.error('åŒæ­¥éŒ¯èª¤è©³æƒ…:', error);
                    updateStatus('error', 'åŒæ­¥å¤±æ•—: ' + error.message);
                }
            };
            
            window.testSystem = function() {
                log('ğŸ§ª æ¸¬è©¦ç®¡ç†å“¡ç³»çµ±...');
                try {
                    if (window.adminAccountsService) {
                        log('âœ… ç®¡ç†å“¡æœå‹™å·²è¼‰å…¥');
                        const githubToken = localStorage.getItem('github_token');
                        if (githubToken) {
                            log('âœ… GitHub Token å·²è¨­å®š');
                        } else {
                            log('âš ï¸ GitHub Token æœªè¨­å®š');
                        }
                        updateStatus('success', 'ç®¡ç†å“¡ç³»çµ±æ­£å¸¸');
                    } else {
                        log('âŒ ç®¡ç†å“¡æœå‹™æœªè¼‰å…¥');
                        updateStatus('error', 'ç®¡ç†å“¡æœå‹™æœªè¼‰å…¥');
                    }
                } catch (error) {
                    log('âŒ ç³»çµ±æ¸¬è©¦å¤±æ•—: ' + error.message);
                    updateStatus('error', 'ç³»çµ±æ¸¬è©¦å¤±æ•—: ' + error.message);
                }
            };
            
            window.clearCache = function() {
                log('ğŸ§¹ æ¸…é™¤æœ¬åœ°å¿«å–...');
                try {
                    localStorage.removeItem('admin_accounts');
                    localStorage.removeItem('admin_accounts_backup');
                    localStorage.removeItem('admin_sync_mode');
                    localStorage.removeItem('system_admins');
                    log('âœ… æœ¬åœ°å¿«å–å·²æ¸…é™¤');
                    updateStatus('success', 'æœ¬åœ°å¿«å–å·²æ¸…é™¤');
                    accountsArea.innerHTML = 'æœ¬åœ°å¿«å–å·²æ¸…é™¤';
                } catch (error) {
                    log('âŒ æ¸…é™¤å¿«å–å¤±æ•—: ' + error.message);
                    updateStatus('error', 'æ¸…é™¤å¿«å–å¤±æ•—: ' + error.message);
                }
            };
            
            function displayFirestoreAccounts(accounts) {
                if (accounts.length === 0) {
                    accountsArea.innerHTML = '<p style="color: #666;">æ²’æœ‰æ‰¾åˆ°ç®¡ç†å“¡å¸³è™Ÿ</p>';
                    return;
                }
                
                accountsArea.innerHTML = accounts.map(account => `
                    <div style="padding: 10px; margin: 5px 0; background: white; border-radius: 4px; border-left: 3px solid #2b71d2; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <strong style="color: #2b71d2;">${account.name || 'æœªå‘½å'}</strong>
                        ${account.source ? `<span style="float: right; font-size: 10px; color: #999; background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">${account.source === 'GitHub' ? 'ğŸŒ GitHub' : 'ğŸ’¾ æœ¬åœ°'}</span>` : ''}<br>
                        <small style="color: #666;">Email: ${account.email || 'æœªè¨­å®š'}</small><br>
                        <small style="color: #666;">è§’è‰²: ${account.role === 'super_admin' ? 'è¶…ç´šç®¡ç†å“¡' : 'æ™®é€šç®¡ç†å“¡'}</small><br>
                        <small style="color: ${account.status === 'active' ? '#28a745' : '#dc3545'};">ç‹€æ…‹: ${account.status === 'active' ? 'å•Ÿç”¨' : 'åœç”¨'}</small>
                    </div>
                `).join('');
            }
            
            function updateStatus(type, message) {
                const statusClass = type === 'success' ? 'success' : type === 'error' ? 'error' : 'warning';
                statusArea.innerHTML = `<div class="message ${statusClass}" style="margin: 0;">${message}</div>`;
            }
            
            function log(message) {
                const timestamp = new Date().toLocaleString('zh-TW');
                logArea.textContent += `[${timestamp}] ${message}\n`;
                logArea.scrollTop = logArea.scrollHeight;
            }
            
            log('åŒæ­¥ä¿®å¾©å·¥å…·å·²å•Ÿå‹•');
        }

        // æ‰“é–‹æ–°å¢ç®¡ç†å“¡æ¨¡æ…‹æ¡†
        window.openAddAdminModal = function() {
            console.log('openAddAdminModal è¢«èª¿ç”¨');
            const modal = document.createElement('div');
            modal.className = 'password-dialog';
            modal.style.display = 'flex';
            modal.style.zIndex = '10000';
            modal.innerHTML = `
                <div class="password-dialog-content" style="max-width: 500px;">
                    <h3>â• æ–°å¢ç®¡ç†å“¡</h3>
                    <form id="addAdminForm" style="margin-top: 20px;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email åœ°å€ *</label>
                            <input type="email" id="newAdminEmail" required 
                                   style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">å§“å *</label>
                            <input type="text" id="newAdminName" required 
                                   style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">è§’è‰² *</label>
                            <select id="newAdminRole" required 
                                    style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px;">
                                <option value="">è«‹é¸æ“‡è§’è‰²</option>
                                <option value="admin">æ™®é€šç®¡ç†å“¡</option>
                                <option value="super_admin">è¶…ç´šç®¡ç†å“¡</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">å¯†ç¢¼ *</label>
                            <input type="password" id="newAdminPassword" required 
                                   style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px;"
                                   placeholder="è‡³å°‘ 6 å€‹å­—å…ƒ"
                                   oninput="checkPasswordMatch()">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">ç¢ºèªå¯†ç¢¼ *</label>
                            <input type="password" id="newAdminPasswordConfirm" required 
                                   style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px;"
                                   placeholder="è«‹å†æ¬¡è¼¸å…¥å¯†ç¢¼ä»¥ç¢ºèª"
                                   oninput="checkPasswordMatch()">
                            <div id="passwordMatchMessage" style="margin-top: 5px; font-size: 12px; min-height: 18px;"></div>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">ç‹€æ…‹</label>
                            <select id="newAdminStatus" 
                                    style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px;">
                                <option value="active">å•Ÿç”¨</option>
                                <option value="inactive">åœç”¨</option>
                            </select>
                        </div>
                        <div id="addAdminMessage" style="margin-bottom: 15px; display: none;"></div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.password-dialog').remove()">å–æ¶ˆ</button>
                            <button type="submit" class="btn btn-primary">æ–°å¢ç®¡ç†å“¡</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ç­‰å¾… DOM æ›´æ–°å¾Œå†ç¶å®šäº‹ä»¶
            setTimeout(() => {
                // å¯†ç¢¼ç¢ºèªæª¢æŸ¥å‡½æ•¸
                window.checkPasswordMatch = function() {
                    const password = document.getElementById('newAdminPassword').value;
                    const passwordConfirm = document.getElementById('newAdminPasswordConfirm').value;
                    const messageDiv = document.getElementById('passwordMatchMessage');
                    
                    if (!messageDiv) return;
                    
                    if (passwordConfirm.length === 0) {
                        messageDiv.innerHTML = '';
                        return;
                    }
                    
                    if (password === passwordConfirm) {
                        messageDiv.innerHTML = '<span style="color: #28a745;">âœ“ å¯†ç¢¼ä¸€è‡´</span>';
                        const confirmInput = document.getElementById('newAdminPasswordConfirm');
                        if (confirmInput) confirmInput.style.borderColor = '#28a745';
                    } else {
                        messageDiv.innerHTML = '<span style="color: #dc3545;">âœ— å¯†ç¢¼ä¸ä¸€è‡´</span>';
                        const confirmInput = document.getElementById('newAdminPasswordConfirm');
                        if (confirmInput) confirmInput.style.borderColor = '#dc3545';
                    }
                };
                
                // ç¶å®šè¡¨å–®æäº¤äº‹ä»¶
                const form = document.getElementById('addAdminForm');
                if (!form) {
                    console.error('æ‰¾ä¸åˆ°è¡¨å–®å…ƒç´  addAdminForm');
                    return;
                }
                
                form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('newAdminEmail').value.trim();
                const name = document.getElementById('newAdminName').value.trim();
                const role = document.getElementById('newAdminRole').value;
                const password = document.getElementById('newAdminPassword').value;
                const passwordConfirm = document.getElementById('newAdminPasswordConfirm').value;
                const status = document.getElementById('newAdminStatus').value;
                
                const messageDiv = document.getElementById('addAdminMessage');
                messageDiv.style.display = 'block';
                
                // é©—è­‰è¼¸å…¥
                if (!email || !name || !role || !password || !passwordConfirm) {
                    messageDiv.innerHTML = '<div class="message error">è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½</div>';
                    return;
                }
                
                // é©—è­‰å¯†ç¢¼æ˜¯å¦ä¸€è‡´
                if (password !== passwordConfirm) {
                    messageDiv.innerHTML = '<div class="message error">âŒ å¯†ç¢¼ä¸ä¸€è‡´ï¼Œè«‹ç¢ºèªå…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ç›¸åŒ</div>';
                    return;
                }
                
                // é©—è­‰å¯†ç¢¼å¼·åº¦
                if (password.length < 6) {
                    messageDiv.innerHTML = '<div class="message error">å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ</div>';
                    return;
                }
                
                try {
                    messageDiv.innerHTML = '<div class="message" style="color: #666;">æ­£åœ¨å‰µå»ºç®¡ç†å“¡...</div>';
                    
                    if (!window.adminAccountsService) {
                        throw new Error('ç®¡ç†å“¡å¸³è™Ÿæœå‹™æœªè¼‰å…¥');
                    }
                    
                    const accountData = {
                        email: email,
                        name: name,
                        role: role,
                        password: password,
                        status: status
                    };
                    
                    const result = await window.adminAccountsService.addAdminAccount(accountData);
                    
                    if (result) {
                        messageDiv.innerHTML = '<div class="message success">âœ… ç®¡ç†å“¡å‰µå»ºæˆåŠŸï¼æ­£åœ¨åŒæ­¥åˆ°é›²ç«¯...</div>';
                        
                        // ç­‰å¾…ä¸€ä¸‹è®“ç”¨æˆ¶çœ‹åˆ°æˆåŠŸè¨Šæ¯
                        setTimeout(() => {
                            modal.remove();
                            showMessage('âœ… ç®¡ç†å“¡å‰µå»ºæˆåŠŸä¸¦å·²åŒæ­¥åˆ°é›²ç«¯', 'success');
                            loadAllAdmins(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
                        }, 1500);
                    } else {
                        throw new Error('å‰µå»ºå¤±æ•—');
                    }
                } catch (error) {
                    console.error('å‰µå»ºç®¡ç†å“¡å¤±æ•—:', error);
                    messageDiv.innerHTML = `<div class="message error">âŒ å‰µå»ºå¤±æ•—: ${error.message}</div>`;
                }
                });
            }, 100);
        };

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const user = checkSuperAdminAuth();
            if (!user) return;
            
            // ç¢ºä¿è¶…ç´šç®¡ç†å“¡çš„åç¨±æ­£ç¢º
            let displayName = user.name || 'Sammy Zomb';
            if (user.email === 'sammyzomb@gmail.com') {
                displayName = 'Sammy Zomb';
            }
            
            document.getElementById('userDetails').textContent = `ğŸ‘¤ ${displayName} (è¶…ç´šç®¡ç†å“¡)`;
            loadAllAdmins();
        });
    </script>
</body>
</html>

