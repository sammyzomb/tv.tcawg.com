<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœˆæ›†ç¯€ç›®ç®¡ç† - èˆªå‘ä¸–ç•Œæ—…éŠé »é“</title>
  <script src="https://cdn.jsdelivr.net/npm/contentful@latest/dist/contentful.browser.min.js"></script>
  <script src="browser-config.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    
    .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .header h1 { color: #2b71d2; margin-bottom: 10px; }
    .header p { color: #666; }
    
    .calendar-controls { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .month-nav { display: flex; align-items: center; gap: 15px; }
    .month-nav button { background: #2b71d2; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    .month-nav button:hover { background: #1e5bb8; }
    .current-month { font-size: 1.2rem; font-weight: 600; color: #333; }
    
    .calendar-grid { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); background: #2b71d2; color: white; }
    .calendar-header div { padding: 15px; text-align: center; font-weight: 600; }
    
    .calendar-body { display: grid; grid-template-columns: repeat(7, 1fr); }
    .calendar-day { min-height: 120px; border: 1px solid #eee; padding: 10px; position: relative; background: white; }
    .calendar-day:hover { background: #f8f9fa; }
         .calendar-day.other-month { background: #f8f9fa; color: #999; }
     .calendar-day.today { background: #e3f2fd; border-color: #2b71d2; }
     .calendar-day.weekend { background: #fff5f5; }
     .calendar-day.other-month.weekend { background: #fef5f5; }
     
     .day-number { font-weight: 600; margin-bottom: 5px; color: #333; }
     .day-number.weekend-text { color: #d32f2f; }
     
     .month-label {
       position: absolute;
       top: 5px;
       right: 5px;
       background: #2b71d2;
       color: white;
       padding: 2px 6px;
       border-radius: 3px;
       font-size: 0.7rem;
       font-weight: 600;
     }
    .day-programs { font-size: 0.8rem; }
    .program-slot { 
      background: #e8f5e8; 
      border: 1px solid #4caf50; 
      border-radius: 3px; 
      padding: 2px 4px; 
      margin-bottom: 2px; 
      cursor: pointer;
      font-size: 0.7rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .program-slot:hover { background: #c8e6c9; }
    .program-slot.empty { 
      background: #fff3cd; 
      border-color: #ffc107; 
      color: #856404;
      font-style: italic;
    }
    .program-slot.empty:hover { background: #ffeaa7; }
    
    .program-modal { 
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.5); 
      z-index: 1000;
    }
    .modal-content { 
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      background: white; 
      padding: 30px; 
      border-radius: 10px; 
      width: 90%; 
      max-width: 600px; 
      max-height: 80vh; 
      overflow-y: auto;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
    .form-group textarea { height: 80px; resize: vertical; }
    
    .btn { background: #2b71d2; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; margin-right: 10px; }
    .btn:hover { background: #1e5bb8; }
    .btn-secondary { background: #6c757d; }
    .btn-secondary:hover { background: #5a6268; }
    .btn-danger { background: #dc3545; }
    .btn-danger:hover { background: #c82333; }
    
    .template-panel { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .template-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
    .template-card { 
      background: #f8f9fa; 
      border: 2px solid #e9ecef; 
      border-radius: 8px; 
      padding: 15px; 
      cursor: pointer; 
      transition: all 0.3s ease;
    }
    .template-card:hover { border-color: #2b71d2; background: #e3f2fd; }
    .template-card.selected { border-color: #2b71d2; background: #e3f2fd; }
    .template-card h4 { margin-bottom: 8px; color: #333; }
    .template-card p { font-size: 0.9rem; color: #666; margin-bottom: 5px; }
    
    .status-bar { 
      position: fixed; 
      bottom: 20px; 
      right: 20px; 
      background: #333; 
      color: white; 
      padding: 15px 20px; 
      border-radius: 8px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1001;
      display: none;
    }
    
    .auto-fill-panel { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .auto-fill-options { display: flex; gap: 15px; margin-top: 15px; }
    .auto-fill-option { 
      background: #f8f9fa; 
      border: 1px solid #ddd; 
      border-radius: 5px; 
      padding: 10px; 
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .auto-fill-option:hover { border-color: #2b71d2; background: #e3f2fd; }
    
    .stats { display: flex; gap: 20px; margin-top: 15px; }
    .stat-item { 
      background: #e3f2fd; 
      padding: 10px 15px; 
      border-radius: 5px; 
      text-align: center;
    }
    .stat-number { font-size: 1.5rem; font-weight: 600; color: #2b71d2; }
    .stat-label { font-size: 0.9rem; color: #666; }
  </style>
</head>
<body>
  <div class="container">
         <div class="header">
       <h1>ğŸ“… æœˆæ›†ç¯€ç›®ç®¡ç†ç³»çµ±</h1>
       <p>ç›´è§€çš„æœˆæ›†ä»‹é¢ï¼Œè¼•é¬†ç®¡ç†ç¯€ç›®å®‰æ’ï¼ˆåªé¡¯ç¤ºä»Šå¤©é–‹å§‹çš„æ—¥æœŸï¼Œéå¾€è¨˜éŒ„è«‹ä½¿ç”¨æ­·å²æœå°‹ï¼‰</p>
     </div>
    
    <!-- æœˆæ›†æ§åˆ¶ -->
    <div class="calendar-controls">
             <div class="month-nav">
         <button onclick="previousMonth()">â—€ ä¸Šå€‹æœˆ</button>
         <span class="current-month" id="currentMonth">è¼‰å…¥ä¸­...</span>
         <button onclick="nextMonth()">ä¸‹å€‹æœˆ â–¶</button>
         <button onclick="goToToday()" style="background: #4caf50; margin-left: 10px;">ğŸ“… å›åˆ°ä»Šå¤©</button>
       </div>
                      <div>
           <button class="btn" onclick="saveToContentful()">ğŸ’¾ å„²å­˜åˆ° Contentful</button>
           <button class="btn btn-secondary" onclick="exportCalendar()">ğŸ“¤ åŒ¯å‡ºæœˆæ›†</button>
           <button class="btn" onclick="showHistorySearch()">ğŸ” æ­·å²æœå°‹</button>
           <button class="btn" onclick="showAutoFillPanel()">ğŸ”§ è‡ªå‹•å¡«å……</button>
           <button class="btn btn-danger" onclick="logout()">ğŸšª ç™»å‡º</button>
         </div>
    </div>
    
         <!-- æ­·å²è¨˜éŒ„æœå°‹é¢æ¿ -->
     <div class="auto-fill-panel" id="historySearchPanel" style="display: none;">
       <h3>ğŸ” æ­·å²è¨˜éŒ„æœå°‹</h3>
       <p>æŸ¥çœ‹å’Œæœå°‹éå»ä¸€å¹´çš„ç¯€ç›®è¨˜éŒ„ï¼ˆæœˆæ›†ä¸­åªé¡¯ç¤ºä»Šå¤©é–‹å§‹çš„æ—¥æœŸï¼‰</p>
       <div style="display: flex; gap: 15px; margin-top: 15px; align-items: end;">
         <div style="flex: 1;">
           <label style="display: block; margin-bottom: 5px; font-weight: 600;">æœå°‹é—œéµå­—ï¼š</label>
           <input type="text" id="searchKeyword" placeholder="è¼¸å…¥ç¯€ç›®æ¨™é¡Œã€åˆ†é¡æˆ–æè¿°..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
         </div>
         <div>
           <label style="display: block; margin-bottom: 5px; font-weight: 600;">æ—¥æœŸç¯„åœï¼š</label>
           <input type="date" id="searchStartDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
         </div>
         <div>
           <label style="display: block; margin-bottom: 5px; font-weight: 600;">è‡³ï¼š</label>
           <input type="date" id="searchEndDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
         </div>
         <button class="btn" onclick="searchHistory()">ğŸ” æœå°‹</button>
         <button class="btn btn-secondary" onclick="clearSearch()">ğŸ—‘ï¸ æ¸…é™¤</button>
       </div>
       <div id="searchResults" style="margin-top: 15px;"></div>
     </div>
     
     <!-- è‡ªå‹•å¡«å……é¢æ¿ -->
     <div class="auto-fill-panel" id="autoFillPanel" style="display: none;">
      <h3>ğŸ”§ è‡ªå‹•å¡«å……é¸é …</h3>
      <div class="auto-fill-options">
        <div class="auto-fill-option" onclick="autoFillEmptySlots()">
          <h4>ğŸ”„ è‡ªå‹•å¡«å……ç©ºç™½æ™‚æ®µ</h4>
          <p>ä½¿ç”¨ç¾æœ‰ç¯€ç›®è‡ªå‹•å¡«å……æ²’æœ‰å®‰æ’çš„æ™‚æ®µ</p>
        </div>
        <div class="auto-fill-option" onclick="generateWeeklyPattern()">
          <h4>ğŸ“… ç”Ÿæˆé€±æœŸæ¨¡å¼</h4>
          <p>æ ¹æ“šé€±ä¸€è‡³é€±æ—¥çš„æ¨¡å¼è‡ªå‹•å®‰æ’ç¯€ç›®</p>
        </div>
        <div class="auto-fill-option" onclick="duplicateWeek()">
          <h4>ğŸ“‹ è¤‡è£½ä¸Šé€±å®‰æ’</h4>
          <p>å°‡ä¸Šé€±çš„ç¯€ç›®å®‰æ’è¤‡è£½åˆ°æœ¬é€±</p>
        </div>
      </div>
    </div>
    
    <!-- ç¯€ç›®ç¯„æœ¬é¢æ¿ -->
    <div class="template-panel">
      <h3>ğŸ“‹ ç¯€ç›®ç¯„æœ¬åº«</h3>
      <p>é»æ“Šç¯„æœ¬å¯å¿«é€Ÿæ·»åŠ åˆ°é¸å®šçš„æ™‚æ®µ</p>
      <div class="template-grid" id="templateGrid">
        <!-- ç¯„æœ¬å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>
    
    <!-- çµ±è¨ˆè³‡è¨Š -->
    <div class="stats">
      <div class="stat-item">
        <div class="stat-number" id="totalPrograms">0</div>
        <div class="stat-label">ç¸½ç¯€ç›®æ•¸</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="emptySlots">0</div>
        <div class="stat-label">ç©ºç™½æ™‚æ®µ</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="coverageRate">0%</div>
        <div class="stat-label">è¦†è“‹ç‡</div>
      </div>
    </div>
    
         <!-- æœˆæ›†ç¶²æ ¼ -->
     <div class="calendar-grid">
       <div class="calendar-header">
         <div style="color: #d32f2f;">æ˜ŸæœŸæ—¥</div>
         <div>æ˜ŸæœŸä¸€</div>
         <div>æ˜ŸæœŸäºŒ</div>
         <div>æ˜ŸæœŸä¸‰</div>
         <div>æ˜ŸæœŸå››</div>
         <div>æ˜ŸæœŸäº”</div>
         <div style="color: #d32f2f;">æ˜ŸæœŸå…­</div>
       </div>
      <div class="calendar-body" id="calendarBody">
        <!-- æœˆæ›†å…§å®¹å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>
  </div>
  
     <!-- ç¯€ç›®ç·¨è¼¯æ¨¡æ…‹æ¡† -->
   <div class="program-modal" id="programModal">
   
   <!-- ç¯€ç›®è©³æƒ…æŸ¥çœ‹æ¨¡æ…‹æ¡† -->
   <div class="program-modal" id="programDetailsModal">
     <div class="modal-content">
       <div class="modal-header">
         <h3>ğŸ“º ç¯€ç›®è©³æƒ…ï¼ˆæ­·å²è¨˜éŒ„ï¼‰</h3>
         <button class="modal-close" onclick="closeDetailsModal()">&times;</button>
       </div>
       
       <div id="programDetailsContent">
         <!-- ç¯€ç›®è©³æƒ…å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
       </div>
       
       <div style="margin-top: 20px; text-align: center;">
         <button class="btn btn-secondary" onclick="closeDetailsModal()">é—œé–‰</button>
       </div>
     </div>
   </div>
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">ç·¨è¼¯ç¯€ç›®</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      
      <form id="programForm">
        <input type="hidden" id="editDate">
        <input type="hidden" id="editTime">
        
        <div class="form-group">
          <label>æ’­å‡ºæ™‚é–“ï¼š</label>
          <input type="time" id="airTime" required>
        </div>
        
        <div class="form-group">
          <label>ç¯€ç›®æ¨™é¡Œï¼š</label>
          <input type="text" id="title" placeholder="ä¾‹å¦‚ï¼šæ—©å®‰ä¸–ç•Œ - æ—¥æœ¬æ±äº¬æ™¨é–“æ¼«æ­¥" required>
        </div>
        
        <div class="form-group">
          <label>ç¯€ç›®æ™‚é•·ï¼ˆåˆ†é˜ï¼‰ï¼š</label>
          <input type="number" id="duration" min="15" max="180" value="60" required>
        </div>
        
        <div class="form-group">
          <label>ç¯€ç›®åˆ†é¡ï¼š</label>
          <select id="category" required>
            <option value="">-- é¸æ“‡åˆ†é¡ --</option>
            <option value="äºæ´²æ—…éŠ">äºæ´²æ—…éŠ</option>
            <option value="æ­æ´²æ—…éŠ">æ­æ´²æ—…éŠ</option>
            <option value="ç¾æ´²æ—…éŠ">ç¾æ´²æ—…éŠ</option>
            <option value="ç¾é£Ÿæ—…éŠ">ç¾é£Ÿæ—…éŠ</option>
            <option value="æ¥µåœ°æ—…éŠ">æ¥µåœ°æ—…éŠ</option>
            <option value="è‡ªç„¶æ—…éŠ">è‡ªç„¶æ—…éŠ</option>
            <option value="æ–‡åŒ–æ—…éŠ">æ–‡åŒ–æ—…éŠ</option>
            <option value="å†’éšªæ—…éŠ">å†’éšªæ—…éŠ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ç¯€ç›®æè¿°ï¼š</label>
          <textarea id="description" placeholder="ç°¡çŸ­æè¿°ç¯€ç›®å…§å®¹..."></textarea>
        </div>
        
                 <div class="form-group">
           <label>å½±ç‰‡é¡å‹ï¼š</label>
           <select id="videoType" onchange="toggleVideoInput()">
             <option value="YouTube">YouTube</option>
             <option value="MP4">MP4 æª”æ¡ˆ</option>
           </select>
         </div>
         
         <div class="form-group" id="youtubeGroup">
           <label>YouTube IDï¼š</label>
           <input type="text" id="youtubeId" placeholder="ä¾‹å¦‚ï¼šdQw4w9WgXcQ">
         </div>
         
         <div class="form-group" id="mp4Group" style="display: none;">
           <label>MP4 å½±ç‰‡é€£çµï¼š</label>
           <input type="url" id="mp4Url" placeholder="ä¾‹å¦‚ï¼šhttps://your-domain.com/videos/travel-video.mp4">
         </div>
        
        <div class="form-group">
          <label>ç¯€ç›®ç‹€æ…‹ï¼š</label>
          <select id="status">
            <option value="é¦–æ’­">é¦–æ’­</option>
            <option value="é‡æ’­">é‡æ’­</option>
            <option value="ç‰¹åˆ¥ç¯€ç›®">ç‰¹åˆ¥ç¯€ç›®</option>
          </select>
        </div>
        
        <button type="submit" class="btn">ğŸ’¾ å„²å­˜ç¯€ç›®</button>
        <button type="button" class="btn btn-danger" onclick="deleteProgram()">ğŸ—‘ï¸ åˆªé™¤ç¯€ç›®</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">âŒ å–æ¶ˆ</button>
      </form>
    </div>
  </div>
  
  <!-- ç‹€æ…‹æ¬„ -->
  <div class="status-bar" id="statusBar">
    <span id="statusMessage"></span>
  </div>

  <script>
    // ç™»å…¥é©—è­‰æª¢æŸ¥
    function checkAuth() {
      const user = sessionStorage.getItem('adminUser');
      const loginTime = sessionStorage.getItem('loginTime');
      
      if (!user || !loginTime) {
        // æœªç™»å…¥ï¼Œè·³è½‰åˆ°ç™»å…¥é é¢
        window.location.href = 'admin-login.html';
        return null;
      }
      
      // æª¢æŸ¥ç™»å…¥æ˜¯å¦è¶…é 8 å°æ™‚
      const loginDate = new Date(loginTime);
      const now = new Date();
      const hoursDiff = (now - loginDate) / (1000 * 60 * 60);
      
      if (hoursDiff >= 8) {
        // ç™»å…¥å·²éæœŸï¼Œæ¸…é™¤ session ä¸¦è·³è½‰åˆ°ç™»å…¥é é¢
        sessionStorage.removeItem('adminUser');
        sessionStorage.removeItem('loginTime');
        window.location.href = 'admin-login.html';
        return null;
      }
      
      return JSON.parse(user);
    }
    
    // ç™»å‡ºåŠŸèƒ½
    function logout() {
      sessionStorage.removeItem('adminUser');
      sessionStorage.removeItem('loginTime');
      window.location.href = 'admin-login.html';
    }
    
         // å…¨åŸŸè®Šæ•¸
     let currentDate = new Date(); // é è¨­ç‚ºç•¶å‰æ—¥æœŸ
     let calendarData = {};
     let selectedTemplate = null;
     let selectedSlot = null;
     let currentUser = null;
    
    // è¼‰å…¥æ‰€æœ‰ç¯€ç›®è³‡æ–™ï¼ˆèˆ‡ç¯€ç›®è¡¨ç®¡ç†å…±äº«ï¼‰
    function loadAllCalendarData() {
      // å¾ç¯€ç›®è¡¨ç®¡ç†è¼‰å…¥
      const schedulePrograms = JSON.parse(localStorage.getItem('adminPrograms') || '[]');
      
      // å¾æœˆæ›†ç®¡ç†è¼‰å…¥
      const existingCalendarData = JSON.parse(localStorage.getItem('calendarData') || '{}');
      
      // åˆä½µè³‡æ–™
      calendarData = { ...existingCalendarData };
      
      // å°‡ç¯€ç›®è¡¨ç®¡ç†çš„è³‡æ–™ä¹ŸåŠ å…¥æœˆæ›†
      schedulePrograms.forEach(program => {
        const slotKey = `${program.airDate}-${program.airTime}`;
        if (!calendarData[slotKey]) {
          calendarData[slotKey] = {
            ...program,
            source: program.source || 'ç¯€ç›®è¡¨ç®¡ç†'
          };
        }
      });
      
      localStorage.setItem('calendarData', JSON.stringify(calendarData));
    }
    
    // Contentful è¨­å®š
    const contentfulClient = contentful.createClient({
      space: process.env.CONTENTFUL_SPACE_ID || 'your-space-id-here',
      accessToken: process.env.CONTENTFUL_DELIVERY_TOKEN || 'your-delivery-token-here'
    });
    
    // ç¯€ç›®ç¯„æœ¬
    const templates = [
      {
        id: 'morning',
        title: 'æ—©å®‰ä¸–ç•Œ',
        duration: 60,
        category: 'äºæ´²æ—…éŠ',
        description: 'è·Ÿè‘—æˆ‘å€‘ä¸€èµ·æ¢ç´¢{åœ°é»}çš„æ—©æ™¨ï¼Œå¾ç•¶åœ°å¸‚å ´åˆ°è‘—åæ™¯é»çš„å¯§éœæ™‚å…‰',
        status: 'é¦–æ’­',
        color: '#4caf50'
      },
      {
        id: 'kitchen',
        title: 'ä¸–ç•Œå»šæˆ¿',
        duration: 45,
        category: 'ç¾é£Ÿæ—…éŠ',
        description: 'æ·±å…¥{åœ°é»}ï¼Œå“åšæœ€é“åœ°çš„ç•¶åœ°ç¾é£Ÿèˆ‡ç‰¹è‰²æ–™ç†',
        status: 'é‡æ’­',
        color: '#ff9800'
      },
      {
        id: 'adventure',
        title: 'æ¥µåœ°æ¢éšª',
        duration: 60,
        category: 'æ¥µåœ°æ—…éŠ',
        description: 'åœ¨{åœ°é»}è¿½å°‹æ¥µå…‰çš„ç¥ç§˜è¹¤è·¡ï¼Œé«”é©—æ¥µåœ°æ¢éšªçš„åˆºæ¿€',
        status: 'ç‰¹åˆ¥ç¯€ç›®',
        color: '#2196f3'
      },
      {
        id: 'city',
        title: 'åŸå¸‚æ¼«æ­¥',
        duration: 45,
        category: 'æ­æ´²æ—…éŠ',
        description: 'æ²¿è‘—{åœ°é»}çš„è¡—é“æ¼«æ­¥ï¼Œæ„Ÿå—é€™åº§åŸå¸‚çš„ç¨ç‰¹é­…åŠ›',
        status: 'é‡æ’­',
        color: '#9c27b0'
      },
      {
        id: 'nature',
        title: 'è‡ªç„¶å¥‡è§€',
        duration: 60,
        category: 'è‡ªç„¶æ—…éŠ',
        description: 'æ¢ç´¢{åœ°é»}çš„è‡ªç„¶å¥‡è§€ï¼Œæ„Ÿå—å¤§è‡ªç„¶çš„å£¯éº—æ™¯è‰²',
        status: 'é¦–æ’­',
        color: '#8bc34a'
      }
    ];
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      // æª¢æŸ¥ç”¨æˆ¶ç™»å…¥ç‹€æ…‹
      currentUser = checkAuth();
      if (!currentUser) return;
      
      // æ›´æ–°é é¢æ¨™é¡Œé¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
      updateUserInfo();
      
      // è¼‰å…¥æ‰€æœ‰ç¯€ç›®è³‡æ–™ï¼ˆèˆ‡ç¯€ç›®è¡¨ç®¡ç†å…±äº«ï¼‰
      loadAllCalendarData();
      
      loadTemplates();
      renderCalendar();
      loadFromContentful();
      updateStats();
    });
    
    // æ›´æ–°ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º
    function updateUserInfo() {
      const header = document.querySelector('.header h1');
      if (header && currentUser) {
        header.innerHTML = `ğŸ“… æœˆæ›†ç¯€ç›®ç®¡ç†ç³»çµ± <span style="font-size: 0.8rem; color: #666; font-weight: normal;">- ${currentUser.name} (${currentUser.role})</span>`;
      }
    }
    
    // è¼‰å…¥ç¯„æœ¬
    function loadTemplates() {
      const grid = document.getElementById('templateGrid');
      grid.innerHTML = templates.map(template => `
        <div class="template-card" onclick="selectTemplate('${template.id}')" data-template="${template.id}">
          <h4>${template.title}</h4>
          <p>${template.duration}åˆ†é˜ | ${template.category}</p>
          <p>${template.description.substring(0, 50)}...</p>
        </div>
      `).join('');
    }
    
    // é¸æ“‡ç¯„æœ¬
    function selectTemplate(templateId) {
      // ç§»é™¤ä¹‹å‰çš„é¸æ“‡
      document.querySelectorAll('.template-card').forEach(card => {
        card.classList.remove('selected');
      });
      
      // é¸æ“‡æ–°çš„ç¯„æœ¬
      const card = document.querySelector(`[data-template="${templateId}"]`);
      if (card) {
        card.classList.add('selected');
        selectedTemplate = templates.find(t => t.id === templateId);
        showStatus('ç¯„æœ¬å·²é¸æ“‡ï¼Œé»æ“Šæœˆæ›†ä¸­çš„ç©ºç™½æ™‚æ®µä¾†æ·»åŠ ç¯€ç›®', 'info');
      }
    }
    
              // æ¸²æŸ“æœˆæ›†
     function renderCalendar() {
       const year = currentDate.getFullYear();
       const month = currentDate.getMonth();
       
       // æ›´æ–°æ¨™é¡Œ
       document.getElementById('currentMonth').textContent = `${year}å¹´${month + 1}æœˆ`;
       
       // ç²å–ä»Šå¤©çš„æ—¥æœŸ
       const today = new Date();
       const todayString = today.toISOString().split('T')[0];
       
       // è¨ˆç®—æœˆæ›†æ•¸æ“š
       const firstDay = new Date(year, month, 1);
       const lastDay = new Date(year, month + 1, 0);
       
       // å¦‚æœç•¶å‰æœˆä»½çš„ç¬¬ä¸€å¤©åœ¨ä»Šå¤©ä¹‹å‰ï¼Œå‰‡å¾ä»Šå¤©é–‹å§‹é¡¯ç¤º
       let startDate;
       if (firstDay < today) {
         // ç•¶å‰æœˆä»½åŒ…å«ä»Šå¤©ï¼Œå¾ä»Šå¤©é–‹å§‹
         startDate = new Date(today);
       } else {
         // æœªä¾†æœˆä»½ï¼Œå¾è©²æœˆç¬¬ä¸€å¤©é–‹å§‹
         startDate = new Date(firstDay);
         const firstDayOfWeek = firstDay.getDay(); // 0=æ˜ŸæœŸæ—¥, 1=æ˜ŸæœŸä¸€, ..., 6=æ˜ŸæœŸå…­
         startDate.setDate(startDate.getDate() - firstDayOfWeek);
       }
       
       const calendarBody = document.getElementById('calendarBody');
       calendarBody.innerHTML = '';
       
       // ç”Ÿæˆ6é€±çš„æœˆæ›†
       for (let week = 0; week < 6; week++) {
         for (let day = 0; day < 7; day++) {
           const currentDay = new Date(startDate);
           currentDay.setDate(startDate.getDate() + week * 7 + day);
           
           // åªé¡¯ç¤ºä»Šå¤©åŠä»¥å¾Œçš„æ—¥æœŸ
           if (currentDay < today) {
             // è·³ééå»çš„æ—¥æœŸï¼Œä¸é¡¯ç¤º
             continue;
           }
           
           const isCurrentMonth = currentDay.getMonth() === month;
           const isToday = currentDay.toDateString() === today.toDateString();
           const isWeekend = currentDay.getDay() === 0 || currentDay.getDay() === 6; // 0=æ˜ŸæœŸæ—¥, 6=æ˜ŸæœŸå…­
           const dateString = currentDay.toISOString().split('T')[0];
           
           const dayElement = document.createElement('div');
           dayElement.className = `calendar-day ${!isCurrentMonth ? 'other-month' : ''} ${isToday ? 'today' : ''} ${isWeekend ? 'weekend' : ''}`;
           dayElement.setAttribute('data-date', dateString);
          
           // é¡¯ç¤ºæœˆä»½æ¨™ç¤ºï¼ˆå¦‚æœæ˜¯æœˆåˆæˆ–è·¨æœˆï¼‰
           let monthLabel = '';
           if (currentDay.getDate() === 1 || (week === 0 && day === 0)) {
             monthLabel = `<div class="month-label">${currentDay.getMonth() + 1}æœˆ</div>`;
           }
           
           dayElement.innerHTML = `
             ${monthLabel}
             <div class="day-number ${isWeekend ? 'weekend-text' : ''}">${currentDay.getDate()}</div>
             <div class="day-programs" id="programs-${dateString}">
               ${generateTimeSlots(dateString)}
             </div>
           `;
           
           calendarBody.appendChild(dayElement);
         }
       }
       
       // æ·»åŠ é»æ“Šäº‹ä»¶
       addCalendarClickEvents();
     }
    
    // ç”Ÿæˆæ™‚é–“æ§½
    function generateTimeSlots(dateString) {
      const timeSlots = [
        { time: '06:00', label: '06:00' },
        { time: '07:00', label: '07:00' },
        { time: '08:00', label: '08:00' },
        { time: '09:00', label: '09:00' },
        { time: '10:00', label: '10:00' },
        { time: '11:00', label: '11:00' },
        { time: '12:00', label: '12:00' },
        { time: '13:00', label: '13:00' },
        { time: '14:00', label: '14:00' },
        { time: '15:00', label: '15:00' },
        { time: '16:00', label: '16:00' },
        { time: '17:00', label: '17:00' },
        { time: '18:00', label: '18:00' },
        { time: '19:00', label: '19:00' },
        { time: '20:00', label: '20:00' },
        { time: '21:00', label: '21:00' },
        { time: '22:00', label: '22:00' },
        { time: '23:00', label: '23:00' }
      ];
      
      return timeSlots.map(slot => {
        const slotKey = `${dateString}-${slot.time}`;
        const program = calendarData[slotKey];
        
        if (program) {
          return `<div class="program-slot" data-slot="${slotKey}" style="background-color: ${program.color || '#e8f5e8'}">
            ${program.title}
          </div>`;
        } else {
          return `<div class="program-slot empty" data-slot="${slotKey}">
            ${slot.label} - ç©ºç™½
          </div>`;
        }
      }).join('');
    }
    
         // æ·»åŠ æœˆæ›†é»æ“Šäº‹ä»¶
     function addCalendarClickEvents() {
       document.querySelectorAll('.program-slot').forEach(slot => {
         slot.addEventListener('click', function() {
           const slotKey = this.getAttribute('data-slot');
           const [date, time] = slotKey.split('-');
           
           if (this.classList.contains('empty')) {
             // ç©ºç™½æ™‚æ®µ - æ·»åŠ æ–°ç¯€ç›®
             if (selectedTemplate) {
               addProgramFromTemplate(date, time);
             } else {
               openProgramModal(date, time);
             }
           } else {
             // å·²æœ‰ç¯€ç›® - ç·¨è¼¯
             openProgramModal(date, time, calendarData[slotKey]);
           }
         });
       });
     }
    
    // å¾ç¯„æœ¬æ·»åŠ ç¯€ç›®
    function addProgramFromTemplate(date, time) {
      const program = {
        ...selectedTemplate,
        title: selectedTemplate.title.replace('{åœ°é»}', 'æ—¥æœ¬æ±äº¬'), // å¯ä»¥è®“ç”¨æˆ¶é¸æ“‡åœ°é»
        airDate: date,
        airTime: time,
        color: selectedTemplate.color
      };
      
      const slotKey = `${date}-${time}`;
      calendarData[slotKey] = program;
      
      updateProgramSlot(slotKey, program);
      updateStats();
      showStatus(`å·²æ·»åŠ ç¯€ç›®ï¼š${program.title}`, 'success');
    }
    
    // æ‰“é–‹ç¯€ç›®ç·¨è¼¯æ¨¡æ…‹æ¡†
    function openProgramModal(date, time, program = null) {
      document.getElementById('editDate').value = date;
      document.getElementById('editTime').value = time;
      document.getElementById('airTime').value = time;
      
      if (program) {
        // ç·¨è¼¯ç¾æœ‰ç¯€ç›®
        document.getElementById('modalTitle').textContent = 'ç·¨è¼¯ç¯€ç›®';
        document.getElementById('title').value = program.title;
        document.getElementById('duration').value = program.duration;
        document.getElementById('category').value = program.category;
        document.getElementById('description').value = program.description;
        document.getElementById('youtubeId').value = program.youtubeId || '';
        document.getElementById('status').value = program.status;
      } else {
        // æ–°å¢ç¯€ç›®
        document.getElementById('modalTitle').textContent = 'æ–°å¢ç¯€ç›®';
        document.getElementById('programForm').reset();
        document.getElementById('airTime').value = time;
      }
      
      document.getElementById('programModal').style.display = 'block';
    }
    
         // é—œé–‰æ¨¡æ…‹æ¡†
     function closeModal() {
       document.getElementById('programModal').style.display = 'none';
     }
     
     // é¡¯ç¤ºç¯€ç›®è©³æƒ…ï¼ˆåªè®€æ¨¡å¼ï¼‰
     function showProgramDetails(date, time, program) {
       const content = document.getElementById('programDetailsContent');
       
       const statusBadge = program.status === 'é¦–æ’­' ? '<span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem;">é¦–æ’­</span>' :
                          program.status === 'ç‰¹åˆ¥ç¯€ç›®' ? '<span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem;">ç‰¹åˆ¥ç¯€ç›®</span>' :
                          '<span style="background: #6c757d; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem;">é‡æ’­</span>';
       
       content.innerHTML = `
         <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
           <h4 style="color: #2b71d2; margin-bottom: 10px;">${program.title}</h4>
           <p><strong>æ’­å‡ºæ™‚é–“ï¼š</strong>${date} ${time}</p>
           <p><strong>ç¯€ç›®æ™‚é•·ï¼š</strong>${program.duration} åˆ†é˜</p>
           <p><strong>ç¯€ç›®åˆ†é¡ï¼š</strong>${program.category}</p>
           <p><strong>ç¯€ç›®ç‹€æ…‹ï¼š</strong>${statusBadge}</p>
           ${program.description ? `<p><strong>ç¯€ç›®æè¿°ï¼š</strong>${program.description}</p>` : ''}
           ${program.youtubeId ? `<p><strong>YouTube IDï¼š</strong>${program.youtubeId}</p>` : ''}
           ${program.videoId && program.videoType === 'MP4' ? `<p><strong>MP4 é€£çµï¼š</strong>${program.videoId}</p>` : ''}
           ${program.createdBy ? `<p><strong>å»ºç«‹è€…ï¼š</strong>${program.createdBy}</p>` : ''}
           ${program.createdAt ? `<p><strong>å»ºç«‹æ™‚é–“ï¼š</strong>${new Date(program.createdAt).toLocaleString('zh-TW')}</p>` : ''}
           ${program.source ? `<p><strong>ä¾†æºï¼š</strong>${program.source}</p>` : ''}
         </div>
       `;
       
       document.getElementById('programDetailsModal').style.display = 'block';
     }
     
     // é—œé–‰ç¯€ç›®è©³æƒ…æ¨¡æ…‹æ¡†
     function closeDetailsModal() {
       document.getElementById('programDetailsModal').style.display = 'none';
     }
    
    // å„²å­˜ç¯€ç›®
    document.getElementById('programForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!checkPermission('write')) {
        showStatus('æ‚¨æ²’æœ‰ç·¨è¼¯ç¯€ç›®çš„æ¬Šé™', 'error');
        return;
      }
      
      const date = document.getElementById('editDate').value;
      const time = document.getElementById('airTime').value;
      const slotKey = `${date}-${time}`;
      
             const videoType = document.getElementById('videoType').value;
       const videoId = videoType === 'YouTube' 
         ? document.getElementById('youtubeId').value 
         : document.getElementById('mp4Url').value;
       
       const program = {
         airDate: date,
         airTime: time,
         title: document.getElementById('title').value,
         duration: parseInt(document.getElementById('duration').value),
         category: document.getElementById('category').value,
         description: document.getElementById('description').value,
         videoType: videoType,
         videoId: videoId,
         status: document.getElementById('status').value,
         color: '#e8f5e8',
         createdBy: currentUser.email,
         createdAt: new Date().toISOString()
       };
      
      calendarData[slotKey] = program;
      
      // åŒæ­¥åˆ°ç¯€ç›®è¡¨ç®¡ç†
      syncToScheduleManagement();
      
      updateProgramSlot(slotKey, program);
      updateStats();
      closeModal();
      showStatus('ç¯€ç›®å·²å„²å­˜', 'success');
    });
    
    // æª¢æŸ¥ç”¨æˆ¶æ¬Šé™
    function checkPermission(permission) {
      if (!currentUser) return false;
      return currentUser.permissions.includes(permission);
    }
    
    // åˆªé™¤ç¯€ç›®
    function deleteProgram() {
      if (!checkPermission('delete')) {
        showStatus('æ‚¨æ²’æœ‰åˆªé™¤ç¯€ç›®çš„æ¬Šé™', 'error');
        return;
      }
      
      const date = document.getElementById('editDate').value;
      const time = document.getElementById('editTime').value;
      const slotKey = `${date}-${time}`;
      
      delete calendarData[slotKey];
      
      // åŒæ­¥åˆ°ç¯€ç›®è¡¨ç®¡ç†
      syncToScheduleManagement();
      
      updateProgramSlot(slotKey, null);
      updateStats();
      closeModal();
      showStatus('ç¯€ç›®å·²åˆªé™¤', 'success');
    }
    
    // æ›´æ–°ç¯€ç›®æ§½
    function updateProgramSlot(slotKey, program) {
      const slotElement = document.querySelector(`[data-slot="${slotKey}"]`);
      if (slotElement) {
        if (program) {
          slotElement.className = 'program-slot';
          slotElement.style.backgroundColor = program.color || '#e8f5e8';
          slotElement.textContent = program.title;
        } else {
          const [date, time] = slotKey.split('-');
          slotElement.className = 'program-slot empty';
          slotElement.style.backgroundColor = '';
          slotElement.textContent = `${time} - ç©ºç™½`;
        }
      }
    }
    
    // åŒæ­¥åˆ°ç¯€ç›®è¡¨ç®¡ç†
    function syncToScheduleManagement() {
      // å°‡æœˆæ›†è³‡æ–™è½‰æ›ç‚ºç¯€ç›®è¡¨æ ¼å¼
      const schedulePrograms = Object.values(calendarData).map(program => ({
        ...program,
        source: program.source || 'æœˆæ›†ç®¡ç†'
      }));
      
      // æ›´æ–°ç¯€ç›®è¡¨ç®¡ç†çš„è³‡æ–™
      localStorage.setItem('adminPrograms', JSON.stringify(schedulePrograms));
      
      // æ›´æ–°æœˆæ›†è³‡æ–™
      localStorage.setItem('calendarData', JSON.stringify(calendarData));
      
      // æ›´æ–°é¦–é ç¯€ç›®è¡¨
      updateHomePageSchedule();
    }
    
    // æ›´æ–°é¦–é ç¯€ç›®è¡¨
    function updateHomePageSchedule() {
      const today = new Date().toISOString().split('T')[0];
      const todayPrograms = Object.values(calendarData).filter(p => p.airDate === today);
      
      const scheduleData = {
        today: {
          date: today,
          dayOfWeek: getDayOfWeek(new Date()),
          month: `${new Date().getMonth() + 1}æœˆ`,
          day: `${new Date().getDate()}æ—¥`,
          schedule: todayPrograms.map(p => ({
            time: p.airTime,
            title: p.title,
            duration: p.duration,
            category: p.category,
            description: p.description,
            thumbnail: p.youtubeId ? `https://i.ytimg.com/vi/${p.youtubeId}/hqdefault.jpg` : 'https://images.unsplash.com/photo-1485846234645-a62644f84728?w=400&h=225&fit=crop',
            youtubeId: p.youtubeId,
            isPremiere: p.status === 'é¦–æ’­',
            isSpecial: p.status === 'ç‰¹åˆ¥ç¯€ç›®'
          }))
        }
      };
      
      localStorage.setItem('currentSchedule', JSON.stringify(scheduleData));
    }
    
    // ç²å–æ˜ŸæœŸå¹¾
    function getDayOfWeek(date) {
      const days = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
      return days[date.getDay()];
    }
    
    // æ›´æ–°çµ±è¨ˆ
    function updateStats() {
      const totalSlots = Object.keys(calendarData).length;
      const totalDays = 31; // ç°¡åŒ–è¨ˆç®—
      const totalTimeSlots = totalDays * 18; // 18å€‹æ™‚æ®µ
      const emptySlots = totalTimeSlots - totalSlots;
      const coverageRate = Math.round((totalSlots / totalTimeSlots) * 100);
      
      document.getElementById('totalPrograms').textContent = totalSlots;
      document.getElementById('emptySlots').textContent = emptySlots;
      document.getElementById('coverageRate').textContent = `${coverageRate}%`;
    }
    
         // æœˆæ›†å°èˆª
     function previousMonth() {
       const newDate = new Date(currentDate);
       newDate.setMonth(newDate.getMonth() - 1);
       
       // æª¢æŸ¥æ˜¯å¦ç‚ºéå»æœˆä»½
       const today = new Date();
       const firstDayOfNewMonth = new Date(newDate.getFullYear(), newDate.getMonth(), 1);
       
       if (firstDayOfNewMonth < today) {
         showStatus('ç„¡æ³•æŸ¥çœ‹éå»çš„æœˆä»½ï¼Œè«‹ä½¿ç”¨æ­·å²æœå°‹åŠŸèƒ½æŸ¥çœ‹éå¾€è¨˜éŒ„', 'warning');
         return;
       }
       
       currentDate = newDate;
       renderCalendar();
     }
    
         function nextMonth() {
       currentDate.setMonth(currentDate.getMonth() + 1);
       renderCalendar();
     }
     
     function goToToday() {
       currentDate = new Date();
       renderCalendar();
       showStatus('å·²å›åˆ°ä»Šå¤©', 'success');
       
       // æ»¾å‹•åˆ°ä»Šå¤©çš„æ—¥æœŸ
       setTimeout(() => {
         const todayElement = document.querySelector('.calendar-day.today');
         if (todayElement) {
           todayElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
         }
       }, 100);
     }
    
         // æ­·å²è¨˜éŒ„æœå°‹åŠŸèƒ½
     function showHistorySearch() {
       const panel = document.getElementById('historySearchPanel');
       const autoFillPanel = document.getElementById('autoFillPanel');
       
       // éš±è—è‡ªå‹•å¡«å……é¢æ¿
       autoFillPanel.style.display = 'none';
       
       // åˆ‡æ›æ­·å²æœå°‹é¢æ¿
       panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
       
       // è¨­å®šé è¨­æ—¥æœŸç¯„åœï¼ˆéå»ä¸€å¹´ï¼‰
       if (panel.style.display === 'block') {
         const today = new Date();
         const oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
         
         document.getElementById('searchStartDate').value = oneYearAgo.toISOString().split('T')[0];
         document.getElementById('searchEndDate').value = today.toISOString().split('T')[0];
         
         // è‡ªå‹•åŸ·è¡Œæœå°‹ï¼Œé¡¯ç¤ºéå»ä¸€å¹´çš„æ‰€æœ‰è¨˜éŒ„
         setTimeout(() => {
           searchHistory();
         }, 100);
       }
     }
     
     // æœå°‹æ­·å²è¨˜éŒ„
     function searchHistory() {
       const keyword = document.getElementById('searchKeyword').value.toLowerCase();
       const startDate = document.getElementById('searchStartDate').value;
       const endDate = document.getElementById('searchEndDate').value;
       
       // å¾ localStorage è¼‰å…¥æ‰€æœ‰ç¯€ç›®è³‡æ–™
       const allPrograms = JSON.parse(localStorage.getItem('adminPrograms') || '[]');
       const calendarPrograms = Object.values(JSON.parse(localStorage.getItem('calendarData') || '{}'));
       
       // åˆä½µæ‰€æœ‰ç¯€ç›®è³‡æ–™
       const allData = [...allPrograms, ...calendarPrograms];
       
       // éæ¿¾ç¯€ç›®
       const filteredPrograms = allData.filter(program => {
         // æ—¥æœŸç¯„åœéæ¿¾
         if (startDate && program.airDate < startDate) return false;
         if (endDate && program.airDate > endDate) return false;
         
         // é—œéµå­—æœå°‹
         if (keyword) {
           const searchText = `${program.title} ${program.category} ${program.description || ''}`.toLowerCase();
           if (!searchText.includes(keyword)) return false;
         }
         
         return true;
       });
       
       // æŒ‰æ—¥æœŸæ’åº
       filteredPrograms.sort((a, b) => new Date(b.airDate) - new Date(a.airDate));
       
       // é¡¯ç¤ºæœå°‹çµæœ
       displaySearchResults(filteredPrograms);
     }
     
     // é¡¯ç¤ºæœå°‹çµæœ
     function displaySearchResults(programs) {
       const resultsDiv = document.getElementById('searchResults');
       
       if (programs.length === 0) {
         resultsDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç¯€ç›®</p>';
         return;
       }
       
       const resultsHtml = programs.map(program => {
         const statusBadge = program.status === 'é¦–æ’­' ? '<span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem;">é¦–æ’­</span>' :
                            program.status === 'ç‰¹åˆ¥ç¯€ç›®' ? '<span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem;">ç‰¹åˆ¥ç¯€ç›®</span>' :
                            '<span style="background: #6c757d; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem;">é‡æ’­</span>';
         
         return `
           <div style="background: white; border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: pointer;" 
                onclick="showProgramDetails('${program.airDate}', '${program.airTime}', ${JSON.stringify(program).replace(/"/g, '&quot;')})">
             <div style="display: flex; justify-content: space-between; align-items: center;">
               <h4 style="margin: 0; color: #2b71d2;">${program.title}</h4>
               ${statusBadge}
             </div>
             <p style="margin: 5px 0; color: #666;">${program.airDate} ${program.airTime} | ${program.duration}åˆ†é˜ | ${program.category}</p>
             ${program.description ? `<p style="margin: 5px 0; font-size: 0.9rem; color: #888;">${program.description.substring(0, 100)}...</p>` : ''}
           </div>
         `;
       }).join('');
       
       resultsDiv.innerHTML = `
         <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
           <strong>æ‰¾åˆ° ${programs.length} å€‹ç¯€ç›®</strong>
         </div>
         ${resultsHtml}
       `;
     }
     
     // æ¸…é™¤æœå°‹
     function clearSearch() {
       document.getElementById('searchKeyword').value = '';
       document.getElementById('searchStartDate').value = '';
       document.getElementById('searchEndDate').value = '';
       document.getElementById('searchResults').innerHTML = '';
     }
     
     // è‡ªå‹•å¡«å……åŠŸèƒ½
     function showAutoFillPanel() {
       const panel = document.getElementById('autoFillPanel');
       const historyPanel = document.getElementById('historySearchPanel');
       
       // éš±è—æ­·å²æœå°‹é¢æ¿
       historyPanel.style.display = 'none';
       
       // åˆ‡æ›è‡ªå‹•å¡«å……é¢æ¿
       panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
     }
    
    function autoFillEmptySlots() {
      // æ‰¾åˆ°æ‰€æœ‰ç©ºç™½æ™‚æ®µä¸¦è‡ªå‹•å¡«å……
      const emptySlots = document.querySelectorAll('.program-slot.empty');
      let filledCount = 0;
      
      emptySlots.forEach((slot, index) => {
        const slotKey = slot.getAttribute('data-slot');
        const [date, time] = slotKey.split('-');
        
        // ä½¿ç”¨å¾ªç’°çš„ç¯„æœ¬
        const template = templates[index % templates.length];
        const program = {
          ...template,
          title: template.title.replace('{åœ°é»}', 'è‡ªå‹•å¡«å……'),
          airDate: date,
          airTime: time,
          color: template.color
        };
        
        calendarData[slotKey] = program;
        updateProgramSlot(slotKey, program);
        filledCount++;
      });
      
      updateStats();
      showStatus(`å·²è‡ªå‹•å¡«å…… ${filledCount} å€‹ç©ºç™½æ™‚æ®µ`, 'success');
    }
    
    function generateWeeklyPattern() {
      // ç”Ÿæˆé€±æœŸæ¨¡å¼
      const weekPattern = [
        { template: templates[0], day: 1 }, // é€±ä¸€ï¼šæ—©å®‰ä¸–ç•Œ
        { template: templates[1], day: 2 }, // é€±äºŒï¼šä¸–ç•Œå»šæˆ¿
        { template: templates[2], day: 3 }, // é€±ä¸‰ï¼šæ¥µåœ°æ¢éšª
        { template: templates[3], day: 4 }, // é€±å››ï¼šåŸå¸‚æ¼«æ­¥
        { template: templates[4], day: 5 }, // é€±äº”ï¼šè‡ªç„¶å¥‡è§€
        { template: templates[0], day: 6 }, // é€±å…­ï¼šæ—©å®‰ä¸–ç•Œ
        { template: templates[1], day: 0 }  // é€±æ—¥ï¼šä¸–ç•Œå»šæˆ¿
      ];
      
      // æ¸…ç©ºç¾æœ‰æ•¸æ“š
      calendarData = {};
      
      // ç”Ÿæˆæ•´å€‹æœˆçš„é€±æœŸæ¨¡å¼
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dayOfWeek = date.getDay();
        const pattern = weekPattern.find(p => p.day === dayOfWeek);
        
        if (pattern) {
          const dateString = date.toISOString().split('T')[0];
          const timeSlots = ['06:00', '12:00', '18:00']; // ä¸»è¦æ™‚æ®µ
          
          timeSlots.forEach(time => {
            const slotKey = `${dateString}-${time}`;
            const program = {
              ...pattern.template,
              title: pattern.template.title.replace('{åœ°é»}', 'é€±æœŸå®‰æ’'),
              airDate: dateString,
              airTime: time,
              color: pattern.template.color
            };
            
            calendarData[slotKey] = program;
          });
        }
      }
      
      renderCalendar();
      updateStats();
      showStatus('å·²ç”Ÿæˆé€±æœŸç¯€ç›®æ¨¡å¼', 'success');
    }
    
    // Contentful æ•´åˆ
    async function loadFromContentful() {
      try {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth() + 1;
        const monthString = month.toString().padStart(2, '0');
        
        const response = await contentfulClient.getEntries({
          content_type: 'scheduleItem',
          'fields.airDate[gte]': `${year}-${monthString}-01`,
          'fields.airDate[lt]': `${year}-${monthString}-32`,
          include: 2
        });
        
        if (response.items && response.items.length > 0) {
          response.items.forEach(item => {
            const date = item.fields.airDate;
            const time = item.fields.airTime || item.fields.æ’­å‡ºæ™‚é–“;
            const slotKey = `${date}-${time}`;
            
            calendarData[slotKey] = {
              airDate: date,
              airTime: time,
              title: item.fields.title || item.fields.ç¯€ç›®æ¨™é¡Œ,
              duration: item.fields.duration || item.fields.ç¯€ç›®æ™‚é•·,
              category: item.fields.category || item.fields.ç¯€ç›®åˆ†é¡,
              description: item.fields.description || item.fields.ç¯€ç›®æè¿°,
              youtubeId: item.fields.youtubeId || item.fields.YouTubeID,
              status: item.fields.status || item.fields.ç¯€ç›®ç‹€æ…‹,
              color: '#e8f5e8'
            };
          });
          
          renderCalendar();
          updateStats();
          showStatus(`å·²å¾ Contentful è¼‰å…¥ ${response.items.length} å€‹ç¯€ç›®`, 'success');
        }
      } catch (error) {
        console.log('Contentful è¼‰å…¥å¤±æ•—:', error);
        showStatus('Contentful è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°æ•¸æ“š', 'warning');
      }
    }
    
    async function saveToContentful() {
      if (!checkPermission('publish')) {
        showStatus('æ‚¨æ²’æœ‰ç™¼å¸ƒåˆ° Contentful çš„æ¬Šé™', 'error');
        return;
      }
      
      try {
        showStatus('æ­£åœ¨å„²å­˜åˆ° Contentful...', 'info');
        
        const programs = Object.values(calendarData);
        let savedCount = 0;
        
        for (const program of programs) {
          try {
            // é€™è£¡æ‡‰è©²èª¿ç”¨ Contentful API ä¾†å‰µå»ºæˆ–æ›´æ–°ç¯€ç›®
            // ç”±æ–¼é€™æ˜¯æ¼”ç¤ºç‰ˆæœ¬ï¼Œæˆ‘å€‘åªè¨˜éŒ„åˆ°æ§åˆ¶å°
            console.log('å„²å­˜ç¯€ç›®:', program);
            savedCount++;
          } catch (error) {
            console.error('å„²å­˜ç¯€ç›®å¤±æ•—:', error);
          }
        }
        
        showStatus(`æˆåŠŸå„²å­˜ ${savedCount} å€‹ç¯€ç›®åˆ° Contentful`, 'success');
      } catch (error) {
        console.error('Contentful å„²å­˜å¤±æ•—:', error);
        showStatus('Contentful å„²å­˜å¤±æ•—', 'error');
      }
    }
    
    // åŒ¯å‡ºæœˆæ›†
    function exportCalendar() {
      const data = {
        month: currentDate.getFullYear() + '-' + (currentDate.getMonth() + 1),
        programs: Object.values(calendarData)
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `calendar-${data.month}.json`;
      a.click();
      
      showStatus('æœˆæ›†å·²åŒ¯å‡º', 'success');
    }
    
    // é¡¯ç¤ºç‹€æ…‹
    function showStatus(message, type) {
      const statusBar = document.getElementById('statusBar');
      const statusMessage = document.getElementById('statusMessage');
      
      statusMessage.textContent = message;
      statusBar.style.display = 'block';
      
      // æ ¹æ“šé¡å‹è¨­å®šé¡è‰²
      statusBar.style.backgroundColor = type === 'success' ? '#4caf50' : 
                                      type === 'error' ? '#f44336' : 
                                      type === 'warning' ? '#ff9800' : '#333';
      
      setTimeout(() => {
        statusBar.style.display = 'none';
      }, 3000);
    }
    
    // åˆ‡æ›å½±ç‰‡è¼¸å…¥æ¬„ä½
    function toggleVideoInput() {
      const videoType = document.getElementById('videoType').value;
      const youtubeGroup = document.getElementById('youtubeGroup');
      const mp4Group = document.getElementById('mp4Group');
      
      if (videoType === 'YouTube') {
        youtubeGroup.style.display = 'block';
        mp4Group.style.display = 'none';
      } else {
        youtubeGroup.style.display = 'none';
        mp4Group.style.display = 'block';
      }
    }
    
         // é»æ“Šå¤–éƒ¨é—œé–‰æ¨¡æ…‹æ¡†
     window.addEventListener('click', function(e) {
       const modal = document.getElementById('programModal');
       const detailsModal = document.getElementById('programDetailsModal');
       
       if (e.target === modal) {
         closeModal();
       }
       
       if (e.target === detailsModal) {
         closeDetailsModal();
       }
     });
  </script>
</body>
</html>
