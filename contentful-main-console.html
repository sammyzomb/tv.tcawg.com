<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contentful 主控台 - 統一管理系統</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .console-container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .console-header {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .console-header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      font-weight: 300;
    }
    
    .console-header p {
      font-size: 1.1em;
      opacity: 0.9;
    }
    
    .console-content {
      padding: 30px;
    }
    
    .cards-grid {
      display: block;
      margin-bottom: 30px;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      border: 1px solid #e1e8ed;
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    }
    
    .card-header {
      padding: 20px;
      border-bottom: 1px solid #e1e8ed;
      background: #f8f9fa;
    }
    
    .card-title {
      font-size: 1.3em;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 5px;
    }
    
    .card-subtitle {
      color: #6c757d;
      font-size: 0.9em;
    }
    
    .card-body {
      padding: 20px;
    }
    
    .card-actions {
      padding: 15px 20px;
      background: #f8f9fa;
      border-top: 1px solid #e1e8ed;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 500;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: #007bff;
      color: white;
    }
    
    .btn-primary:hover {
      background: #0056b3;
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-success:hover {
      background: #1e7e34;
    }
    
    .btn-warning {
      background: #ffc107;
      color: #212529;
    }
    
    .btn-warning:hover {
      background: #e0a800;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .btn-danger:hover {
      background: #c82333;
    }
    
    .btn-info {
      background: #17a2b8;
      color: white;
    }
    
    .btn-info:hover {
      background: #138496;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #545b62;
    }
    
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-online {
      background: #28a745;
    }
    
    .status-offline {
      background: #dc3545;
    }
    
    .status-warning {
      background: #ffc107;
    }
    
    .log-container {
      background: #f8f9fa;
      border: 1px solid #e1e8ed;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .log-entry {
      padding: 8px 0;
      border-bottom: 1px solid #e9ecef;
      font-family: 'Courier New', monospace;
      font-size: 0.85em;
    }
    
    .log-entry:last-child {
      border-bottom: none;
    }
    
    .log-timestamp {
      color: #6c757d;
      margin-right: 10px;
    }
    
    .log-success {
      color: #28a745;
    }
    
    .log-error {
      color: #dc3545;
    }
    
    .log-warning {
      color: #ffc107;
    }
    
    .log-info {
      color: #17a2b8;
    }
    
    .system-status {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .status-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #007bff;
      text-align: center;
    }
    
    .status-card.success {
      border-left-color: #28a745;
    }
    
    .status-card.error {
      border-left-color: #dc3545;
    }
    
    .status-card.warning {
      border-left-color: #ffc107;
    }
    
    .status-title {
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .status-value {
      font-size: 1.2em;
      font-weight: 700;
    }
    
    .quick-actions {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 25px;
    }
    
    .quick-actions h3 {
      margin-bottom: 15px;
      color: #2c3e50;
    }
    
    .quick-actions .btn {
      margin: 5px;
    }
    
    @media (max-width: 768px) {
      .cards-grid {
        grid-template-columns: 1fr;
      }
      
      .console-header h1 {
        font-size: 2em;
      }
      
      .card-actions {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="console-container">
    <div class="console-header">
      <h1>🚀 Contentful 主控台</h1>
      <p>統一管理系統 - 測試、監控、配置</p>
    </div>
    
    <div class="console-content">
      <!-- 系統狀態 -->
      <div class="system-status" id="systemStatus">
        <div class="status-card" id="sdkStatus">
          <div class="status-title">SDK 狀態</div>
          <div class="status-value" id="sdkStatusValue">檢查中...</div>
        </div>
        <div class="status-card" id="connectionStatus">
          <div class="status-title">連線狀態</div>
          <div class="status-value" id="connectionStatusValue">檢查中...</div>
        </div>
        <div class="status-card" id="configStatus">
          <div class="status-title">配置狀態</div>
          <div class="status-value" id="configStatusValue">檢查中...</div>
        </div>
        <div class="status-card" id="uploadStatus">
          <div class="status-title">上架狀態</div>
          <div class="status-value" id="uploadStatusValue">檢查中...</div>
        </div>
      </div>
      
      
      <!-- 統一管理測試日誌卡片 -->
      <div class="card" style="max-width: 100%; margin: 0 auto;">
        <div class="card-header">
          <div class="card-title">📋 管理測試日誌</div>
          <div class="card-subtitle">統一管理所有測試、檢查、同步與日誌功能</div>
        </div>
        <div class="card-body">
          <p>整合所有 Contentful 相關的測試、檢查、配置管理、同步檢查和日誌監控功能。</p>
          
          <!-- 功能分組 -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
            
            <!-- SDK 管理 -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff;">
              <h4 style="margin: 0 0 10px 0; color: #007bff;">📦 SDK 管理</h4>
              <button class="btn btn-primary" onclick="checkSDKStatus()" style="margin: 2px;">檢查狀態</button>
              <button class="btn btn-warning" onclick="forceLoadSDK()" style="margin: 2px;">強制載入</button>
              <button class="btn btn-info" onclick="showSDKInfo()" style="margin: 2px;">顯示資訊</button>
            </div>
            
            <!-- 連線測試 -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
              <h4 style="margin: 0 0 10px 0; color: #28a745;">🔗 連線測試</h4>
              <button class="btn btn-success" onclick="testConnection()" style="margin: 2px;">測試連線</button>
              <button class="btn btn-warning" onclick="testDeliveryAPI()" style="margin: 2px;">Delivery API</button>
              <button class="btn btn-info" onclick="testManagementAPI()" style="margin: 2px;">Management API</button>
            </div>
            
            <!-- 節目上架 -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
              <h4 style="margin: 0 0 10px 0; color: #e0a800;">📺 節目上架</h4>
              <button class="btn btn-warning" onclick="testVideoUpload()" style="margin: 2px;">測試影片</button>
              <button class="btn btn-warning" onclick="testScheduleUpload()" style="margin: 2px;">測試排表</button>
              <button class="btn btn-success" onclick="testBothUploads()" style="margin: 2px;">測試全部</button>
            </div>
            
            <!-- 配置管理 -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #17a2b8;">
              <h4 style="margin: 0 0 10px 0; color: #17a2b8;">⚙️ 配置管理</h4>
              <button class="btn btn-info" onclick="checkConfig()" style="margin: 2px;">檢查配置</button>
              <button class="btn btn-warning" onclick="validateTokens()" style="margin: 2px;">驗證 Token</button>
              <button class="btn btn-info" onclick="showConfig()" style="margin: 2px;">顯示配置</button>
            </div>
            
            <!-- 系統操作 -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #6f42c1;">
              <h4 style="margin: 0 0 10px 0; color: #6f42c1;">🔧 系統操作</h4>
              <button class="btn btn-primary" onclick="runSystemDiagnostic()" style="margin: 2px;">系統診斷</button>
              <button class="btn btn-info" onclick="initializeSystem()" style="margin: 2px;">初始化系統</button>
              <button class="btn btn-secondary" onclick="showStats()" style="margin: 2px;">查看統計</button>
            </div>
            
            <!-- 同步檢查 -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #6c757d;">
              <h4 style="margin: 0 0 10px 0; color: #6c757d;">🔄 同步檢查</h4>
              <button class="btn btn-secondary" onclick="checkVersions()" style="margin: 2px;">檢查版本</button>
              <button class="btn btn-secondary" onclick="checkFiles()" style="margin: 2px;">檢查檔案</button>
              <button class="btn btn-secondary" onclick="checkOnline()" style="margin: 2px;">檢查線上</button>
            </div>
            
            <!-- YouTube 檢查 -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #ff6b6b;">
              <h4 style="margin: 0 0 10px 0; color: #ff6b6b;">🎬 YouTube 檢查</h4>
              <button class="btn btn-danger" onclick="checkHeroVideos()" style="margin: 2px;">檢查 HERO 影片</button>
              <button class="btn btn-warning" onclick="checkContentfulVideos()" style="margin: 2px;">檢查 Contentful 影片</button>
              <button class="btn btn-info" onclick="openYouTubeChecker()" style="margin: 2px;">開啟檢查器</button>
            </div>
            
            <!-- 日誌管理 -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545;">
              <h4 style="margin: 0 0 10px 0; color: #dc3545;">📋 日誌管理</h4>
              <button class="btn btn-primary" onclick="showLogs()" style="margin: 2px;">查看日誌</button>
              <button class="btn btn-warning" onclick="exportLogs()" style="margin: 2px;">匯出日誌</button>
              <button class="btn btn-danger" onclick="clearAllLogs()" style="margin: 2px;">清除日誌</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 日誌顯示區域 -->
      <div class="log-container" id="logContainer" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h3 style="margin: 0;">📋 系統日誌</h3>
          <div>
            <button class="btn btn-warning" onclick="exportLogs()" style="margin-right: 10px;">匯出日誌</button>
            <button class="btn btn-danger" onclick="clearAllLogs()">清除日誌</button>
          </div>
        </div>
        <div id="logContent"></div>
      </div>
    </div>
  </div>

  <!-- 載入必要的腳本 -->
  <script src="https://cdn.jsdelivr.net/npm/contentful@latest/dist/contentful.browser.min.js"></script>
  <script>
    // 確保 Contentful SDK 載入完成後再載入其他腳本
    if (typeof contentful !== 'undefined') {
      console.log('✅ Contentful SDK 已載入');
    } else {
      console.error('❌ Contentful SDK 載入失敗');
    }
  </script>
  <script src="contentful-management-simple.js"></script>
  <script>
    // 等待 Management SDK 載入
    setTimeout(() => {
      if (typeof contentfulManagement !== 'undefined') {
        console.log('✅ Management SDK 已載入');
      } else {
        console.error('❌ Management SDK 載入失敗');
      }
    }, 2000);
  </script>
  <script src="contentful-real-only.js"></script>
  <script src="contentful-quick-check.js"></script>
  
  <script>
    let systemLogs = [];
    let systemStats = {
      totalUploads: 0,
      successfulUploads: 0,
      failedUploads: 0,
      lastUpload: null,
      connectionTests: 0,
      lastConnectionTest: null
    };
    
    // 載入統計資料
    function loadStats() {
      const saved = localStorage.getItem('contentful_system_stats');
      if (saved) {
        systemStats = { ...systemStats, ...JSON.parse(saved) };
      }
    }
    
    // 儲存統計資料
    function saveStats() {
      localStorage.setItem('contentful_system_stats', JSON.stringify(systemStats));
    }
    
    // 記錄日誌
    function log(level, message, details = null) {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = {
        timestamp,
        level,
        message,
        details
      };
      
      systemLogs.unshift(logEntry);
      if (systemLogs.length > 100) {
        systemLogs = systemLogs.slice(0, 100);
      }
      
      console.log(`[${timestamp}] ${level.toUpperCase()}: ${message}`, details);
      updateLogDisplay();
    }
    
    // 更新日誌顯示
    function updateLogDisplay() {
      const logContent = document.getElementById('logContent');
      if (!logContent) return;
      
      logContent.innerHTML = systemLogs.map(entry => {
        const levelClass = `log-${entry.level}`;
        return `
          <div class="log-entry">
            <span class="log-timestamp">[${entry.timestamp}]</span>
            <span class="${levelClass}">${entry.level.toUpperCase()}</span>
            <span>${entry.message}</span>
            ${entry.details ? `<br><small style="color: #6c757d;">${JSON.stringify(entry.details, null, 2)}</small>` : ''}
          </div>
        `;
      }).join('');
    }
    
    // 更新系統狀態
    async function updateSystemStatus() {
      try {
        // 檢查 SDK 狀態
        const sdkStatus = {
          contentful: typeof contentful !== 'undefined',
          contentfulManagement: typeof contentfulManagement !== 'undefined',
          contentfulRealOnly: typeof window.contentfulRealOnly !== 'undefined'
        };
        
        const sdkCount = Object.values(sdkStatus).filter(Boolean).length;
        const sdkStatusElement = document.getElementById('sdkStatus');
        const sdkStatusValue = document.getElementById('sdkStatusValue');
        
        if (sdkCount === 3) {
          sdkStatusElement.className = 'status-card success';
          sdkStatusValue.textContent = '✅ 正常';
        } else if (sdkCount > 0) {
          sdkStatusElement.className = 'status-card warning';
          sdkStatusValue.textContent = `⚠️ 部分載入 (${sdkCount}/3)`;
        } else {
          sdkStatusElement.className = 'status-card error';
          sdkStatusValue.textContent = '❌ 未載入';
        }
        
        // 檢查連線狀態
        const connectionStatusElement = document.getElementById('connectionStatus');
        const connectionStatusValue = document.getElementById('connectionStatusValue');
        
        if (window.contentfulRealOnly && window.contentfulRealOnly.isInitialized) {
          connectionStatusElement.className = 'status-card success';
          connectionStatusValue.textContent = '✅ 已連線';
        } else {
          connectionStatusElement.className = 'status-card warning';
          connectionStatusValue.textContent = '⚠️ 未連線';
        }
        
        // 檢查配置狀態
        const configStatusElement = document.getElementById('configStatus');
        const configStatusValue = document.getElementById('configStatusValue');
        
        if (window.contentfulRealOnly) {
          const config = window.contentfulRealOnly.getConfig();
          const hasValidConfig = config.spaceId && config.spaceId !== 'YOUR_SPACE_ID' &&
                                config.deliveryToken && config.deliveryToken !== 'YOUR_DELIVERY_TOKEN' &&
                                config.managementToken && config.managementToken !== 'YOUR_MANAGEMENT_TOKEN';
          
          if (hasValidConfig) {
            configStatusElement.className = 'status-card success';
            configStatusValue.textContent = '✅ 已配置';
          } else {
            configStatusElement.className = 'status-card error';
            configStatusValue.textContent = '❌ 配置不完整';
          }
        } else {
          configStatusElement.className = 'status-card error';
          configStatusValue.textContent = '❌ 系統未載入';
        }
        
        // 檢查上架狀態
        const uploadStatusElement = document.getElementById('uploadStatus');
        const uploadStatusValue = document.getElementById('uploadStatusValue');
        
        if (systemStats.totalUploads > 0) {
          const successRate = Math.round((systemStats.successfulUploads / systemStats.totalUploads) * 100);
          uploadStatusElement.className = successRate >= 80 ? 'status-card success' : 'status-card warning';
          uploadStatusValue.textContent = `${successRate}% 成功率`;
        } else {
          uploadStatusElement.className = 'status-card warning';
          uploadStatusValue.textContent = '⚠️ 未測試';
        }
        
      } catch (error) {
        log('error', '更新系統狀態失敗', error.message);
      }
    }
    
    // 系統診斷
    async function runSystemDiagnostic() {
      log('info', '開始系統診斷...');
      
      try {
        // 檢查 SDK 載入
        await checkSDKStatus();
        
        // 如果 Management SDK 未載入，嘗試載入
        if (typeof contentfulManagement === 'undefined') {
          log('warning', 'Management SDK 未載入，嘗試載入...');
          await forceLoadSDK();
        }
        
        // 檢查配置
        await checkConfig();
        
        // 測試連線
        await testConnection();
        
        // 更新狀態
        await updateSystemStatus();
        
        log('success', '系統診斷完成');
        
      } catch (error) {
        log('error', '系統診斷失敗', error.message);
      }
    }
    
    // 檢查 SDK 狀態
    async function checkSDKStatus() {
      log('info', '檢查 SDK 載入狀態...');
      
      const sdkStatus = {
        contentful: typeof contentful !== 'undefined',
        contentfulManagement: typeof contentfulManagement !== 'undefined',
        contentfulRealOnly: typeof window.contentfulRealOnly !== 'undefined'
      };
      
      log('info', 'SDK 狀態', sdkStatus);
      
      if (sdkStatus.contentful) {
        log('success', 'Contentful SDK 已載入');
      } else {
        log('error', 'Contentful SDK 未載入');
      }
      
      if (sdkStatus.contentfulManagement) {
        log('success', 'Management SDK 已載入');
      } else {
        log('error', 'Management SDK 未載入');
      }
      
      if (sdkStatus.contentfulRealOnly) {
        log('success', 'Contentful Real Only 系統已載入');
      } else {
        log('error', 'Contentful Real Only 系統未載入');
      }
    }
    
    // 檢查配置
    async function checkConfig() {
      log('info', '檢查系統配置...');
      
      if (window.contentfulRealOnly) {
        const config = window.contentfulRealOnly.getConfig();
        log('info', '系統配置', config);
        
        const hasSpaceId = config.spaceId && config.spaceId !== 'YOUR_SPACE_ID';
        const hasDeliveryToken = config.deliveryToken && config.deliveryToken !== 'YOUR_DELIVERY_TOKEN';
        const hasManagementToken = config.managementToken && config.managementToken !== 'YOUR_MANAGEMENT_TOKEN';
        
        if (hasSpaceId) {
          log('success', 'Space ID 已配置');
        } else {
          log('error', 'Space ID 未配置');
        }
        
        if (hasDeliveryToken) {
          log('success', 'Delivery Token 已配置');
        } else {
          log('error', 'Delivery Token 未配置');
        }
        
        if (hasManagementToken) {
          log('success', 'Management Token 已配置');
        } else {
          log('error', 'Management Token 未配置');
        }
      } else {
        log('error', 'Contentful Real Only 系統未載入');
      }
    }
    
    // 測試連線
    async function testConnection() {
      log('info', '開始測試連線...');
      systemStats.connectionTests++;
      systemStats.lastConnectionTest = new Date().toISOString();
      saveStats();
      
      try {
        if (!window.contentfulRealOnly) {
          throw new Error('Contentful 系統未載入');
        }
        
        await window.contentfulRealOnly.testConnection();
        log('success', '連線測試成功');
        
      } catch (error) {
        log('error', '連線測試失敗', error.message);
        throw error;
      }
    }
    
    // 初始化系統
    async function initializeSystem() {
      log('info', '開始初始化系統...');
      
      try {
        if (!window.contentfulRealOnly) {
          throw new Error('Contentful 系統未載入');
        }
        
        // 嘗試初始化 Management Ultimate 載入器
        if (!window.contentfulManagementUltimate) {
          log('warning', 'Management Ultimate 載入器未初始化，嘗試初始化...');
          initializeManagementUltimate();
        }
        
        // 嘗試載入 Management SDK
        if (typeof contentfulManagement === 'undefined' && window.contentfulManagementUltimate) {
          log('warning', 'Management SDK 未載入，嘗試載入...');
          try {
            await window.contentfulManagementUltimate.loadManagementSDK();
            log('success', 'Management SDK 載入成功');
          } catch (sdkError) {
            log('warning', `Management SDK 載入失敗: ${sdkError.message}`);
          }
        }
        
        await window.contentfulRealOnly.init();
        log('success', '系統初始化成功');
        
        await updateSystemStatus();
        
      } catch (error) {
        log('error', '系統初始化失敗', error.message);
        throw error;
      }
    }
    
    // 測試上架
    async function testUpload() {
      log('info', '開始測試上架...');
      
      try {
        await testBothUploads();
      } catch (error) {
        log('error', '上架測試失敗', error.message);
      }
    }
    
    // 測試影片上架
    async function testVideoUpload() {
      log('info', '測試影片上架...');
      systemStats.totalUploads++;
      
      try {
        if (!window.contentfulRealOnly) {
          throw new Error('Contentful 系統未載入');
        }
        
        // 檢查系統是否已初始化
        if (!window.contentfulRealOnly.isInitialized) {
          log('warning', '系統未初始化，嘗試初始化...');
          await initializeSystem();
        }
        
        const testData = {
          contentType: 'video',
          title: '測試影片 - ' + new Date().toLocaleTimeString(),
          videoType: 'YouTube',
          youtubeId: 'dQw4w9WgXcQ',
          description: '測試影片描述'
        };
        
        const result = await window.contentfulRealOnly.uploadProgram(testData);
        
        if (result.success) {
          systemStats.successfulUploads++;
          systemStats.lastUpload = new Date().toISOString();
          log('success', '影片上架測試成功', { entryId: result.entryId });
        } else {
          systemStats.failedUploads++;
          throw new Error('影片上架失敗');
        }
        
      } catch (error) {
        systemStats.failedUploads++;
        log('error', '影片上架測試失敗', error.message);
        throw error;
      } finally {
        saveStats();
        await updateSystemStatus();
      }
    }
    
    // 測試排表上架
    async function testScheduleUpload() {
      log('info', '測試排表上架...');
      systemStats.totalUploads++;
      
      try {
        if (!window.contentfulRealOnly) {
          throw new Error('Contentful 系統未載入');
        }
        
        // 檢查系統是否已初始化
        if (!window.contentfulRealOnly.isInitialized) {
          log('warning', '系統未初始化，嘗試初始化...');
          await initializeSystem();
        }
        
        const testData = {
          contentType: 'scheduleItem',
          title: '測試排表項目 - ' + new Date().toLocaleTimeString(),
          airDate: new Date().toISOString().split('T')[0],
          airTime: '14:00',
          slotNumber: 0,
          isFirstBroadcast: true,
          notes: '測試排表項目'
        };
        
        const result = await window.contentfulRealOnly.uploadProgram(testData);
        
        if (result.success) {
          systemStats.successfulUploads++;
          systemStats.lastUpload = new Date().toISOString();
          log('success', '排表上架測試成功', { entryId: result.entryId });
        } else {
          systemStats.failedUploads++;
          throw new Error('排表上架失敗');
        }
        
      } catch (error) {
        systemStats.failedUploads++;
        log('error', '排表上架測試失敗', error.message);
        throw error;
      } finally {
        saveStats();
        await updateSystemStatus();
      }
    }
    
    // 測試兩種上架
    async function testBothUploads() {
      log('info', '測試兩種內容類型上架...');
      
      try {
        await testVideoUpload();
        await new Promise(resolve => setTimeout(resolve, 1000)); // 等待1秒
        await testScheduleUpload();
        log('success', '兩種內容類型上架測試完成');
      } catch (error) {
        log('error', '兩種內容類型上架測試失敗', error.message);
        throw error;
      }
    }
    
    // 顯示日誌
    function showLogs() {
      const logContainer = document.getElementById('logContainer');
      logContainer.style.display = logContainer.style.display === 'none' ? 'block' : 'none';
      updateLogDisplay();
    }
    
    // 清除日誌
    function clearLogs() {
      systemLogs = [];
      updateLogDisplay();
      log('info', '日誌已清除');
    }
    
    // 清除所有日誌
    function clearAllLogs() {
      clearLogs();
      localStorage.removeItem('contentful_system_logs');
      log('info', '所有日誌已清除');
    }
    
    // 顯示統計
    function showStats() {
      log('info', '系統統計', systemStats);
    }
    
    // 其他功能函數
    async function forceLoadSDK() {
      log('info', '強制載入 SDK...');
      
      // 確保載入器已初始化
      if (!window.contentfulManagementUltimate) {
        if (!initializeManagementUltimate()) {
          log('error', '無法初始化 Management Ultimate 載入器');
          return;
        }
      }
      
      try {
        const result = await window.contentfulManagementUltimate.loadManagementSDK();
        if (result) {
          log('success', 'SDK 載入成功');
          await updateSystemStatus();
        } else {
          log('error', 'SDK 載入失敗');
        }
      } catch (error) {
        log('error', 'SDK 載入錯誤', error.message);
      }
    }
    
    function showSDKInfo() {
      const info = {
        contentful: typeof contentful !== 'undefined' ? '已載入' : '未載入',
        contentfulManagement: typeof contentfulManagement !== 'undefined' ? '已載入' : '未載入',
        contentfulRealOnly: typeof window.contentfulRealOnly !== 'undefined' ? '已載入' : '未載入'
      };
      log('info', 'SDK 資訊', info);
    }
    
    function testDeliveryAPI() {
      log('info', '測試 Delivery API...');
      testConnection();
    }
    
    function testManagementAPI() {
      log('info', '測試 Management API...');
      testConnection();
    }
    
    function validateTokens() {
      log('info', '驗證 Token...');
      checkConfig();
    }
    
    // 同步檢查功能
    async function checkVersions() {
      log('info', '開始檢查版本資訊...');
      
      try {
        // 檢查本地 Git 狀態
        const localCommit = await getLocalCommit();
        const remoteCommit = await getRemoteCommit();
        
        if (localCommit && remoteCommit) {
          if (localCommit === remoteCommit) {
            log('success', '本地版本與遠端版本一致');
          } else {
            log('warning', '本地版本與遠端版本不一致');
            log('info', `本地版本: ${localCommit.substring(0, 8)}`);
            log('info', `遠端版本: ${remoteCommit.substring(0, 8)}`);
          }
        } else {
          log('error', '無法獲取版本資訊');
        }
      } catch (error) {
        log('error', `檢查版本失敗: ${error.message}`);
      }
    }
    
    async function checkFiles() {
      log('info', '開始檢查檔案狀態...');
      
      try {
        const criticalFiles = [
          'index.html',
          'admin-calendar-unified.html',
          'contentful-main-console.html',
          'contentful-real-only.js',
          'contentful-management-ultimate.js'
        ];
        
        let allFilesOk = true;
        let accessibleFiles = 0;
        
        for (const file of criticalFiles) {
          try {
            // 使用絕對路徑或相對路徑
            const filePath = file.startsWith('/') ? file : `./${file}`;
            const response = await fetch(filePath, { method: 'HEAD' });
            
            if (response.ok) {
              log('success', `${file} - 可存取`);
              accessibleFiles++;
            } else {
              allFilesOk = false;
              log('error', `${file} - 無法存取 (${response.status})`);
            }
          } catch (error) {
            allFilesOk = false;
            log('error', `${file} - 載入錯誤: ${error.message}`);
          }
        }
        
        if (allFilesOk) {
          log('success', '所有關鍵檔案都可存取');
        } else {
          log('warning', `部分檔案無法存取 (${accessibleFiles}/${criticalFiles.length} 可存取)`);
        }
      } catch (error) {
        log('error', `檢查檔案失敗: ${error.message}`);
      }
    }
    
    async function checkOnline() {
      log('info', '開始檢查線上版本...');
      
      try {
        const onlineUrl = 'https://tv.tcawg.com';
        log('info', '請手動前往 https://tv.tcawg.com 檢查線上版本');
        log('info', '線上版本應該顯示「目前暫無節目」卡片');
        log('warning', '由於 CORS 限制，無法直接檢查線上版本');
      } catch (error) {
        log('error', `檢查線上版本失敗: ${error.message}`);
      }
    }
    
    // 獲取本地 commit hash (模擬)
    async function getLocalCommit() {
      // 這裡應該讀取 .git/refs/heads/main 檔案
      // 但由於瀏覽器安全限制，我們無法直接讀取
      // 實際應用中需要通過後端 API 獲取
      return 'local-commit-hash';
    }
    
    // 獲取遠端 commit hash (模擬)
    async function getRemoteCommit() {
      // 這裡應該讀取 .git/refs/remotes/origin/main 檔案
      // 但由於瀏覽器安全限制，我們無法直接讀取
      // 實際應用中需要通過後端 API 獲取
      return 'remote-commit-hash';
    }
    
    function showConfig() {
      if (window.contentfulRealOnly) {
        const config = window.contentfulRealOnly.getConfig();
        log('info', '系統配置', config);
      } else {
        log('error', 'Contentful 系統未載入');
      }
    }
    
    function exportLogs() {
      const logsText = systemLogs.map(log => 
        `[${log.timestamp}] ${log.level.toUpperCase()}: ${log.message}`
      ).join('\n');
      
      const blob = new Blob([logsText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `contentful-logs-${new Date().toISOString().slice(0, 10)}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      
      log('success', '日誌已匯出');
    }
    
    // === YouTube 檢查功能 ===
    
    // HERO 影片資料 - 從 hero.json 載入
    let heroVideos = [];
    
    // 載入 HERO 影片資料 - 優先使用 Contentful
    async function loadHeroVideosForConsole() {
      // 首先嘗試從 Contentful 載入
      try {
        if (window.contentfulRealOnly) {
          const client = window.contentfulRealOnly.deliveryClient;
          const response = await client.getEntries({
            content_type: 'video',
            'fields.isHero': true,
            order: '-sys.updatedAt',
            limit: 1000
          });
          
          const contentfulVideos = response.items.map(item => ({
            id: item.fields.youTubeId || item.fields.youtubeId || item.fields.YouTubeID || '',
            title: item.fields.heroTitle || item.fields.title || '',
            desc: item.fields.heroText || item.fields.description || ''
          })).filter(v => v.id);
          
          if (contentfulVideos.length > 0) {
            heroVideos = contentfulVideos;
            log('success', `✅ 從 Contentful 載入 ${heroVideos.length} 個 HERO 影片`);
            return;
          }
        }
      } catch (error) {
        log('warning', `Contentful 載入失敗: ${error.message}`);
      }
      
      // 只使用 Contentful 資料，不提供備用資料
      log('error', '無法從 Contentful 載入 HERO 影片資料');
      log('info', '請檢查 Contentful 連線設定或在 Contentful 中設定 HERO 影片 (isHero: true)');
      heroVideos = [];
    }
    
    async function checkHeroVideos() {
      log('info', '開始檢查 HERO 影片狀態...');
      log('info', `將檢查 ${heroVideos.length} 個 HERO 影片`);
      
      let availableCount = 0;
      let unavailableCount = 0;
      const unavailableVideos = [];
      
      for (let i = 0; i < heroVideos.length; i++) {
        const video = heroVideos[i];
        log('info', `檢查影片 ${i + 1}/${heroVideos.length}: ${video.title} (${video.id})`);
        
        try {
          const isAvailable = await checkVideoAvailability(video.id);
          if (isAvailable) {
            availableCount++;
            log('success', `✅ ${video.title} - 可播放`);
          } else {
            unavailableCount++;
            unavailableVideos.push(video);
            log('error', `❌ ${video.title} - 無法播放`);
          }
        } catch (error) {
          unavailableCount++;
          unavailableVideos.push(video);
          log('error', `❌ ${video.title} - 檢查失敗: ${error.message}`);
        }
        
        // 延遲避免請求過於頻繁
        await new Promise(resolve => setTimeout(resolve, 500));
      }
      
      // 顯示檢查結果摘要
      const availabilityRate = Math.round((availableCount / heroVideos.length) * 100);
      log('success', `HERO 影片檢查完成！`);
      log('info', `總數: ${heroVideos.length}, 可用: ${availableCount}, 不可用: ${unavailableCount}, 可用率: ${availabilityRate}%`);
      
      if (unavailableVideos.length > 0) {
        log('warning', '無法播放的影片:');
        unavailableVideos.forEach(video => {
          log('error', `- ${video.title} (${video.id})`);
        });
      }
    }
    
    async function checkContentfulVideos() {
      log('info', '開始檢查 Contentful 中的 HERO 影片...');
      
      try {
        if (!window.contentfulRealOnly) {
          log('error', 'Contentful 系統未載入');
          return;
        }
        
        const client = window.contentfulRealOnly.getClient();
        const response = await client.getEntries({
          content_type: 'video',
          'fields.isHero': true,
          order: '-sys.updatedAt',
          limit: 1000
        });
        
        const contentfulVideos = response.items.map(item => ({
          id: item.fields.youTubeId || item.fields.youtubeId || '',
          title: item.fields.heroTitle || item.fields.title || '',
          desc: item.fields.heroText || item.fields.description || ''
        })).filter(v => v.id);
        
        log('info', `找到 ${contentfulVideos.length} 個 Contentful HERO 影片`);
        
        let availableCount = 0;
        let unavailableCount = 0;
        
        for (let i = 0; i < contentfulVideos.length; i++) {
          const video = contentfulVideos[i];
          log('info', `檢查 Contentful 影片 ${i + 1}/${contentfulVideos.length}: ${video.title} (${video.id})`);
          
          try {
            const isAvailable = await checkVideoAvailability(video.id);
            if (isAvailable) {
              availableCount++;
              log('success', `✅ ${video.title} - 可播放`);
            } else {
              unavailableCount++;
              log('error', `❌ ${video.title} - 無法播放`);
            }
          } catch (error) {
            unavailableCount++;
            log('error', `❌ ${video.title} - 檢查失敗: ${error.message}`);
          }
          
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        const availabilityRate = Math.round((availableCount / contentfulVideos.length) * 100);
        log('success', `Contentful HERO 影片檢查完成！`);
        log('info', `總數: ${contentfulVideos.length}, 可用: ${availableCount}, 不可用: ${unavailableCount}, 可用率: ${availabilityRate}%`);
        
      } catch (error) {
        log('error', `檢查 Contentful 影片失敗: ${error.message}`);
      }
    }
    
    async function checkVideoAvailability(videoId) {
      return new Promise((resolve) => {
        const thumbnailUrl = `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`;
        const img = new Image();
        
        img.onload = () => resolve(true);
        img.onerror = () => resolve(false);
        
        // 設定超時
        setTimeout(() => resolve(false), 5000);
        
        img.src = thumbnailUrl;
      });
    }
    
    function openYouTubeChecker() {
      log('info', '開啟 YouTube 檢查器...');
      window.open('check-hero-videos.html', '_blank');
    }
    
    
    // 初始化 Management Ultimate 載入器
    function initializeManagementUltimate() {
      // 檢查是否已經有全域實例
      if (window.contentfulManagementUltimate) {
        log('success', 'Management Ultimate 載入器已存在');
        return true;
      }
      
      // 檢查類別是否可用
      if (typeof ContentfulManagementUltimate !== 'undefined') {
        window.contentfulManagementUltimate = new ContentfulManagementUltimate();
        log('success', 'Management Ultimate 載入器已初始化');
        return true;
      } else {
        log('error', 'Management Ultimate 載入器類別未載入');
        return false;
      }
    }

    // 頁面載入完成後初始化
    document.addEventListener('DOMContentLoaded', async function() {
      log('info', '主控台載入完成');
      loadStats();
      
      // 載入 HERO 影片資料
      await loadHeroVideosForConsole();
      
      // 初始化 Management Ultimate 載入器
      initializeManagementUltimate();
      
      // 等待 SDK 載入
      setTimeout(async () => {
        await updateSystemStatus();
        log('success', '系統狀態已更新');
      }, 2000);
    });
  </script>
</body>
</html>
