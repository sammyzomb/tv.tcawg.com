<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>後台主控台 - 航向世界旅遊頻道</title>
  
  <!-- AdminLTE 3 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  
  <style>
    body { 
      background: #f4f6f9;
      min-height: 100vh;
    }
    
    .content-wrapper {
      padding: 20px;
    }
    
    .header { 
      background: white; 
      padding: 20px; 
      border-radius: 4px; 
      margin-bottom: 20px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      text-align: center;
    }
    
    .header h1 { 
      color: #495057; 
      margin-bottom: 10px; 
      font-size: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }
    
    .header-icon {
      font-size: 2rem;
      color: #007bff;
    }
    
    .header p { 
      color: #6c757d; 
      font-size: 1rem;
      margin: 0;
    }
    
    .user-info { 
      background: white; 
      padding: 15px 20px; 
      border-radius: 4px; 
      margin-bottom: 20px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    }
    
    .user-info .user-details { 
      color: #495057; 
      font-weight: 600; 
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .user-icon {
      font-size: 1.2rem;
      color: #007bff;
    }
    
    .user-info .logout-btn { 
      background: #dc3545; 
      color: white; 
      border: none; 
      padding: 8px 16px; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 14px;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .user-info .logout-btn:hover { 
      background: #c82333; 
    }
    
    .logout-icon {
      font-size: 14px;
    }
    
    .section-label {
      color: #6c757d;
      font-size: 0.85rem;
      font-weight: 600;
      margin: 24px 0 12px 0;
      padding-bottom: 6px;
      border-bottom: 1px solid #dee2e6;
    }
    .section-label:first-of-type { margin-top: 0; }
    .dashboard-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); 
      gap: 16px; 
      margin-bottom: 8px;
    }
    .module-card { 
      background: white; 
      padding: 16px; 
      border-radius: 6px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      text-align: center;
      transition: all 0.2s ease;
      cursor: pointer;
      border: 1px solid #e9ecef;
    }
    .module-card:hover { 
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      border-color: #007bff;
    }
    .module-icon { 
      font-size: 2rem;
      margin: 0 auto 10px;
      display: block;
      color: #007bff;
    }
    .module-title { 
      color: #495057; 
      font-size: 1.1rem; 
      font-weight: 600; 
      margin-bottom: 6px;
    }
    .module-description { 
      color: #6c757d; 
      margin-bottom: 12px; 
      line-height: 1.4;
      font-size: 0.8rem;
    }
    .more-links {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .more-links a {
      color: #495057;
      font-size: 0.9rem;
      text-decoration: none;
      padding: 6px 12px;
      background: #f8f9fa;
      border-radius: 4px;
      border: 1px solid #dee2e6;
      transition: all 0.2s ease;
    }
    .more-links a:hover { background: #e9ecef; border-color: #007bff; color: #007bff; }
    
    .enter-btn { 
      background: #007bff; 
      color: white; 
      border: none; 
      padding: 8px 16px; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 0.85rem; 
      font-weight: 600;
      transition: all 0.2s ease;
      width: 100%;
    }
    .enter-btn:hover { background: #0056b3; }
    
    .quick-actions { 
      background: white; 
      padding: 20px; 
      border-radius: 4px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    }
    
    .quick-actions h3 { 
      color: #495057; 
      margin-bottom: 15px; 
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .quick-actions-icon {
      font-size: 1.1rem;
      color: #007bff;
    }
    
    .action-buttons { 
      display: flex; 
      gap: 10px; 
      flex-wrap: wrap;
    }
    
    .action-btn { 
      background: #f8f9fa; 
      color: #495057; 
      border: 1px solid #dee2e6; 
      padding: 8px 16px; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 14px;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .action-btn:hover { 
      background: #007bff; 
      color: white; 
      border-color: #007bff;
    }
    
    .action-btn-icon {
      font-size: 14px;
    }
    
    .status-indicator { 
      display: inline-block; 
      width: 8px; 
      height: 8px; 
      border-radius: 50%; 
      margin-right: 8px;
    }
    
    .status-online { background: #28a745; }
    .status-offline { background: #dc3545; }
    
    @media (max-width: 768px) {
      .dashboard-grid { grid-template-columns: 1fr; gap: 12px; }
      .module-card { padding: 14px; }
      .action-buttons { flex-direction: column; }
      .header h1 { font-size: 1.5rem; }
    }
  </style>
</head>
<body class="hold-transition sidebar-mini">
  <div class="wrapper">
    <div class="content-wrapper">
      <div class="container-fluid">
        <div class="header">
          <h1>
            <i class="fas fa-tachometer-alt header-icon"></i>
            後台管理主控台
          </h1>
          <p>航向世界旅遊頻道 - 節目管理系統</p>
        </div>
    
    <!-- 用戶資訊顯示 -->
    <div class="user-info" id="userInfo" style="display: none;">
      <div class="user-details" id="userDetails"></div>
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt logout-icon"></i>
          登出系統
        </button>
    </div>
    
    <!-- 管理模組：本站影片上架 -->
    <p class="section-label">本站影片上架</p>
    <div class="dashboard-grid">
      <div class="module-card" onclick="navigateToModule('admin-calendar-unified.html')">
        <i class="fas fa-calendar-alt module-icon"></i>
        <h2 class="module-title">統一節目管理</h2>
        <p class="module-description">節目表、排程、上架 Contentful。內含 Contentful 主控台。</p>
        <button class="enter-btn">進入</button>
      </div>
      <div class="module-card" onclick="navigateToModule('admin-hero-videos-unified.html')">
        <i class="fas fa-video module-icon"></i>
        <h2 class="module-title">HERO 影片</h2>
        <p class="module-description">首頁大圖輪播影片的設定與檢查。</p>
        <button class="enter-btn">進入</button>
      </div>
      <div class="module-card" onclick="navigateToModule('admin-published-programs.html')">
        <i class="fas fa-tv module-icon"></i>
        <h2 class="module-title">已上架節目</h2>
        <p class="module-description">查看、篩選、下架已上架到 Contentful 的節目。</p>
        <button class="enter-btn">進入</button>
      </div>
    </div>

    <!-- 系統與安全 -->
    <p class="section-label">系統與安全</p>
    <div class="dashboard-grid">
      <div class="module-card" onclick="navigateToModule('admin-users-list.html')">
        <i class="fas fa-users module-icon"></i>
        <h2 class="module-title">用戶管理</h2>
        <p class="module-description">帳號、權限、活動記錄。</p>
        <button class="enter-btn">進入</button>
      </div>
      <div class="module-card" onclick="navigateToModule('admin-login-logs.html')">
        <i class="fas fa-clipboard-list module-icon"></i>
        <h2 class="module-title">登入日誌</h2>
        <p class="module-description">登入審計、IP 封鎖與安全紀錄。</p>
        <button class="enter-btn">進入</button>
      </div>
    </div>

    <!-- 更多：進階功能 -->
    <p class="section-label">更多</p>
    <div class="more-links">
      <a href="admin-templates.html">節目範本管理</a>
      <a href="admin-topics-management.html">主題館管理</a>
      <a href="admin-featured-videos.html">精選節目管理</a>
    </div>

    <!-- 快速操作 -->
    <div class="quick-actions">
      <h3><i class="fas fa-bolt quick-actions-icon"></i> 快速操作</h3>
      <div class="action-buttons">
        <a href="admin-login.html" class="action-btn"><i class="fas fa-sign-in-alt action-btn-icon"></i> 重新登入</a>
        <a href="admin-change-password.html" class="action-btn"><i class="fas fa-key action-btn-icon"></i> 修改密碼</a>
        <button class="action-btn" onclick="clearCache()"><i class="fas fa-trash-alt action-btn-icon"></i> 清除快取</button>
        <button class="action-btn" onclick="showSystemInfo()"><i class="fas fa-info-circle action-btn-icon"></i> 系統資訊</button>
        <a href="create-admin-simple.html" class="action-btn" id="createAdminBtn" style="display: none;"><i class="fas fa-user-plus action-btn-icon"></i> 創建管理員</a>
      </div>
    </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // Firebase 9 模組化導入
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    // Firebase 配置
    const firebaseConfig = {
      apiKey: "AIzaSyB5MLyG5H1sCflHFU7WeKQCmC0Ft5TIqjM",
      authDomain: "tv-tcawg-com.firebaseapp.com",
      projectId: "tv-tcawg-com",
      storageBucket: "tv-tcawg-com.firebasestorage.app",
      messagingSenderId: "313251141126",
      appId: "1:313251141126:web:88ef97ce28798c0a2e9587",
      measurementId: "G-83Z5VTRTZH"
    };

    // 初始化 Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 啟用 Firestore 離線支援
    enableIndexedDbPersistence(db).catch((err) => {
      if (err.code === 'failed-precondition') {
        console.log('多個標籤頁可能影響離線支援');
      } else if (err.code === 'unimplemented') {
        console.log('瀏覽器不支援離線支援');
      }
    });

    // 設定全域變數
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.firebaseApp = app;
    window.firebase9Loaded = true;

    console.log('Firebase 已初始化');
  </script>

  <!-- 管理員帳號服務（與登入頁一致，使用 admin-accounts-service.js） -->
  <script src="admin-accounts-service.js"></script>

  <script>
    // 登入驗證檢查
    function checkAuth() {
      // 優先檢查 Firebase 認證狀態
      if (window.firebaseAuth && window.firebaseAuth.currentUser) {
        const firebaseUser = window.firebaseAuth.currentUser;
        console.log('Firebase 用戶已登入:', firebaseUser.email);
        
        // 檢查是否為已知的超級管理員（優先檢查）
        if (firebaseUser.email === 'sammyzomb@gmail.com') {
          console.log('識別為超級管理員 (sammyzomb@gmail.com)');
          return {
            uid: firebaseUser.uid,
            email: firebaseUser.email,
            displayName: 'Sammy Zomb',
            name: 'Sammy Zomb',
            role: 'super_admin',
            permissions: ['read', 'write', 'delete', 'publish', 'admin', 'system'],
            provider: 'firebase'
          };
        }
        
        // 嘗試從管理員帳號服務獲取用戶資訊
        if (window.adminAccountsService) {
          try {
            // 根據電子郵件查找用戶帳號資訊
            const accountsData = window.adminAccountsService.getLocalBackup();
            if (accountsData && accountsData.accounts) {
              const account = accountsData.accounts.find(acc => acc.email === firebaseUser.email);
              if (account) {
                console.log('找到用戶帳號資訊:', account);
                return {
                  uid: firebaseUser.uid,
                  email: firebaseUser.email,
                  displayName: account.name || '管理員',
                  name: account.name || '管理員',
                  role: account.role || 'admin',
                  permissions: account.permissions || [],
                  provider: 'firebase'
                };
              }
            }
          } catch (error) {
            console.log('無法從管理員帳號服務獲取資訊:', error);
          }
        }
        
        // 預設返回管理員角色
        return {
          uid: firebaseUser.uid,
          email: firebaseUser.email,
          displayName: firebaseUser.displayName || '管理員',
          name: firebaseUser.displayName || firebaseUser.email || '管理員',
          role: 'admin',
          provider: 'firebase'
        };
      }
      
      // 檢查本地 sessionStorage
      const user = sessionStorage.getItem('adminUser');
      const loginTime = sessionStorage.getItem('loginTime');
      
      if (!user || !loginTime) {
        // 未登入，跳轉到登入頁面
        window.location.href = 'admin-login.html';
        return null;
      }
      
      // 檢查登入是否超過 8 小時
      const loginDate = new Date(loginTime);
      const now = new Date();
      const hoursDiff = (now - loginDate) / (1000 * 60 * 60);
      
      if (hoursDiff >= 8) {
        // 登入已過期，清除 session 並跳轉到登入頁面
        sessionStorage.removeItem('adminUser');
        sessionStorage.removeItem('loginTime');
        window.location.href = 'admin-login.html';
        return null;
      }
      
      return JSON.parse(user);
    }
    
    // 登出功能
    function logout() {
      // 清除本地存儲
      sessionStorage.removeItem('adminUser');
      sessionStorage.removeItem('loginTime');
      
      // 清除 Firebase 認證狀態
      if (window.firebaseAuth) {
        window.firebaseAuth.signOut().then(() => {
          console.log('Firebase 用戶已登出');
          window.location.href = 'admin-login.html';
        }).catch((error) => {
          console.error('Firebase 登出錯誤:', error);
          window.location.href = 'admin-login.html';
        });
      } else {
        // 如果 Firebase 未載入，直接跳轉
        window.location.href = 'admin-login.html';
      }
    }
    
    // 更新用戶資訊顯示
    function updateUserInfo() {
      const userInfo = document.getElementById('userInfo');
      const userDetails = document.getElementById('userDetails');
      const createAdminBtn = document.getElementById('createAdminBtn');
      
      if (currentUser) {
        userInfo.style.display = 'flex';
        
        // 安全地獲取用戶資訊，避免 undefined
        const userName = currentUser.name || currentUser.displayName || currentUser.email || '管理員';
        const userRole = currentUser.role || '管理員';
        const loginTime = sessionStorage.getItem('loginTime');
        const loginTimeStr = loginTime ? new Date(loginTime).toLocaleString() : '未知';
        
        userDetails.innerHTML = `
          <i class="fas fa-user user-icon"></i>
          <span class="status-indicator status-online"></span>
          歡迎，${userName} (${userRole}) | 
          登入時間：${loginTimeStr} | 
          <span style="color: #2b71d2; font-weight: 600;">版本：v1.2.0 (2025/08/28 18:30:00)</span>
        `;
        
        // 檢查用戶是否有管理其他管理員的權限
        console.log('檢查用戶權限:', {
          email: currentUser.email,
          role: userRole,
          permissions: currentUser.permissions
        });
        
        // 優先檢查是否為已知的超級管理員
        const isKnownSuperAdmin = currentUser.email === 'sammyzomb@gmail.com';
        const hasAdminPermission = isKnownSuperAdmin || 
                                 userRole === 'super_admin' || 
                                 (currentUser.permissions && currentUser.permissions.includes('admin'));
        
        if (hasAdminPermission) {
          console.log('用戶具有管理員管理權限，顯示創建管理員按鈕');
          createAdminBtn.style.display = 'inline-flex';
        } else {
          console.log('用戶不具有管理員管理權限，隱藏創建管理員按鈕');
          createAdminBtn.style.display = 'none';
        }
      }
    }
    
    // 導航到指定模組
    function navigateToModule(url) {
      // 添加過渡動畫效果
      document.body.style.opacity = '0.7';
      setTimeout(() => {
        window.location.href = url;
      }, 300);
    }
    
    // 清除快取
    function clearCache() {
      if (confirm('確定要清除瀏覽器快取嗎？這將清除所有暫存的資料。')) {
        sessionStorage.clear();
        localStorage.clear();
        alert('快取已清除！請重新登入。');
        window.location.href = 'admin-login.html';
      }
    }
    
    // 顯示系統資訊
    function showSystemInfo() {
      const info = `
系統資訊：
- 瀏覽器：${navigator.userAgent}
- 螢幕解析度：${screen.width}x${screen.height}
- 登入用戶：${currentUser.name}
- 用戶角色：${currentUser.role}
- 登入時間：${new Date(sessionStorage.getItem('loginTime')).toLocaleString()}
- 系統時間：${new Date().toLocaleString()}
- 當前版本：v1.2.0
- 版本發布：2025/08/28 18:30:00
- 最後更新：2025/08/28
      `;
      alert(info);
    }
    
    // 全域變數
    let currentUser = null;
    
    // 頁面載入時檢查登入狀態
    document.addEventListener('DOMContentLoaded', async function() {
      // 等待 Firebase 載入（管理員帳號服務可選，不阻塞進入）
      const waitForServices = setInterval(function() {
        if (window.firebaseAuth) {
          clearInterval(waitForServices);
          console.log('Firebase 已載入', window.adminAccountsService ? '，管理員帳號服務已載入' : '（管理員帳號服務未載入，不影響使用）');
          
          currentUser = checkAuth();
          if (!currentUser) return;
          
          updateUserInfo();
          
          document.body.style.opacity = '0';
          setTimeout(function() {
            document.body.style.transition = 'opacity 0.5s ease';
            document.body.style.opacity = '1';
          }, 100);
        }
      }, 100);
      
      // 若 8 秒後 Firebase 仍未載入才提示（多數為網路或 CDN 問題）
      setTimeout(function() {
        if (!window.firebaseAuth) {
          console.error('Firebase 載入超時');
          alert('❌ 系統服務載入超時\n\n請檢查網路後重新整理頁面。');
        }
      }, 8000);
    });
  </script>
  
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Bootstrap 4 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- AdminLTE 3 -->
  <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
</body>
</html>

