<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>後台主控台 - 航向世界旅遊頻道</title>
  
  <!-- AdminLTE 3 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  
  <style>
    body { 
      background: #f4f6f9;
      min-height: 100vh;
    }
    
    .content-wrapper {
      padding: 20px;
    }
    
    .header { 
      background: white; 
      padding: 20px; 
      border-radius: 4px; 
      margin-bottom: 20px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      text-align: center;
    }
    
    .header h1 { 
      color: #495057; 
      margin-bottom: 10px; 
      font-size: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }
    
    .header-icon {
      font-size: 2rem;
      color: #007bff;
    }
    
    .header p { 
      color: #6c757d; 
      font-size: 1rem;
      margin: 0;
    }
    
    .user-info { 
      background: white; 
      padding: 15px 20px; 
      border-radius: 4px; 
      margin-bottom: 20px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    }
    
    .user-info .user-details { 
      color: #495057; 
      font-weight: 600; 
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .user-icon {
      font-size: 1.2rem;
      color: #007bff;
    }
    
    .user-info .logout-btn { 
      background: #dc3545; 
      color: white; 
      border: none; 
      padding: 8px 16px; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 14px;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .user-info .logout-btn:hover { 
      background: #c82333; 
    }
    
    .logout-icon {
      font-size: 14px;
    }
    
    .dashboard-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
      gap: 20px; 
      margin-bottom: 20px;
    }
    
    .module-card { 
      background: white; 
      padding: 20px; 
      border-radius: 4px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      border: 1px solid #dee2e6;
    }
    
    .module-card:hover { 
      box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
      border-color: #007bff;
    }
    
    .module-icon { 
      font-size: 3rem;
      margin: 0 auto 15px;
      display: block;
      color: #007bff;
    }
    
    .module-title { 
      color: #495057; 
      font-size: 1.25rem; 
      font-weight: 600; 
      margin-bottom: 10px;
    }
    
    .module-description { 
      color: #6c757d; 
      margin-bottom: 15px; 
      line-height: 1.5;
      font-size: 0.9rem;
    }
    
    .module-stats { 
      background: #f8f9fa; 
      padding: 10px; 
      border-radius: 4px; 
      margin-bottom: 15px;
      font-size: 0.85rem;
      color: #6c757d;
    }
    
    .enter-btn { 
      background: #007bff; 
      color: white; 
      border: none; 
      padding: 10px 20px; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 0.9rem; 
      font-weight: 600;
      transition: all 0.3s ease;
      width: 100%;
    }
    
    .enter-btn:hover { 
      background: #0056b3;
    }
    
    .quick-actions { 
      background: white; 
      padding: 20px; 
      border-radius: 4px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    }
    
    .quick-actions h3 { 
      color: #495057; 
      margin-bottom: 15px; 
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .quick-actions-icon {
      font-size: 1.1rem;
      color: #007bff;
    }
    
    .action-buttons { 
      display: flex; 
      gap: 10px; 
      flex-wrap: wrap;
    }
    
    .action-btn { 
      background: #f8f9fa; 
      color: #495057; 
      border: 1px solid #dee2e6; 
      padding: 8px 16px; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 14px;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .action-btn:hover { 
      background: #007bff; 
      color: white; 
      border-color: #007bff;
    }
    
    .action-btn-icon {
      font-size: 14px;
    }
    
    .status-indicator { 
      display: inline-block; 
      width: 8px; 
      height: 8px; 
      border-radius: 50%; 
      margin-right: 8px;
    }
    
    .status-online { background: #28a745; }
    .status-offline { background: #dc3545; }
    
    @media (max-width: 768px) {
      .dashboard-grid { 
        grid-template-columns: 1fr; 
        gap: 15px;
      }
      
      .module-card { 
        padding: 15px; 
      }
      
      .action-buttons { 
        flex-direction: column;
      }
      
      .header h1 { 
        font-size: 1.5rem; 
      }
    }
  </style>
</head>
<body class="hold-transition sidebar-mini">
  <div class="wrapper">
    <div class="content-wrapper">
      <div class="container-fluid">
        <div class="header">
          <h1>
            <i class="fas fa-tachometer-alt header-icon"></i>
            後台管理主控台
          </h1>
          <p>航向世界旅遊頻道 - 節目管理系統</p>
        </div>
    
    <!-- 用戶資訊顯示 -->
    <div class="user-info" id="userInfo" style="display: none;">
      <div class="user-details" id="userDetails"></div>
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt logout-icon"></i>
          登出系統
        </button>
    </div>
    
    <!-- 管理模組卡片 -->
    <div class="dashboard-grid">
        <!-- 統一節目管理 -->
        <div class="module-card" onclick="navigateToModule('admin-calendar-unified.html')">
          <i class="fas fa-calendar-alt module-icon"></i>
        <h2 class="module-title">統一節目管理</h2>
        <p class="module-description">
          整合月曆、週曆、日曆三種視圖的統一管理系統，類似 Google Calendar。
          支援節目上傳、編輯、批量管理和統一資料管理。
        </p>
        <div class="module-stats">
          <span class="status-indicator status-online"></span>
          系統狀態：正常運作
        </div>
        <button class="enter-btn">進入統一管理</button>
      </div>
      
        <!-- 節目範本管理 -->
        <div class="module-card" onclick="navigateToModule('admin-templates.html')">
          <i class="fas fa-file-alt module-icon"></i>
        <h2 class="module-title">節目範本管理</h2>
        <p class="module-description">
          管理節目範本庫，支援範本創建、編輯和快速套用。
          適合建立標準化節目格式和批量節目安排。
        </p>
        <div class="module-stats">
          <span class="status-indicator status-online"></span>
          系統狀態：正常運作
        </div>
        <button class="enter-btn">進入範本管理</button>
      </div>
      
        <!-- 已上架節目管理 -->
        <div class="module-card" onclick="navigateToModule('admin-published-programs.html')">
          <i class="fas fa-tv module-icon"></i>
        <h2 class="module-title">已上架節目管理</h2>
        <p class="module-description">
          查看和管理所有已上架到 Contentful 的節目。
          支援篩選、統計和下架操作。
        </p>
        <div class="module-stats">
          <span class="status-indicator status-online"></span>
          系統狀態：正常運作
        </div>
        <button class="enter-btn">進入上架管理</button>
      </div>
      
        <!-- Contentful 同步狀態 -->
        <div class="module-card" onclick="navigateToModule('contentful-sync-status.html')">
          <i class="fas fa-sync-alt module-icon"></i>
        <h2 class="module-title">Contentful 同步狀態</h2>
        <p class="module-description">
          監控和管理節目同步到 Contentful 的狀態。
          支援批量同步、進度追蹤和錯誤診斷。
        </p>
        <div class="module-stats">
          <span class="status-indicator status-online"></span>
          系統狀態：正常運作
        </div>
        <button class="enter-btn">查看同步狀態</button>
      </div>
      
        <!-- 用戶管理 -->
        <div class="module-card" onclick="navigateToModule('admin-users-list.html')">
          <i class="fas fa-users module-icon"></i>
        <h2 class="module-title">用戶管理</h2>
        <p class="module-description">
          管理系統用戶帳號、權限設定和活動記錄。
          支援用戶創建、編輯、刪除和權限控制。
        </p>
        <div class="module-stats">
          <span class="status-indicator status-online"></span>
          系統狀態：正常運作
        </div>
        <button class="enter-btn">進入用戶管理</button>
      </div>
      
        <!-- 主題館管理 -->
        <div class="module-card" onclick="navigateToModule('admin-topics-management.html')">
          <i class="fas fa-search module-icon"></i>
        <h2 class="module-title">主題館管理</h2>
        <p class="module-description">
          管理主題探索頁面的內容、圖片和設定。
          支援主題新增、編輯、背景圖片設定和狀態管理。
        </p>
        <div class="module-stats">
          <span class="status-indicator status-online"></span>
          系統狀態：正常運作
        </div>
        <button class="enter-btn">進入主題館管理</button>
      </div>
      
        <!-- 登入日誌管理 -->
        <div class="module-card" onclick="navigateToModule('admin-login-logs.html')">
          <i class="fas fa-clipboard-list module-icon"></i>
        <h2 class="module-title">登入日誌管理</h2>
        <p class="module-description">
          完整的登入審計系統，記錄所有登入嘗試、IP 封鎖機制、
          權限分層管理和安全保護功能。
        </p>
        <div class="module-stats">
          <span class="status-indicator status-online"></span>
          系統狀態：正常運作
        </div>
        <button class="enter-btn">進入日誌管理</button>
      </div>
      
        <!-- HERO 影片設定 -->
        <div class="module-card" onclick="navigateToModule('admin-hero-videos-unified.html')">
          <i class="fas fa-video module-icon"></i>
        <h2 class="module-title">HERO 影片設定</h2>
        <p class="module-description">
          管理首頁 HERO 影片的播放設定、檢查影片可用性、
          更新影片清單和播放順序。確保首頁影片正常播放。
        </p>
        <div class="module-stats">
          <span class="status-indicator status-online"></span>
          系統狀態：正常運作
        </div>
        <button class="enter-btn">進入 HERO 設定</button>
      </div>
    </div>
    
        <!-- 快速操作 -->
        <div class="quick-actions">
          <h3>
            <i class="fas fa-bolt quick-actions-icon"></i>
            快速操作
          </h3>
          <div class="action-buttons">
            <a href="debug-admin-system.html" class="action-btn">
              <i class="fas fa-tools action-btn-icon"></i>
              系統調試
            </a>
            <a href="admin-login.html" class="action-btn">
              <i class="fas fa-sign-in-alt action-btn-icon"></i>
              重新登入
            </a>
            <a href="admin-change-password.html" class="action-btn">
              <i class="fas fa-key action-btn-icon"></i>
              修改密碼
            </a>
            <button class="action-btn" onclick="clearCache()">
              <i class="fas fa-trash-alt action-btn-icon"></i>
              清除快取
            </button>
            <button class="action-btn" onclick="showSystemInfo()">
              <i class="fas fa-info-circle action-btn-icon"></i>
              系統資訊
            </button>
            <a href="create-admin-simple.html" class="action-btn" id="createAdminBtn" style="display: none;">
              <i class="fas fa-user-plus action-btn-icon"></i>
              創建管理員
            </a>
            <a href="admin-hero-videos-unified.html" class="action-btn">
              <i class="fas fa-video action-btn-icon"></i>
              HERO 影片管理
            </a>
            <a href="contentful-main-console.html" class="action-btn">
              <i class="fas fa-tv action-btn-icon"></i>
              Contentful 主控台
            </a>
            <a href="admin-topics-management.html" class="action-btn">
              <i class="fas fa-search action-btn-icon"></i>
              主題館管理
            </a>
            <a href="admin-login-logs.html" class="action-btn">
              <i class="fas fa-clipboard-list action-btn-icon"></i>
              登入日誌
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // Firebase 9 模組化導入
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    // Firebase 配置
    const firebaseConfig = {
      apiKey: "AIzaSyB5MLyG5H1sCflHFU7WeKQCmC0Ft5TIqjM",
      authDomain: "tv-tcawg-com.firebaseapp.com",
      projectId: "tv-tcawg-com",
      storageBucket: "tv-tcawg-com.firebasestorage.app",
      messagingSenderId: "313251141126",
      appId: "1:313251141126:web:88ef97ce28798c0a2e9587",
      measurementId: "G-83Z5VTRTZH"
    };

    // 初始化 Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 啟用 Firestore 離線支援
    enableIndexedDbPersistence(db).catch((err) => {
      if (err.code === 'failed-precondition') {
        console.log('多個標籤頁可能影響離線支援');
      } else if (err.code === 'unimplemented') {
        console.log('瀏覽器不支援離線支援');
      }
    });

    // 設定全域變數
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.firebaseApp = app;
    window.firebase9Loaded = true;

    console.log('Firebase 已初始化');
  </script>

  <!-- 管理員帳號服務 -->
  <script src="admin-accounts-firebase.js"></script>

  <script>
    // 登入驗證檢查
    function checkAuth() {
      // 優先檢查 Firebase 認證狀態
      if (window.firebaseAuth && window.firebaseAuth.currentUser) {
        const firebaseUser = window.firebaseAuth.currentUser;
        console.log('Firebase 用戶已登入:', firebaseUser.email);
        
        // 檢查是否為已知的超級管理員（優先檢查）
        if (firebaseUser.email === 'sammyzomb@gmail.com') {
          console.log('識別為超級管理員 (sammyzomb@gmail.com)');
          return {
            uid: firebaseUser.uid,
            email: firebaseUser.email,
            displayName: 'Sammy Zomb',
            name: 'Sammy Zomb',
            role: 'super_admin',
            permissions: ['read', 'write', 'delete', 'publish', 'admin', 'system'],
            provider: 'firebase'
          };
        }
        
        // 嘗試從管理員帳號服務獲取用戶資訊
        if (window.adminAccountsService) {
          try {
            // 根據電子郵件查找用戶帳號資訊
            const accountsData = window.adminAccountsService.getLocalBackup();
            if (accountsData && accountsData.accounts) {
              const account = accountsData.accounts.find(acc => acc.email === firebaseUser.email);
              if (account) {
                console.log('找到用戶帳號資訊:', account);
                return {
                  uid: firebaseUser.uid,
                  email: firebaseUser.email,
                  displayName: account.name || '管理員',
                  name: account.name || '管理員',
                  role: account.role || 'admin',
                  permissions: account.permissions || [],
                  provider: 'firebase'
                };
              }
            }
          } catch (error) {
            console.log('無法從管理員帳號服務獲取資訊:', error);
          }
        }
        
        // 預設返回管理員角色
        return {
          uid: firebaseUser.uid,
          email: firebaseUser.email,
          displayName: firebaseUser.displayName || '管理員',
          name: firebaseUser.displayName || firebaseUser.email || '管理員',
          role: 'admin',
          provider: 'firebase'
        };
      }
      
      // 檢查本地 sessionStorage
      const user = sessionStorage.getItem('adminUser');
      const loginTime = sessionStorage.getItem('loginTime');
      
      if (!user || !loginTime) {
        // 未登入，跳轉到登入頁面
        window.location.href = 'admin-login.html';
        return null;
      }
      
      // 檢查登入是否超過 8 小時
      const loginDate = new Date(loginTime);
      const now = new Date();
      const hoursDiff = (now - loginDate) / (1000 * 60 * 60);
      
      if (hoursDiff >= 8) {
        // 登入已過期，清除 session 並跳轉到登入頁面
        sessionStorage.removeItem('adminUser');
        sessionStorage.removeItem('loginTime');
        window.location.href = 'admin-login.html';
        return null;
      }
      
      return JSON.parse(user);
    }
    
    // 登出功能
    function logout() {
      // 清除本地存儲
      sessionStorage.removeItem('adminUser');
      sessionStorage.removeItem('loginTime');
      
      // 清除 Firebase 認證狀態
      if (window.firebaseAuth) {
        window.firebaseAuth.signOut().then(() => {
          console.log('Firebase 用戶已登出');
          window.location.href = 'admin-login.html';
        }).catch((error) => {
          console.error('Firebase 登出錯誤:', error);
          window.location.href = 'admin-login.html';
        });
      } else {
        // 如果 Firebase 未載入，直接跳轉
        window.location.href = 'admin-login.html';
      }
    }
    
    // 更新用戶資訊顯示
    function updateUserInfo() {
      const userInfo = document.getElementById('userInfo');
      const userDetails = document.getElementById('userDetails');
      const createAdminBtn = document.getElementById('createAdminBtn');
      
      if (currentUser) {
        userInfo.style.display = 'flex';
        
        // 安全地獲取用戶資訊，避免 undefined
        const userName = currentUser.name || currentUser.displayName || currentUser.email || '管理員';
        const userRole = currentUser.role || '管理員';
        const loginTime = sessionStorage.getItem('loginTime');
        const loginTimeStr = loginTime ? new Date(loginTime).toLocaleString() : '未知';
        
        userDetails.innerHTML = `
          <i class="fas fa-user user-icon"></i>
          <span class="status-indicator status-online"></span>
          歡迎，${userName} (${userRole}) | 
          登入時間：${loginTimeStr} | 
          <span style="color: #2b71d2; font-weight: 600;">版本：v1.2.0 (2025/08/28 18:30:00)</span>
        `;
        
        // 檢查用戶是否有管理其他管理員的權限
        console.log('檢查用戶權限:', {
          email: currentUser.email,
          role: userRole,
          permissions: currentUser.permissions
        });
        
        // 優先檢查是否為已知的超級管理員
        const isKnownSuperAdmin = currentUser.email === 'sammyzomb@gmail.com';
        const hasAdminPermission = isKnownSuperAdmin || 
                                 userRole === 'super_admin' || 
                                 (currentUser.permissions && currentUser.permissions.includes('admin'));
        
        if (hasAdminPermission) {
          console.log('用戶具有管理員管理權限，顯示創建管理員按鈕');
          createAdminBtn.style.display = 'inline-flex';
        } else {
          console.log('用戶不具有管理員管理權限，隱藏創建管理員按鈕');
          createAdminBtn.style.display = 'none';
        }
      }
    }
    
    // 導航到指定模組
    function navigateToModule(url) {
      // 添加過渡動畫效果
      document.body.style.opacity = '0.7';
      setTimeout(() => {
        window.location.href = url;
      }, 300);
    }
    
    // 清除快取
    function clearCache() {
      if (confirm('確定要清除瀏覽器快取嗎？這將清除所有暫存的資料。')) {
        sessionStorage.clear();
        localStorage.clear();
        alert('快取已清除！請重新登入。');
        window.location.href = 'admin-login.html';
      }
    }
    
    // 顯示系統資訊
    function showSystemInfo() {
      const info = `
系統資訊：
- 瀏覽器：${navigator.userAgent}
- 螢幕解析度：${screen.width}x${screen.height}
- 登入用戶：${currentUser.name}
- 用戶角色：${currentUser.role}
- 登入時間：${new Date(sessionStorage.getItem('loginTime')).toLocaleString()}
- 系統時間：${new Date().toLocaleString()}
- 當前版本：v1.2.0
- 版本發布：2025/08/28 18:30:00
- 最後更新：2025/08/28
      `;
      alert(info);
    }
    
    // 全域變數
    let currentUser = null;
    
    // 頁面載入時檢查登入狀態
    document.addEventListener('DOMContentLoaded', async function() {
      // 等待 Firebase 和管理員帳號服務載入
      const waitForServices = setInterval(async () => {
        if (window.firebaseAuth && window.adminAccountsService) {
          clearInterval(waitForServices);
          console.log('Firebase 和管理員帳號服務已載入');
          
          // 檢查用戶登入狀態
          currentUser = checkAuth();
          if (!currentUser) return;
          
          // 更新用戶資訊顯示
          updateUserInfo();
          
          // 添加頁面載入動畫
          document.body.style.opacity = '0';
          setTimeout(() => {
            document.body.style.transition = 'opacity 0.5s ease';
            document.body.style.opacity = '1';
          }, 100);
        }
      }, 100);
      
      // 如果 10 秒後服務仍未載入，顯示錯誤
      setTimeout(() => {
        if (!window.firebaseAuth || !window.adminAccountsService) {
          console.error('系統服務載入超時');
          alert('❌ 系統服務載入超時\n\n請重新整理頁面。');
        }
      }, 10000);
    });
  </script>
  
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Bootstrap 4 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- AdminLTE 3 -->
  <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
</body>
</html>

