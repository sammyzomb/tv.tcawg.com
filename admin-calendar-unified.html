<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çµ±ä¸€ç¯€ç›®ç®¡ç†ç³»çµ± - ç¸®åœ–åŠŸèƒ½å·²æ›´æ–°</title>
  <!-- ç‰ˆæœ¬æ¨™è¨˜ï¼š2024-12-19 æ›´æ–°ç¸®åœ–åŠŸèƒ½ -->
  <!-- æ™‚é–“æˆ³è¨˜ï¼š2024-12-19 21:45:00 -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }

    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

    .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .header h1 { color: #2b71d2; margin-bottom: 10px; }

    .view-controls { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px; }

    .view-buttons { display: flex; gap: 10px; }
    .view-btn { background: #f8f9fa; color: #495057; border: 2px solid #e9ecef; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
    .view-btn.active { background: #2b71d2; color: white; border-color: #2b71d2; }
    .view-btn:hover { background: #e3f2fd; border-color: #2b71d2; }
    .view-btn.active:hover { background: #1e5bb8; }

    .nav-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
    .nav-btn { background: #2b71d2; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    .nav-btn:hover { background: #1e5bb8; }
    .current-date { font-size: 1.2rem; font-weight: 600; color: #333; min-width: 200px; text-align: center; }
    .today-btn { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    .today-btn:hover { background: #218838; }

    .view { display: none; }
    .view.active { display: block; }

    .calendar-grid { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); background: #2b71d2; color: white; }
    .calendar-header div { padding: 15px; text-align: center; font-weight: 600; }
    .calendar-body { display: grid; grid-template-columns: repeat(7, 1fr); }
    .calendar-day { min-height: 120px; border: 1px solid #eee; padding: 8px; position: relative; background: white; cursor: pointer; }
    .calendar-day:hover { background: #f8f9fa; }
    .calendar-day.other-month { background: #f8f9fa; color: #999; }
    .calendar-day.today { background: #e3f2fd; border-color: #2b71d2; }

    .day-number { font-weight: 600; margin-bottom: 8px; color: #333; font-size: 0.9rem; }
    .day-events { position: relative; }

    /* Google æ—¥æ›†é¢¨æ ¼çš„ç¯€ç›®é¡¯ç¤º */
    .event {
      background: #e8f5e8;
      border: 1px solid #4caf50;
      border-radius: 3px;
      padding: 2px 6px;
      font-size: 0.65rem;
      margin-bottom: 1px;
      cursor: pointer;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      line-height: 1.2;
      max-width: 100%;
      position: relative;
    }
    .event:hover { background: #c8e6c9; }
    .event.prime-time { background: #ffe8e8; border-color: #ff6b6b; }
    .event.first-air { background: #fff3cd; border-color: #ffc107; }

    /* æ›´å¤šç¯€ç›®æŒ‡ç¤ºå™¨ */
    .more-events-indicator {
      background: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 3px;
      padding: 2px 6px;
      font-size: 0.6rem;
      color: #666;
      cursor: pointer;
      text-align: center;
      margin-top: 2px;
      font-style: italic;
    }
    .more-events-indicator:hover {
      background: #e0e0e0;
    }

    /* ç¯€ç›®å·¥å…·æç¤º */
    .event-tooltip {
      position: absolute;
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      max-width: 250px;
      word-wrap: break-word;
      white-space: normal;
      top: 100%;
      left: 0;
      margin-top: 5px;
    }

    .event:hover .event-tooltip {
      opacity: 1;
    }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; }
    .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; z-index: 10001; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: relative; z-index: 10002; }
    
    /* ç·¨è¼¯æ¨¡æ…‹æ¡†éœ€è¦æ›´é«˜çš„ z-index å’Œæ›´å¤§çš„é«˜åº¦ */
    #eventModal { z-index: 10010 !important; }
    #eventModal .modal-content { 
      z-index: 10011 !important; 
      max-height: 90vh !important;
      max-width: 95vw !important;
      width: 95vw !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      padding: 40px !important;
      position: fixed !important;
      margin: 0 !important;
    }
    #eventModal .modal-header { z-index: 10012 !important; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }

    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 15px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
    .form-group textarea { height: 120px; resize: vertical; }
    
    /* ç·¨è¼¯æ¨¡æ…‹æ¡†å°ˆç”¨æ¨£å¼ */
    #eventModal .form-group { margin-bottom: 25px; }
    #eventModal .form-group label { font-size: 16px; margin-bottom: 10px; }
    #eventModal .form-group input, #eventModal .form-group select, #eventModal .form-group textarea { 
      padding: 14px; 
      font-size: 15px; 
      border: 2px solid #e9ecef; 
      border-radius: 8px;
      transition: border-color 0.3s ease;
    }
    #eventModal .form-group input:focus, #eventModal .form-group select:focus, #eventModal .form-group textarea:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    #eventModal .form-group textarea { height: 150px; }
    
    /* éŸ¿æ‡‰å¼è¨­è¨ˆ - ç·¨è¼¯æ¨¡æ…‹æ¡† */
    @media (max-width: 1200px) {
      #eventModal .modal-content {
        max-width: 90vw !important;
        width: 90vw !important;
        padding: 30px !important;
      }
    }
    
    @media (max-width: 768px) {
      #eventModal .modal-content {
        max-width: 95vw !important;
        width: 95vw !important;
        padding: 20px !important;
        max-height: 95vh !important;
      }
      #eventModal .form-group { margin-bottom: 20px; }
      #eventModal .form-group textarea { height: 120px; }
      #topicsCheckboxes {
        grid-template-columns: 1fr !important;
      }
    }

    .btn { background: #2b71d2; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; margin-right: 10px; }
    .btn:hover { background: #1e5bb8; }
    .btn-secondary { background: #6c757d; }
    .btn-secondary:hover { background: #5a6268; }
    .btn-danger { background: #dc3545; }
    .btn-danger:hover { background: #c82333; }

    .status-bar { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1001; display: none; }

    /* é€±è¦–åœ–å’Œæ—¥è¦–åœ–æ¨£å¼ */
    .week-row, .day-row { transition: background-color 0.2s ease; }
    .week-row:hover, .day-row:hover { background-color: #f8f9fa; }
    .time-cell { user-select: none; }
    .day-cell, .event-cell { transition: background-color 0.2s ease; }
    .day-cell:hover, .event-cell:hover { background-color: #e3f2fd !important; }

    /* é€±è¦–åœ–ç‰¹æ®Šæ¨£å¼ */
    #weekView .calendar-header {
      grid-template-columns: 80px repeat(7, 1fr);
      background: #2b71d2;
      color: white;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    #weekView .calendar-body {
      display: block;
      background: white;
      max-height: 70vh;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #ccc transparent;
    }

    /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
    #weekView .calendar-body::-webkit-scrollbar {
      width: 8px;
    }

    #weekView .calendar-body::-webkit-scrollbar-track {
      background: transparent;
    }

    #weekView .calendar-body::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 4px;
    }

    #weekView .calendar-body::-webkit-scrollbar-thumb:hover {
      background: #999;
    }

    /* é€±è¦–åœ–è¡Œæ¨£å¼ */
    .week-row {
      display: grid !important;
      grid-template-columns: 80px repeat(7, 1fr) !important;
      border-bottom: 1px solid #eee;
      background: white;
      min-height: 30px;
    }

    /* é€±è¦–åœ–æ™‚é–“åˆ—æ¨£å¼ */
    #weekView .time-cell {
      min-width: 80px;
      max-width: 80px;
      width: 80px;
      box-sizing: border-box;
      font-size: 0.75rem;
      padding: 4px 6px;
    }

    /* é€±è¦–åœ–æ—¥æœŸå–®å…ƒæ ¼æ¨£å¼ */
    #weekView .day-cell {
      min-height: 30px;
      max-height: 60px;
      overflow: hidden;
      position: relative;
      padding: 2px;
    }

    /* é€±è¦–åœ–ç¯€ç›®æ¨£å¼ */
    #weekView .event {
      font-size: 0.7rem;
      padding: 2px 4px;
      margin: 1px 0;
      border-radius: 3px;
      cursor: pointer;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
      position: relative;
      transition: all 0.2s ease;
    }

    /* é€±è¦–åœ–ç¯€ç›®æ‡¸åœæ•ˆæœ */
    #weekView .event:hover {
      transform: scale(1.02);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 10;
    }

    /* é€±è¦–åœ–ç¯€ç›®å·¥å…·æç¤º */
    #weekView .event-tooltip {
      position: absolute;
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      white-space: nowrap;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      max-width: 300px;
      word-wrap: break-word;
      white-space: normal;
    }

    #weekView .event:hover .event-tooltip {
      opacity: 1;
    }

    /* æ—¥è¦–åœ–ç‰¹æ®Šæ¨£å¼ */
    #dayView .calendar-header {
      grid-template-columns: 80px 1fr;
      background: #2b71d2;
      color: white;
    }
    #dayView .calendar-body {
      display: block;
      background: white;
      max-height: 70vh;
      overflow-y: auto;
      padding: 0;
      min-height: 400px;
    }

    /* æ—¥è¦–åœ–è¡Œæ¨£å¼ */
    .day-row {
      display: grid !important;
      grid-template-columns: 80px 1fr !important;
      border-bottom: 1px solid #eee;
      background: white;
      min-height: 60px;
      width: 100%;
    }

    /* ç¢ºä¿æ—¥è¦–åœ–å®¹å™¨æœ‰è¶³å¤ é«˜åº¦ */
    #dayView .calendar-grid {
      height: auto;
      min-height: 70vh;
      width: 100%;
    }

    /* æ—¥è¦–åœ–æ™‚é–“åˆ—æ¨£å¼ */
    #dayView .time-cell {
      min-width: 80px;
      max-width: 80px;
      width: 80px;
      box-sizing: border-box;
    }

    /* æ—¥è¦–åœ–ç¯€ç›®åˆ—æ¨£å¼ */
    #dayView .event-cell {
      width: 100%;
      box-sizing: border-box;
      overflow: hidden;
    }

    /* éå»æ—¥æœŸæ¨£å¼ */
    .calendar-day.past-date {
      background-color: #f8f9fa !important;
      color: #999 !important;
    }

    .calendar-day.past-date .day-number {
      color: #999 !important;
    }

    .calendar-day.past-date .event {
      opacity: 0.6;
    }

    /* æœˆæ›†è¦–åœ–çš„ç¯€ç›®è¨ˆæ•¸æŒ‡ç¤ºå™¨ */
    .event-count-badge {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #2b71d2;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 600;
      z-index: 5;
    }

    /* ç¯€ç›®æ™‚é–“æ¨™ç±¤ */
    .event-time-label {
      font-weight: 600;
      color: #333;
      font-size: 0.6rem;
      margin-right: 3px;
    }

    /* æ”¹å–„æŒ‰éˆ•æ¨£å¼ */
    .btn {
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    /* æ”¹å–„æ—¥æ›†ç¶²æ ¼ */
    .calendar-grid {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    /* æ”¹å–„æ—¥æ›†æ¨™é¡Œ */
    .calendar-header {
      background: linear-gradient(135deg, #2b71d2, #1e5bb8) !important;
    }

    /* æ”¹å–„å®¹å™¨é–“è· */
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    /* æ”¹å–„æç¤ºæ¡†æ¨£å¼ */
    [title] {
      position: relative;
    }
    
    [title]:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.95);
      color: #ffffff;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      line-height: 1.4;
      z-index: 1000;
      pointer-events: none;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
      margin-bottom: 8px;
      max-width: 320px;
      min-width: 200px;
      word-wrap: break-word;
      white-space: normal;
      text-align: left;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    [title]:hover::before {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.95);
      z-index: 1000;
      pointer-events: none;
      margin-bottom: -6px;
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 1200px) {
      .nav-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      
      .date-navigation,
      .main-actions,
      .tool-actions {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“… çµ±ä¸€ç¯€ç›®ç®¡ç†ç³»çµ±</h1>
      <p>æ•´åˆæœˆæ›†ã€é€±æ›†ã€æ—¥æ›†ä¸‰ç¨®è¦–åœ–ï¼Œçµ±ä¸€ç®¡ç†æ‰€æœ‰ç¯€ç›®å®‰æ’</p>
      <div class="current-time-display" id="currentTimeDisplay" style="
        background: #2b71d2;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        display: inline-block;
        margin-top: 10px;
        box-shadow: 0 2px 8px rgba(43, 113, 210, 0.3);
      ">
        ğŸ• å°ç£æ™‚é–“ï¼š<span id="currentTimeText">è¼‰å…¥ä¸­...</span>
      </div>
    </div>

    <div class="view-controls">
      <div class="view-buttons">
        <button class="view-btn active" onclick="switchView('month')" title="æœˆæ›†è¦–åœ–ï¼šæŸ¥çœ‹æ•´æœˆçš„ç¯€ç›®å®‰æ’ï¼Œé©åˆé•·æœŸè¦åŠƒ">ğŸ“… æœˆæ›†è¦–åœ–</button>
        <button class="view-btn" onclick="switchView('week')" title="é€±æ›†è¦–åœ–ï¼šæŸ¥çœ‹ä¸€é€±çš„ç¯€ç›®å®‰æ’ï¼Œé©åˆé€±é–“è¦åŠƒ">ğŸ“Š é€±æ›†è¦–åœ–</button>
        <button class="view-btn" onclick="switchView('day')" title="æ—¥æ›†è¦–åœ–ï¼šæŸ¥çœ‹å–®æ—¥çš„è©³ç´°ç¯€ç›®å®‰æ’ï¼Œé©åˆç²¾ç¢ºç®¡ç†">ğŸ“‹ æ—¥æ›†è¦–åœ–</button>
      </div>

      <div class="nav-controls">
        <!-- æ—¥æœŸå°èˆª -->
        <div class="date-navigation" style="display: flex; align-items: center; gap: 10px; margin-right: 20px;">
          <button class="nav-btn" onclick="previousPeriod()" title="å›åˆ°ä¸Šä¸€å€‹æœˆ/é€±/æ—¥">â—€</button>
          <div class="current-date" id="currentDate" title="ç•¶å‰é¡¯ç¤ºçš„æ—¥æœŸç¯„åœ">2024å¹´8æœˆ</div>
          <button class="nav-btn" onclick="nextPeriod()" title="å‰å¾€ä¸‹ä¸€å€‹æœˆ/é€±/æ—¥">â–¶</button>
          <button class="today-btn" onclick="goToToday()" title="å¿«é€Ÿå›åˆ°ä»Šå¤©">ä»Šå¤©</button>
        </div>
        
        <!-- ä¸»è¦åŠŸèƒ½æŒ‰éˆ• -->
        <div class="main-actions" style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="btn" style="background: #28a745; padding: 8px 12px; font-size: 0.85rem;" onclick="reloadFromContentful()" title="å¾ Contentful é‡æ–°è¼‰å…¥æ‰€æœ‰ç¯€ç›®æ•¸æ“šï¼ŒåŒæ­¥æœ€æ–°å…§å®¹">ğŸ“¥ é‡æ–°è¼‰å…¥</button>
          <button class="btn" style="background: #dc3545; padding: 8px 12px; font-size: 0.85rem;" onclick="forceReloadFromContentful()" title="å¼·åˆ¶æ¸…ç©ºæœ¬åœ°æ•¸æ“šï¼Œå®Œå…¨å¾ Contentful é‡æ–°è¼‰å…¥">ğŸ”„ å¼·åˆ¶é‡æ–°è¼‰å…¥</button>
          <button class="btn" style="background: #17a2b8; padding: 8px 12px; font-size: 0.85rem;" onclick="syncAllToContentful()" title="å°‡æœ¬åœ°ç¯€ç›®æ•¸æ“šåŒæ­¥ä¸Šå‚³åˆ° Contentful">ğŸ”„ åŒæ­¥</button>
          <button class="btn" style="background: #dc3545; padding: 8px 12px; font-size: 0.85rem;" onclick="uploadSelectedPrograms()" title="ä¸Šæ¶é¸ä¸­çš„ç¯€ç›®åˆ° Contentful">ğŸ“º ä¸Šæ¶</button>
          <button class="btn" style="background: #ffc107; padding: 8px 12px; font-size: 0.85rem;" onclick="showBatchEditDialog()" title="æ‰¹æ¬¡ä¿®æ”¹å·²ä¸Šæ¶ç¯€ç›®çš„åˆ†é¡ã€ä¸»é¡Œç­‰è³‡è¨Š">âœï¸ æ‰¹æ¬¡ä¿®æ”¹</button>
          <button class="btn" style="background: #6f42c1; padding: 8px 12px; font-size: 0.85rem;" onclick="showAllVideos()" title="æŸ¥çœ‹æ‰€æœ‰å½±ç‰‡ï¼šé¡¯ç¤º Contentful ä¸­çš„æ‰€æœ‰å½±ç‰‡è³‡æ–™">ğŸ¬ æŸ¥çœ‹æ‰€æœ‰å½±ç‰‡</button>
        </div>
        
        <!-- å·¥å…·æŒ‰éˆ• -->
        <div class="tool-actions" style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="btn" style="background: #6c757d; padding: 8px 12px; font-size: 0.85rem;" onclick="checkContentfulContentTypes()" title="æª¢æŸ¥ Contentful å…§å®¹é¡å‹å’Œæ¬„ä½è¨­å®š">ğŸ” æª¢æŸ¥</button>
        <button class="btn" style="background: #dc3545; padding: 8px 12px; font-size: 0.85rem;" onclick="cleanupOldContentfulData()" title="æ¸…ç† Contentful ä¸­çš„èˆŠç¯€ç›®æ•¸æ“šï¼ˆ30å¤©å‰ï¼‰">ğŸ—‘ï¸ æ¸…ç†èˆŠæ•¸æ“š</button>
        <button class="btn" style="background: #17a2b8; padding: 8px 12px; font-size: 0.85rem;" onclick="showContentfulStats()" title="æŸ¥çœ‹ Contentful æ•¸æ“šçµ±è¨ˆå’Œå­˜å„²ä½¿ç”¨æƒ…æ³">ğŸ“Š æ•¸æ“šçµ±è¨ˆ</button>
          <button class="btn" style="background: #6f42c1; padding: 8px 12px; font-size: 0.85rem;" onclick="goToDashboard()" title="å‰å¾€ä¸»æ§å°æŸ¥çœ‹ç³»çµ±ç‹€æ…‹">ğŸ  ä¸»æ§å°</button>
          <button class="btn" style="background: #ff6b6b; padding: 8px 12px; font-size: 0.85rem;" onclick="clearAllDialogs()" title="ç·Šæ€¥æ¸…ç†ï¼šç§»é™¤æ‰€æœ‰å°è©±æ¡†å’Œé®ç½©å±¤">ğŸš¨ ç·Šæ€¥æ¸…ç†</button>
          <button class="btn" style="background: #28a745; padding: 8px 12px; font-size: 0.85rem;" onclick="recoverMissingPrograms()" title="æ¢å¾©æ¶ˆå¤±çš„ç¯€ç›®ï¼šå¾ Contentful é‡æ–°è¼‰å…¥æ•¸æ“š">ğŸ”„ æ¢å¾©ç¯€ç›®</button>
          <button class="btn" style="background: #17a2b8; padding: 8px 12px; font-size: 0.85rem;" onclick="diagnoseToday1730()" title="è¨ºæ–·ä»Šæ—¥ 17:30 çš„ç¯€ç›®">ğŸ” è¨ºæ–· 17:30</button>
          <button class="btn" style="background: #fd7e14; padding: 8px 12px; font-size: 0.85rem;" onclick="diagnoseToday1630()" title="è¨ºæ–·ä»Šæ—¥ 16:30 çš„ç¯€ç›®">ğŸ” è¨ºæ–· 16:30</button>
          <button class="btn" style="background: #28a745; padding: 8px 12px; font-size: 0.85rem;" onclick="createMissing1630Program()" title="å¦‚æœ 16:30 ç¯€ç›®ä¸å­˜åœ¨ï¼Œå‰µå»ºä¸€å€‹æ–°çš„">â• å‰µå»º 16:30</button>
        </div>
      </div>
    </div>

    <div class="view active" id="monthView">
      <div class="calendar-grid">
        <div class="calendar-header">
          <div>æ˜ŸæœŸæ—¥</div><div>æ˜ŸæœŸä¸€</div><div>æ˜ŸæœŸäºŒ</div><div>æ˜ŸæœŸä¸‰</div>
          <div>æ˜ŸæœŸå››</div><div>æ˜ŸæœŸäº”</div><div>æ˜ŸæœŸå…­</div>
        </div>
        <div class="calendar-body" id="monthCalendarBody"></div>
      </div>
    </div>

    <div class="view" id="weekView">
      <div class="calendar-grid">
        <div class="calendar-header" id="weekHeader">
          <div>æ™‚é–“</div><div>æ˜ŸæœŸæ—¥</div><div>æ˜ŸæœŸä¸€</div><div>æ˜ŸæœŸäºŒ</div>
          <div>æ˜ŸæœŸä¸‰</div><div>æ˜ŸæœŸå››</div><div>æ˜ŸæœŸäº”</div><div>æ˜ŸæœŸå…­</div>
        </div>
        <div class="calendar-body" id="weekCalendarBody"></div>
      </div>
    </div>

    <div class="view" id="dayView">
      <div class="calendar-grid">
        <div class="calendar-header" id="dayHeader">
          <div>æ™‚é–“</div><div>ç¯€ç›®å®‰æ’</div>
        </div>
        <div class="calendar-body" id="dayCalendarBody"></div>
      </div>
    </div>
  </div>

  <!-- æ™‚é–“æ§½é¸æ“‡å™¨æ¨¡æ…‹æ¡† -->
  <div class="modal" id="timeSlotModal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h3>é¸æ“‡æ’­å‡ºæ™‚é–“</h3>
        <button class="modal-close" onclick="closeTimeSlotModal()">&times;</button>
      </div>
      <div class="time-slot-grid" id="timeSlotGrid" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px; padding: 20px;">
        <!-- æ™‚é–“æ§½å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>
  </div>

  <div class="modal" id="eventModal">
    <div class="modal-content">
      <div class="modal-header">
        <div style="display: flex; align-items: center; gap: 15px; flex: 1; position: relative; z-index: 10003;">
          <h3 id="modalTitle" style="color: #333; font-weight: 600; margin: 0;">æ–°å¢ç¯€ç›®</h3>
          <!-- å¾æ­·å²è¤‡è£½åŠŸèƒ½æš«æ™‚éš±è— -->
          <!-- <button class="btn" style="background: #6f42c1; padding: 6px 12px; font-size: 0.8rem; position: relative; z-index: 10004;" onclick="showCopyFromHistoryDialog()" title="å¾æ­·å²ç¯€ç›®ä¸­é¸æ“‡æ™‚é–“æ§½é€²è¡Œæ‰¹é‡è¤‡è£½">ğŸ“š å¾æ­·å²è¤‡è£½</button> -->
        </div>
        <button class="modal-close" onclick="closeModal()" style="position: relative; z-index: 10005;">&times;</button>
      </div>

      <form id="eventForm">
        <input type="hidden" id="editDate">
        <input type="hidden" id="editTime">

        <div class="form-group">
          <label>æ’­å‡ºæ™‚é–“ï¼š</label>
          <input type="time" id="airTime" required onchange="checkPastDateTime(); updateTimeSlotInfo()">
          <div id="timeSlotInfo" style="margin-top: 5px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 0.9rem; color: #495057; display: none;">
            <span id="timeSlotName"></span>
            <span id="timeSlotDescription"></span>
          </div>
        </div>

        <div id="pastDateTimeWarning" style="display: none; background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 0.9rem;">
          âš ï¸ <strong>è­¦å‘Šï¼š</strong>æ‚¨é¸æ“‡çš„æ˜¯éå»çš„æ—¥æœŸæˆ–æ™‚é–“ï¼Œé€™å¯èƒ½æœƒå½±éŸ¿ç¯€ç›®æ’ç¨‹ã€‚è«‹ç¢ºèªæ˜¯å¦è¦ç¹¼çºŒç·¨è¼¯ã€‚
        </div>

        <div class="form-group">
          <label>å½±ç‰‡é¡å‹ï¼š</label>
          <select id="videoType" required onchange="toggleVideoFields()">
            <option value="">-- é¸æ“‡å½±ç‰‡é¡å‹ --</option>
            <option value="YouTube">YouTube</option>
            <option value="MP4">MP4 æª”æ¡ˆ</option>
          </select>
        </div>

        <div class="form-group" id="youtubeIdGroup" style="display: none;">
          <label>YouTube IDï¼š</label>
          <input type="text" id="youtubeId" placeholder="ä¾‹å¦‚ï¼šdQw4w9WgXcQ" onblur="fetchYouTubeInfo()" oninput="updateThumbnailPreview(this.value.trim())">
        </div>

        <div class="form-group" id="mp4FileGroup" style="display: none;">
          <label>MP4 æª”æ¡ˆï¼š</label>
          <input type="file" id="mp4File" accept=".mp4" onchange="handleFileUpload()">
        </div>

        <div class="form-group">
          <label>ç¯€ç›®æ¨™é¡Œï¼š</label>
          <input type="text" id="title" placeholder="ä¾‹å¦‚ï¼šæ—©å®‰ä¸–ç•Œ - æ—¥æœ¬æ±äº¬æ™¨é–“æ¼«æ­¥" required>
        </div>

        <div class="form-group">
          <label>ç¯€ç›®æ™‚é•·ï¼š</label>
          <select id="duration" required>
            <option value="30" selected>30åˆ†é˜</option>
            <option value="60">60åˆ†é˜</option>
            <option value="90">90åˆ†é˜</option>
          </select>
        </div>

        <div class="form-group">
          <label>ç¯€ç›®åˆ†é¡ï¼š</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <select id="category" required style="flex: 1;">
            <option value="">-- é¸æ“‡åˆ†é¡ --</option>
            <option value="äºæ´²">äºæ´²</option>
            <option value="æ­æ´²">æ­æ´²</option>
            <option value="åŒ—ç¾æ´²">åŒ—ç¾æ´²</option>
            <option value="å—ç¾æ´²">å—ç¾æ´²</option>
            <option value="éæ´²">éæ´²</option>
            <option value="å¤§æ´‹æ´²">å¤§æ´‹æ´²</option>
            <option value="å—æ¥µæ´²">å—æ¥µæ´²</option>
          </select>
            <button type="button" onclick="autoClassifyFromTitle()" 
                    style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;">
              ğŸ¤– è‡ªå‹•åˆ†é¡
            </button>
          </div>
          <small style="color: #666; margin-top: 5px; display: block;">
            é»æ“Šã€Œè‡ªå‹•åˆ†é¡ã€æŒ‰éˆ•å¯æ ¹æ“šæ¨™é¡Œå’Œæè¿°è‡ªå‹•åˆ¤æ–·æ‰€å±¬æ´²åˆ¥
          </small>
        </div>

        <div class="form-group">
          <label>ä¸»é¡Œæ¢ç´¢åˆ†é¡ï¼š</label>
          <div id="topicsCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-top: 12px;">
            <!-- ä¸»é¡Œå‹¾é¸æ¡†å°‡ç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
          </div>
          <small style="color: #666; margin-top: 5px; display: block;">å¯é¸æ“‡å¤šå€‹ä¸»é¡Œï¼Œç¯€ç›®å°‡å‡ºç¾åœ¨å°æ‡‰çš„ä¸»é¡Œæ¢ç´¢é é¢ä¸­</small>
        </div>

        <div class="form-group">
          <label>ç¯€ç›®æè¿°ï¼š</label>
          <div style="display: flex; gap: 10px; align-items: flex-start;">
            <textarea id="description" placeholder="ç°¡çŸ­æè¿°ç¯€ç›®å…§å®¹..." style="flex: 1; min-height: 80px;"></textarea>
            <div style="display: flex; flex-direction: column; gap: 5px;">
               <button type="button" onclick="openYouTubePage()" 
                       style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;">
                 ğŸ”— é–‹å•Ÿ YouTube é é¢
               </button>
               <button type="button" onclick="autoExtractDescription()" 
                       style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;">
                 ğŸ¤– è‡ªå‹•æ“·å–æè¿°
               </button>
               <button type="button" onclick="pasteFromClipboard()" 
                       style="background: #6f42c1; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;">
                 ğŸ“‹ è²¼ä¸Šå‰ªè²¼ç°¿å…§å®¹
               </button>
            </div>
          </div>
          <small style="color: #666; margin-top: 5px; display: block;">
            <span style="color: #28a745; font-weight: bold;">ğŸ¤– è‡ªå‹•æ“·å–ï¼š</span>è¼¸å…¥ YouTube ID å¾Œé»æ“Šã€ŒğŸ¤– è‡ªå‹•æ“·å–æè¿°ã€å³å¯è‡ªå‹•ç²å–æè¿°æ–‡å­—<br>
            <span style="color: #007bff; font-weight: bold;">âœ¨ æ™ºèƒ½è™•ç†ï¼š</span>ç³»çµ±æœƒè‡ªå‹•æå–è§€çœ‹æ¬¡æ•¸ã€æ—¥æœŸå’Œæ¨™ç±¤ä¿¡æ¯ä¸¦æ·»åŠ åˆ°æè¿°é–‹é ­
          </small>
        </div>


        <div class="form-group" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px solid #007bff;">
          <label style="color: #007bff; font-weight: bold;">ğŸ¬ ç¯€ç›®ç¸®åœ–ï¼š</label>
          <div style="display: flex; gap: 15px; align-items: center; margin-top: 10px;">
            <img id="thumbnailPreview" src="https://images.unsplash.com/photo-1485846234645-a62644f84728?w=200&h=112&fit=crop" 
                 style="width: 200px; height: 112px; object-fit: cover; border: 2px solid #007bff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; flex-direction: column; gap: 10px;">
              <input type="file" id="thumbnailFile" accept="image/*" onchange="previewThumbnail()" 
                     style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: white;">
              <button type="button" onclick="resetThumbnail()" 
                      style="background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;">
                ğŸ”„ é‡ç½®ç‚º YouTube ç¸®åœ–
              </button>
            </div>
          </div>
          <div style="margin-top: 10px; font-size: 12px; color: #666;">
            ğŸ’¡ æç¤ºï¼šè¼¸å…¥ YouTube ID å¾Œæœƒè‡ªå‹•é¡¯ç¤ºç¸®åœ–ï¼Œä¹Ÿå¯ä»¥ä¸Šå‚³è‡ªè¨‚ç¸®åœ–
          </div>
        </div>

        <div class="form-group">
          <label>ç¯€ç›®ç‹€æ…‹ï¼š</label>
          <select id="status" required>
            <option value="é‡æ’­">é‡æ’­</option>
            <option value="é¦–æ’­">é¦–æ’­</option>
            <option value="ç‰¹åˆ¥ç¯€ç›®">ç‰¹åˆ¥ç¯€ç›®</option>
          </select>
        </div>

        <!-- ç¯€ç›®æ’­å‡ºæ­·å² -->
        <div id="broadcastHistory" style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
          <h4 style="margin: 0 0 10px 0; color: #333;">ğŸ“º æ’­å‡ºæ­·å²</h4>
          <div id="broadcastHistoryList" style="color: #666; font-size: 0.9rem;">
            <!-- æ’­å‡ºæ­·å²å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
          </div>
        </div>

        <!-- ç²¾é¸ç‹€æ…‹é¡¯ç¤º -->
        <div id="featuredStatus" style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; display: none;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="color: #856404; font-weight: bold;">â­ æ­¤ç¯€ç›®å·²è¨­ç‚ºç²¾é¸ç¯€ç›®æ¨è–¦</span>
            <button type="button" class="btn" style="background: #dc3545; color: white; padding: 4px 8px; font-size: 0.8rem;" onclick="toggleFeaturedFromEdit(false)">å–æ¶ˆç²¾é¸</button>
          </div>
        </div>

        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
          <button type="submit" class="btn">ğŸ’¾ å„²å­˜ç¯€ç›®</button>
          <button type="button" class="btn" style="background: #17a2b8;" onclick="copyAndPublish()">ğŸ“‹ è¤‡è£½ä¸Šæ¶</button>
          <button type="button" class="btn" style="background: #ffc107; color: #000;" onclick="checkSystemStatus()">ğŸ” æª¢æŸ¥ç³»çµ±ç‹€æ…‹</button>
          <button type="button" class="btn" style="background: #6f42c1; color: white;" onclick="toggleFeaturedFromEdit(true)" id="setFeaturedBtn">â­ è¨­ç‚ºç²¾é¸</button>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button type="button" class="btn btn-danger" onclick="deleteEvent()">ğŸ—‘ï¸ åˆªé™¤ç¯€ç›®</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal()">âŒ å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>

  <div class="status-bar" id="statusBar">
    <span id="statusMessage"></span>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/contentful@latest/dist/contentful.browser.min.js"></script>
  <script src="browser-config.js"></script>
  <script>
    // å¼·åŠ›è¼‰å…¥ Management SDK
    function loadManagementSDK() {
      return new Promise((resolve, reject) => {
        // æª¢æŸ¥æ˜¯å¦å·²ç¶“è¼‰å…¥
        if (typeof contentfulManagement !== 'undefined') {
          console.log('âœ… Management SDK å·²è¼‰å…¥');
          window.contentfulManagement = contentfulManagement;
          resolve();
          return;
        }

        // å˜—è©¦å¤šå€‹ CDN æºï¼ˆä½¿ç”¨å›ºå®šç‰ˆæœ¬è™Ÿä»¥æé«˜ç©©å®šæ€§ï¼‰
        const cdnSources = [
          'https://cdn.jsdelivr.net/npm/contentful-management@10.0.0/dist/contentful-management.browser.min.js',
          'https://unpkg.com/contentful-management@10.0.0/dist/contentful-management.browser.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/contentful-management/10.0.0/contentful-management.browser.min.js',
          'https://cdn.jsdelivr.net/npm/contentful-management@9.0.0/dist/contentful-management.browser.min.js',
          'https://unpkg.com/contentful-management@9.0.0/dist/contentful-management.browser.min.js'
        ];

        let currentIndex = 0;

        function tryNextCDN() {
          if (currentIndex >= cdnSources.length) {
            reject(new Error('æ‰€æœ‰ CDN æºéƒ½è¼‰å…¥å¤±æ•—'));
            return;
          }

          const script = document.createElement('script');
          script.src = cdnSources[currentIndex];
          
          script.onload = function() {
            // ç­‰å¾…ä¸€ä¸‹è®“è…³æœ¬åŸ·è¡Œ
            setTimeout(() => {
              if (typeof contentfulManagement !== 'undefined') {
                console.log(`âœ… Management SDK å¾ CDN ${currentIndex + 1} è¼‰å…¥æˆåŠŸ`);
                window.contentfulManagement = contentfulManagement;
                resolve();
              } else {
                console.log(`âŒ CDN ${currentIndex + 1} è¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦ä¸‹ä¸€å€‹...`);
                currentIndex++;
                tryNextCDN();
              }
            }, 100);
          };

          script.onerror = function() {
            console.log(`âŒ CDN ${currentIndex + 1} è¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦ä¸‹ä¸€å€‹...`);
            currentIndex++;
            tryNextCDN();
          };

          document.head.appendChild(script);
        }

        tryNextCDN();
      });
    }

    // ç¢ºä¿ Contentful SDK è¼‰å…¥å®Œæˆ
    if (typeof contentful !== 'undefined') {
      console.log('âœ… Contentful SDK å·²è¼‰å…¥');
    } else {
      console.error('âŒ Contentful SDK è¼‰å…¥å¤±æ•—');
    }
    
    // è¼‰å…¥ Management SDK
    loadManagementSDK()
      .then(() => {
        console.log('âœ… Management SDK è¼‰å…¥å®Œæˆ');
      })
      .catch((error) => {
        console.error('âŒ Management SDK è¼‰å…¥å¤±æ•—:', error);
        console.log('âŒ æ‰€æœ‰ CDN æºéƒ½è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
      });
  </script>
  <script src="contentful-real-only.js"></script>
  <script>
    // ç›£è½ Management SDK è¼‰å…¥äº‹ä»¶
    window.addEventListener('contentfulManagementLoaded', function() {
      console.log('âœ… Management SDK è¼‰å…¥å®Œæˆäº‹ä»¶è§¸ç™¼');
    });
    
    window.addEventListener('contentfulManagementFailed', function() {
      console.error('âŒ Management SDK è¼‰å…¥å¤±æ•—äº‹ä»¶è§¸ç™¼');
    });
    
    // ç¢ºä¿ ContentfulRealOnly ç³»çµ±è¼‰å…¥å®Œæˆ
    setTimeout(() => {
      if (window.contentfulRealOnly) {
        console.log('âœ… ContentfulRealOnly ç³»çµ±å·²è¼‰å…¥');
      } else {
        console.error('âŒ ContentfulRealOnly ç³»çµ±è¼‰å…¥å¤±æ•—');
      }
    }, 1000);
  </script>
  <script>
    let currentDate = new Date();
    let currentView = 'month';
    let events = {};

    // å¯¦æ™‚æ™‚é–“æ›´æ–°åŠŸèƒ½
    function updateCurrentTime() {
      const now = new Date();
      // ç›´æ¥ä½¿ç”¨ç•¶å‰æ™‚é–“ï¼Œå‡è¨­ç³»çµ±æ™‚é–“å·²ç¶“æ˜¯å°ç£æ™‚é–“
      
      const year = now.getFullYear();
      const month = now.getMonth() + 1;
      const date = now.getDate();
      const dayNames = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
      const dayName = dayNames[now.getDay()];
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const seconds = now.getSeconds().toString().padStart(2, '0');
      
      const timeString = `${year}å¹´${month}æœˆ${date}æ—¥ ${dayName} ${hours}:${minutes}:${seconds}`;
      
      const currentTimeElement = document.getElementById('currentTimeText');
      if (currentTimeElement) {
        currentTimeElement.textContent = timeString;
      }
    }

    // å•Ÿå‹•å¯¦æ™‚æ™‚é–“æ›´æ–°
    function startTimeUpdates() {
      updateCurrentTime(); // ç«‹å³æ›´æ–°ä¸€æ¬¡
      setInterval(updateCurrentTime, 1000); // æ¯ç§’æ›´æ–°
    }

    // ä¸»é¡Œæ¢ç´¢åˆ†é¡è³‡æ–™
    const TOPICS_DATA = [
      {
        id: 'city-secrets',
        title: 'åŸå¸‚ç§˜å¢ƒ',
        description: 'æ·±å…¥åŸå¸‚è§’è½ã€å¸‚é›†ã€æ–‡åŒ–æ™¯é»ï¼Œç”¨å¯¦åœ°é«”é©—å‘ˆç¾åŸå¸‚æ•…äº‹'
      },
      {
        id: 'taste-journal',
        title: 'å‘³è¦ºæ—¥èªŒ',
        description: 'å“å˜—ç•¶åœ°æ–™ç†èˆ‡è¡—é ­å°åƒï¼Œè¨ªå•é¤å»³è€é—†æˆ–å»šå¸«ï¼Œåˆ†äº«é£Ÿç‰©èƒŒå¾Œçš„æ•…äº‹'
      },
      {
        id: 'travel-talk',
        title: 'æ—…é€”è«‡',
        description: 'é‚€è«‹æ—…éŠé”äººã€éƒ¨è½å®¢ã€åœ¨åœ°äººï¼Œåˆ†äº«æ—…è¡Œå¿ƒå¾—ã€æŠ€å·§èˆ‡è¶£è'
      },
      {
        id: 'around-world',
        title: 'ç¹è‘—åœ°çƒè·‘',
        description: 'èµ°è¨ªå°é®æˆ–é„‰æ‘ï¼Œä»‹ç´¹ç•¶åœ°æ–‡åŒ–ã€æ‰‹ä½œå·¥è—ã€å¸‚å ´èˆ‡ç‰¹è‰²ç¾é£Ÿ'
      },
      {
        id: 'food-talk',
        title: 'é£Ÿè©±å¯¦èªª',
        description: 'è¨è«–ç‰¹å®šé£Ÿæã€æ–™ç†æˆ–ç¾é£Ÿæ–‡åŒ–ï¼Œçµåˆè¨è«–èˆ‡å¯¦åœ°ç¤ºç¯„'
      },
      {
        id: 'play-fun',
        title: 'ç©æ¨‚FUN',
        description: 'å°ˆç‚ºå®¶åº­è¨­è¨ˆï¼Œæ¢ç´¢é©åˆè¦ªå­æ´»å‹•çš„æ™¯é»ã€éŠæ¨‚åœ’ã€å‹•ç‰©åœ’'
      },
      {
        id: 'time-walk',
        title: 'æ™‚å…‰æ¼«éŠ',
        description: 'èµ°è¨ªå¤è¹Ÿã€åšç‰©é¤¨ã€å‚³çµ±æ‘è½ï¼Œé€éæ­·å²æ•…äº‹å‘ˆç¾æ·±åº¦æ–‡åŒ–æ—…ç¨‹'
      },
      {
        id: 'nature-secrets',
        title: 'è‡ªç„¶ç§˜å¢ƒ',
        description: 'æ¢ç´¢è‡ªç„¶æ™¯è§€ã€é‡ç”Ÿå‹•æ¤ç‰©ã€ç”Ÿæ…‹ä¿è‚²ï¼Œæ„Ÿå—åœ°çƒä¹‹ç¾'
      }
    ];

    // è¼‰å…¥ä¸»é¡Œæ¢ç´¢åˆ†é¡
    function loadTopics() {
      const container = document.getElementById('topicsCheckboxes');
      if (!container) return;

      container.innerHTML = TOPICS_DATA.map(topic => `
        <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.2s ease;">
          <input type="checkbox" name="topics" value="${topic.id}" style="margin: 0;">
          <div>
            <div style="font-weight: 600; font-size: 14px;">${topic.title}</div>
            <div style="font-size: 12px; color: #666; margin-top: 2px;">${topic.description}</div>
          </div>
        </label>
      `).join('');
    }

    document.addEventListener('DOMContentLoaded', function() {
      loadEvents();
      renderCurrentView();
      updateCurrentDateDisplay();
      loadTopics();
      startTimeUpdates(); // å•Ÿå‹•å¯¦æ™‚æ™‚é–“æ›´æ–°
      
      // æ¯ 30 ç§’è‡ªå‹•å¾ Contentful åˆ·æ–°æ•¸æ“šï¼Œç¢ºä¿å¤šäººå”ä½œæ™‚æ•¸æ“šåŒæ­¥
      setInterval(() => {
        console.log('ğŸ”„ è‡ªå‹•åˆ·æ–° Contentful æ•¸æ“š...');
        loadEvents();
      }, 30000);
      
      // æª¢æŸ¥æ¸…ç†æé†’ï¼ˆå»¶é²3ç§’åŸ·è¡Œï¼Œé¿å…å½±éŸ¿ä¸»è¦åŠŸèƒ½ï¼‰
      setTimeout(() => {
        checkCleanupReminder();
      }, 3000);
      
      // æª¢æŸ¥é‡è¤‡æ™‚é–“æ§½ï¼ˆå»¶é²5ç§’åŸ·è¡Œï¼‰
      setTimeout(() => {
        checkDuplicateTimeSlots();
      }, 5000);
      
      // æ·»åŠ å…¨å±€ Escape éµè™•ç†å™¨ç”¨æ–¼ç·Šæ€¥æ¸…ç†
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
          // æª¢æŸ¥æ˜¯å¦æœ‰å°è©±æ¡†å­˜åœ¨
          const hasDialogs = document.querySelectorAll('div[style*="position: fixed"][style*="z-index: 10000"], div[style*="background: rgba(0,0,0"]').length > 0;
          if (hasDialogs) {
            console.log('ğŸš¨ Escape éµè§¸ç™¼ç·Šæ€¥æ¸…ç†');
            clearAllDialogs();
            event.preventDefault();
          }
        }
      });
    });

    function switchView(view) {
      currentView = view;

      document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(view + 'View').classList.add('active');

      renderCurrentView();
    }

    function renderCurrentView() {
      switch(currentView) {
        case 'month': renderMonthView(); break;
        case 'week': renderWeekView(); break;
        case 'day': renderDayView(); break;
      }
    }

    function renderMonthView() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - firstDay.getDay());

      const today = new Date();
      const todayStart = new Date(today);
      todayStart.setHours(0, 0, 0, 0);

      const calendarBody = document.getElementById('monthCalendarBody');
      calendarBody.innerHTML = '';

      for (let week = 0; week < 6; week++) {
        for (let day = 0; day < 7; day++) {
          const currentDay = new Date(startDate);
          currentDay.setDate(startDate.getDate() + week * 7 + day);

          const isCurrentMonth = currentDay.getMonth() === month;
          const isToday = currentDay.toDateString() === today.toDateString();
          const isPastDate = currentDay < todayStart;
          const dateString = currentDay.getFullYear() + '-' +
                           String(currentDay.getMonth() + 1).padStart(2, '0') + '-' +
                           String(currentDay.getDate()).padStart(2, '0');

          const dayElement = document.createElement('div');
          dayElement.className = `calendar-day ${!isCurrentMonth ? 'other-month' : ''} ${isToday ? 'today' : ''} ${isPastDate ? 'past-date' : ''}`;
          dayElement.setAttribute('data-date', dateString);

          const dayEvents = getDayEvents(dateString);
          const eventCount = dayEvents.length;

          dayElement.innerHTML = `
            <div class="day-number">${currentDay.getDate()}</div>
            ${eventCount > 0 ? `<div class="event-count-badge">${eventCount}</div>` : ''}
            <div class="day-events" id="events-${dateString}">
              ${getDayEventsHTML(dateString)}
            </div>
          `;

          // ç§»é™¤éå»æ—¥æœŸçš„é™åˆ¶ï¼Œæ‰€æœ‰æ—¥æœŸéƒ½å¯ä»¥é»æ“Šç·¨è¼¯
            dayElement.style.cursor = 'pointer';
            dayElement.addEventListener('click', function() {
              openTimeSlotSelector(dateString);
            });

          calendarBody.appendChild(dayElement);
        }
      }
    }

    function renderWeekView() {
      const today = new Date();
      const currentHour = today.getHours();
      const currentMinute = today.getMinutes();
      const currentTimeSlot = `${currentHour.toString().padStart(2, '0')}:${Math.floor(currentMinute / 30) * 30 === 0 ? '00' : '30'}`;

      const weekStart = new Date(currentDate);
      weekStart.setDate(currentDate.getDate() - currentDate.getDay());

      const weekHeader = document.getElementById('weekHeader');
      const dayNames = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
      weekHeader.innerHTML = '';

      const timeHeader = document.createElement('div');
      timeHeader.textContent = 'æ™‚é–“';
      timeHeader.style.display = 'flex';
      timeHeader.style.alignItems = 'center';
      timeHeader.style.justifyContent = 'center';
      weekHeader.appendChild(timeHeader);

      for (let i = 0; i < 7; i++) {
        const currentDay = new Date(weekStart);
        currentDay.setDate(weekStart.getDate() + i);
        const isToday = currentDay.toDateString() === today.toDateString();

        const headerCell = document.createElement('div');
        headerCell.innerHTML = `
          <div style="font-weight: 600; margin-bottom: 2px;">${dayNames[i]}</div>
          <div style="font-size: 0.9rem; opacity: 0.9; ${isToday ? 'color: #ffc107; font-weight: 600;' : ''}">
            ${currentDay.getMonth() + 1}/${currentDay.getDate()}
          </div>
        `;
        weekHeader.appendChild(headerCell);
      }

      const calendarBody = document.getElementById('weekCalendarBody');
      calendarBody.innerHTML = '';

      const timeSlots = [];
      for (let hour = 0; hour < 24; hour++) {
        for (let minute = 0; minute < 60; minute += 30) {
          const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
          timeSlots.push(timeString);
        }
      }

      timeSlots.forEach(timeSlot => {
        const row = document.createElement('div');
        row.className = 'week-row';

        const timeCell = document.createElement('div');
        timeCell.className = 'time-cell';
        timeCell.style.cssText = `
          padding: 4px 6px;
          border-right: 1px solid #eee;
          background-color: #f8f9fa;
          font-size: 0.75rem;
          font-weight: 600;
          display: flex;
          align-items: center;
          justify-content: center;
          min-width: 80px;
          max-width: 80px;
          box-sizing: border-box;
        `;
        timeCell.textContent = timeSlot;

        const hour = parseInt(timeSlot.split(':')[0]);
        const minute = parseInt(timeSlot.split(':')[1]);
        // ç§»é™¤éå»æ™‚é–“çš„æ¨£å¼é™åˆ¶ï¼Œæ‰€æœ‰æ™‚é–“éƒ½å¯ä»¥ç·¨è¼¯

        if (timeSlot === currentTimeSlot && today.toDateString() === currentDate.toDateString()) {
          timeCell.style.color = '#2b71d2';
          timeCell.style.fontWeight = '700';
          timeCell.style.borderLeft = '3px solid #2b71d2';
        }

        row.appendChild(timeCell);

        for (let day = 0; day < 7; day++) {
          const currentDay = new Date(weekStart);
          currentDay.setDate(weekStart.getDate() + day);
          const dateString = currentDay.getFullYear() + '-' +
                           String(currentDay.getMonth() + 1).padStart(2, '0') + '-' +
                           String(currentDay.getDate()).padStart(2, '0');
          const isToday = currentDay.toDateString() === today.toDateString();

          const dayCell = document.createElement('div');
          dayCell.className = 'day-cell';
          dayCell.style.cssText = `
            padding: 2px;
            border-right: 1px solid #eee;
            min-height: 30px;
            max-height: 60px;
            overflow: hidden;
            position: relative;
            background: white;
          `;

          if (timeSlot === '00:00') {
            const dateLabel = document.createElement('div');
            dateLabel.style.cssText = `
              position: absolute;
              top: 2px;
              left: 2px;
              font-size: 0.7rem;
              font-weight: 600;
              color: ${isToday ? '#ffc107' : '#666'};
              background: ${isToday ? 'rgba(255, 193, 7, 0.1)' : 'rgba(0, 0, 0, 0.05)'};
              padding: 1px 4px;
              border-radius: 3px;
              z-index: 1;
            `;
            dateLabel.textContent = `${currentDay.getMonth() + 1}/${currentDay.getDate()}`;
            dayCell.appendChild(dateLabel);
          }

          // ç§»é™¤éå»æ—¥æœŸå’Œæ™‚é–“çš„é™åˆ¶ï¼Œæ‰€æœ‰æ—¥æœŸå’Œæ™‚é–“éƒ½å¯ä»¥é»æ“Šç·¨è¼¯
            dayCell.style.cursor = 'pointer';
            dayCell.addEventListener('click', function() {
              openEventModal(dateString, timeSlot);
            });

          const events = getDayEvents(dateString);
          const timeSlotEvents = events.filter(event => event.time === timeSlot);

          timeSlotEvents.forEach(event => {
            const eventDiv = document.createElement('div');
            eventDiv.className = `event ${event.status === 'é¦–æ’­' ? 'first-air' : ''} ${isPrimeTime(hour) ? 'prime-time' : ''}`;
            eventDiv.style.cssText = `
              font-size: 0.7rem;
              padding: 2px 4px;
              margin: 1px 0;
              border-radius: 3px;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
              max-width: 100%;
              position: relative;
              transition: all 0.2s ease;
              cursor: pointer;
            `;

            const maxLength = 25;
            const displayTitle = event.title.length > maxLength ?
              event.title.substring(0, maxLength) + '...' : event.title;
            eventDiv.textContent = displayTitle;

            if (event.title.length > maxLength || event.description) {
              const tooltip = document.createElement('div');
              tooltip.className = 'event-tooltip';
              tooltip.style.cssText = `
                position: absolute;
                background: rgba(0,0,0,0.9);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 0.8rem;
                z-index: 1000;
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.3s ease;
                max-width: 300px;
                word-wrap: break-word;
                white-space: normal;
                top: 100%;
                left: 0;
                margin-top: 5px;
              `;

              let tooltipContent = `<strong>${event.title}</strong>`;
              if (event.description) {
                tooltipContent += `<br><small>${event.description}</small>`;
              }
              tooltipContent += `<br><small>${event.time} | ${event.category} | ${event.duration}åˆ†é˜</small>`;
              tooltip.innerHTML = tooltipContent;

              eventDiv.appendChild(tooltip);

              eventDiv.addEventListener('mouseenter', function() {
                tooltip.style.opacity = '1';
              });

              eventDiv.addEventListener('mouseleave', function() {
                tooltip.style.opacity = '0';
              });
            }

            eventDiv.addEventListener('click', function(e) {
              e.stopPropagation();
              openEventModal(dateString, timeSlot);
            });

            dayCell.appendChild(eventDiv);
          });

          if (timeSlotEvents.length === 0) {
            const emptyDiv = document.createElement('div');
            emptyDiv.style.cssText = `
              color: #ccc;
              font-size: 0.6rem;
              font-style: italic;
              text-align: center;
              padding: 2px;
              opacity: 0.7;
            `;
            emptyDiv.textContent = '+';
            dayCell.appendChild(emptyDiv);
          }

          row.appendChild(dayCell);
        }

        calendarBody.appendChild(row);
      });
    }

    function renderDayView() {
      const today = new Date();
      const currentHour = today.getHours();
      const currentMinute = today.getMinutes();
      const currentTimeSlot = `${currentHour.toString().padStart(2, '0')}:${Math.floor(currentMinute / 30) * 30 === 0 ? '00' : '30'}`;
      const dateString = currentDate.getFullYear() + '-' +
                       String(currentDate.getMonth() + 1).padStart(2, '0') + '-' +
                       String(currentDate.getDate()).padStart(2, '0');
      const isToday = currentDate.toDateString() === today.toDateString();

      const dayHeader = document.getElementById('dayHeader');
      const dayNames = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
      const dayOfWeek = currentDate.getDay();

      dayHeader.innerHTML = `
        <div>æ™‚é–“</div>
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
          <div style="font-weight: 600; margin-bottom: 2px;">ç¯€ç›®å®‰æ’</div>
          <div style="font-size: 0.9rem; opacity: 0.9; ${isToday ? 'color: #ffc107; font-weight: 600;' : ''}">
            ${currentDate.getFullYear()}å¹´${currentDate.getMonth() + 1}æœˆ${currentDate.getDate()}æ—¥ ${dayNames[dayOfWeek]}
          </div>
        </div>
      `;

      const calendarBody = document.getElementById('dayCalendarBody');
      calendarBody.innerHTML = '';

      const timeSlots = [];
      for (let hour = 0; hour < 24; hour++) {
        for (let minute = 0; minute < 60; minute += 30) {
          const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
          timeSlots.push(timeString);
        }
      }

      timeSlots.forEach(timeSlot => {
        const row = document.createElement('div');
        row.className = 'day-row';

        const timeCell = document.createElement('div');
        timeCell.className = 'time-cell';
        timeCell.style.cssText = `
          padding: 12px 8px;
          border-right: 1px solid #eee;
          background-color: #f8f9fa;
          font-size: 0.9rem;
          font-weight: 600;
          display: flex;
          align-items: center;
          justify-content: center;
          min-width: 80px;
        `;
        timeCell.textContent = timeSlot;

        const hour = parseInt(timeSlot.split(':')[0]);
        const minute = parseInt(timeSlot.split(':')[1]);
        
        // æ¨™ç¤ºç•¶å‰æ™‚é–“
        if (timeSlot === currentTimeSlot && isToday) {
          timeCell.style.color = '#2b71d2';
          timeCell.style.fontWeight = '700';
          timeCell.style.borderLeft = '3px solid #2b71d2';
          timeCell.style.backgroundColor = '#e3f2fd';
        }

        row.appendChild(timeCell);

        const eventCell = document.createElement('div');
        eventCell.className = 'event-cell';
        eventCell.style.cssText = `
          padding: 8px;
          position: relative;
          min-height: 60px;
          display: flex;
          align-items: center;
        `;

        // æ¨™ç¤ºç•¶å‰æ™‚é–“çš„äº‹ä»¶å–®å…ƒæ ¼
        if (timeSlot === currentTimeSlot && isToday) {
          eventCell.style.backgroundColor = '#e3f2fd';
          eventCell.style.borderLeft = '3px solid #2b71d2';
        }

        // ç§»é™¤éå»æ™‚é–“çš„æ¨£å¼é™åˆ¶ï¼Œæ‰€æœ‰æ™‚é–“éƒ½å¯ä»¥é»æ“Šç·¨è¼¯
          eventCell.style.cursor = 'pointer';
          eventCell.addEventListener('click', function() {
            openEventModal(dateString, timeSlot);
          });

        const events = getDayEvents(dateString);
        const timeSlotEvents = events.filter(event => event.time === timeSlot);

        if (timeSlotEvents.length > 0) {
          timeSlotEvents.forEach(event => {
            const eventDiv = document.createElement('div');
            eventDiv.className = `event ${event.status === 'é¦–æ’­' ? 'first-air' : ''} ${isPrimeTime(hour) ? 'prime-time' : ''}`;
            eventDiv.style.cssText = `
              padding: 8px;
              margin: 4px 0;
              border-radius: 6px;
              font-size: 0.9rem;
              font-weight: 500;
              background: #e8f5e8;
              border: 1px solid #4caf50;
              width: 100%;
              box-sizing: border-box;
              word-wrap: break-word;
              overflow-wrap: break-word;
            `;

            eventDiv.innerHTML = `
              <div style="font-weight: 600; margin-bottom: 4px; word-break: break-word;">${event.title}</div>
              <div style="font-size: 0.8rem; color: #666;">
                <span style="background: ${event.status === 'é¦–æ’­' ? '#ffc107' : '#28a745'}; color: white; padding: 2px 6px; border-radius: 3px; margin-right: 8px;">
                  ${event.status}
                </span>
                <span>${event.category}</span>
                <span style="margin-left: 8px;">${event.duration}åˆ†é˜</span>
              </div>
              ${event.description ? `<div style="color: #666; font-size: 0.8rem; color: #666; margin-top: 4px; word-break: break-word;">${event.description}</div>` : ''}
            `;

            eventCell.appendChild(eventDiv);
          });
        } else {
          const emptyDiv = document.createElement('div');
          emptyDiv.style.cssText = `
            color: #999;
            font-size: 0.8rem;
            font-style: italic;
            width: 100%;
            text-align: center;
          `;
          emptyDiv.textContent = 'é»æ“Šæ–°å¢ç¯€ç›®';
          eventCell.appendChild(emptyDiv);
        }

        row.appendChild(eventCell);
        calendarBody.appendChild(row);
      });
    }

    function getDayEvents(dateString) {
      // ç›´æ¥å¾ Contentful è®€å–ï¼Œä¸ä½¿ç”¨æœ¬åœ°ç·©å­˜
      return events[dateString] || [];
    }

    // ç²å–ç‰¹å®šæ—¥æœŸå’Œæ™‚é–“çš„ç¯€ç›®
    function getEvent(date, time) {
      const dayEvents = events[date] || [];
      console.log(`ğŸ” getEvent(${date}, ${time}):`, {
        dayEventsCount: dayEvents.length,
        dayEvents: dayEvents.map(e => ({ time: e.time, title: e.title, topics: e.topics }))
      });
      const foundEvent = dayEvents.find(event => event.time === time);
      console.log(`ğŸ” æ‰¾åˆ°çš„ç¯€ç›®:`, foundEvent);
      return foundEvent;
    }

    function getDayEventsHTML(dateString) {
      const dayEvents = events[dateString] || [];
      if (dayEvents.length === 0) {
        return '';
      }

      const maxVisibleEvents = 3;
      const visibleEvents = dayEvents.slice(0, maxVisibleEvents);
      const hiddenEventsCount = dayEvents.length - maxVisibleEvents;

      let html = '';

      visibleEvents.forEach(event => {
        const maxTitleLength = 20;
        const displayTitle = event.title.length > maxTitleLength ?
          event.title.substring(0, maxTitleLength) + '...' : event.title;

        html += `
          <div class="event ${event.status === 'é¦–æ’­' ? 'first-air' : ''} ${isPrimeTime(parseInt(event.time.split(':')[0])) ? 'prime-time' : ''}"
               onclick="openEventModal('${dateString}', '${event.time}')">
            <span class="event-time-label">${event.time}</span>${displayTitle}
            ${event.title.length > maxTitleLength || event.description ? `
              <div class="event-tooltip">
                <strong>${event.title}</strong>
                ${event.description ? `<br><small>${event.description}</small>` : ''}
                <br><small>${event.time} | ${event.category} | ${event.duration}åˆ†é˜</small>
              </div>
            ` : ''}
          </div>
        `;
      });

      if (hiddenEventsCount > 0) {
        html += `
          <div class="more-events-indicator" onclick="showAllEventsForDay('${dateString}')">
            +${hiddenEventsCount} æ›´å¤šç¯€ç›®
          </div>
        `;
      }

      return html;
    }

    function isPrimeTime(hour) {
      return hour >= 12 && hour < 18;
    }

    function previousPeriod() {
      switch(currentView) {
        case 'month': currentDate.setMonth(currentDate.getMonth() - 1); break;
        case 'week': currentDate.setDate(currentDate.getDate() - 7); break;
        case 'day': currentDate.setDate(currentDate.getDate() - 1); break;
      }
      renderCurrentView();
      updateCurrentDateDisplay();
    }

    function nextPeriod() {
      switch(currentView) {
        case 'month': currentDate.setMonth(currentDate.getMonth() + 1); break;
        case 'week': currentDate.setDate(currentDate.getDate() + 7); break;
        case 'day': currentDate.setDate(currentDate.getDate() + 1); break;
      }
      renderCurrentView();
      updateCurrentDateDisplay();
    }

    function goToToday() {
      currentDate = new Date();
      renderCurrentView();
      updateCurrentDateDisplay();
    }

    function updateCurrentDateDisplay() {
      const dateElement = document.getElementById('currentDate');
      switch(currentView) {
        case 'month':
          dateElement.textContent = `${currentDate.getFullYear()}å¹´${currentDate.getMonth() + 1}æœˆ`;
          break;
        case 'week':
          const weekStart = new Date(currentDate);
          weekStart.setDate(currentDate.getDate() - currentDate.getDay());
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekStart.getDate() + 6);
          dateElement.textContent = `${weekStart.getFullYear()}å¹´${weekStart.getMonth() + 1}æœˆ${weekStart.getDate()}æ—¥ - ${weekEnd.getMonth() + 1}æœˆ${weekEnd.getDate()}æ—¥`;
          break;
        case 'day':
          dateElement.textContent = `${currentDate.getFullYear()}å¹´${currentDate.getMonth() + 1}æœˆ${currentDate.getDate()}æ—¥`;
          break;
      }
    }

    function openEventModal(date, time = '') {
      // ç§»é™¤éå»æ—¥æœŸå’Œæ™‚é–“çš„ç·¨è¼¯é™åˆ¶ï¼Œå…è¨±ç·¨è¼¯æ‰€æœ‰æ—¥æœŸå’Œæ™‚é–“

      document.getElementById('editDate').value = date;
      document.getElementById('editTime').value = time;
      document.getElementById('airTime').value = time;
      
      // æª¢æŸ¥æ˜¯å¦ç‚ºéå»çš„æ™‚é–“ä¸¦é¡¯ç¤ºè­¦èª
      setTimeout(() => {
        checkPastDateTime();
      }, 100);

      const existingEvent = getEvent(date, time);
      if (existingEvent) {
        console.log('ğŸ” è¼‰å…¥ç¾æœ‰ç¯€ç›®è³‡æ–™:', existingEvent);
        console.log('ğŸ” ç¯€ç›®ä¸»é¡Œè³‡æ–™è©³æƒ…:', {
          topics: existingEvent.topics,
          topicsType: typeof existingEvent.topics,
          topicsLength: existingEvent.topics ? existingEvent.topics.length : 'N/A',
          topicsArray: Array.isArray(existingEvent.topics)
        });
        document.getElementById('modalTitle').textContent = 'ç·¨è¼¯ç¯€ç›®';
        
        // ç§»é™¤ä¿®æ”¹æŒ‰éˆ•ç›¸é—œé‚è¼¯
        
        document.getElementById('title').value = existingEvent.title;
        document.getElementById('duration').value = existingEvent.duration;
        document.getElementById('category').value = existingEvent.category;
        document.getElementById('description').value = existingEvent.description;
        document.getElementById('status').value = existingEvent.status;
        document.getElementById('videoType').value = existingEvent.videoType || '';
        document.getElementById('youtubeId').value = existingEvent.youtubeId || '';
        
        // è¼‰å…¥ç¸®åœ–è³‡æ–™
        const thumbnailPreview = document.getElementById('thumbnailPreview');
        if (existingEvent.thumbnail) {
          thumbnailPreview.src = existingEvent.thumbnail;
          if (existingEvent.youtubeId) {
            thumbnailPreview.setAttribute('data-youtube-url', `https://img.youtube.com/vi/${existingEvent.youtubeId}/maxresdefault.jpg`);
          }
        } else if (existingEvent.youtubeId) {
          // å¦‚æœæœ‰ YouTube ID ä½†æ²’æœ‰ç¸®åœ–ï¼Œç”Ÿæˆç¸®åœ–
          const youtubeThumbnail = `https://img.youtube.com/vi/${existingEvent.youtubeId}/maxresdefault.jpg`;
          thumbnailPreview.src = youtubeThumbnail;
          thumbnailPreview.setAttribute('data-youtube-url', youtubeThumbnail);
        } else {
          // æ²’æœ‰ç¸®åœ–è³‡æ–™ï¼Œä½¿ç”¨é è¨­
          thumbnailPreview.src = 'https://images.unsplash.com/photo-1485846234645-a62644f84728?w=200&h=112&fit=crop';
          thumbnailPreview.removeAttribute('data-youtube-url');
        }
        
        // è¼‰å…¥ä¸»é¡Œæ¢ç´¢åˆ†é¡
        console.log('ğŸ” æª¢æŸ¥ä¸»é¡Œè³‡æ–™:', existingEvent.topics);
        console.log('ğŸ” æª¢æŸ¥ç¯€ç›®å‚™è¨»å…§å®¹:', existingEvent.description);
        
        // æª¢æŸ¥å‚™è¨»ä¸­æ˜¯å¦æœ‰ä¸»é¡Œæ¨™è¨˜
        const notes = existingEvent.description || '';
        const hasTopicMarkers = notes.includes('[ä¸»é¡Œ:');
        const hasCategoryMarkers = notes.includes('[åˆ†é¡:');
        console.log('ğŸ” å‚™è¨»æ¨™è¨˜æª¢æŸ¥:', {
          hasTopicMarkers: hasTopicMarkers,
          hasCategoryMarkers: hasCategoryMarkers,
          notesLength: notes.length,
          notesPreview: notes.substring(0, 200)
        });
        
        // æ‰‹å‹•å¾å‚™è¨»ä¸­æå–ä¸»é¡Œï¼Œæª¢æŸ¥æ˜¯å¦èˆ‡ existingEvent.topics ä¸€è‡´
        const extractedTopics = extractTopicsFromNotes(notes);
        console.log('ğŸ” æ‰‹å‹•æå–çš„ä¸»é¡Œ:', extractedTopics);
        console.log('ğŸ” existingEvent.topics:', existingEvent.topics);
        console.log('ğŸ” ä¸»é¡Œè³‡æ–™æ˜¯å¦ä¸€è‡´:', JSON.stringify(extractedTopics) === JSON.stringify(existingEvent.topics));
        console.log('ğŸ” å®Œæ•´çš„ existingEvent ç‰©ä»¶:', existingEvent);
        console.log('ğŸ” å‚™è¨»å®Œæ•´å…§å®¹:', notes);
        
        // ç¢ºä¿ä¸»é¡Œè¤‡é¸æ¡†å·²ç¶“è¼‰å…¥
        const topicsContainer = document.getElementById('topicsCheckboxes');
        if (!topicsContainer || topicsContainer.children.length === 0) {
          console.log('âš ï¸ ä¸»é¡Œè¤‡é¸æ¡†æœªè¼‰å…¥ï¼Œé‡æ–°è¼‰å…¥...');
          loadTopics();
        }
        
        // ç­‰å¾…ä¸€ä¸‹è®“ DOM æ›´æ–°
        setTimeout(() => {
          // æ±ºå®šä½¿ç”¨å“ªå€‹ä¸»é¡Œè³‡æ–™
          let topicsToLoad = existingEvent.topics;
          
          // å¦‚æœ existingEvent.topics ç‚ºç©ºï¼Œä½†å‚™è¨»ä¸­æœ‰ä¸»é¡Œæ¨™è¨˜ï¼Œä½¿ç”¨æ‰‹å‹•æå–çš„ä¸»é¡Œ
          if ((!topicsToLoad || topicsToLoad.length === 0) && extractedTopics.length > 0) {
            console.log('ğŸ”„ ä½¿ç”¨æ‰‹å‹•æå–çš„ä¸»é¡Œè³‡æ–™:', extractedTopics);
            topicsToLoad = extractedTopics;
          }
          
          if (topicsToLoad && Array.isArray(topicsToLoad) && topicsToLoad.length > 0) {
            console.log('âœ… æ‰¾åˆ°ä¸»é¡Œè³‡æ–™ï¼Œé–‹å§‹è¼‰å…¥:', topicsToLoad);
            // æ¸…é™¤æ‰€æœ‰ä¸»é¡Œé¸æ“‡
            document.querySelectorAll('input[name="topics"]').forEach(checkbox => {
              checkbox.checked = false;
            });
            
            // é¸ä¸­ç¾æœ‰çš„ä¸»é¡Œ
            topicsToLoad.forEach(topicTitle => {
              console.log('ğŸ” è™•ç†ä¸»é¡Œ:', topicTitle);
              // æ ¹æ“šä¸»é¡Œæ¨™é¡Œæ‰¾åˆ°å°æ‡‰çš„ topicId
              const topicData = TOPICS_DATA.find(topic => topic.title === topicTitle);
              if (topicData) {
                const checkbox = document.querySelector(`input[name="topics"][value="${topicData.id}"]`);
                if (checkbox) {
                  checkbox.checked = true;
                  console.log('âœ… è¼‰å…¥ä¸»é¡Œ:', topicTitle, 'ID:', topicData.id);
                } else {
                  console.log('âŒ æ‰¾ä¸åˆ°å°æ‡‰çš„è¤‡é¸æ¡†:', topicData.id);
                  console.log('ğŸ” å¯ç”¨çš„è¤‡é¸æ¡†:', document.querySelectorAll('input[name="topics"]'));
                }
              } else {
                console.log('âš ï¸ æ‰¾ä¸åˆ°ä¸»é¡Œè³‡æ–™:', topicTitle);
                console.log('ğŸ” å¯ç”¨çš„ä¸»é¡Œè³‡æ–™:', TOPICS_DATA.map(t => t.title));
              }
            });
          } else {
            console.log('âš ï¸ æ²’æœ‰ä¸»é¡Œè³‡æ–™æˆ–ä¸»é¡Œé™£åˆ—ç‚ºç©º');
            // å¦‚æœæ²’æœ‰ä¸»é¡Œè³‡æ–™ï¼Œæ¸…é™¤æ‰€æœ‰é¸æ“‡
            document.querySelectorAll('input[name="topics"]').forEach(checkbox => {
              checkbox.checked = false;
            });
          }
        }, 100);
        
        // æ¸…é™¤æª”æ¡ˆé¸æ“‡ï¼ˆå› ç‚ºæ˜¯ç·¨è¼¯ç¾æœ‰ç¯€ç›®ï¼‰
        const thumbnailFile = document.getElementById('thumbnailFile');
        if (thumbnailFile) {
          thumbnailFile.value = '';
        }
        
        toggleVideoFields();
      } else {
        document.getElementById('modalTitle').textContent = 'æ–°å¢ç¯€ç›®';
        
        // ç§»é™¤ä¿®æ”¹æŒ‰éˆ•ç›¸é—œé‚è¼¯
        
        document.getElementById('eventForm').reset();
        document.getElementById('airTime').value = time;
        
        // æ¸…é™¤æ‰€æœ‰èˆŠè³‡æ–™
        document.getElementById('title').value = '';
        document.getElementById('duration').value = '30';
        document.getElementById('category').value = '';
        document.getElementById('description').value = '';
        document.getElementById('status').value = 'é‡æ’­';
        document.getElementById('videoType').value = '';
        document.getElementById('youtubeId').value = '';
        
        // æ¸…é™¤ç¸®åœ–é è¦½
        const thumbnailPreview = document.getElementById('thumbnailPreview');
        thumbnailPreview.src = 'https://images.unsplash.com/photo-1485846234645-a62644f84728?w=200&h=112&fit=crop';
        thumbnailPreview.removeAttribute('data-youtube-url');
        
        // æ¸…é™¤æª”æ¡ˆé¸æ“‡
        const thumbnailFile = document.getElementById('thumbnailFile');
        if (thumbnailFile) {
          thumbnailFile.value = '';
        }
        
        // æ¸…é™¤ä¸»é¡Œæ¢ç´¢åˆ†é¡é¸æ“‡
        document.querySelectorAll('input[name="topics"]').forEach(checkbox => {
          checkbox.checked = false;
        });
        
        // éš±è—å½±ç‰‡é¡å‹ç›¸é—œæ¬„ä½
        toggleVideoFields();
      }

      document.getElementById('eventModal').style.display = 'block';
    }

    function closeModal() {
      // æ¸…é™¤å½±ç‰‡ç·¨è¼¯ç‹€æ…‹
      window.currentEditingVideoId = null;
      window.currentEditingVideoData = null;
      
      document.getElementById('eventModal').style.display = 'none';
    }

    // é¡¯ç¤ºé€²åº¦æ¢
    function showProgressBar(message, percentage) {
      console.log('ğŸ¯ showProgressBar è¢«èª¿ç”¨:', { message, percentage });
      
      // ç§»é™¤ç¾æœ‰çš„é€²åº¦æ¢
      hideProgressBar();
      
      // å‰µå»ºé€²åº¦æ¢å®¹å™¨
      const progressDialog = document.createElement('div');
      progressDialog.id = 'saveProgressDialog';
      progressDialog.style.cssText = `
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background: rgba(0, 0, 0, 0.8) !important;
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        z-index: 999999 !important;
        font-family: Arial, sans-serif !important;
        pointer-events: auto !important;
      `;
      
      progressDialog.innerHTML = `
        <div style="
          background: white !important;
          padding: 40px !important;
          border-radius: 20px !important;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5) !important;
          max-width: 450px !important;
          width: 90% !important;
          text-align: center !important;
          border: 3px solid #4CAF50 !important;
        ">
          <h3 style="margin: 0 0 25px 0; color: #333; font-size: 20px; font-weight: bold;">ğŸ’¾ å„²å­˜ç¯€ç›®</h3>
          <div style="margin-bottom: 25px;">
            <div style="
              width: 100%;
              height: 25px;
              background: #e0e0e0;
              border-radius: 12px;
              overflow: hidden;
              margin-bottom: 15px;
              border: 2px solid #ddd;
            ">
              <div id="saveProgressBar" style="
                width: ${percentage}%;
                height: 100%;
                background: linear-gradient(90deg, #4CAF50, #45a049);
                transition: width 0.5s ease;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(76, 175, 80, 0.3);
              "></div>
            </div>
            <div id="saveProgressText" style="color: #555; font-size: 16px; font-weight: 500; margin-bottom: 8px;">${message}</div>
            <div id="saveProgressPercent" style="color: #4CAF50; font-size: 18px; font-weight: bold;">${percentage}%</div>
          </div>
          <div style="color: #888; font-size: 12px;">è«‹ç¨å€™ï¼Œæ­£åœ¨è™•ç†ä¸­...</div>
        </div>
      `;
      
      // å¼·åˆ¶æ·»åŠ åˆ° body ä¸¦ç¢ºä¿é¡¯ç¤º
      document.body.appendChild(progressDialog);
      
      // å¼·åˆ¶é‡ç¹ª
      progressDialog.offsetHeight;
      
      console.log('ğŸ¯ é€²åº¦æ¢å·²æ·»åŠ åˆ° DOMï¼Œå…ƒç´ :', progressDialog);
      console.log('ğŸ¯ é€²åº¦æ¢æ¨£å¼:', progressDialog.style.cssText);
      
      // æ¸¬è©¦é€²åº¦æ¢æ˜¯å¦å¯è¦‹
      setTimeout(() => {
        const rect = progressDialog.getBoundingClientRect();
        console.log('ğŸ¯ é€²åº¦æ¢ä½ç½®å’Œå¤§å°:', rect);
        console.log('ğŸ¯ é€²åº¦æ¢æ˜¯å¦å¯è¦‹:', rect.width > 0 && rect.height > 0);
      }, 100);
    }

    // éš±è—é€²åº¦æ¢
    function hideProgressBar() {
      const existingDialog = document.getElementById('saveProgressDialog');
      if (existingDialog) {
        document.body.removeChild(existingDialog);
      }
    }

    // æ¸¬è©¦é€²åº¦æ¢å‡½æ•¸ï¼ˆå¯ä»¥åœ¨æ§åˆ¶å°èª¿ç”¨ï¼‰
    window.testProgressBar = function() {
      console.log('ğŸ§ª æ¸¬è©¦é€²åº¦æ¢');
      showProgressBar('æ¸¬è©¦é€²åº¦æ¢...', 50);
      
      setTimeout(() => {
        showProgressBar('æ¸¬è©¦å®Œæˆï¼', 100);
      }, 2000);
      
      setTimeout(() => {
        hideProgressBar();
        console.log('ğŸ§ª æ¸¬è©¦å®Œæˆï¼Œé€²åº¦æ¢å·²éš±è—');
      }, 4000);
    };

    // æ›´æ–°å½±ç‰‡åˆ° Contentful
    async function updateVideoInContentful() {
      try {
        console.log('ğŸ¬ updateVideoInContentful å‡½æ•¸é–‹å§‹åŸ·è¡Œ');
        console.log('ğŸ” ç•¶å‰ç·¨è¼¯çš„å½±ç‰‡ ID:', window.currentEditingVideoId);
        
        // é¡¯ç¤ºé€²åº¦æ¢
        console.log('ğŸ¯ æº–å‚™é¡¯ç¤ºé€²åº¦æ¢');
        showProgressBar('æ­£åœ¨å„²å­˜å½±ç‰‡è®Šæ›´...', 0);
        console.log('ğŸ¯ é€²åº¦æ¢å·²èª¿ç”¨');
        
        showStatus('æ­£åœ¨å„²å­˜å½±ç‰‡è®Šæ›´...', 'info');
        
        // æª¢æŸ¥ Management SDK
        if (typeof contentfulManagement === 'undefined') {
          console.error('âŒ Management SDK æœªè¼‰å…¥');
          throw new Error('Management SDK æœªè¼‰å…¥ï¼Œè«‹å…ˆè¼‰å…¥ Management SDK');
        }
        
        console.log('âœ… Management SDK å·²è¼‰å…¥');
        
        // æ›´æ–°é€²åº¦æ¢
        showProgressBar('æ­£åœ¨é€£æ¥ Contentful...', 20);
        
        // å‰µå»º Management å®¢æˆ¶ç«¯
        const managementClient = contentfulManagement.createClient({
          accessToken: 'CFPAT-hNLOfw3XdP5Hf_C3eYjI8294agakAK0Yo5Ew1Mjnsqs'
        });
        
        // ç²å–ç©ºé–“å’Œç’°å¢ƒ
        const space = await managementClient.getSpace('os5wf90ljenp');
        const environment = await space.getEnvironment('master');
        
        // æ›´æ–°é€²åº¦æ¢
        showProgressBar('æ­£åœ¨è¼‰å…¥å½±ç‰‡è³‡æ–™...', 40);
        
        // ç²å–è¦ç·¨è¼¯çš„æ¢ç›®
        const entry = await environment.getEntry(window.currentEditingVideoId);
        
        // èª¿è©¦ï¼šé¡¯ç¤ºç¾æœ‰æ¬„ä½çµæ§‹
        console.log('ğŸ” ç¾æœ‰æ¢ç›®æ¬„ä½çµæ§‹:', Object.keys(entry.fields));
        console.log('ğŸ” ç¾æœ‰æ¢ç›®å®Œæ•´è³‡æ–™:', entry.fields);
        console.log('ğŸ” å…§å®¹é¡å‹:', entry.sys.contentType?.sys?.id);
        console.log('ğŸ” æ¢ç›® ID:', entry.sys.id);
        
        // æº–å‚™æ›´æ–°è³‡æ–™
        const title = document.getElementById('title').value;
        const description = document.getElementById('description').value;
        const youtubeId = document.getElementById('youtubeId').value;
        const category = document.getElementById('category').value;
        const videoType = document.getElementById('videoType').value;
        
        // ç²å–é¸ä¸­çš„ä¸»é¡Œæ¢ç´¢åˆ†é¡
        const selectedTopics = [];
        document.querySelectorAll('input[name="topics"]:checked').forEach(checkbox => {
          selectedTopics.push(checkbox.value);
        });
        
        // æ›´æ–°æ¢ç›® - å˜—è©¦å¤šç¨®å¯èƒ½çš„æ¬„ä½åç¨±
        const updateFields = {
          ...entry.fields,
          'title': {
            'en-US': title
          },
          'description': {
            'en-US': description
          },
          'youTubeId': {
            'en-US': youtubeId
          },
          'tags': {
            'en-US': selectedTopics
          }
        };
        
        // å˜—è©¦ä¸åŒçš„åˆ†é¡æ¬„ä½åç¨±
        console.log('ğŸ” æª¢æŸ¥åˆ†é¡æ¬„ä½å­˜åœ¨æ€§:');
        console.log('  - category:', !!entry.fields['category']);
        console.log('  - ç¯€ç›®åˆ†é¡:', !!entry.fields['ç¯€ç›®åˆ†é¡']);
        console.log('  - åˆ†é¡:', !!entry.fields['åˆ†é¡']);
        console.log('  - Category:', !!entry.fields['Category']);
        
        // æª¢æŸ¥æ‰€æœ‰å¯èƒ½çš„æ¬„ä½åç¨±
        const allFieldNames = Object.keys(entry.fields);
        console.log('ğŸ” æ‰€æœ‰æ¬„ä½åç¨±:', allFieldNames);
        
        // å°‹æ‰¾åŒ…å« "category" æˆ– "åˆ†é¡" çš„æ¬„ä½
        const categoryFields = allFieldNames.filter(name => 
          name.toLowerCase().includes('category') || 
          name.includes('åˆ†é¡')
        );
        console.log('ğŸ” æ‰¾åˆ°çš„åˆ†é¡ç›¸é—œæ¬„ä½:', categoryFields);
        
        if (entry.fields['category']) {
          console.log('âœ… ä½¿ç”¨ category æ¬„ä½');
          updateFields['category'] = { 'en-US': category };
        } else if (entry.fields['Category']) {
          console.log('âœ… ä½¿ç”¨ Category æ¬„ä½');
          updateFields['Category'] = { 'en-US': category };
        } else if (entry.fields['ç¯€ç›®åˆ†é¡']) {
          console.log('âœ… ä½¿ç”¨ ç¯€ç›®åˆ†é¡ æ¬„ä½');
          updateFields['ç¯€ç›®åˆ†é¡'] = { 'zh-TW': category };
        } else if (entry.fields['åˆ†é¡']) {
          console.log('âœ… ä½¿ç”¨ åˆ†é¡ æ¬„ä½');
          updateFields['åˆ†é¡'] = { 'zh-TW': category };
        } else if (categoryFields.length > 0) {
          // ä½¿ç”¨æ‰¾åˆ°çš„ç¬¬ä¸€å€‹åˆ†é¡ç›¸é—œæ¬„ä½
          const fieldName = categoryFields[0];
          console.log('âœ… ä½¿ç”¨æ‰¾åˆ°çš„åˆ†é¡æ¬„ä½:', fieldName);
          updateFields[fieldName] = { 'en-US': category };
        } else {
          console.log('âš ï¸ æœªæ‰¾åˆ°åˆ†é¡æ¬„ä½ï¼Œå˜—è©¦å¼·åˆ¶å‰µå»º category');
          // å˜—è©¦å¼·åˆ¶å‰µå»º category æ¬„ä½
          updateFields['category'] = { 'en-US': category };
          showStatus('âš ï¸ å˜—è©¦å‰µå»º category æ¬„ä½ï¼Œå¦‚æœå¤±æ•—è«‹æª¢æŸ¥å…§å®¹æ¨¡å‹', 'warning');
        }
        
        entry.fields = updateFields;
        
        // æ›´æ–°é€²åº¦æ¢
        showProgressBar('æ­£åœ¨æ›´æ–°å½±ç‰‡è³‡æ–™...', 70);
        
        // å¦‚æœæœ‰ MP4 æª”æ¡ˆï¼Œä¹Ÿæ›´æ–°
        if (videoType === 'MP4') {
          const mp4File = document.getElementById('mp4File').files[0];
          if (mp4File) {
            // é€™è£¡å¯ä»¥æ·»åŠ  MP4 æª”æ¡ˆä¸Šå‚³é‚è¼¯
            entry.fields['MP4 å½±ç‰‡ç¶²å€'] = {
              'zh-TW': mp4File.name
            };
          }
        }
        
        // æ›´æ–°é€²åº¦æ¢
        showProgressBar('æ­£åœ¨å„²å­˜åˆ° Contentful...', 85);
        
        // å„²å­˜è®Šæ›´
        const updatedEntry = await entry.update();
        
        // æ›´æ–°é€²åº¦æ¢
        showProgressBar('æ­£åœ¨ç™¼å¸ƒè®Šæ›´...', 95);
        
        await updatedEntry.publish();
        
        // æ¸…é™¤ç·¨è¼¯ç‹€æ…‹
        window.currentEditingVideoId = null;
        window.currentEditingVideoData = null;
        
        // æ›´æ–°é€²åº¦æ¢
        showProgressBar('å„²å­˜å®Œæˆï¼', 100);
        
        // é—œé–‰æ¨¡æ…‹æ¡†
        closeModal();
        
        // é‡æ–°è¼‰å…¥å½±ç‰‡åˆ—è¡¨
        showStatus('âœ… å½±ç‰‡å·²æˆåŠŸæ›´æ–°ï¼Œæ­£åœ¨é‡æ–°è¼‰å…¥...', 'success');
        
        // éš±è—é€²åº¦æ¢
        setTimeout(() => {
          hideProgressBar();
          showAllVideos();
        }, 1000);
        
      } catch (error) {
        console.error('æ›´æ–°å½±ç‰‡å¤±æ•—:', error);
        hideProgressBar(); // éš±è—é€²åº¦æ¢
        showStatus(`âŒ æ›´æ–°å½±ç‰‡å¤±æ•—: ${error.message}`, 'error');
      }
    }

    function openTimeSlotSelector(date) {
      const today = new Date();
      const currentHour = today.getHours();
      const currentMinute = today.getMinutes();
      const todayString = today.getFullYear() + '-' +
                         String(today.getMonth() + 1).padStart(2, '0') + '-' +
                         String(today.getDate()).padStart(2, '0');
      const isToday = date === todayString;

      const timeSlotGrid = document.getElementById('timeSlotGrid');
      timeSlotGrid.innerHTML = '';

      for (let hour = 0; hour < 24; hour++) {
        for (let minute = 0; minute < 60; minute += 30) {
          const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;

          // ç§»é™¤éå»æ™‚é–“çš„é™åˆ¶ï¼Œæ‰€æœ‰æ™‚é–“éƒ½å¯ä»¥é¸æ“‡

          const timeSlot = document.createElement('div');
          timeSlot.className = 'time-slot-btn';
          timeSlot.style.cssText = `
            padding: 15px 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            background: #fff;
            color: #333;
            font-weight: 600;
            transition: all 0.3s ease;
          `;

            timeSlot.addEventListener('mouseenter', function() {
              this.style.borderColor = '#2b71d2';
              this.style.backgroundColor = '#e3f2fd';
            });

            timeSlot.addEventListener('mouseleave', function() {
              this.style.borderColor = '#e9ecef';
              this.style.backgroundColor = '#fff';
            });

            timeSlot.addEventListener('click', function() {
              openEventModal(date, timeString);
              closeTimeSlotModal();
            });

          timeSlot.textContent = timeString;
          timeSlotGrid.appendChild(timeSlot);
        }
      }

      document.getElementById('timeSlotModal').style.display = 'block';
    }

    function closeTimeSlotModal() {
      document.getElementById('timeSlotModal').style.display = 'none';
    }

    function toggleVideoFields() {
      const videoType = document.getElementById('videoType').value;
      const youtubeIdGroup = document.getElementById('youtubeIdGroup');
      const mp4FileGroup = document.getElementById('mp4FileGroup');

      youtubeIdGroup.style.display = videoType === 'YouTube' ? 'block' : 'none';
      mp4FileGroup.style.display = videoType === 'MP4' ? 'block' : 'none';
    }

    // åœ‹å®¶/åœ°å€åˆ°æ´²çš„å°æ‡‰è¡¨
    const countryToContinent = {
      // äºæ´²
      'å°ç£': 'äºæ´²', 'ä¸­åœ‹': 'äºæ´²', 'æ—¥æœ¬': 'äºæ´²', 'éŸ“åœ‹': 'äºæ´²', 'é¦™æ¸¯': 'äºæ´²', 'æ¾³é–€': 'äºæ´²',
      'æ–°åŠ å¡': 'äºæ´²', 'é¦¬ä¾†è¥¿äº': 'äºæ´²', 'æ³°åœ‹': 'äºæ´²', 'è¶Šå—': 'äºæ´²', 'è²å¾‹è³“': 'äºæ´²',
      'å°å°¼': 'äºæ´²', 'å°åº¦': 'äºæ´²', 'å·´åŸºæ–¯å¦': 'äºæ´²', 'å­ŸåŠ æ‹‰': 'äºæ´²', 'æ–¯é‡Œè˜­å¡': 'äºæ´²',
      'å°¼æ³Šçˆ¾': 'äºæ´²', 'ä¸ä¸¹': 'äºæ´²', 'ç·¬ç”¸': 'äºæ´²', 'æŸ¬åŸ”å¯¨': 'äºæ´²', 'å¯®åœ‹': 'äºæ´²',
      'è’™å¤': 'äºæ´²', 'å“ˆè–©å…‹': 'äºæ´²', 'çƒèŒ²åˆ¥å…‹': 'äºæ´²', 'å‰çˆ¾å‰æ–¯': 'äºæ´²', 'å¡”å‰å…‹': 'äºæ´²',
      'åœŸåº«æ›¼': 'äºæ´²', 'é˜¿å¯Œæ±—': 'äºæ´²', 'ä¼Šæœ—': 'äºæ´²', 'ä¼Šæ‹‰å…‹': 'äºæ´²', 'ä»¥è‰²åˆ—': 'äºæ´²',
      'ç´„æ—¦': 'äºæ´²', 'é»å·´å«©': 'äºæ´²', 'æ•˜åˆ©äº': 'äºæ´²', 'åœŸè€³å…¶': 'äºæ´²', 'æ²™çƒåœ°é˜¿æ‹‰ä¼¯': 'äºæ´²',
      'é˜¿è¯é…‹': 'äºæ´²', 'å¡é”': 'äºæ´²', 'ç§‘å¨ç‰¹': 'äºæ´²', 'å·´æ—': 'äºæ´²', 'é˜¿æ›¼': 'äºæ´²',
      'è‘‰é–€': 'äºæ´²', 'äºç¾å°¼äº': 'äºæ´²', 'äºå¡æ‹œç„¶': 'äºæ´²', 'å–¬æ²»äº': 'äºæ´²',
      
      // äºæ´²è‹±æ–‡åç¨±
      'China': 'äºæ´²', 'Japan': 'äºæ´²', 'Korea': 'äºæ´²', 'South Korea': 'äºæ´²', 'North Korea': 'äºæ´²',
      'Taiwan': 'äºæ´²', 'Hong Kong': 'äºæ´²', 'Macau': 'äºæ´²', 'Mongolia': 'äºæ´²', 'India': 'äºæ´²',
      'Pakistan': 'äºæ´²', 'Bangladesh': 'äºæ´²', 'Sri Lanka': 'äºæ´²', 'Nepal': 'äºæ´²', 'Bhutan': 'äºæ´²',
      'Maldives': 'äºæ´²', 'Myanmar': 'äºæ´²', 'Thailand': 'äºæ´²', 'Laos': 'äºæ´²', 'Cambodia': 'äºæ´²',
      'Vietnam': 'äºæ´²', 'Malaysia': 'äºæ´²', 'Singapore': 'äºæ´²', 'Indonesia': 'äºæ´²', 'Philippines': 'äºæ´²',
      'Brunei': 'äºæ´²', 'East Timor': 'äºæ´²', 'Kazakhstan': 'äºæ´²', 'Uzbekistan': 'äºæ´²', 'Turkmenistan': 'äºæ´²',
      'Afghanistan': 'äºæ´²', 'Iran': 'äºæ´²', 'Iraq': 'äºæ´²', 'Israel': 'äºæ´²', 'Jordan': 'äºæ´²',
      'Lebanon': 'äºæ´²', 'Syria': 'äºæ´²', 'Turkey': 'äºæ´²', 'Saudi Arabia': 'äºæ´²', 'UAE': 'äºæ´²',
      'Qatar': 'äºæ´²', 'Kuwait': 'äºæ´²', 'Bahrain': 'äºæ´²', 'Oman': 'äºæ´²', 'Yemen': 'äºæ´²',
      'Armenia': 'äºæ´²', 'Azerbaijan': 'äºæ´²', 'Georgia': 'äºæ´²',
      
      // æ­æ´²
      'è‹±åœ‹': 'æ­æ´²', 'France': 'æ­æ´²', 'å¾·åœ‹': 'æ­æ´²', 'ç¾©å¤§åˆ©': 'æ­æ´²', 'Italy': 'æ­æ´²', 'è¥¿ç­ç‰™': 'æ­æ´²',
      'è·è˜­': 'æ­æ´²', 'æ¯”åˆ©æ™‚': 'æ­æ´²', 'ç‘å£«': 'æ­æ´²', 'å¥§åœ°åˆ©': 'æ­æ´²', 'ç‘å…¸': 'æ­æ´²',
      'æŒªå¨': 'æ­æ´²', 'ä¸¹éº¥': 'æ­æ´²', 'èŠ¬è˜­': 'æ­æ´²', 'å†°å³¶': 'æ­æ´²', 'æ„›çˆ¾è˜­': 'æ­æ´²',
      'è‘¡è„ç‰™': 'æ­æ´²', 'å¸Œè‡˜': 'æ­æ´²', 'æ³¢è˜­': 'æ­æ´²', 'æ·å…‹': 'æ­æ´²', 'åŒˆç‰™åˆ©': 'æ­æ´²',
      'ç¾…é¦¬å°¼äº': 'æ­æ´²', 'ä¿åŠ åˆ©äº': 'æ­æ´²', 'å…‹ç¾…åŸƒè¥¿äº': 'æ­æ´²', 'å¡çˆ¾ç¶­äº': 'æ­æ´²',
      'æ–¯æ´›ç¶­å°¼äº': 'æ­æ´²', 'æ–¯æ´›ä¼å…‹': 'æ­æ´²', 'ç«‹é™¶å®›': 'æ­æ´²', 'æ‹‰è„«ç¶­äº': 'æ­æ´²',
      'æ„›æ²™å°¼äº': 'æ­æ´²', 'çƒå…‹è˜­': 'æ­æ´²', 'ç™½ä¿„ç¾…æ–¯': 'æ­æ´²', 'ä¿„ç¾…æ–¯': 'æ­æ´²',
      
      // æ­æ´²è‹±æ–‡åç¨±
      'United Kingdom': 'æ­æ´²', 'UK': 'æ­æ´²', 'England': 'æ­æ´²', 'Scotland': 'æ­æ´²', 'Wales': 'æ­æ´²',
      'Germany': 'æ­æ´²', 'Spain': 'æ­æ´²', 'Netherlands': 'æ­æ´²', 'Belgium': 'æ­æ´²', 'Switzerland': 'æ­æ´²',
      'Austria': 'æ­æ´²', 'Sweden': 'æ­æ´²', 'Norway': 'æ­æ´²', 'Denmark': 'æ­æ´²', 'Finland': 'æ­æ´²',
      'Iceland': 'æ­æ´²', 'Ireland': 'æ­æ´²', 'Portugal': 'æ­æ´²', 'Greece': 'æ­æ´²', 'Poland': 'æ­æ´²',
      'Czech Republic': 'æ­æ´²', 'Czech': 'æ­æ´²', 'Hungary': 'æ­æ´²', 'Romania': 'æ­æ´²', 'Bulgaria': 'æ­æ´²',
      'Croatia': 'æ­æ´²', 'Serbia': 'æ­æ´²', 'Slovenia': 'æ­æ´²', 'Slovakia': 'æ­æ´²', 'Lithuania': 'æ­æ´²',
      'Latvia': 'æ­æ´²', 'Estonia': 'æ­æ´²', 'Ukraine': 'æ­æ´²', 'Belarus': 'æ­æ´²', 'Russia': 'æ­æ´²',
      
      // åŒ—ç¾æ´²
      'ç¾åœ‹': 'åŒ—ç¾æ´²', 'Canada': 'åŒ—ç¾æ´²', 'å¢¨è¥¿å“¥': 'åŒ—ç¾æ´²', 'å¤å·´': 'åŒ—ç¾æ´²',
      'ç‰™è²·åŠ ': 'åŒ—ç¾æ´²', 'å·´å“ˆé¦¬': 'åŒ—ç¾æ´²', 'å¤šæ˜å°¼åŠ ': 'åŒ—ç¾æ´²', 'æµ·åœ°': 'åŒ—ç¾æ´²',
      'ç“œåœ°é¦¬æ‹‰': 'åŒ—ç¾æ´²', 'è²é‡Œæ–¯': 'åŒ—ç¾æ´²', 'è–©çˆ¾ç“¦å¤š': 'åŒ—ç¾æ´²', 'å®éƒ½æ‹‰æ–¯': 'åŒ—ç¾æ´²',
      'å°¼åŠ æ‹‰ç“œ': 'åŒ—ç¾æ´²', 'å“¥æ–¯å¤§é»åŠ ': 'åŒ—ç¾æ´²', 'å·´æ‹¿é¦¬': 'åŒ—ç¾æ´²',
      
      // åŒ—ç¾æ´²è‹±æ–‡åç¨±
      'United States': 'åŒ—ç¾æ´²', 'USA': 'åŒ—ç¾æ´²', 'US': 'åŒ—ç¾æ´²', 'America': 'åŒ—ç¾æ´²',
      'Mexico': 'åŒ—ç¾æ´²', 'Cuba': 'åŒ—ç¾æ´²', 'Jamaica': 'åŒ—ç¾æ´²', 'Bahamas': 'åŒ—ç¾æ´²',
      'Dominican Republic': 'åŒ—ç¾æ´²', 'Haiti': 'åŒ—ç¾æ´²', 'Guatemala': 'åŒ—ç¾æ´²', 'Belize': 'åŒ—ç¾æ´²',
      'El Salvador': 'åŒ—ç¾æ´²', 'Honduras': 'åŒ—ç¾æ´²', 'Nicaragua': 'åŒ—ç¾æ´²', 'Costa Rica': 'åŒ—ç¾æ´²',
      'Panama': 'åŒ—ç¾æ´²',
      
      // å—ç¾æ´²
      'å·´è¥¿': 'å—ç¾æ´²', 'é˜¿æ ¹å»·': 'å—ç¾æ´²', 'æ™ºåˆ©': 'å—ç¾æ´²', 'ç§˜é­¯': 'å—ç¾æ´²',
      'å“¥å€«æ¯”äº': 'å—ç¾æ´²', 'å§”å…§ç‘æ‹‰': 'å—ç¾æ´²', 'å„ç“œå¤š': 'å—ç¾æ´²', 'ç»åˆ©ç¶­äº': 'å—ç¾æ´²',
      'å·´æ‹‰åœ­': 'å—ç¾æ´²', 'çƒæ‹‰åœ­': 'å—ç¾æ´²', 'è“‹äºé‚£': 'å—ç¾æ´²', 'è˜‡åˆ©å—': 'å—ç¾æ´²',
      
      // å—ç¾æ´²è‹±æ–‡åç¨±
      'Brazil': 'å—ç¾æ´²', 'Argentina': 'å—ç¾æ´²', 'Chile': 'å—ç¾æ´²', 'Peru': 'å—ç¾æ´²',
      'Colombia': 'å—ç¾æ´²', 'Venezuela': 'å—ç¾æ´²', 'Ecuador': 'å—ç¾æ´²', 'Bolivia': 'å—ç¾æ´²',
      'Paraguay': 'å—ç¾æ´²', 'Uruguay': 'å—ç¾æ´²', 'Guyana': 'å—ç¾æ´²', 'Suriname': 'å—ç¾æ´²',
      
      // éæ´²
      'åŸƒåŠ': 'éæ´²', 'å—é': 'éæ´²', 'æ‘©æ´›å“¥': 'éæ´²', 'é˜¿çˆ¾åŠåˆ©äº': 'éæ´²',
      'çªå°¼è¥¿äº': 'éæ´²', 'åˆ©æ¯”äº': 'éæ´²', 'è˜‡ä¸¹': 'éæ´²', 'è¡£ç´¢æ¯”äº': 'éæ´²',
      'è‚¯äº': 'éæ´²', 'å¦å°šå°¼äº': 'éæ´²', 'çƒå¹²é”': 'éæ´²', 'ç›§å®‰é”': 'éæ´²',
      'è¿¦ç´': 'éæ´²', 'å¥ˆåŠåˆ©äº': 'éæ´²', 'å¡å…§åŠ çˆ¾': 'éæ´²', 'é¦¬åˆ©': 'éæ´²',
      'å¸ƒå‰ç´æ³•ç´¢': 'éæ´²', 'å°¼æ—¥': 'éæ´²', 'æŸ¥å¾·': 'éæ´²', 'ä¸­é': 'éæ´²',
      'å–€éº¥éš†': 'éæ´²', 'å‰›æœ': 'éæ´²', 'å‰›æœæ°‘ä¸»å…±å’Œåœ‹': 'éæ´²', 'åŠ å½­': 'éæ´²',
      'èµ¤é“å¹¾å…§äº': 'éæ´²', 'è–å¤šç¾æ™®æ—è¥¿æ¯”': 'éæ´²', 'å®‰å“¥æ‹‰': 'éæ´²', 'å°šæ¯”äº': 'éæ´²',
      'è¾›å·´å¨': 'éæ´²', 'æ³¢æœ­é‚£': 'éæ´²', 'ç´ç±³æ¯”äº': 'éæ´²', 'é¦¬é”åŠ æ–¯åŠ ': 'éæ´²',
      'æ¨¡é‡Œè¥¿æ–¯': 'éæ´²', 'å¡å¸­çˆ¾': 'éæ´²', 'è‘›æ‘©': 'éæ´²', 'å‰å¸ƒåœ°': 'éæ´²',
      'ç´¢é¦¬åˆ©äº': 'éæ´²', 'å„åˆ©å‚äº': 'éæ´²', 'é¦¬æ‹‰å¨': 'éæ´²', 'è«ä¸‰æ¯”å…‹': 'éæ´²',
      'è³´ç´¢æ‰˜': 'éæ´²', 'å²ç“¦å¸å°¼': 'éæ´²',
      
      // å¤§æ´‹æ´²
      'æ¾³æ´²': 'å¤§æ´‹æ´²', 'ç´è¥¿è˜­': 'å¤§æ´‹æ´²', 'æ–æ¿Ÿ': 'å¤§æ´‹æ´²', 'å·´å¸ƒäºç´å¹¾å…§äº': 'å¤§æ´‹æ´²',
      'ç´¢ç¾…é–€ç¾¤å³¶': 'å¤§æ´‹æ´²', 'è¬é‚£æœ': 'å¤§æ´‹æ´²', 'æ–°å–€é‡Œå¤šå°¼äº': 'å¤§æ´‹æ´²',
      'è–©æ‘©äº': 'å¤§æ´‹æ´²', 'æ±åŠ ': 'å¤§æ´‹æ´²', 'å‰é‡Œå·´æ–¯': 'å¤§æ´‹æ´²', 'åç“¦é­¯': 'å¤§æ´‹æ´²',
      'è«¾é­¯': 'å¤§æ´‹æ´²', 'å¸›ç‰': 'å¤§æ´‹æ´²', 'å¯†å…‹ç¾…å°¼è¥¿äº': 'å¤§æ´‹æ´²', 'é¦¬ç´¹çˆ¾ç¾¤å³¶': 'å¤§æ´‹æ´²',
      
      // å¤§æ´‹æ´²è‹±æ–‡åç¨±
      'Australia': 'å¤§æ´‹æ´²', 'New Zealand': 'å¤§æ´‹æ´²', 'Fiji': 'å¤§æ´‹æ´²', 'Papua New Guinea': 'å¤§æ´‹æ´²',
      'Solomon Islands': 'å¤§æ´‹æ´²', 'Vanuatu': 'å¤§æ´‹æ´²', 'New Caledonia': 'å¤§æ´‹æ´²',
      'Samoa': 'å¤§æ´‹æ´²', 'Tonga': 'å¤§æ´‹æ´²', 'Kiribati': 'å¤§æ´‹æ´²', 'Tuvalu': 'å¤§æ´‹æ´²',
      'Nauru': 'å¤§æ´‹æ´²', 'Palau': 'å¤§æ´‹æ´²', 'Micronesia': 'å¤§æ´‹æ´²', 'Marshall Islands': 'å¤§æ´‹æ´²'
    };

    // å¾æ–‡å­—ä¸­æå–åœ‹å®¶/åœ°å€åç¨±
    function extractCountryFromText(text) {
      if (!text) return null;
      
      const lowerText = text.toLowerCase();
      const countries = Object.keys(countryToContinent);
      
      for (const country of countries) {
        if (lowerText.includes(country.toLowerCase())) {
          return country;
        }
      }
      return null;
    }

    // è‡ªå‹•åˆ†é¡åˆ°æ´²
    function autoClassifyContinent(title, description) {
      const text = (title + ' ' + description).toLowerCase();
      const country = extractCountryFromText(text);
      
      if (country) {
        return countryToContinent[country];
      }
      
      // å¦‚æœæ²’æœ‰æ‰¾åˆ°å…·é«”åœ‹å®¶ï¼Œä½¿ç”¨é—œéµå­—åˆ¤æ–·
      if (text.includes('äºæ´²') || text.includes('æ±äº') || text.includes('æ±å—äº') || 
          text.includes('æ±åŒ—äº') || text.includes('ä¸­äº') || text.includes('è¥¿äº')) {
        return 'äºæ´²';
      }
      if (text.includes('æ­æ´²') || text.includes('æ­ç›Ÿ') || text.includes('æ­é™¸')) {
        return 'æ­æ´²';
      }
      if (text.includes('ç¾æ´²') || text.includes('åŒ—ç¾') || text.includes('ç¾åœ‹') || 
          text.includes('åŠ æ‹¿å¤§') || text.includes('å¢¨è¥¿å“¥')) {
        return 'åŒ—ç¾æ´²';
      }
      if (text.includes('å—ç¾') || text.includes('æ‹‰ä¸ç¾æ´²') || text.includes('å·´è¥¿') || 
          text.includes('é˜¿æ ¹å»·') || text.includes('æ™ºåˆ©')) {
        return 'å—ç¾æ´²';
      }
      if (text.includes('éæ´²') || text.includes('é»‘éæ´²')) {
        return 'éæ´²';
      }
      if (text.includes('å¤§æ´‹æ´²') || text.includes('æ¾³æ´²') || text.includes('ç´è¥¿è˜­') || 
          text.includes('å¤ªå¹³æ´‹')) {
        return 'å¤§æ´‹æ´²';
      }
      
      return 'äºæ´²'; // é è¨­ç‚ºäºæ´²
    }

    // æ¸…ç† YouTube æè¿°
    function cleanYouTubeDescription(description) {
      if (!description) return '';
      
      let cleaned = description;
      
      // ç§»é™¤å¸¸è¦‹çš„ YouTube è‡ªå‹•ç”Ÿæˆçš„å…§å®¹
      const patternsToRemove = [
        // ç§»é™¤è§€çœ‹æ¬¡æ•¸å’Œæ—¥æœŸ
        /è§€çœ‹æ¬¡æ•¸:\d+æ¬¡\s*\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥/g,
        // ç§»é™¤æ™‚é–“æˆ³è¨˜
        /\d{1,2}:\d{2}(?::\d{2})?\s*[-\u2013\u2014]\s*/g,
        // ç§»é™¤å¸¸è¦‹çš„ YouTube æ¨™ç±¤
        /#\w+/g,
        // ç§»é™¤éå¤šçš„æ›è¡Œç¬¦è™Ÿ
        /\n{3,}/g,
        // ç§»é™¤å¸¸è¦‹çš„ç¤¾äº¤åª’é«”é€£çµ
        /(?:Facebook|Twitter|Instagram|TikTok|å¾®åš|å¾®ä¿¡):\s*https?:\/\/[^\s]+/gi,
        // ç§»é™¤å¸¸è¦‹çš„è¨‚é–±æé†’
        /(?:è¨‚é–±|Subscribe|æŒ‰è®š|Like|åˆ†äº«|Share|é€šçŸ¥|Notification)[\s\S]*?(?=\n\n|\n$|$)/gi,
        // ç§»é™¤å¸¸è¦‹çš„ç‰ˆæ¬Šè²æ˜
        /(?:ç‰ˆæ¬Š|Copyright|All rights reserved)[\s\S]*?(?=\n\n|\n$|$)/gi,
        // ç§»é™¤å¸¸è¦‹çš„å…è²¬è²æ˜
        /(?:å…è²¬è²æ˜|Disclaimer)[\s\S]*?(?=\n\n|\n$|$)/gi,
        // ç§»é™¤ URL é€£çµ
        /https?:\/\/[^\s]+/g,
        // ç§»é™¤èˆªå‘ä¸–ç•Œæ—…éŠå°ç­‰å“ç‰Œè³‡è¨Š
        /èˆªå‘ä¸–ç•Œæ—…éŠå°[\s\S]*?(?=\n\n|\n$|$)/gi
      ];
      
      patternsToRemove.forEach(pattern => {
        cleaned = cleaned.replace(pattern, '');
      });
      
      // æ¸…ç†å¤šé¤˜çš„ç©ºç™½å’Œæ›è¡Œ
      cleaned = cleaned
        .replace(/\n\s*\n/g, '\n\n')  // å°‡å¤šå€‹æ›è¡Œåˆä½µç‚ºæœ€å¤šå…©å€‹
        .replace(/^\s+|\s+$/g, '')    // ç§»é™¤é¦–å°¾ç©ºç™½
        .replace(/[ \t]+/g, ' ')      // å°‡å¤šå€‹ç©ºæ ¼åˆä½µç‚ºä¸€å€‹
        .trim();
      
      // å¦‚æœæ¸…ç†å¾Œå¤ªçŸ­ï¼Œè¿”å›åŸå§‹æè¿°
      if (cleaned.length < 20) {
        return description;
      }
      
      return cleaned;
    }


    // å¾ HTML ä¸­æå– YouTube æè¿°
    function extractDescriptionFromHTML(html) {
      try {
        console.log('é–‹å§‹è§£æ HTML å…§å®¹...');
        console.log('HTML å…§å®¹é•·åº¦:', html.length);
        console.log('HTML å…§å®¹é è¦½:', html.substring(0, 500));
        
        // å‰µå»ºä¸€å€‹è‡¨æ™‚çš„ DOM å…ƒç´ ä¾†è§£æ HTML
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // æ–¹æ³•1ï¼šå˜—è©¦å¾ meta æ¨™ç±¤æå–
        const metaSelectors = [
          'meta[name="description"]',
          'meta[property="og:description"]',
          'meta[name="twitter:description"]'
        ];
        
        for (const selector of metaSelectors) {
          const element = doc.querySelector(selector);
          if (element) {
            const content = element.getAttribute('content');
            if (content && content.length > 50) {
              console.log('å¾ meta æ¨™ç±¤æ‰¾åˆ°æè¿°:', content.substring(0, 100) + '...');
              return content.trim();
            }
          }
        }
        
        // æ–¹æ³•2ï¼šå˜—è©¦å¾ JSON-LD çµæ§‹åŒ–æ•¸æ“šä¸­æå–
        const jsonLdScripts = doc.querySelectorAll('script[type="application/ld+json"]');
        for (const script of jsonLdScripts) {
          try {
            const jsonData = JSON.parse(script.textContent);
            if (jsonData.description && jsonData.description.length > 50) {
              console.log('å¾ JSON-LD æ‰¾åˆ°æè¿°:', jsonData.description.substring(0, 100) + '...');
              return jsonData.description.trim();
            }
          } catch (e) {
            // å¿½ç•¥ JSON è§£æéŒ¯èª¤
          }
        }
        
        // æ–¹æ³•3ï¼šå˜—è©¦å¾ YouTube ç‰¹å®šçš„å…ƒç´ ä¸­æå–
        const youtubeSelectors = [
          '#description',
          '.content-description',
          '[data-description]',
          '.ytd-video-secondary-info-renderer',
          '#description-text',
          '.ytd-expander'
        ];
        
        for (const selector of youtubeSelectors) {
          const element = doc.querySelector(selector);
          if (element) {
            const content = element.textContent || element.innerText;
            if (content && content.length > 50) {
              console.log('å¾ YouTube å…ƒç´ æ‰¾åˆ°æè¿°:', content.substring(0, 100) + '...');
              return content.trim();
            }
          }
        }
        
        // æ–¹æ³•4ï¼šå¾é é¢æ–‡æœ¬ä¸­æ™ºèƒ½æå–
        const bodyText = doc.body ? doc.body.textContent : '';
        if (bodyText) {
          console.log('é–‹å§‹å¾é é¢æ–‡æœ¬ä¸­æå–...');
          
          // å°‹æ‰¾åŒ…å«ã€Œè§€çœ‹æ¬¡æ•¸ã€çš„æ®µè½ï¼Œç„¶å¾Œæå–å¾ŒçºŒçš„æè¿°
          const lines = bodyText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
          
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            
            // å°‹æ‰¾ã€Œè§€çœ‹æ¬¡æ•¸ã€æ¨™é¡Œï¼ˆæ”¯æ´ä¸­è‹±æ–‡ï¼‰
            if (line.includes('è§€çœ‹æ¬¡æ•¸') || line.includes('Views') || line.includes('æ¬¡') || 
                line.includes('views') || line.includes('view')) {
              console.log('æ‰¾åˆ°è§€çœ‹æ¬¡æ•¸è¡Œ:', line);
              
              // æå–å¾ŒçºŒçš„å…§å®¹
              let description = '';
              let foundContent = false;
              let paragraphCount = 0;
              
              for (let j = i + 1; j < Math.min(i + 50, lines.length); j++) {
                const contentLine = lines[j];
                
                // å¦‚æœé‡åˆ°ä¸‹ä¸€å€‹æ¨™é¡Œæˆ–æŒ‰éˆ•ï¼Œåœæ­¢æå–
                if (contentLine.includes('è¨‚é–±') || contentLine.includes('åˆ†äº«') || 
                    contentLine.includes('å„²å­˜') || contentLine.includes('Subscribe') ||
                    contentLine.includes('Share') || contentLine.includes('Save') ||
                    contentLine.includes('ç¸®åœ–') || contentLine.includes('æ’­æ”¾æ¸…å–®') || 
                    contentLine.includes('è³‡è¨Šå¡') || contentLine.includes('Thumbnail') ||
                    contentLine.includes('Playlist') || contentLine.includes('Info Cards') ||
                    contentLine.includes('Watch more') || contentLine.includes('Question for you') ||
                    contentLine.includes('Welcome to') || contentLine.includes('âœ¨')) {
                  break;
                }
                
                // å¦‚æœé€™è¡Œæœ‰å¯¦è³ªå…§å®¹ï¼ŒåŠ å…¥æè¿°
                if (contentLine.length > 20 && !contentLine.match(/^[#@\s]*$/)) {
                  // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„æè¿°æ®µè½
                  if (isValidDescriptionParagraph(contentLine)) {
                    description += contentLine + '\n';
                    foundContent = true;
                    paragraphCount++;
                    console.log('æ‰¾åˆ°æœ‰æ•ˆæ®µè½:', contentLine.substring(0, 50) + '...');
                  }
                }
              }
              
              if (foundContent && description.length > 50) {
                console.log('æˆåŠŸæå–æè¿°:', description.substring(0, 100) + '...');
                return description.trim();
              }
            }
          }
          
          // å¦‚æœæ²’æœ‰æ‰¾åˆ°ã€Œè§€çœ‹æ¬¡æ•¸ã€ï¼Œå˜—è©¦å°‹æ‰¾å…¶ä»–æ¨™è­˜
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            
            // å°‹æ‰¾åŒ…å«ã€Œåœ¨åŠ æ‹¿å¤§çš„å£¯éº—åŒ—åœ‹ã€çš„æ®µè½
            if (line.includes('åœ¨åŠ æ‹¿å¤§çš„å£¯éº—åŒ—åœ‹') || line.includes('åœ¨') && line.includes('çš„') && line.includes('ï¼Œ')) {
              console.log('æ‰¾åˆ°æè¿°é–‹å§‹è¡Œ:', line);
              
              // æå–å¾ŒçºŒçš„å…§å®¹
              let description = '';
              let foundContent = false;
              let paragraphCount = 0;
              
              for (let j = i; j < Math.min(i + 20, lines.length); j++) {
                const contentLine = lines[j];
                
                // å¦‚æœé‡åˆ°ä¸‹ä¸€å€‹æ¨™é¡Œæˆ–æŒ‰éˆ•ï¼Œåœæ­¢æå–
                if (contentLine.includes('è¨‚é–±') || contentLine.includes('åˆ†äº«') || 
                    contentLine.includes('å„²å­˜') || contentLine.includes('Subscribe') ||
                    contentLine.includes('Share') || contentLine.includes('Save')) {
                  break;
                }
                
                // å¦‚æœé€™è¡Œæœ‰å¯¦è³ªå…§å®¹ï¼ŒåŠ å…¥æè¿°
                if (contentLine.length > 20 && !contentLine.match(/^[#@\s]*$/)) {
                  if (isValidDescriptionParagraph(contentLine)) {
                    description += contentLine + '\n';
                    foundContent = true;
                    paragraphCount++;
                  }
                }
              }
              
              if (foundContent && description.length > 100 && paragraphCount >= 2) {
                console.log('æˆåŠŸæå–æè¿°:', description.substring(0, 100) + '...');
                return description.trim();
              }
            }
          }
        }
        
        // æ–¹æ³•5ï¼šå˜—è©¦å¾ YouTube çš„å…§åµŒæ•¸æ“šä¸­æå–
        const scripts = doc.querySelectorAll('script');
        for (const script of scripts) {
          const scriptContent = script.textContent;
          if (scriptContent && scriptContent.includes('description')) {
            // å°‹æ‰¾ JSON æ ¼å¼çš„æè¿°æ•¸æ“š
            const descriptionMatch = scriptContent.match(/"description":\s*"([^"]+)"/);
            if (descriptionMatch && descriptionMatch[1].length > 50) {
              console.log('å¾è…³æœ¬ä¸­æ‰¾åˆ°æè¿°:', descriptionMatch[1].substring(0, 100) + '...');
              return descriptionMatch[1].trim();
            }
          }
        }
        
        // æ–¹æ³•6ï¼šå˜—è©¦å¾ YouTube çš„ ytInitialData ä¸­æå–
        for (const script of scripts) {
          const scriptContent = script.textContent;
          if (scriptContent && scriptContent.includes('ytInitialData')) {
            try {
              // å°‹æ‰¾ ytInitialData è®Šæ•¸
              const ytDataMatch = scriptContent.match(/var ytInitialData = ({.+?});/);
              if (ytDataMatch) {
                const ytData = JSON.parse(ytDataMatch[1]);
                console.log('æ‰¾åˆ° ytInitialDataï¼Œé–‹å§‹è§£æ...');
                
                // éæ­¸æœç´¢æè¿°
                const description = findDescriptionInYtData(ytData);
                if (description && description.length > 50) {
                  console.log('å¾ ytInitialData ä¸­æ‰¾åˆ°æè¿°:', description.substring(0, 100) + '...');
                  return description.trim();
                }
              }
            } catch (e) {
              console.log('è§£æ ytInitialData å¤±æ•—:', e);
            }
          }
        }
        
        // æ–¹æ³•7ï¼šç›´æ¥å¾ HTML æ–‡æœ¬ä¸­å°‹æ‰¾æè¿°æ¨¡å¼
        console.log('å˜—è©¦ç›´æ¥å¾ HTML æ–‡æœ¬ä¸­æå–...');
        
        // å°‹æ‰¾åŒ…å« "Join us" æˆ–é¡ä¼¼é–‹é ­çš„æ®µè½
        const descriptionPatterns = [
          /Join us on a scenic road trip[^<]*/gi,
          /Join us[^<]*/gi,
          /Welcome to[^<]*/gi,
          /In this video[^<]*/gi,
          /This journey[^<]*/gi,
          /Experience[^<]*/gi,
          /Discover[^<]*/gi,
          /Explore[^<]*/gi
        ];
        
        for (const pattern of descriptionPatterns) {
          const match = html.match(pattern);
          if (match && match[0].length > 50) {
            let description = match[0];
            // æ¸…ç† HTML æ¨™ç±¤
            description = description.replace(/<[^>]*>/g, '');
            // æ¸…ç†å¤šé¤˜çš„ç©ºç™½
            description = description.replace(/\s+/g, ' ').trim();
            
            if (description.length > 50) {
              console.log('å¾ HTML æ–‡æœ¬æ¨¡å¼æ‰¾åˆ°æè¿°:', description.substring(0, 100) + '...');
              return description;
            }
          }
        }
        
        // æ–¹æ³•8ï¼šå°‹æ‰¾åŒ…å«æ—…éŠé—œéµè©çš„é•·æ®µè½
        const travelPatterns = [
          /Switzerland[^<]{50,500}/gi,
          /Italy[^<]{50,500}/gi,
          /travel[^<]{50,500}/gi,
          /journey[^<]{50,500}/gi,
          /adventure[^<]{50,500}/gi,
          /scenic[^<]{50,500}/gi,
          /beautiful[^<]{50,500}/gi,
          /breathtaking[^<]{50,500}/gi
        ];
        
        for (const pattern of travelPatterns) {
          const match = html.match(pattern);
          if (match && match[0].length > 100) {
            let description = match[0];
            // æ¸…ç† HTML æ¨™ç±¤
            description = description.replace(/<[^>]*>/g, '');
            // æ¸…ç†å¤šé¤˜çš„ç©ºç™½
            description = description.replace(/\s+/g, ' ').trim();
            
            if (description.length > 100) {
              console.log('å¾æ—…éŠé—œéµè©æ¨¡å¼æ‰¾åˆ°æè¿°:', description.substring(0, 100) + '...');
              return description;
            }
          }
        }
        
        console.log('æœªèƒ½æ‰¾åˆ°æœ‰æ•ˆçš„æè¿°å…§å®¹');
        return null;
        
      } catch (error) {
        console.error('HTML è§£æéŒ¯èª¤:', error);
        return null;
      }
    }

    // éæ­¸æœç´¢ YouTube æ•¸æ“šä¸­çš„æè¿°
    function findDescriptionInYtData(obj, depth = 0) {
      if (depth > 10) return null; // é˜²æ­¢ç„¡é™éæ­¸
      
      if (typeof obj === 'string' && obj.length > 100) {
        // æª¢æŸ¥æ˜¯å¦åŒ…å«ä¸­æ–‡æè¿°å…§å®¹ - æ›´ç²¾ç¢ºçš„åŒ¹é…
        if (isChineseDescription(obj)) {
          return obj;
        }
      }
      
      if (typeof obj === 'object' && obj !== null) {
        // æª¢æŸ¥æ˜¯å¦æœ‰ description å±¬æ€§
        if (obj.description && typeof obj.description === 'string' && obj.description.length > 100) {
          if (isChineseDescription(obj.description)) {
            return obj.description;
          }
        }
        
        // éæ­¸æœç´¢æ‰€æœ‰å±¬æ€§
        for (const key in obj) {
          if (obj.hasOwnProperty(key)) {
            const result = findDescriptionInYtData(obj[key], depth + 1);
            if (result) return result;
          }
        }
      }
      
      return null;
    }

    // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„æè¿°æ®µè½
    function isValidDescriptionParagraph(text) {
      if (!text || text.length < 20) return false;
      
      // æª¢æŸ¥æ˜¯å¦åŒ…å«æ—…éŠç›¸é—œçš„é—œéµè©ï¼ˆä¸­æ–‡ï¼‰
      const chineseTravelKeywords = [
        'å£¯éº—', 'åŒ—åœ‹', 'å¤¢å¹»', 'ä¹‹æ—…', 'æ²³é¢', 'éŠ€ç™½', 'æ¥µå…‰', 'é›ªåœ°', 'æ¢éšª',
        'æ¸…æ¾ˆ', 'å¥”é¨°', 'å€’æ˜ ', 'å¤©ç©º', 'åŸå§‹', 'æ£®æ—', 'å¤§è‡ªç„¶', 'ç´”ç²¹', 'åŠ›é‡', 'éœè¬',
        'å±±è„ˆ', 'å°é®', 'é¢¨æƒ…', 'ç«¥è©±', 'é›ªæ™¯', 'ç’°æŠ±', 'è³¼ç‰©', 'ç¾é£Ÿ', 'å¤©å ‚',
        'å·¥è—å“', 'æ¥“ç³–æ¼¿', 'æœé£¾', 'é©šå–œ', 'é¡é ­', 'æ„Ÿå—', 'éœè¬', 'ç£…ç¤´', 'ç†±é¬§', 'ç¹½ç´›', 'è¿·äºº', 'é¢è²Œ',
        'åŠ æ‹¿å¤§', 'é»ƒåˆ€é®', 'å¼“æ²³', 'æ´›ç£¯å±±è„ˆ', 'ç­å¤«', 'å†¬å­£', 'å¤å­£', 'æ¢éšª', 'æ¬£è³'
      ];
      
      // æª¢æŸ¥æ˜¯å¦åŒ…å«æ—…éŠç›¸é—œçš„é—œéµè©ï¼ˆè‹±æ–‡ï¼‰
      const englishTravelKeywords = [
        'travel', 'journey', 'trip', 'adventure', 'explore', 'visit', 'destination',
        'scenic', 'beautiful', 'amazing', 'stunning', 'breathtaking', 'landscape',
        'countryside', 'mountain', 'lake', 'river', 'city', 'town', 'village',
        'culture', 'history', 'nature', 'wildlife', 'experience', 'discover',
        'road trip', 'hiking', 'sightseeing', 'photography', 'video', 'vlog',
        'Switzerland', 'Zurich', 'Thun', 'Alps', 'Swiss', 'Europe', 'Italy',
        'France', 'Germany', 'Spain', 'Japan', 'Korea', 'Thailand', 'Vietnam'
      ];
      
      // æª¢æŸ¥æ˜¯å¦åŒ…å«ä¸­æ–‡æ¨™é»ç¬¦è™Ÿ
      const hasChinesePunctuation = /[ï¼Œã€‚ï¼›ï¼šï¼ï¼Ÿ]/.test(text);
      
      // æª¢æŸ¥æ˜¯å¦åŒ…å«è‹±æ–‡æ¨™é»ç¬¦è™Ÿ
      const hasEnglishPunctuation = /[.,;:!?]/.test(text);
      
      // è¨ˆç®—åŒ¹é…çš„ä¸­æ–‡é—œéµè©æ•¸é‡
      let chineseKeywordCount = 0;
      for (const keyword of chineseTravelKeywords) {
        if (text.includes(keyword)) {
          chineseKeywordCount++;
        }
      }
      
      // è¨ˆç®—åŒ¹é…çš„è‹±æ–‡é—œéµè©æ•¸é‡
      let englishKeywordCount = 0;
      for (const keyword of englishTravelKeywords) {
        if (text.toLowerCase().includes(keyword.toLowerCase())) {
          englishKeywordCount++;
        }
      }
      
      // æª¢æŸ¥æ˜¯å¦ç‚ºè‹±æ–‡å…§å®¹
      const isEnglishContent = /[a-zA-Z]/.test(text) && englishKeywordCount >= 2;
      
      // æª¢æŸ¥æ˜¯å¦ç‚ºä¸­æ–‡å…§å®¹
      const isChineseContent = /[\u4e00-\u9fff]/.test(text) && chineseKeywordCount >= 2 && hasChinesePunctuation;
      
      // å¦‚æœåŒ…å«è¶³å¤ çš„é—œéµè©å’Œæ¨™é»ç¬¦è™Ÿï¼Œèªç‚ºæ˜¯æœ‰æ•ˆçš„æè¿°æ®µè½
      return isEnglishContent || isChineseContent;
    }

    // æª¢æŸ¥æ˜¯å¦ç‚ºä¸­æ–‡æè¿°å…§å®¹
    function isChineseDescription(text) {
      if (!text || text.length < 50) return false;
      
      // æª¢æŸ¥æ˜¯å¦åŒ…å«ä¸­æ–‡æ¨™é»ç¬¦è™Ÿå’Œå¸¸è¦‹è©å½™
      const chinesePatterns = [
        /åœ¨.*çš„.*ï¼Œ/,  // "åœ¨...çš„...ï¼Œ"
        /é€™è£¡.*æ˜¯/,    // "é€™è£¡...æ˜¯"
        /è€Œ.*æ‚¨å°‡/,    // "è€Œ...æ‚¨å°‡"
        /å¾.*åˆ°/,      // "å¾...åˆ°"
        /è·Ÿéš¨.*ä¸€èµ·/,  // "è·Ÿéš¨...ä¸€èµ·"
        /ç™¼ç¾.*çš„/,    // "ç™¼ç¾...çš„"
        /ï¼Œ.*ï¼Œ.*ã€‚/   // ä¸­æ–‡æ¨™é»ç¬¦è™Ÿæ¨¡å¼
      ];
      
      // æª¢æŸ¥æ˜¯å¦åŒ…å«æ—…éŠç›¸é—œè©å½™
      const travelKeywords = [
        'å£¯éº—', 'åŒ—åœ‹', 'å¤¢å¹»', 'ä¹‹æ—…', 'æ²³é¢', 'éŠ€ç™½', 'æ¥µå…‰', 'é›ªåœ°', 'æ¢éšª',
        'æ¸…æ¾ˆ', 'å¥”é¨°', 'å€’æ˜ ', 'å¤©ç©º', 'åŸå§‹', 'æ£®æ—', 'å¤§è‡ªç„¶', 'ç´”ç²¹', 'åŠ›é‡', 'éœè¬',
        'å±±è„ˆ', 'å°é®', 'é¢¨æƒ…', 'ç«¥è©±', 'é›ªæ™¯', 'ç’°æŠ±', 'è³¼ç‰©', 'ç¾é£Ÿ', 'å¤©å ‚',
        'å·¥è—å“', 'æ¥“ç³–æ¼¿', 'æœé£¾', 'é©šå–œ', 'é¡é ­', 'æ„Ÿå—', 'éœè¬', 'ç£…ç¤´', 'ç†±é¬§', 'ç¹½ç´›', 'è¿·äºº', 'é¢è²Œ'
      ];
      
      // è¨ˆç®—åŒ¹é…çš„é—œéµè©æ•¸é‡
      let keywordCount = 0;
      for (const keyword of travelKeywords) {
        if (text.includes(keyword)) {
          keywordCount++;
        }
      }
      
      // æª¢æŸ¥ä¸­æ–‡æ¨™é»ç¬¦è™Ÿæ¨¡å¼
      let patternCount = 0;
      for (const pattern of chinesePatterns) {
        if (pattern.test(text)) {
          patternCount++;
        }
      }
      
      // å¦‚æœåŒ…å«è¶³å¤ çš„é—œéµè©å’Œæ¨¡å¼ï¼Œèªç‚ºæ˜¯æœ‰æ•ˆçš„ä¸­æ–‡æè¿°
      return keywordCount >= 3 && patternCount >= 1;
    }

    // é–‹å•Ÿ YouTube é é¢
    function openYouTubePage() {
      const youtubeId = document.getElementById('youtubeId').value.trim();
      if (!youtubeId) {
        showStatus('è«‹å…ˆè¼¸å…¥ YouTube ID', 'warning');
        return;
      }
      
      const youtubeUrl = `https://www.youtube.com/watch?v=${youtubeId}`;
      window.open(youtubeUrl, '_blank');
      
      showStatus('å·²é–‹å•Ÿ YouTube é é¢ï¼Œè«‹è¤‡è£½ã€Œèªªæ˜ã€å€å¡Šçš„å…§å®¹ï¼Œç„¶å¾Œé»æ“Šã€ŒğŸ“‹ è²¼ä¸Šå‰ªè²¼ç°¿å…§å®¹ã€', 'info');
    }

    // è‡ªå‹•æ“·å– YouTube æè¿°
    async function autoExtractDescription() {
      try {
        const youtubeId = document.getElementById('youtubeId').value.trim();
        
        if (!youtubeId) {
          showStatus('è«‹å…ˆè¼¸å…¥ YouTube ID', 'warning');
          return;
        }
        
        showStatus('ğŸ¤– æ­£åœ¨è‡ªå‹•æ“·å– YouTube æè¿°...', 'info');
        
        // ä½¿ç”¨æ›´å¯é çš„ä»£ç†æœå‹™å˜—è©¦æ“·å–
        const proxies = [
          `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(`https://www.youtube.com/watch?v=${youtubeId}`)}`,
          `https://thingproxy.freeboard.io/fetch/https://www.youtube.com/watch?v=${youtubeId}`,
          `https://corsproxy.io/?${encodeURIComponent(`https://www.youtube.com/watch?v=${youtubeId}`)}`
        ];
        
        let description = null;
        
        for (let i = 0; i < proxies.length; i++) {
          try {
            console.log(`ğŸ”„ å˜—è©¦ä»£ç†æœå‹™ ${i + 1}/${proxies.length}...`);
            showStatus(`ğŸ¤– æ­£åœ¨å˜—è©¦æ“·å–... (${i + 1}/${proxies.length})`, 'info');
            
            const response = await fetch(proxies[i]);
            const data = await response.text();
            
            // å˜—è©¦å¾ HTML ä¸­æå–æè¿°
            const descriptionMatch = data.match(/<meta name="description" content="([^"]+)"/);
            if (descriptionMatch) {
              description = descriptionMatch[1];
              console.log('âœ… æˆåŠŸæ“·å–æè¿°:', description);
              break;
            }
            
            // å˜—è©¦å…¶ä»–å¯èƒ½çš„æè¿°ä½ç½®
            const altDescriptionMatch = data.match(/"description":"([^"]+)"/);
            if (altDescriptionMatch) {
              description = altDescriptionMatch[1];
              console.log('âœ… æˆåŠŸæ“·å–æè¿° (å‚™ç”¨æ–¹æ³•):', description);
              break;
            }
            
          } catch (error) {
            console.log(`âŒ ä»£ç†æœå‹™ ${i + 1} å¤±æ•—:`, error.message);
            continue;
          }
        }
        
        if (description) {
          // è™•ç†æè¿°æ–‡å­—
          let processedDescription = description
            .replace(/&quot;/g, '"')
            .replace(/&amp;/g, '&')
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&nbsp;/g, ' ')
            .trim();
          
          // è‡ªå‹•æå–è§€çœ‹æ¬¡æ•¸ä¿¡æ¯
          const viewCountInfo = extractViewCountInfo(processedDescription);
          if (viewCountInfo) {
            const tagInfo = viewCountInfo.tag ? ` #${viewCountInfo.tag}` : '';
            showStatus(`âœ… è‡ªå‹•æ“·å–æˆåŠŸï¼è§€çœ‹æ¬¡æ•¸: ${viewCountInfo.viewCount} (${viewCountInfo.date})${tagInfo}`, 'success');
            
            // åœ¨é–‹é ­æ·»åŠ è§€çœ‹æ¬¡æ•¸ä¿¡æ¯
            const tagPrefix = viewCountInfo.tag ? ` #${viewCountInfo.tag}` : '';
            processedDescription = `ğŸ“Š ${viewCountInfo.viewCount} (${viewCountInfo.date})${tagPrefix}\n\n${processedDescription}`;
          } else {
            showStatus('âœ… è‡ªå‹•æ“·å–æˆåŠŸï¼', 'success');
          }
          
          // å¡«å…¥æè¿°æ¡†
          document.getElementById('description').value = processedDescription;
          
          // è‡ªå‹•åˆ†é¡
          const title = document.getElementById('title').value;
          const continent = autoClassifyContinent(title, processedDescription);
          document.getElementById('category').value = continent;
          
        } else {
          showStatus('âŒ ç„¡æ³•è‡ªå‹•æ“·å–æè¿°ï¼Œè«‹æ‰‹å‹•è¤‡è£½è²¼ä¸Š', 'error');
          console.log('âŒ æ‰€æœ‰ä»£ç†æœå‹™éƒ½å¤±æ•—äº†');
        }
        
      } catch (error) {
        console.error('è‡ªå‹•æ“·å–å¤±æ•—:', error);
        showStatus('âŒ è‡ªå‹•æ“·å–å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½è²¼ä¸Š', 'error');
      }
    }

    // æ¸¬è©¦è§€çœ‹æ¬¡æ•¸æå–åŠŸèƒ½
    function testViewCountExtraction() {
      const testText = "è§€çœ‹æ¬¡æ•¸:22æ¬¡ 2025å¹´9æœˆ22æ—¥\n\né€™æ˜¯ä¸€å€‹æ¸¬è©¦æè¿°...";
      console.log('ğŸ§ª æ¸¬è©¦è§€çœ‹æ¬¡æ•¸æå–åŠŸèƒ½');
      console.log('ğŸ§ª æ¸¬è©¦æ–‡æœ¬:', testText);
      const result = extractViewCountInfo(testText);
      console.log('ğŸ§ª æå–çµæœ:', result);
      return result;
    }

    // æå–è§€çœ‹æ¬¡æ•¸ä¿¡æ¯
    function extractViewCountInfo(text) {
      try {
        console.log('ğŸ” é–‹å§‹æå–è§€çœ‹æ¬¡æ•¸ï¼Œè¼¸å…¥æ–‡æœ¬:', text.substring(0, 100) + '...');
        
        // åŒ¹é…ä¸­æ–‡æ ¼å¼ï¼šè§€çœ‹æ¬¡æ•¸:22æ¬¡ 2025å¹´9æœˆ22æ—¥ï¼ˆå¯èƒ½åŒ…å«æ¨™ç±¤ï¼‰
        const chinesePattern = /è§€çœ‹æ¬¡æ•¸:(\d+)æ¬¡\s*(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥(?:\s*#\S+)?/;
        const chineseMatch = text.match(chinesePattern);
        console.log('ğŸ” ä¸­æ–‡æ ¼å¼åŒ¹é…çµæœ:', chineseMatch);
        
        if (chineseMatch) {
          const [, viewCount, year, month, day] = chineseMatch;
          
          // æå–æ¨™ç±¤ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          const tagMatch = chineseMatch[0].match(/#(\S+)/);
          const tag = tagMatch ? tagMatch[1] : null;
          
          return {
            viewCount: `${viewCount}æ¬¡`,
            date: `${year}å¹´${month}æœˆ${day}æ—¥`,
            tag: tag,
            fullText: chineseMatch[0],
            type: 'chinese'
          };
        }
        
        // åŒ¹é…è‹±æ–‡æ ¼å¼ï¼šViews: 22 September 22, 2025
        const englishPattern = /Views:\s*(\d+)\s*(\w+)\s*(\d{1,2}),\s*(\d{4})/i;
        const englishMatch = text.match(englishPattern);
        console.log('ğŸ” è‹±æ–‡æ ¼å¼åŒ¹é…çµæœ:', englishMatch);
        
        if (englishMatch) {
          const [, viewCount, month, day, year] = englishMatch;
          return {
            viewCount: `${viewCount} views`,
            date: `${month} ${day}, ${year}`,
            fullText: englishMatch[0],
            type: 'english'
          };
        }
        
        // åŒ¹é…ç°¡åŒ–æ ¼å¼ï¼šè§€çœ‹æ¬¡æ•¸:22æ¬¡
        const simplePattern = /è§€çœ‹æ¬¡æ•¸:(\d+)æ¬¡/;
        const simpleMatch = text.match(simplePattern);
        console.log('ğŸ” ç°¡åŒ–æ ¼å¼åŒ¹é…çµæœ:', simpleMatch);
        
        if (simpleMatch) {
          return {
            viewCount: `${simpleMatch[1]}æ¬¡`,
            date: 'æ—¥æœŸæœªæ‰¾åˆ°',
            fullText: simpleMatch[0],
            type: 'simple'
          };
        }
        
        console.log('âŒ æ²’æœ‰æ‰¾åˆ°ä»»ä½•è§€çœ‹æ¬¡æ•¸æ ¼å¼');
        return null;
      } catch (error) {
        console.error('æå–è§€çœ‹æ¬¡æ•¸å¤±æ•—:', error);
        return null;
      }
    }

    // å¾å‰ªè²¼ç°¿è²¼ä¸Šå…§å®¹
    async function pasteFromClipboard() {
      try {
        console.log('ğŸ“‹ é–‹å§‹å¾å‰ªè²¼ç°¿è®€å–å…§å®¹...');
        const text = await navigator.clipboard.readText();
        console.log('ğŸ“‹ å‰ªè²¼ç°¿å…§å®¹é•·åº¦:', text ? text.length : 0);
        console.log('ğŸ“‹ å‰ªè²¼ç°¿å…§å®¹é è¦½:', text ? text.substring(0, 200) + '...' : 'ç©º');
        
        if (text && text.trim()) {
          // æ¸…ç†å‰ªè²¼ç°¿å…§å®¹
          let cleanedText = text.trim();
          
          // è‡ªå‹•æå–è§€çœ‹æ¬¡æ•¸
          console.log('ğŸ” é–‹å§‹æå–è§€çœ‹æ¬¡æ•¸...');
          const viewCountInfo = extractViewCountInfo(cleanedText);
          if (viewCountInfo) {
            console.log('ğŸ“Š æå–åˆ°è§€çœ‹æ¬¡æ•¸ä¿¡æ¯:', viewCountInfo);
            const tagInfo = viewCountInfo.tag ? ` #${viewCountInfo.tag}` : '';
            showStatus(`âœ… è‡ªå‹•æå–è§€çœ‹æ¬¡æ•¸: ${viewCountInfo.viewCount} (${viewCountInfo.date})${tagInfo}`, 'success');
          } else {
            console.log('âŒ æ²’æœ‰æå–åˆ°è§€çœ‹æ¬¡æ•¸ä¿¡æ¯');
          }
          
          // ç§»é™¤å¸¸è¦‹çš„ç„¡é—œå…§å®¹ï¼Œä½†ä¿ç•™è§€çœ‹æ¬¡æ•¸ä¿¡æ¯åœ¨é–‹é ­
          let viewCountPrefix = '';
          if (viewCountInfo) {
            const tagInfo = viewCountInfo.tag ? ` #${viewCountInfo.tag}` : '';
            viewCountPrefix = `ğŸ“Š ${viewCountInfo.viewCount} (${viewCountInfo.date})${tagInfo}\n\n`;
          }
          
          // ç§»é™¤è§€çœ‹æ¬¡æ•¸è¡Œï¼Œå› ç‚ºæˆ‘å€‘å·²ç¶“æå–äº†
          cleanedText = cleanedText.replace(/è§€çœ‹æ¬¡æ•¸:\d+æ¬¡\s*\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥(?:\s*#\S+)?/g, '');
          cleanedText = cleanedText.replace(/Views:\d+\s*\d{4}-\d{1,2}-\d{1,2}/g, '');
          cleanedText = cleanedText.replace(/Subscribe|åˆ†äº«|å„²å­˜|ç¸®åœ–|æ’­æ”¾æ¸…å–®|è³‡è¨Šå¡/g, '');
          
          // åœ¨é–‹é ­æ·»åŠ è§€çœ‹æ¬¡æ•¸ä¿¡æ¯
          cleanedText = viewCountPrefix + cleanedText;
          cleanedText = cleanedText.replace(/Watch more|Question for you|Welcome to/g, '');
          
          // å¦‚æœå…§å®¹å¤ªçŸ­ï¼Œå¯èƒ½æ˜¯ç„¡æ•ˆå…§å®¹
          if (cleanedText.length < 20) {
            showStatus('å‰ªè²¼ç°¿å…§å®¹å¤ªçŸ­ï¼Œè«‹ç¢ºèªå·²è¤‡è£½å®Œæ•´çš„ YouTube æè¿°', 'warning');
            return;
          }
          
          document.getElementById('description').value = cleanedText;
          
          // è‡ªå‹•åˆ†é¡
          const title = document.getElementById('title').value;
          const continent = autoClassifyContinent(title, cleanedText);
          document.getElementById('category').value = continent;
          
          showStatus(`å·²è²¼ä¸Šå‰ªè²¼ç°¿å…§å®¹ä¸¦åˆ†é¡åˆ°ï¼š${continent}`, 'success');
        } else {
          showStatus('å‰ªè²¼ç°¿ç‚ºç©ºï¼Œè«‹å…ˆè¤‡è£½ YouTube æè¿°å…§å®¹', 'warning');
        }
      } catch (error) {
        console.error('è®€å–å‰ªè²¼ç°¿å¤±æ•—:', error);
        showStatus('ç„¡æ³•è®€å–å‰ªè²¼ç°¿ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æè¿°', 'error');
      }
    }

    // å–®ç¨ç²å– YouTube æè¿°ï¼ˆä½¿ç”¨ç„¡éœ€ API Key çš„æ–¹æ³•ï¼‰
    async function fetchYouTubeDescription() {
      const youtubeId = document.getElementById('youtubeId').value.trim();
      if (!youtubeId) {
        showStatus('è«‹å…ˆè¼¸å…¥ YouTube ID', 'warning');
        return;
      }
      
      console.log('ğŸ” é–‹å§‹ç²å– YouTube æè¿°ï¼ŒID:', youtubeId);

      try {
        showStatus('æ­£åœ¨å¾ YouTube ç²å–æè¿°...', 'info');
        
        // ä½¿ç”¨ YouTube oEmbed API é©—è­‰å½±ç‰‡å­˜åœ¨
        const oembedResponse = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${youtubeId}&format=json`);
        if (oembedResponse.ok) {
          const oembedData = await oembedResponse.json();
          
          // å˜—è©¦ä½¿ç”¨å¤šå€‹ä»£ç†æœå‹™ç²å– YouTube æè¿°
          const proxyServices = [
            `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(`https://www.youtube.com/watch?v=${youtubeId}`)}`,
            `https://thingproxy.freeboard.io/fetch/https://www.youtube.com/watch?v=${youtubeId}`,
            `https://corsproxy.io/?${encodeURIComponent(`https://www.youtube.com/watch?v=${youtubeId}`)}`,
            `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(`https://youtu.be/${youtubeId}`)}`
          ];
          
          for (let i = 0; i < proxyServices.length; i++) {
            try {
              showStatus(`æ­£åœ¨å˜—è©¦ç²å–å½±ç‰‡æè¿°... (æ–¹æ³• ${i + 1}/${proxyServices.length})`, 'info');
              
              const proxyResponse = await fetch(proxyServices[i]);
              if (proxyResponse.ok) {
                let htmlContent = '';
                
                if (proxyServices[i].includes('allorigins.win')) {
                  const proxyData = await proxyResponse.json();
                  htmlContent = proxyData.contents;
                } else {
                  htmlContent = await proxyResponse.text();
                }
                
                console.log(`ä»£ç†æœå‹™ ${i + 1} ç²å–åˆ° HTML å…§å®¹é•·åº¦:`, htmlContent.length);
                
                // å¾ HTML ä¸­æå–æè¿°
                const description = extractDescriptionFromHTML(htmlContent);
                
                if (description && description.length > 50) {
                  // æ¸…ç†æè¿°
                  const cleanedDescription = cleanYouTubeDescription(description);
                  document.getElementById('description').value = cleanedDescription;
                  
                  // è‡ªå‹•åˆ†é¡
                  const continent = autoClassifyContinent(oembedData.title, cleanedDescription);
                  document.getElementById('category').value = continent;
                  
                  showStatus(`âœ… å·²æˆåŠŸç²å– YouTube æè¿°ä¸¦åˆ†é¡åˆ°ï¼š${continent}`, 'success');
                  return;
                } else {
                  console.log(`ä»£ç†æœå‹™ ${i + 1} æœªèƒ½æå–åˆ°æœ‰æ•ˆæè¿°`);
                }
              } else {
                console.log(`ä»£ç†æœå‹™ ${i + 1} è«‹æ±‚å¤±æ•—:`, proxyResponse.status);
              }
            } catch (proxyError) {
              console.log(`ä»£ç†æœå‹™ ${i + 1} å¤±æ•—:`, proxyError);
            }
          }
          
          // å¦‚æœæ‰€æœ‰ä»£ç†æœå‹™éƒ½å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨ YouTube çš„å…¬é–‹ API
          try {
            showStatus('æ­£åœ¨å˜—è©¦ä½¿ç”¨ YouTube å…¬é–‹ API...', 'info');
            
            // ä½¿ç”¨ YouTube çš„å…¬é–‹ oEmbed API ç²å–æ›´å¤šè³‡è¨Š
            const oembedResponse = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${youtubeId}&format=json&maxwidth=800&maxheight=600`);
            if (oembedResponse.ok) {
              const oembedData = await oembedResponse.json();
              
              // oEmbed API ä¸æä¾›æè¿°ï¼Œä½†æˆ‘å€‘å¯ä»¥å˜—è©¦å…¶ä»–æ–¹æ³•
              console.log('oEmbed API æˆåŠŸï¼Œä½†ç„¡æ³•ç²å–æè¿°');
            }
          } catch (oembedError) {
            console.log('oEmbed API å¤±æ•—:', oembedError);
          }
          
          // å¦‚æœç„¡æ³•ç²å–æè¿°ï¼Œæä¾›æ‰‹å‹•è¼¸å…¥çš„æŒ‡å°
          showStatus('ä»£ç†æœå‹™è¢« YouTube é˜»æ“‹ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æè¿°', 'warning');
          
          // åŒæ™‚è‡ªå‹•åˆ†é¡
          const continent = autoClassifyContinent(oembedData.title, '');
          document.getElementById('category').value = continent;
          
          // æä¾›æ‰‹å‹•è¼¸å…¥çš„é¸é …
          const manualDescription = prompt(`å½±ç‰‡æ¨™é¡Œï¼š${oembedData.title}\n\nè«‹æ‰‹å‹•è¼¸å…¥ YouTube å½±ç‰‡æè¿°ï¼ˆæˆ–æŒ‰å–æ¶ˆè·³éï¼‰ï¼š`);
          if (manualDescription && manualDescription.trim()) {
            document.getElementById('description').value = manualDescription.trim();
            showStatus(`å·²æ‰‹å‹•è¼¸å…¥æè¿°ä¸¦åˆ†é¡åˆ°ï¼š${continent}`, 'success');
          } else {
            // åœ¨æè¿°æ¬„ä½ä¸­æä¾›å»ºè­°
            const suggestions = [
              `ğŸ“º å½±ç‰‡æ¨™é¡Œï¼š${oembedData.title}`,
              '',
              'ğŸ’¡ æ‰‹å‹•ç²å–æè¿°çš„æ–¹æ³•ï¼š',
              '1. å‰å¾€ YouTube å½±ç‰‡é é¢ï¼šhttps://www.youtube.com/watch?v=' + youtubeId,
              '2. æ‰¾åˆ°ã€Œèªªæ˜ã€æˆ–ã€ŒDescriptionã€å€å¡Š',
              '3. è¤‡è£½å®Œæ•´çš„æè¿°æ–‡å­—',
              '4. è²¼åˆ°æ­¤æ¬„ä½ä¸­',
              '',
              'ğŸ’¡ å»ºè­°æè¿°æ ¼å¼ï¼š',
              'â€¢ å½±ç‰‡ä¸»é¡Œå’Œå…§å®¹æ¦‚è¿°',
              'â€¢ ä¸»è¦æ™¯é»æˆ–ç‰¹è‰²',
              'â€¢ é©åˆçš„è§€çœ¾ç¾¤é«”',
              'â€¢ å½±ç‰‡äº®é»æˆ–æ¨è–¦åŸå› ',
              '',
              'ğŸ“ è«‹æ‰‹å‹•è¼¸å…¥æè¿°...'
            ].join('\n');
            
            document.getElementById('description').value = suggestions;
            showStatus(`å·²æ ¹æ“šæ¨™é¡Œè‡ªå‹•åˆ†é¡åˆ°ï¼š${continent}ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æè¿°`, 'info');
          }
          
        } else {
          showStatus('ç„¡æ³•ç²å– YouTube è³‡è¨Šï¼Œè«‹æª¢æŸ¥ ID æ˜¯å¦æ­£ç¢º', 'warning');
        }
        
      } catch (error) {
        showStatus('ç²å– YouTube æè¿°æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
        console.error('YouTube æè¿°ç²å–éŒ¯èª¤:', error);
      }
    }

    // æ‰‹å‹•è§¸ç™¼è‡ªå‹•åˆ†é¡
    function autoClassifyFromTitle() {
      const title = document.getElementById('title').value;
      const description = document.getElementById('description').value;
      
      if (!title && !description) {
        showStatus('è«‹å…ˆå¡«å…¥ç¯€ç›®æ¨™é¡Œæˆ–æè¿°', 'warning');
        return;
      }
      
      const continent = autoClassifyContinent(title, description);
      document.getElementById('category').value = continent;
      
      // é¡¯ç¤ºåˆ†é¡çµæœ
      const country = extractCountryFromText(title + ' ' + description);
      if (country) {
        showStatus(`å·²è‡ªå‹•åˆ†é¡åˆ°ï¼š${continent}ï¼ˆæª¢æ¸¬åˆ°ï¼š${country}ï¼‰`, 'success');
      } else {
        showStatus(`å·²è‡ªå‹•åˆ†é¡åˆ°ï¼š${continent}ï¼ˆåŸºæ–¼é—œéµå­—åˆ¤æ–·ï¼‰`, 'success');
      }
    }

    async function fetchYouTubeInfo() {
      const youtubeId = document.getElementById('youtubeId').value.trim();
      if (!youtubeId) return;

      try {
        showStatus('æ­£åœ¨ç²å– YouTube è³‡è¨Š...', 'info');
        
        // ä½¿ç”¨ YouTube oEmbed API ç²å–åŸºæœ¬è³‡è¨Š
        const response = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${youtubeId}&format=json`);
        if (response.ok) {
          const data = await response.json();
          
          // å¡«å…¥æ¨™é¡Œ
          document.getElementById('title').value = data.title;
          
          // è‡ªå‹•æ›´æ–°ç¸®åœ–é è¦½
          updateThumbnailPreview(youtubeId);
          
          // è‡ªå‹•åˆ†é¡åˆ°æ´²ï¼ˆåŸºæ–¼æ¨™é¡Œï¼‰
          const continent = autoClassifyContinent(data.title, '');
          document.getElementById('category').value = continent;
          
          showStatus(`YouTube è³‡è¨Šå·²è‡ªå‹•å¡«å…¥ï¼Œå·²åˆ†é¡åˆ°ï¼š${continent}ã€‚å¦‚éœ€æè¿°ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æˆ–ä½¿ç”¨ã€ŒğŸ“ å¾ YouTube ç²å–ã€æŒ‰éˆ•`, 'success');
        } else {
          showStatus('ç„¡æ³•ç²å– YouTube è³‡è¨Šï¼Œè«‹æª¢æŸ¥ ID æ˜¯å¦æ­£ç¢º', 'warning');
        }
      } catch (error) {
        showStatus('ç²å– YouTube è³‡è¨Šæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
        console.error('YouTube è³‡è¨Šç²å–éŒ¯èª¤:', error);
      }
    }

    // æ›´æ–°ç¸®åœ–é è¦½
    function updateThumbnailPreview(youtubeId) {
      const thumbnailPreview = document.getElementById('thumbnailPreview');
      if (youtubeId) {
        // ä½¿ç”¨æ›´å¯é çš„ YouTube ç¸®åœ– URL
        const thumbnailUrl = `https://i.ytimg.com/vi/${youtubeId}/maxresdefault.jpg`;
        thumbnailPreview.src = thumbnailUrl;
        thumbnailPreview.setAttribute('data-youtube-url', thumbnailUrl);
        
        // å¦‚æœ maxresdefault å¤±æ•—ï¼Œå›é€€åˆ° hqdefault
        thumbnailPreview.onerror = function() {
          this.src = `https://i.ytimg.com/vi/${youtubeId}/hqdefault.jpg`;
          this.onerror = null; // é˜²æ­¢ç„¡é™å¾ªç’°
        };
      } else {
        thumbnailPreview.src = 'https://images.unsplash.com/photo-1485846234645-a62644f84728?w=200&h=112&fit=crop';
        thumbnailPreview.removeAttribute('data-youtube-url');
        thumbnailPreview.onerror = null;
      }
    }

    // é è¦½ä¸Šå‚³çš„ç¸®åœ–
    function previewThumbnail() {
      const fileInput = document.getElementById('thumbnailFile');
      const thumbnailPreview = document.getElementById('thumbnailPreview');
      
      if (fileInput.files && fileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          thumbnailPreview.src = e.target.result;
        };
        reader.readAsDataURL(fileInput.files[0]);
      }
    }

    // é‡ç½®ç‚º YouTube ç¸®åœ–
    function resetThumbnail() {
      const youtubeId = document.getElementById('youtubeId').value.trim();
      const thumbnailFile = document.getElementById('thumbnailFile');
      
      // æ¸…é™¤æª”æ¡ˆé¸æ“‡
      thumbnailFile.value = '';
      
      // æ›´æ–°ç¸®åœ–é è¦½
      updateThumbnailPreview(youtubeId);
      
      showStatus('å·²é‡ç½®ç‚º YouTube ç¸®åœ–', 'info');
    }

    function handleFileUpload() {
      const fileInput = document.getElementById('mp4File');
      const file = fileInput.files[0];

      if (file) {
        const fileName = file.name.replace('.mp4', '');
        document.getElementById('title').value = fileName;
        showStatus('æª”æ¡ˆåç¨±å·²è‡ªå‹•å¡«å…¥ç‚ºæ¨™é¡Œ', 'success');
      }
    }

    function getEvent(date, time) {
      const dayEvents = events[date] || [];
      return dayEvents.find(event => event.time === time);
    }

    // æª¢æŸ¥æ˜¯å¦ç‚ºéå»çš„æ—¥æœŸæ™‚é–“ä¸¦é¡¯ç¤ºè­¦èª
    function checkPastDateTime() {
      const date = document.getElementById('editDate').value;
      const time = document.getElementById('airTime').value;
      const warningDiv = document.getElementById('pastDateTimeWarning');
      
      if (!date || !time) {
        warningDiv.style.display = 'none';
        return;
      }

      const now = new Date();
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      const todayString = now.getFullYear() + '-' +
                         String(now.getMonth() + 1).padStart(2, '0') + '-' +
                         String(now.getDate()).padStart(2, '0');
      
      const isPastDate = date < todayString;
      const isPastTime = date === todayString &&
                        (parseInt(time.split(':')[0]) < currentHour ||
                         (parseInt(time.split(':')[0]) === currentHour && parseInt(time.split(':')[1]) <= currentMinute));

      if (isPastDate || isPastTime) {
        warningDiv.style.display = 'block';
        warningDiv.innerHTML = isPastDate 
          ? `âš ï¸ <strong>è­¦å‘Šï¼š</strong>æ‚¨é¸æ“‡çš„æ˜¯éå»çš„æ—¥æœŸ (${date})ï¼Œé€™å¯èƒ½æœƒå½±éŸ¿ç¯€ç›®æ’ç¨‹ã€‚è«‹ç¢ºèªæ˜¯å¦è¦ç¹¼çºŒç·¨è¼¯ã€‚`
          : `âš ï¸ <strong>è­¦å‘Šï¼š</strong>æ‚¨é¸æ“‡çš„æ˜¯éå»çš„æ™‚é–“ (${date} ${time})ï¼Œé€™å¯èƒ½æœƒå½±éŸ¿ç¯€ç›®æ’ç¨‹ã€‚è«‹ç¢ºèªæ˜¯å¦è¦ç¹¼çºŒç·¨è¼¯ã€‚`;
      } else {
        warningDiv.style.display = 'none';
      }
    }

    function updateTimeSlotInfo() {
      const time = document.getElementById('airTime').value;
      const timeSlotInfo = document.getElementById('timeSlotInfo');
      const timeSlotName = document.getElementById('timeSlotName');
      const timeSlotDescription = document.getElementById('timeSlotDescription');
      
      if (!time) {
        timeSlotInfo.style.display = 'none';
        return;
      }
      
      const timeSlot = getTimeSlot(time);
      if (timeSlot) {
        const slotIndex = timeSlot.slot.slots.indexOf(time);
        const otherSlots = getSameTimeSlotInOtherPeriods(time);
        
        timeSlotName.textContent = `ğŸ¯ ${timeSlot.slot.name} (ç¬¬${slotIndex + 1}å€‹æ™‚é–“æ§½)`;
        timeSlotDescription.innerHTML = `
          <br>ğŸ“… å¯è¤‡è£½åˆ°ï¼š${otherSlots.map(slot => `${slot.periodName} ${slot.time}`).join('ã€')}
          <br>ğŸ”„ æ­¤æ™‚é–“æ§½å¯æ‰¹é‡è¤‡è£½åˆ°æ•´å€‹æœˆçš„ç›¸åŒæ™‚æ®µ
        `;
        timeSlotInfo.style.display = 'block';
      } else {
        timeSlotInfo.style.display = 'none';
      }
    }

    document.getElementById('eventForm').addEventListener('submit', function(e) {
      e.preventDefault();
      console.log('ğŸ“ è¡¨å–®æäº¤äº‹ä»¶è§¸ç™¼');
      console.log('ğŸ” æª¢æŸ¥ç·¨è¼¯æ¨¡å¼:', {
        currentEditingVideoId: window.currentEditingVideoId,
        hasVideoId: !!window.currentEditingVideoId
      });

      // æª¢æŸ¥æ˜¯å¦ç‚ºå½±ç‰‡ç·¨è¼¯æ¨¡å¼
      if (window.currentEditingVideoId) {
        console.log('âœ… é€²å…¥å½±ç‰‡ç·¨è¼¯æ¨¡å¼ï¼Œèª¿ç”¨ updateVideoInContentful');
        // åœ¨ç·¨è¼¯å½±ç‰‡æ¨¡å¼ä¸‹ï¼Œç›´æ¥èª¿ç”¨ updateVideoInContentful
        updateVideoInContentful();
        return;
      }
      
      console.log('ğŸ“… é€²å…¥ç¯€ç›®æ’ç¨‹æ¨¡å¼ï¼Œç›´æ¥ä¸Šæ¶åˆ° Contentful');
      // æ‰€æœ‰å„²å­˜æ“ä½œéƒ½ç›´æ¥åŒæ­¥åˆ° Contentful
      createNewProgram();
    });

    async function deleteEvent() {
      console.log('ğŸ—‘ï¸ deleteEvent å‡½æ•¸è¢«èª¿ç”¨');
      console.log('window.currentEditingVideoId:', window.currentEditingVideoId);
      console.log('window.deleteVideo æ˜¯å¦å­˜åœ¨:', typeof window.deleteVideo);
      
      // æª¢æŸ¥æ˜¯å¦ç‚ºå½±ç‰‡ç·¨è¼¯æ¨¡å¼
      if (window.currentEditingVideoId) {
        console.log('ğŸ—‘ï¸ åˆªé™¤å½±ç‰‡æ¨¡å¼ï¼Œèª¿ç”¨å½±ç‰‡åˆªé™¤åŠŸèƒ½');
        const videoTitle = document.getElementById('title').value || 'æœªå‘½åå½±ç‰‡';
        
        if (typeof window.deleteVideo === 'function') {
          console.log('âœ… window.deleteVideo å‡½æ•¸å­˜åœ¨ï¼Œé–‹å§‹èª¿ç”¨');
          await window.deleteVideo(window.currentEditingVideoId, videoTitle);
        } else {
          console.error('âŒ window.deleteVideo å‡½æ•¸ä¸å­˜åœ¨');
          showStatus('âŒ åˆªé™¤åŠŸèƒ½æœªè¼‰å…¥ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢', 'error');
        }
        return;
      }

      const date = document.getElementById('editDate').value;
      const time = document.getElementById('editTime').value;
      const title = document.getElementById('title').value;

      console.log('ğŸ—‘ï¸ é–‹å§‹åˆªé™¤ç¯€ç›®:', { date, time, title });

      try {
        // æ‰¾åˆ°è¦åˆªé™¤çš„ç¯€ç›®
        console.log('ğŸ” å°‹æ‰¾è¦åˆªé™¤çš„ç¯€ç›®...');
        const eventToDelete = events[date]?.find(event => event.time === time);
        
        if (!eventToDelete) {
          console.error('âŒ æ‰¾ä¸åˆ°è¦åˆªé™¤çš„ç¯€ç›®');
          showStatus('æ‰¾ä¸åˆ°è¦åˆªé™¤çš„ç¯€ç›®', 'error');
          return;
        }

        console.log('âœ… æ‰¾åˆ°è¦åˆªé™¤çš„ç¯€ç›®:', eventToDelete);

        // æª¢æŸ¥æ˜¯å¦æœ‰ç›¸åŒæ™‚é–“æ§½å’Œç›¸åŒ YouTube ID çš„ç¯€ç›®
        const duplicateEvents = findDuplicateEvents(eventToDelete, date, time);
        
        if (duplicateEvents.length > 0) {
          // é¡¯ç¤ºé¸æ“‡åˆªé™¤æ–¹å¼çš„å°è©±æ¡†
          console.log('ğŸ“‹ é¡¯ç¤ºé¸æ“‡åˆªé™¤æ–¹å¼å°è©±æ¡†...');
          try {
            const choice = await showDeleteChoiceDialog(eventToDelete, duplicateEvents, date, time, title);
            console.log('ğŸ“‹ ç”¨æˆ¶é¸æ“‡:', choice);
            
            if (choice === 'single') {
              console.log('âœ… ç”¨æˆ¶é¸æ“‡åªåˆªé™¤é€™ä¸€å€‹ç¯€ç›®');
              await deleteSingleEvent(eventToDelete, date, time);
            } else if (choice === 'batch') {
              console.log('âœ… ç”¨æˆ¶é¸æ“‡æ‰¹é‡åˆªé™¤');
              await batchDeleteEvents(duplicateEvents);
            } else {
              console.log('âŒ ç”¨æˆ¶å–æ¶ˆåˆªé™¤');
              showStatus('å·²å–æ¶ˆåˆªé™¤', 'info');
              return;
            }
          } catch (error) {
            console.error('âŒ é¡¯ç¤ºé¸æ“‡å°è©±æ¡†å¤±æ•—:', error);
            showStatus('é¡¯ç¤ºé¸æ“‡å°è©±æ¡†å¤±æ•—: ' + error.message, 'error');
            return;
          }
        } else {
          // å–®å€‹ç¯€ç›®åˆªé™¤ç¢ºèª
          const confirmMessage = `ç¢ºå®šè¦åˆªé™¤ä»¥ä¸‹ç¯€ç›®å—ï¼Ÿ\n\næ—¥æœŸï¼š${date}\næ™‚é–“ï¼š${time}\næ¨™é¡Œï¼š${title}\n\nâš ï¸ æ­¤æ“ä½œå°‡åŒæ™‚å¾ Contentful ä¸­åˆªé™¤ç¯€ç›®ï¼Œç„¡æ³•å¾©åŸï¼`;
          
          if (!confirm(confirmMessage)) {
            console.log('âŒ ç”¨æˆ¶å–æ¶ˆåˆªé™¤');
            showStatus('å·²å–æ¶ˆåˆªé™¤', 'info');
            return;
          }

          console.log('âœ… ç”¨æˆ¶ç¢ºèªåˆªé™¤');
          await deleteSingleEvent(eventToDelete, date, time);
        }

        // ä¸èª¿ç”¨ saveEvents()ï¼Œå› ç‚ºæˆ‘å€‘å·²ç¶“ç§»é™¤äº† localStorage ä¾è³´
        renderCurrentView();
        closeModal();
        
        // é¡¯ç¤ºæœ€çµ‚ç‹€æ…‹ï¼ˆåœ¨ deleteSingleEvent æˆ– batchDeleteEvents ä¸­å·²ç¶“é¡¯ç¤ºäº†ï¼‰
        
      } catch (error) {
        console.error('âŒ åˆªé™¤ç¯€ç›®å¤±æ•—:', error);
        showStatus('åˆªé™¤ç¯€ç›®å¤±æ•—: ' + error.message, 'error');
      }
    }

    // é¡¯ç¤ºåˆªé™¤é¸æ“‡å°è©±æ¡†
    function showDeleteChoiceDialog(eventToDelete, duplicateEvents, date, time, title) {
      console.log('ğŸ“‹ é–‹å§‹å‰µå»ºé¸æ“‡å°è©±æ¡†...');
      
      const dialog = document.createElement('div');
      dialog.id = 'deleteChoiceDialog';
      dialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        font-family: Arial, sans-serif;
      `;
      
      console.log('ğŸ“‹ å°è©±æ¡†æ¨£å¼å·²è¨­ç½®');
      
      dialog.innerHTML = `
        <div style="
          background: white;
          padding: 30px;
          border-radius: 10px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
          max-width: 600px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="margin: 0 0 20px 0; color: #333;">é¸æ“‡åˆªé™¤æ–¹å¼</h3>
          <div style="margin-bottom: 20px; text-align: left;">
            <p style="margin: 0 0 15px 0; color: #666;">
              <strong>ç¯€ç›®ï¼š</strong>${title}<br>
              <strong>æ™‚é–“ï¼š</strong>${time}<br>
              <strong>YouTube IDï¼š</strong>${eventToDelete.youtubeId || 'ç„¡'}
            </p>
            <p style="margin: 0 0 15px 0; color: #666;">
              ç™¼ç¾ <strong>${duplicateEvents.length}</strong> å€‹ä»Šå¤©ä¹‹å¾Œç›¸åŒæ™‚é–“æ§½çš„ç›¸åŒç¯€ç›®ï¼š
            </p>
            <p style="margin: 0 0 15px 0; color: #999; font-size: 12px;">
              â„¹ï¸ æ‰¹é‡åˆªé™¤åªæœƒåˆªé™¤ä»Šå¤©åŠä¹‹å¾Œçš„ç¯€ç›®ï¼Œéå»çš„ç¯€ç›®ä¸æœƒè¢«åˆªé™¤
            </p>
            <div style="
              background: #f8f9fa;
              padding: 15px;
              border-radius: 5px;
              margin-bottom: 20px;
              max-height: 200px;
              overflow-y: auto;
              font-size: 12px;
            ">
              ${duplicateEvents.slice(0, 10).map(e => `â€¢ ${e.date} ${e.time}`).join('<br>')}
              ${duplicateEvents.length > 10 ? `<br>... é‚„æœ‰ ${duplicateEvents.length - 10} å€‹ç¯€ç›®` : ''}
            </div>
          </div>
          <div style="display: flex; gap: 15px; justify-content: center;">
            <button id="singleDeleteBtn" style="
              background: #dc3545;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 5px;
              cursor: pointer;
              font-size: 14px;
              font-weight: bold;
            ">åªåˆªé™¤é€™ä¸€å€‹ç¯€ç›®</button>
            <button id="batchDeleteBtn" style="
              background: #fd7e14;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 5px;
              cursor: pointer;
              font-size: 14px;
              font-weight: bold;
            ">æ‰¹é‡åˆªé™¤æ‰€æœ‰ç›¸åŒç¯€ç›® (${duplicateEvents.length} å€‹)</button>
            <button id="cancelBtn" style="
              background: #6c757d;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 5px;
              cursor: pointer;
              font-size: 14px;
            ">å–æ¶ˆ</button>
          </div>
          <div style="margin-top: 15px; font-size: 12px; color: #666;">
            âš ï¸ æ­¤æ“ä½œå°‡åŒæ™‚å¾ Contentful ä¸­åˆªé™¤ç¯€ç›®ï¼Œç„¡æ³•å¾©åŸï¼
          </div>
        </div>
      `;
      
      console.log('ğŸ“‹ å°‡å°è©±æ¡†æ·»åŠ åˆ°é é¢...');
      document.body.appendChild(dialog);
      console.log('ğŸ“‹ å°è©±æ¡†å·²æ·»åŠ åˆ°é é¢');
      
      return new Promise((resolve) => {
        console.log('ğŸ“‹ è¨­ç½®æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨...');
        
        const singleBtn = dialog.querySelector('#singleDeleteBtn');
        const batchBtn = dialog.querySelector('#batchDeleteBtn');
        const cancelBtn = dialog.querySelector('#cancelBtn');
        
        if (singleBtn) {
          singleBtn.onclick = () => {
            console.log('ğŸ“‹ ç”¨æˆ¶é»æ“Šï¼šåªåˆªé™¤é€™ä¸€å€‹ç¯€ç›®');
            document.body.removeChild(dialog);
            resolve('single');
          };
        } else {
          console.error('âŒ æ‰¾ä¸åˆ°å–®å€‹åˆªé™¤æŒ‰éˆ•');
        }
        
        if (batchBtn) {
          batchBtn.onclick = () => {
            console.log('ğŸ“‹ ç”¨æˆ¶é»æ“Šï¼šæ‰¹é‡åˆªé™¤');
            document.body.removeChild(dialog);
            resolve('batch');
          };
        } else {
          console.error('âŒ æ‰¾ä¸åˆ°æ‰¹é‡åˆªé™¤æŒ‰éˆ•');
        }
        
        if (cancelBtn) {
          cancelBtn.onclick = () => {
            console.log('ğŸ“‹ ç”¨æˆ¶é»æ“Šï¼šå–æ¶ˆ');
            document.body.removeChild(dialog);
            resolve('cancel');
          };
        } else {
          console.error('âŒ æ‰¾ä¸åˆ°å–æ¶ˆæŒ‰éˆ•');
        }
        
        // é»æ“ŠèƒŒæ™¯é—œé–‰
        dialog.onclick = (e) => {
          if (e.target === dialog) {
            console.log('ğŸ“‹ ç”¨æˆ¶é»æ“ŠèƒŒæ™¯ï¼šå–æ¶ˆ');
            document.body.removeChild(dialog);
            resolve('cancel');
          }
        };
        
        console.log('ğŸ“‹ å°è©±æ¡†å·²æº–å‚™å°±ç·’ï¼Œç­‰å¾…ç”¨æˆ¶é¸æ“‡...');
      });
    }

    // æŸ¥æ‰¾ç›¸åŒæ™‚é–“æ§½å’Œç›¸åŒ YouTube ID çš„ç¯€ç›®
    function findDuplicateEvents(eventToDelete, currentDate, currentTime) {
      const duplicates = [];
      const targetYouTubeId = eventToDelete.youtubeId;
      const targetTime = currentTime;
      
      if (!targetYouTubeId) {
        console.log('â„¹ï¸ ç¯€ç›®æ²’æœ‰ YouTube IDï¼Œä¸é€²è¡Œæ‰¹é‡åˆªé™¤');
        return duplicates;
      }

      console.log('ğŸ” æŸ¥æ‰¾ç›¸åŒæ™‚é–“æ§½å’Œ YouTube ID çš„ç¯€ç›®...');
      
      // ç²å–ä»Šå¤©çš„æ—¥æœŸ
      const today = new Date().toISOString().split('T')[0];
      console.log('ä»Šå¤©æ—¥æœŸ:', today);
      
      // éæ­·æ‰€æœ‰æ—¥æœŸ
      Object.keys(events).forEach(date => {
      if (events[date]) {
          events[date].forEach(event => {
            // æª¢æŸ¥æ˜¯å¦æ˜¯ç›¸åŒæ™‚é–“æ§½å’Œç›¸åŒ YouTube ID
            if (event.time === targetTime && 
                event.youtubeId === targetYouTubeId && 
                event.title === eventToDelete.title &&
                !(date === currentDate && event.time === currentTime)) { // æ’é™¤ç•¶å‰è¦åˆªé™¤çš„ç¯€ç›®
              
              // åªåŒ…å«ä»Šå¤©ä¹‹å¾Œçš„ç¯€ç›®ï¼ˆåŒ…æ‹¬ä»Šå¤©ï¼‰
              if (date >= today) {
                duplicates.push({
                  date: date,
                  time: event.time,
                  event: event
                });
              } else {
                console.log(`â° è·³ééå»çš„ç¯€ç›®: ${date} ${event.time}`);
              }
            }
          });
        }
      });

      console.log(`âœ… æ‰¾åˆ° ${duplicates.length} å€‹ä»Šå¤©ä¹‹å¾Œçš„é‡è¤‡ç¯€ç›®:`, duplicates);
      return duplicates;
    }

    // æ‰¹é‡åˆªé™¤ç¯€ç›®
    async function batchDeleteEvents(duplicateEvents) {
      console.log('ğŸ—‘ï¸ é–‹å§‹æ‰¹é‡åˆªé™¤ç¯€ç›®...');
      
      // å‰µå»ºé€²åº¦æ¢å°è©±æ¡†
      const progressDialog = createProgressDialog(duplicateEvents.length);
      document.body.appendChild(progressDialog);
      
      let successCount = 0;
      let failCount = 0;
      let currentIndex = 0;

      try {
        for (const duplicate of duplicateEvents) {
          currentIndex++;
          
          // æ›´æ–°é€²åº¦æ¢
          updateProgress(progressDialog, currentIndex, duplicateEvents.length, duplicate);
          
          try {
            console.log(`ğŸ—‘ï¸ åˆªé™¤ç¯€ç›® ${currentIndex}/${duplicateEvents.length}: ${duplicate.date} ${duplicate.time}`);
            
            // å¾ Contentful åˆªé™¤
            if (duplicate.event.contentfulId) {
              try {
                await deleteFromContentful(duplicate.event.contentfulId);
                console.log(`âœ… æˆåŠŸå¾ Contentful åˆªé™¤: ${duplicate.date} ${duplicate.time}`);
              } catch (error) {
                console.error(`âŒ å¾ Contentful åˆªé™¤å¤±æ•—: ${duplicate.date} ${duplicate.time}`, error);
                failCount++;
                continue; // è·³éæœ¬åœ°åˆªé™¤
              }
            }

            // å¾æœ¬åœ°åˆªé™¤
            if (events[duplicate.date]) {
              events[duplicate.date] = events[duplicate.date].filter(event => 
                !(event.time === duplicate.time && event.youtubeId === duplicate.event.youtubeId)
              );
              
              if (events[duplicate.date].length === 0) {
                delete events[duplicate.date];
              }
            }

            successCount++;
            
            // æ·»åŠ å°å»¶é²ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°é€²åº¦
            await new Promise(resolve => setTimeout(resolve, 100));
            
          } catch (error) {
            console.error(`âŒ åˆªé™¤å¤±æ•—: ${duplicate.date} ${duplicate.time}`, error);
            failCount++;
          }
        }

        // å®Œæˆå¾Œæ›´æ–°é€²åº¦æ¢
        updateProgressComplete(progressDialog, successCount, failCount);
        
        // ç­‰å¾… 2 ç§’å¾Œé—œé–‰é€²åº¦æ¢
        setTimeout(() => {
          document.body.removeChild(progressDialog);
          showStatus(`æ‰¹é‡åˆªé™¤å®Œæˆ: æˆåŠŸ ${successCount} å€‹ï¼Œå¤±æ•— ${failCount} å€‹`, successCount > 0 ? 'success' : 'error');
        }, 2000);

      } catch (error) {
        console.error('âŒ æ‰¹é‡åˆªé™¤éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
        document.body.removeChild(progressDialog);
        showStatus('æ‰¹é‡åˆªé™¤éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ' + error.message, 'error');
      }
    }

    // å‰µå»ºé€²åº¦æ¢å°è©±æ¡†
    function createProgressDialog(totalCount) {
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        font-family: Arial, sans-serif;
      `;
      
      dialog.innerHTML = `
        <div style="
          background: white;
          padding: 30px;
          border-radius: 10px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
          max-width: 500px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="margin: 0 0 20px 0; color: #333;">æ­£åœ¨æ‰¹é‡åˆªé™¤ç¯€ç›®</h3>
          <div style="margin-bottom: 20px;">
            <div style="
              width: 100%;
              height: 20px;
              background: #f0f0f0;
              border-radius: 10px;
              overflow: hidden;
              margin-bottom: 10px;
            ">
              <div id="progressBar" style="
                width: 0%;
                height: 100%;
                background: linear-gradient(90deg, #4CAF50, #45a049);
                transition: width 0.3s ease;
                border-radius: 10px;
              "></div>
            </div>
            <div id="progressText" style="color: #666; font-size: 14px;">æº–å‚™ä¸­...</div>
          </div>
          <div id="currentItem" style="
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #666;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
          ">ç­‰å¾…é–‹å§‹...</div>
          <div id="statusText" style="color: #333; font-weight: bold;">æ­£åœ¨åˆªé™¤ç¯€ç›®...</div>
        </div>
      `;
      
      return dialog;
    }

    // æ›´æ–°é€²åº¦æ¢
    function updateProgress(dialog, current, total, duplicate) {
      const progressBar = dialog.querySelector('#progressBar');
      const progressText = dialog.querySelector('#progressText');
      const currentItem = dialog.querySelector('#currentItem');
      const statusText = dialog.querySelector('#statusText');
      
      const percentage = Math.round((current / total) * 100);
      
      progressBar.style.width = percentage + '%';
      progressText.textContent = `${current} / ${total} (${percentage}%)`;
      currentItem.textContent = `æ­£åœ¨åˆªé™¤: ${duplicate.date} ${duplicate.time} - ${duplicate.event.title}`;
      statusText.textContent = `æ­£åœ¨åˆªé™¤ç¯€ç›®...`;
    }

    // æ›´æ–°å®Œæˆç‹€æ…‹
    function updateProgressComplete(dialog, successCount, failCount) {
      const progressBar = dialog.querySelector('#progressBar');
      const progressText = dialog.querySelector('#progressText');
      const currentItem = dialog.querySelector('#currentItem');
      const statusText = dialog.querySelector('#statusText');
      
      progressBar.style.width = '100%';
      progressBar.style.background = failCount > 0 ? 'linear-gradient(90deg, #ff9800, #f57c00)' : 'linear-gradient(90deg, #4CAF50, #45a049)';
      progressText.textContent = `å®Œæˆ (${successCount + failCount} / ${successCount + failCount})`;
      currentItem.textContent = `æ‰¹é‡åˆªé™¤å®Œæˆï¼`;
      statusText.textContent = `æˆåŠŸ: ${successCount} å€‹ï¼Œå¤±æ•—: ${failCount} å€‹`;
    }

    // åˆªé™¤å–®å€‹ç¯€ç›®
    async function deleteSingleEvent(eventToDelete, date, time) {
      console.log('ğŸ—‘ï¸ åˆªé™¤å–®å€‹ç¯€ç›®...');
      console.log('è¦åˆªé™¤çš„ç¯€ç›®è©³æƒ…:', eventToDelete);

      let contentfulDeleteSuccess = false;

      // å¦‚æœæœ‰ Contentful IDï¼Œå¾ Contentful ä¸­åˆªé™¤
      if (eventToDelete.contentfulId) {
        console.log('ğŸ—‘ï¸ å¾ Contentful åˆªé™¤ç¯€ç›®:', eventToDelete.contentfulId);
        showStatus('æ­£åœ¨å¾ Contentful åˆªé™¤ç¯€ç›®...', 'info');
        
        try {
          await deleteFromContentful(eventToDelete.contentfulId);
          console.log('âœ… æˆåŠŸå¾ Contentful åˆªé™¤ç¯€ç›®');
          showStatus('å·²å¾ Contentful åˆªé™¤ç¯€ç›®', 'success');
          contentfulDeleteSuccess = true;
        } catch (error) {
          console.error('âŒ å¾ Contentful åˆªé™¤å¤±æ•—:', error);
          showStatus('å¾ Contentful åˆªé™¤å¤±æ•—: ' + error.message, 'error');
          contentfulDeleteSuccess = false;
        }
      } else {
        console.log('â„¹ï¸ ç¯€ç›®æ²’æœ‰ Contentful IDï¼Œåªå¾æœ¬åœ°åˆªé™¤');
        contentfulDeleteSuccess = true; // æ²’æœ‰ Contentful ID è¦–ç‚ºæˆåŠŸ
      }

      // å¾æœ¬åœ°äº‹ä»¶ä¸­åˆªé™¤
      console.log('ğŸ—‘ï¸ å¾æœ¬åœ°åˆªé™¤ç¯€ç›®...');
      console.log('åˆªé™¤å‰ events[date]:', events[date]);
      
      if (events[date]) {
        const beforeCount = events[date].length;
        
        // æ›´ç²¾ç¢ºçš„åˆªé™¤é‚è¼¯ï¼šæ ¹æ“šæ™‚é–“å’Œ YouTube ID åŒ¹é…
        events[date] = events[date].filter(event => {
          const timeMatch = event.time === time;
          const youtubeMatch = event.youtubeId === eventToDelete.youtubeId;
          const titleMatch = event.title === eventToDelete.title;
          
          // å¦‚æœæ™‚é–“ã€YouTube ID å’Œæ¨™é¡Œéƒ½åŒ¹é…ï¼Œå‰‡åˆªé™¤
          const shouldDelete = timeMatch && youtubeMatch && titleMatch;
          
          if (shouldDelete) {
            console.log('ğŸ—‘ï¸ åˆªé™¤æœ¬åœ°ç¯€ç›®:', event);
          }
          
          return !shouldDelete;
        });
        
        const afterCount = events[date].length;
        console.log(`åˆªé™¤å‰å¾Œæ•¸é‡: ${beforeCount} â†’ ${afterCount}`);
        
        if (events[date].length === 0) {
          console.log('ğŸ—‘ï¸ åˆªé™¤ç©ºçš„æ—¥æœŸ');
          delete events[date];
        }
      }

      console.log('åˆªé™¤å¾Œ events:', events);
      
      if (contentfulDeleteSuccess) {
        showStatus('ç¯€ç›®å·²æˆåŠŸåˆªé™¤', 'success');
      } else {
        showStatus('æœ¬åœ°åˆªé™¤æˆåŠŸï¼Œä½† Contentful åˆªé™¤å¤±æ•—', 'warning');
      }
    }

    // å¾ Contentful åˆªé™¤ç¯€ç›®
    async function deleteFromContentful(entryId) {
      try {
        console.log('ğŸ—‘ï¸ é–‹å§‹å¾ Contentful åˆªé™¤ç¯€ç›®:', entryId);
        
        // æª¢æŸ¥ Management SDK
        if (typeof contentfulManagement === 'undefined') {
          throw new Error('Management SDK æœªè¼‰å…¥');
        }

        // æª¢æŸ¥ API Token
        const managementToken = window.CONTENTFUL_CONFIG?.MANAGEMENT_TOKEN || window.CONTENTFUL_MANAGEMENT_TOKEN;
        if (!managementToken) {
          throw new Error('Management Token æœªè¨­å®š');
        }

        console.log('âœ… Management SDK å’Œ Token æª¢æŸ¥é€šé');

        // å‰µå»º Management å®¢æˆ¶ç«¯
        const managementClient = contentfulManagement.createClient({
          accessToken: managementToken
        });

        // ç²å– Space
        const spaceId = window.CONTENTFUL_CONFIG?.SPACE_ID || 'os5wf90ljenp';
        console.log('ğŸ“¡ é€£æ¥åˆ° Space:', spaceId);
        const space = await managementClient.getSpace(spaceId);
        
        // ç²å– Environment
        console.log('ğŸ“¡ é€£æ¥åˆ° Environment: master');
        const environment = await space.getEnvironment('master');
        
        // ç²å– Entry
        console.log('ğŸ“¡ ç²å– Entry:', entryId);
        const entry = await environment.getEntry(entryId);
        console.log('âœ… Entry ç²å–æˆåŠŸ:', entry.sys.id);
        
        // å–æ¶ˆç™¼å¸ƒ Entryï¼ˆå¦‚æœå·²ç™¼å¸ƒï¼‰
        if (entry.isPublished()) {
          console.log('ğŸ“¡ å–æ¶ˆç™¼å¸ƒ Entry...');
          await entry.unpublish();
          console.log('âœ… Entry å–æ¶ˆç™¼å¸ƒæˆåŠŸ');
        } else {
          console.log('â„¹ï¸ Entry æœªç™¼å¸ƒï¼Œè·³éå–æ¶ˆç™¼å¸ƒæ­¥é©Ÿ');
        }
        
        // åˆªé™¤ Entry
        console.log('ğŸ“¡ åˆªé™¤ Entry...');
        await entry.delete();
        console.log('âœ… Entry åˆªé™¤æˆåŠŸ');
        
        console.log('âœ… æˆåŠŸå¾ Contentful åˆªé™¤ç¯€ç›®:', entryId);
        return true;
        
      } catch (error) {
        console.error('âŒ å¾ Contentful åˆªé™¤ç¯€ç›®å¤±æ•—:', error);
        console.error('éŒ¯èª¤è©³æƒ…:', {
          message: error.message,
          status: error.status,
          statusText: error.statusText,
          details: error.details
        });
        throw error;
      }
    }

    function saveEvents() {
      // ä¸å†ä½¿ç”¨ localStorageï¼Œç›´æ¥ä½¿ç”¨ Contentful ä½œç‚ºå”¯ä¸€æ•¸æ“šæº
      console.log('âœ… ç¯€ç›®è³‡æ–™å·²åŒæ­¥åˆ° Contentful');
    }

    function loadEvents() {
      // å®Œå…¨å¾ Contentful è¼‰å…¥ï¼Œæ¸…ç©ºæœ¬åœ°æ•¸æ“š
      console.log('ğŸ”„ æ¸…ç©ºæœ¬åœ°æ•¸æ“šï¼Œå®Œå…¨å¾ Contentful è¼‰å…¥...');
      events = {}; // æ¸…ç©ºæœ¬åœ°äº‹ä»¶æ•¸æ“š
      
      loadEventsFromContentful().then(() => {
        console.log('âœ… å¾ Contentful è¼‰å…¥ç¯€ç›®è³‡æ–™æˆåŠŸ');
        showStatus('âœ… å·²å¾ Contentful é‡æ–°è¼‰å…¥æ‰€æœ‰ç¯€ç›®æ•¸æ“š', 'success');
      }).catch((error) => {
        console.error('âŒ å¾ Contentful è¼‰å…¥ç¯€ç›®è³‡æ–™å¤±æ•—:', error);
        showStatus('è¼‰å…¥ç¯€ç›®è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Contentful é€£ç·š', 'error');
      });
    }

    // å¾å‚™è¨»ä¸­æå–åˆ†é¡
    function extractCategoryFromNotes(notes) {
      if (!notes) return '';
      const match = notes.match(/\[åˆ†é¡:(.*?)\]/);
      return match ? match[1] : '';
    }

    // å¾å‚™è¨»ä¸­æå–ä¸»é¡Œ
    function extractTopicsFromNotes(notes) {
      if (!notes) return [];
      const matches = notes.match(/\[ä¸»é¡Œ:(.*?)\]/g);
      if (!matches) return [];
      
      // æå–æ‰€æœ‰ä¸»é¡Œæ¨™è¨˜çš„å…§å®¹
      const topics = matches.map(m => m.replace(/\[ä¸»é¡Œ:(.*?)\]/, '$1'));
      
      // å¦‚æœä¸»é¡ŒåŒ…å«é€—è™Ÿåˆ†éš”çš„å¤šå€‹ä¸»é¡Œï¼Œå‰‡åˆ†å‰²å®ƒå€‘
      const allTopics = [];
      topics.forEach(topic => {
        if (topic.includes(',')) {
          // åˆ†å‰²é€—è™Ÿåˆ†éš”çš„ä¸»é¡Œ
          const splitTopics = topic.split(',').map(t => t.trim()).filter(t => t);
          allTopics.push(...splitTopics);
        } else {
          allTopics.push(topic.trim());
        }
      });
      
      return allTopics;
    }

    // å¾ Contentful è¼‰å…¥ç¯€ç›®
    async function loadEventsFromContentful() {
      try {
        console.log('æ­£åœ¨å¾ Contentful è¼‰å…¥ç¯€ç›®...');
        
        // æª¢æŸ¥ Contentful æ˜¯å¦å¯ç”¨
        if (typeof contentful === 'undefined') {
          throw new Error('Contentful SDK æœªè¼‰å…¥');
        }

        // å‰µå»º Contentful å®¢æˆ¶ç«¯ (ä½¿ç”¨ Delivery Token è®€å–è³‡æ–™)
        const client = contentful.createClient({
          space: 'os5wf90ljenp',
          accessToken: 'lODH-WLwHwVZv7O4rFdBWjSnrzaQWGD4koeOZ1Dypj0'
        });

        // ç²å–æ‰€æœ‰ç¯€ç›®ï¼ˆä½¿ç”¨åˆ†é è¼‰å…¥ä»¥ç¢ºä¿è¼‰å…¥åˆ° 10/31ï¼‰
        let allItems = [];
        let skip = 0;
        const limit = 1000; // Contentful API æœ€å¤§é™åˆ¶ç‚º 1000
        let hasMore = true;
        
        while (hasMore) {
        const response = await client.getEntries({
          content_type: 'scheduleItem',
            order: 'fields.airDate',
            limit: limit,
            skip: skip
          });
          
          allItems = allItems.concat(response.items);
          console.log(`ğŸ“¥ è¼‰å…¥ç¬¬ ${Math.floor(skip/limit) + 1} é : ${response.items.length} å€‹ç¯€ç›® (ç¸½è¨ˆ: ${allItems.length})`);
          
          // æª¢æŸ¥æ˜¯å¦é‚„æœ‰æ›´å¤šè³‡æ–™
          hasMore = response.items.length === limit;
          skip += limit;
          
          // å¦‚æœå·²ç¶“è¼‰å…¥åˆ° 10/31 ä¹‹å¾Œçš„ç¯€ç›®ï¼Œå¯ä»¥åœæ­¢è¼‰å…¥
          const hasOct31OrLater = response.items.some(item => {
            const airDate = item.fields.airDate;
            return airDate && airDate >= '2025-10-31';
          });
          
          if (hasOct31OrLater) {
            console.log('âœ… å·²è¼‰å…¥åˆ° 10/31 åŠä¹‹å¾Œçš„ç¯€ç›®ï¼Œåœæ­¢åˆ†é è¼‰å…¥');
            break;
          }
        }

        console.log(`ğŸ“Š ç¸½å…±å¾ Contentful è¼‰å…¥ ${allItems.length} å€‹ç¯€ç›®`);
        
        // æª¢æŸ¥ä¸»é¡Œæ¨™è¨˜çµ±è¨ˆ
        let programsWithTopics = 0;
        let programsWithCategory = 0;
        let programsWithNoTags = 0;
        
        allItems.forEach(item => {
          const notes = String(item.fields.notes || '');
          const hasTopics = notes.includes('[ä¸»é¡Œ:');
          const hasCategory = notes.includes('[åˆ†é¡:');
          
          if (hasTopics) programsWithTopics++;
          if (hasCategory) programsWithCategory++;
          if (!hasTopics && !hasCategory) programsWithNoTags++;
        });
        
        console.log('ğŸ“Š ç¯€ç›®æ¨™è¨˜çµ±è¨ˆ:');
        console.log(`  - æœ‰ä¸»é¡Œæ¨™è¨˜çš„ç¯€ç›®: ${programsWithTopics} å€‹`);
        console.log(`  - æœ‰åˆ†é¡æ¨™è¨˜çš„ç¯€ç›®: ${programsWithCategory} å€‹`);
        console.log(`  - æ²’æœ‰ä»»ä½•æ¨™è¨˜çš„ç¯€ç›®: ${programsWithNoTags} å€‹`);
        
        // èª¿è©¦ï¼šæª¢æŸ¥æ‰€æœ‰ç¯€ç›®çš„æ—¥æœŸ
        console.log('ğŸ” æ‰€æœ‰ç¯€ç›®çš„æ—¥æœŸåˆ†ä½ˆ:');
        const dateCounts = {};
        allItems.forEach(item => {
          const airDate = item.fields.airDate;
          if (airDate) {
            dateCounts[airDate] = (dateCounts[airDate] || 0) + 1;
          }
        });
        
        // é¡¯ç¤ºæ‰€æœ‰æ—¥æœŸ
        Object.keys(dateCounts).sort().forEach(date => {
          console.log(`ğŸ“… ${date}: ${dateCounts[date]} å€‹ç¯€ç›®`);
        });
        
        // æª¢æŸ¥æ˜¯å¦æœ‰è¶…é 10/11 çš„ç¯€ç›®
        const laterDates = Object.keys(dateCounts).filter(date => date > '2025-10-11');
        console.log('ğŸ” è¶…é 10/11 çš„æ—¥æœŸ:', laterDates);
        if (laterDates.length > 0) {
          laterDates.forEach(date => {
            console.log(`ğŸ“… ${date}: ${dateCounts[date]} å€‹ç¯€ç›®`);
          });
        } else {
          console.log('âŒ æ²’æœ‰æ‰¾åˆ°è¶…é 10/11 çš„ç¯€ç›®');
        }
        
        // ç‰¹åˆ¥æª¢æŸ¥ 10/2 å’Œ 10/31 - æª¢æŸ¥æ‰€æœ‰å¯èƒ½çš„æ—¥æœŸæ ¼å¼
        const oct2Items = allItems.filter(item => {
          const airDate = item.fields.airDate;
          if (!airDate) return false;
          
          // æª¢æŸ¥å¤šç¨®æ—¥æœŸæ ¼å¼
          const dateStr = String(airDate);
          return dateStr.includes('2025-10-02') || 
                 dateStr.includes('2025-10-2') ||
                 dateStr.includes('10-02') ||
                 dateStr.includes('10/02');
        });
        
        const oct31Items = allItems.filter(item => {
          const airDate = item.fields.airDate;
          if (!airDate) return false;
          
          // æª¢æŸ¥å¤šç¨®æ—¥æœŸæ ¼å¼
          const dateStr = String(airDate);
          return dateStr.includes('2025-10-31') || 
                 dateStr.includes('2025-10-31') ||
                 dateStr.includes('10-31') ||
                 dateStr.includes('10/31');
        });
        
        console.log('ğŸ” Contentful ä¸­ 10/2 çš„ç¯€ç›®æ•¸é‡:', oct2Items.length);
        if (oct2Items.length > 0) {
          oct2Items.forEach((item, index) => {
            console.log(`10/2 ç¯€ç›® ${index + 1}:`, {
          id: item.sys.id,
          title: item.fields.title,
          airDate: item.fields.airDate,
              notes: item.fields.notes,
              block: item.fields.block,
              slotIndex: item.fields.slotIndex
            });
          });
        } else {
          console.log('âŒ æ²’æœ‰æ‰¾åˆ° 10/2 çš„ç¯€ç›®');
        }
        
        console.log('ğŸ” Contentful ä¸­ 10/31 çš„ç¯€ç›®æ•¸é‡:', oct31Items.length);
        if (oct31Items.length > 0) {
          oct31Items.forEach((item, index) => {
            console.log(`10/31 ç¯€ç›® ${index + 1}:`, {
              id: item.sys.id,
              title: item.fields.title,
              airDate: item.fields.airDate,
              notes: item.fields.notes,
              block: item.fields.block,
              slotIndex: item.fields.slotIndex
            });
          });
        } else {
          console.log('âŒ æ²’æœ‰æ‰¾åˆ° 10/31 çš„ç¯€ç›®');
          
          // æª¢æŸ¥æ‰€æœ‰ç¯€ç›®çš„æ—¥æœŸæ ¼å¼
          console.log('ğŸ” æª¢æŸ¥æ‰€æœ‰ç¯€ç›®çš„æ—¥æœŸæ ¼å¼:');
          response.items.slice(0, 5).forEach((item, index) => {
            console.log(`ç¯€ç›® ${index + 1}:`, {
              title: item.fields.title,
              airDate: item.fields.airDate,
              airDateType: typeof item.fields.airDate
            });
          });
        }
        
        console.log('è¼‰å…¥çš„ç¯€ç›®è©³æƒ…:', allItems.map(item => ({
          id: item.sys.id,
          title: item.fields.title,
          airDate: item.fields.airDate,
          notes: item.fields.notes,
          isPremiere: item.fields.isPremiere,
          status: item.fields.status
        })));

        // æ¸…ç©ºç¾æœ‰äº‹ä»¶
        events = {};

        // è½‰æ› Contentful è³‡æ–™ç‚ºæœ¬åœ°æ ¼å¼
        allItems.forEach(item => {
          const fields = item.fields;
          const airDate = fields.airDate || new Date().toISOString().split('T')[0];
          
          // å¾å‚™è¨»ä¸­æå–å…·é«”æ™‚é–“ï¼Œæ ¼å¼ç‚º [æ™‚é–“:XX:XX]
          const notes = String(fields.notes || '');
          const timeMatch = notes.match(/\[æ™‚é–“:(\d{2}:\d{2})\]/);
          let airTime;
          
          if (timeMatch) {
            airTime = timeMatch[1];
            console.log(`âœ… å¾å‚™è¨»æå–æ™‚é–“: ${airTime} for ${fields.title}`);
          } else {
            // å¦‚æœæ²’æœ‰æ™‚é–“æ¨™è¨˜ï¼Œå˜—è©¦å¾å…¶ä»–æ–¹å¼æ¨æ–·æ™‚é–“
            airTime = convertBlockToTime(fields.block || '12-18');
            console.log(`âš ï¸ æ²’æœ‰æ™‚é–“æ¨™è¨˜ï¼Œä½¿ç”¨æ™‚æ®µè½‰æ›: ${fields.block} -> ${airTime} for ${fields.title}`);
          }
          
          // ä½¿ç”¨å…·é«”æ™‚é–“ï¼Œå¦‚æœæ²’æœ‰å‰‡è½‰æ›æ™‚æ®µ
          const time = airTime;
          
          if (!events[airDate]) {
            events[airDate] = [];
          }

          // å¾å‚™è¨»ä¸­æå– YouTube ID
          const youtubeMatch = notes.match(/\[YouTube:([^\]]+)\]/);
          const youtubeId = youtubeMatch ? youtubeMatch[1] : '';
          
          // å¾å‚™è¨»ä¸­æå–æ™‚é•·
          const durationMatch = notes.match(/\[æ™‚é•·:(\d+)åˆ†é˜\]/);
          const duration = durationMatch ? parseInt(durationMatch[1]) : 30;
          
          // å¾å‚™è¨»ä¸­æå–ç‹€æ…‹
          const statusMatch = notes.match(/\[ç‹€æ…‹:(.*?)\]/);
          const status = statusMatch ? statusMatch[1] : 'é‡æ’­';
          
          // å¾å‚™è¨»ä¸­æå–ç¸®åœ–
          const thumbnailMatch = notes.match(/\[ç¸®åœ–:([^\]]+)\]/);
          const thumbnail = thumbnailMatch ? thumbnailMatch[1] : (youtubeId ? `https://img.youtube.com/vi/${youtubeId}/maxresdefault.jpg` : '');
          
          // èª¿è©¦è³‡è¨Š
          if (youtubeId) {
            console.log('âœ… å¾ Contentful æå–åˆ° YouTube ID:', youtubeId, 'for', fields.title);
          } else if (notes.includes('[YouTube:')) {
            console.log('âš ï¸ å‚™è¨»ä¸­æœ‰ YouTube æ¨™è¨˜ä½†æå–å¤±æ•—:', notes);
          }
          
          // å¾å‚™è¨»ä¸­æå–åˆ†é¡å’Œä¸»é¡Œ
          const category = extractCategoryFromNotes(notes);
          const topics = extractTopicsFromNotes(notes);
          
          // èª¿è©¦ä¸»é¡Œæå–
          if (topics && topics.length > 0) {
            console.log('âœ… æå–åˆ°ä¸»é¡Œ:', fields.title, 'ä¸»é¡Œ:', topics);
          } else if (notes.includes('[ä¸»é¡Œ:')) {
            console.log('âš ï¸ å‚™è¨»ä¸­æœ‰ä¸»é¡Œæ¨™è¨˜ä½†æå–å¤±æ•—:', fields.title, 'å‚™è¨»:', notes);
          } else {
            console.log('âŒ æ²’æœ‰ä¸»é¡Œæ¨™è¨˜:', fields.title, 'å‚™è¨»é•·åº¦:', notes.length, 'å‚™è¨»é è¦½:', notes.substring(0, 100));
          }
          
          // æ¸…ç†æè¿°ï¼Œç§»é™¤æ™‚é–“æ¨™è¨˜ã€YouTube æ¨™è¨˜ã€åˆ†é¡æ¨™è¨˜å’Œä¸»é¡Œæ¨™è¨˜
          const cleanDescription = notes
            .replace(/\[æ™‚é–“:\d{2}:\d{2}\]/, '')
            .replace(/\[YouTube:[^\]]+\]/, '')
            .replace(/\[åˆ†é¡:[^\]]+\]/, '')
            .replace(/\[ä¸»é¡Œ:[^\]]+\]/g, '')
            .trim();
          
          // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„ç¯€ç›®ï¼ˆé¿å…é‡è¤‡è¼‰å…¥ï¼‰
          // 1. é¦–å…ˆæª¢æŸ¥æ˜¯å¦æœ‰ç›¸åŒçš„ Contentful ID
          const existingEventIndex = events[airDate].findIndex(event => event.contentfulId === item.sys.id);
          if (existingEventIndex !== -1) {
            console.log('âš ï¸ ç™¼ç¾é‡è¤‡ ID ç¯€ç›®ï¼Œæ›´æ–°ç¾æœ‰ç¯€ç›®:', time, fields.title);
            // æ›´æ–°ç¾æœ‰ç¯€ç›®
            events[airDate][existingEventIndex] = {
              id: item.sys.id,
              title: fields.title || 'æœªå‘½åç¯€ç›®',
              time: time,
              duration: duration,
              category: category,
              description: cleanDescription,
              videoType: youtubeId ? 'YouTube' : (fields.videoType || 'YouTube'),
              youtubeId: youtubeId,
              thumbnail: thumbnail,
              status: status,
              topics: topics,
              published: true,
              publishedAt: item.sys.createdAt,
              contentfulId: item.sys.id
            };
          } else {
            // 2. æª¢æŸ¥æ˜¯å¦æœ‰å®Œå…¨ç›¸åŒçš„ç¯€ç›®ï¼ˆç›¸åŒæ™‚é–“ã€æ¨™é¡Œã€YouTube IDï¼‰
            // é€™æœƒè™•ç†ç·¨è¼¯å¾Œé‡æ–°ä¸Šæ¶é€ æˆçš„é‡è¤‡å•é¡Œ
            const duplicateEventIndex = events[airDate].findIndex(event => 
              event.time === time && 
              event.title === (fields.title || 'æœªå‘½åç¯€ç›®') && 
              event.youtubeId === youtubeId &&
              event.description === cleanDescription
            );
            
            if (duplicateEventIndex !== -1) {
              console.log('âš ï¸ ç™¼ç¾å®Œå…¨ç›¸åŒç¯€ç›®ï¼ˆå¯èƒ½æ˜¯ç·¨è¼¯å¾Œé‡æ–°ä¸Šæ¶ï¼‰ï¼Œè·³éé‡è¤‡:', time, fields.title, youtubeId);
              // è·³éé‡è¤‡çš„ç¯€ç›®ï¼Œä½†ä¿ç•™æœ€æ–°çš„ Contentful ID ä»¥ä¾¿å¾ŒçºŒæ›´æ–°
              events[airDate][duplicateEventIndex].contentfulId = item.sys.id;
              events[airDate][duplicateEventIndex].publishedAt = item.sys.createdAt;
            } else {
              // æ·»åŠ æ–°ç¯€ç›®ï¼ˆå…è¨±ç›¸åŒæ™‚é–“æœ‰ä¸åŒçš„ç¯€ç›®ï¼‰
              console.log('âœ… æ·»åŠ æ–°ç¯€ç›®:', time, fields.title);
          events[airDate].push({
            id: item.sys.id,
            title: fields.title || 'æœªå‘½åç¯€ç›®',
            time: time,
            duration: duration,
            category: category,
            description: cleanDescription,
            videoType: youtubeId ? 'YouTube' : (fields.videoType || 'YouTube'),
            youtubeId: youtubeId,
            thumbnail: thumbnail,
            status: status,
            topics: topics,
            published: true,
            publishedAt: item.sys.createdAt,
            contentfulId: item.sys.id
          });
            }
          }
        });

        // æŒ‰æ™‚é–“æ’åºï¼ˆä¸ç§»é™¤é‡è¤‡ç¯€ç›®ï¼Œå…è¨±ç›¸åŒæ™‚é–“æœ‰å¤šå€‹ç¯€ç›®ï¼‰
        Object.keys(events).forEach(date => {
          events[date].sort((a, b) => a.time.localeCompare(b.time));
          console.log(`ğŸ“… ${date}: è¼‰å…¥ ${events[date].length} å€‹ç¯€ç›®`);
        });

        // é‡æ–°æ¸²æŸ“æ—¥æ›†è¦–åœ–ï¼ˆç›´æ¥ä½¿ç”¨ Contentful æ•¸æ“šï¼‰
        renderCurrentView();
        
        console.log('âœ… å¾ Contentful è¼‰å…¥ç¯€ç›®æˆåŠŸ');
        showStatus('âœ… å·²å¾ Contentful è¼‰å…¥ç¯€ç›®', 'success');
        
        return true;
      } catch (error) {
        console.error('âŒ å¾ Contentful è¼‰å…¥ç¯€ç›®å¤±æ•—:', error);
        console.error('éŒ¯èª¤è©³æƒ…:', {
          message: error.message,
          status: error.status,
          statusText: error.statusText,
          details: error.details
        });
        showStatus('âš ï¸ å¾ Contentful è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™', 'warning');
        throw error;
      }
    }

    // è½‰æ›æ™‚æ®µç‚ºå…·é«”æ™‚é–“
    function convertBlockToTime(block) {
      switch (block) {
        case '00-06': return '02:00';
        case '06-12': return '11:30';
        case '12-18': return '14:00'; // é è¨­å€¼ï¼Œä½†å¯¦éš›æ™‚é–“æ‡‰è©²å¾ notes ä¸­æå–
        case '18-24': return '22:00';
        default: return '14:00';
      }
    }

    function debugEvents() {
      console.log('=== ç¯€ç›®è³‡æ–™èª¿è©¦ ===');
      console.log('æ‰€æœ‰ç¯€ç›®è³‡æ–™:', events);

      const eventDates = Object.keys(events);
      console.log('æœ‰ç¯€ç›®çš„æ—¥æœŸ:', eventDates);

      eventDates.forEach(date => {
        const dayEvents = events[date];
        console.log(`æ—¥æœŸ ${date} (${new Date(date).toLocaleDateString('zh-TW')}):`, dayEvents);
        
        // æª¢æŸ¥æ¯å€‹ç¯€ç›®çš„ YouTube ID
        dayEvents.forEach(event => {
          if (event.youtubeId) {
            console.log(`âœ… ç¯€ç›® "${event.title}" æœ‰ YouTube ID: ${event.youtubeId}`);
          } else {
            console.log(`âŒ ç¯€ç›® "${event.title}" æ²’æœ‰ YouTube ID`);
          }
        });
        
        // æª¢æŸ¥é‡è¤‡æ™‚é–“æ§½
        const timeGroups = {};
        dayEvents.forEach(event => {
          if (!timeGroups[event.time]) {
            timeGroups[event.time] = [];
          }
          timeGroups[event.time].push(event);
        });
        
        Object.keys(timeGroups).forEach(time => {
          if (timeGroups[time].length > 1) {
            console.log(`âš ï¸ ç™¼ç¾é‡è¤‡æ™‚é–“æ§½ ${time}:`, timeGroups[time].map(e => e.title));
          }
        });
      });

      const today = new Date();
      const todayString = today.getFullYear() + '-' +
                         String(today.getMonth() + 1).padStart(2, '0') + '-' +
                         String(today.getDate()).padStart(2, '0');
      const currentDateString = currentDate.getFullYear() + '-' +
                               String(currentDate.getMonth() + 1).padStart(2, '0') + '-' +
                               String(currentDate.getDate()).padStart(2, '0');
      console.log('ä»Šå¤©æ—¥æœŸ:', todayString);
      console.log('ç•¶å‰é¡¯ç¤ºæ—¥æœŸ:', currentDateString);

      showStatus('èª¿è©¦è³‡è¨Šå·²è¼¸å‡ºåˆ°æ§åˆ¶å°', 'info');
    }

    async function syncAllToContentful() {
      try {
        showStatus('æ­£åœ¨æª¢æŸ¥ Contentful çœŸå¯¦é€£ç·š...', 'info');
        
        // å…ˆæ¸…ç†æ¸¬è©¦è³‡æ–™
        const removedCount = clearOldTestData();
        if (removedCount > 0) {
          showStatus(`å·²æ¸…ç† ${removedCount} å€‹æ¸¬è©¦ç¯€ç›®ï¼Œç¹¼çºŒåŒæ­¥...`, 'info');
        }

        // æª¢æŸ¥ Management SDK æ˜¯å¦è¼‰å…¥
        if (typeof contentfulManagement === 'undefined') {
          throw new Error('Management SDK æœªè¼‰å…¥ï¼Œè«‹å…ˆè¼‰å…¥ Management SDK');
        }

        if (typeof window.contentfulManagement === 'undefined') {
          throw new Error('window.contentfulManagement ä¸å¯ç”¨');
        }

        showStatus('âœ… Contentful çœŸå¯¦é€£ç·šæˆåŠŸï¼Œé–‹å§‹åŒæ­¥...', 'success');

        const calendarEvents = JSON.parse(localStorage.getItem('calendar_events') || '{}');
        const allPrograms = [];

        Object.keys(calendarEvents).forEach(date => {
          calendarEvents[date].forEach(event => {
            allPrograms.push({
              title: event.title,
              airDate: date,
              airTime: event.time,
              duration: event.duration,
              category: event.category,
              description: event.description || '',
              status: event.status,
              videoType: event.videoType || '',
              youtubeId: event.youtubeId || '',
              mp4File: event.mp4File || ''
            });
          });
        });

        if (allPrograms.length === 0) {
          showStatus('æ²’æœ‰ç¯€ç›®éœ€è¦åŒæ­¥', 'warning');
          return;
        }

        showStatus(`é–‹å§‹åŒæ­¥ ${allPrograms.length} å€‹ç¯€ç›®åˆ° Contentful...`, 'info');

        let successCount = 0;
        let failCount = 0;

        let skipCount = 0;
        
        for (const program of allPrograms) {
          try {
            console.log('æ­£åœ¨ä¸Šæ¶ç¯€ç›®:', program);
            const result = await uploadProgramSimple(program);
            if (result.success) {
              if (result.skipped) {
                skipCount++;
                console.log('â­ï¸ ç¯€ç›®å·²å­˜åœ¨ï¼Œè·³é:', program.title, result.entryId);
              } else {
                successCount++;
                console.log('âœ… ç¯€ç›®ä¸Šæ¶æˆåŠŸ:', program.title, result.entryId);
              }
            } else {
              failCount++;
              console.error('âŒ åŒæ­¥ç¯€ç›®å¤±æ•—:', program.title, result.error);
            }
          } catch (error) {
            console.error('âŒ åŒæ­¥ç¯€ç›®ç•°å¸¸:', program.title, error);
            failCount++;
          }
        }

        if (failCount === 0) {
          if (skipCount > 0) {
            showStatus(`âœ… åŒæ­¥å®Œæˆï¼š${successCount} å€‹æ–°ç¯€ç›®ä¸Šæ¶æˆåŠŸï¼Œ${skipCount} å€‹é‡è¤‡ç¯€ç›®å·²è·³é`, 'success');
          } else {
            showStatus(`âœ… æ‰€æœ‰ ${successCount} å€‹ç¯€ç›®åŒæ­¥æˆåŠŸåˆ° Contentfulï¼`, 'success');
          }
        } else {
          showStatus(`âš ï¸ åŒæ­¥å®Œæˆï¼š${successCount} æˆåŠŸï¼Œ${skipCount} è·³éï¼Œ${failCount} å¤±æ•—`, 'warning');
        }

        console.log('åŒæ­¥çµæœ:', { successCount, skipCount, failCount });

      } catch (error) {
        console.error('æ‰¹é‡åŒæ­¥å¤±æ•—:', error);
        showStatus('âŒ æ‰¹é‡åŒæ­¥å¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    async function showAllVideos() {
      try {
        showStatus('æ­£åœ¨è¼‰å…¥æ‰€æœ‰å½±ç‰‡è³‡æ–™...', 'info');
        
        // å‰µå»º Contentful å®¢æˆ¶ç«¯
        const client = contentful.createClient({
          space: 'os5wf90ljenp',
          accessToken: 'lODH-WLwHwVZv7O4rFdBWjSnrzaQWGD4koeOZ1Dypj0'
        });

        // ç²å–æ‰€æœ‰å½±ç‰‡
        const response = await client.getEntries({
          content_type: 'video',
          order: '-sys.updatedAt',
          limit: 1000
        });

        const videos = response.items || [];
        
        if (videos.length === 0) {
          showStatus('æ²’æœ‰æ‰¾åˆ°ä»»ä½•å½±ç‰‡', 'warning');
          return;
        }

        showStatus(`æ‰¾åˆ° ${videos.length} å€‹å½±ç‰‡`, 'success');

        // å‰µå»ºæ¨¡æ…‹æ¡†
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'videoManagementModal';
        modal.style.display = 'block';
        modal.style.zIndex = '10000';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.style.padding = '10px';
        modal.style.overflowY = 'auto';

        // è™•ç†å½±ç‰‡è³‡æ–™
        const processedVideos = videos.map(video => {
          const fields = video.fields || {};
          const pick = (obj, keys) => {
            for (const k of keys) {
              if (obj && obj[k] != null && obj[k] !== '') return obj[k];
            }
            return '';
          };

          const title = pick(fields, ['title']);
          const description = pick(fields, ['description']);
          const youtubeId = pick(fields, ['youTubeId']);
          const mp4Url = pick(fields, ['mp4Url']);
          const tags = Array.isArray(fields.tags) ? fields.tags : [];
          // æª¢æŸ¥ HERO å½±ç‰‡æ¨™è¨˜ï¼ˆä½¿ç”¨ isHero æ¬„ä½ï¼‰
          const isHero = fields.isHero === true || 
                        fields.isHero === 'true' || 
                        fields.isHero === 1 || 
                        fields.isHero === '1' ||
                        fields['isHero'] === true ||
                        fields['isHero'] === 'true' ||
                        fields['isHero'] === 1 ||
                        fields['isHero'] === '1' ||
                        false;
          
          // æª¢æŸ¥ç²¾é¸ç¯€ç›®æ¨è–¦æ¨™è¨˜ï¼ˆä½¿ç”¨ isFeatured æ¬„ä½ï¼‰
          const isFeatured = fields.isFeatured === true || 
                            fields.isFeatured === 'true' || 
                            fields.isFeatured === 1 || 
                            fields.isFeatured === '1' ||
                            fields['isFeatured'] === true ||
                            fields['isFeatured'] === 'true' ||
                            fields['isFeatured'] === 1 ||
                            fields['isFeatured'] === '1' ||
                            false;
          
          // èª¿è©¦ä¿¡æ¯ï¼šæª¢æŸ¥å…©å€‹æ¬„ä½
          if (fields.isHero !== undefined || fields.isFeatured !== undefined) {
            console.log('ğŸ” å½±ç‰‡ç‹€æ…‹æª¢æŸ¥:', {
              title: title,
              isHero: fields.isHero,
              isHeroType: typeof fields.isHero,
              isFeatured: fields.isFeatured,
              isFeaturedType: typeof fields.isFeatured,
              isHeroResult: isHero,
              isFeaturedResult: isFeatured
            });
          }
          
          const category = pick(fields, ['category', 'åˆ†é¡']);
          
          let thumbnail = fields.thumbnail?.fields?.file?.url || '';
          if (thumbnail && !thumbnail.startsWith('http')) {
            thumbnail = 'https:' + thumbnail;
          }
          if (!thumbnail && youtubeId) {
            thumbnail = `https://i.ytimg.com/vi/${youtubeId}/hqdefault.jpg`;
          }

          return {
            id: video.sys.id,
            title: title || 'æœªå‘½åå½±ç‰‡',
            description: description || '',
            youtubeId: youtubeId || '',
            mp4Url: mp4Url || '',
            tags: tags,
            isHero: isHero,
            isFeatured: isFeatured,
            category: category || 'æœªåˆ†é¡',
            thumbnail: thumbnail || 'https://images.unsplash.com/photo-1485846234645-a62644f84728?w=400&h=225&fit=crop',
            createdAt: video.sys.createdAt,
            updatedAt: video.sys.updatedAt
          };
        });

        // å‰µå»ºæœç´¢å’Œç¯©é¸ç•Œé¢
        const searchHtml = `
          <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
              <input type="text" id="videoSearch" placeholder="æœç´¢å½±ç‰‡æ¨™é¡Œ..." 
                     style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <select id="categoryFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">æ‰€æœ‰åˆ†é¡</option>
                <option value="äºæ´²">äºæ´²</option>
                <option value="æ­æ´²">æ­æ´²</option>
                <option value="åŒ—ç¾æ´²">åŒ—ç¾æ´²</option>
                <option value="å—ç¾æ´²">å—ç¾æ´²</option>
                <option value="éæ´²">éæ´²</option>
                <option value="å¤§æ´‹æ´²">å¤§æ´‹æ´²</option>
                <option value="å—æ¥µæ´²">å—æ¥µæ´²</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
              </select>
              <select id="heroFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">æ‰€æœ‰å½±ç‰‡</option>
                <option value="hero">ğŸ† HERO å½±ç‰‡</option>
                <option value="normal">ä¸€èˆ¬å½±ç‰‡</option>
              </select>
              <select id="featuredFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">æ‰€æœ‰å½±ç‰‡</option>
                <option value="featured">â­ ç²¾é¸ç¯€ç›®æ¨è–¦</option>
                <option value="normal">ä¸€èˆ¬å½±ç‰‡</option>
              </select>
              <button onclick="filterVideos()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                ğŸ” ç¯©é¸
              </button>
              <button onclick="clearFilters()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                ğŸ”„ æ¸…é™¤
              </button>
            </div>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
              <span style="color: #666;">å…± <strong id="videoCount">${processedVideos.length}</strong> å€‹å½±ç‰‡</span>
              <span style="color: #666;">ğŸ† HERO å½±ç‰‡: <strong id="heroCount" style="color: #ff6b6b;">${processedVideos.filter(v => v.isHero).length}</strong></span>
              <span style="color: #666;">â­ ç²¾é¸ç¯€ç›®æ¨è–¦: <strong id="featuredCount" style="color: #ffc107;">${processedVideos.filter(v => v.isFeatured).length}</strong></span>
              <span style="color: #666;">ä¸€èˆ¬å½±ç‰‡: <strong id="normalCount">${processedVideos.filter(v => !v.isHero && !v.isFeatured).length}</strong></span>
            </div>
          </div>
        `;

        // å‰µå»ºå½±ç‰‡åˆ—è¡¨
        const videosHtml = processedVideos.map(video => `
          <div class="video-item" data-video-id="${video.id}" data-title="${video.title.toLowerCase()}" data-category="${video.category}" data-hero="${video.isHero ? 'hero' : 'normal'}" data-featured="${video.isFeatured ? 'featured' : 'normal'}" 
               style="border: ${video.isHero ? '2px solid #ffd93d' : '1px solid #eee'}; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: ${video.isHero ? 'linear-gradient(135deg, #fff9e6 0%, #ffffff 100%)' : 'white'}; display: flex; gap: 15px; box-shadow: ${video.isHero ? '0 4px 12px rgba(255, 215, 0, 0.3)' : 'none'};">
            <div style="flex-shrink: 0;">
              <img src="${video.thumbnail}" alt="${video.title}" 
                   style="width: 120px; height: 68px; object-fit: cover; border-radius: 4px; cursor: pointer;"
                   onclick="window.open('${video.youtubeId ? `https://www.youtube.com/watch?v=${video.youtubeId}` : video.mp4Url || '#'}', '_blank')">
            </div>
            <div style="flex: 1; min-width: 0;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <h4 style="margin: 0; color: #333; font-size: 1.1rem; line-height: 1.3;">
                  ${video.isHero ? '<span style="background: linear-gradient(45deg, #ff6b6b, #ffd93d); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-right: 8px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">ğŸ† HERO</span>' : ''}${video.title}
                </h4>
                <div style="display: flex; gap: 5px; flex-shrink: 0;">
                  ${video.isFeatured ? '<span style="background: #ffc107; color: #000; padding: 2px 6px; border-radius: 12px; font-size: 0.7rem; font-weight: bold;">â­ ç²¾é¸</span>' : ''}
                  <span style="background: #007bff; color: white; padding: 2px 6px; border-radius: 12px; font-size: 0.7rem;">${video.category}</span>
                </div>
              </div>
              <div style="color: #666; font-size: 0.9rem; margin-bottom: 8px; line-height: 1.4;">
                ${video.description ? video.description : '<span style="color: #999; font-style: italic;">ğŸ“ é»æ“Šã€Œç·¨è¼¯ã€æŒ‰éˆ•æ·»åŠ å½±ç‰‡æè¿°</span>'}
              </div>
              <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 8px;">
                ${video.youtubeId ? `<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 12px; font-size: 0.7rem;">ğŸ“º YouTube</span>` : ''}
                ${video.mp4Url ? `<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 12px; font-size: 0.7rem;">ğŸ¬ MP4</span>` : ''}
                ${video.tags.length > 0 ? `<span style="background: #6f42c1; color: white; padding: 2px 6px; border-radius: 12px; font-size: 0.7rem;">ğŸ·ï¸ ${video.tags.length} æ¨™ç±¤</span>` : ''}
              </div>
              <div style="color: #999; font-size: 0.8rem;">
                å»ºç«‹: ${new Date(video.createdAt).toLocaleDateString('zh-TW')} | 
                æ›´æ–°: ${new Date(video.updatedAt).toLocaleDateString('zh-TW')}
              </div>
            </div>
            <div style="flex-shrink: 0; display: flex; flex-direction: column; gap: 5px;">
              <button onclick="toggleFeatured('${video.id}', ${!video.isFeatured})" 
                      style="background: ${video.isFeatured ? '#dc3545' : '#28a745'}; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                ${video.isFeatured ? 'âŒ å–æ¶ˆç²¾é¸' : 'â­ è¨­ç‚ºç²¾é¸'}
              </button>
              <button onclick="editVideo('${video.id}')" 
                      style="background: #ffc107; color: #000; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                âœï¸ ç·¨è¼¯
              </button>
              <button onclick="deleteVideo('${video.id}', '${video.title}')" 
                      style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                ğŸ—‘ï¸ åˆªé™¤
              </button>
            </div>
          </div>
        `).join('');

        modal.innerHTML = `
          <div class="modal-content" id="videoModalContent" style="width: 98vw; max-width: 1400px; height: 95vh; max-height: 95vh; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative; margin: auto; display: flex; flex-direction: column;">
            <div class="modal-header" id="videoModalHeader" style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border-radius: 8px 8px 0 0;">
              <h3 style="margin: 0; color: #333;">ğŸ¬ æ‰€æœ‰å½±ç‰‡ç®¡ç† (${processedVideos.length} å€‹)</h3>
              <div style="display: flex; gap: 10px; align-items: center;">
                <button class="modal-close" onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
              </div>
            </div>
            <div id="videoScrollContainer" style="flex: 1; overflow-y: auto; overflow-x: hidden; padding: 0 20px 20px; min-height: 0;">
              <style>
                #videoScrollContainer::-webkit-scrollbar {
                  width: 8px;
                }
                #videoScrollContainer::-webkit-scrollbar-track {
                  background: #f1f1f1;
                  border-radius: 4px;
                }
                #videoScrollContainer::-webkit-scrollbar-thumb {
                  background: #c1c1c1;
                  border-radius: 4px;
                }
                #videoScrollContainer::-webkit-scrollbar-thumb:hover {
                  background: #a8a8a8;
                }
              </style>
              ${searchHtml}
              <div id="videoList">
                ${videosHtml}
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // ç§»é™¤æ‹–æ‹½å’Œèª¿æ•´å¤§å°åŠŸèƒ½ï¼Œä¿æŒæ¨¡æ…‹æ¡†å›ºå®šç½®ä¸­

        // æ·»åŠ ç¯©é¸åŠŸèƒ½
        window.filterVideos = function() {
          const searchTerm = document.getElementById('videoSearch').value.toLowerCase();
          const categoryFilter = document.getElementById('categoryFilter').value;
          const heroFilter = document.getElementById('heroFilter').value;
          const featuredFilter = document.getElementById('featuredFilter').value;
          
          const videoItems = document.querySelectorAll('.video-item');
          let visibleCount = 0;
          let heroCount = 0;
          let featuredCount = 0;
          let normalCount = 0;
          
          videoItems.forEach(item => {
            const title = item.dataset.title;
            const category = item.dataset.category;
            const hero = item.dataset.hero;
            const featured = item.dataset.featured;
            
            const matchesSearch = !searchTerm || title.includes(searchTerm);
            const matchesCategory = !categoryFilter || category === categoryFilter;
            const matchesHero = !heroFilter || hero === heroFilter;
            const matchesFeatured = !featuredFilter || featured === featuredFilter;
            
            if (matchesSearch && matchesCategory && matchesHero && matchesFeatured) {
              item.style.display = 'flex';
              visibleCount++;
              if (hero === 'hero') heroCount++;
              if (featured === 'featured') featuredCount++;
              if (hero === 'normal' && featured === 'normal') normalCount++;
            } else {
              item.style.display = 'none';
            }
          });
          
          document.getElementById('videoCount').textContent = visibleCount;
          document.getElementById('heroCount').textContent = heroCount;
          document.getElementById('featuredCount').textContent = featuredCount;
          document.getElementById('normalCount').textContent = normalCount;
        };

        window.clearFilters = function() {
          document.getElementById('videoSearch').value = '';
          document.getElementById('categoryFilter').value = '';
          document.getElementById('heroFilter').value = '';
          document.getElementById('featuredFilter').value = '';
          window.filterVideos();
        };

        // æ·»åŠ ç²¾é¸ç¯€ç›®æ¨è–¦åˆ‡æ›åŠŸèƒ½
        window.toggleFeatured = async function(videoId, newFeaturedStatus) {
          try {
            console.log('ğŸ¯ toggleFeatured å‡½æ•¸è¢«èª¿ç”¨:', { videoId, newFeaturedStatus });
            showStatus('æ­£åœ¨æ›´æ–°ç²¾é¸ç¯€ç›®æ¨è–¦ç‹€æ…‹...', 'info');
            
            // æª¢æŸ¥ Management SDK
            console.log('ğŸ” æª¢æŸ¥ Management SDK:', typeof contentfulManagement);
            if (typeof contentfulManagement === 'undefined') {
              console.log('ğŸ“¥ è¼‰å…¥ Management SDK...');
              await loadManagementSDK();
            }
            
            if (typeof contentfulManagement === 'undefined') {
              console.error('âŒ Management SDK è¼‰å…¥å¤±æ•—');
              throw new Error('Management SDK è¼‰å…¥å¤±æ•—');
            }
            
            // ç²å– Management Token
            const managementToken = window.CONTENTFUL_CONFIG?.MANAGEMENT_TOKEN || window.CONTENTFUL_MANAGEMENT_TOKEN;
            console.log('ğŸ”‘ Management Token ç‹€æ…‹:', managementToken ? 'å·²è¨­å®š' : 'æœªè¨­å®š');
            
            if (!managementToken) {
              console.error('âŒ Management Token æœªè¨­å®š');
              throw new Error('Management Token æœªè¨­å®š');
            }
            
            // å‰µå»º Management å®¢æˆ¶ç«¯
            const client = contentfulManagement.createClient({
              accessToken: managementToken
            });
            
            const space = await client.getSpace('os5wf90ljenp');
            const environment = await space.getEnvironment('master');
            const entry = await environment.getEntry(videoId);
            
            // æ›´æ–° isFeatured æ¬„ä½
            entry.fields.isFeatured = { 'en-US': newFeaturedStatus };
            
            // èª¿è©¦ï¼šæª¢æŸ¥æ‰€æœ‰å¯ç”¨æ¬„ä½
            console.log('ğŸ” æª¢æŸ¥æ¢ç›®æ‰€æœ‰æ¬„ä½:', Object.keys(entry.fields));
            console.log('ğŸ” æ¢ç›®å®Œæ•´è³‡æ–™:', entry.fields);
            
            // å¦‚æœè¨­ç‚ºç²¾é¸ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰ç²¾é¸èªªæ˜æ–‡å­—æ¬„ä½
            if (newFeaturedStatus) {
              // æª¢æŸ¥å¯èƒ½çš„ç²¾é¸èªªæ˜æ–‡å­—æ¬„ä½åç¨±
              const possibleFeaturedDescFields = [
                'ç²¾é¸æ¨è–¦å½±ç‰‡èªªæ˜æ–‡å­—',
                'featuredDescription', 
                'featuredText',
                'ç²¾é¸èªªæ˜',
                'ç²¾é¸æè¿°'
              ];
              
              let featuredDescField = null;
              for (const fieldName of possibleFeaturedDescFields) {
                if (entry.fields[fieldName]) {
                  featuredDescField = fieldName;
                  console.log(`âœ… æ‰¾åˆ°ç²¾é¸èªªæ˜æ¬„ä½: ${fieldName}`);
                  break;
                }
              }
              
              if (featuredDescField) {
                const currentFeaturedDesc = entry.fields[featuredDescField];
                const currentDesc = entry.fields.description;
                
                if (!currentFeaturedDesc && currentDesc) {
                  entry.fields[featuredDescField] = { 'en-US': currentDesc['en-US'] || currentDesc };
                  console.log(`âœ… å·²è¨­å®šç²¾é¸èªªæ˜æ–‡å­—åˆ°æ¬„ä½: ${featuredDescField}`);
                }
              } else {
                console.log('âš ï¸ æœªæ‰¾åˆ°ç²¾é¸èªªæ˜æ–‡å­—æ¬„ä½ï¼Œè·³éè¨­å®š');
              }
            }
            
            // ç™¼å¸ƒæ›´æ–°
            const updatedEntry = await entry.update();
            await updatedEntry.publish();
            
            // æ›´æ–° UI - é€šé videoId æ‰¾åˆ°å°æ‡‰çš„æŒ‰éˆ•
            const videoItem = document.querySelector(`[data-video-id="${videoId}"]`);
            console.log('ğŸ” æ‰¾åˆ°çš„ videoItem:', videoItem);
            
            const button = videoItem ? videoItem.querySelector('button[onclick*="toggleFeatured"]') : null;
            console.log('ğŸ” æ‰¾åˆ°çš„ button:', button);
            
            if (button) {
              if (newFeaturedStatus) {
                button.textContent = 'âŒ å–æ¶ˆç²¾é¸';
                button.style.background = '#dc3545';
              
                // æ·»åŠ ç²¾é¸æ¨™è¨˜
                const badgeContainer = videoItem.querySelector('div[style*="flex-shrink: 0"]');
                if (badgeContainer && !badgeContainer.innerHTML.includes('â­ ç²¾é¸')) {
                  badgeContainer.insertAdjacentHTML('afterbegin', '<span style="background: #ffc107; color: #000; padding: 2px 6px; border-radius: 12px; font-size: 0.7rem; font-weight: bold;">â­ ç²¾é¸</span>');
                }
              } else {
                button.textContent = 'â­ è¨­ç‚ºç²¾é¸';
                button.style.background = '#28a745';
                
                // ç§»é™¤ç²¾é¸æ¨™è¨˜
                const featuredBadge = videoItem.querySelector('span[style*="ffc107"]');
                if (featuredBadge) {
                  featuredBadge.remove();
                }
              }
            } else {
              console.warn('âš ï¸ æ‰¾ä¸åˆ°æŒ‰éˆ•å…ƒç´ ï¼Œè·³é UI æ›´æ–°');
            }
            
            // æ›´æ–°çµ±è¨ˆæ•¸å­—
            const featuredCount = document.querySelectorAll('.video-item[data-featured="featured"]').length;
            document.getElementById('featuredCount').textContent = featuredCount;
            
            // é¡¯ç¤ºæˆåŠŸé€šçŸ¥
            let statusMessage;
            if (newFeaturedStatus) {
              statusMessage = 'âœ… å½±ç‰‡å·²è¨­ç‚ºç²¾é¸ç¯€ç›®æ¨è–¦';
            } else {
              statusMessage = 'âœ… å·²å–æ¶ˆç²¾é¸ç¯€ç›®æ¨è–¦';
            }
            showStatus(statusMessage, 'success');
            
            // é¡å¤–çš„è¦–è¦ºåé¥‹
            const originalText = button.textContent;
            button.textContent = 'âœ… å®Œæˆ';
            button.style.background = '#28a745';
            setTimeout(() => {
              button.textContent = originalText;
              button.style.background = newFeaturedStatus ? '#dc3545' : '#28a745';
            }, 2000);
          } catch (error) {
            console.error('âŒ æ›´æ–°ç²¾é¸ç¯€ç›®æ¨è–¦ç‹€æ…‹å¤±æ•—:', error);
            console.error('éŒ¯èª¤è©³æƒ…:', {
              message: error.message,
              stack: error.stack,
              name: error.name
            });
            showStatus('æ›´æ–°ç²¾é¸ç¯€ç›®æ¨è–¦ç‹€æ…‹å¤±æ•—: ' + error.message, 'error');
          }
        };

        // å¾ç·¨è¼¯é é¢è¨­ç‚ºç²¾é¸çš„åŠŸèƒ½
        window.toggleFeaturedFromEdit = async function(newFeaturedStatus) {
          try {
            const videoId = window.currentEditingVideoId;
            if (!videoId) {
              showStatus('âŒ ç„¡æ³•ç²å–å½±ç‰‡ ID', 'error');
              return;
            }

            showStatus('æ­£åœ¨æ›´æ–°ç²¾é¸ç¯€ç›®æ¨è–¦ç‹€æ…‹...', 'info');
            
            // æª¢æŸ¥ Management SDK
            if (typeof contentfulManagement === 'undefined') {
              await loadManagementSDK();
            }
            
            if (typeof contentfulManagement === 'undefined') {
              throw new Error('Management SDK è¼‰å…¥å¤±æ•—');
            }
            
            // ç²å– Management Token
            const managementToken = window.CONTENTFUL_CONFIG?.MANAGEMENT_TOKEN || window.CONTENTFUL_MANAGEMENT_TOKEN;
            
            if (!managementToken) {
              throw new Error('Management Token æœªè¨­å®š');
            }
            
            // å‰µå»º Management å®¢æˆ¶ç«¯
            const client = contentfulManagement.createClient({
              accessToken: managementToken
            });
            
            const space = await client.getSpace('os5wf90ljenp');
            const environment = await space.getEnvironment('master');
            const entry = await environment.getEntry(videoId);
            
            // æ›´æ–° isFeatured æ¬„ä½
            entry.fields.isFeatured = { 'en-US': newFeaturedStatus };
            
            // èª¿è©¦ï¼šæª¢æŸ¥æ‰€æœ‰å¯ç”¨æ¬„ä½
            console.log('ğŸ” æª¢æŸ¥æ¢ç›®æ‰€æœ‰æ¬„ä½:', Object.keys(entry.fields));
            console.log('ğŸ” æ¢ç›®å®Œæ•´è³‡æ–™:', entry.fields);
            
            // å¦‚æœè¨­ç‚ºç²¾é¸ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰ç²¾é¸èªªæ˜æ–‡å­—æ¬„ä½
            if (newFeaturedStatus) {
              // æª¢æŸ¥å¯èƒ½çš„ç²¾é¸èªªæ˜æ–‡å­—æ¬„ä½åç¨±
              const possibleFeaturedDescFields = [
                'ç²¾é¸æ¨è–¦å½±ç‰‡èªªæ˜æ–‡å­—',
                'featuredDescription', 
                'featuredText',
                'ç²¾é¸èªªæ˜',
                'ç²¾é¸æè¿°'
              ];
              
              let featuredDescField = null;
              for (const fieldName of possibleFeaturedDescFields) {
                if (entry.fields[fieldName]) {
                  featuredDescField = fieldName;
                  console.log(`âœ… æ‰¾åˆ°ç²¾é¸èªªæ˜æ¬„ä½: ${fieldName}`);
                  break;
                }
              }
              
              if (featuredDescField) {
                const currentFeaturedDesc = entry.fields[featuredDescField];
                const currentDesc = entry.fields.description;
                
                if (!currentFeaturedDesc && currentDesc) {
                  entry.fields[featuredDescField] = { 'en-US': currentDesc['en-US'] || currentDesc };
                  console.log(`âœ… å·²è¨­å®šç²¾é¸èªªæ˜æ–‡å­—åˆ°æ¬„ä½: ${featuredDescField}`);
                }
              } else {
                console.log('âš ï¸ æœªæ‰¾åˆ°ç²¾é¸èªªæ˜æ–‡å­—æ¬„ä½ï¼Œè·³éè¨­å®š');
              }
            }
            
            // ç™¼å¸ƒæ›´æ–°
            const updatedEntry = await entry.update();
            await updatedEntry.publish();
            
            // æ›´æ–°ç·¨è¼¯é é¢çš„ UI
            const featuredStatusDiv = document.getElementById('featuredStatus');
            const setFeaturedBtn = document.getElementById('setFeaturedBtn');
            
            if (newFeaturedStatus) {
              featuredStatusDiv.style.display = 'block';
              setFeaturedBtn.style.display = 'none';
            } else {
              featuredStatusDiv.style.display = 'none';
              setFeaturedBtn.style.display = 'inline-block';
            }
            
            // é¡¯ç¤ºæˆåŠŸé€šçŸ¥
            const statusMessage = newFeaturedStatus ? 
              'âœ… å½±ç‰‡å·²è¨­ç‚ºç²¾é¸ç¯€ç›®æ¨è–¦ï¼Œèªªæ˜æ–‡å­—å·²æ“·å–' : 
              'âœ… å·²å–æ¶ˆç²¾é¸ç¯€ç›®æ¨è–¦';
            showStatus(statusMessage, 'success');
            
          } catch (error) {
            console.error('âŒ æ›´æ–°ç²¾é¸ç¯€ç›®æ¨è–¦ç‹€æ…‹å¤±æ•—:', error);
            showStatus('æ›´æ–°ç²¾é¸ç¯€ç›®æ¨è–¦ç‹€æ…‹å¤±æ•—: ' + error.message, 'error');
          }
        };

        // è¼‰å…¥ç¯€ç›®æ’­å‡ºæ­·å²
        window.loadBroadcastHistory = function(videoId) {
          try {
            const broadcastHistoryDiv = document.getElementById('broadcastHistory');
            const broadcastHistoryList = document.getElementById('broadcastHistoryList');
            
            if (!videoId) {
              broadcastHistoryDiv.style.display = 'none';
              return;
            }
            
            // å¾æœ¬åœ°å­˜å„²çš„ç¯€ç›®è¡¨ä¸­æŸ¥æ‰¾è©²å½±ç‰‡çš„æ’­å‡ºè¨˜éŒ„
            const calendarEvents = JSON.parse(localStorage.getItem('calendar_events') || '{}');
            const broadcastRecords = [];
            
            Object.keys(calendarEvents).forEach(date => {
              calendarEvents[date].forEach(event => {
                if (event.youtubeId && event.youtubeId === videoId) {
                  broadcastRecords.push({
                    date: date,
                    time: event.time,
                    title: event.title,
                    status: event.status
                  });
                }
              });
            });
            
            if (broadcastRecords.length > 0) {
              broadcastHistoryList.innerHTML = broadcastRecords.map(record => `
                <div style="padding: 5px 0; border-bottom: 1px solid #dee2e6;">
                  <strong>${record.date}</strong> ${record.time} - ${record.title}
                  <span style="background: ${record.status === 'é¦–æ’­' ? '#ffc107' : '#28a745'}; color: ${record.status === 'é¦–æ’­' ? '#000' : '#fff'}; padding: 2px 6px; border-radius: 12px; font-size: 0.7rem; margin-left: 8px;">${record.status}</span>
                </div>
              `).join('');
              broadcastHistoryDiv.style.display = 'block';
            } else {
              broadcastHistoryDiv.style.display = 'none';
            }
            
          } catch (error) {
            console.error('è¼‰å…¥æ’­å‡ºæ­·å²å¤±æ•—:', error);
            document.getElementById('broadcastHistory').style.display = 'none';
          }
        };


        // æ·»åŠ ç·¨è¼¯åŠŸèƒ½ - ä½¿ç”¨çµ±ä¸€çš„ç·¨è¼¯æ¨¡æ…‹æ¡†
        window.editVideo = async function(videoId) {
          try {
            showStatus('æ­£åœ¨è¼‰å…¥å½±ç‰‡è³‡æ–™...', 'info');
            
            // å‰µå»º Contentful å®¢æˆ¶ç«¯
            const client = contentful.createClient({
              space: 'os5wf90ljenp',
              accessToken: 'lODH-WLwHwVZv7O4rFdBWjSnrzaQWGD4koeOZ1Dypj0'
            });

            // ç²å–å½±ç‰‡è³‡æ–™
            const video = await client.getEntry(videoId);
            const fields = video.fields || {};
            
            const pick = (obj, keys) => {
              for (const k of keys) {
                if (obj && obj[k] != null && obj[k] !== '') return obj[k];
              }
              return '';
            };

            const currentData = {
              id: video.sys.id,
              title: pick(fields, ['title']) || '',
              description: pick(fields, ['description']) || '',
              youtubeId: pick(fields, ['youTubeId']) || '',
              mp4Url: pick(fields, ['mp4Url']) || '',
              tags: Array.isArray(fields.tags) ? fields.tags : [],
              isFeatured: fields.isFeatured || false,
              category: pick(fields, ['category', 'åˆ†é¡']) || 'æœªåˆ†é¡'
            };

            // ä½¿ç”¨çµ±ä¸€çš„ç·¨è¼¯æ¨¡æ…‹æ¡†
            document.getElementById('modalTitle').textContent = 'ç·¨è¼¯å½±ç‰‡';
            
            // ç§»é™¤ä¿®æ”¹æŒ‰éˆ•ç›¸é—œé‚è¼¯
            
            // å¡«å…¥å½±ç‰‡è³‡æ–™åˆ°è¡¨å–®
            document.getElementById('title').value = currentData.title;
            document.getElementById('description').value = currentData.description;
            document.getElementById('category').value = currentData.category;
            document.getElementById('youtubeId').value = currentData.youtubeId;
            document.getElementById('videoType').value = currentData.youtubeId ? 'YouTube' : (currentData.mp4Url ? 'MP4' : '');
            
            // è¨­å®šç¸®åœ–
            const thumbnailPreview = document.getElementById('thumbnailPreview');
            if (currentData.youtubeId) {
              const youtubeThumbnail = `https://img.youtube.com/vi/${currentData.youtubeId}/maxresdefault.jpg`;
              thumbnailPreview.src = youtubeThumbnail;
              thumbnailPreview.setAttribute('data-youtube-url', youtubeThumbnail);
            } else {
              thumbnailPreview.src = 'https://images.unsplash.com/photo-1485846234645-a62644f84728?w=400&h=225&fit=crop';
            }
            
            // è¨­å®šæ—¥æœŸå’Œæ™‚é–“ï¼ˆä½¿ç”¨ç•¶å‰æ—¥æœŸå’Œæ™‚é–“ï¼‰
            const now = new Date();
            const todayString = now.getFullYear() + '-' + 
                               String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(now.getDate()).padStart(2, '0');
            const currentTime = String(now.getHours()).padStart(2, '0') + ':' + 
                               String(now.getMinutes()).padStart(2, '0');
            
            document.getElementById('editDate').value = todayString;
            document.getElementById('editTime').value = currentTime;
            document.getElementById('airTime').value = currentTime;
            
            // è¨­å®šå…¶ä»–æ¬„ä½
            document.getElementById('duration').value = '30'; // é è¨­30åˆ†é˜
            document.getElementById('status').value = 'é¦–æ’­';
            
            // åˆ‡æ›å½±ç‰‡æ¬„ä½é¡¯ç¤º
            toggleVideoFields();
            
            // å„²å­˜å½±ç‰‡IDåˆ°å…¨åŸŸè®Šæ•¸ï¼Œä¾›å„²å­˜æ™‚ä½¿ç”¨
            window.currentEditingVideoId = videoId;
            window.currentEditingVideoData = currentData;
            
            // è¼‰å…¥æ’­å‡ºæ­·å²
            loadBroadcastHistory(videoId);
            
            // æª¢æŸ¥ä¸¦é¡¯ç¤ºç²¾é¸ç‹€æ…‹
            const isFeatured = currentData.isFeatured;
            const featuredStatusDiv = document.getElementById('featuredStatus');
            const setFeaturedBtn = document.getElementById('setFeaturedBtn');
            
            if (isFeatured) {
              featuredStatusDiv.style.display = 'block';
              setFeaturedBtn.style.display = 'none';
            } else {
              featuredStatusDiv.style.display = 'none';
              setFeaturedBtn.style.display = 'inline-block';
            }
            
            // é¡¯ç¤ºæ¨¡æ…‹æ¡†
            document.getElementById('eventModal').style.display = 'block';
            
            showStatus('å½±ç‰‡è³‡æ–™å·²è¼‰å…¥ï¼Œå¯ä»¥é–‹å§‹ç·¨è¼¯', 'success');
            
          } catch (error) {
            console.error('è¼‰å…¥å½±ç‰‡è³‡æ–™å¤±æ•—:', error);
            showStatus('è¼‰å…¥å½±ç‰‡è³‡æ–™å¤±æ•—: ' + error.message, 'error');
          }
        };

        // æª¢æŸ¥å½±ç‰‡ä½¿ç”¨æƒ…æ³ï¼ˆç§»åˆ°å…¨åŸŸç¯„åœï¼‰
        window.checkVideoUsage = async function(videoId, videoTitle) {
          try {
            const usage = {
              inSchedule: [],
              inFeatured: false,
              inContentful: false,
              totalUsage: 0
            };

            // æª¢æŸ¥ç¯€ç›®è¡¨ä¸­çš„ä½¿ç”¨æƒ…æ³
            const calendarEvents = JSON.parse(localStorage.getItem('calendar_events') || '{}');
            Object.keys(calendarEvents).forEach(date => {
              calendarEvents[date].forEach(event => {
                if (event.youtubeId && event.youtubeId === videoId) {
                  usage.inSchedule.push({
                    date: date,
                    time: event.time,
                    title: event.title,
                    status: event.status
                  });
                }
              });
            });

            // æª¢æŸ¥æ˜¯å¦ç‚ºç²¾é¸å½±ç‰‡
            const client = contentful.createClient({
              space: 'os5wf90ljenp',
              accessToken: 'lODH-WLwHwVZv7O4rFdBWjSnrzaQWGD4koeOZ1Dypj0'
            });

            try {
              const video = await client.getEntry(videoId);
              usage.inContentful = true;
              usage.inFeatured = video.fields.isHero || false;
            } catch (error) {
              console.log('å½±ç‰‡åœ¨ Contentful ä¸­ä¸å­˜åœ¨æˆ–ç„¡æ³•è¨ªå•');
            }

            usage.totalUsage = usage.inSchedule.length + (usage.inFeatured ? 1 : 0);
            return usage;

          } catch (error) {
            console.error('æª¢æŸ¥å½±ç‰‡ä½¿ç”¨æƒ…æ³å¤±æ•—:', error);
            return {
              inSchedule: [],
              inFeatured: false,
              inContentful: false,
              totalUsage: 0,
              error: error.message
            };
          }
        }

        // æ·»åŠ åˆªé™¤åŠŸèƒ½ï¼ˆç§»åˆ°å…¨åŸŸç¯„åœï¼‰
        window.deleteVideo = async function(videoId, videoTitle) {
          console.log('ğŸ¬ window.deleteVideo å‡½æ•¸é–‹å§‹åŸ·è¡Œ');
          console.log('videoId:', videoId);
          console.log('videoTitle:', videoTitle);
          
          try {
            // å…ˆæª¢æŸ¥å½±ç‰‡ä½¿ç”¨æƒ…æ³
            showStatus('æ­£åœ¨æª¢æŸ¥å½±ç‰‡ä½¿ç”¨æƒ…æ³...', 'info');
            console.log('æ­£åœ¨èª¿ç”¨ window.checkVideoUsage...');
            
            const usage = await window.checkVideoUsage(videoId, videoTitle);
            console.log('âœ… window.checkVideoUsage å®Œæˆï¼Œçµæœ:', usage);
            
            // å‰µå»ºæ›´è©³ç´°çš„ç¢ºèªå°è©±æ¡†
            console.log('é–‹å§‹å‰µå»ºç¢ºèªå°è©±æ¡†...');
            const confirmModal = document.createElement('div');
            console.log('âœ… confirmModal å…ƒç´ å·²å‰µå»º');
            confirmModal.className = 'modal';
            confirmModal.style.display = 'block';
            confirmModal.style.zIndex = '10020';
            console.log('âœ… confirmModal æ¨£å¼å·²è¨­ç½®');
          
            // ç”Ÿæˆä½¿ç”¨æƒ…æ³å ±å‘Š
            console.log('é–‹å§‹ç”Ÿæˆä½¿ç”¨æƒ…æ³å ±å‘Š...');
            let usageReport = '';
            if (usage.totalUsage === 0) {
              console.log('âœ… å½±ç‰‡æœªè¢«ä½¿ç”¨ï¼Œç”Ÿæˆå®‰å…¨åˆªé™¤å ±å‘Š');
              usageReport = `
                <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                  <p style="margin: 0; color: #155724; font-weight: bold;">âœ… æ­¤å½±ç‰‡ç›®å‰æœªè¢«ä½¿ç”¨</p>
                  <p style="margin: 5px 0 0 0; color: #155724; font-size: 0.9rem;">å¯ä»¥å®‰å…¨åˆªé™¤ï¼Œä¸æœƒå½±éŸ¿ä»»ä½•ç¯€ç›®å®‰æ’ã€‚</p>
                </div>
              `;
            } else {
            usageReport = `
              <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <p style="margin: 0; color: #721c24; font-weight: bold;">âš ï¸ æ­¤å½±ç‰‡æ­£åœ¨è¢«ä½¿ç”¨ä¸­ï¼</p>
                <p style="margin: 5px 0 0 0; color: #721c24; font-size: 0.9rem;">åˆªé™¤å‰è«‹ç¢ºèªæ˜¯å¦è¦ç§»é™¤æ‰€æœ‰ç›¸é—œçš„ç¯€ç›®å®‰æ’ã€‚</p>
              </div>
              
              <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #856404;">ğŸ“Š ä½¿ç”¨æƒ…æ³è©³æƒ…ï¼š</h4>
                ${usage.inFeatured ? '<p style="margin: 5px 0; color: #856404;">â­ <strong>ç²¾é¸å½±ç‰‡</strong>ï¼šæ­¤å½±ç‰‡è¨­ç‚ºç²¾é¸æ¨è–¦</p>' : ''}
                ${usage.inSchedule.length > 0 ? `
                  <p style="margin: 5px 0; color: #856404;">ğŸ“… <strong>ç¯€ç›®è¡¨å®‰æ’</strong>ï¼šå…± ${usage.inSchedule.length} å€‹æ™‚æ®µ</p>
                  <div style="max-height: 150px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px;">
                    ${usage.inSchedule.map(item => `
                      <div style="padding: 5px 0; border-bottom: 1px solid #dee2e6;">
                        <strong>${item.date}</strong> ${item.time} - ${item.title}
                        <span style="background: ${item.status === 'é¦–æ’­' ? '#ffc107' : '#28a745'}; color: ${item.status === 'é¦–æ’­' ? '#000' : '#fff'}; padding: 2px 6px; border-radius: 12px; font-size: 0.7rem; margin-left: 8px;">${item.status}</span>
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
                <p style="margin: 10px 0 0 0; color: #856404; font-weight: bold;">ç¸½è¨ˆï¼š${usage.totalUsage} å€‹ä½¿ç”¨ä½ç½®</p>
              </div>
            `;
          }
          
          confirmModal.innerHTML = `
            <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto; z-index: 10021 !important;">
              <div class="modal-header" style="z-index: 10022 !important;">
                <h3>âš ï¸ ç¢ºèªåˆªé™¤å½±ç‰‡</h3>
                <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
              </div>
              <div style="padding: 20px;">
                <div style="margin-bottom: 20px;">
                  <p style="color: #dc3545; font-weight: bold; margin-bottom: 10px;">æ‚¨å³å°‡åˆªé™¤ä»¥ä¸‹å½±ç‰‡ï¼š</p>
                  <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545;">
                    <strong>${videoTitle}</strong>
                  </div>
                </div>
                
                ${usageReport}
                
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                  <p style="margin: 0; color: #856404;">
                    <strong>âš ï¸ è­¦å‘Šï¼š</strong>æ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤å½±ç‰‡ï¼Œç„¡æ³•å¾©åŸï¼
                    ${usage.totalUsage > 0 ? 'åŒæ™‚æœƒç§»é™¤æ‰€æœ‰ç›¸é—œçš„ç¯€ç›®å®‰æ’ã€‚' : ''}
                  </p>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                  <button onclick="this.closest('.modal').remove()" 
                          style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                    âŒ å–æ¶ˆ
                  </button>
                  <button id="confirmDeleteBtn" 
                          style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                    ğŸ—‘ï¸ ç¢ºèªåˆªé™¤
                  </button>
                </div>
              </div>
            </div>
          `;
          
          document.body.appendChild(confirmModal);
          console.log('âœ… ç¢ºèªå°è©±æ¡†å·²æ·»åŠ åˆ° DOM');
          console.log('âœ… confirmModal å…ƒç´ :', confirmModal);
          console.log('âœ… confirmModal æ¨£å¼:', confirmModal.style.cssText);
          console.log('âœ… confirmModal æ˜¯å¦å¯è¦‹:', confirmModal.offsetParent !== null);
          
          // æ·»åŠ ç¢ºèªåˆªé™¤äº‹ä»¶
          document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
            try {
              // å‰µå»ºåˆªé™¤é€²åº¦æ¢
              const progressDialog = createDeleteProgressDialog();
              document.body.appendChild(progressDialog);
              
              // æ›´æ–°é€²åº¦ï¼šæª¢æŸ¥ SDK
              updateDeleteProgress(progressDialog, 1, 5, 'æª¢æŸ¥ Management SDK...');
              
              // æª¢æŸ¥ Management SDK æ˜¯å¦è¼‰å…¥
              if (typeof contentfulManagement === 'undefined') {
                updateDeleteProgress(progressDialog, 2, 5, 'æ­£åœ¨è¼‰å…¥ Management SDK...');
                try {
                  await loadManagementSDK();
                } catch (loadError) {
                  console.error('è¼‰å…¥ Management SDK å¤±æ•—:', loadError);
                  progressDialog.remove();
                  showStatus('âŒ Management SDK è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢', 'error');
                  return;
                }
              }
              
              // å†æ¬¡æª¢æŸ¥
              if (typeof contentfulManagement === 'undefined') {
                progressDialog.remove();
                throw new Error('Management SDK è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢');
              }
              
              console.log('âœ… Management SDK å·²è¼‰å…¥ï¼Œé–‹å§‹åˆªé™¤æ“ä½œ');
              updateDeleteProgress(progressDialog, 3, 5, 'æ­£åœ¨é€£æ¥ Contentful...');
              
              // å‰µå»º Management å®¢æˆ¶ç«¯
              const managementClient = contentfulManagement.createClient({
                accessToken: 'CFPAT-hNLOfw3XdP5Hf_C3eYjI8294agakAK0Yo5Ew1Mjnsqs'
              });
              
              // ç²å–ç©ºé–“
              updateDeleteProgress(progressDialog, 4, 5, 'æ­£åœ¨ç²å–å½±ç‰‡è³‡æ–™...');
              const space = await managementClient.getSpace('os5wf90ljenp');
              
              // ç²å–ç’°å¢ƒ
              const environment = await space.getEnvironment('master');
              
              // ç²å–ä¸¦åˆªé™¤å½±ç‰‡
              const entry = await environment.getEntry(videoId);
              updateDeleteProgress(progressDialog, 5, 5, 'æ­£åœ¨åˆªé™¤å½±ç‰‡...');
              await entry.unpublish(); // å…ˆå–æ¶ˆç™¼å¸ƒ
              await entry.delete(); // å†åˆªé™¤
              
              // æ¸…ç†ç›¸é—œçš„ç¯€ç›®å®‰æ’
              if (usage.totalUsage > 0) {
                updateDeleteProgress(progressDialog, 5, 5, 'æ­£åœ¨æ¸…ç†ç›¸é—œç¯€ç›®å®‰æ’...');
                
                // å¾ç¯€ç›®è¡¨ä¸­ç§»é™¤ä½¿ç”¨æ­¤å½±ç‰‡çš„ç¯€ç›®
                const calendarEvents = JSON.parse(localStorage.getItem('calendar_events') || '{}');
                let removedCount = 0;
                
                Object.keys(calendarEvents).forEach(date => {
                  calendarEvents[date] = calendarEvents[date].filter(event => {
                    if (event.youtubeId === videoId) {
                      removedCount++;
                      return false; // ç§»é™¤é€™å€‹ç¯€ç›®
                    }
                    return true; // ä¿ç•™å…¶ä»–ç¯€ç›®
                  });
                });
                
                // å„²å­˜æ›´æ–°å¾Œçš„ç¯€ç›®è¡¨
                localStorage.setItem('calendar_events', JSON.stringify(calendarEvents));
                
                if (removedCount > 0) {
                  updateDeleteProgress(progressDialog, 5, 5, `å·²æ¸…ç† ${removedCount} å€‹ç›¸é—œç¯€ç›®å®‰æ’`);
                }
              }
              
              // å¾ UI ä¸­ç§»é™¤å½±ç‰‡é …ç›®
              const videoItem = document.querySelector(`[onclick*="deleteVideo('${videoId}'"]`).closest('.video-item');
              if (videoItem) {
                videoItem.style.transition = 'opacity 0.3s ease';
                videoItem.style.opacity = '0';
                setTimeout(() => {
                  videoItem.remove();
                  
                  // æ›´æ–°çµ±è¨ˆæ•¸å­—
                  const videoCount = document.querySelectorAll('.video-item').length;
                  document.getElementById('videoCount').textContent = videoCount;
                  
                  // é‡æ–°è¨ˆç®—ç²¾é¸å’Œä¸€èˆ¬å½±ç‰‡æ•¸é‡
                  const featuredCount = document.querySelectorAll('.video-item[data-featured="featured"]').length;
                  const normalCount = document.querySelectorAll('.video-item[data-featured="normal"]').length;
                  document.getElementById('featuredCount').textContent = featuredCount;
                  document.getElementById('normalCount').textContent = normalCount;
                  
                  // æ›´æ–°æ¨™é¡Œä¸­çš„ç¸½æ•¸
                  const modalHeader = document.getElementById('videoModalHeader');
                  if (modalHeader) {
                    const titleElement = modalHeader.querySelector('h3');
                    if (titleElement) {
                      titleElement.textContent = `ğŸ¬ æ‰€æœ‰å½±ç‰‡ç®¡ç† (${videoCount} å€‹)`;
                    }
                  }
                }, 300);
              }
              
              // é—œé–‰ç¢ºèªå°è©±æ¡†
              confirmModal.remove();
              
              // é—œé–‰ç·¨è¼¯è¦–çª—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
              const eventModal = document.getElementById('eventModal');
              if (eventModal) {
                eventModal.style.display = 'none';
                console.log('âœ… å·²é—œé–‰ç·¨è¼¯è¦–çª—');
              }
              
              // é¡¯ç¤ºå®Œæˆç‹€æ…‹
              updateDeleteProgressComplete(progressDialog, true, `âœ… å½±ç‰‡ã€Œ${videoTitle}ã€å·²æˆåŠŸåˆªé™¤`);
              
              // å»¶é²é—œé–‰é€²åº¦æ¢
              setTimeout(() => {
                progressDialog.remove();
                showStatus(`âœ… å½±ç‰‡ã€Œ${videoTitle}ã€å·²æˆåŠŸåˆªé™¤`, 'success');
              }, 2000);
              
            } catch (error) {
              console.error('åˆªé™¤å½±ç‰‡å¤±æ•—:', error);
              confirmModal.remove();
              
              // é¡¯ç¤ºéŒ¯èª¤ç‹€æ…‹
              updateDeleteProgressComplete(progressDialog, false, `âŒ åˆªé™¤å½±ç‰‡å¤±æ•—: ${error.message}`);
              
              // å»¶é²é—œé–‰é€²åº¦æ¢
              setTimeout(() => {
                progressDialog.remove();
                showStatus(`âŒ åˆªé™¤å½±ç‰‡å¤±æ•—: ${error.message}`, 'error');
              }, 3000);
            }
          });
          
          // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
          confirmModal.addEventListener('click', function(e) {
            if (e.target === confirmModal) {
              confirmModal.remove();
            }
          });
          
          } catch (error) {
            console.error('âŒ window.deleteVideo å‡½æ•¸åŸ·è¡Œå¤±æ•—:', error);
            showStatus('âŒ åˆªé™¤åŠŸèƒ½åŸ·è¡Œå¤±æ•—: ' + error.message, 'error');
          }
        };

      } catch (error) {
        console.error('è¼‰å…¥å½±ç‰‡å¤±æ•—:', error);
        showStatus('è¼‰å…¥å½±ç‰‡å¤±æ•—: ' + error.message, 'error');
      }
    }

    // å‰µå»ºåˆªé™¤é€²åº¦æ¢å°è©±æ¡†
    function createDeleteProgressDialog() {
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10020;
      `;
      
      dialog.innerHTML = `
        <div style="
          background: white;
          padding: 30px;
          border-radius: 10px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
          max-width: 500px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="margin: 0 0 20px 0; color: #333;">ğŸ—‘ï¸ æ­£åœ¨åˆªé™¤å½±ç‰‡</h3>
          <div style="margin-bottom: 20px;">
            <div style="
              width: 100%;
              height: 20px;
              background: #f0f0f0;
              border-radius: 10px;
              overflow: hidden;
            ">
              <div id="deleteProgressBar" style="
                width: 0%;
                height: 100%;
                background: linear-gradient(90deg, #dc3545, #ff6b6b);
                transition: width 0.3s ease;
                border-radius: 10px;
              "></div>
            </div>
            <div id="deleteProgressText" style="
              margin-top: 10px;
              color: #666;
              font-size: 14px;
            ">æº–å‚™ä¸­...</div>
          </div>
          <div id="deleteCurrentItem" style="
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
          ">ç­‰å¾…é–‹å§‹...</div>
          <div id="deleteStatusText" style="color: #333; font-weight: bold;">æ­£åœ¨åˆªé™¤å½±ç‰‡...</div>
        </div>
      `;
      
      return dialog;
    }

    // æ›´æ–°åˆªé™¤é€²åº¦
    function updateDeleteProgress(dialog, current, total, message) {
      const progressBar = dialog.querySelector('#deleteProgressBar');
      const progressText = dialog.querySelector('#deleteProgressText');
      const currentItem = dialog.querySelector('#deleteCurrentItem');
      const statusText = dialog.querySelector('#deleteStatusText');
      
      const percentage = Math.round((current / total) * 100);
      
      progressBar.style.width = percentage + '%';
      progressText.textContent = `${current} / ${total} (${percentage}%)`;
      currentItem.textContent = message;
      statusText.textContent = 'æ­£åœ¨åˆªé™¤å½±ç‰‡...';
    }

    // æ›´æ–°åˆªé™¤å®Œæˆç‹€æ…‹
    function updateDeleteProgressComplete(dialog, success, message) {
      const progressBar = dialog.querySelector('#deleteProgressBar');
      const progressText = dialog.querySelector('#deleteProgressText');
      const currentItem = dialog.querySelector('#deleteCurrentItem');
      const statusText = dialog.querySelector('#deleteStatusText');
      
      progressBar.style.width = '100%';
      progressBar.style.background = success ? 'linear-gradient(90deg, #28a745, #20c997)' : 'linear-gradient(90deg, #dc3545, #ff6b6b)';
      progressText.textContent = '100% (å®Œæˆ)';
      currentItem.textContent = message;
      statusText.textContent = success ? 'âœ… åˆªé™¤å®Œæˆ' : 'âŒ åˆªé™¤å¤±æ•—';
      statusText.style.color = success ? '#28a745' : '#dc3545';
    }

    function showAllEventsForDay(dateString) {
      const dayEvents = events[dateString] || [];
      if (dayEvents.length === 0) {
        showStatus('è©²æ—¥æœŸæ²’æœ‰ç¯€ç›®', 'info');
        return;
      }

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'block';

      const date = new Date(dateString);
      const dateDisplay = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;

      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
            <h3>${dateDisplay} çš„æ‰€æœ‰ç¯€ç›®</h3>
            <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
          </div>
          <div style="max-height: 400px; overflow-y: auto;">
            ${dayEvents.map(event => `
              <div style="border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <span style="font-weight: 600; color: #2b71d2;">${event.time}</span>
                  <span style="background: ${event.status === 'é¦–æ’­' ? '#ffc107' : '#28a745'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">
                    ${event.status}
                  </span>
                </div>
                <div style="font-weight: 600; margin-bottom: 5px;">${event.title}</div>
                <div style="color: #666; font-size: 0.9rem; margin-bottom: 5px;">
                  <span>${event.category}</span> â€¢ <span>${event.duration}åˆ†é˜</span>
                  ${event.videoType ? ` â€¢ <span>${event.videoType}</span>` : ''}
                </div>
                ${event.description ? `<div style="color: #666; font-size: 0.9rem; margin-bottom: 8px;">${event.description}</div>` : ''}
                <button class="btn" style="padding: 5px 12px; font-size: 0.8rem;" onclick="openEventModal('${dateString}', '${event.time}')">
                  ç·¨è¼¯ç¯€ç›®
                </button>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    function showStatus(message, type) {
      const statusBar = document.getElementById('statusBar');
      const statusMessage = document.getElementById('statusMessage');

      statusMessage.textContent = message;
      statusBar.style.display = 'block';

      statusBar.style.backgroundColor = type === 'success' ? '#4caf50' :
                                      type === 'error' ? '#f44336' :
                                      type === 'warning' ? '#ff9800' : '#333';

      setTimeout(() => {
        statusBar.style.display = 'none';
      }, 3000);
    }

    // æ›´æ–°ä»Šæ—¥ç¯€ç›®è¡¨é¡¯ç¤º
    function updateCurrentScheduleForToday(programData) {
      const today = new Date();
      const todayString = today.getFullYear() + '-' +
                         String(today.getMonth() + 1).padStart(2, '0') + '-' +
                         String(today.getDate()).padStart(2, '0');
      
      // ç²å–ç¾æœ‰çš„ä»Šæ—¥ç¯€ç›®è¡¨
      let currentSchedule = JSON.parse(localStorage.getItem('currentSchedule') || '{}');
      
      if (!currentSchedule.today) {
        currentSchedule.today = {
          date: todayString,
          dayOfWeek: getDayOfWeek(today),
          month: `${today.getMonth() + 1}æœˆ`,
          day: `${today.getDate()}æ—¥`,
          schedule: []
        };
      }
      
      // è½‰æ›ç¯€ç›®è³‡æ–™æ ¼å¼
      let thumbnail = 'https://images.unsplash.com/photo-1485846234645-a62644f84728?w=400&h=225&fit=crop';
      
      // å„ªå…ˆä½¿ç”¨ programData.thumbnailï¼Œç„¶å¾Œæ˜¯ YouTube ç¸®åœ–
      if (programData.thumbnail) {
        thumbnail = programData.thumbnail;
      } else if (programData.youtubeId) {
        thumbnail = `https://img.youtube.com/vi/${programData.youtubeId}/maxresdefault.jpg`;
      }
      
      const scheduleItem = {
        time: programData.airTime,
        title: programData.title,
        duration: programData.duration.toString(),
        category: programData.category,
        description: programData.description,
        thumbnail: thumbnail,
        youtubeId: programData.youtubeId || '',
        status: programData.status,
        tags: []
      };
      
      // ç§»é™¤åŒæ™‚é–“çš„èˆŠç¯€ç›®ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
      currentSchedule.today.schedule = currentSchedule.today.schedule.filter(
        item => item.time !== programData.airTime
      );
      
      // æ·»åŠ æ–°ç¯€ç›®
      currentSchedule.today.schedule.push(scheduleItem);
      
      // æŒ‰æ™‚é–“æ’åº
      currentSchedule.today.schedule.sort((a, b) => a.time.localeCompare(b.time));
      
      // å„²å­˜åˆ° localStorage
      localStorage.setItem('currentSchedule', JSON.stringify(currentSchedule));
      
      console.log('å·²æ›´æ–°ä»Šæ—¥ç¯€ç›®è¡¨ï¼Œæ–°å¢ç¯€ç›®:', scheduleItem);
    }

    // ç²å–æ˜ŸæœŸå¹¾çš„è¼”åŠ©å‡½æ•¸
    function getDayOfWeek(date) {
      const days = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
      return days[date.getDay()];
    }

    // === æœˆæ’ç¨‹ç³»çµ± ===
    
    // å®šç¾©å››å€‹æ™‚æ®µ
    const TIME_SLOTS = {
      AFTERNOON: {
        name: 'ä¸‹åˆå ´',
        startTime: '12:00',
        endTime: '17:30',
        slots: [
          '12:00', '12:30', '13:00', '13:30', '14:00', '14:30',
          '15:00', '15:30', '16:00', '16:30', '17:00', '17:30'
        ]
      },
      EVENING: {
        name: 'æ™šå ´',
        startTime: '18:00',
        endTime: '23:30',
        slots: [
          '18:00', '18:30', '19:00', '19:30', '20:00', '20:30',
          '21:00', '21:30', '22:00', '22:30', '23:00', '23:30'
        ]
      },
      MIDNIGHT: {
        name: 'åˆå¤œå ´',
        startTime: '00:00',
        endTime: '05:30',
        slots: [
          '00:00', '00:30', '01:00', '01:30', '02:00', '02:30',
          '03:00', '03:30', '04:00', '04:30', '05:00', '05:30'
        ]
      },
      MORNING: {
        name: 'æ—©å ´',
        startTime: '06:00',
        endTime: '11:30',
        slots: [
          '06:00', '06:30', '07:00', '07:30', '08:00', '08:30',
          '09:00', '09:30', '10:00', '10:30', '11:00', '11:30'
        ]
      }
    };

    // åˆ¤æ–·æ™‚é–“å±¬æ–¼å“ªå€‹æ™‚æ®µ
    function getTimeSlot(time) {
      for (const [key, slot] of Object.entries(TIME_SLOTS)) {
        if (slot.slots.includes(time)) {
          return { key, slot };
        }
      }
      return null;
    }

    // ç²å–ç›¸åŒæ™‚æ®µçš„å…¶ä»–æ™‚é–“æ§½
    function getSameTimeSlotInOtherPeriods(time) {
      const currentSlot = getTimeSlot(time);
      if (!currentSlot) return [];

      const slotIndex = currentSlot.slot.slots.indexOf(time);
      const otherSlots = [];

      for (const [key, slot] of Object.entries(TIME_SLOTS)) {
        if (key !== currentSlot.key && slot.slots[slotIndex]) {
          otherSlots.push({
            period: key,
            periodName: slot.name,
            time: slot.slots[slotIndex]
          });
        }
      }

      return otherSlots;
    }

    // ç”Ÿæˆæ•´å€‹æœˆçš„æ—¥æœŸ
    function generateMonthDates(startDate) {
      const dates = [];
      const start = new Date(startDate);
      const year = start.getFullYear();
      const month = start.getMonth();
      
      // ç²å–ç•¶æœˆå¤©æ•¸
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        dates.push(date.toISOString().split('T')[0]);
      }
      
      return dates;
    }

    // ç”Ÿæˆè·¨æœˆæ—¥æœŸï¼ˆå¾é–‹å§‹æ—¥æœŸåˆ°æŒ‡å®šå¤©æ•¸ï¼‰
    function generateCrossMonthDates(startDate, days) {
      const dates = [];
      const start = new Date(startDate);
      
      for (let i = 0; i < days; i++) {
        const date = new Date(start);
        date.setDate(start.getDate() + i);
        dates.push(date.toISOString().split('T')[0]);
      }
      
      return dates;
    }

    // ç”ŸæˆæŒ‡å®šæ—¥æœŸç¯„åœï¼ˆå¾é–‹å§‹æ—¥æœŸåˆ°çµæŸæ—¥æœŸï¼‰
    function generateDateRange(startDate, endDate) {
      const dates = [];
      const start = new Date(startDate);
      const end = new Date(endDate);
      
      // ç¢ºä¿çµæŸæ—¥æœŸä¸æ—©æ–¼é–‹å§‹æ—¥æœŸ
      if (end < start) {
        console.warn('âš ï¸ çµæŸæ—¥æœŸæ—©æ–¼é–‹å§‹æ—¥æœŸï¼Œä½¿ç”¨é–‹å§‹æ—¥æœŸä½œç‚ºçµæŸæ—¥æœŸ');
        return [startDate];
      }
      
      const current = new Date(start);
      while (current <= end) {
        dates.push(current.toISOString().split('T')[0]);
        current.setDate(current.getDate() + 1);
      }
      
      return dates;
    }

    // æª¢æŸ¥æ˜¯å¦éœ€è¦å®šæœŸæ¸…ç†æé†’
    function checkCleanupReminder() {
      const lastCleanupKey = 'last_contentful_cleanup';
      const reminderInterval = 60; // 60å¤©
      
      const lastCleanup = localStorage.getItem(lastCleanupKey);
      const now = new Date();
      
      if (!lastCleanup) {
        // ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œè¨­ç½®æé†’
        localStorage.setItem(lastCleanupKey, now.toISOString());
        return;
      }
      
      const lastCleanupDate = new Date(lastCleanup);
      const daysSinceLastCleanup = Math.floor((now - lastCleanupDate) / (1000 * 60 * 60 * 24));
      
      if (daysSinceLastCleanup >= reminderInterval) {
        showCleanupReminder(daysSinceLastCleanup);
      }
    }
    
    // æª¢æŸ¥é‡è¤‡æ™‚é–“æ§½
    function checkDuplicateTimeSlots() {
      const duplicateSlots = [];
      
      Object.keys(events).forEach(date => {
        const dayEvents = events[date];
        const timeGroups = {};
        
        dayEvents.forEach(event => {
          if (!timeGroups[event.time]) {
            timeGroups[event.time] = [];
          }
          timeGroups[event.time].push(event);
        });
        
        Object.keys(timeGroups).forEach(time => {
          if (timeGroups[time].length > 1) {
            duplicateSlots.push({
              date: date,
              time: time,
              programs: timeGroups[time]
            });
          }
        });
      });
      
      if (duplicateSlots.length > 0) {
        console.log('âš ï¸ ç™¼ç¾é‡è¤‡æ™‚é–“æ§½:', duplicateSlots);
        showDuplicateTimeSlotsDialog(duplicateSlots);
      }
    }
    
    
    // æ¸…ç†é‡è¤‡æ™‚é–“æ§½ï¼ˆä½¿ç”¨æœ¬åœ°æ•¸æ“šæª¢æ¸¬ï¼ŒContentful æ¸…ç†ï¼‰
    async function cleanupDuplicateTimeSlots() {
      try {
        showStatus('ğŸ”„ é–‹å§‹æ¸…ç†é‡è¤‡ç¯€ç›®...', 'info');
        
        // 1. ä½¿ç”¨æœ¬åœ° events æ•¸æ“šæª¢æ¸¬é‡è¤‡ï¼ˆèˆ‡ checkDuplicateTimeSlots ä¸€è‡´ï¼‰
        const duplicateSlots = [];
        
        Object.keys(events).forEach(date => {
          const dayEvents = events[date];
          const timeGroups = {};
          
          dayEvents.forEach(event => {
            if (!timeGroups[event.time]) {
              timeGroups[event.time] = [];
            }
            timeGroups[event.time].push(event);
          });
          
          Object.keys(timeGroups).forEach(time => {
            if (timeGroups[time].length > 1) {
              duplicateSlots.push({
                date: date,
                time: time,
                programs: timeGroups[time]
              });
            }
          });
        });
        
        console.log('ğŸ” ä½¿ç”¨æœ¬åœ°æ•¸æ“šç™¼ç¾é‡è¤‡æ™‚é–“æ§½æ•¸é‡:', duplicateSlots.length);
        
        if (duplicateSlots.length === 0) {
          showStatus('âœ… æ²’æœ‰ç™¼ç¾é‡è¤‡æ™‚é–“æ§½', 'success');
          return;
        }
        
        // 2. é¡¯ç¤ºç¢ºèªå°è©±æ¡†
        showDuplicateTimeSlotsDialog(duplicateSlots);
        
      } catch (error) {
        console.error('âŒ æ¸…ç†é‡è¤‡ç¯€ç›®å¤±æ•—:', error);
        showStatus(`âŒ æ¸…ç†å¤±æ•—: ${error.message}`, 'error');
      }
    }
    
    // é¡¯ç¤ºé‡è¤‡æ™‚é–“æ§½ç¢ºèªå°è©±æ¡†
    function showDuplicateTimeSlotsDialog(duplicateSlots) {
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 10000;
        display: flex; align-items: center; justify-content: center;
      `;
      
      const totalDuplicates = duplicateSlots.reduce((sum, slot) => sum + slot.programs.length - 1, 0);
      
      dialog.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
          <h3>ğŸ§¹ æ¸…ç†é‡è¤‡ç¯€ç›®</h3>
          <p>ç™¼ç¾ <strong>${duplicateSlots.length}</strong> å€‹é‡è¤‡æ™‚é–“æ§½ï¼Œå…± <strong>${totalDuplicates}</strong> å€‹é‡è¤‡ç¯€ç›®éœ€è¦æ¸…ç†ã€‚</p>
          
          <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px;">
            <h4>æ¸…ç†ç­–ç•¥ï¼š</h4>
            <ul style="margin: 10px 0; padding-left: 20px;">
              <li>ä¿ç•™æ¯å€‹æ™‚é–“æ§½æœ€å¾Œä¸€æ¬¡ä¸Šå‚³çš„ç¯€ç›®ï¼ˆæœ€æ–°çš„ï¼‰</li>
              <li>åˆªé™¤å…¶ä»–é‡è¤‡çš„ç¯€ç›®</li>
              <li>åŒæ™‚å¾ Contentful å’Œæœ¬åœ°æ•¸æ“šä¸­æ¸…ç†</li>
            </ul>
          </div>
          
          <div style="margin: 20px 0;">
            <h4>é‡è¤‡æ™‚é–“æ§½é è¦½ï¼š</h4>
            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
              ${duplicateSlots.slice(0, 10).map(slot => `
                <div style="margin: 5px 0; padding: 5px; background: #fff3cd; border-radius: 3px;">
                  <strong>${slot.date} ${slot.time}</strong> (${slot.programs.length} å€‹ç¯€ç›®)
                  <div style="font-size: 0.9em; color: #666;">
                    ${slot.programs.slice(0, 3).map((p, index) => {
                      const isLast = index === slot.programs.length - 1;
                      const isKeep = index === slot.programs.length - 1;
                      return `â€¢ ${p.title}${isKeep ? ' <span style="color: #28a745; font-weight: bold;">(ä¿ç•™)</span>' : ' <span style="color: #dc3545;">(åˆªé™¤)</span>'}`;
                    }).join('<br>')}
                    ${slot.programs.length > 3 ? `<br>â€¢ ... é‚„æœ‰ ${slot.programs.length - 3} å€‹` : ''}
                  </div>
                </div>
              `).join('')}
              ${duplicateSlots.length > 10 ? `<div style="text-align: center; color: #666; margin-top: 10px;">... é‚„æœ‰ ${duplicateSlots.length - 10} å€‹æ™‚é–“æ§½</div>` : ''}
            </div>
          </div>
          
          <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
            <button onclick="this.closest('div').parentElement.remove()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
              å–æ¶ˆ
            </button>
            <button onclick="startCleanupProcess(); this.closest('div').parentElement.remove()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
              é–‹å§‹æ¸…ç† (${totalDuplicates} å€‹)
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(dialog);
      
      // é»æ“ŠèƒŒæ™¯é—œé–‰
      dialog.addEventListener('click', function(e) {
        if (e.target === dialog) {
          dialog.remove();
        }
      });
    }
    
    // é–‹å§‹æ¸…ç†éç¨‹
    async function startCleanupProcess() {
      try {
        console.log('ğŸš€ startCleanupProcess é–‹å§‹åŸ·è¡Œ');
        showStatus('ğŸ”„ é–‹å§‹æ¸…ç†é‡è¤‡ç¯€ç›®...', 'info');
        
        // æª¢æŸ¥ events æ˜¯å¦å­˜åœ¨
        if (!events || Object.keys(events).length === 0) {
          console.error('âŒ events æ•¸æ“šä¸å­˜åœ¨æˆ–ç‚ºç©º');
          showStatus('âŒ æ²’æœ‰æ‰¾åˆ°ç¯€ç›®æ•¸æ“š', 'error');
          return;
        }
        
        console.log('ğŸ“Š events æ•¸æ“šæª¢æŸ¥é€šéï¼Œå…±æœ‰', Object.keys(events).length, 'å€‹æ—¥æœŸçš„æ•¸æ“š');
        
        // ä½¿ç”¨æœ¬åœ° events æ•¸æ“šæª¢æ¸¬é‡è¤‡ï¼ˆèˆ‡ checkDuplicateTimeSlots ä¸€è‡´ï¼‰
        const duplicateSlots = [];
        
        Object.keys(events).forEach(date => {
          const dayEvents = events[date];
          if (!dayEvents || !Array.isArray(dayEvents)) {
            console.warn(`âš ï¸ æ—¥æœŸ ${date} çš„æ•¸æ“šæ ¼å¼ä¸æ­£ç¢º:`, dayEvents);
            return;
          }
          
          const timeGroups = {};
          
          dayEvents.forEach(event => {
            if (!event.time) {
              console.warn('âš ï¸ ç¯€ç›®ç¼ºå°‘æ™‚é–“ä¿¡æ¯:', event);
              return;
            }
            
            if (!timeGroups[event.time]) {
              timeGroups[event.time] = [];
            }
            timeGroups[event.time].push(event);
          });
          
          Object.keys(timeGroups).forEach(time => {
            if (timeGroups[time].length > 1) {
              duplicateSlots.push({
                date: date,
                time: time,
                programs: timeGroups[time]
              });
            }
          });
        });
        
        console.log('ğŸ” é–‹å§‹æ¸…ç†ï¼Œç™¼ç¾é‡è¤‡æ™‚é–“æ§½æ•¸é‡:', duplicateSlots.length);
        
        if (duplicateSlots.length === 0) {
          console.log('âœ… æ²’æœ‰ç™¼ç¾é‡è¤‡æ™‚é–“æ§½');
          showStatus('âœ… æ²’æœ‰ç™¼ç¾é‡è¤‡æ™‚é–“æ§½', 'success');
          return;
        }
        
        let cleanedCount = 0;
        let errorCount = 0;
        let totalToDelete = 0;
        
        // è¨ˆç®—ç¸½å…±éœ€è¦åˆªé™¤çš„ç¯€ç›®æ•¸é‡
        duplicateSlots.forEach(slot => {
          totalToDelete += slot.programs.length - 1; // æ¸›å»ä¿ç•™çš„æœ€å¾Œä¸€å€‹
        });
        
        // é¡¯ç¤ºé€²åº¦å°è©±æ¡†
        console.log('ğŸ“Š é¡¯ç¤ºé€²åº¦å°è©±æ¡†');
        const progressDialog = showCleanupProgressDialog();
        
        let processedCount = 0;
        
        // æ¸…ç†æ¯å€‹é‡è¤‡æ™‚é–“æ§½
        for (let i = 0; i < duplicateSlots.length; i++) {
          const slot = duplicateSlots[i];
          const programs = slot.programs;
          
          console.log(`ğŸ”„ è™•ç†é‡è¤‡æ™‚é–“æ§½ ${i + 1}/${duplicateSlots.length}: ${slot.date} ${slot.time}`);
          
          // ä¿ç•™æœ€å¾Œä¸€å€‹ç¯€ç›®ï¼ˆæœ€æ–°çš„ï¼‰ï¼Œåˆªé™¤å…¶ä»–
          for (let j = 0; j < programs.length - 1; j++) {
            const programToDelete = programs[j];
            
            try {
              processedCount++;
              updateCleanupProgress(progressDialog, processedCount, totalToDelete, 
                `æ­£åœ¨åˆªé™¤: ${programToDelete.title} (${slot.date} ${slot.time})`);
              
              // å¾ Contentful åˆªé™¤ï¼ˆå¦‚æœæœ‰ contentfulIdï¼‰
              if (programToDelete.contentfulId) {
                console.log(`ğŸ—‘ï¸ å¾ Contentful åˆªé™¤: ${programToDelete.contentfulId}`);
                await deleteProgramFromContentful(programToDelete.contentfulId);
              }
              
              // å¾æœ¬åœ°äº‹ä»¶ä¸­åˆªé™¤
              const eventIndex = events[slot.date]?.findIndex(e => 
                e.time === programToDelete.time && 
                e.title === programToDelete.title &&
                e.contentfulId === programToDelete.contentfulId
              );
              
              if (eventIndex !== -1) {
                events[slot.date].splice(eventIndex, 1);
                console.log(`ğŸ—‘ï¸ å¾æœ¬åœ°æ•¸æ“šåˆªé™¤: ${programToDelete.title}`);
              }
              
              cleanedCount++;
              console.log(`âœ… å·²åˆªé™¤é‡è¤‡ç¯€ç›®: ${programToDelete.title} (${slot.date} ${slot.time})`);
              
            } catch (error) {
              console.error(`âŒ åˆªé™¤ç¯€ç›®å¤±æ•—: ${programToDelete.title}`, error);
              errorCount++;
            }
            
            // æ·»åŠ å°å»¶é²é¿å… API é™åˆ¶
            await new Promise(resolve => setTimeout(resolve, 200));
          }
        }
        
        console.log('ğŸ’¾ ä¿å­˜æœ¬åœ°æ•¸æ“š');
        // ä¿å­˜æœ¬åœ°æ•¸æ“š
        saveEvents();
        renderCurrentView();
        
        console.log('âœ… æ¸…ç†å®Œæˆï¼Œé¡¯ç¤ºçµæœ');
        // å®Œæˆé€²åº¦
        updateCleanupProgressComplete(progressDialog, cleanedCount, errorCount);
        
        showStatus(`âœ… æ¸…ç†å®Œæˆï¼åˆªé™¤ ${cleanedCount} å€‹é‡è¤‡ç¯€ç›®${errorCount > 0 ? `ï¼Œ${errorCount} å€‹å¤±æ•—` : ''}`, 'success');
        
      } catch (error) {
        console.error('âŒ æ¸…ç†éç¨‹å¤±æ•—:', error);
        console.error('éŒ¯èª¤è©³æƒ…:', error.stack);
        showStatus(`âŒ æ¸…ç†å¤±æ•—: ${error.message}`, 'error');
        
        // ç¢ºä¿åœ¨éŒ¯èª¤æƒ…æ³ä¸‹ä¹Ÿé—œé–‰å°è©±æ¡†
        clearAllDialogs();
      }
    }

    // é¡¯ç¤ºæ¸…ç†é€²åº¦å°è©±æ¡†
    function showCleanupProgressDialog() {
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 10000;
        display: flex; align-items: center; justify-content: center;
      `;
      
      dialog.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
          <h3>ğŸ§¹ æ¸…ç†é‡è¤‡ç¯€ç›®ä¸­...</h3>
          <div style="margin: 20px 0;">
            <div style="background: #f0f0f0; border-radius: 10px; height: 20px; overflow: hidden;">
              <div id="cleanup-progress-bar" style="background: #28a745; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
            </div>
            <div id="cleanup-progress-text" style="text-align: center; margin-top: 10px; color: #666;">
              æº–å‚™ä¸­...
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(dialog);
      return dialog;
    }
    
    // å¾ Contentful åˆªé™¤ç¯€ç›®
    async function deleteProgramFromContentful(contentfulId) {
      try {
        const managementToken = window.CONTENTFUL_CONFIG?.MANAGEMENT_TOKEN || window.CONTENTFUL_MANAGEMENT_TOKEN;
        if (!managementToken) {
          throw new Error('Management Token æœªè¨­å®š');
        }
        
        const managementClient = contentfulManagement.createClient({
          accessToken: managementToken
        });
        
        const spaceId = window.CONTENTFUL_CONFIG?.SPACE_ID || 'os5wf90ljenp';
        const space = await managementClient.getSpace(spaceId);
        const environment = await space.getEnvironment('master');
        
        const entry = await environment.getEntry(contentfulId);
        
        // å…ˆå–æ¶ˆç™¼å¸ƒ
        if (entry.isPublished()) {
          await entry.unpublish();
        }
        
        // åˆªé™¤æ¢ç›®
        await entry.delete();
        
        console.log(`âœ… å·²å¾ Contentful åˆªé™¤ç¯€ç›®: ${contentfulId}`);
        
      } catch (error) {
        console.error(`âŒ å¾ Contentful åˆªé™¤ç¯€ç›®å¤±æ•—: ${contentfulId}`, error);
        throw error;
      }
    }
    
    
    // æ›´æ–°æ¸…ç†é€²åº¦
    function updateCleanupProgress(dialog, current, total, message) {
      const progressBar = dialog.querySelector('#cleanup-progress-bar');
      const progressText = dialog.querySelector('#cleanup-progress-text');
      
      if (progressBar && progressText) {
        const percentage = total === 0 ? 100 : (current / total) * 100;
        progressBar.style.width = `${percentage}%`;
        progressText.textContent = `${current}/${total} - ${message}`;
      }
    }
    
    // å®Œæˆæ¸…ç†é€²åº¦
    function updateCleanupProgressComplete(dialog, cleanedCount, errorCount) {
      const progressBar = dialog.querySelector('#cleanup-progress-bar');
      const progressText = dialog.querySelector('#cleanup-progress-text');
      
      if (progressBar && progressText) {
        progressBar.style.width = '100%';
        progressBar.style.backgroundColor = errorCount > 0 ? '#dc3545' : '#28a745';
        progressText.innerHTML = `
          <div style="color: #28a745; font-weight: bold;">
            âœ… æ¸…ç†å®Œæˆï¼
          </div>
          <div style="margin-top: 10px;">
            æˆåŠŸåˆªé™¤: ${cleanedCount} å€‹ç¯€ç›®<br>
            ${errorCount > 0 ? `å¤±æ•—: ${errorCount} å€‹ç¯€ç›®` : ''}
          </div>
        `;
      }
      
      // 3ç§’å¾Œè‡ªå‹•é—œé–‰
      setTimeout(() => {
        try {
          // å…ˆç§»é™¤ç‰¹å®šå°è©±æ¡†
          if (dialog && dialog.parentElement) {
            dialog.remove();
            console.log('âœ… å·²ç§»é™¤æ¸…ç†é€²åº¦å°è©±æ¡†');
          }
          
          // ä½¿ç”¨é€šç”¨æ¸…ç†å‡½æ•¸ç¢ºä¿æ‰€æœ‰å°è©±æ¡†éƒ½è¢«ç§»é™¤
          clearAllDialogs();
          
          // é¡å¤–ç¢ºä¿æ²’æœ‰æ®˜ç•™çš„é®ç½©å±¤
          setTimeout(() => {
            clearAllDialogs();
            console.log('âœ… äºŒæ¬¡æ¸…ç†å®Œæˆ');
          }, 100);
          
        } catch (error) {
          console.error('é—œé–‰å°è©±æ¡†æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
          // å³ä½¿å‡ºéŒ¯ä¹Ÿè¦å˜—è©¦æ¸…ç†
          clearAllDialogs();
        }
      }, 3000);
    }

    // å¼·åˆ¶é‡æ–°è¼‰å…¥ Contentful æ•¸æ“š
    async function forceReloadFromContentful() {
      try {
        console.log('ğŸ”„ å¼·åˆ¶é‡æ–°è¼‰å…¥ Contentful æ•¸æ“š...');
        showStatus('ğŸ”„ æ­£åœ¨å¼·åˆ¶é‡æ–°è¼‰å…¥ Contentful æ•¸æ“š...', 'info');
        
        // æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•¸æ“š
        events = {};
        localStorage.removeItem('calendar_events');
        localStorage.removeItem('published_programs');
        
        console.log('âœ… å·²æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•¸æ“š');
        
        // é‡æ–°è¼‰å…¥ Contentful æ•¸æ“š
        await loadEventsFromContentful();
        
        // é‡æ–°æ¸²æŸ“è¦–åœ–
        renderCurrentView();
        
        showStatus('âœ… å¼·åˆ¶é‡æ–°è¼‰å…¥å®Œæˆï¼æ‰€æœ‰æ•¸æ“šç¾åœ¨å®Œå…¨ä¾†è‡ª Contentful', 'success');
        
        // é¡¯ç¤ºçµ±è¨ˆä¿¡æ¯
        const totalPrograms = Object.values(events).flat().length;
        const totalDates = Object.keys(events).length;
        console.log(`ğŸ“Š é‡æ–°è¼‰å…¥å¾Œçµ±è¨ˆ: ${totalPrograms} å€‹ç¯€ç›®ï¼Œ${totalDates} å€‹æ—¥æœŸ`);
        
      } catch (error) {
        console.error('âŒ å¼·åˆ¶é‡æ–°è¼‰å…¥å¤±æ•—:', error);
        showStatus('âŒ å¼·åˆ¶é‡æ–°è¼‰å…¥å¤±æ•—: ' + error.message, 'error');
      }
    }

    // æ¢å¾©æ¶ˆå¤±çš„ç¯€ç›®
    async function recoverMissingPrograms() {
      try {
        console.log('ğŸ”„ é–‹å§‹æ¢å¾©æ¶ˆå¤±çš„ç¯€ç›®...');
        showStatus('ğŸ”„ æ­£åœ¨å¾ Contentful é‡æ–°è¼‰å…¥ç¯€ç›®æ•¸æ“š...', 'info');
        
        // é‡æ–°è¼‰å…¥äº‹ä»¶æ•¸æ“š
        await loadEventsFromContentful();
        
        // é‡æ–°æ¸²æŸ“è¦–åœ–
        renderCurrentView();
        
        showStatus('âœ… ç¯€ç›®æ•¸æ“šå·²æ¢å¾©ï¼å¦‚æœç¯€ç›®ä»ç„¶ä¸è¦‹ï¼Œè«‹æª¢æŸ¥ Contentful ä¸­çš„æ•¸æ“šã€‚', 'success');
        
        // é¡¯ç¤ºçµ±è¨ˆä¿¡æ¯
        const totalPrograms = Object.values(events).flat().length;
        const totalDates = Object.keys(events).length;
        console.log(`ğŸ“Š æ¢å¾©å¾Œçµ±è¨ˆ: ${totalPrograms} å€‹ç¯€ç›®ï¼Œ${totalDates} å€‹æ—¥æœŸ`);
        
        // è¨ºæ–·ç‰¹å®šæ—¥æœŸçš„ç¯€ç›®
        const today = new Date();
        const todayString = today.getFullYear() + '-' +
                           String(today.getMonth() + 1).padStart(2, '0') + '-' +
                           String(today.getDate()).padStart(2, '0');
        
        console.log(`ğŸ” è¨ºæ–·ä»Šæ—¥ (${todayString}) çš„ç¯€ç›®:`);
        if (events[todayString]) {
          console.log(`ğŸ“… ä»Šæ—¥æœ‰ ${events[todayString].length} å€‹ç¯€ç›®:`);
          events[todayString].forEach((event, index) => {
            console.log(`  ${index + 1}. ${event.time} - ${event.title} (ID: ${event.contentfulId})`);
          });
        } else {
          console.log('âŒ ä»Šæ—¥æ²’æœ‰ä»»ä½•ç¯€ç›®');
        }
        
      } catch (error) {
        console.error('âŒ æ¢å¾©ç¯€ç›®å¤±æ•—:', error);
        showStatus('âŒ æ¢å¾©ç¯€ç›®å¤±æ•—: ' + error.message, 'error');
      }
    }

    // æ¢å¾©ç‰¹å®šç¯€ç›®
    async function recoverSpecificProgram(date, time, title) {
      try {
        console.log(`ğŸ”„ å˜—è©¦æ¢å¾©ç‰¹å®šç¯€ç›®: ${date} ${time} - ${title}`);
        showStatus(`ğŸ”„ æ­£åœ¨æ¢å¾©ç¯€ç›®ã€Œ${title}ã€...`, 'info');
        
        // æª¢æŸ¥ Contentful ä¸­æ˜¯å¦æœ‰è©²ç¯€ç›®
        if (typeof contentful !== 'undefined') {
          const client = contentful.createClient({
            space: 'os5wf90ljenp',
            accessToken: 'lODH-WLwHwVZv7O4rFdBWjSnrzaQWGD4koeOZ1Dypj0'
          });
          
          // æœç´¢è©²æ—¥æœŸçš„æ‰€æœ‰ç¯€ç›®
          const response = await client.getEntries({
            content_type: 'scheduleItem',
            'fields.airDate': date,
            limit: 100
          });
          
          console.log(`ğŸ” åœ¨ ${date} æ‰¾åˆ° ${response.items.length} å€‹ç¯€ç›®`);
          
          // å°‹æ‰¾åŒ¹é…çš„ç¯€ç›®ï¼ˆæŒ‰æ¨™é¡Œæˆ–æ™‚é–“ï¼‰
          let foundProgram = null;
          
          // é¦–å…ˆæŒ‰æ™‚é–“åŒ¹é…
          for (const item of response.items) {
            const notes = String(item.fields.notes || '');
            const timeMatch = notes.match(/\[æ™‚é–“:(\d{2}:\d{2})\]/);
            let airTime;
            
            if (timeMatch) {
              airTime = timeMatch[1];
            } else {
              airTime = convertBlockToTime(item.fields.block || '12-18');
            }
            
            console.log(`ğŸ” æª¢æŸ¥ç¯€ç›®: ${item.fields.title}, æ™‚é–“æ¨™è¨˜: ${timeMatch ? timeMatch[0] : 'ç„¡'}, è¨ˆç®—æ™‚é–“: ${airTime}, ç›®æ¨™æ™‚é–“: ${time}`);
            
            if (airTime === time) {
              foundProgram = item;
              console.log(`âœ… æŒ‰æ™‚é–“æ‰¾åˆ°ç¯€ç›®: ${item.fields.title} (${airTime})`);
              break;
            }
          }
          
          // å¦‚æœæŒ‰æ™‚é–“æ²’æ‰¾åˆ°ï¼ŒæŒ‰æ¨™é¡ŒåŒ¹é…
          if (!foundProgram) {
            for (const item of response.items) {
              if (item.fields.title && item.fields.title.includes(title)) {
                foundProgram = item;
                console.log(`âœ… æŒ‰æ¨™é¡Œæ‰¾åˆ°ç¯€ç›®: ${item.fields.title}`);
                break;
              }
            }
          }
          
          if (foundProgram) {
            // é‡å»ºç¯€ç›®æ•¸æ“šä¸¦æ·»åŠ åˆ°æœ¬åœ°
            const notes = String(foundProgram.fields.notes || '');
            const timeMatch = notes.match(/\[æ™‚é–“:(\d{2}:\d{2})\]/);
            let airTime;
            
            if (timeMatch) {
              airTime = timeMatch[1];
            } else {
              airTime = convertBlockToTime(foundProgram.fields.block || '12-18');
            }
            
            const programData = {
              title: foundProgram.fields.title,
              time: airTime,
              date: date,
              contentfulId: foundProgram.sys.id,
              description: notes,
              category: extractCategoryFromNotes(notes),
              topics: extractTopicsFromNotes(notes),
              duration: 30, // é è¨­å€¼
              status: 'é‡æ’­', // é è¨­å€¼
              published: true,
              publishedAt: new Date().toISOString()
            };
            
            // æ·»åŠ åˆ°æœ¬åœ°äº‹ä»¶
            if (!events[date]) {
              events[date] = [];
            }
            
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const existingIndex = events[date].findIndex(e => e.time === airTime);
            if (existingIndex >= 0) {
              events[date][existingIndex] = programData;
              console.log(`ğŸ”„ æ›´æ–°ç¾æœ‰ç¯€ç›®: ${airTime} - ${programData.title}`);
            } else {
              events[date].push(programData);
              console.log(`âœ… æ·»åŠ æ¢å¾©çš„ç¯€ç›®: ${airTime} - ${programData.title}`);
            }
            
            // é‡æ–°æ¸²æŸ“è¦–åœ–
            renderCurrentView();
            showStatus(`âœ… æˆåŠŸæ¢å¾©ç¯€ç›®ã€Œ${title}ã€ï¼`, 'success');
            
          } else {
            console.log(`âŒ åœ¨ Contentful ä¸­æ‰¾ä¸åˆ°ç¯€ç›®: ${date} ${time} - ${title}`);
            showStatus(`âŒ ç„¡æ³•æ‰¾åˆ°ç¯€ç›®ã€Œ${title}ã€ï¼Œå¯èƒ½å·²è¢«åˆªé™¤`, 'error');
          }
        }
        
      } catch (error) {
        console.error('âŒ æ¢å¾©ç‰¹å®šç¯€ç›®å¤±æ•—:', error);
        showStatus('âŒ æ¢å¾©ç¯€ç›®å¤±æ•—: ' + error.message, 'error');
      }
    }

    // è¨ºæ–·ç‰¹å®šæ™‚é–“çš„ç¯€ç›®
    async function diagnoseSpecificProgram(date, time) {
      try {
        console.log(`ğŸ” è¨ºæ–· ${date} ${time} çš„ç¯€ç›®...`);
        
        // æª¢æŸ¥æœ¬åœ°æ•¸æ“š
        const localEvent = getEvent(date, time);
        console.log('ğŸ“± æœ¬åœ°æ•¸æ“š:', localEvent);
        
        // æª¢æŸ¥ Contentful ä¸­çš„æ•¸æ“š
        if (typeof contentful !== 'undefined') {
          const client = contentful.createClient({
            space: 'os5wf90ljenp',
            accessToken: 'lODH-WLwHwVZv7O4rFdBWjSnrzaQWGD4koeOZ1Dypj0'
          });
          
          const response = await client.getEntries({
            content_type: 'scheduleItem',
            'fields.airDate': date,
            limit: 100
          });
          
          console.log(`ğŸ“Š Contentful ä¸­ ${date} çš„ç¯€ç›®æ•¸é‡:`, response.items.length);
          
          // æª¢æŸ¥æ˜¯å¦æœ‰åŒ¹é…æ™‚é–“çš„ç¯€ç›®
          const matchingPrograms = response.items.filter(item => {
            const notes = String(item.fields.notes || '');
            const timeMatch = notes.match(/\[æ™‚é–“:(\d{2}:\d{2})\]/);
            let airTime;
            
            if (timeMatch) {
              airTime = timeMatch[1];
            } else {
              airTime = convertBlockToTime(item.fields.block || '12-18');
            }
            
            console.log(`ğŸ” æª¢æŸ¥ç¯€ç›®: ${item.fields.title}, æ™‚é–“æ¨™è¨˜: ${timeMatch ? timeMatch[0] : 'ç„¡'}, è¨ˆç®—æ™‚é–“: ${airTime}, ç›®æ¨™æ™‚é–“: ${time}`);
            return airTime === time;
          });
          
          console.log(`ğŸ¯ åŒ¹é… ${time} æ™‚é–“çš„ç¯€ç›®:`, matchingPrograms.length);
          matchingPrograms.forEach((item, index) => {
            console.log(`  ${index + 1}. ${item.fields.title} (ID: ${item.sys.id})`);
            console.log(`     å‚™è¨»: ${String(item.fields.notes || '').substring(0, 200)}...`);
          });
          
          // å¦‚æœæ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„ç¯€ç›®ï¼Œé¡¯ç¤ºæ‰€æœ‰ç¯€ç›®çš„æ™‚é–“ä¿¡æ¯
          if (matchingPrograms.length === 0) {
            console.log(`ğŸ” æ²’æœ‰æ‰¾åˆ° ${time} çš„ç¯€ç›®ï¼Œé¡¯ç¤ºæ‰€æœ‰ç¯€ç›®çš„æ™‚é–“ä¿¡æ¯:`);
            response.items.forEach((item, index) => {
              const notes = String(item.fields.notes || '');
              const timeMatch = notes.match(/\[æ™‚é–“:(\d{2}:\d{2})\]/);
              const airTime = timeMatch ? timeMatch[1] : convertBlockToTime(item.fields.block || '12-18');
              const block = item.fields.block || '12-18';
              
              console.log(`  ${index + 1}. ${item.fields.title}`);
              console.log(`     æ™‚é–“æ¨™è¨˜: ${timeMatch ? timeMatch[0] : 'ç„¡'}`);
              console.log(`     è¨ˆç®—æ™‚é–“: ${airTime}`);
              console.log(`     æ™‚æ®µ: ${block}`);
              console.log(`     å‚™è¨»é è¦½: ${notes.substring(0, 100)}...`);
              console.log('---');
            });
          }
        }
        
      } catch (error) {
        console.error('âŒ è¨ºæ–·å¤±æ•—:', error);
      }
    }

    // è¨ºæ–·ä»Šæ—¥ 17:30 çš„ç¯€ç›®
    async function diagnoseToday1730() {
      const today = new Date();
      const todayString = today.getFullYear() + '-' +
                         String(today.getMonth() + 1).padStart(2, '0') + '-' +
                         String(today.getDate()).padStart(2, '0');
      
      console.log(`ğŸ” é–‹å§‹è¨ºæ–·ä»Šæ—¥ (${todayString}) 17:30 çš„ç¯€ç›®...`);
      showStatus('ğŸ” æ­£åœ¨è¨ºæ–· 17:30 çš„ç¯€ç›®...', 'info');
      
      await diagnoseSpecificProgram(todayString, '17:30');
      
      // é¡¯ç¤ºè¨ºæ–·çµæœ
      const localEvent = getEvent(todayString, '17:30');
      if (localEvent) {
        showStatus(`âœ… æ‰¾åˆ°æœ¬åœ°ç¯€ç›®: ${localEvent.title}`, 'success');
      } else {
        showStatus('âŒ æœ¬åœ°æ²’æœ‰æ‰¾åˆ° 17:30 çš„ç¯€ç›®', 'error');
        
        // å¦‚æœæœ¬åœ°æ²’æœ‰æ‰¾åˆ°ï¼Œå˜—è©¦æœç´¢å¯èƒ½çš„ç¯€ç›®æ¨™é¡Œ
        console.log('ğŸ” å˜—è©¦æœç´¢å¯èƒ½çš„ç¯€ç›®æ¨™é¡Œ...');
        await searchProgramByTitle(todayString, 'åŠ æ‹¿å¤§å°¼åŠ æ‹‰ç€‘å¸ƒ');
      }
    }

    // è¨ºæ–·ä»Šæ—¥ 16:30 çš„ç¯€ç›®
    async function diagnoseToday1630() {
      const today = new Date();
      const todayString = today.getFullYear() + '-' +
                         String(today.getMonth() + 1).padStart(2, '0') + '-' +
                         String(today.getDate()).padStart(2, '0');
      
      console.log(`ğŸ” é–‹å§‹è¨ºæ–·ä»Šæ—¥ (${todayString}) 16:30 çš„ç¯€ç›®...`);
      showStatus('ğŸ” æ­£åœ¨è¨ºæ–· 16:30 çš„ç¯€ç›®...', 'info');
      
      // ç›´æ¥æŸ¥è©¢ Contentful ä¸­çš„åŸå§‹æ•¸æ“š
      await directQueryContentfulFor1630(todayString);
      
      await diagnoseSpecificProgram(todayString, '16:30');
      
      // é¡¯ç¤ºè¨ºæ–·çµæœ
      const localEvent = getEvent(todayString, '16:30');
      if (localEvent) {
        showStatus(`âœ… æ‰¾åˆ°æœ¬åœ°ç¯€ç›®: ${localEvent.title}`, 'success');
      } else {
        showStatus('âŒ æœ¬åœ°æ²’æœ‰æ‰¾åˆ° 16:30 çš„ç¯€ç›®', 'error');
        
        // å¦‚æœæœ¬åœ°æ²’æœ‰æ‰¾åˆ°ï¼Œå˜—è©¦æœç´¢å¯èƒ½çš„ç¯€ç›®æ¨™é¡Œ
        console.log('ğŸ” å˜—è©¦æœç´¢å¯èƒ½çš„ç¯€ç›®æ¨™é¡Œ...');
        await searchProgramByTitle(todayString, 'åŠ æ‹¿å¤§è³æ¥“');
      }
    }

    // ç›´æ¥æŸ¥è©¢ Contentful ä¸­çš„ 16:30 ç¯€ç›®
    async function directQueryContentfulFor1630(date) {
      try {
        console.log(`ğŸ” ç›´æ¥æŸ¥è©¢ Contentful ä¸­ ${date} çš„æ‰€æœ‰ç¯€ç›®...`);
        
        if (typeof contentful === 'undefined') {
          throw new Error('Contentful SDK æœªè¼‰å…¥');
        }

        const client = contentful.createClient({
          space: 'os5wf90ljenp',
          accessToken: 'lODH-WLwHwVZv7O4rFdBWjSnrzaQWGD4koeOZ1Dypj0'
        });

        // æŸ¥è©¢è©²æ—¥æœŸçš„æ‰€æœ‰ç¯€ç›®
        const response = await client.getEntries({
          content_type: 'scheduleItem',
          'fields.airDate': date,
          limit: 100
        });

        console.log(`ğŸ“Š Contentful ä¸­ ${date} çš„åŸå§‹ç¯€ç›®æ•¸é‡:`, response.items.length);
        
        // è©³ç´°æª¢æŸ¥æ¯å€‹ç¯€ç›®
        response.items.forEach((item, index) => {
          const notes = String(item.fields.notes || '');
          const timeMatch = notes.match(/\[æ™‚é–“:(\d{2}:\d{2})\]/);
          const block = item.fields.block || '12-18';
          const airTime = timeMatch ? timeMatch[1] : convertBlockToTime(block);
          
          console.log(`ğŸ“º ç¯€ç›® ${index + 1}:`);
          console.log(`  æ¨™é¡Œ: ${item.fields.title}`);
          console.log(`  ID: ${item.sys.id}`);
          console.log(`  æ—¥æœŸ: ${item.fields.airDate}`);
          console.log(`  æ™‚æ®µ: ${block}`);
          console.log(`  æ™‚é–“æ¨™è¨˜: ${timeMatch ? timeMatch[0] : 'ç„¡'}`);
          console.log(`  è¨ˆç®—æ™‚é–“: ${airTime}`);
          console.log(`  å‚™è¨»é•·åº¦: ${notes.length}`);
          console.log(`  å‚™è¨»é è¦½: ${notes.substring(0, 200)}...`);
          
          // ç‰¹åˆ¥æª¢æŸ¥æ˜¯å¦åŒ…å« 16:30
          if (airTime === '16:30' || notes.includes('16:30')) {
            console.log(`ğŸ¯ æ‰¾åˆ° 16:30 ç›¸é—œç¯€ç›®: ${item.fields.title}`);
          }
          
          console.log('---');
        });

        // ç‰¹åˆ¥æœç´¢åŒ…å« 16:30 çš„ç¯€ç›®
        const programsWith1630 = response.items.filter(item => {
          const notes = String(item.fields.notes || '');
          return notes.includes('16:30') || notes.includes('[æ™‚é–“:16:30]');
        });

        console.log(`ğŸ¯ åŒ…å« 16:30 çš„ç¯€ç›®æ•¸é‡:`, programsWith1630.length);
        programsWith1630.forEach((item, index) => {
          console.log(`  ${index + 1}. ${item.fields.title} (ID: ${item.sys.id})`);
          console.log(`     å‚™è¨»: ${String(item.fields.notes || '').substring(0, 300)}...`);
        });

      } catch (error) {
        console.error('âŒ ç›´æ¥æŸ¥è©¢ Contentful å¤±æ•—:', error);
      }
    }

    // å‰µå»ºç¼ºå¤±çš„ 16:30 ç¯€ç›®
    async function createMissing1630Program() {
      try {
        const today = new Date();
        const todayString = today.getFullYear() + '-' +
                           String(today.getMonth() + 1).padStart(2, '0') + '-' +
                           String(today.getDate()).padStart(2, '0');
        
        console.log(`â• å˜—è©¦å‰µå»º ${todayString} 16:30 çš„ç¯€ç›®...`);
        showStatus('â• æ­£åœ¨å‰µå»º 16:30 ç¯€ç›®...', 'info');
        
        // æª¢æŸ¥æ˜¯å¦å·²ç¶“å­˜åœ¨
        const existingEvent = getEvent(todayString, '16:30');
        if (existingEvent) {
          showStatus('âš ï¸ 16:30 ç¯€ç›®å·²å­˜åœ¨: ' + existingEvent.title, 'warning');
          return;
        }
        
        // å‰µå»ºæ–°çš„ç¯€ç›®æ•¸æ“š
        const programData = {
          title: 'åŠ æ‹¿å¤§è³æ¥“ åˆ’èˆ¹',
          airDate: todayString,
          airTime: '16:30',
          duration: 30,
          category: 'è‡ªç„¶ç§˜å¢ƒ',
          description: 'åŠ æ‹¿å¤§è³æ¥“ æ¯å¹´ä¹æœˆåº•åˆ°åæœˆï¼ŒåŠ æ‹¿å¤§å¤§åœ°è¢«æ¥“ç´…é»ç‡ƒã€‚å®‰å¤§ç•¥çœçš„é˜¿å²¡æ˜†å…¬åœ’ï¼ˆAlgonquin Parkï¼‰ã€é­åŒ—å…‹çš„å‹å€«ç´å±±ï¼ˆLaurentiansï¼‰ã€ä»¥åŠæ–°æ–¯ç§‘ç´°äºçœçš„æ¥“è‘‰å¤§é“ï¼ˆCabot Trailï¼‰ï¼Œéƒ½æ˜¯è§€è³æ¥“ç´…çš„è‘—åæ™¯é»ã€‚æ»¿å±±éé‡çš„ç´…ã€æ©™ã€é‡‘é»ƒäº¤ç¹”æˆçµ•ç¾ç•«å¸ƒï¼Œå¸å¼•ç„¡æ•¸éŠå®¢å‰ä¾†æœè–ã€‚',
          status: 'é‡æ’­',
          youtubeId: 'III8KxwNGwI',
          topics: ['åŠ æ‹¿å¤§è³æ¥“ åˆ’èˆ¹']
        };
        
        // ä¸Šæ¶åˆ° Contentful
        const result = await uploadProgramSimple(programData);
        
        if (result.success) {
          showStatus('âœ… æˆåŠŸå‰µå»º 16:30 ç¯€ç›®ï¼', 'success');
          
          // é‡æ–°è¼‰å…¥æ•¸æ“š
          await loadEventsFromContentful();
          renderCurrentView();
        } else {
          showStatus('âŒ å‰µå»ºç¯€ç›®å¤±æ•—: ' + result.error, 'error');
        }
        
      } catch (error) {
        console.error('âŒ å‰µå»º 16:30 ç¯€ç›®å¤±æ•—:', error);
        showStatus('âŒ å‰µå»ºç¯€ç›®å¤±æ•—: ' + error.message, 'error');
      }
    }

    // æ ¹æ“šæ¨™é¡Œæœç´¢ç¯€ç›®
    async function searchProgramByTitle(date, searchTitle) {
      try {
        if (typeof contentful !== 'undefined') {
          const client = contentful.createClient({
            space: 'os5wf90ljenp',
            accessToken: 'lODH-WLwHwVZv7O4rFdBWjSnrzaQWGD4koeOZ1Dypj0'
          });
          
          const response = await client.getEntries({
            content_type: 'scheduleItem',
            'fields.airDate': date,
            'fields.title[match]': searchTitle,
            limit: 10
          });
          
          console.log(`ğŸ” æœç´¢æ¨™é¡ŒåŒ…å« "${searchTitle}" çš„ç¯€ç›®:`, response.items.length);
          response.items.forEach((item, index) => {
            const notes = String(item.fields.notes || '');
            const timeMatch = notes.match(/\[æ™‚é–“:(\d{2}:\d{2})\]/);
            const airTime = timeMatch ? timeMatch[1] : convertBlockToTime(item.fields.block || '12-18');
            
            console.log(`  ${index + 1}. ${item.fields.title} (ID: ${item.sys.id})`);
            console.log(`     æ™‚é–“: ${airTime}`);
            console.log(`     æ™‚æ®µ: ${item.fields.block || '12-18'}`);
            console.log(`     å‚™è¨»é è¦½: ${notes.substring(0, 150)}...`);
            console.log('---');
          });
        }
      } catch (error) {
        console.error('âŒ æœç´¢å¤±æ•—:', error);
      }
    }

    // æ¸…ç†æ‰€æœ‰å°è©±æ¡†å’Œé®ç½©å±¤
    function clearAllDialogs() {
      try {
        console.log('ğŸ§¹ é–‹å§‹æ¸…ç†æ‰€æœ‰å°è©±æ¡†å’Œé®ç½©å±¤...');
        
        // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„å°è©±æ¡†ï¼ˆå¤šç¨®é¸æ“‡å™¨ç¢ºä¿å®Œæ•´æ¸…ç†ï¼‰
        const selectors = [
          'div[style*="position: fixed"][style*="z-index: 10000"]',
          'div[style*="position: fixed"][style*="background: rgba(0,0,0"]',
          'div[style*="position: fixed"][style*="z-index: 9999"]',
          'div[style*="position: fixed"][style*="z-index: 10001"]'
        ];
        
        selectors.forEach(selector => {
          const elements = document.querySelectorAll(selector);
          elements.forEach(element => {
            if (element && element.parentElement) {
              element.remove();
              console.log('âœ… å·²ç§»é™¤å°è©±æ¡†å…ƒç´ :', selector);
            }
          });
        });
        
        // ç§»é™¤ä»»ä½•å¯èƒ½æ®˜ç•™çš„é®ç½©å±¤ï¼ˆæ›´å»£æ³›çš„é¸æ“‡å™¨ï¼‰
        const overlaySelectors = [
          'div[style*="background: rgba(0,0,0"]',
          'div[style*="background:rgba(0,0,0"]',
          'div[style*="background-color: rgba(0,0,0"]',
          'div[style*="background-color:rgba(0,0,0"]'
        ];
        
        overlaySelectors.forEach(selector => {
          const overlays = document.querySelectorAll(selector);
          overlays.forEach(overlay => {
            if (overlay && overlay.parentElement) {
              overlay.remove();
              console.log('âœ… å·²ç§»é™¤é®ç½©å±¤å…ƒç´ :', selector);
            }
          });
        });
        
        // é¡å¤–æª¢æŸ¥ï¼šç§»é™¤ä»»ä½•åŒ…å«ç‰¹å®šé¡åæˆ–IDçš„å°è©±æ¡†
        const additionalSelectors = [
          '.modal',
          '.dialog',
          '.overlay',
          '#cleanup-progress-dialog',
          '#batch-progress-dialog'
        ];
        
        additionalSelectors.forEach(selector => {
          const elements = document.querySelectorAll(selector);
          elements.forEach(element => {
            if (element && element.parentElement) {
              element.remove();
              console.log('âœ… å·²ç§»é™¤é¡å¤–å°è©±æ¡†å…ƒç´ :', selector);
            }
          });
        });
        
        // ç§»é™¤ä»»ä½•å¯èƒ½å½±éŸ¿é é¢é¡¯ç¤ºçš„æ¨£å¼
        const body = document.body;
        if (body) {
          // ç§»é™¤å¯èƒ½æ·»åŠ çš„æ¨£å¼
          body.style.overflow = '';
          body.style.pointerEvents = '';
          body.style.filter = '';
          body.style.opacity = '';
        }
        
        // ç§»é™¤ä»»ä½•å¯èƒ½æ·»åŠ çš„å…¨å±€æ¨£å¼
        const styleElements = document.querySelectorAll('style[data-dialog-style]');
        styleElements.forEach(style => {
          if (style && style.parentElement) {
            style.remove();
            console.log('âœ… å·²ç§»é™¤å°è©±æ¡†æ¨£å¼å…ƒç´ ');
          }
        });
        
        console.log('âœ… å·²æ¸…ç†æ‰€æœ‰å°è©±æ¡†å’Œé®ç½©å±¤');
        
        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        showStatus('âœ… ç·Šæ€¥æ¸…ç†å®Œæˆï¼æ‰€æœ‰å°è©±æ¡†å’Œé®ç½©å±¤å·²ç§»é™¤', 'success');
        
      } catch (error) {
        console.error('æ¸…ç†å°è©±æ¡†æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        showStatus('âŒ æ¸…ç†éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢', 'error');
      }
    }
    
    // é¡¯ç¤ºæ¸…ç†æé†’
    function showCleanupReminder(daysSinceLastCleanup) {
      const reminderDialog = document.createElement('div');
      reminderDialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      `;
      
      reminderDialog.innerHTML = `
        <div style="
          background: white;
          padding: 30px;
          border-radius: 12px;
          max-width: 500px;
          width: 90%;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        ">
          <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ§¹</div>
            <h3 style="color: #ffc107; margin-bottom: 15px;">å®šæœŸæ¸…ç†æé†’</h3>
          </div>
          
          <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <strong>æ¸…ç†æé†’ï¼š</strong><br>
            è·é›¢ä¸Šæ¬¡æ¸…ç†å·²ç¶“éäº† <strong>${daysSinceLastCleanup} å¤©</strong><br>
            å»ºè­°æ¸…ç† 30 å¤©å‰çš„èˆŠç¯€ç›®æ•¸æ“šä»¥å„ªåŒ–å­˜å„²ç©ºé–“
          </div>
          
          <div style="background: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; border-radius: 8px; margin-bottom: 25px;">
            <strong>æ¸…ç†å¥½è™•ï¼š</strong><br>
            â€¢ æ¸›å°‘ Contentful å­˜å„²æˆæœ¬<br>
            â€¢ æå‡æŸ¥è©¢æ€§èƒ½<br>
            â€¢ ä¿æŒæ•¸æ“šæ•´æ½”<br>
            â€¢ é¿å… API é™åˆ¶
          </div>
          
          <div style="text-align: center;">
            <button id="remindLater" style="
              background: #6c757d;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 6px;
              margin-right: 15px;
              cursor: pointer;
              font-size: 1rem;
            ">ç¨å¾Œæé†’</button>
            <button id="startCleanup" style="
              background: #dc3545;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 1rem;
            ">ç«‹å³æ¸…ç†</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(reminderDialog);
      
      // ç¨å¾Œæé†’æŒ‰éˆ•
      document.getElementById('remindLater').onclick = () => {
        // è¨­ç½® 7 å¤©å¾Œå†æ¬¡æé†’
        const nextReminder = new Date();
        nextReminder.setDate(nextReminder.getDate() + 7);
        localStorage.setItem('last_contentful_cleanup', nextReminder.toISOString());
        document.body.removeChild(reminderDialog);
        showStatus('å·²è¨­ç½® 7 å¤©å¾Œå†æ¬¡æé†’', 'info');
      };
      
      // ç«‹å³æ¸…ç†æŒ‰éˆ•
      document.getElementById('startCleanup').onclick = () => {
        document.body.removeChild(reminderDialog);
        cleanupOldContentfulData();
      };
    }

    // æ¸…ç† Contentful ä¸­çš„èˆŠæ•¸æ“š
    async function cleanupOldContentfulData() {
      try {
        // ç¢ºèªå°è©±æ¡†
        const confirmed = confirm(
          'âš ï¸ æ¸…ç†èˆŠæ•¸æ“šè­¦å‘Š\n\n' +
          'æ­¤æ“ä½œå°‡åˆªé™¤ Contentful ä¸­ 30 å¤©å‰çš„ç¯€ç›®æ•¸æ“šã€‚\n\n' +
          'â€¢ åªæœƒåˆªé™¤å·²éæœŸçš„ç¯€ç›®\n' +
          'â€¢ ä¸æœƒå½±éŸ¿ç•¶å‰å’Œæœªä¾†çš„ç¯€ç›®\n' +
          'â€¢ æ­¤æ“ä½œç„¡æ³•å¾©åŸ\n\n' +
          'ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ'
        );
        
        if (!confirmed) {
          showStatus('å·²å–æ¶ˆæ¸…ç†æ“ä½œ', 'info');
          return;
        }
        
        showStatus('é–‹å§‹æ¸…ç†èˆŠæ•¸æ“š...', 'info');
        
        // æª¢æŸ¥ Management SDK
        if (typeof contentfulManagement === 'undefined') {
          throw new Error('Management SDK æœªè¼‰å…¥');
        }
        
        // æª¢æŸ¥ API Token
        const managementToken = window.CONTENTFUL_CONFIG?.MANAGEMENT_TOKEN || window.CONTENTFUL_MANAGEMENT_TOKEN;
        if (!managementToken) {
          throw new Error('Management Token æœªè¨­å®š');
        }
        
        // å‰µå»º Management å®¢æˆ¶ç«¯
        const managementClient = contentfulManagement.createClient({
          accessToken: managementToken
        });
        
        // ç²å– Space å’Œ Environment
        const spaceId = window.CONTENTFUL_CONFIG?.SPACE_ID || 'os5wf90ljenp';
        const space = await managementClient.getSpace(spaceId);
        const environment = await space.getEnvironment('master');
        
        // è¨ˆç®— 30 å¤©å‰çš„æ—¥æœŸ
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const cutoffDate = thirtyDaysAgo.toISOString().split('T')[0];
        
        console.log('ğŸ—‘ï¸ æ¸…ç†æ—¥æœŸé–¾å€¼:', cutoffDate);
        
        // ç²å–æ‰€æœ‰ç¯€ç›®æ•¸æ“š
        const entries = await environment.getEntries({
          content_type: 'scheduleItem',
          limit: 1000
        });
        
        console.log('ğŸ“Š ç¸½å…±æ‰¾åˆ°', entries.items.length, 'å€‹ç¯€ç›®');
        
        let deletedCount = 0;
        let errorCount = 0;
        
        // å‰µå»ºé€²åº¦å°è©±æ¡†
        const progressDialog = document.createElement('div');
        progressDialog.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        `;
        
        progressDialog.innerHTML = `
          <div style="
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          ">
            <h3 style="margin-bottom: 20px; color: #dc3545;">ğŸ—‘ï¸ æ¸…ç†èˆŠæ•¸æ“š</h3>
            <div style="margin-bottom: 20px;">
              <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <strong>æ¸…ç†æ¢ä»¶ï¼š</strong>åˆªé™¤ ${cutoffDate} ä¹‹å‰çš„ç¯€ç›®<br>
                <strong>ç¸½ç¯€ç›®æ•¸ï¼š</strong>${entries.items.length} å€‹
              </div>
              <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                  <span>é€²åº¦ï¼š</span>
                  <span id="progressText">0 / ${entries.items.length}</span>
                </div>
                <div style="background: #ddd; height: 20px; border-radius: 10px; overflow: hidden;">
                  <div id="progressBar" style="background: #dc3545; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                </div>
              </div>
            </div>
            <div id="statusText" style="color: #666; font-size: 0.9rem;">æº–å‚™é–‹å§‹æ¸…ç†...</div>
          </div>
        `;
        
        document.body.appendChild(progressDialog);
        
        // æ›´æ–°é€²åº¦
        function updateProgress(current, total, status) {
          const progressBar = document.getElementById('progressBar');
          const progressText = document.getElementById('progressText');
          const statusText = document.getElementById('statusText');
          
          const percentage = (current / total) * 100;
          progressBar.style.width = percentage + '%';
          progressText.textContent = `${current} / ${total}`;
          statusText.textContent = status;
        }
        
        // æª¢æŸ¥ä¸¦åˆªé™¤èˆŠç¯€ç›®
        for (let i = 0; i < entries.items.length; i++) {
          const entry = entries.items[i];
          const airDate = entry.fields.airDate || '';
          
          updateProgress(i, entries.items.length, `æª¢æŸ¥ç¯€ç›®: ${entry.fields.title || 'æœªçŸ¥'}`);
          
          // å¦‚æœç¯€ç›®æ—¥æœŸæ—©æ–¼æˆªæ­¢æ—¥æœŸï¼Œå‰‡åˆªé™¤
          if (airDate && airDate < cutoffDate) {
            try {
              console.log('ğŸ—‘ï¸ åˆªé™¤èˆŠç¯€ç›®:', entry.fields.title, 'æ—¥æœŸ:', airDate);
              
              // å…ˆå–æ¶ˆç™¼å¸ƒï¼Œå†åˆªé™¤
              if (entry.isPublished()) {
                await entry.unpublish();
              }
              await entry.delete();
              
              deletedCount++;
              updateProgress(i + 1, entries.items.length, `å·²åˆªé™¤: ${entry.fields.title}`);
              
            } catch (error) {
              console.error('âŒ åˆªé™¤å¤±æ•—:', entry.fields.title, error);
              errorCount++;
              updateProgress(i + 1, entries.items.length, `åˆªé™¤å¤±æ•—: ${entry.fields.title}`);
            }
          } else {
            updateProgress(i + 1, entries.items.length, `ä¿ç•™ç¯€ç›®: ${entry.fields.title}`);
          }
          
          // æ·»åŠ å°å»¶é²é¿å… API é™åˆ¶
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // å®Œæˆæ¸…ç†
        document.body.removeChild(progressDialog);
        
        const resultMessage = `æ¸…ç†å®Œæˆï¼\n\n` +
          `âœ… å·²åˆªé™¤: ${deletedCount} å€‹èˆŠç¯€ç›®\n` +
          `âŒ åˆªé™¤å¤±æ•—: ${errorCount} å€‹ç¯€ç›®\n` +
          `ğŸ“… ä¿ç•™: ${entries.items.length - deletedCount - errorCount} å€‹ç¯€ç›®`;
        
        alert(resultMessage);
        showStatus(`æ¸…ç†å®Œæˆï¼šåˆªé™¤ ${deletedCount} å€‹èˆŠç¯€ç›®`, 'success');
        
        // æ›´æ–°æœ€å¾Œæ¸…ç†æ™‚é–“
        localStorage.setItem('last_contentful_cleanup', new Date().toISOString());
        
      } catch (error) {
        console.error('âŒ æ¸…ç†èˆŠæ•¸æ“šå¤±æ•—:', error);
        showStatus(`æ¸…ç†å¤±æ•—: ${error.message}`, 'error');
      }
    }

    // é¡¯ç¤º Contentful æ•¸æ“šçµ±è¨ˆ
    async function showContentfulStats() {
      try {
        showStatus('æ­£åœ¨ç²å–æ•¸æ“šçµ±è¨ˆ...', 'info');
        
        // æª¢æŸ¥ Management SDK
        if (typeof contentfulManagement === 'undefined') {
          throw new Error('Management SDK æœªè¼‰å…¥');
        }
        
        // æª¢æŸ¥ API Token
        const managementToken = window.CONTENTFUL_CONFIG?.MANAGEMENT_TOKEN || window.CONTENTFUL_MANAGEMENT_TOKEN;
        if (!managementToken) {
          throw new Error('Management Token æœªè¨­å®š');
        }
        
        // å‰µå»º Management å®¢æˆ¶ç«¯
        const managementClient = contentfulManagement.createClient({
          accessToken: managementToken
        });
        
        // ç²å– Space å’Œ Environment
        const spaceId = window.CONTENTFUL_CONFIG?.SPACE_ID || 'os5wf90ljenp';
        const space = await managementClient.getSpace(spaceId);
        const environment = await space.getEnvironment('master');
        
        // ç²å–æ‰€æœ‰ç¯€ç›®æ•¸æ“š
        const entries = await environment.getEntries({
          content_type: 'scheduleItem',
          limit: 1000
        });
        
        // çµ±è¨ˆæ•¸æ“š
        const now = new Date();
        const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        const sixtyDaysAgo = new Date(now.getTime() - 60 * 24 * 60 * 60 * 1000);
        
        let totalPrograms = entries.items.length;
        let publishedPrograms = 0;
        let draftPrograms = 0;
        let recentPrograms = 0; // 30å¤©å…§
        let oldPrograms = 0; // 60å¤©å‰
        let duplicatePrograms = 0;
        
        // çµ±è¨ˆå„ç¨®ç‹€æ…‹
        const programMap = new Map();
        
        entries.items.forEach(entry => {
          // çµ±è¨ˆç™¼å¸ƒç‹€æ…‹
          if (entry.isPublished()) {
            publishedPrograms++;
          } else {
            draftPrograms++;
          }
          
          // çµ±è¨ˆæ™‚é–“
          const airDate = entry.fields.airDate || '';
          if (airDate) {
            const programDate = new Date(airDate);
            if (programDate >= thirtyDaysAgo) {
              recentPrograms++;
            }
            if (programDate < sixtyDaysAgo) {
              oldPrograms++;
            }
          }
          
          // æª¢æŸ¥é‡è¤‡ç¯€ç›®
          const title = entry.fields.title || '';
          const notes = String(entry.fields.notes || '');
          const youtubeMatch = notes.match(/\[YouTube:([^\]]+)\]/);
          const youtubeId = youtubeMatch ? youtubeMatch[1] : '';
          
          const key = `${title}_${youtubeId}`;
          if (programMap.has(key)) {
            duplicatePrograms++;
          } else {
            programMap.set(key, 1);
          }
        });
        
        // è¨ˆç®—å­˜å„²æˆæœ¬ä¼°ç®—ï¼ˆContentful æŒ‰ entry æ”¶è²»ï¼‰
        const estimatedCost = Math.ceil(totalPrograms / 1000) * 5; // å‡è¨­æ¯1000å€‹entryç´„5ç¾å…ƒ
        
        // é¡¯ç¤ºçµ±è¨ˆå°è©±æ¡†
        const statsDialog = document.createElement('div');
        statsDialog.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        `;
        
        statsDialog.innerHTML = `
          <div style="
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          ">
            <div style="text-align: center; margin-bottom: 25px;">
              <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ“Š</div>
              <h3 style="color: #17a2b8; margin-bottom: 10px;">Contentful æ•¸æ“šçµ±è¨ˆ</h3>
              <p style="color: #666; font-size: 0.9rem;">æœ€å¾Œæ›´æ–°ï¼š${new Date().toLocaleString()}</p>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
              <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; text-align: center;">
                <div style="font-size: 2rem; font-weight: bold; color: #1976d2;">${totalPrograms}</div>
                <div style="color: #666; font-size: 0.9rem;">ç¸½ç¯€ç›®æ•¸</div>
              </div>
              <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; text-align: center;">
                <div style="font-size: 2rem; font-weight: bold; color: #2e7d32;">${publishedPrograms}</div>
                <div style="color: #666; font-size: 0.9rem;">å·²ç™¼å¸ƒ</div>
              </div>
              <div style="background: #fff3e0; padding: 20px; border-radius: 8px; text-align: center;">
                <div style="font-size: 2rem; font-weight: bold; color: #f57c00;">${draftPrograms}</div>
                <div style="color: #666; font-size: 0.9rem;">è‰ç¨¿</div>
              </div>
              <div style="background: #fce4ec; padding: 20px; border-radius: 8px; text-align: center;">
                <div style="font-size: 2rem; font-weight: bold; color: #c2185b;">${duplicatePrograms}</div>
                <div style="color: #666; font-size: 0.9rem;">é‡è¤‡ç¯€ç›®</div>
              </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h4 style="margin-bottom: 15px; color: #495057;">ğŸ“… æ™‚é–“åˆ†å¸ƒ</h4>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>æœ€è¿‘ 30 å¤©ï¼š</span>
                <strong style="color: #28a745;">${recentPrograms} å€‹</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>60 å¤©å‰ï¼š</span>
                <strong style="color: #dc3545;">${oldPrograms} å€‹</strong>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span>å…¶ä»–æ™‚é–“ï¼š</span>
                <strong style="color: #6c757d;">${totalPrograms - recentPrograms - oldPrograms} å€‹</strong>
              </div>
            </div>
            
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h4 style="margin-bottom: 15px; color: #856404;">ğŸ’° æˆæœ¬ä¼°ç®—</h4>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>Entry æ•¸é‡ï¼š</span>
                <strong>${totalPrograms} å€‹</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>ä¼°ç®—æœˆæˆæœ¬ï¼š</span>
                <strong style="color: #dc3545;">ç´„ $${estimatedCost}</strong>
              </div>
              <div style="font-size: 0.85rem; color: #856404; margin-top: 10px;">
                * æ­¤ç‚ºä¼°ç®—å€¼ï¼Œå¯¦éš›è²»ç”¨è«‹åƒè€ƒ Contentful å®šåƒ¹
              </div>
            </div>
            
            <div style="background: #d1ecf1; border: 1px solid #bee5eb; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
              <h4 style="margin-bottom: 15px; color: #0c5460;">ğŸ’¡ å„ªåŒ–å»ºè­°</h4>
              ${oldPrograms > 0 ? `<div style="margin-bottom: 8px;">â€¢ å»ºè­°æ¸…ç† ${oldPrograms} å€‹ 60 å¤©å‰çš„èˆŠç¯€ç›®</div>` : ''}
              ${duplicatePrograms > 0 ? `<div style="margin-bottom: 8px;">â€¢ ç™¼ç¾ ${duplicatePrograms} å€‹é‡è¤‡ç¯€ç›®ï¼Œå»ºè­°æª¢æŸ¥</div>` : ''}
              ${totalPrograms > 500 ? `<div style="margin-bottom: 8px;">â€¢ ç¯€ç›®æ•¸é‡è¼ƒå¤šï¼Œå»ºè­°å®šæœŸæ¸…ç†èˆŠæ•¸æ“š</div>` : ''}
              ${totalPrograms <= 500 ? `<div style="margin-bottom: 8px;">â€¢ æ•¸æ“šé‡é©ä¸­ï¼Œå»ºè­°æ¯ 60 å¤©æ¸…ç†ä¸€æ¬¡</div>` : ''}
            </div>
            
            <div style="text-align: center;">
              <button id="closeStatsDialog" style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 1rem;
                margin-right: 15px;
              ">é—œé–‰</button>
              ${oldPrograms > 0 ? `
                <button id="cleanupFromStats" style="
                  background: #dc3545;
                  color: white;
                  border: none;
                  padding: 12px 24px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 1rem;
                ">ç«‹å³æ¸…ç†</button>
              ` : ''}
            </div>
          </div>
        `;
        
        document.body.appendChild(statsDialog);
        
        // æ·»åŠ é—œé–‰æŒ‰éˆ•äº‹ä»¶è™•ç†å™¨
        document.getElementById('closeStatsDialog').onclick = () => {
          document.body.removeChild(statsDialog);
        };
        
        // æ·»åŠ æ¸…ç†æŒ‰éˆ•äº‹ä»¶è™•ç†å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const cleanupBtn = document.getElementById('cleanupFromStats');
        if (cleanupBtn) {
          cleanupBtn.onclick = () => {
            document.body.removeChild(statsDialog);
            cleanupOldContentfulData();
          };
        }
        
        // æ·»åŠ é»æ“ŠèƒŒæ™¯é—œé–‰åŠŸèƒ½
        statsDialog.onclick = (e) => {
          if (e.target === statsDialog) {
            document.body.removeChild(statsDialog);
          }
        };
        
        // æ·»åŠ  ESC éµé—œé–‰åŠŸèƒ½
        const handleKeyPress = (e) => {
          if (e.key === 'Escape') {
            document.body.removeChild(statsDialog);
            document.removeEventListener('keydown', handleKeyPress);
          }
        };
        document.addEventListener('keydown', handleKeyPress);
        
        showStatus('æ•¸æ“šçµ±è¨ˆè¼‰å…¥å®Œæˆ', 'success');
        
      } catch (error) {
        console.error('âŒ ç²å–æ•¸æ“šçµ±è¨ˆå¤±æ•—:', error);
        showStatus(`ç²å–çµ±è¨ˆå¤±æ•—: ${error.message}`, 'error');
      }
    }

    // é¡¯ç¤ºå¾æ­·å²è¤‡è£½å°è©±æ¡†
    async function showCopyFromHistoryDialog() {
      try {
        showStatus('æ­£åœ¨è¼‰å…¥æ­·å²ç¯€ç›®...', 'info');
        
        // æª¢æŸ¥ Management SDK
        if (typeof contentfulManagement === 'undefined') {
          throw new Error('Management SDK æœªè¼‰å…¥');
        }
        
        // æª¢æŸ¥ API Token
        const managementToken = window.CONTENTFUL_CONFIG?.MANAGEMENT_TOKEN || window.CONTENTFUL_MANAGEMENT_TOKEN;
        if (!managementToken) {
          throw new Error('Management Token æœªè¨­å®š');
        }
        
        // å‰µå»º Management å®¢æˆ¶ç«¯
        const managementClient = contentfulManagement.createClient({
          accessToken: managementToken
        });
        
        // ç²å– Space å’Œ Environment
        const spaceId = window.CONTENTFUL_CONFIG?.SPACE_ID || 'os5wf90ljenp';
        const space = await managementClient.getSpace(spaceId);
        const environment = await space.getEnvironment('master');
        
        // ç²å–æœ€è¿‘ 2 å€‹æœˆçš„ç¯€ç›®æ•¸æ“š
        const twoMonthsAgo = new Date();
        twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);
        const cutoffDate = twoMonthsAgo.toISOString().split('T')[0];
        
        const entries = await environment.getEntries({
          content_type: 'scheduleItem',
          'fields.airDate[gte]': cutoffDate,
          limit: 500,
          order: '-fields.airDate'
        });
        
        console.log('ğŸ“š è¼‰å…¥æ­·å²ç¯€ç›®:', entries.items.length, 'å€‹');
        console.log('ğŸ“š è¼‰å…¥çš„ç¯€ç›®è©³æƒ…:', entries.items.map(entry => ({
          id: entry.sys.id,
          title: entry.fields.title,
          airDate: entry.fields.airDate,
          notes: entry.fields.notes
        })));
        
        // æŒ‰æ—¥æœŸåˆ†çµ„ç¯€ç›®
        const programsByDate = {};
        entries.items.forEach(entry => {
          const airDate = entry.fields.airDate || '';
          const notes = String(entry.fields.notes || '');
          const timeMatch = notes.match(/\[æ™‚é–“:(\d{2}:\d{2})\]/);
          const airTime = timeMatch ? timeMatch[1] : '';
          
          console.log('ğŸ“š è™•ç†ç¯€ç›®:', {
            title: entry.fields.title,
            airDate: airDate,
            airTime: airTime,
            notes: notes
          });
          
          if (airDate && airTime) {
            if (!programsByDate[airDate]) {
              programsByDate[airDate] = [];
            }
            programsByDate[airDate].push({
              id: entry.sys.id,
              title: entry.fields.title || '',
              time: airTime,
              status: entry.fields.status || '',
              notes: notes
            });
          }
        });
        
        console.log('ğŸ“š æŒ‰æ—¥æœŸåˆ†çµ„çš„ç¯€ç›®:', programsByDate);
        
        // å‰µå»ºæ­·å²è¤‡è£½å°è©±æ¡†
        const historyDialog = document.createElement('div');
        historyDialog.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        `;
        
        const sortedDates = Object.keys(programsByDate).sort().reverse();
        
        // æª¢æŸ¥æ˜¯å¦æœ‰æ­·å²æ•¸æ“š
        if (sortedDates.length === 0) {
          alert('âš ï¸ æ²’æœ‰æ‰¾åˆ°æ­·å²ç¯€ç›®æ•¸æ“š\n\nå¯èƒ½åŸå› ï¼š\nâ€¢ æœ€è¿‘ 2 å€‹æœˆå…§æ²’æœ‰ç¯€ç›®\nâ€¢ Contentful é€£æ¥å•é¡Œ\nâ€¢ ç¯€ç›®æ•¸æ“šæ ¼å¼å•é¡Œ\n\nè«‹æª¢æŸ¥æ§åˆ¶å°æ—¥èªŒç²å–è©³ç´°ä¿¡æ¯ã€‚');
          showStatus('æ²’æœ‰æ‰¾åˆ°æ­·å²ç¯€ç›®æ•¸æ“š', 'warning');
          return;
        }
        
        const dateOptions = sortedDates.map(date => {
          const programs = programsByDate[date];
          const dateStr = new Date(date).toLocaleDateString('zh-TW');
          return `<option value="${date}">${dateStr} (${programs.length} å€‹ç¯€ç›®)</option>`;
        }).join('');
        
        historyDialog.innerHTML = `
          <div style="
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          ">
            <div style="text-align: center; margin-bottom: 25px;">
              <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ“š</div>
              <h3 style="color: #6f42c1; margin-bottom: 10px;">å¾æ­·å²ç¯€ç›®è¤‡è£½</h3>
              <p style="color: #666; font-size: 0.9rem;">é¸æ“‡æ­·å²æ—¥æœŸå’Œæ™‚é–“æ§½ï¼Œæ‰¹é‡è¤‡è£½åˆ°ç•¶å‰ç¯€ç›®</p>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h4 style="margin-bottom: 15px; color: #495057;">ğŸ“… é¸æ“‡æ­·å²æ—¥æœŸ</h4>
              <select id="historyDateSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                <option value="">-- é¸æ“‡æ—¥æœŸ --</option>
                ${dateOptions}
              </select>
            </div>
            
            <div id="timeSlotsContainer" style="display: none;">
              <h4 style="margin-bottom: 15px; color: #495057;">â° é¸æ“‡æ™‚é–“æ§½</h4>
              <div id="timeSlotsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px;">
                <!-- æ™‚é–“æ§½å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
              </div>
            </div>
            
            <div id="copyOptionsContainer" style="display: none; background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h4 style="margin-bottom: 15px; color: #1976d2;">ğŸ“‹ è¤‡è£½é¸é …</h4>
              <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; margin-bottom: 10px;">
                  <input type="radio" name="copyMode" value="sameDay" checked style="margin-right: 8px;">
                  <span>è¤‡è£½åˆ°ç•¶å¤©ç›¸åŒæ™‚é–“æ§½</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 10px;">
                  <input type="radio" name="copyMode" value="batchDays" style="margin-right: 8px;">
                  <span>æ‰¹é‡è¤‡è£½åˆ°å¤šå¤©</span>
                </label>
              </div>
              
              <div id="batchOptions" style="display: none;">
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 600;">è¤‡è£½å¤©æ•¸ï¼š</label>
                  <div style="display: flex; gap: 10px; align-items: center;">
                    <label style="display: flex; align-items: center;">
                      <input type="radio" name="copyDays" value="30" checked style="margin-right: 5px;">
                      <span>30 å¤©</span>
                    </label>
                    <label style="display: flex; align-items: center;">
                      <input type="radio" name="copyDays" value="31" style="margin-right: 5px;">
                      <span>31 å¤©</span>
                    </label>
                    <label style="display: flex; align-items: center;">
                      <input type="radio" name="copyDays" value="custom" style="margin-right: 5px;">
                      <span>è‡ªè¨‚ï¼š</span>
                    </label>
                    <input type="number" id="customDays" min="1" max="365" value="30" style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;" disabled>
                  </div>
                </div>
              </div>
            </div>
            
            <div style="text-align: center;">
              <button id="closeHistoryDialog" style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 1rem;
                margin-right: 15px;
              ">å–æ¶ˆ</button>
              <button id="confirmHistoryCopy" style="
                background: #6f42c1;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 1rem;
                display: none;
              ">ç¢ºèªè¤‡è£½</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(historyDialog);
        
        // æ·»åŠ äº‹ä»¶è™•ç†å™¨
        document.getElementById('closeHistoryDialog').onclick = () => {
          document.body.removeChild(historyDialog);
        };
        
        // æ—¥æœŸé¸æ“‡äº‹ä»¶
        document.getElementById('historyDateSelect').onchange = (e) => {
          const selectedDate = e.target.value;
          if (selectedDate) {
            showTimeSlotsForDate(selectedDate, programsByDate[selectedDate]);
            document.getElementById('timeSlotsContainer').style.display = 'block';
            document.getElementById('copyOptionsContainer').style.display = 'block';
          } else {
            document.getElementById('timeSlotsContainer').style.display = 'none';
            document.getElementById('copyOptionsContainer').style.display = 'none';
          }
        };
        
        // è¤‡è£½æ¨¡å¼é¸æ“‡äº‹ä»¶
        document.querySelectorAll('input[name="copyMode"]').forEach(radio => {
          radio.onchange = (e) => {
            const batchOptions = document.getElementById('batchOptions');
            if (e.target.value === 'batchDays') {
              batchOptions.style.display = 'block';
            } else {
              batchOptions.style.display = 'none';
            }
          };
        });
        
        // è‡ªè¨‚å¤©æ•¸é¸é …
        document.querySelectorAll('input[name="copyDays"]').forEach(radio => {
          radio.onchange = (e) => {
            const customDaysInput = document.getElementById('customDays');
            if (e.target.value === 'custom') {
              customDaysInput.disabled = false;
            } else {
              customDaysInput.disabled = true;
            }
          };
        });
        
        // ç¢ºèªè¤‡è£½äº‹ä»¶
        document.getElementById('confirmHistoryCopy').onclick = () => {
          const selectedDate = document.getElementById('historyDateSelect').value;
          const selectedTimeSlots = Array.from(document.querySelectorAll('input[name="timeSlot"]:checked')).map(cb => cb.value);
          const copyMode = document.querySelector('input[name="copyMode"]:checked').value;
          
          if (selectedTimeSlots.length === 0) {
            alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ™‚é–“æ§½');
            return;
          }
          
          document.body.removeChild(historyDialog);
          executeHistoryCopy(selectedDate, selectedTimeSlots, copyMode, programsByDate);
        };
        
        showStatus('æ­·å²ç¯€ç›®è¼‰å…¥å®Œæˆ', 'success');
        
      } catch (error) {
        console.error('âŒ è¼‰å…¥æ­·å²ç¯€ç›®å¤±æ•—:', error);
        showStatus(`è¼‰å…¥æ­·å²ç¯€ç›®å¤±æ•—: ${error.message}`, 'error');
      }
    }
    
    // é¡¯ç¤ºæŒ‡å®šæ—¥æœŸçš„æ™‚é–“æ§½
    function showTimeSlotsForDate(date, programs) {
      const timeSlotsGrid = document.getElementById('timeSlotsGrid');
      const confirmButton = document.getElementById('confirmHistoryCopy');
      
      timeSlotsGrid.innerHTML = '';
      
      // æŒ‰æ™‚é–“æ’åº
      programs.sort((a, b) => a.time.localeCompare(b.time));
      
      programs.forEach(program => {
        const timeSlotDiv = document.createElement('div');
        timeSlotDiv.style.cssText = `
          background: #f8f9fa;
          border: 2px solid #e9ecef;
          border-radius: 8px;
          padding: 15px;
          cursor: pointer;
          transition: all 0.3s ease;
        `;
        
        timeSlotDiv.innerHTML = `
          <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
            <input type="checkbox" name="timeSlot" value="${program.time}" style="margin-right: 10px; transform: scale(1.2);">
            <div>
              <div style="font-weight: 600; color: #333; margin-bottom: 5px;">${program.time}</div>
              <div style="font-size: 0.9rem; color: #666; margin-bottom: 3px;">${program.title}</div>
              <div style="font-size: 0.8rem; color: #999;">${program.status}</div>
            </div>
          </label>
        `;
        
        timeSlotsGrid.appendChild(timeSlotDiv);
      });
      
      // æ·»åŠ å…¨é¸/å–æ¶ˆå…¨é¸
      const selectAllDiv = document.createElement('div');
      selectAllDiv.style.cssText = `
        grid-column: 1 / -1;
        background: #e3f2fd;
        border: 2px solid #2196f3;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        margin-bottom: 10px;
      `;
      
      selectAllDiv.innerHTML = `
        <label style="display: flex; align-items: center; justify-content: center; cursor: pointer; margin: 0;">
          <input type="checkbox" id="selectAllTimeSlots" style="margin-right: 10px; transform: scale(1.2);">
          <span style="font-weight: 600; color: #1976d2;">å…¨é¸/å–æ¶ˆå…¨é¸</span>
        </label>
      `;
      
      timeSlotsGrid.insertBefore(selectAllDiv, timeSlotsGrid.firstChild);
      
      // å…¨é¸åŠŸèƒ½
      document.getElementById('selectAllTimeSlots').onchange = (e) => {
        const checkboxes = document.querySelectorAll('input[name="timeSlot"]');
        checkboxes.forEach(cb => cb.checked = e.target.checked);
        updateConfirmButton();
      };
      
      // å€‹åˆ¥é¸æ“‡äº‹ä»¶
      document.querySelectorAll('input[name="timeSlot"]').forEach(cb => {
        cb.onchange = updateConfirmButton;
      });
      
      function updateConfirmButton() {
        const selectedCount = document.querySelectorAll('input[name="timeSlot"]:checked').length;
        if (selectedCount > 0) {
          confirmButton.style.display = 'inline-block';
          confirmButton.textContent = `ç¢ºèªè¤‡è£½ (${selectedCount} å€‹æ™‚é–“æ§½)`;
        } else {
          confirmButton.style.display = 'none';
        }
      }
    }
    
    // åŸ·è¡Œæ­·å²è¤‡è£½
    async function executeHistoryCopy(selectedDate, selectedTimeSlots, copyMode, programsByDate) {
      try {
        showStatus('é–‹å§‹å¾æ­·å²è¤‡è£½ç¯€ç›®...', 'info');
        
        const programs = programsByDate[selectedDate];
        const selectedPrograms = programs.filter(p => selectedTimeSlots.includes(p.time));
        
        console.log('ğŸ“š é¸æ“‡çš„æ­·å²ç¯€ç›®:', selectedPrograms);
        
        // ç²å–ç•¶å‰æ¨¡æ…‹æ¡†çš„æ•¸æ“š
        const currentProgramData = {
          title: document.getElementById('title').value,
          category: document.getElementById('category').value,
          topics: Array.from(document.querySelectorAll('input[name="topic"]:checked')).map(cb => cb.value),
          description: document.getElementById('description').value,
          youtubeId: document.getElementById('youtubeId').value,
          duration: document.getElementById('duration').value,
          status: document.getElementById('status').value
        };
        
        if (!currentProgramData.title) {
          alert('è«‹å…ˆå¡«å¯«ç¯€ç›®æ¨™é¡Œ');
          return;
        }
        
        let programsToUpload = [];
        
        if (copyMode === 'sameDay') {
          // è¤‡è£½åˆ°ç•¶å¤©ç›¸åŒæ™‚é–“æ§½
          const currentDate = document.getElementById('editDate').value;
          selectedTimeSlots.forEach(time => {
            programsToUpload.push({
              ...currentProgramData,
              airDate: currentDate,
              airTime: time
            });
          });
        } else {
          // æ‰¹é‡è¤‡è£½åˆ°å¤šå¤©
          const currentDate = document.getElementById('editDate').value;
          const copyDays = document.querySelector('input[name="copyDays"]:checked').value;
          const customDays = document.getElementById('customDays').value;
          
          let daysToCopy = copyDays === 'custom' ? parseInt(customDays) : parseInt(copyDays);
          const dates = generateCrossMonthDates(currentDate, daysToCopy);
          
          dates.forEach(date => {
            selectedTimeSlots.forEach(time => {
              programsToUpload.push({
                ...currentProgramData,
                airDate: date,
                airTime: time
              });
            });
          });
        }
        
        console.log('ğŸ“š æº–å‚™ä¸Šæ¶ç¯€ç›®:', programsToUpload.length, 'å€‹');
        
        // å‰µå»ºé€²åº¦å°è©±æ¡†
        const progressDialog = createBatchProgressDialog(programsToUpload.length, 'å¾æ­·å²è¤‡è£½ç¯€ç›®');
        document.body.appendChild(progressDialog);
        
        let successCount = 0;
        let errorCount = 0;
        let skippedCount = 0;
        
        for (let i = 0; i < programsToUpload.length; i++) {
          const programData = programsToUpload[i];
          
          updateBatchProgress(progressDialog, i + 1, programsToUpload.length, 
            `æ­£åœ¨ä¸Šæ¶: ${programData.airDate} ${programData.airTime} - ${programData.title}`);
          
          try {
            const result = await uploadProgramSimple(programData);
            if (result.success) {
              if (result.skipped) {
                skippedCount++;
              } else {
                successCount++;
              }
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error(`âŒ ä¸Šæ¶å¤±æ•— ${i + 1}/${programsToUpload.length}:`, error);
            errorCount++;
          }
          
          // æ·»åŠ å°å»¶é²
          await new Promise(resolve => setTimeout(resolve, 200));
        }
        
        // å®Œæˆé€²åº¦
        updateBatchProgressComplete(progressDialog, successCount, errorCount, skippedCount);
        
        showStatus(`å¾æ­·å²è¤‡è£½å®Œæˆï¼šæˆåŠŸ ${successCount}ï¼Œå¤±æ•— ${errorCount}ï¼Œè·³é ${skippedCount}`, 'success');
        
      } catch (error) {
        console.error('âŒ å¾æ­·å²è¤‡è£½å¤±æ•—:', error);
        showStatus(`å¾æ­·å²è¤‡è£½å¤±æ•—: ${error.message}`, 'error');
      }
    }

    // é¡¯ç¤ºè¦†è“‹ç¢ºèªå°è©±æ¡†
    function showOverwriteConfirmation(existingTitle, time, date, isBatchCopy = false, originalDate = null) {
      return new Promise((resolve) => {
        const dialog = document.createElement('div');
        dialog.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        `;
        
        dialog.innerHTML = `
          <div style="
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          ">
            <div style="text-align: center; margin-bottom: 20px;">
              <div style="font-size: 3rem; margin-bottom: 15px;">âš ï¸</div>
              <h3 style="color: #dc3545; margin-bottom: 15px;">æ™‚é–“è¡çªè­¦å‘Š</h3>
            </div>
            
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
              <strong>ç™¼ç¾æ™‚é–“è¡çªï¼š</strong><br>
              <strong>æ—¥æœŸï¼š</strong>${date}<br>
              <strong>æ™‚é–“ï¼š</strong>${time}<br>
              <strong>ç¾æœ‰ç¯€ç›®ï¼š</strong>${existingTitle}
            </div>
            
            <div style="background: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; border-radius: 8px; margin-bottom: 25px;">
              <strong>è¦†è“‹èªªæ˜ï¼š</strong><br>
              â€¢ é¸æ“‡ã€Œæ˜¯ã€å°‡åˆªé™¤ç¾æœ‰ç¯€ç›®ä¸¦ä¸Šæ¶æ–°ç¯€ç›®<br>
              ${isBatchCopy ? 
                `â€¢ é€™æ˜¯æ‰¹é‡è¤‡è£½çš„ä¸€éƒ¨åˆ†ï¼ˆåŸå§‹æ—¥æœŸï¼š${originalDate}ï¼‰<br>
                 â€¢ æ‰¹é‡è¤‡è£½åªæœƒå½±éŸ¿ ${originalDate} åŠä¹‹å¾Œçš„æ—¥æœŸ<br>
                 â€¢ ${originalDate} ä¹‹å‰çš„ç¯€ç›®ä¸æœƒå—åˆ°å½±éŸ¿` :
                `â€¢ åªæœƒå½±éŸ¿ ${date} é€™ä¸€å¤©çš„ç¯€ç›®`
              }<br>
              â€¢ æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œè«‹è¬¹æ…é¸æ“‡
            </div>
            
            <div style="text-align: center;">
              <button id="cancelOverwrite" style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                margin-right: 15px;
                cursor: pointer;
                font-size: 1rem;
              ">å–æ¶ˆ</button>
              <button id="confirmOverwrite" style="
                background: #dc3545;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 1rem;
              ">æ˜¯ï¼Œè¦†è“‹ç¾æœ‰ç¯€ç›®</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(dialog);
        
        // å–æ¶ˆæŒ‰éˆ•
        document.getElementById('cancelOverwrite').onclick = () => {
          document.body.removeChild(dialog);
          resolve(false);
        };
        
        // ç¢ºèªæŒ‰éˆ•
        document.getElementById('confirmOverwrite').onclick = () => {
          document.body.removeChild(dialog);
          resolve(true);
        };
        
        // é»æ“ŠèƒŒæ™¯é—œé–‰
        dialog.onclick = (e) => {
          if (e.target === dialog) {
            document.body.removeChild(dialog);
            resolve(false);
          }
        };
        
        // ESC éµé—œé–‰
        const handleEsc = (e) => {
          if (e.key === 'Escape') {
            document.body.removeChild(dialog);
            document.removeEventListener('keydown', handleEsc);
            resolve(false);
          }
        };
        document.addEventListener('keydown', handleEsc);
      });
    }

    // æ‰¹é‡è¤‡è£½ç¯€ç›®åˆ°æ•´å€‹æœˆ
    async function batchCopyToMonth(programData, targetDate, targetTime) {
      const monthDates = generateMonthDates(targetDate);
      const currentSlot = getTimeSlot(targetTime);
      const slotIndex = currentSlot.slot.slots.indexOf(targetTime);
      
      const programsToCreate = [];
      
      // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°ç¯€ç›®ï¼ˆæ–° YouTube ID + æ–°ä¸»é¡Œï¼‰
      const isNewProgram = checkIfNewProgram(programData);
      
      for (let i = 0; i < monthDates.length; i++) {
        const date = monthDates[i];
        const isFirstDay = i === 0;
        
        // ç•¶å¤©å…¶ä»–æ™‚æ®µçš„ç›¸åŒæ™‚é–“æ§½
        if (isFirstDay) {
          const otherSlots = getSameTimeSlotInOtherPeriods(targetTime);
          for (const slot of otherSlots) {
            // æ–°ç¯€ç›®ä¸”æ™šå ´æ‰ç‚ºé¦–æ’­ï¼Œå¦å‰‡é‡æ’­
            const isEveningFirstTime = slot.period === 'EVENING' && isNewProgram;
            programsToCreate.push({
              ...programData,
              airDate: date,
              airTime: slot.time,
              status: isEveningFirstTime ? 'é¦–æ’­' : 'é‡æ’­',
              isFirstBroadcast: isEveningFirstTime
            });
          }
        }
        
        // éš”å¤©é–‹å§‹çš„ç›¸åŒæ™‚æ®µ
        const nextDayTime = currentSlot.slot.slots[slotIndex];
        // æ–°ç¯€ç›®ä¸”æ™šå ´ç¬¬ä¸€æ¬¡ä¸Šæ¶æ‰ç‚ºé¦–æ’­ï¼Œå…¶é¤˜é‡æ’­
        const isEveningFirstTime = currentSlot.key === 'EVENING' && isFirstDay && isNewProgram;
        programsToCreate.push({
          ...programData,
          airDate: date,
          airTime: nextDayTime,
          status: isEveningFirstTime ? 'é¦–æ’­' : 'é‡æ’­',
          isFirstBroadcast: isEveningFirstTime
        });
      }
      
      return programsToCreate;
    }

    // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°ç¯€ç›®
    function checkIfNewProgram(programData) {
      // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒ YouTube ID å’Œä¸»é¡Œçš„ç¯€ç›®
      const existingPrograms = Object.values(events).flat();
      const isNewYouTubeId = !existingPrograms.some(program => 
        program.youtubeId === programData.youtubeId
      );
      const isNewTitle = !existingPrograms.some(program => 
        program.title === programData.title
      );
      
      console.log('ğŸ” æª¢æŸ¥æ˜¯å¦ç‚ºæ–°ç¯€ç›®:', {
        youtubeId: programData.youtubeId,
        title: programData.title,
        isNewYouTubeId,
        isNewTitle,
        isNewProgram: isNewYouTubeId && isNewTitle
      });
      
      return isNewYouTubeId && isNewTitle;
    }

    // é¡¯ç¤ºæ‰¹é‡è¤‡è£½ç¢ºèªå°è©±æ¡†
    function showBatchCopyDialog(programData, targetDate, targetTime) {
      const currentSlot = getTimeSlot(targetTime);
      const otherSlots = getSameTimeSlotInOtherPeriods(targetTime);
      const monthDates = generateMonthDates(targetDate);
      const isNewProgram = checkIfNewProgram(programData);
      
      // æª¢æŸ¥é¦–æ’­æ™‚æ®µè­¦å‘Š
      const isAfternoonSlot = currentSlot.key === 'AFTERNOON';
      const showWarning = isNewProgram && isAfternoonSlot;
      
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 10000;
        display: flex; align-items: center; justify-content: center;
      `;
      
      dialog.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
          <h3>ğŸ“… æ‰¹é‡æ’ç¨‹é¸é …</h3>
          <p><strong>ç¯€ç›®ï¼š</strong>${programData.title}</p>
          <p><strong>æ™‚æ®µï¼š</strong>${currentSlot.slot.name} (${targetTime})</p>
          <p><strong>ç¯€ç›®ç‹€æ…‹ï¼š</strong>${isNewProgram ? 'æ–°ç¯€ç›®' : 'é‡è¤‡ç¯€ç›®'}</p>
          
          ${showWarning ? `
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 15px 0;">
              <strong>âš ï¸ é¦–æ’­æ™‚æ®µè­¦å‘Šï¼š</strong><br>
              é€™æ˜¯æ–°ç¯€ç›®ï¼Œå»ºè­°é¦–æ’­å®‰æ’åœ¨æ™šå ´æ™‚æ®µã€‚ä¸‹åˆå ´é¦–æ’­å¯èƒ½å½±éŸ¿æ”¶è¦–æ•ˆæœã€‚
            </div>
          ` : ''}
          
          <div style="margin: 20px 0;">
            <h4>ğŸ¯ è¤‡è£½é¸é …ï¼š</h4>
            
            <div style="margin: 15px 0;">
              <label style="display: flex; align-items: center; margin: 10px 0;">
                <input type="checkbox" id="copySameDay" checked style="margin-right: 10px;">
                <span>è¤‡è£½åˆ°ç•¶å¤©å…¶ä»–æ™‚æ®µçš„ç›¸åŒæ™‚é–“æ§½</span>
              </label>
              ${otherSlots.map(slot => {
                const isEveningFirstTime = slot.period === 'EVENING' && isNewProgram;
                return `
                  <div style="margin-left: 30px; color: #666;">
                    â€¢ ${slot.periodName}: ${slot.time} (${isEveningFirstTime ? 'é¦–æ’­' : 'é‡æ’­'})
                  </div>
                `;
              }).join('')}
            </div>
            
            <div style="margin: 15px 0;">
              <label style="display: flex; align-items: center; margin: 10px 0;">
                <input type="checkbox" id="copyByDays" checked style="margin-right: 10px;">
                <span>æŒ‰å¤©æ•¸è¤‡è£½ (å¾ ${targetDate} é–‹å§‹)</span>
              </label>
              <div style="margin-left: 30px; color: #666;">
                <div style="margin: 10px 0;">
                  <label style="margin-right: 15px;">
                    <input type="radio" name="copyDays" value="30" checked style="margin-right: 5px;">30å¤©
                  </label>
                  <label style="margin-right: 15px;">
                    <input type="radio" name="copyDays" value="31" style="margin-right: 5px;">31å¤©
                  </label>
                  <label style="margin-right: 15px;">
                    <input type="radio" name="copyDays" value="custom" style="margin-right: 5px;">è‡ªå®šç¾©
                    <input type="number" id="customDays" value="30" min="1" max="90" style="width: 60px; margin-left: 5px;" disabled>å¤©
                  </label>
                  <label>
                    <input type="radio" name="copyDays" value="toDate" style="margin-right: 5px;">åˆ°æŒ‡å®šæ—¥æœŸ
                    <input type="date" id="endDate" style="margin-left: 5px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;" disabled>
                  </label>
                </div>
                <div style="font-size: 0.9rem; margin-top: 5px;">
                  â€¢ æ¯å¤© ${currentSlot.slot.name}: ${targetTime}<br>
                  â€¢ è¤‡è£½åˆ°æ‰€æœ‰æ™‚æ®µçš„ç›¸åŒæ™‚é–“æ§½<br>
                  â€¢ ${isNewProgram && currentSlot.key === 'EVENING' ? 'ç¬¬1å¤©: é¦–æ’­ï¼Œç¬¬2å¤©èµ·: é‡æ’­' : 'å…¨éƒ¨ç‚ºé‡æ’­'}<br>
                  â€¢ é¿å…è¦†è“‹æœˆåˆç¯€ç›®ï¼Œæ›´éˆæ´»æ§åˆ¶<br>
                  â€¢ æŒ‡å®šæ—¥æœŸï¼šç²¾ç¢ºæ§åˆ¶çµæŸæ™‚é–“ï¼ˆå¦‚ 9/25 åˆ° 10/31ï¼‰
                </div>
              </div>
            </div>
          </div>
          
          <div style="text-align: right; margin-top: 30px;">
            <button id="cancelBatch" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">å–æ¶ˆ</button>
            <button id="confirmBatch" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">ç¢ºèªæ‰¹é‡ä¸Šæ¶</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(dialog);

      // è™•ç†è‡ªå®šç¾©å¤©æ•¸å’Œæ—¥æœŸé¸æ“‡å™¨çš„å•Ÿç”¨/ç¦ç”¨
      const customDaysInput = document.getElementById('customDays');
      const endDateInput = document.getElementById('endDate');
      const copyDaysRadios = document.querySelectorAll('input[name="copyDays"]');
      
      // è¨­ç½®é è¨­çµæŸæ—¥æœŸï¼ˆå¾é–‹å§‹æ—¥æœŸç®—èµ·30å¤©ï¼‰
      const startDate = new Date(targetDate);
      const defaultEndDate = new Date(startDate);
      defaultEndDate.setDate(startDate.getDate() + 30);
      endDateInput.value = defaultEndDate.toISOString().split('T')[0];
      
      copyDaysRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.value === 'custom') {
            customDaysInput.disabled = false;
            endDateInput.disabled = true;
            customDaysInput.focus();
          } else if (this.value === 'toDate') {
            customDaysInput.disabled = true;
            endDateInput.disabled = false;
            endDateInput.focus();
          } else {
            customDaysInput.disabled = true;
            endDateInput.disabled = true;
          }
        });
      });
      
      return new Promise((resolve) => {
        // å–æ¶ˆæŒ‰éˆ•
        const cancelBtn = document.getElementById('cancelBatch');
        if (cancelBtn) {
          cancelBtn.onclick = () => {
            console.log('ğŸ“‹ ç”¨æˆ¶é»æ“Šå–æ¶ˆæŒ‰éˆ•');
            document.body.removeChild(dialog);
            resolve(null);
          };
        }
        
        // ç¢ºèªæŒ‰éˆ•
        const confirmBtn = document.getElementById('confirmBatch');
        if (confirmBtn) {
          confirmBtn.onclick = () => {
            console.log('ğŸ“‹ ç”¨æˆ¶é»æ“Šç¢ºèªæŒ‰éˆ•');
            const copySameDay = document.getElementById('copySameDay')?.checked || false;
            const copyByDays = document.getElementById('copyByDays')?.checked || false;
            
            // ç²å–å¤©æ•¸é¸é …
            let copyDays = 30; // é è¨­å€¼
            let endDate = null;
            
            if (copyByDays) {
              const selectedDays = document.querySelector('input[name="copyDays"]:checked')?.value;
              if (selectedDays === 'custom') {
                copyDays = parseInt(document.getElementById('customDays')?.value) || 30;
              } else if (selectedDays === 'toDate') {
                endDate = document.getElementById('endDate')?.value;
                // è¨ˆç®—å¾é–‹å§‹æ—¥æœŸåˆ°çµæŸæ—¥æœŸçš„å¤©æ•¸
                if (endDate) {
                  const start = new Date(targetDate);
                  const end = new Date(endDate);
                  const diffTime = end - start;
                  copyDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 åŒ…å«é–‹å§‹æ—¥æœŸ
                }
              } else {
                copyDays = parseInt(selectedDays) || 30;
              }
            }
            
            console.log('ğŸ“‹ è¤‡è£½é¸é …:', { copySameDay, copyByDays, copyDays, endDate });
            document.body.removeChild(dialog);
            resolve({ copySameDay, copyByDays, copyDays, endDate });
          };
        }
        
        // é»æ“ŠèƒŒæ™¯é—œé–‰
        dialog.onclick = (e) => {
          if (e.target === dialog) {
            console.log('ğŸ“‹ ç”¨æˆ¶é»æ“ŠèƒŒæ™¯é—œé–‰');
            document.body.removeChild(dialog);
            resolve(null);
          }
        };
        
        // ESC éµé—œé–‰
        const handleEsc = (e) => {
          if (e.key === 'Escape') {
            console.log('ğŸ“‹ ç”¨æˆ¶æŒ‰ ESC é—œé–‰');
            document.body.removeChild(dialog);
            document.removeEventListener('keydown', handleEsc);
            resolve(null);
          }
        };
        document.addEventListener('keydown', handleEsc);
      });
    }

    // å‰µå»ºæ‰¹é‡ä¸Šæ¶é€²åº¦æ¢å°è©±æ¡†
    function createBatchProgressDialog(totalCount) {
      const dialog = document.createElement('div');
      dialog.id = 'batchProgressDialog';
      dialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10001;
        font-family: Arial, sans-serif;
      `;
      
      dialog.innerHTML = `
        <div style="
          background: white;
          padding: 30px;
          border-radius: 10px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
          max-width: 500px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="margin: 0 0 20px 0; color: #333;">ğŸ“º æ‰¹é‡ä¸Šæ¶é€²è¡Œä¸­</h3>
          <div style="margin: 20px 0;">
            <div style="
              background: #f0f0f0;
              border-radius: 10px;
              height: 20px;
              overflow: hidden;
              margin-bottom: 10px;
            ">
              <div id="batchProgressBar" style="
                background: linear-gradient(90deg, #007bff, #28a745);
                height: 100%;
                width: 0%;
                transition: width 0.3s ease;
                border-radius: 10px;
              "></div>
            </div>
            <div id="batchProgressText" style="color: #666; font-size: 14px;">
              æº–å‚™ä¸­... (0/${totalCount})
            </div>
          </div>
          <div id="batchProgressList" style="
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
            font-size: 12px;
          "></div>
          <div style="margin-top: 20px; font-size: 12px; color: #666;">
            â³ è«‹ç¨å€™ï¼Œæ­£åœ¨æ‰¹é‡ä¸Šæ¶ç¯€ç›®åˆ° Contentful...
          </div>
        </div>
      `;
      
      return dialog;
    }

    // æ›´æ–°æ‰¹é‡ä¸Šæ¶é€²åº¦
    function updateBatchProgress(dialog, current, total, program) {
      const progressBar = dialog.querySelector('#batchProgressBar');
      const progressText = dialog.querySelector('#batchProgressText');
      const progressList = dialog.querySelector('#batchProgressList');
      
      const percentage = (current / total) * 100;
      
      if (progressBar) {
        progressBar.style.width = percentage + '%';
      }
      
      if (progressText) {
        progressText.textContent = `ä¸Šæ¶ä¸­... (${current}/${total})`;
      }
      
      if (progressList && program) {
        const status = program.status || 'é‡æ’­';
        const timeSlot = getTimeSlot(program.airTime);
        const slotName = timeSlot ? timeSlot.slot.name : 'æœªçŸ¥æ™‚æ®µ';
        
        progressList.innerHTML += `
          <div style="margin: 5px 0; padding: 5px; background: white; border-radius: 3px;">
            ğŸ“º ${program.title}<br>
            <small style="color: #666;">
              ${program.airDate} ${program.airTime} (${slotName}) - ${status}
            </small>
          </div>
        `;
        
        // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
        progressList.scrollTop = progressList.scrollHeight;
      }
    }

    // æ›´æ–°æ‰¹é‡ä¸Šæ¶å®Œæˆç‹€æ…‹
    function updateBatchProgressComplete(dialog, successCount, failCount) {
      const progressText = dialog.querySelector('#batchProgressText');
      const progressBar = dialog.querySelector('#batchProgressBar');
      
      if (progressText) {
        if (failCount === 0) {
          progressText.innerHTML = `âœ… å®Œæˆï¼æˆåŠŸä¸Šæ¶ ${successCount} å€‹ç¯€ç›®`;
          progressText.style.color = '#28a745';
        } else {
          progressText.innerHTML = `âš ï¸ å®Œæˆï¼æˆåŠŸ ${successCount} å€‹ï¼Œå¤±æ•— ${failCount} å€‹`;
          progressText.style.color = '#ffc107';
        }
      }
      
      if (progressBar) {
        progressBar.style.background = failCount === 0 ? 
          'linear-gradient(90deg, #28a745, #20c997)' : 
          'linear-gradient(90deg, #ffc107, #fd7e14)';
      }
    }

    // å¾æè¿°ä¸­æå– YouTube ID
    function extractYouTubeId(description) {
      if (!description) return '';
      
      // å˜—è©¦å¤šç¨® YouTube ID æ ¼å¼
      const patterns = [
        /\[YouTube:([^\]]+)\]/g,  // [YouTube:ID]
        /youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/g,  // youtube.com/watch?v=ID
        /youtu\.be\/([a-zA-Z0-9_-]+)/g,  // youtu.be/ID
        /youtube\.com\/embed\/([a-zA-Z0-9_-]+)/g,  // youtube.com/embed/ID
        /v=([a-zA-Z0-9_-]{11})/g  // v=ID (11 characters)
      ];
      
      for (const pattern of patterns) {
        const match = description.match(pattern);
        if (match) {
          // æå– ID éƒ¨åˆ†
          const idMatch = match[0].match(/([a-zA-Z0-9_-]{11})/);
          if (idMatch) {
            return idMatch[1];
          }
        }
      }
      
      return '';
    }

    // è¤‡è£½ä¸Šæ¶åŠŸèƒ½
    async function copyAndPublish() {
      const date = document.getElementById('editDate').value;
      const time = document.getElementById('airTime').value;
      const title = document.getElementById('title').value;
      const duration = document.getElementById('duration').value;
      const category = document.getElementById('category').value;
      const description = document.getElementById('description').value;
      const status = document.getElementById('status').value;

      if (!title || !date || !time) {
        showStatus('è«‹å…ˆå¡«å¯«å®Œæ•´çš„ç¯€ç›®è³‡è¨Š', 'warning');
        return;
      }

      showStatus('æ­£åœ¨æº–å‚™è¤‡è£½ä¸Šæ¶...', 'info');

      try {
        // ç²å–ç¸®åœ–è³‡æ–™
        const thumbnailPreview = document.getElementById('thumbnailPreview');
        const currentThumbnail = thumbnailPreview.src;
        const isDefaultThumbnail = currentThumbnail.includes('placeholder') || currentThumbnail.includes('via.placeholder');
        
        // ç²å–é¸ä¸­çš„ä¸»é¡Œæ¢ç´¢åˆ†é¡
        const selectedTopics = [];
        document.querySelectorAll('input[name="topics"]:checked').forEach(checkbox => {
          selectedTopics.push(checkbox.value);
        });

        // å„ªå…ˆå¾ youtubeId æ¬„ä½ç²å–ï¼Œå¦‚æœæ²’æœ‰å‰‡å¾æè¿°ä¸­æå–
        const youtubeIdField = document.getElementById('youtubeId').value.trim();
        const extractedYouTubeId = youtubeIdField || extractYouTubeId(description);
        
        console.log('ğŸ” æå– YouTube ID èª¿è©¦:', {
          youtubeIdField: youtubeIdField,
          description: description,
          extractedYouTubeId: extractedYouTubeId,
          category: category,
          topics: selectedTopics
        });

        // æª¢æŸ¥æ˜¯å¦æœ‰ YouTube ID
        if (!extractedYouTubeId) {
          showStatus('âŒ ç„¡æ³•æ‰¾åˆ° YouTube IDï¼Œè«‹åœ¨ YouTube ID æ¬„ä½è¼¸å…¥æˆ–ç¢ºä¿æè¿°ä¸­åŒ…å« YouTube é€£çµæˆ– [YouTube:ID] æ ¼å¼', 'error');
          return;
        }

        const programData = {
          title: title,
          airDate: date,
          airTime: time,
          duration: parseInt(duration) || 30,
          category: category,
          description: description,
          status: status,
          thumbnail: isDefaultThumbnail ? '' : currentThumbnail,
          topics: selectedTopics,
          youtubeId: extractedYouTubeId,
          videoType: 'YouTube'
        };

        // æª¢æŸ¥æ™‚é–“æ§½ä¸¦é¡¯ç¤ºæ‰¹é‡è¤‡è£½é¸é …
        const timeSlot = getTimeSlot(time);
        if (timeSlot) {
          console.log('ğŸ¯ æª¢æ¸¬åˆ°æ™‚é–“æ§½:', timeSlot);
          
          // é¡¯ç¤ºæ‰¹é‡è¤‡è£½å°è©±æ¡†
          const batchOptions = await showBatchCopyDialog(programData, date, time);
          
          if (!batchOptions) {
            showStatus('å·²å–æ¶ˆè¤‡è£½ä¸Šæ¶', 'info');
            return;
          }

          // æº–å‚™è¦ä¸Šæ¶çš„ç¯€ç›®åˆ—è¡¨
          const programsToUpload = [programData];
          
          if (batchOptions.copySameDay) {
            // è¤‡è£½åˆ°ç•¶å¤©å…¶ä»–æ™‚æ®µçš„ç›¸åŒæ™‚é–“æ§½
            const otherSlots = getSameTimeSlotInOtherPeriods(time);
            const isNewProgram = checkIfNewProgram(programData);
            
            for (const slot of otherSlots) {
              // æ–°ç¯€ç›®ä¸”æ™šå ´æ‰ç‚ºé¦–æ’­ï¼Œå¦å‰‡é‡æ’­
              const isEveningFirstTime = slot.period === 'EVENING' && isNewProgram;
              programsToUpload.push({
                ...programData,
                airTime: slot.time,
                status: isEveningFirstTime ? 'é¦–æ’­' : 'é‡æ’­',
                isFirstBroadcast: isEveningFirstTime,
                youtubeId: programData.youtubeId
              });
            }
          }
          
          if (batchOptions.copyByDays) {
            // æŒ‰å¤©æ•¸è¤‡è£½åˆ°æ‰€æœ‰æ™‚æ®µç›¸åŒæ™‚é–“æ§½
            const copyDays = batchOptions.copyDays;
            const endDate = batchOptions.endDate;
            let crossMonthDates;
            
            if (endDate) {
              // ä½¿ç”¨æŒ‡å®šçµæŸæ—¥æœŸç”Ÿæˆæ—¥æœŸç¯„åœ
              crossMonthDates = generateDateRange(date, endDate);
              console.log('ğŸ“… æŒ‡å®šæ—¥æœŸè¤‡è£½èª¿è©¦:', {
                startDate: date,
                endDate: endDate,
                copyDays: copyDays,
                crossMonthDates: crossMonthDates,
                crossMonthDatesLength: crossMonthDates.length
              });
            } else {
              // ä½¿ç”¨å¤©æ•¸ç”Ÿæˆæ—¥æœŸç¯„åœ
              crossMonthDates = generateCrossMonthDates(date, copyDays);
              console.log('ğŸ“… æŒ‰å¤©æ•¸è¤‡è£½èª¿è©¦:', {
                startDate: date,
                copyDays: copyDays,
                crossMonthDates: crossMonthDates,
                crossMonthDatesLength: crossMonthDates.length
              });
            }
            
            const slotIndex = timeSlot.slot.slots.indexOf(time);
            const isNewProgram = checkIfNewProgram(programData);
            
            // å¾ç¬¬2å¤©é–‹å§‹è¤‡è£½ï¼ˆç¬¬1å¤©å·²ç¶“åœ¨ programsToUpload ä¸­ï¼‰
            for (let i = 1; i < crossMonthDates.length; i++) {
              const nextDate = crossMonthDates[i];
              
              // è¤‡è£½åˆ°æ‰€æœ‰æ™‚æ®µçš„ç›¸åŒæ™‚é–“æ§½
              Object.keys(TIME_SLOTS).forEach(periodKey => {
                const period = TIME_SLOTS[periodKey];
                const targetTime = period.slots[slotIndex];
                
                // æ–°ç¯€ç›®ä¸”æ™šå ´ç¬¬ä¸€æ¬¡ä¸Šæ¶æ‰ç‚ºé¦–æ’­ï¼Œå…¶é¤˜é‡æ’­
                const isEveningFirstTime = periodKey === 'EVENING' && i === 1 && isNewProgram;
                
                programsToUpload.push({
                  ...programData,
                  airDate: nextDate,
                  airTime: targetTime,
                  status: isEveningFirstTime ? 'é¦–æ’­' : 'é‡æ’­',
                  isFirstBroadcast: isEveningFirstTime,
                  youtubeId: programData.youtubeId,
                  // æ¨™è¨˜ç‚ºæ‰¹é‡è¤‡è£½ï¼Œç”¨æ–¼è¦†è“‹æª¢æŸ¥
                  isBatchCopy: true,
                  originalDate: date
                });
              });
            }
          }

          // å‰µå»ºé€²åº¦æ¢å°è©±æ¡†
          const progressDialog = createBatchProgressDialog(programsToUpload.length);
          document.body.appendChild(progressDialog);
          
          // æ‰¹é‡ä¸Šæ¶ç¯€ç›®
          const results = [];
          let successCount = 0;
          let failCount = 0;

          for (let i = 0; i < programsToUpload.length; i++) {
            const program = programsToUpload[i];
            
            // æ›´æ–°é€²åº¦æ¢
            updateBatchProgress(progressDialog, i + 1, programsToUpload.length, program);
            
            try {
              console.log(`ğŸš€ é–‹å§‹ä¸Šæ¶ç¯€ç›® ${i + 1}/${programsToUpload.length}:`, program);
              const result = await uploadProgramSimple(program);
              results.push({ program, result });
              
              if (result.success) {
                successCount++;
                console.log(`âœ… ä¸Šæ¶æˆåŠŸ ${i + 1}/${programsToUpload.length}: ${program.title}`);
              } else {
                failCount++;
                console.error(`âŒ ä¸Šæ¶å¤±æ•— ${i + 1}/${programsToUpload.length}: ${program.title}`, result.error);
              }
            } catch (error) {
              console.error(`âŒ ä¸Šæ¶ç¯€ç›®ç•°å¸¸ ${i + 1}/${programsToUpload.length}:`, program.title, error);
              console.error('éŒ¯èª¤è©³æƒ…:', {
                message: error.message,
                stack: error.stack,
                program: program
              });
              results.push({ program, result: { success: false, error: error.message } });
              failCount++;
            }
            
            // æ·»åŠ å°å»¶é²ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°é€²åº¦
            await new Promise(resolve => setTimeout(resolve, 200));
          }
          
          // å®Œæˆå¾Œæ›´æ–°é€²åº¦æ¢
          updateBatchProgressComplete(progressDialog, successCount, failCount);
          
          // ç­‰å¾… 3 ç§’å¾Œé—œé–‰é€²åº¦æ¢
          setTimeout(() => {
            if (document.body.contains(progressDialog)) {
              document.body.removeChild(progressDialog);
            }
          }, 3000);

          // è™•ç†æ‰¹é‡ä¸Šæ¶çµæœ
          const publishedPrograms = JSON.parse(localStorage.getItem('published_programs') || '[]');
          
          for (const { program, result } of results) {
            if (result.success) {
              publishedPrograms.push({
                ...program,
                publishedAt: new Date().toISOString(),
                contentfulId: result.entryId,
                simulated: result.simulated || false
              });
              
              // åŒæ­¥åˆ°ä»Šæ—¥ç¯€ç›®è¡¨é¡¯ç¤ºç³»çµ±
              updateCurrentScheduleForToday(program);
              
              // æ›´æ–°æ—¥æ›†äº‹ä»¶
              const event = getEvent(program.airDate, program.airTime);
              if (event) {
                event.published = true;
                event.publishedAt = new Date().toISOString();
                event.contentfulId = result.entryId;
              }
            }
          }
          
          localStorage.setItem('published_programs', JSON.stringify(publishedPrograms));
          saveEvents();
          renderCurrentView();

          // é¡¯ç¤ºæ‰¹é‡ä¸Šæ¶çµæœ
          const totalPrograms = programsToUpload.length;
          const statusMessage = successCount === totalPrograms ? 
            `âœ… æˆåŠŸè¤‡è£½ä¸Šæ¶ ${successCount} å€‹ç¯€ç›®åˆ° Contentfulï¼` :
            `âš ï¸ è¤‡è£½ä¸Šæ¶å®Œæˆï¼šæˆåŠŸ ${successCount} å€‹ï¼Œå¤±æ•— ${failCount} å€‹`;
          
          showStatus(statusMessage, successCount === totalPrograms ? 'success' : 'warning');

          // é—œé–‰æ¨¡æ…‹æ¡†
          closeModal();

        } else {
          showStatus('âŒ ç„¡æ³•è­˜åˆ¥æ™‚é–“æ§½ï¼Œè«‹ä½¿ç”¨æ¨™æº–æ™‚é–“æ ¼å¼', 'error');
        }

      } catch (error) {
        console.error('è¤‡è£½ä¸Šæ¶å¤±æ•—:', error);
        showStatus('âŒ è¤‡è£½ä¸Šæ¶å¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    // å‰µå»ºæ–°ç¯€ç›®åˆ° Contentful
    async function createNewProgram() {
      console.log('ğŸ“… é–‹å§‹å‰µå»ºæ–°ç¯€ç›®åˆ° Contentful');

      const date = document.getElementById('editDate').value;
      const time = document.getElementById('airTime').value;
      const title = document.getElementById('title').value;
      const duration = document.getElementById('duration').value;
      const category = document.getElementById('category').value;
      const description = document.getElementById('description').value;
      const status = document.getElementById('status').value;

      if (!title || !date || !time) {
        showStatus('è«‹å…ˆå¡«å¯«å®Œæ•´çš„ç¯€ç›®è³‡è¨Š', 'warning');
        return;
      }

      const today = new Date();
      const currentHour = today.getHours();
      const currentMinute = today.getMinutes();
      const todayString = today.getFullYear() + '-' +
                         String(today.getMonth() + 1).padStart(2, '0') + '-' +
                         String(today.getDate()).padStart(2, '0');
      const isPastDate = date < todayString;
      const isPastTime = date === todayString &&
                        (parseInt(time.split(':')[0]) < currentHour ||
                         (parseInt(time.split(':')[0]) === currentHour && parseInt(time.split(':')[1]) <= currentMinute));

      // å¦‚æœæ˜¯éå»çš„æ™‚é–“ï¼Œé¡¯ç¤ºè­¦èªä½†å…è¨±ç¹¼çºŒ
      if (isPastDate || isPastTime) {
        const confirmMessage = isPastDate 
          ? `âš ï¸ è­¦å‘Šï¼šæ‚¨æ­£åœ¨ä¸Šæ¶éå»çš„æ—¥æœŸ (${date})ï¼Œé€™å¯èƒ½æœƒå½±éŸ¿ç¯€ç›®æ’ç¨‹ã€‚æ˜¯å¦ç¹¼çºŒï¼Ÿ`
          : `âš ï¸ è­¦å‘Šï¼šæ‚¨æ­£åœ¨ä¸Šæ¶éå»çš„æ™‚é–“ (${date} ${time})ï¼Œé€™å¯èƒ½æœƒå½±éŸ¿ç¯€ç›®æ’ç¨‹ã€‚æ˜¯å¦ç¹¼çºŒï¼Ÿ`;
        
        if (!confirm(confirmMessage)) {
          showStatus('å·²å–æ¶ˆä¸Šæ¶', 'info');
        return;
        }
        showStatus('âš ï¸ æ­£åœ¨ä¸Šæ¶éå»çš„æ™‚é–“ï¼Œè«‹æ³¨æ„ç¯€ç›®æ’ç¨‹å½±éŸ¿', 'warning');
      }

      showStatus('æ­£åœ¨ä¸Šæ¶ç¯€ç›®åˆ° Contentful...', 'info');

      try {
        // ç²å–ç¸®åœ–è³‡æ–™
        const thumbnailPreview = document.getElementById('thumbnailPreview');
        const currentThumbnail = thumbnailPreview.src;
        const isDefaultThumbnail = currentThumbnail.includes('placeholder') || currentThumbnail.includes('via.placeholder');
        
        // ç²å–é¸ä¸­çš„ä¸»é¡Œæ¢ç´¢åˆ†é¡
        const selectedTopics = [];
        document.querySelectorAll('input[name="topics"]:checked').forEach(checkbox => {
          selectedTopics.push(checkbox.value);
        });
        
        console.log('ğŸ” ç²å–é¸ä¸­çš„ä¸»é¡Œæ¢ç´¢åˆ†é¡:', {
          selectedTopics: selectedTopics,
          topicsLength: selectedTopics.length,
          allCheckboxes: document.querySelectorAll('input[name="topics"]').length,
          checkedCheckboxes: document.querySelectorAll('input[name="topics"]:checked').length
        });
        
        const programData = {
          title: title,
          airDate: date,
          airTime: time,
          duration: parseInt(duration),
          category: category,
          description: description,
          status: status,
          videoType: document.getElementById('videoType').value,
          youtubeId: document.getElementById('videoType').value === 'YouTube' ? document.getElementById('youtubeId').value : null,
          mp4File: document.getElementById('videoType').value === 'MP4' ? (document.getElementById('mp4File').files[0] ? document.getElementById('mp4File').files[0].name : null) : null,
          thumbnail: isDefaultThumbnail ? null : currentThumbnail,
          topics: selectedTopics
        };

        // ä¸Šæ¶æ–°ç¯€ç›®
        const result = await uploadProgramSimple(programData);

        if (result.success) {
          console.log('âœ… ä¸Šæ¶æˆåŠŸï¼Œæº–å‚™é—œé–‰è¦–çª—...', { title });
          
          // è™•ç†ä¸Šæ¶çµæœ
          const publishedPrograms = JSON.parse(localStorage.getItem('published_programs') || '[]');
          publishedPrograms.push({
            ...programData,
            publishedAt: new Date().toISOString(),
            contentfulId: result.entryId,
            simulated: result.simulated || false
          });
            
          localStorage.setItem('published_programs', JSON.stringify(publishedPrograms));

          // åŒæ­¥åˆ°ä»Šæ—¥ç¯€ç›®è¡¨é¡¯ç¤ºç³»çµ±
          updateCurrentScheduleForToday(programData);

          // æ›´æ–°æ—¥æ›†äº‹ä»¶
          const event = getEvent(programData.airDate, programData.airTime);
          if (event) {
            event.published = true;
            event.publishedAt = new Date().toISOString();
            event.contentfulId = result.entryId;
          }
            
          saveEvents();
          renderCurrentView();

          showStatus(`âœ… æˆåŠŸä¸Šæ¶ç¯€ç›®ã€Œ${title}ã€åˆ° Contentfulï¼`, 'success');
          console.log('ğŸšª æº–å‚™é—œé–‰è¦–çª—...');
          closeModal();
          console.log('âœ… è¦–çª—å·²é—œé–‰');
        } else {
          console.error('âŒ ä¸Šæ¶å¤±æ•—:', result);
          showStatus('âŒ ä¸Šæ¶å¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
        }

      } catch (error) {
        console.error('ä¸Šæ¶å¤±æ•—:', error);
        showStatus('âŒ ä¸Šæ¶å¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    window.addEventListener('click', function(e) {
      const eventModal = document.getElementById('eventModal');
      const timeSlotModal = document.getElementById('timeSlotModal');

      if (e.target === eventModal) {
        closeModal();
      }

      if (e.target === timeSlotModal) {
        closeTimeSlotModal();
      }
    });

    // æ¸¬è©¦ä¸Šæ¶åŠŸèƒ½
    async function testUploadFunction() {
      try {
        showStatus('ğŸ§ª é–‹å§‹æ¸¬è©¦ä¸Šæ¶åŠŸèƒ½...', 'info');
        
        // å‰µå»ºæ¸¬è©¦ç¯€ç›®æ•¸æ“š
        const testProgram = {
          title: 'æ¸¬è©¦ç¯€ç›® - ' + new Date().toLocaleTimeString(),
          airDate: new Date().toISOString().split('T')[0],
          airTime: '22:00',
          description: 'é€™æ˜¯ä¸€å€‹æ¸¬è©¦ç¯€ç›®',
          category: 'æ¸¬è©¦',
          duration: 30,
          contentType: 'scheduleItem'
        };
        
        console.log('ğŸ§ª æ¸¬è©¦ç¯€ç›®æ•¸æ“š:', testProgram);
        
        // åŸ·è¡Œä¸Šæ¶
        const result = await uploadProgramSimple(testProgram);
        
        if (result.success) {
          showStatus(`âœ… æ¸¬è©¦ä¸Šæ¶æˆåŠŸï¼Entry ID: ${result.entryId}`, 'success');
          console.log('âœ… æ¸¬è©¦ä¸Šæ¶æˆåŠŸ:', result);
        } else {
          showStatus(`âŒ æ¸¬è©¦ä¸Šæ¶å¤±æ•—: ${result.error}`, 'error');
          console.error('âŒ æ¸¬è©¦ä¸Šæ¶å¤±æ•—:', result);
        }
        
        return result;
        
      } catch (error) {
        showStatus(`âŒ æ¸¬è©¦ä¸Šæ¶ç•°å¸¸: ${error.message}`, 'error');
        console.error('âŒ æ¸¬è©¦ä¸Šæ¶ç•°å¸¸:', error);
        return { success: false, error: error.message };
      }
    }

    // é¡¯ç¤ºæ¸¬è©¦æ—¥èªŒ
    function showTestLogs() {
      const uploadHistory = window.contentfulRealIntegration.getUploadHistory();
      const publishedPrograms = JSON.parse(localStorage.getItem('published_programs') || '[]');
      
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'block';
      
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
          <div class="modal-header">
            <h3>ğŸ“‹ æ¸¬è©¦æ—¥èªŒå’Œä¸Šæ¶è¨˜éŒ„</h3>
            <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
          </div>
          <div style="max-height: 60vh; overflow-y: auto;">
            <div style="margin-bottom: 20px;">
              <h4>ğŸ§ª ä¸Šæ¶æ¸¬è©¦è¨˜éŒ„ (${uploadHistory.length} ç­†)</h4>
              ${uploadHistory.length > 0 ? uploadHistory.map((item, index) => `
                <div style="border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-weight: 600; color: #2b71d2;">æ¸¬è©¦ #${index + 1}</span>
                    <span style="background: ${item.simulated ? '#ffc107' : '#28a745'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">
                      ${item.simulated ? 'æ¨¡æ“¬æ¨¡å¼' : 'çœŸå¯¦æ¨¡å¼'}
                    </span>
                  </div>
                  <div style="font-weight: 600; margin-bottom: 5px;">${item.title}</div>
                  <div style="color: #666; font-size: 0.9rem; margin-bottom: 5px;">
                    <span>${item.airDate} ${item.airTime}</span> â€¢ 
                    <span>${item.category}</span> â€¢ 
                    <span>${item.duration}åˆ†é˜</span>
                  </div>
                  <div style="color: #666; font-size: 0.8rem;">
                    ä¸Šæ¶æ™‚é–“: ${new Date(item.uploadedAt).toLocaleString()}
                  </div>
                  ${item.contentfulId ? `<div style="color: #666; font-size: 0.8rem;">Contentful ID: ${item.contentfulId}</div>` : ''}
                </div>
              `).join('') : '<p style="color: #666; font-style: italic;">å°šç„¡æ¸¬è©¦è¨˜éŒ„</p>'}
            </div>
            
            <div style="margin-bottom: 20px;">
              <h4>ğŸ“º å·²ç™¼å¸ƒç¯€ç›®è¨˜éŒ„ (${publishedPrograms.length} ç­†)</h4>
              ${publishedPrograms.length > 0 ? publishedPrograms.map((item, index) => `
                <div style="border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-weight: 600; color: #2b71d2;">ç¯€ç›® #${index + 1}</span>
                    <span style="background: ${item.simulated ? '#ffc107' : '#28a745'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">
                      ${item.simulated ? 'æ¨¡æ“¬ç™¼å¸ƒ' : 'çœŸå¯¦ç™¼å¸ƒ'}
                    </span>
                  </div>
                  <div style="font-weight: 600; margin-bottom: 5px;">${item.title}</div>
                  <div style="color: #666; font-size: 0.9rem; margin-bottom: 5px;">
                    <span>${item.airDate} ${item.airTime}</span> â€¢ 
                    <span>${item.category}</span> â€¢ 
                    <span>${item.duration}åˆ†é˜</span>
                  </div>
                  <div style="color: #666; font-size: 0.8rem;">
                    ç™¼å¸ƒæ™‚é–“: ${new Date(item.publishedAt).toLocaleString()}
                  </div>
                  ${item.contentfulId ? `<div style="color: #666; font-size: 0.8rem;">Contentful ID: ${item.contentfulId}</div>` : ''}
                </div>
              `).join('') : '<p style="color: #666; font-style: italic;">å°šç„¡ç™¼å¸ƒè¨˜éŒ„</p>'}
            </div>
            
            <div style="margin-bottom: 20px;">
              <h4>ğŸ”§ ç³»çµ±ç‹€æ…‹</h4>
              <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <div style="margin-bottom: 10px;">
                  <strong>Contentful é…ç½®:</strong>
                  <div style="font-family: monospace; font-size: 0.8rem; color: #666; margin-top: 5px;">
                    Space ID: ${window.contentfulUploadFix.config.space}<br>
                    Environment: ${window.contentfulUploadFix.config.environment}<br>
                    Management Token: ${window.contentfulUploadFix.config.managementToken ? 'å·²è¨­ç½®' : 'æœªè¨­ç½®'}
                  </div>
                </div>
                <div>
                  <strong>ç€è¦½å™¨æ”¯æ´:</strong>
                  <div style="font-family: monospace; font-size: 0.8rem; color: #666; margin-top: 5px;">
                    Contentful SDK: ${typeof contentful !== 'undefined' ? 'âœ… å·²è¼‰å…¥' : 'âŒ æœªè¼‰å…¥'}<br>
                    Management SDK: ${typeof contentfulManagement !== 'undefined' ? 'âœ… å·²è¼‰å…¥' : 'âŒ æœªè¼‰å…¥'}<br>
                    Local Storage: ${typeof Storage !== 'undefined' ? 'âœ… æ”¯æ´' : 'âŒ ä¸æ”¯æ´'}
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="clearTestLogs()">ğŸ—‘ï¸ æ¸…é™¤æ¸¬è©¦è¨˜éŒ„</button>
            <button class="btn" onclick="this.closest('.modal').remove()">é—œé–‰</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    // æ¸…é™¤æ¸¬è©¦æ—¥èªŒ
    function clearTestLogs() {
      if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ¸¬è©¦è¨˜éŒ„å—ï¼Ÿ')) {
        window.contentfulRealIntegration.clearAllLogs();
        localStorage.removeItem('published_programs');
        showStatus('æ¸¬è©¦è¨˜éŒ„å·²æ¸…é™¤', 'success');
        // é—œé–‰æ¨¡æ…‹æ¡†
        document.querySelector('.modal').remove();
      }
    }

    // é‡æ–°åˆå§‹åŒ– Contentful
    async function reinitializeContentful() {
      try {
        showStatus('æ­£åœ¨é‡æ–°åˆå§‹åŒ– Contentful...', 'info');
        console.log('ğŸ”„ é–‹å§‹é‡æ–°åˆå§‹åŒ– Contentful...');
        
        // æª¢æŸ¥ SDK ç‹€æ…‹
        console.log('ğŸ“Š ç•¶å‰ SDK ç‹€æ…‹:');
        console.log('- Contentful SDK:', typeof contentful !== 'undefined' ? 'âœ… å·²è¼‰å…¥' : 'âŒ æœªè¼‰å…¥');
        console.log('- Management SDK:', typeof contentfulManagement !== 'undefined' ? 'âœ… å·²è¼‰å…¥' : 'âŒ æœªè¼‰å…¥');
        
        // å¦‚æœ Management SDK æœªè¼‰å…¥ï¼Œå˜—è©¦è¼‰å…¥
        if (typeof contentfulManagement === 'undefined') {
          console.log('ğŸ“¥ å˜—è©¦è¼‰å…¥ Management SDK...');
          // Management SDK æ‡‰è©²å·²ç¶“è¼‰å…¥ï¼Œå¦‚æœæ²’æœ‰å‰‡é‡æ–°åˆå§‹åŒ–
          await window.contentfulRealIntegration.init();
        }
        
        // é‡æ–°åˆå§‹åŒ–
        const initResult = await window.contentfulRealIntegration.init();
        
        if (initResult) {
          showStatus('âœ… Contentful é‡æ–°åˆå§‹åŒ–æˆåŠŸï¼', 'success');
          console.log('âœ… é‡æ–°åˆå§‹åŒ–å®Œæˆ');
          
        // æ¸¬è©¦é€£æ¥
        const connectionTest = await window.contentfulRealIntegration.testConnection();
          console.log('ğŸ”— é€£æ¥æ¸¬è©¦çµæœ:', connectionTest);
          
          if (connectionTest.success) {
            showStatus('âœ… Contentful é€£æ¥æ­£å¸¸ï¼Œå¯ä»¥é€²è¡ŒçœŸå¯¦ä¸Šæ¶ï¼', 'success');
          } else {
            showStatus('âš ï¸ Contentful é€£æ¥æœ‰å•é¡Œï¼š' + connectionTest.error, 'warning');
          }
        } else {
          showStatus('âŒ Contentful é‡æ–°åˆå§‹åŒ–å¤±æ•—', 'error');
        }
        
      } catch (error) {
        console.error('âŒ é‡æ–°åˆå§‹åŒ–å¤±æ•—:', error);
        showStatus('âŒ é‡æ–°åˆå§‹åŒ–å¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    // å¼·åˆ¶è¼‰å…¥ Management SDK
    async function forceLoadManagementSDK() {
      try {
        showStatus('æ­£åœ¨å¼·åˆ¶ä¿®å¾©è¼‰å…¥ Management SDK...', 'info');
        console.log('ğŸ”§ é–‹å§‹å¼·åˆ¶ä¿®å¾©è¼‰å…¥ Management SDK...');
        
        if (!window.contentfulManagementFix) {
          showStatus('âŒ Management ä¿®å¾©è¼‰å…¥å™¨ä¸å¯ç”¨', 'error');
          return;
        }
        
        // æª¢æŸ¥ç•¶å‰ç‹€æ…‹
        const status = window.contentfulManagementFix.checkStatus();
        console.log('ğŸ“Š ç•¶å‰ç‹€æ…‹:', status);
        
        // å¼·åˆ¶é‡æ–°è¼‰å…¥
        await window.contentfulManagementFix.forceReload();
        
        // æª¢æŸ¥è¼‰å…¥çµæœ
        const newStatus = window.contentfulManagementFix.checkStatus();
        console.log('ğŸ“Š è¼‰å…¥å¾Œç‹€æ…‹:', newStatus);
        
        if (newStatus.sdkAvailable) {
          showStatus('âœ… Management SDK ä¿®å¾©è¼‰å…¥æˆåŠŸï¼', 'success');
          
          // é‡æ–°åˆå§‹åŒ– Contentful
          const initResult = await window.contentfulRealIntegration.init();
          if (initResult) {
            showStatus('âœ… Contentful é‡æ–°åˆå§‹åŒ–æˆåŠŸï¼Œç¾åœ¨å¯ä»¥çœŸå¯¦ä¸Šæ¶ï¼', 'success');
          } else {
            showStatus('âš ï¸ Management SDK è¼‰å…¥æˆåŠŸä½†åˆå§‹åŒ–å¤±æ•—', 'warning');
          }
        } else {
          showStatus('âŒ Management SDK ä¿®å¾©è¼‰å…¥å¤±æ•—', 'error');
        }
        
      } catch (error) {
        console.error('âŒ å¼·åˆ¶ä¿®å¾©è¼‰å…¥ Management SDK å¤±æ•—:', error);
        showStatus('âŒ å¼·åˆ¶ä¿®å¾©è¼‰å…¥å¤±æ•—ï¼š' + error.message, 'error');
        
        // å˜—è©¦é‡è©¦
        if (window.contentfulManagementFix && window.contentfulManagementFix.retryCount < 5) {
          console.log('ğŸ”„ å˜—è©¦é‡è©¦è¼‰å…¥...');
          try {
            await window.contentfulManagementFix.retryLoad();
            showStatus('âœ… é‡è©¦è¼‰å…¥æˆåŠŸï¼', 'success');
          } catch (retryError) {
            showStatus('âŒ é‡è©¦è¼‰å…¥ä¹Ÿå¤±æ•—ï¼š' + retryError.message, 'error');
          }
        }
      }
    }

    // é–‹å•Ÿçµ±ä¸€æ¸¬è©¦èˆ‡æ—¥èªŒæŸ¥çœ‹å™¨
    // é–‹å•Ÿ Contentful ä¸»æ§å°
    function openMainConsole() {
      window.open('contentful-main-console.html', '_blank', 'width=1400,height=900,scrollbars=yes,resizable=yes');
    }

    // å‰å¾€ä¸»æ§å°
    function goToDashboard() {
      window.location.href = 'admin-dashboard.html';
    }

    // å¾ Contentful é‡æ–°è¼‰å…¥ç¯€ç›®
    async function reloadFromContentful() {
      try {
        showStatus('æ­£åœ¨å¾ Contentful é‡æ–°è¼‰å…¥ç¯€ç›®...', 'info');
        
        // å…ˆæ¸¬è©¦é€£ç·š
        await testContentfulConnection();
        
        await loadEventsFromContentful();
        renderCurrentView();
        showStatus('âœ… å·²å¾ Contentful é‡æ–°è¼‰å…¥ç¯€ç›®', 'success');
        
        // é¡¯ç¤ºè¼‰å…¥çš„ç¯€ç›®æ•¸é‡
        const totalEvents = Object.values(events).reduce((sum, dayEvents) => sum + dayEvents.length, 0);
        console.log(`âœ… å…±è¼‰å…¥ ${totalEvents} å€‹ç¯€ç›®`);
      } catch (error) {
        console.error('é‡æ–°è¼‰å…¥å¤±æ•—:', error);
        showStatus('âŒ é‡æ–°è¼‰å…¥å¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    // æ¸¬è©¦ Contentful é€£ç·š
    async function testContentfulConnection() {
      try {
        console.log('ğŸ” æ¸¬è©¦ Contentful é€£ç·š...');
        
        if (typeof contentful === 'undefined') {
          throw new Error('Contentful SDK æœªè¼‰å…¥');
        }

        const client = contentful.createClient({
          space: window.CONTENTFUL_CONFIG?.SPACE_ID || 'os5wf90ljenp',
          accessToken: window.CONTENTFUL_CONFIG?.DELIVERY_TOKEN
        });

        // æ¸¬è©¦ç²å–ç©ºé–“è³‡è¨Š
        const space = await client.getSpace();
        console.log('âœ… Contentful é€£ç·šæˆåŠŸï¼Œç©ºé–“:', space.name);
        
        // æ¸¬è©¦ç²å–å…§å®¹é¡å‹
        const contentTypes = await client.getContentTypes();
        console.log('âœ… å…§å®¹é¡å‹æ•¸é‡:', contentTypes.items.length);
        
        // æª¢æŸ¥æ˜¯å¦æœ‰ scheduleItem å…§å®¹é¡å‹
        const scheduleItemType = contentTypes.items.find(ct => ct.sys.id === 'scheduleItem');
        if (scheduleItemType) {
          console.log('âœ… æ‰¾åˆ° scheduleItem å…§å®¹é¡å‹');
        } else {
          console.log('âš ï¸ æœªæ‰¾åˆ° scheduleItem å…§å®¹é¡å‹');
        }
        
        return true;
      } catch (error) {
        console.error('âŒ Contentful é€£ç·šæ¸¬è©¦å¤±æ•—:', error);
        throw error;
      }
    }


    // ä¸Šæ¶é¸ä¸­çš„ç¯€ç›®åˆ° Contentful
    async function uploadSelectedPrograms() {
      try {
        // å…ˆæª¢æŸ¥ç³»çµ±ç‹€æ…‹
        if (typeof contentfulManagement === 'undefined') {
          alert('âŒ Management SDK æœªè¼‰å…¥\nè«‹é‡æ–°è¼‰å…¥é é¢');
          return;
        }
        
        // æª¢æŸ¥æ˜¯å¦æœ‰é¸ä¸­çš„ç¯€ç›®
        const selectedPrograms = getSelectedPrograms();
        if (selectedPrograms.length === 0) {
          alert('è«‹å…ˆé¸æ“‡è¦ä¸Šæ¶çš„ç¯€ç›®ï¼\n\né¸æ“‡æ–¹å¼ï¼š\n1. åœ¨æ—¥æ›†ä¸­é»æ“Šç¯€ç›®\n2. æˆ–ä½¿ç”¨ã€Œèª¿è©¦ç¯€ç›®ã€åŠŸèƒ½æŸ¥çœ‹æ‰€æœ‰ç¯€ç›®');
          return;
        }

        // ç¢ºèªä¸Šæ¶
        const confirmMessage = `ç¢ºå®šè¦ä¸Šæ¶ä»¥ä¸‹ ${selectedPrograms.length} å€‹ç¯€ç›®åˆ° Contentful å—ï¼Ÿ\n\n${selectedPrograms.map(p => `â€¢ ${p.title} (${p.airDate} ${p.airTime})`).join('\n')}`;
        if (!confirm(confirmMessage)) {
          return;
        }

        // é¡¯ç¤ºé€²åº¦
        const progressDiv = document.createElement('div');
        progressDiv.id = 'uploadProgress';
        progressDiv.style.cssText = `
          position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
          background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
          z-index: 10000; max-width: 500px; width: 90%;
        `;
        progressDiv.innerHTML = `
          <h3>ğŸ“º ç¯€ç›®ä¸Šæ¶ä¸­...</h3>
          <div id="progressList" style="max-height: 300px; overflow-y: auto; margin: 10px 0;"></div>
          <button onclick="document.getElementById('uploadProgress').remove()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">é—œé–‰</button>
        `;
        document.body.appendChild(progressDiv);

        const progressList = document.getElementById('progressList');
        
        // ç­‰å¾… Management SDK è¼‰å…¥
        let retryCount = 0;
        const maxRetries = 10;
        
        while (typeof contentfulManagement === 'undefined' && retryCount < maxRetries) {
          progressList.innerHTML += `<div>â³ ç­‰å¾… Management SDK è¼‰å…¥... (${retryCount + 1}/${maxRetries})</div>`;
          await new Promise(resolve => setTimeout(resolve, 1000));
          retryCount++;
        }
        
        if (typeof contentfulManagement === 'undefined') {
          throw new Error('Management SDK è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢');
        }
        
        progressList.innerHTML += '<div>âœ… Management SDK å·²è¼‰å…¥</div>';

        let successCount = 0;
        let failCount = 0;

        // é€å€‹ä¸Šæ¶ç¯€ç›®
        for (let i = 0; i < selectedPrograms.length; i++) {
          const program = selectedPrograms[i];
          progressList.innerHTML += `<div>ğŸ“º ä¸Šæ¶ç¯€ç›® ${i + 1}/${selectedPrograms.length}: ${program.title}</div>`;
          
          try {
            // æº–å‚™ç¯€ç›®æ•¸æ“š
            const programData = {
              contentType: 'scheduleItem',
              title: program.title,
              airDate: program.airDate,
              airTime: program.airTime,
              slotNumber: program.slotNumber || 0,
              isFirstBroadcast: program.isFirstBroadcast || false,
              notes: program.notes || '',
              videoReference: program.videoReference || '',
              category: program.category || 'æ—…éŠç¯€ç›®',
              duration: program.duration || 30
            };

            // ä¸Šæ¶åˆ° Contentfulï¼ˆä½¿ç”¨ç°¡åŒ–åŠŸèƒ½ï¼‰
            const result = await uploadProgramSimple(programData);
            
            if (result.success) {
              progressList.innerHTML += `<div style="color: green;">âœ… ${program.title} ä¸Šæ¶æˆåŠŸ (ID: ${result.entryId})</div>`;
              successCount++;
            } else {
              progressList.innerHTML += `<div style="color: red;">âŒ ${program.title} ä¸Šæ¶å¤±æ•—</div>`;
              failCount++;
            }
          } catch (error) {
            progressList.innerHTML += `<div style="color: red;">âŒ ${program.title} ä¸Šæ¶éŒ¯èª¤: ${error.message}</div>`;
            failCount++;
          }
        }

        // é¡¯ç¤ºçµæœ
        progressList.innerHTML += `<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
          <strong>ä¸Šæ¶å®Œæˆï¼</strong><br>
          âœ… æˆåŠŸ: ${successCount} å€‹<br>
          âŒ å¤±æ•—: ${failCount} å€‹<br>
          ğŸ“Š ç¸½è¨ˆ: ${selectedPrograms.length} å€‹ç¯€ç›®
        </div>`;

        // æ›´æ–°æœ¬åœ°ç¯€ç›®ç‹€æ…‹
        if (successCount > 0) {
          updateLocalProgramStatus(selectedPrograms.slice(0, successCount), 'uploaded');
        }

      } catch (error) {
        alert(`ç¯€ç›®ä¸Šæ¶å¤±æ•—: ${error.message}\n\nè«‹æª¢æŸ¥ï¼š\n1. Contentful ç³»çµ±æ˜¯å¦å·²åˆå§‹åŒ–\n2. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸\n3. API Token æ˜¯å¦æ­£ç¢º`);
        console.error('ç¯€ç›®ä¸Šæ¶éŒ¯èª¤:', error);
      }
    }

    // ç²å–é¸ä¸­çš„ç¯€ç›®
    function getSelectedPrograms() {
      const selectedPrograms = [];
      
      // å¾ localStorage ä¸­ç²å–ç¯€ç›®è³‡æ–™
      const calendarEvents = JSON.parse(localStorage.getItem('calendar_events') || '{}');
      
      // å¾æ—¥æ›†äº‹ä»¶ä¸­ç²å–ç¯€ç›®
      Object.keys(calendarEvents).forEach(date => {
        calendarEvents[date].forEach(event => {
          if (event.selected) {
            selectedPrograms.push({
              title: event.title,
              airDate: date,
              airTime: event.time,
              slotNumber: event.slotNumber || 0,
              isFirstBroadcast: event.isFirstBroadcast || false,
              notes: event.notes || '',
              videoReference: event.videoReference || '',
              category: event.category || 'æ—…éŠç¯€ç›®',
              duration: event.duration || 30
            });
          }
        });
      });

      // å¦‚æœæ²’æœ‰é¸ä¸­çš„ç¯€ç›®ï¼Œè¿”å›ä»Šæ—¥æ‰€æœ‰ç¯€ç›®
      if (selectedPrograms.length === 0) {
        const today = new Date().toISOString().split('T')[0];
        if (calendarEvents[today]) {
          calendarEvents[today].forEach(event => {
            selectedPrograms.push({
              title: event.title,
              airDate: today,
              airTime: event.time,
              slotNumber: event.slotNumber || 0,
              isFirstBroadcast: event.isFirstBroadcast || false,
              notes: event.notes || '',
              videoReference: event.videoReference || '',
              category: event.category || 'æ—…éŠç¯€ç›®',
              duration: event.duration || 30
            });
          });
        }
      }

      return selectedPrograms;
    }

    // æ›´æ–°æœ¬åœ°ç¯€ç›®ç‹€æ…‹
    function updateLocalProgramStatus(programs, status) {
      programs.forEach(program => {
        const eventKey = `${program.airDate}_${program.airTime}`;
        if (window.calendarEvents && window.calendarEvents[program.airDate]) {
          const event = window.calendarEvents[program.airDate].find(e => e.time === program.airTime);
          if (event) {
            event.uploadStatus = status;
            event.uploadedAt = new Date().toISOString();
          }
        }
      });
      
      // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²
      if (window.calendarEvents) {
        localStorage.setItem('calendarEvents', JSON.stringify(window.calendarEvents));
      }
    }

    // æª¢æŸ¥ç³»çµ±ç‹€æ…‹
    function checkSystemStatus() {
      const status = {
        contentful: typeof contentful !== 'undefined',
        contentfulManagement: typeof contentfulManagement !== 'undefined',
        windowContentfulManagement: typeof window.contentfulManagement !== 'undefined',
        uploadProgramSimple: typeof uploadProgramSimple === 'function'
      };
      
      console.log('ç³»çµ±ç‹€æ…‹æª¢æŸ¥:', status);
      
      let message = 'ç³»çµ±ç‹€æ…‹æª¢æŸ¥çµæœ:\n\n';
      message += status.contentful ? 'âœ… Contentful SDK å·²è¼‰å…¥\n' : 'âŒ Contentful SDK æœªè¼‰å…¥\n';
      message += status.contentfulManagement ? 'âœ… Management SDK å·²è¼‰å…¥\n' : 'âŒ Management SDK æœªè¼‰å…¥\n';
      message += status.windowContentfulManagement ? 'âœ… window.contentfulManagement å¯ç”¨\n' : 'âŒ window.contentfulManagement ä¸å¯ç”¨\n';
      message += status.uploadProgramSimple ? 'âœ… ä¸Šæ¶åŠŸèƒ½å¯ç”¨\n' : 'âŒ ä¸Šæ¶åŠŸèƒ½ä¸å¯ç”¨\n';
      
      // è¨ºæ–·è³‡è¨Š
      message += '\nè¨ºæ–·è³‡è¨Š:\n';
      message += `- contentful: ${typeof contentful}\n`;
      message += `- contentfulManagement: ${typeof contentfulManagement}\n`;
      message += `- window.contentfulManagement: ${typeof window.contentfulManagement}\n`;
      message += `- uploadProgramSimple: ${typeof uploadProgramSimple}\n`;
      
      if (status.contentful && status.contentfulManagement && status.uploadProgramSimple) {
        message += '\nğŸ‰ ç³»çµ±ç‹€æ…‹æ­£å¸¸ï¼Œå¯ä»¥é€²è¡ŒçœŸå¯¦ç¯€ç›®ä¸Šæ¶ï¼';
        alert(message);
        return true;
      } else {
        message += '\nâš ï¸ ç³»çµ±ç‹€æ…‹ç•°å¸¸ï¼ŒManagement SDK æœªè¼‰å…¥';
        alert(message);
        return false;
      }
    }

    // å°‡æ™‚é–“è½‰æ›ç‚ºæ™‚æ®µç¯„åœ
    // åœ–ç‰‡å£“ç¸®å‡½æ•¸
    function compressImage(base64String, quality = 0.7) {
      return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = function() {
          // è¨ˆç®—æ–°å°ºå¯¸ï¼ˆæœ€å¤§å¯¬åº¦ 400pxï¼Œæ›´å°çš„å°ºå¯¸ä»¥æ¸›å°‘ base64 é•·åº¦ï¼‰
          const maxWidth = 400;
          const maxHeight = 300;
          let { width, height } = img;
          
          // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹
          const widthRatio = maxWidth / width;
          const heightRatio = maxHeight / height;
          const ratio = Math.min(widthRatio, heightRatio, 1); // ä¸æ”¾å¤§åœ–ç‰‡
          
          if (ratio < 1) {
            width = Math.floor(width * ratio);
            height = Math.floor(height * ratio);
          }
          
          canvas.width = width;
          canvas.height = height;
          
          // ç¹ªè£½å£“ç¸®å¾Œçš„åœ–ç‰‡
          ctx.drawImage(img, 0, 0, width, height);
          
          // è½‰æ›ç‚º base64ï¼Œä½¿ç”¨æ›´ä½çš„å“è³ª
          let compressedBase64 = canvas.toDataURL('image/jpeg', quality);
          
          // æª¢æŸ¥ base64 é•·åº¦ï¼Œå¦‚æœé‚„æ˜¯å¤ªé•·ï¼Œé€²ä¸€æ­¥é™ä½å“è³ª
          let currentQuality = quality;
          while (compressedBase64.length > 30000 && currentQuality > 0.1) { // é™åˆ¶åœ¨ 30KB ä»¥å…§
            currentQuality -= 0.1;
            compressedBase64 = canvas.toDataURL('image/jpeg', currentQuality);
            console.log(`ğŸ”„ é€²ä¸€æ­¥å£“ç¸®åœ–ç‰‡ï¼Œå“è³ª: ${currentQuality.toFixed(1)}, å¤§å°: ${compressedBase64.length} å­—ç¬¦`);
          }
          
          console.log(`ğŸ“Š æœ€çµ‚å£“ç¸®çµæœ: å“è³ª ${currentQuality.toFixed(1)}, å¤§å° ${compressedBase64.length} å­—ç¬¦`);
          resolve(compressedBase64);
        };
        
        img.onerror = function() {
          console.error('âŒ åœ–ç‰‡è¼‰å…¥å¤±æ•—');
          resolve(base64String); // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œè¿”å›åŸå§‹æ•¸æ“š
        };
        
        img.src = base64String;
      });
    }

    // æª¢æŸ¥ä¸¦èª¿æ•´ notes æ¬„ä½é•·åº¦
    function validateAndAdjustNotesLength(notes, maxLength = 45000) {
      if (notes.length <= maxLength) {
        return notes;
      }
      
      console.warn(`âš ï¸ Notes æ¬„ä½éé•· (${notes.length} å­—ç¬¦)ï¼Œé–‹å§‹èª¿æ•´...`);
      
      // å˜—è©¦ç§»é™¤ç¸®åœ–æ•¸æ“š
      const thumbnailMatch = notes.match(/\[ç¸®åœ–:data:image\/[^]]+\]/);
      if (thumbnailMatch) {
        const withoutThumbnail = notes.replace(thumbnailMatch[0], '[ç¸®åœ–:å·²ç§»é™¤-éé•·]');
        console.log(`ğŸ“Š ç§»é™¤ç¸®åœ–å¾Œé•·åº¦: ${withoutThumbnail.length} å­—ç¬¦`);
        
        if (withoutThumbnail.length <= maxLength) {
          return withoutThumbnail;
        }
      }
      
      // å¦‚æœé‚„æ˜¯å¤ªé•·ï¼Œæˆªæ–·æè¿°æ–‡å­—
      const descriptionMatch = notes.match(/^(\[åˆ†é¡:[^\]]+\])(.*?)(\[æ™‚é•·:[^\]]+\])(.*)$/s);
      if (descriptionMatch) {
        const [, category, description, duration, rest] = descriptionMatch;
        const maxDescriptionLength = maxLength - category.length - duration.length - rest.length - 100; // é ç•™ 100 å­—ç¬¦ç·©è¡
        
        if (maxDescriptionLength > 0) {
          const truncatedDescription = description.length > maxDescriptionLength 
            ? description.substring(0, maxDescriptionLength - 3) + '...'
            : description;
          
          const adjustedNotes = category + truncatedDescription + duration + rest;
          console.log(`ğŸ“Š æˆªæ–·æè¿°å¾Œé•·åº¦: ${adjustedNotes.length} å­—ç¬¦`);
          return adjustedNotes;
        }
      }
      
      // æœ€å¾Œæ‰‹æ®µï¼šç›´æ¥æˆªæ–·
      const truncated = notes.substring(0, maxLength - 3) + '...';
      console.warn(`âš ï¸ ç›´æ¥æˆªæ–· notes åˆ° ${truncated.length} å­—ç¬¦`);
      return truncated;
    }

    function getTimeBlock(timeString) {
      if (!timeString) return '12-18';
      
      const hour = parseInt(timeString.split(':')[0]);
      
      if (hour >= 0 && hour < 6) return '00-06';
      if (hour >= 6 && hour < 12) return '06-12';
      if (hour >= 12 && hour < 18) return '12-18';
      if (hour >= 18 && hour < 24) return '18-24';
      
      return '12-18'; // é è¨­å€¼
    }

    // æ¸…ç†èˆŠçš„æ¸¬è©¦è³‡æ–™
    function clearOldTestData() {
      try {
        const calendarEvents = JSON.parse(localStorage.getItem('calendar_events') || '{}');
        let removedCount = 0;
        
        Object.keys(calendarEvents).forEach(date => {
          calendarEvents[date] = calendarEvents[date].filter(event => {
            // æª¢æŸ¥æ˜¯å¦ç‚ºæ¸¬è©¦è³‡æ–™
            const isTestData = 
              event.title.includes('åŠ æ‹¿å¤§') || 
              event.title.includes('æ¥µå…‰') || 
              event.title.includes('å¯’å†°') || 
              event.title.includes('æ•é­š') ||
              event.title.includes('æ¸¬è©¦') ||
              event.title.includes('demo') ||
              event.title.includes('Demo');
            
            if (isTestData) {
              removedCount++;
              console.log('ç§»é™¤æ¸¬è©¦è³‡æ–™:', event.title);
              return false;
            }
            return true;
          });
        });
        
        // å„²å­˜æ¸…ç†å¾Œçš„è³‡æ–™
        localStorage.setItem('calendar_events', JSON.stringify(calendarEvents));
        
        if (removedCount > 0) {
          showStatus(`å·²æ¸…ç† ${removedCount} å€‹æ¸¬è©¦ç¯€ç›®è³‡æ–™`, 'success');
          console.log(`å·²æ¸…ç† ${removedCount} å€‹æ¸¬è©¦ç¯€ç›®è³‡æ–™`);
        } else {
          showStatus('æ²’æœ‰æ‰¾åˆ°éœ€è¦æ¸…ç†çš„æ¸¬è©¦è³‡æ–™', 'info');
        }
        
        return removedCount;
      } catch (error) {
        console.error('æ¸…ç†æ¸¬è©¦è³‡æ–™å¤±æ•—:', error);
        showStatus('æ¸…ç†æ¸¬è©¦è³‡æ–™å¤±æ•—: ' + error.message, 'error');
        return 0;
      }
    }

    // æª¢æŸ¥ Contentful å…§å®¹é¡å‹ï¼ˆä¾›æŒ‰éˆ•èª¿ç”¨ï¼‰
    async function checkContentfulContentTypes() {
      try {
        showStatus('æ­£åœ¨æª¢æŸ¥ Contentful å…§å®¹é¡å‹...', 'info');
        
        // æª¢æŸ¥ Management SDK
        if (typeof contentfulManagement === 'undefined') {
          throw new Error('Management SDK æœªè¼‰å…¥');
        }

        // å‰µå»º Management å®¢æˆ¶ç«¯
        const managementClient = contentfulManagement.createClient({
          accessToken: window.CONTENTFUL_CONFIG?.MANAGEMENT_TOKEN || window.CONTENTFUL_MANAGEMENT_TOKEN
        });

        // ç²å– Space
        const space = await managementClient.getSpace(window.CONTENTFUL_CONFIG?.SPACE_ID || 'os5wf90ljenp');
        
        // ç²å– Environment
        const environment = await space.getEnvironment('master');
        
        // æª¢æŸ¥å…§å®¹é¡å‹
        const contentTypes = await checkAvailableContentTypes(environment);
        
        // é¡¯ç¤ºçµæœåœ¨é é¢ä¸Š
        let message = `æ‰¾åˆ° ${contentTypes.length} å€‹å…§å®¹é¡å‹ï¼š\n\n`;
        contentTypes.forEach(ct => {
          message += `ğŸ“‹ ${ct.name} (${ct.sys.id})\n`;
          message += `   æ¬„ä½: ${ct.fields.map(f => `${f.name}(${f.id}:${f.type})`).join(', ')}\n\n`;
        });
        
        console.log('Contentful å…§å®¹é¡å‹:', contentTypes);
        console.log('=== å…§å®¹é¡å‹è©³ç´°è³‡è¨Š ===');
        console.log(message);
        
        // åœ¨ç‹€æ…‹æ¬„é¡¯ç¤ºçµæœ
        showStatus(`âœ… æ‰¾åˆ° ${contentTypes.length} å€‹å…§å®¹é¡å‹ï¼Œè©³æƒ…è«‹æŸ¥çœ‹æ§åˆ¶å°`, 'success');
        
        // åœ¨é é¢ä¸Šå‰µå»ºä¸€å€‹é¡¯ç¤ºå€åŸŸ
        let displayDiv = document.getElementById('contentTypesDisplay');
        if (!displayDiv) {
          displayDiv = document.createElement('div');
          displayDiv.id = 'contentTypesDisplay';
          displayDiv.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 20px;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
            z-index: 10000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            font-family: monospace;
            white-space: pre-line;
          `;
          document.body.appendChild(displayDiv);
        }
        
        displayDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; color: #007bff;">Contentful å…§å®¹é¡å‹</h3>
            <button onclick="document.getElementById('contentTypesDisplay').remove()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">é—œé–‰</button>
          </div>
          <div style="max-height: 400px; overflow-y: auto;">${message}</div>
        `;
        
      } catch (error) {
        console.error('æª¢æŸ¥å…§å®¹é¡å‹å¤±æ•—:', error);
        showStatus('âŒ æª¢æŸ¥å…§å®¹é¡å‹å¤±æ•—: ' + error.message, 'error');
        alert('æª¢æŸ¥å…§å®¹é¡å‹å¤±æ•—: ' + error.message);
      }
    }

    // æª¢æŸ¥ Contentful ä¸­å¯ç”¨çš„å…§å®¹é¡å‹
    async function checkAvailableContentTypes(environment) {
      try {
        const contentTypes = await environment.getContentTypes();
        console.log('å¯ç”¨çš„å…§å®¹é¡å‹:', contentTypes.items.map(ct => ({
          id: ct.sys.id,
          name: ct.name,
          fields: ct.fields.map(f => ({ id: f.id, name: f.name, type: f.type }))
        })));
        return contentTypes.items;
      } catch (error) {
        console.error('ç²å–å…§å®¹é¡å‹å¤±æ•—:', error);
        return [];
      }
    }

    // å‰µå»ºæˆ–ç²å–é è¨­å½±ç‰‡ Entry
    async function createOrGetDefaultVideoEntry(managementClient, space, environment) {
      try {
        // å…ˆæª¢æŸ¥å¯ç”¨çš„å…§å®¹é¡å‹
        const contentTypes = await checkAvailableContentTypes(environment);
        
        // å°‹æ‰¾å½±ç‰‡ç›¸é—œçš„å…§å®¹é¡å‹
        const videoContentType = contentTypes.find(ct => 
          ct.sys.id === 'video' || 
          ct.sys.id === 'videoAsset' || 
          ct.name.toLowerCase().includes('video') ||
          ct.name.toLowerCase().includes('å½±ç‰‡')
        );
        
        if (!videoContentType) {
          console.log('æ²’æœ‰æ‰¾åˆ°å½±ç‰‡å…§å®¹é¡å‹ï¼Œè·³é video æ¬„ä½');
          return null;
        }
        
        console.log('æ‰¾åˆ°å½±ç‰‡å…§å®¹é¡å‹:', videoContentType.sys.id, videoContentType.name);
        
        // å˜—è©¦ç²å–ç¾æœ‰çš„å½±ç‰‡ Entry
        const existingVideos = await environment.getEntries({
          content_type: videoContentType.sys.id,
          limit: 1
        });
        
        if (existingVideos.items.length > 0) {
          console.log('æ‰¾åˆ°ç¾æœ‰å½±ç‰‡ Entry:', existingVideos.items[0].sys.id);
          return existingVideos.items[0].sys.id;
        }
        
        // å¦‚æœæ²’æœ‰ç¾æœ‰çš„ï¼Œå‰µå»ºä¸€å€‹é è¨­çš„å½±ç‰‡ Entry
        console.log('å‰µå»ºé è¨­å½±ç‰‡ Entry...');
        const videoEntryData = {
          fields: {
            'title': { 'en-US': 'é è¨­å½±ç‰‡' },
            'videoType': { 'en-US': 'MP4' },
            'youTubeId': { 'en-US': '' },
            'mp4Url': { 'en-US': '' },
            'isHero': { 'en-US': false },
            'heroTitle': { 'en-US': '' },
            'heroText': { 'en-US': '' },
            'isFeatured': { 'en-US': false },
            'featuredText': { 'en-US': '' },
            'comingSoon': { 'en-US': false },
            'releaseDate': { 'en-US': new Date().toISOString() },
            'description': { 'en-US': 'é è¨­å½±ç‰‡æè¿°' }
          }
        };
        
        // æ ¹æ“šå…§å®¹é¡å‹æ·»åŠ å¿…è¦çš„æ¬„ä½
        videoContentType.fields.forEach(field => {
          if (field.required && !videoEntryData.fields[field.id]) {
            if (field.type === 'Text' || field.type === 'ShortText') {
              videoEntryData.fields[field.id] = { 'en-US': 'é è¨­å€¼' };
            } else if (field.type === 'Number') {
              videoEntryData.fields[field.id] = { 'en-US': 0 };
            } else if (field.type === 'Boolean') {
              videoEntryData.fields[field.id] = { 'en-US': false };
            }
          }
        });
        
        const videoEntry = await environment.createEntry(videoContentType.sys.id, videoEntryData);
        await videoEntry.publish();
        
        console.log('å‰µå»ºé è¨­å½±ç‰‡ Entry æˆåŠŸ:', videoEntry.sys.id);
        return videoEntry.sys.id;
        
      } catch (error) {
        console.error('å‰µå»ºæˆ–ç²å–å½±ç‰‡ Entry å¤±æ•—:', error);
        // å¦‚æœå‰µå»ºå¤±æ•—ï¼Œè¿”å› nullï¼Œè®“ä¸Šæ¶å‡½æ•¸æ±ºå®šå¦‚ä½•è™•ç†
        return null;
      }
    }

    // ç°¡åŒ–çš„ä¸Šæ¶åŠŸèƒ½ï¼ˆä¸ä¾è³´ contentful-real-only.jsï¼‰
    // å‰µå»ºæˆ–ç²å– video entry
    async function createOrGetVideoEntry(youtubeId, title, environment) {
      try {
        // å…ˆæª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„ video entry
        const existingVideos = await environment.getEntries({
          content_type: 'video',
          'fields.youTubeId': youtubeId
        });
        
        if (existingVideos.items.length > 0) {
          console.log('æ‰¾åˆ°ç¾æœ‰çš„ video entry:', existingVideos.items[0].sys.id);
          return existingVideos.items[0];
        }
        
        // å‰µå»ºæ–°çš„ video entry
        const videoEntry = await environment.createEntry('video', {
          fields: {
            'title': { 'en-US': title || 'YouTube å½±ç‰‡' },
            'youTubeId': { 'en-US': youtubeId },
            'thumbnail': { 'en-US': `https://img.youtube.com/vi/${youtubeId}/maxresdefault.jpg` }
          }
        });
        
        // ç™¼å¸ƒ video entry
        await videoEntry.publish();
        console.log('å‰µå»ºæ–°çš„ video entry:', videoEntry.sys.id);
        return videoEntry;
        
      } catch (error) {
        console.error('å‰µå»º video entry å¤±æ•—:', error);
        throw error;
      }
    }

    // æ›´æ–°ç¾æœ‰ç¯€ç›®åˆ° Contentful
    async function updateProgramInContentful(contentfulId, programData) {
      try {
        console.log('ğŸ”„ é–‹å§‹æ›´æ–°ç¯€ç›®åˆ° Contentful:', contentfulId, programData);
        
        // æª¢æŸ¥ API Token
        const managementToken = window.CONTENTFUL_CONFIG?.MANAGEMENT_TOKEN || window.CONTENTFUL_MANAGEMENT_TOKEN;
        if (!managementToken) {
          throw new Error('Management Token æœªè¨­å®š');
        }

        // å‰µå»º Contentful Management API å®¢æˆ¶ç«¯
        const managementClient = contentfulManagement.createClient({
          accessToken: managementToken
        });

        // ç²å– Space å’Œ Environment
        const spaceId = window.CONTENTFUL_CONFIG?.SPACE_ID || 'os5wf90ljenp';
        const space = await managementClient.getSpace(spaceId);
        const environment = await space.getEnvironment('master');

        // ç²å–ç¾æœ‰æ¢ç›®
        const entry = await environment.getEntry(contentfulId);
        
        // æº–å‚™æ›´æ–°è³‡æ–™
        console.log('ğŸ” è™•ç†ä¸»é¡Œæ¢ç´¢åˆ†é¡:', {
          programDataTopics: programData.topics,
          topicsLength: programData.topics ? programData.topics.length : 0,
          topicsType: typeof programData.topics
        });
        
        const topicsText = programData.topics && programData.topics.length > 0 
          ? programData.topics.map(topicId => {
              const topicData = TOPICS_DATA.find(t => t.id === topicId);
              console.log('ğŸ” ä¸»é¡Œæ˜ å°„:', { topicId, topicData: topicData ? topicData.title : 'æœªæ‰¾åˆ°' });
              return topicData ? topicData.title : topicId;
            }).join(',')
          : '';
        
        console.log('ğŸ” æœ€çµ‚ä¸»é¡Œæ–‡å­—:', topicsText);
        
        // æ§‹å»ºå‚™è¨»å…§å®¹ï¼ŒåŒ…å«åˆ†é¡å’Œä¸»é¡Œæ¨™è¨˜
        let notes = programData.description || '';
        
        // æ·»åŠ åˆ†é¡æ¨™è¨˜
        if (programData.category) {
          const categoryPattern = /\[åˆ†é¡:.*?\]/g;
          notes = notes.replace(categoryPattern, '');
          notes = `[åˆ†é¡:${programData.category}] ${notes}`;
        }
        
        // æ·»åŠ ä¸»é¡Œæ¨™è¨˜
        if (topicsText) {
          const topicPattern = /\[ä¸»é¡Œ:.*?\]/g;
          notes = notes.replace(topicPattern, '');
          notes = `${notes} [ä¸»é¡Œ:${topicsText}]`;
          console.log('ğŸ” æ·»åŠ ä¸»é¡Œæ¨™è¨˜å¾Œçš„å‚™è¨»:', notes.substring(0, 200) + '...');
        } else {
          console.log('âš ï¸ æ²’æœ‰ä¸»é¡Œæ–‡å­—ï¼Œè·³éä¸»é¡Œæ¨™è¨˜');
        }
        
        // æ·»åŠ æ™‚é•·æ¨™è¨˜
        if (programData.duration) {
          const durationPattern = /\[æ™‚é•·:.*?\]/g;
          notes = notes.replace(durationPattern, '');
          notes = `${notes} [æ™‚é•·:${programData.duration}åˆ†é˜]`;
        }
        
        // æ·»åŠ ç‹€æ…‹æ¨™è¨˜
        if (programData.status) {
          const statusPattern = /\[ç‹€æ…‹:.*?\]/g;
          notes = notes.replace(statusPattern, '');
          notes = `${notes} [ç‹€æ…‹:${programData.status}]`;
        }
        
        // æ·»åŠ ç¸®åœ–æ¨™è¨˜ï¼ˆæª¢æŸ¥å¤§å°ï¼‰
        if (programData.thumbnail) {
          const thumbnailPattern = /\[ç¸®åœ–:.*?\]/g;
          notes = notes.replace(thumbnailPattern, '');
          
          // æª¢æŸ¥ç¸®åœ–å¤§å°
          let thumbnail = programData.thumbnail;
          if (thumbnail.startsWith('data:image/')) {
            const sizeInBytes = (thumbnail.length * 3) / 4; // base64 å¤§å°ä¼°ç®—
            const maxSize = 500000; // 500KB é™åˆ¶
            
            if (sizeInBytes > maxSize) {
              console.warn('âš ï¸ ç¸®åœ–å¤ªå¤§ï¼Œå˜—è©¦å£“ç¸®...', { sizeInBytes, maxSize });
              thumbnail = await compressImage(thumbnail, 0.7); // å£“ç¸®åˆ° 70% å“è³ª
              const newSize = (thumbnail.length * 3) / 4;
              console.log('ğŸ“Š å£“ç¸®å¾Œå¤§å°:', { newSize, originalSize: sizeInBytes });
            }
          }
          
          notes = `${notes} [ç¸®åœ–:${thumbnail}]`;
        }

        // é©—è­‰ä¸¦èª¿æ•´ notes æ¬„ä½é•·åº¦
        notes = validateAndAdjustNotesLength(notes);

        // è¨ˆç®— block å’Œ slotIndex
        const block = getTimeBlock(programData.airTime);
        const slotIndex = 0; // é è¨­å€¼ï¼Œå¯ä»¥æ ¹æ“šéœ€è¦èª¿æ•´
        
        // æ›´æ–°æ¢ç›®ï¼ˆåªæ›´æ–° Contentful ä¸­å¯¦éš›å­˜åœ¨çš„æ¬„ä½ï¼‰
        entry.fields.title = { 'en-US': programData.title };
        entry.fields.airDate = { 'en-US': programData.airDate };
        entry.fields.block = { 'en-US': block };
        entry.fields.slotIndex = { 'en-US': slotIndex };
        entry.fields.notes = { 'en-US': notes };
        
        // æ³¨æ„ï¼šdurationã€statusã€youtubeIdã€thumbnail ç­‰è³‡è¨Šéƒ½å­˜å„²åœ¨ notes æ¬„ä½ä¸­
        // ä¸éœ€è¦å–®ç¨æ›´æ–°é€™äº›æ¬„ä½ï¼Œå› ç‚ºå®ƒå€‘åœ¨ Contentful ä¸­ä¸å­˜åœ¨

        // ä¿å­˜æ›´æ–°
        const updatedEntry = await entry.update();
        
        // ç™¼å¸ƒæ›´æ–°
        await updatedEntry.publish();
        
        console.log('âœ… æˆåŠŸæ›´æ–°ç¯€ç›®åˆ° Contentful:', updatedEntry.sys.id);
        
        // æ›´æ–°æœ¬åœ°äº‹ä»¶è³‡æ–™
        const event = getEvent(programData.airDate, programData.airTime);
        if (event) {
          event.title = programData.title;
          event.duration = programData.duration;
          event.category = programData.category;
          event.description = notes;
          event.status = programData.status;
          event.youtubeId = programData.youtubeId;
          event.thumbnail = programData.thumbnail;
          event.topics = programData.topics;
          event.publishedAt = new Date().toISOString();
          event.contentfulId = updatedEntry.sys.id;
        }
        
        saveEvents();
        renderCurrentView();
        
        return {
          success: true,
          entryId: updatedEntry.sys.id,
          message: 'ç¯€ç›®æ›´æ–°æˆåŠŸ'
        };
        
      } catch (error) {
        console.error('âŒ æ›´æ–°ç¯€ç›®å¤±æ•—:', error);
        console.error('éŒ¯èª¤è©³æƒ…:', {
          message: error.message,
          status: error.status,
          statusText: error.statusText,
          details: error.details,
          contentfulId: contentfulId,
          programData: programData
        });
        
        // å¦‚æœæ˜¯ Contentful é©—è­‰éŒ¯èª¤ï¼Œæä¾›æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
        let errorMessage = error.message || 'æ›´æ–°å¤±æ•—';
        if (error.status === 422) {
          errorMessage = 'Contentful é©—è­‰éŒ¯èª¤ï¼š' + (error.details?.errors?.[0]?.details || error.message);
        } else if (error.status === 404) {
          errorMessage = 'æ‰¾ä¸åˆ°æŒ‡å®šçš„ç¯€ç›®ï¼Œå¯èƒ½å·²è¢«åˆªé™¤';
        } else if (error.status === 401) {
          errorMessage = 'API æ¬Šé™éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Management Token';
        }
        
        return {
          success: false,
          error: errorMessage,
          details: error.details || error.message
        };
      }
    }

    async function uploadProgramSimple(programData) {
      try {
        console.log('ğŸš€ é–‹å§‹ä¸Šæ¶ç¯€ç›®:', programData);
        
        // æª¢æŸ¥ Management SDK
        if (typeof contentfulManagement === 'undefined') {
          throw new Error('Management SDK æœªè¼‰å…¥');
        }
        console.log('âœ… Management SDK å·²è¼‰å…¥');

        // æª¢æŸ¥ API Token
        const managementToken = window.CONTENTFUL_CONFIG?.MANAGEMENT_TOKEN || window.CONTENTFUL_MANAGEMENT_TOKEN;
        if (!managementToken) {
          throw new Error('Management Token æœªè¨­å®š');
        }
        console.log('âœ… Management Token å·²è¨­å®š');

        // å‰µå»º Management å®¢æˆ¶ç«¯
        const managementClient = contentfulManagement.createClient({
          accessToken: managementToken
        });
        console.log('âœ… Management å®¢æˆ¶ç«¯å·²å‰µå»º');

        // ç²å– Space
        const spaceId = window.CONTENTFUL_CONFIG?.SPACE_ID || 'os5wf90ljenp';
        const space = await managementClient.getSpace(spaceId);
        console.log('âœ… Space å·²ç²å–:', spaceId);
        
        // ç²å– Environment
        const environment = await space.getEnvironment('master');
        console.log('âœ… Environment å·²ç²å–: master');
        
        // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„ç¯€ç›®
        const airDate = programData.airDate || new Date().toISOString().split('T')[0];
        const block = getTimeBlock(programData.airTime);
        const slotIndex = programData.slotNumber || 0;
        const airTime = programData.airTime; // å…·é«”æ™‚é–“ï¼Œå¦‚ "23:00"
        
        console.log('æª¢æŸ¥é‡è¤‡ç¯€ç›®:', { title: programData.title, airDate, airTime, block, slotIndex });
        
        // æŸ¥è©¢æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ—¥æœŸã€å…·é«”æ™‚é–“çš„ç¯€ç›®
        const existingEntries = await environment.getEntries({
          content_type: 'scheduleItem',
          'fields.airDate': airDate,
          limit: 100
        });
        console.log('âœ… æŸ¥è©¢ç¾æœ‰ç¯€ç›®å®Œæˆï¼Œæ‰¾åˆ°', existingEntries.items.length, 'å€‹ç¯€ç›®');
        
        // è©³ç´°è¨˜éŒ„ç¾æœ‰ç¯€ç›®
        existingEntries.items.forEach((entry, index) => {
          const entryNotes = String(entry.fields.notes || '');
          const timeMatch = entryNotes.match(/\[æ™‚é–“:(\d{2}:\d{2})\]/);
          const entryAirTime = timeMatch ? timeMatch[1] : null;
          console.log(`ç¾æœ‰ç¯€ç›® ${index + 1}:`, {
            id: entry.sys.id,
            title: entry.fields.title,
            notes: entryNotes,
            extractedTime: entryAirTime,
            targetTime: airTime,
            isMatch: entryAirTime === airTime
          });
        });
        
        // æª¢æŸ¥æ˜¯å¦æœ‰ç›¸åŒå…·é«”æ™‚é–“çš„ç¯€ç›®
        const duplicateProgram = existingEntries.items.find(entry => {
          const entryNotes = String(entry.fields.notes || '');
          const timeMatch = entryNotes.match(/\[æ™‚é–“:(\d{2}:\d{2})\]/);
          const entryAirTime = timeMatch ? timeMatch[1] : null;
          
          // æª¢æŸ¥æ™‚é–“æ˜¯å¦ç›¸åŒ
          if (entryAirTime !== airTime) {
            return false;
          }
          
          // æª¢æŸ¥æ˜¯å¦æ˜¯å®Œå…¨ç›¸åŒçš„ç¯€ç›®ï¼ˆæ¨™é¡Œå’Œ YouTube ID éƒ½ç›¸åŒï¼‰
          const entryTitle = entry.fields.title || '';
          const entryYouTubeMatch = entryNotes.match(/\[YouTube:([^\]]+)\]/);
          const entryYouTubeId = entryYouTubeMatch ? entryYouTubeMatch[1] : '';
          
          const isSameTitle = entryTitle === (programData.title || '');
          const isSameYouTubeId = entryYouTubeId === (programData.youtubeId || '');
          
          // å¦‚æœæ˜¯å®Œå…¨ç›¸åŒçš„ç¯€ç›®ï¼Œå‰‡è¦–ç‚ºé‡è¤‡
          if (isSameTitle && isSameYouTubeId) {
            console.log('ç™¼ç¾å®Œå…¨ç›¸åŒç¯€ç›®:', {
              title: entryTitle,
              youtubeId: entryYouTubeId,
              time: entryAirTime
            });
            return true;
          }
          
          return false;
        });
        
        // æª¢æŸ¥æ˜¯å¦æœ‰ç›¸åŒç¯€ç›®ï¼ˆæ¨™é¡Œå’Œ YouTube ID éƒ½ç›¸åŒï¼‰
        const sameProgram = existingEntries.items.find(entry => {
          const entryNotes = String(entry.fields.notes || '');
          const timeMatch = entryNotes.match(/\[æ™‚é–“:(\d{2}:\d{2})\]/);
          const entryAirTime = timeMatch ? timeMatch[1] : null;
          
          // æª¢æŸ¥æ™‚é–“æ˜¯å¦ç›¸åŒ
          if (entryAirTime !== airTime) {
            return false;
          }
          
          // æª¢æŸ¥æ˜¯å¦æ˜¯å®Œå…¨ç›¸åŒçš„ç¯€ç›®
          const entryTitle = entry.fields.title || '';
          const entryYouTubeMatch = entryNotes.match(/\[YouTube:([^\]]+)\]/);
          const entryYouTubeId = entryYouTubeMatch ? entryYouTubeMatch[1] : '';
          
          const isSameTitle = entryTitle === (programData.title || '');
          const isSameYouTubeId = entryYouTubeId === (programData.youtubeId || '');
          
          // å¦‚æœæ˜¯å®Œå…¨ç›¸åŒçš„ç¯€ç›®ï¼Œå‰‡è¦–ç‚ºå¯æ›´æ–°
          if (isSameTitle && isSameYouTubeId) {
            console.log('ç™¼ç¾ç›¸åŒç¯€ç›®ï¼Œå°‡æ›´æ–°è€Œéå‰µå»ºæ–° entry:', {
              existingTitle: entryTitle,
              existingYouTubeId: entryYouTubeId,
              existingTime: entryAirTime,
              entryId: entry.sys.id
            });
            return true;
          }
          
          return false;
        });
        
        // æª¢æŸ¥æ˜¯å¦æœ‰æ™‚é–“è¡çªçš„ç¯€ç›®ï¼ˆä¸åŒç¯€ç›®ä½†ç›¸åŒæ™‚é–“ï¼‰
        const timeConflictProgram = existingEntries.items.find(entry => {
          const entryNotes = String(entry.fields.notes || '');
          const timeMatch = entryNotes.match(/\[æ™‚é–“:(\d{2}:\d{2})\]/);
          const entryAirTime = timeMatch ? timeMatch[1] : null;
          
          // æª¢æŸ¥æ™‚é–“æ˜¯å¦ç›¸åŒ
          if (entryAirTime !== airTime) {
            return false;
          }
          
          // æª¢æŸ¥æ˜¯å¦æ˜¯ä¸åŒçš„ç¯€ç›®ï¼ˆæ¨™é¡Œæˆ– YouTube ID ä¸åŒï¼‰
          const entryTitle = entry.fields.title || '';
          const entryYouTubeMatch = entryNotes.match(/\[YouTube:([^\]]+)\]/);
          const entryYouTubeId = entryYouTubeMatch ? entryYouTubeMatch[1] : '';
          
          const isSameTitle = entryTitle === (programData.title || '');
          const isSameYouTubeId = entryYouTubeId === (programData.youtubeId || '');
          
          // å¦‚æœæ˜¯ä¸åŒç¯€ç›®ä½†ç›¸åŒæ™‚é–“ï¼Œå‰‡è¦–ç‚ºæ™‚é–“è¡çª
          if (!isSameTitle || !isSameYouTubeId) {
            console.log('ç™¼ç¾æ™‚é–“è¡çªç¯€ç›®:', {
              existingTitle: entryTitle,
              existingYouTubeId: entryYouTubeId,
              existingTime: entryAirTime,
              newTitle: programData.title,
              newYouTubeId: programData.youtubeId,
              newTime: airTime,
              isBatchCopy: programData.isBatchCopy,
              originalDate: programData.originalDate
            });
            return true;
          }
          
          return false;
        });
        
        if (sameProgram) {
          console.log('ğŸ”„ ç™¼ç¾ç›¸åŒç¯€ç›®ï¼Œå°‡æ›´æ–°ç¾æœ‰ entry:', sameProgram.sys.id);
          
          try {
            // æ›´æ–°ç¾æœ‰ç¯€ç›®
            const updatedEntry = await sameProgram.update();
            
            // æ›´æ–°æ‰€æœ‰æ¬„ä½ï¼ˆåªæ›´æ–° Contentful ä¸­å¯¦éš›å­˜åœ¨çš„æ¬„ä½ï¼‰
            updatedEntry.fields.title = { 'en-US': programData.title };
            updatedEntry.fields.airDate = { 'en-US': airDate };
            updatedEntry.fields.notes = { 'en-US': notes };
            
            // æ³¨æ„ï¼šairTimeã€statusã€durationã€youtubeIdã€thumbnail ç­‰è³‡è¨Šéƒ½å­˜å„²åœ¨ notes æ¬„ä½ä¸­
            // ä¸éœ€è¦å–®ç¨æ›´æ–°é€™äº›æ¬„ä½ï¼Œå› ç‚ºå®ƒå€‘åœ¨ Contentful ä¸­ä¸å­˜åœ¨
            
            // ä¿å­˜æ›´æ–°
            await updatedEntry.update();
            
            // å¦‚æœåŸæœ¬å·²ç™¼å¸ƒï¼Œé‡æ–°ç™¼å¸ƒ
            if (sameProgram.isPublished()) {
              await updatedEntry.publish();
            }
            
            console.log('âœ… æˆåŠŸæ›´æ–°ç¾æœ‰ç¯€ç›®:', sameProgram.sys.id);
            return { 
              success: true, 
              message: 'æˆåŠŸæ›´æ–°ç¾æœ‰ç¯€ç›®',
              action: 'updated',
              entryId: sameProgram.sys.id
            };
            
          } catch (error) {
            console.error('âŒ æ›´æ–°ç¯€ç›®å¤±æ•—:', error);
            return { 
              success: false, 
              message: `æ›´æ–°ç¯€ç›®å¤±æ•—: ${error.message}`,
              action: 'update_failed'
            };
          }
        }
        
        if (duplicateProgram) {
          console.log('âš ï¸ ç™¼ç¾å®Œå…¨ç›¸åŒç¯€ç›®ï¼Œè·³éä¸Šæ¶:', duplicateProgram.sys.id);
          console.log('é‡è¤‡ç¯€ç›®è©³æƒ…:', {
            id: duplicateProgram.sys.id,
            title: duplicateProgram.fields.title,
            notes: duplicateProgram.fields.notes,
            targetTime: airTime
          });
          return {
            success: true,
            entryId: duplicateProgram.sys.id,
            message: `ç™¼ç¾å®Œå…¨ç›¸åŒç¯€ç›®ï¼Œè·³éé‡è¤‡ä¸Šæ¶`,
            skipped: true
          };
        }
        
        if (timeConflictProgram) {
          console.log('âš ï¸ ç™¼ç¾æ™‚é–“è¡çªç¯€ç›®:', timeConflictProgram.sys.id);
          console.log('æ™‚é–“è¡çªç¯€ç›®è©³æƒ…:', {
            id: timeConflictProgram.sys.id,
            title: timeConflictProgram.fields.title,
            notes: timeConflictProgram.fields.notes,
            targetTime: airTime
          });
          
          // è©¢å•ç”¨æˆ¶æ˜¯å¦è¦è¦†è“‹
          const shouldOverwrite = await showOverwriteConfirmation(
            timeConflictProgram.fields.title || 'æœªçŸ¥ç¯€ç›®',
            airTime,
            airDate,
            programData.isBatchCopy,
            programData.originalDate
          );
          
          if (!shouldOverwrite) {
            return {
              success: true,
              entryId: timeConflictProgram.sys.id,
              message: `ç”¨æˆ¶å–æ¶ˆè¦†è“‹ï¼Œè·³éä¸Šæ¶`,
              skipped: true
            };
          }
          
          // ç”¨æˆ¶é¸æ“‡è¦†è“‹ï¼Œå…ˆåˆªé™¤ç¾æœ‰ç¯€ç›®
          console.log('ğŸ—‘ï¸ ç”¨æˆ¶é¸æ“‡è¦†è“‹ï¼Œåˆªé™¤ç¾æœ‰ç¯€ç›®:', timeConflictProgram.sys.id);
          try {
            await timeConflictProgram.unpublish();
            await timeConflictProgram.delete();
            console.log('âœ… æˆåŠŸåˆªé™¤ç¾æœ‰ç¯€ç›®');
          } catch (deleteError) {
            console.error('âŒ åˆªé™¤ç¾æœ‰ç¯€ç›®å¤±æ•—:', deleteError);
            return {
              success: false,
              error: `åˆªé™¤ç¾æœ‰ç¯€ç›®å¤±æ•—: ${deleteError.message}`
            };
          }
        }
        
        // æº–å‚™ Entry æ•¸æ“šï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼Œä¸åŒ…å« video æ¬„ä½ï¼‰
        let notes = (programData.description || '') + ` [æ™‚é–“:${airTime}]`;
        
        // å¦‚æœæœ‰ YouTube IDï¼Œæ·»åŠ åˆ°å‚™è¨»ä¸­
        if (programData.youtubeId) {
          notes += ` [YouTube:${programData.youtubeId}]`;
        }
        
        // æ·»åŠ åˆ†é¡å’Œä¸»é¡Œè³‡è¨Šåˆ°å‚™è¨»ä¸­
        if (programData.category) {
          notes += ` [åˆ†é¡:${programData.category}]`;
        }
        
        if (programData.topics && programData.topics.length > 0) {
          notes += ` [ä¸»é¡Œ:${programData.topics.join(',')}]`;
        }
        
        if (programData.duration) {
          notes += ` [æ™‚é•·:${programData.duration}åˆ†é˜]`;
        }
        
        if (programData.status) {
          notes += ` [ç‹€æ…‹:${programData.status}]`;
        }
        
        if (programData.thumbnail) {
          // æª¢æŸ¥ç¸®åœ–å¤§å°
          let thumbnail = programData.thumbnail;
          if (thumbnail.startsWith('data:image/')) {
            const sizeInBytes = (thumbnail.length * 3) / 4; // base64 å¤§å°ä¼°ç®—
            const maxSize = 500000; // 500KB é™åˆ¶
            
            if (sizeInBytes > maxSize) {
              console.warn('âš ï¸ ç¸®åœ–å¤ªå¤§ï¼Œå˜—è©¦å£“ç¸®...', { sizeInBytes, maxSize });
              thumbnail = await compressImage(thumbnail, 0.7); // å£“ç¸®åˆ° 70% å“è³ª
              const newSize = (thumbnail.length * 3) / 4;
              console.log('ğŸ“Š å£“ç¸®å¾Œå¤§å°:', { newSize, originalSize: sizeInBytes });
            }
          }
          
          notes += ` [ç¸®åœ–:${thumbnail}]`;
        }
        
        // é©—è­‰ä¸¦èª¿æ•´ notes æ¬„ä½é•·åº¦
        notes = validateAndAdjustNotesLength(notes);
        
        // å…ˆå‰µå»º video entry
        let videoEntry;
        if (programData.youtubeId) {
          try {
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„ YouTube ID
            const existingVideos = await environment.getEntries({
              content_type: 'video',
              'fields.youTubeId': programData.youtubeId
            });
            
            if (existingVideos.items.length > 0) {
              videoEntry = existingVideos.items[0];
              console.log('æ‰¾åˆ°ç¾æœ‰çš„ video entry:', videoEntry.sys.id);
            } else {
              // å‰µå»ºæ–°çš„ video entry
              videoEntry = await environment.createEntry('video', {
                fields: {
                  'title': { 'en-US': programData.title || 'YouTube å½±ç‰‡' },
                  'videoType': { 'en-US': 'YouTube' },
                  'youTubeId': { 'en-US': programData.youtubeId }
                }
              });
              
              // ç™¼å¸ƒ video entry
              await videoEntry.publish();
              console.log('å‰µå»ºæ–°çš„ video entry:', videoEntry.sys.id);
            }
          } catch (error) {
            console.error('å‰µå»º video entry å¤±æ•—:', error);
            throw new Error('ç„¡æ³•å‰µå»ºå½±ç‰‡è³‡æ–™ï¼š' + error.message);
          }
        } else {
          throw new Error('å¿…é ˆæä¾› YouTube ID æ‰èƒ½ä¸Šæ¶ç¯€ç›®');
        }

        const entryData = {
          fields: {
            'title': { 'en-US': programData.title || 'æœªå‘½åç¯€ç›®' },
            'airDate': { 'en-US': airDate },
            'block': { 'en-US': block },
            'slotIndex': { 'en-US': slotIndex },
            'isPremiere': { 'en-US': programData.isFirstBroadcast || false },
            'notes': { 'en-US': notes },
            'video': { 
              'en-US': { 
                sys: { 
                  type: 'Link', 
                  linkType: 'Entry', 
                  id: videoEntry.sys.id 
                } 
              } 
            }
          }
        };
        
        
        console.log('æº–å‚™ä¸Šæ¶çš„ Entry è³‡æ–™:', entryData);

        // å‰µå»º Entry
        const contentTypeId = programData.contentType || 'scheduleItem';
        console.log('å‰µå»º Entryï¼ŒContent Type:', contentTypeId);
        const entry = await environment.createEntry(contentTypeId, entryData);
        console.log('âœ… Entry å‰µå»ºæˆåŠŸ:', entry.sys.id);
        
        // ç™¼å¸ƒ Entry
        console.log('ç™¼å¸ƒ Entry...');
        await entry.publish();
        console.log('âœ… Entry ç™¼å¸ƒæˆåŠŸ');
        
        return {
          success: true,
          entryId: entry.sys.id,
          message: 'ç¯€ç›®å·²æˆåŠŸä¸Šæ¶åˆ° Contentful'
        };
        
      } catch (error) {
        console.error('âŒ ä¸Šæ¶å¤±æ•—:', error);
        console.error('éŒ¯èª¤è©³æƒ…:', {
          message: error.message,
          stack: error.stack,
          programData: programData,
          managementSDK: typeof contentfulManagement,
          windowManagement: typeof window.contentfulManagement,
          config: window.CONTENTFUL_CONFIG
        });
        
        // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
        let errorMessage = error.message;
        if (error.message.includes('Management SDK')) {
          errorMessage = 'Management SDK æœªè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢';
        } else if (error.message.includes('Token')) {
          errorMessage = 'API Token è¨­å®šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é…ç½®';
        } else if (error.message.includes('Space')) {
          errorMessage = 'Space ID éŒ¯èª¤æˆ–ç„¡æ¬Šé™å­˜å–';
        } else if (error.message.includes('Content Type')) {
          errorMessage = 'Content Type ä¸å­˜åœ¨ï¼Œè«‹æª¢æŸ¥ Contentful è¨­å®š';
        }
        
        return {
          success: false,
          error: errorMessage,
          message: 'ç¯€ç›®ä¸Šæ¶å¤±æ•—: ' + errorMessage
        };
      }
    }

    // ========== ç°¡åŒ–ç‰ˆæ‰¹æ¬¡ä¿®æ”¹åŠŸèƒ½ ==========
    
    async function showBatchEditDialog() {
      console.log('ğŸ“ é–‹å•Ÿæ‰¹æ¬¡ä¿®æ”¹å°è©±æ¡†');
      
      try {
        // æª¢æŸ¥å¿…è¦çš„ä¾è³´
        if (typeof contentful === 'undefined') {
          throw new Error('Contentful SDK æœªè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
        }
        
        // é¡¯ç¤ºè¼‰å…¥ä¸­çš„æç¤º
        const loadingModal = document.createElement('div');
        loadingModal.className = 'modal';
        loadingModal.style.display = 'block';
        loadingModal.innerHTML = `
          <div class="modal-content" style="max-width: 600px; text-align: center;">
            <div class="modal-header">
              <h3>ğŸ”„ è¼‰å…¥ç¯€ç›®è³‡æ–™ä¸­...</h3>
            </div>
            <div style="padding: 30px;">
              <div style="font-size: 3rem; margin-bottom: 15px;">â³</div>
              <p style="color: #666;">æ­£åœ¨å¾ Contentful è¼‰å…¥å·²ä¸Šæ¶çš„ç¯€ç›®...</p>
            </div>
          </div>
        `;
        document.body.appendChild(loadingModal);

        // å¾ Contentful è¼‰å…¥æ‰€æœ‰å·²ä¸Šæ¶çš„ç¯€ç›®
        const publishedPrograms = await loadPublishedPrograms();
        
        // ç§»é™¤è¼‰å…¥ä¸­çš„æç¤º
        document.body.removeChild(loadingModal);
        
        if (publishedPrograms.length === 0) {
          alert('ç›®å‰æ²’æœ‰å·²ä¸Šæ¶çš„ç¯€ç›®');
          return;
        }

        // é¡¯ç¤ºæ‰¹æ¬¡ä¿®æ”¹å°è©±æ¡†
        displayBatchEditDialog(publishedPrograms);
        
      } catch (error) {
        console.error('âŒ æ‰¹æ¬¡ä¿®æ”¹åŠŸèƒ½éŒ¯èª¤:', error);
        
        // ç§»é™¤è¼‰å…¥ä¸­çš„æç¤ºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const loadingModal = document.querySelector('.modal');
        if (loadingModal && loadingModal.innerHTML.includes('è¼‰å…¥ç¯€ç›®è³‡æ–™ä¸­')) {
          document.body.removeChild(loadingModal);
        }
        
        alert('æ‰¹æ¬¡ä¿®æ”¹åŠŸèƒ½éŒ¯èª¤ï¼š' + error.message);
      }
    }

    async function loadPublishedPrograms() {
      console.log('ğŸ“¥ å¾ Contentful è¼‰å…¥å·²ä¸Šæ¶ç¯€ç›®...');
      
      const client = contentful.createClient({
        space: 'os5wf90ljenp',
        accessToken: 'lODH-WLwHwVZv7O4rFdBWjSnrzaQWGD4koeOZ1Dypj0'
      });

      // è¼‰å…¥æ‰€æœ‰ scheduleItem
      const response = await client.getEntries({
        content_type: 'scheduleItem',
        limit: 1000,
        order: '-fields.airDate'
      });

      console.log(`âœ… è¼‰å…¥äº† ${response.items.length} å€‹ç¯€ç›®`);
      
      // è½‰æ›ç‚ºç¨‹å¼å¯ç”¨çš„æ ¼å¼
      return response.items.map(item => {
        const notes = String(item.fields.notes || '');
        
        // å¾ notes ä¸­æå–æ™‚é–“
        const timeMatch = notes.match(/\[æ™‚é–“:(\d{2}:\d{2})\]/);
        const airTime = timeMatch ? timeMatch[1] : '';
        
        // å¾ notes ä¸­æå–æ™‚é•·
        const durationMatch = notes.match(/\[æ™‚é•·:(\d+)åˆ†é˜\]/);
        const duration = durationMatch ? parseInt(durationMatch[1]) : 30;
        
        // å¾ notes ä¸­æå–ç‹€æ…‹
        const statusMatch = notes.match(/\[ç‹€æ…‹:(.*?)\]/);
        const status = statusMatch ? statusMatch[1] : 'é‡æ’­';
        
        // å¾ notes ä¸­æå– YouTube ID
        const youtubeMatch = notes.match(/\[YouTube:([^\]]+)\]/);
        const youtubeId = youtubeMatch ? youtubeMatch[1] : '';
        
        // å¾ notes ä¸­æå–ç¸®åœ–
        const thumbnailMatch = notes.match(/\[ç¸®åœ–:([^\]]+)\]/);
        const thumbnail = thumbnailMatch ? thumbnailMatch[1] : (youtubeId ? `https://img.youtube.com/vi/${youtubeId}/maxresdefault.jpg` : '');
        
        return {
          id: item.sys.id,
          title: item.fields.title || 'æœªå‘½åç¯€ç›®',
          airDate: item.fields.airDate || '',
          airTime: airTime,
          duration: duration,
          category: extractCategoryFromNotes(notes),
          topics: extractTopicsFromNotes(notes),
          description: notes,
          status: status,
          youtubeId: youtubeId,
          thumbnail: thumbnail,
          publishedAt: item.sys.publishedAt || item.sys.createdAt,
          updatedAt: item.sys.updatedAt
        };
      });
    }

    function extractCategoryFromNotes(notes) {
      if (!notes) return '';
      const match = notes.match(/\[åˆ†é¡:(.*?)\]/);
      return match ? match[1] : '';
    }

    function extractTopicsFromNotes(notes) {
      if (!notes) return [];
      const matches = notes.match(/\[ä¸»é¡Œ:(.*?)\]/g);
      if (!matches) return [];
      
      // æå–æ‰€æœ‰ä¸»é¡Œæ¨™è¨˜çš„å…§å®¹
      const topics = matches.map(m => m.replace(/\[ä¸»é¡Œ:(.*?)\]/, '$1'));
      
      // å¦‚æœä¸»é¡ŒåŒ…å«é€—è™Ÿåˆ†éš”çš„å¤šå€‹ä¸»é¡Œï¼Œå‰‡åˆ†å‰²å®ƒå€‘
      const allTopics = [];
      topics.forEach(topic => {
        if (topic.includes(',')) {
          // åˆ†å‰²é€—è™Ÿåˆ†éš”çš„ä¸»é¡Œ
          const splitTopics = topic.split(',').map(t => t.trim()).filter(t => t);
          allTopics.push(...splitTopics);
        } else {
          allTopics.push(topic.trim());
        }
      });
      
      return allTopics;
    }

    function displayBatchEditDialog(programs) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'block';
      modal.id = 'batchEditModal';

      // æŒ‰æ—¥æœŸåˆ†çµ„
      const programsByDate = {};
      programs.forEach(program => {
        if (!programsByDate[program.airDate]) {
          programsByDate[program.airDate] = [];
        }
        programsByDate[program.airDate].push(program);
      });

      const dates = Object.keys(programsByDate).sort();

      modal.innerHTML = `
        <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
          <div class="modal-header">
            <h3>ğŸ“ æ‰¹æ¬¡ä¿®æ”¹ç¯€ç›®</h3>
            <button class="modal-close" onclick="closeBatchEditDialog()">&times;</button>
          </div>
          <div style="padding: 20px;">
            <div style="margin-bottom: 20px;">
              <label style="font-weight: 600; display: block; margin-bottom: 10px;">
                é¸æ“‡æ—¥æœŸï¼š
              </label>
              <select id="batchEditDateSelect" onchange="updateBatchEditProgramList()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                <option value="">-- é¸æ“‡æ—¥æœŸ --</option>
                ${dates.map(date => {
                  const dateObj = new Date(date);
                  const displayDate = `${dateObj.getFullYear()}å¹´${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥`;
                  const count = programsByDate[date].length;
                  return `<option value="${date}">${displayDate} (${count} å€‹ç¯€ç›®)</option>`;
                }).join('')}
              </select>
            </div>

            <div id="batchEditProgramList" style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 15px; display: none;">
              <!-- ç¯€ç›®åˆ—è¡¨å°‡åœ¨é€™è£¡é¡¯ç¤º -->
            </div>

            <div id="batchEditActions" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
              <h4 style="margin-bottom: 15px;">æ‰¹æ¬¡ä¿®æ”¹é¸é …ï¼š</h4>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <label>
                    <input type="checkbox" id="batchEditCategory" onchange="toggleBatchEditField('category')">
                    ä¿®æ”¹ç¯€ç›®åˆ†é¡
                  </label>
                  <select id="batchEditCategoryValue" disabled style="width: 100%; padding: 6px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">è«‹é¸æ“‡åˆ†é¡</option>
                    <option value="äºæ´²">äºæ´²</option>
                    <option value="æ­æ´²">æ­æ´²</option>
                    <option value="åŒ—ç¾æ´²">åŒ—ç¾æ´²</option>
                    <option value="å—ç¾æ´²">å—ç¾æ´²</option>
                    <option value="éæ´²">éæ´²</option>
                    <option value="å¤§æ´‹æ´²">å¤§æ´‹æ´²</option>
                    <option value="å—æ¥µæ´²">å—æ¥µæ´²</option>
                  </select>
                </div>

                <div>
                  <label>
                    <input type="checkbox" id="batchEditTopics" onchange="toggleBatchEditField('topics')">
                    ä¿®æ”¹ä¸»é¡Œåˆ†é¡
                  </label>
                  <div id="batchEditTopicsValue" style="margin-top: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa; opacity: 0.5; pointer-events: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                      ${TOPICS_DATA.map(topic => `
                        <label style="font-size: 0.9rem;">
                          <input type="checkbox" name="batchTopics" value="${topic.id}">
                          ${topic.title}
                        </label>
                      `).join('')}
                    </div>
                  </div>
                </div>
              </div>

              <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="closeBatchEditDialog()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                  å–æ¶ˆ
                </button>
                <button onclick="executeBatchEdit()" style="background: #ffc107; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 600;">
                  ç¢ºèªä¿®æ”¹
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // å„²å­˜ç¨‹å¼è³‡æ–™ä¾›å¾ŒçºŒä½¿ç”¨
      window.batchEditPrograms = programsByDate;

      // é»æ“ŠèƒŒæ™¯é—œé–‰
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeBatchEditDialog();
        }
      });
    }

    function updateBatchEditProgramList() {
      const dateSelect = document.getElementById('batchEditDateSelect');
      const selectedDate = dateSelect.value;
      const programList = document.getElementById('batchEditProgramList');
      const batchEditActions = document.getElementById('batchEditActions');

      if (!selectedDate) {
        programList.style.display = 'none';
        batchEditActions.style.display = 'none';
        return;
      }

      const programs = window.batchEditPrograms[selectedDate] || [];
      
      programList.style.display = 'block';
      batchEditActions.style.display = 'block';

      programList.innerHTML = `
        <div style="margin-bottom: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
          <label style="font-weight: 600;">
            <input type="checkbox" id="selectAllPrograms" onchange="toggleSelectAllPrograms()" checked>
            å…¨é¸ (${programs.length} å€‹ç¯€ç›®)
          </label>
        </div>
        ${programs.map((program, index) => `
          <div style="border: 1px solid #eee; border-radius: 8px; padding: 12px; margin-bottom: 10px; background: white;">
            <label style="display: flex; align-items: flex-start; cursor: pointer;">
              <input type="checkbox" class="program-checkbox" data-program-id="${program.id}" checked style="margin-right: 10px; margin-top: 4px;">
              <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 5px;">
                  <span style="color: #2b71d2; margin-right: 10px;">${program.airTime}</span>
                  ${program.title}
                </div>
                <div style="color: #666; font-size: 0.9rem;">
                  <span>${program.category || 'æœªåˆ†é¡'}</span> â€¢ 
                  <span>${program.duration}åˆ†é˜</span> â€¢ 
                  <span style="color: ${program.status === 'é¦–æ’­' ? '#ffc107' : '#28a745'};">${program.status}</span>
                </div>
                ${program.topics && program.topics.length > 0 ? `
                  <div style="margin-top: 5px;">
                    ${program.topics.map(topic => `<span style="background: #e3f2fd; color: #2b71d2; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-right: 5px;">${topic}</span>`).join('')}
                  </div>
                ` : ''}
              </div>
            </label>
          </div>
        `).join('')}
      `;
    }

    function toggleSelectAllPrograms() {
      const selectAll = document.getElementById('selectAllPrograms');
      const checkboxes = document.querySelectorAll('.program-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
      });
    }

    function toggleBatchEditField(fieldName) {
      const checkbox = document.getElementById(`batchEdit${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)}`);
      const valueField = document.getElementById(`batchEdit${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)}Value`);
      
      if (checkbox.checked) {
        valueField.disabled = false;
        if (fieldName === 'topics') {
          valueField.style.opacity = '1';
          valueField.style.pointerEvents = 'auto';
        }
      } else {
        valueField.disabled = true;
        if (fieldName === 'topics') {
          valueField.style.opacity = '0.5';
          valueField.style.pointerEvents = 'none';
        }
      }
    }

    async function executeBatchEdit() {
      // ç²å–é¸ä¸­çš„ç¯€ç›®
      const selectedPrograms = [];
      document.querySelectorAll('.program-checkbox:checked').forEach(checkbox => {
        selectedPrograms.push(checkbox.dataset.programId);
      });

      if (selectedPrograms.length === 0) {
        alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ç¯€ç›®');
        return;
      }

      // ç²å–è¦ä¿®æ”¹çš„æ¬„ä½
      const updates = {};
      
      if (document.getElementById('batchEditCategory').checked) {
        updates.category = document.getElementById('batchEditCategoryValue').value;
        if (!updates.category) {
          alert('è«‹é¸æ“‡ç¯€ç›®åˆ†é¡');
          return;
        }
      }

      if (document.getElementById('batchEditTopics').checked) {
        const selectedTopics = [];
        document.querySelectorAll('input[name="batchTopics"]:checked').forEach(checkbox => {
          const topicId = checkbox.value;
          const topic = TOPICS_DATA.find(t => t.id === topicId);
          if (topic) {
            selectedTopics.push(topic.title);
          }
        });
        if (selectedTopics.length > 0) {
          updates.topics = selectedTopics;
        }
      }

      if (Object.keys(updates).length === 0) {
        alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è¦ä¿®æ”¹çš„æ¬„ä½');
        return;
      }

      // ç¢ºèªä¿®æ”¹
      const confirmMessage = `
ç¢ºèªè¦æ‰¹æ¬¡ä¿®æ”¹ ${selectedPrograms.length} å€‹ç¯€ç›®å—ï¼Ÿ

ä¿®æ”¹å…§å®¹ï¼š
${updates.category ? `â€¢ ç¯€ç›®åˆ†é¡ï¼š${updates.category}\n` : ''}
${updates.topics ? `â€¢ ä¸»é¡Œåˆ†é¡ï¼š${updates.topics.join('ã€')}\n` : ''}
      `.trim();

      if (!confirm(confirmMessage)) {
        return;
      }

      // åŸ·è¡Œæ‰¹æ¬¡ä¿®æ”¹
      await performBatchEdit(selectedPrograms, updates);
    }

    async function performBatchEdit(programIds, updates) {
      // é¡¯ç¤ºé€²åº¦å°è©±æ¡†
      const progressDialog = createBatchProgressDialog();
      document.body.appendChild(progressDialog);
      
      let successCount = 0;
      let failCount = 0;
      const total = programIds.length;

      try {
        // è¼‰å…¥ Management SDK
        if (typeof contentfulManagement === 'undefined' && typeof window.contentfulManagement === 'undefined') {
          throw new Error('Management SDK æœªè¼‰å…¥');
        }

        const managementClient = (window.contentfulManagement || contentfulManagement).createClient({
          accessToken: 'CFPAT-7c8b9a2d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6'
        });

        const space = await managementClient.getSpace('os5wf90ljenp');
        const environment = await space.getEnvironment('master');

        // é€å€‹ä¿®æ”¹ç¯€ç›®
        for (let i = 0; i < programIds.length; i++) {
          const programId = programIds[i];
          updateBatchProgress(i + 1, total, `æ­£åœ¨ä¿®æ”¹ç¯€ç›® ${i + 1}/${total}...`);

          try {
            // ç²å– Entry
            const entry = await environment.getEntry(programId);
            
            // æ›´æ–°æ¬„ä½
            let notes = entry.fields.notes?.['zh-Hant'] || '';
            
            // ç§»é™¤èˆŠçš„æ¨™è¨˜
            notes = notes.replace(/\[åˆ†é¡:.*?\]/g, '');
            notes = notes.replace(/\[ä¸»é¡Œ:.*?\]/g, '');
            
            // æ·»åŠ æ–°çš„æ¨™è¨˜
            if (updates.category) {
              notes = `[åˆ†é¡:${updates.category}] ${notes}`;
            }
            if (updates.topics) {
              updates.topics.forEach(topic => {
                notes = `[ä¸»é¡Œ:${topic}] ${notes}`;
              });
            }
            
            entry.fields.notes = { 'zh-Hant': notes.trim() };

            // æ›´æ–°ä¸¦é‡æ–°ç™¼å¸ƒ
            const updatedEntry = await entry.update();
            if (updatedEntry.isPublished()) {
              await updatedEntry.publish();
            }
            
            successCount++;
            console.log(`âœ… æˆåŠŸä¿®æ”¹ç¯€ç›® ${i + 1}/${total}`);

          } catch (error) {
            failCount++;
            console.error(`âŒ ä¿®æ”¹ç¯€ç›®å¤±æ•— ${i + 1}/${total}:`, error);
          }

          // å»¶é²ä»¥é¿å… API é€Ÿç‡é™åˆ¶
          if (i < programIds.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        }

        // é¡¯ç¤ºå®Œæˆè¨Šæ¯
        updateBatchProgressComplete(successCount, failCount, total);
        
        // 3ç§’å¾Œé—œé–‰é€²åº¦å°è©±æ¡†
        setTimeout(() => {
          document.body.removeChild(progressDialog);
          closeBatchEditDialog();
          
          // é‡æ–°è¼‰å…¥ç¯€ç›®
          loadEvents();
          renderCurrentView();
          
          alert(`æ‰¹æ¬¡ä¿®æ”¹å®Œæˆï¼\næˆåŠŸï¼š${successCount} å€‹\nå¤±æ•—ï¼š${failCount} å€‹`);
        }, 3000);

      } catch (error) {
        console.error('æ‰¹æ¬¡ä¿®æ”¹å¤±æ•—:', error);
        document.body.removeChild(progressDialog);
        alert('æ‰¹æ¬¡ä¿®æ”¹å¤±æ•—ï¼š' + error.message);
      }
    }

    function closeBatchEditDialog() {
      const modal = document.getElementById('batchEditModal');
      if (modal) {
        document.body.removeChild(modal);
      }
      delete window.batchEditPrograms;
    }

    // æ‰¹æ¬¡é€²åº¦ç›¸é—œå‡½æ•¸
    function createBatchProgressDialog() {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'block';
      modal.id = 'batchProgressModal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px; text-align: center;">
          <div class="modal-header">
            <h3>ğŸ”„ æ‰¹æ¬¡ä¿®æ”¹é€²è¡Œä¸­...</h3>
          </div>
          <div style="padding: 30px;">
            <div id="batchProgressBar" style="width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin-bottom: 15px;">
              <div id="batchProgressFill" style="width: 0%; height: 100%; background: linear-gradient(90deg, #ffc107, #17a2b8); transition: width 0.3s ease;"></div>
            </div>
            <div id="batchProgressText" style="font-size: 1.1rem; color: #333; margin-bottom: 10px;">
              æº–å‚™ä¸­...
            </div>
            <div id="batchProgressCount" style="font-size: 0.9rem; color: #666;">
              0 / 0
            </div>
          </div>
        </div>
      `;
      return modal;
    }

    function updateBatchProgress(current, total, message) {
      const progressFill = document.getElementById('batchProgressFill');
      const progressText = document.getElementById('batchProgressText');
      const progressCount = document.getElementById('batchProgressCount');
      
      if (progressFill) {
        const percentage = (current / total) * 100;
        progressFill.style.width = percentage + '%';
      }
      
      if (progressText) {
        progressText.textContent = message;
      }
      
      if (progressCount) {
        progressCount.textContent = `${current} / ${total}`;
      }
    }

    function updateBatchProgressComplete(successCount, failCount, total) {
      const progressText = document.getElementById('batchProgressText');
      const progressCount = document.getElementById('batchProgressCount');
      
      if (progressText) {
        progressText.textContent = 'âœ… æ‰¹æ¬¡ä¿®æ”¹å®Œæˆï¼';
        progressText.style.color = '#28a745';
      }
      
      if (progressCount) {
        progressCount.innerHTML = `
          <div style="color: #28a745; font-weight: 600;">æˆåŠŸï¼š${successCount} å€‹</div>
          <div style="color: #dc3545; font-weight: 600;">å¤±æ•—ï¼š${failCount} å€‹</div>
          <div style="color: #666;">ç¸½è¨ˆï¼š${total} å€‹</div>
        `;
      }
    }

  </script>
</body>
</html>
