<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>統一節目管理系統</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }

    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

    .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .header h1 { color: #2b71d2; margin-bottom: 10px; }

    .view-controls { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }

    .view-buttons { display: flex; gap: 10px; }
    .view-btn { background: #f8f9fa; color: #495057; border: 2px solid #e9ecef; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
    .view-btn.active { background: #2b71d2; color: white; border-color: #2b71d2; }
    .view-btn:hover { background: #e3f2fd; border-color: #2b71d2; }
    .view-btn.active:hover { background: #1e5bb8; }

    .nav-controls { display: flex; align-items: center; gap: 15px; }
    .nav-btn { background: #2b71d2; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    .nav-btn:hover { background: #1e5bb8; }
    .current-date { font-size: 1.2rem; font-weight: 600; color: #333; min-width: 200px; text-align: center; }
    .today-btn { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    .today-btn:hover { background: #218838; }

    .view { display: none; }
    .view.active { display: block; }

    .calendar-grid { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); background: #2b71d2; color: white; }
    .calendar-header div { padding: 15px; text-align: center; font-weight: 600; }
    .calendar-body { display: grid; grid-template-columns: repeat(7, 1fr); }
    .calendar-day { min-height: 120px; border: 1px solid #eee; padding: 8px; position: relative; background: white; cursor: pointer; }
    .calendar-day:hover { background: #f8f9fa; }
    .calendar-day.other-month { background: #f8f9fa; color: #999; }
    .calendar-day.today { background: #e3f2fd; border-color: #2b71d2; }

    .day-number { font-weight: 600; margin-bottom: 8px; color: #333; font-size: 0.9rem; }
    .day-events { position: relative; }

    /* Google 日曆風格的節目顯示 */
    .event {
      background: #e8f5e8;
      border: 1px solid #4caf50;
      border-radius: 3px;
      padding: 2px 6px;
      font-size: 0.65rem;
      margin-bottom: 1px;
      cursor: pointer;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      line-height: 1.2;
      max-width: 100%;
      position: relative;
    }
    .event:hover { background: #c8e6c9; }
    .event.prime-time { background: #ffe8e8; border-color: #ff6b6b; }
    .event.first-air { background: #fff3cd; border-color: #ffc107; }

    /* 更多節目指示器 */
    .more-events-indicator {
      background: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 3px;
      padding: 2px 6px;
      font-size: 0.6rem;
      color: #666;
      cursor: pointer;
      text-align: center;
      margin-top: 2px;
      font-style: italic;
    }
    .more-events-indicator:hover {
      background: #e0e0e0;
    }

    /* 節目工具提示 */
    .event-tooltip {
      position: absolute;
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      max-width: 250px;
      word-wrap: break-word;
      white-space: normal;
      top: 100%;
      left: 0;
      margin-top: 5px;
    }

    .event:hover .event-tooltip {
      opacity: 1;
    }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }

    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
    .form-group textarea { height: 80px; resize: vertical; }

    .btn { background: #2b71d2; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; margin-right: 10px; }
    .btn:hover { background: #1e5bb8; }
    .btn-secondary { background: #6c757d; }
    .btn-secondary:hover { background: #5a6268; }
    .btn-danger { background: #dc3545; }
    .btn-danger:hover { background: #c82333; }

    .status-bar { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1001; display: none; }

    /* 全螢幕播放器樣式 */
    .fullscreen-player {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    
    .fullscreen-player.active {
      display: flex;
    }
    
    .close-player-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      font-size: 30px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s ease;
    }
    
    .close-player-btn:hover {
      background: rgba(0, 0, 0, 0.9);
    }
    
    #main-player {
      width: 100%;
      height: 100%;
    }

    /* 週視圖和日視圖樣式 */
    .week-row, .day-row { transition: background-color 0.2s ease; }
    .week-row:hover, .day-row:hover { background-color: #f8f9fa; }
    .time-cell { user-select: none; }
    .day-cell, .event-cell { transition: background-color 0.2s ease; }
    .day-cell:hover, .event-cell:hover { background-color: #e3f2fd !important; }

    /* 週視圖特殊樣式 */
    #weekView .calendar-header {
      grid-template-columns: 80px repeat(7, 1fr);
      background: #2b71d2;
      color: white;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    #weekView .calendar-body {
      display: block;
      background: white;
      max-height: 70vh;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #ccc transparent;
    }

    /* 自定義滾動條 */
    #weekView .calendar-body::-webkit-scrollbar {
      width: 8px;
    }

    #weekView .calendar-body::-webkit-scrollbar-track {
      background: transparent;
    }

    #weekView .calendar-body::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 4px;
    }

    #weekView .calendar-body::-webkit-scrollbar-thumb:hover {
      background: #999;
    }

    /* 週視圖行樣式 */
    .week-row {
      display: grid !important;
      grid-template-columns: 80px repeat(7, 1fr) !important;
      border-bottom: 1px solid #eee;
      background: white;
      min-height: 30px;
    }

    /* 週視圖時間列樣式 */
    #weekView .time-cell {
      min-width: 80px;
      max-width: 80px;
      width: 80px;
      box-sizing: border-box;
      font-size: 0.75rem;
      padding: 4px 6px;
    }

    /* 週視圖日期單元格樣式 */
    #weekView .day-cell {
      min-height: 30px;
      max-height: 60px;
      overflow: hidden;
      position: relative;
      padding: 2px;
    }

    /* 週視圖節目樣式 */
    #weekView .event {
      font-size: 0.7rem;
      padding: 2px 4px;
      margin: 1px 0;
      border-radius: 3px;
      cursor: pointer;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
      position: relative;
      transition: all 0.2s ease;
    }

    /* 週視圖節目懸停效果 */
    #weekView .event:hover {
      transform: scale(1.02);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 10;
    }

    /* 週視圖節目工具提示 */
    #weekView .event-tooltip {
      position: absolute;
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      white-space: nowrap;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      max-width: 300px;
      word-wrap: break-word;
      white-space: normal;
    }

    #weekView .event:hover .event-tooltip {
      opacity: 1;
    }

    /* 日視圖特殊樣式 */
    #dayView .calendar-header {
      grid-template-columns: 80px 1fr;
      background: #2b71d2;
      color: white;
    }
    #dayView .calendar-body {
      display: block;
      background: white;
      max-height: 70vh;
      overflow-y: auto;
      padding: 0;
    }

    /* 日視圖行樣式 */
    .day-row {
      display: grid !important;
      grid-template-columns: 80px 1fr !important;
      border-bottom: 1px solid #eee;
      background: white;
      min-height: 60px;
      width: 100%;
    }

    /* 確保日視圖容器有足夠高度 */
    #dayView .calendar-grid {
      height: auto;
      min-height: 70vh;
      width: 100%;
    }

    /* 日視圖時間列樣式 */
    #dayView .time-cell {
      min-width: 80px;
      max-width: 80px;
      width: 80px;
      box-sizing: border-box;
    }

    /* 日視圖節目列樣式 */
    #dayView .event-cell {
      width: 100%;
      box-sizing: border-box;
      overflow: hidden;
    }

    /* 過去日期樣式 */
    .calendar-day.past-date {
      background-color: #f8f9fa !important;
      color: #999 !important;
    }

    .calendar-day.past-date .day-number {
      color: #999 !important;
    }

    .calendar-day.past-date .event {
      opacity: 0.6;
    }

    /* 月曆視圖的節目計數指示器 */
    .event-count-badge {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #2b71d2;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 600;
      z-index: 5;
    }

    /* 節目時間標籤 */
    .event-time-label {
      font-weight: 600;
      color: #333;
      font-size: 0.6rem;
      margin-right: 3px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>📅 統一節目管理系統</h1>
      <p>整合月曆、週曆、日曆三種視圖，統一管理所有節目安排</p>
    </div>

    <div class="view-controls">
      <div class="view-buttons">
        <button class="view-btn active" onclick="switchView('month')">📅 月曆視圖</button>
        <button class="view-btn" onclick="switchView('week')">📊 週曆視圖</button>
        <button class="view-btn" onclick="switchView('day')">📋 日曆視圖</button>
      </div>

      <div class="nav-controls">
        <button class="nav-btn" onclick="previousPeriod()">◀</button>
        <div class="current-date" id="currentDate">2024年8月</div>
        <button class="nav-btn" onclick="nextPeriod()">▶</button>
        <button class="today-btn" onclick="goToToday()">今天</button>
        <button class="btn" style="background: #ffc107; margin-left: 10px;" onclick="clearOldTestData()">🧹 清理測試資料</button>
        <button class="btn" style="background: #6c757d; margin-left: 10px;" onclick="checkContentfulContentTypes()">🔍 檢查內容類型</button>
        <button class="btn" style="background: #28a745; margin-left: 10px;" onclick="syncAllToContentful()">🔄 同步到 Contentful</button>
        <button class="btn" style="background: #dc3545; margin-left: 10px;" onclick="uploadSelectedPrograms()">📺 上架選中節目</button>
        <button class="btn" style="background: #17a2b8; margin-left: 10px;" onclick="reloadFromContentful()">📥 從 Contentful 重新載入</button>
        <button class="btn" style="background: #6f42c1; margin-left: 10px;" onclick="goToDashboard()">🏠 主控台</button>
        <button class="btn" style="background: #fd7e14; margin-left: 10px;" onclick="cleanupPastPrograms()">🧹 清理過去節目</button>
        <button class="btn" style="background: #28a745; margin-left: 10px;" onclick="testPlayback()">▶️ 測試播放</button>
      </div>
    </div>

    <div class="view active" id="monthView">
      <div class="calendar-grid">
        <div class="calendar-header">
          <div>星期日</div><div>星期一</div><div>星期二</div><div>星期三</div>
          <div>星期四</div><div>星期五</div><div>星期六</div>
        </div>
        <div class="calendar-body" id="monthCalendarBody"></div>
      </div>
    </div>

    <div class="view" id="weekView">
      <div class="calendar-grid">
        <div class="calendar-header" id="weekHeader">
          <div>時間</div><div>星期日</div><div>星期一</div><div>星期二</div>
          <div>星期三</div><div>星期四</div><div>星期五</div><div>星期六</div>
        </div>
        <div class="calendar-body" id="weekCalendarBody"></div>
      </div>
    </div>

    <div class="view" id="dayView">
      <div class="calendar-grid">
        <div class="calendar-header" id="dayHeader">
          <div>時間</div><div>節目安排</div>
        </div>
        <div class="calendar-body" id="dayCalendarBody"></div>
      </div>
    </div>
  </div>

  <!-- 時間槽選擇器模態框 -->
  <div class="modal" id="timeSlotModal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h3>選擇播出時間</h3>
        <button class="modal-close" onclick="closeTimeSlotModal()">&times;</button>
      </div>
      <div class="time-slot-grid" id="timeSlotGrid" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px; padding: 20px;">
        <!-- 時間槽將在這裡動態生成 -->
      </div>
    </div>
  </div>

  <!-- 全螢幕播放器 -->
  <div class="fullscreen-player" id="fullscreenPlayer">
    <button class="close-player-btn" title="關閉播放器">&times;</button>
    <div id="main-player"></div>
  </div>

  <div class="modal" id="eventModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">編輯節目</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>

      <form id="eventForm">
        <input type="hidden" id="editDate">
        <input type="hidden" id="editTime">

        <div class="form-group">
          <label>播出時間：</label>
          <input type="time" id="airTime" required>
        </div>

        <div class="form-group">
          <label>影片類型：</label>
          <select id="videoType" required onchange="toggleVideoFields()">
            <option value="">-- 選擇影片類型 --</option>
            <option value="YouTube">YouTube</option>
            <option value="MP4">MP4 檔案</option>
          </select>
        </div>

        <div class="form-group" id="youtubeIdGroup" style="display: none;">
          <label>YouTube ID：</label>
          <input type="text" id="youtubeId" placeholder="例如：dQw4w9WgXcQ" onblur="fetchYouTubeInfo()">
          <button type="button" class="btn btn-info" onclick="generateYouTubeThumbnail()" style="margin-top: 5px;">
            🖼️ 自動生成 YouTube 縮圖
          </button>
        </div>

        <div class="form-group" id="mp4FileGroup" style="display: none;">
          <label>MP4 檔案：</label>
          <input type="file" id="mp4File" accept=".mp4" onchange="handleFileUpload()">
        </div>
        
        <div class="form-group">
          <label>節目縮圖：</label>
          <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
            <input type="file" id="thumbnailFile" accept="image/*" style="flex: 1;" onchange="previewThumbnail()">
            <button type="button" class="btn btn-secondary" onclick="clearThumbnail()">清除</button>
          </div>
          <div id="thumbnailPreview" style="margin-top: 10px; text-align: center;">
            <img id="thumbnailImage" style="max-width: 200px; max-height: 150px; border: 1px solid #ddd; border-radius: 4px; display: none;">
            <div id="thumbnailPlaceholder" style="width: 200px; height: 150px; border: 2px dashed #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #666; margin: 0 auto;">
              預覽縮圖
            </div>
          </div>
          <!-- 隱藏欄位存儲 Contentful Asset ID -->
          <input type="hidden" id="thumbnailAssetId" value="">
        </div>

        <div class="form-group">
          <label>節目標題：</label>
          <input type="text" id="title" placeholder="例如：早安世界 - 日本東京晨間漫步" required>
        </div>

        <div class="form-group">
          <label>節目時長：</label>
          <select id="duration" required>
            <option value="30" selected>30分鐘</option>
            <option value="60">60分鐘</option>
            <option value="90">90分鐘</option>
          </select>
        </div>

        <div class="form-group">
          <label>節目分類：</label>
          <select id="category" required>
            <option value="">-- 選擇分類 --</option>
            <option value="亞洲旅遊">亞洲旅遊</option>
            <option value="歐洲旅遊">歐洲旅遊</option>
            <option value="美洲旅遊">美洲旅遊</option>
            <option value="美食旅遊">美食旅遊</option>
            <option value="極地旅遊">極地旅遊</option>
            <option value="自然旅遊">自然旅遊</option>
            <option value="文化旅遊">文化旅遊</option>
            <option value="冒險旅遊">冒險旅遊</option>
          </select>
        </div>

        <div class="form-group">
          <label>節目描述：</label>
          <textarea id="description" placeholder="簡短描述節目內容..."></textarea>
        </div>

        <div class="form-group">
          <label>節目狀態：</label>
          <select id="status" required>
            <option value="重播">重播</option>
            <option value="首播">首播</option>
            <option value="特別節目">特別節目</option>
          </select>
        </div>

        <button type="submit" class="btn">💾 儲存節目</button>
        <button type="button" class="btn btn-danger" onclick="deleteEvent()">🗑️ 刪除節目</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">❌ 取消</button>
        <button type="button" class="btn" style="background: #28a745;" onclick="publishToContentful()">🚀 上架節目</button>
      </form>
    </div>
  </div>

  <div class="status-bar" id="statusBar">
    <span id="statusMessage"></span>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/contentful@latest/dist/contentful.browser.min.js"></script>
  <script src="browser-config.js"></script>
  <script>
    // 強力載入 Management SDK
    function loadManagementSDK() {
      return new Promise((resolve, reject) => {
        // 檢查是否已經載入
        if (typeof contentfulManagement !== 'undefined') {
          console.log('✅ Management SDK 已載入');
          window.contentfulManagement = contentfulManagement;
          resolve();
          return;
        }

        // 嘗試多個 CDN 源（使用固定版本號以提高穩定性）
        const cdnSources = [
          'https://cdn.jsdelivr.net/npm/contentful-management@10.0.0/dist/contentful-management.browser.min.js',
          'https://unpkg.com/contentful-management@10.0.0/dist/contentful-management.browser.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/contentful-management/10.0.0/contentful-management.browser.min.js',
          'https://cdn.jsdelivr.net/npm/contentful-management@9.0.0/dist/contentful-management.browser.min.js',
          'https://unpkg.com/contentful-management@9.0.0/dist/contentful-management.browser.min.js'
        ];

        let currentIndex = 0;

        function tryNextCDN() {
          if (currentIndex >= cdnSources.length) {
            reject(new Error('所有 CDN 源都載入失敗'));
            return;
          }

          const script = document.createElement('script');
          script.src = cdnSources[currentIndex];
          
          script.onload = function() {
            // 等待一下讓腳本執行
            setTimeout(() => {
              if (typeof contentfulManagement !== 'undefined') {
                console.log(`✅ Management SDK 從 CDN ${currentIndex + 1} 載入成功`);
                window.contentfulManagement = contentfulManagement;
                resolve();
              } else {
                console.log(`❌ CDN ${currentIndex + 1} 載入失敗，嘗試下一個...`);
                currentIndex++;
                tryNextCDN();
              }
            }, 100);
          };

          script.onerror = function() {
            console.log(`❌ CDN ${currentIndex + 1} 載入失敗，嘗試下一個...`);
            currentIndex++;
            tryNextCDN();
          };

          document.head.appendChild(script);
        }

        tryNextCDN();
      });
    }

    // 確保 Contentful SDK 載入完成
    if (typeof contentful !== 'undefined') {
      console.log('✅ Contentful SDK 已載入');
    } else {
      console.error('❌ Contentful SDK 載入失敗');
    }
    
    // 載入 Management SDK
    loadManagementSDK()
      .then(() => {
        console.log('✅ Management SDK 載入完成');
      })
      .catch((error) => {
        console.error('❌ Management SDK 載入失敗:', error);
        console.log('❌ 所有 CDN 源都載入失敗，請檢查網路連線');
      });
  </script>
  <script src="contentful-real-only.js"></script>
  <script>
    // 監聽 Management SDK 載入事件
    window.addEventListener('contentfulManagementLoaded', function() {
      console.log('✅ Management SDK 載入完成事件觸發');
    });
    
    window.addEventListener('contentfulManagementFailed', function() {
      console.error('❌ Management SDK 載入失敗事件觸發');
    });
    
    // 確保 ContentfulRealOnly 系統載入完成
    setTimeout(() => {
      if (window.contentfulRealOnly) {
        console.log('✅ ContentfulRealOnly 系統已載入');
      } else {
        console.error('❌ ContentfulRealOnly 系統載入失敗');
      }
    }, 1000);
  </script>
  <script>
    let currentDate = new Date();
    let currentView = 'month';
    let events = {};

    document.addEventListener('DOMContentLoaded', function() {
      loadEvents();
      renderCurrentView();
      updateCurrentDateDisplay();
      
      // 自動清理過去節目
      cleanupPastPrograms();
    });

    function switchView(view) {
      currentView = view;

      document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(view + 'View').classList.add('active');

      renderCurrentView();
    }

    function renderCurrentView() {
      switch(currentView) {
        case 'month': renderMonthView(); break;
        case 'week': renderWeekView(); break;
        case 'day': renderDayView(); break;
      }
    }

    function renderMonthView() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - firstDay.getDay());

      const today = new Date();
      const todayStart = new Date(today);
      todayStart.setHours(0, 0, 0, 0);

      const calendarBody = document.getElementById('monthCalendarBody');
      calendarBody.innerHTML = '';

      for (let week = 0; week < 6; week++) {
        for (let day = 0; day < 7; day++) {
          const currentDay = new Date(startDate);
          currentDay.setDate(startDate.getDate() + week * 7 + day);

          const isCurrentMonth = currentDay.getMonth() === month;
          const isToday = currentDay.toDateString() === today.toDateString();
          const isPastDate = currentDay < todayStart;
          const dateString = currentDay.getFullYear() + '-' +
                           String(currentDay.getMonth() + 1).padStart(2, '0') + '-' +
                           String(currentDay.getDate()).padStart(2, '0');

          const dayElement = document.createElement('div');
          dayElement.className = `calendar-day ${!isCurrentMonth ? 'other-month' : ''} ${isToday ? 'today' : ''} ${isPastDate ? 'past-date' : ''}`;
          dayElement.setAttribute('data-date', dateString);

          const dayEvents = getDayEvents(dateString);
          const eventCount = dayEvents.length;

          dayElement.innerHTML = `
            <div class="day-number">${currentDay.getDate()}</div>
            ${eventCount > 0 ? `<div class="event-count-badge">${eventCount}</div>` : ''}
            <div class="day-events" id="events-${dateString}">
              ${getDayEventsHTML(dateString)}
            </div>
          `;

          if (!isPastDate) {
            dayElement.style.cursor = 'pointer';
            dayElement.addEventListener('click', function() {
              openTimeSlotSelector(dateString);
            });
          } else {
            dayElement.style.cursor = 'not-allowed';
            dayElement.style.opacity = '0.6';
          }

          calendarBody.appendChild(dayElement);
        }
      }
    }

    function renderWeekView() {
      const today = new Date();
      const currentHour = today.getHours();
      const currentMinute = today.getMinutes();
      const currentTimeSlot = `${currentHour.toString().padStart(2, '0')}:${Math.floor(currentMinute / 30) * 30 === 0 ? '00' : '30'}`;

      const weekStart = new Date(currentDate);
      weekStart.setDate(currentDate.getDate() - currentDate.getDay());

      const weekHeader = document.getElementById('weekHeader');
      const dayNames = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
      weekHeader.innerHTML = '';

      const timeHeader = document.createElement('div');
      timeHeader.textContent = '時間';
      timeHeader.style.display = 'flex';
      timeHeader.style.alignItems = 'center';
      timeHeader.style.justifyContent = 'center';
      weekHeader.appendChild(timeHeader);

      for (let i = 0; i < 7; i++) {
        const currentDay = new Date(weekStart);
        currentDay.setDate(weekStart.getDate() + i);
        const isToday = currentDay.toDateString() === today.toDateString();

        const headerCell = document.createElement('div');
        headerCell.innerHTML = `
          <div style="font-weight: 600; margin-bottom: 2px;">${dayNames[i]}</div>
          <div style="font-size: 0.9rem; opacity: 0.9; ${isToday ? 'color: #ffc107; font-weight: 600;' : ''}">
            ${currentDay.getMonth() + 1}/${currentDay.getDate()}
          </div>
        `;
        weekHeader.appendChild(headerCell);
      }

      const calendarBody = document.getElementById('weekCalendarBody');
      calendarBody.innerHTML = '';

      const timeSlots = [];
      for (let hour = 0; hour < 24; hour++) {
        for (let minute = 0; minute < 60; minute += 30) {
          const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
          timeSlots.push(timeString);
        }
      }

      timeSlots.forEach(timeSlot => {
        const row = document.createElement('div');
        row.className = 'week-row';

        const timeCell = document.createElement('div');
        timeCell.className = 'time-cell';
        timeCell.style.cssText = `
          padding: 4px 6px;
          border-right: 1px solid #eee;
          background-color: #f8f9fa;
          font-size: 0.75rem;
          font-weight: 600;
          display: flex;
          align-items: center;
          justify-content: center;
          min-width: 80px;
          max-width: 80px;
          box-sizing: border-box;
        `;
        timeCell.textContent = timeSlot;

        const hour = parseInt(timeSlot.split(':')[0]);
        const minute = parseInt(timeSlot.split(':')[1]);
        const isPastTime = today.toDateString() === currentDate.toDateString() &&
                          (hour < currentHour || (hour === currentHour && minute <= currentMinute));

        if (isPastTime) {
          timeCell.style.color = '#999';
          timeCell.style.backgroundColor = '#f5f5f5';
        }

        if (timeSlot === currentTimeSlot && today.toDateString() === currentDate.toDateString()) {
          timeCell.style.color = '#2b71d2';
          timeCell.style.fontWeight = '700';
          timeCell.style.borderLeft = '3px solid #2b71d2';
        }

        row.appendChild(timeCell);

        for (let day = 0; day < 7; day++) {
          const currentDay = new Date(weekStart);
          currentDay.setDate(weekStart.getDate() + day);
          const dateString = currentDay.getFullYear() + '-' +
                           String(currentDay.getMonth() + 1).padStart(2, '0') + '-' +
                           String(currentDay.getDate()).padStart(2, '0');
          const isToday = currentDay.toDateString() === today.toDateString();

          const dayCell = document.createElement('div');
          dayCell.className = 'day-cell';
          dayCell.style.cssText = `
            padding: 2px;
            border-right: 1px solid #eee;
            min-height: 30px;
            max-height: 60px;
            overflow: hidden;
            position: relative;
            background: white;
          `;

          if (timeSlot === '00:00') {
            const dateLabel = document.createElement('div');
            dateLabel.style.cssText = `
              position: absolute;
              top: 2px;
              left: 2px;
              font-size: 0.7rem;
              font-weight: 600;
              color: ${isToday ? '#ffc107' : '#666'};
              background: ${isToday ? 'rgba(255, 193, 7, 0.1)' : 'rgba(0, 0, 0, 0.05)'};
              padding: 1px 4px;
              border-radius: 3px;
              z-index: 1;
            `;
            dateLabel.textContent = `${currentDay.getMonth() + 1}/${currentDay.getDate()}`;
            dayCell.appendChild(dateLabel);
          }

          const todayStart = new Date(today);
          todayStart.setHours(0, 0, 0, 0);
          const isPastDate = currentDay < todayStart;
          const isPastTimeToday = currentDay.toDateString() === today.toDateString() && isPastTime;
          const isPastTimeOrDate = isPastDate || isPastTimeToday;

          if (isPastTimeOrDate) {
            dayCell.style.backgroundColor = '#f5f5f5';
            dayCell.style.opacity = '0.6';
            dayCell.style.cursor = 'not-allowed';
          } else {
            dayCell.style.cursor = 'pointer';
            dayCell.addEventListener('click', function() {
              openEventModal(dateString, timeSlot);
            });
          }

          const events = getDayEvents(dateString);
          const timeSlotEvents = events.filter(event => event.time === timeSlot);

          timeSlotEvents.forEach(event => {
            const eventDiv = document.createElement('div');
            eventDiv.className = `event ${event.status === '首播' ? 'first-air' : ''} ${isPrimeTime(hour) ? 'prime-time' : ''}`;
            eventDiv.style.cssText = `
              font-size: 0.7rem;
              padding: 2px 4px;
              margin: 1px 0;
              border-radius: 3px;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
              max-width: 100%;
              position: relative;
              transition: all 0.2s ease;
              cursor: pointer;
            `;

            const maxLength = 25;
            const displayTitle = event.title.length > maxLength ?
              event.title.substring(0, maxLength) + '...' : event.title;
            eventDiv.textContent = displayTitle;

            if (event.title.length > maxLength || event.description) {
              const tooltip = document.createElement('div');
              tooltip.className = 'event-tooltip';
              tooltip.style.cssText = `
                position: absolute;
                background: rgba(0,0,0,0.9);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 0.8rem;
                z-index: 1000;
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.3s ease;
                max-width: 300px;
                word-wrap: break-word;
                white-space: normal;
                top: 100%;
                left: 0;
                margin-top: 5px;
              `;

              let tooltipContent = `<strong>${event.title}</strong>`;
              if (event.description) {
                tooltipContent += `<br><small>${event.description}</small>`;
              }
              tooltipContent += `<br><small>${event.time} | ${event.category} | ${event.duration}分鐘</small>`;
              tooltip.innerHTML = tooltipContent;

              eventDiv.appendChild(tooltip);

              eventDiv.addEventListener('mouseenter', function() {
                tooltip.style.opacity = '1';
              });

              eventDiv.addEventListener('mouseleave', function() {
                tooltip.style.opacity = '0';
              });
            }

            eventDiv.addEventListener('click', function(e) {
              e.stopPropagation();
              openEventModal(dateString, timeSlot);
            });

            dayCell.appendChild(eventDiv);
          });

          if (timeSlotEvents.length === 0 && !isPastTimeOrDate) {
            const emptyDiv = document.createElement('div');
            emptyDiv.style.cssText = `
              color: #ccc;
              font-size: 0.6rem;
              font-style: italic;
              text-align: center;
              padding: 2px;
              opacity: 0.7;
            `;
            emptyDiv.textContent = '+';
            dayCell.appendChild(emptyDiv);
          }

          row.appendChild(dayCell);
        }

        calendarBody.appendChild(row);
      });
    }

    function renderDayView() {
      const today = new Date();
      const currentHour = today.getHours();
      const currentMinute = today.getMinutes();
      const dateString = currentDate.getFullYear() + '-' +
                       String(currentDate.getMonth() + 1).padStart(2, '0') + '-' +
                       String(currentDate.getDate()).padStart(2, '0');
      const isToday = currentDate.toDateString() === today.toDateString();

      const dayHeader = document.getElementById('dayHeader');
      const dayNames = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
      const dayOfWeek = currentDate.getDay();

      dayHeader.innerHTML = `
        <div>時間</div>
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
          <div style="font-weight: 600; margin-bottom: 2px;">節目安排</div>
          <div style="font-size: 0.9rem; opacity: 0.9; ${isToday ? 'color: #ffc107; font-weight: 600;' : ''}">
            ${currentDate.getFullYear()}年${currentDate.getMonth() + 1}月${currentDate.getDate()}日 ${dayNames[dayOfWeek]}
          </div>
        </div>
      `;

      const calendarBody = document.getElementById('dayCalendarBody');
      calendarBody.innerHTML = '';

      const timeSlots = [];
      for (let hour = 0; hour < 24; hour++) {
        for (let minute = 0; minute < 60; minute += 30) {
          const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
          timeSlots.push(timeString);
        }
      }

      timeSlots.forEach(timeSlot => {
        const row = document.createElement('div');
        row.className = 'day-row';

        const timeCell = document.createElement('div');
        timeCell.className = 'time-cell';
        timeCell.style.cssText = `
          padding: 12px 8px;
          border-right: 1px solid #eee;
          background-color: #f8f9fa;
          font-size: 0.9rem;
          font-weight: 600;
          display: flex;
          align-items: center;
          justify-content: center;
          min-width: 80px;
        `;
        timeCell.textContent = timeSlot;

        const hour = parseInt(timeSlot.split(':')[0]);
        const minute = parseInt(timeSlot.split(':')[1]);
        const todayStart = new Date(today);
        todayStart.setHours(0, 0, 0, 0);
        const isPastDate = currentDate < todayStart;
        const isPastTime = today.toDateString() === currentDate.toDateString() &&
                          (hour < currentHour || (hour === currentHour && minute <= currentMinute));
        const isPastTimeOrDate = isPastDate || isPastTime;

        if (isPastTimeOrDate) {
          timeCell.style.color = '#999';
          timeCell.style.backgroundColor = '#f5f5f5';
        }

        row.appendChild(timeCell);

        const eventCell = document.createElement('div');
        eventCell.className = 'event-cell';
        eventCell.style.cssText = `
          padding: 8px;
          position: relative;
          min-height: 60px;
          display: flex;
          align-items: center;
        `;

        if (isPastTimeOrDate) {
          eventCell.style.backgroundColor = '#f5f5f5';
          eventCell.style.opacity = '0.6';
          eventCell.style.cursor = 'not-allowed';
        } else {
          eventCell.style.cursor = 'pointer';
          eventCell.addEventListener('click', function() {
            openEventModal(dateString, timeSlot);
          });
        }

        const events = getDayEvents(dateString);
        const timeSlotEvents = events.filter(event => event.time === timeSlot);

        if (timeSlotEvents.length > 0) {
          timeSlotEvents.forEach(event => {
            const eventDiv = document.createElement('div');
            eventDiv.className = `event ${event.status === '首播' ? 'first-air' : ''} ${isPrimeTime(hour) ? 'prime-time' : ''}`;
            eventDiv.style.cssText = `
              padding: 8px;
              margin: 4px 0;
              border-radius: 6px;
              font-size: 0.9rem;
              font-weight: 500;
              background: #e8f5e8;
              border: 1px solid #4caf50;
              width: 100%;
              box-sizing: border-box;
              word-wrap: break-word;
              overflow-wrap: break-word;
            `;

            // 判斷是否為現正播出的節目
            const isCurrentPlaying = isCurrentProgram(event);
            
            eventDiv.innerHTML = `
              <div style="font-weight: 600; margin-bottom: 4px; word-break: break-word;">${event.title}</div>
              <div style="font-size: 0.8rem; color: #666;">
                <span style="background: ${event.status === '首播' ? '#ffc107' : '#28a745'}; color: white; padding: 2px 6px; border-radius: 3px; margin-right: 8px;">
                  ${event.status}
                </span>
                <span>${event.category}</span>
                <span style="margin-left: 8px;">${event.duration}分鐘</span>
              </div>
              ${event.description ? `<div style="color: #666; font-size: 0.8rem; color: #666; margin-top: 4px; word-break: break-word;">${event.description}</div>` : ''}
              ${(event.youtubeId && isCurrentPlaying) ? `<button class="watch-btn" data-video-id="${event.youtubeId}" style="background: #2b71d2; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; margin-top: 6px; cursor: pointer;">立即觀看</button>` : ''}
            `;

            eventCell.appendChild(eventDiv);
          });
        } else {
          const emptyDiv = document.createElement('div');
          emptyDiv.style.cssText = `
            color: #999;
            font-size: 0.8rem;
            font-style: italic;
            width: 100%;
            text-align: center;
          `;
          emptyDiv.textContent = '點擊新增節目';
          eventCell.appendChild(emptyDiv);
        }

        row.appendChild(eventCell);
        calendarBody.appendChild(row);
      });
    }

    function getDayEvents(dateString) {
      const dayEvents = events[dateString] || [];
      return dayEvents;
    }

    function getDayEventsHTML(dateString) {
      const dayEvents = events[dateString] || [];
      if (dayEvents.length === 0) {
        return '';
      }

      const maxVisibleEvents = 3;
      const visibleEvents = dayEvents.slice(0, maxVisibleEvents);
      const hiddenEventsCount = dayEvents.length - maxVisibleEvents;

      let html = '';

      visibleEvents.forEach(event => {
        const maxTitleLength = 20;
        const displayTitle = event.title.length > maxTitleLength ?
          event.title.substring(0, maxTitleLength) + '...' : event.title;

        // 判斷是否為現正播出的節目
        const isCurrentPlaying = isCurrentProgram(event);
        
        html += `
          <div class="event ${event.status === '首播' ? 'first-air' : ''} ${isPrimeTime(parseInt(event.time.split(':')[0])) ? 'prime-time' : ''}"
               data-date="${dateString}" 
               data-time="${event.time}" 
               data-video-id="${event.youtubeId || ''}" 
               data-is-current="${isCurrentPlaying}">
            <span class="event-time-label">${event.time}</span>${displayTitle}
            ${(event.youtubeId && isCurrentPlaying) ? `<button class="watch-btn-small" data-video-id="${event.youtubeId}" style="background: #2b71d2; color: white; border: none; padding: 2px 4px; border-radius: 3px; font-size: 0.6rem; margin-left: 4px; cursor: pointer;">觀看</button>` : ''}
            ${event.title.length > maxTitleLength || event.description ? `
              <div class="event-tooltip">
                <strong>${event.title}</strong>
                ${event.description ? `<br><small>${event.description}</small>` : ''}
                <br><small>${event.time} | ${event.category} | ${event.duration}分鐘</small>
                ${(event.youtubeId && isCurrentPlaying) ? `<br><button class="watch-btn-tooltip" data-video-id="${event.youtubeId}" style="background: #2b71d2; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; margin-top: 4px; cursor: pointer;">立即觀看</button>` : ''}
              </div>
            ` : ''}
          </div>
        `;
      });

      if (hiddenEventsCount > 0) {
        html += `
          <div class="more-events-indicator" onclick="showAllEventsForDay('${dateString}')">
            +${hiddenEventsCount} 更多節目
          </div>
        `;
      }

      return html;
    }

    function isPrimeTime(hour) {
      return hour >= 12 && hour < 18;
    }

    function previousPeriod() {
      switch(currentView) {
        case 'month': currentDate.setMonth(currentDate.getMonth() - 1); break;
        case 'week': currentDate.setDate(currentDate.getDate() - 7); break;
        case 'day': currentDate.setDate(currentDate.getDate() - 1); break;
      }
      renderCurrentView();
      updateCurrentDateDisplay();
    }

    function nextPeriod() {
      switch(currentView) {
        case 'month': currentDate.setMonth(currentDate.getMonth() + 1); break;
        case 'week': currentDate.setDate(currentDate.getDate() + 7); break;
        case 'day': currentDate.setDate(currentDate.getDate() + 1); break;
      }
      renderCurrentView();
      updateCurrentDateDisplay();
    }

    function goToToday() {
      currentDate = new Date();
      renderCurrentView();
      updateCurrentDateDisplay();
    }

    function updateCurrentDateDisplay() {
      const dateElement = document.getElementById('currentDate');
      switch(currentView) {
        case 'month':
          dateElement.textContent = `${currentDate.getFullYear()}年${currentDate.getMonth() + 1}月`;
          break;
        case 'week':
          const weekStart = new Date(currentDate);
          weekStart.setDate(currentDate.getDate() - currentDate.getDay());
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekStart.getDate() + 6);
          dateElement.textContent = `${weekStart.getFullYear()}年${weekStart.getMonth() + 1}月${weekStart.getDate()}日 - ${weekEnd.getMonth() + 1}月${weekEnd.getDate()}日`;
          break;
        case 'day':
          dateElement.textContent = `${currentDate.getFullYear()}年${currentDate.getMonth() + 1}月${currentDate.getDate()}日`;
          break;
      }
    }

    function openEventModal(date, time = '') {
      const today = new Date();
      const currentHour = today.getHours();
      const currentMinute = today.getMinutes();
      const todayString = today.getFullYear() + '-' +
                         String(today.getMonth() + 1).padStart(2, '0') + '-' +
                         String(today.getDate()).padStart(2, '0');
      const isPastDate = date < todayString;
      const isPastTime = date === todayString &&
                        (parseInt(time.split(':')[0]) < currentHour ||
                         (parseInt(time.split(':')[0]) === currentHour && parseInt(time.split(':')[1]) <= currentMinute));

      if (isPastDate || isPastTime) {
        showStatus('無法編輯過去的日期或時間', 'warning');
        return;
      }

      document.getElementById('editDate').value = date;
      document.getElementById('editTime').value = time;
      document.getElementById('airTime').value = time;

      const existingEvent = getEvent(date, time);
      if (existingEvent) {
        document.getElementById('modalTitle').textContent = '編輯節目';
        document.getElementById('title').value = existingEvent.title;
        document.getElementById('duration').value = existingEvent.duration;
        document.getElementById('category').value = existingEvent.category;
        document.getElementById('description').value = existingEvent.description;
        document.getElementById('status').value = existingEvent.status;
        document.getElementById('videoType').value = existingEvent.videoType || '';
        document.getElementById('youtubeId').value = existingEvent.youtubeId || '';
        
        // 載入現有的縮圖資料
        if (existingEvent.thumbnail) {
          // 如果有現有縮圖，顯示在預覽中
          const thumbnailImage = document.getElementById('thumbnailImage');
          const placeholder = document.getElementById('thumbnailPlaceholder');
          
          if (existingEvent.thumbnail.startsWith('http')) {
            // 如果是 URL（YouTube 縮圖或自訂 URL）
            thumbnailImage.src = existingEvent.thumbnail;
            thumbnailImage.style.display = 'block';
            placeholder.style.display = 'none';
            
            // 如果是 YouTube 縮圖，設定隱藏欄位
            if (existingEvent.thumbnail.includes('i.ytimg.com') || existingEvent.thumbnail.includes('img.youtube.com')) {
              document.getElementById('thumbnailAssetId').setAttribute('data-youtube-url', existingEvent.thumbnail);
            }
          }
        }
        
        toggleVideoFields();
      } else {
        document.getElementById('modalTitle').textContent = '新增節目';
        document.getElementById('eventForm').reset();
        document.getElementById('airTime').value = time;
      }

      document.getElementById('eventModal').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('eventModal').style.display = 'none';
    }

    function openTimeSlotSelector(date) {
      const today = new Date();
      const currentHour = today.getHours();
      const currentMinute = today.getMinutes();
      const todayString = today.getFullYear() + '-' +
                         String(today.getMonth() + 1).padStart(2, '0') + '-' +
                         String(today.getDate()).padStart(2, '0');
      const isToday = date === todayString;

      const timeSlotGrid = document.getElementById('timeSlotGrid');
      timeSlotGrid.innerHTML = '';

      for (let hour = 0; hour < 24; hour++) {
        for (let minute = 0; minute < 60; minute += 30) {
          const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;

          const isPastTime = isToday && (hour < currentHour || (hour === currentHour && minute <= currentMinute));

          const timeSlot = document.createElement('div');
          timeSlot.className = 'time-slot-btn';
          timeSlot.style.cssText = `
            padding: 15px 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
            cursor: ${isPastTime ? 'not-allowed' : 'pointer'};
            background: ${isPastTime ? '#f5f5f5' : '#fff'};
            color: ${isPastTime ? '#999' : '#333'};
            font-weight: 600;
            transition: all 0.3s ease;
          `;

          if (!isPastTime) {
            timeSlot.addEventListener('mouseenter', function() {
              this.style.borderColor = '#2b71d2';
              this.style.backgroundColor = '#e3f2fd';
            });

            timeSlot.addEventListener('mouseleave', function() {
              this.style.borderColor = '#e9ecef';
              this.style.backgroundColor = '#fff';
            });

            timeSlot.addEventListener('click', function() {
              openEventModal(date, timeString);
              closeTimeSlotModal();
            });
          }

          timeSlot.textContent = timeString;
          timeSlotGrid.appendChild(timeSlot);
        }
      }

      document.getElementById('timeSlotModal').style.display = 'block';
    }

    function closeTimeSlotModal() {
      document.getElementById('timeSlotModal').style.display = 'none';
    }

    function toggleVideoFields() {
      const videoType = document.getElementById('videoType').value;
      const youtubeIdGroup = document.getElementById('youtubeIdGroup');
      const mp4FileGroup = document.getElementById('mp4FileGroup');

      youtubeIdGroup.style.display = videoType === 'YouTube' ? 'block' : 'none';
      mp4FileGroup.style.display = videoType === 'MP4' ? 'block' : 'none';
    }

    async function fetchYouTubeInfo() {
      const youtubeId = document.getElementById('youtubeId').value.trim();
      if (!youtubeId) return;

      try {
        const response = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${youtubeId}&format=json`);
        if (response.ok) {
          const data = await response.json();
          document.getElementById('title').value = data.title;
          showStatus('YouTube 資訊已自動填入', 'success');
        } else {
          showStatus('無法獲取 YouTube 資訊，請檢查 ID 是否正確', 'warning');
        }
      } catch (error) {
        showStatus('獲取 YouTube 資訊時發生錯誤', 'error');
      }
    }

    function handleFileUpload() {
      const fileInput = document.getElementById('mp4File');
      const file = fileInput.files[0];

      if (file) {
        const fileName = file.name.replace('.mp4', '');
        document.getElementById('title').value = fileName;
        showStatus('檔案名稱已自動填入為標題', 'success');
      }
    }

    function getEvent(date, time) {
      const dayEvents = events[date] || [];
      return dayEvents.find(event => event.time === time);
    }

    document.getElementById('eventForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const date = document.getElementById('editDate').value;
      const time = document.getElementById('airTime').value;

      const today = new Date();
      const currentHour = today.getHours();
      const currentMinute = today.getMinutes();
      const todayString = today.getFullYear() + '-' +
                         String(today.getMonth() + 1).padStart(2, '0') + '-' +
                         String(today.getDate()).padStart(2, '0');
      const isPastDate = date < todayString;
      const isPastTime = date === todayString &&
                        (parseInt(time.split(':')[0]) < currentHour ||
                         (parseInt(time.split(':')[0]) === currentHour && parseInt(time.split(':')[1]) <= currentMinute));

      if (isPastDate || isPastTime) {
        showStatus('無法在過去的日期或時間安排節目', 'warning');
        return;
      }

      const videoType = document.getElementById('videoType').value;
      const videoId = videoType === 'YouTube'
        ? document.getElementById('youtubeId').value
        : document.getElementById('mp4File').files[0] ? document.getElementById('mp4File').files[0].name : null;

      // 處理縮圖資料
      const thumbnailAssetId = document.getElementById('thumbnailAssetId').value;
      const youtubeThumbnailUrl = document.getElementById('thumbnailAssetId').getAttribute('data-youtube-url');
      const thumbnailFile = document.getElementById('thumbnailFile').files[0];
      const thumbnailImage = document.getElementById('thumbnailImage');
      
      let thumbnail = null;
      if (thumbnailAssetId) {
        // 如果有 Contentful Asset ID，使用預設縮圖（實際縮圖會在 Contentful 中）
        thumbnail = 'https://images.unsplash.com/photo-1485846234645-a62644f84728?w=400&h=225&fit=crop';
      } else if (youtubeThumbnailUrl) {
        // 如果有 YouTube 縮圖 URL
        thumbnail = youtubeThumbnailUrl;
      } else if (thumbnailImage.src && thumbnailImage.src.startsWith('http')) {
        // 如果有預覽的縮圖
        thumbnail = thumbnailImage.src;
      }

      const event = {
        date: date,
        time: time,
        title: document.getElementById('title').value,
        duration: parseInt(document.getElementById('duration').value),
        category: document.getElementById('category').value,
        description: document.getElementById('description').value,
        status: document.getElementById('status').value,
        videoType: videoType,
        youtubeId: videoType === 'YouTube' ? document.getElementById('youtubeId').value : null,
        mp4File: videoType === 'MP4' ? (document.getElementById('mp4File').files[0] ? document.getElementById('mp4File').files[0].name : null) : null,
        thumbnail: thumbnail
      };

      if (!events[date]) {
        events[date] = [];
      }

      events[date] = events[date].filter(e => e.time !== time);
      events[date].push(event);
      events[date].sort((a, b) => a.time.localeCompare(b.time));

      saveEvents();
      renderCurrentView();
      closeModal();
      showStatus('節目已儲存', 'success');
    });

    function deleteEvent() {
      const date = document.getElementById('editDate').value;
      const time = document.getElementById('editTime').value;

      if (events[date]) {
        events[date] = events[date].filter(event => event.time !== time);
        if (events[date].length === 0) {
          delete events[date];
        }
      }

      saveEvents();
      renderCurrentView();
      closeModal();
      showStatus('節目已刪除', 'success');
    }

    function saveEvents() {
      localStorage.setItem('calendar_events', JSON.stringify(events));
    }

    function loadEvents() {
      // 先嘗試從 Contentful 載入
      loadEventsFromContentful().then(() => {
        // Contentful 載入成功，不需要從 localStorage 載入
        console.log('✅ 使用 Contentful 資料，跳過 localStorage 載入 (v2.1)');
      }).catch(() => {
        // Contentful 載入失敗，使用 localStorage
        const saved = localStorage.getItem('calendar_events');
        if (saved) {
          events = JSON.parse(saved);
          console.log('❌ Contentful 載入失敗，從 localStorage 載入節目資料 (v2.1)');
        }
      });
    }

    // 從 Contentful 載入節目
    async function loadEventsFromContentful() {
      try {
        console.log('正在從 Contentful 載入節目...');
        
        // 檢查 Contentful 是否可用
        if (typeof contentful === 'undefined') {
          throw new Error('Contentful SDK 未載入');
        }

        // 創建 Contentful 客戶端 (使用 Delivery Token 讀取資料)
        const client = contentful.createClient({
          space: window.CONTENTFUL_CONFIG?.SPACE_ID || 'os5wf90ljenp',
          accessToken: window.CONTENTFUL_CONFIG?.DELIVERY_TOKEN
        });

        // 獲取所有節目
        const response = await client.getEntries({
          content_type: 'scheduleItem',
          order: 'fields.airDate'
        });

        console.log(`從 Contentful 載入 ${response.items.length} 個節目`);
        console.log('Contentful 原始資料範例:', response.items[0]?.fields);
        console.log('Contentful video 欄位範例:', response.items[0]?.fields?.video);
        console.log('Contentful video 欄位詳細內容:', JSON.stringify(response.items[0]?.fields?.video, null, 2));

        // 清空現有事件
        events = {};

        // 轉換 Contentful 資料為本地格式
        response.items.forEach(item => {
          const fields = item.fields;
          const airDate = fields.airDate || new Date().toISOString().split('T')[0];
          
          // 從備註中提取具體時間，格式為 [時間:XX:XX]
          const notes = fields.notes || '';
          const timeMatch = notes.match(/\[時間:(\d{2}:\d{2})\]/);
          const airTime = timeMatch ? timeMatch[1] : convertBlockToTime(fields.block || '12-18');
          
          // 使用具體時間，如果沒有則轉換時段
          const time = airTime;
          
          if (!events[airDate]) {
            events[airDate] = [];
          }

          // 清理描述，移除時間標記
          const cleanDescription = notes.replace(/\[時間:\d{2}:\d{2}\]/, '').trim();
          
          // 處理縮圖
          let thumbnail = null;
          console.log('處理 Contentful 節目縮圖:', fields.title, {
            hasThumbnail: !!(fields.thumbnail && fields.thumbnail['en-US']),
            hasThumbnailUrl: !!(fields.thumbnailUrl && fields.thumbnailUrl['en-US']),
            thumbnailAsset: fields.thumbnail?.['en-US'],
            thumbnailUrl: fields.thumbnailUrl?.['en-US']
          });
          
          if (fields.thumbnail && fields.thumbnail['en-US']) {
            const thumbnailAsset = fields.thumbnail['en-US'];
            if (thumbnailAsset.fields && thumbnailAsset.fields.file) {
              thumbnail = 'https:' + thumbnailAsset.fields.file['en-US'].url;
              console.log('使用 Contentful Asset 縮圖:', thumbnail);
            }
          } else if (fields.thumbnailUrl && fields.thumbnailUrl['en-US']) {
            thumbnail = fields.thumbnailUrl['en-US'];
            console.log('使用 Contentful URL 縮圖:', thumbnail);
          }
          
          // 處理 YouTube ID
          let youtubeId = '';
          // 檢查 video 欄位結構
          
          if (fields.video && fields.video['en-US'] && fields.video['en-US'].fields) {
            const videoFields = fields.video['en-US'].fields;
            youtubeId = videoFields.youtubeId || videoFields.youTubeId || videoFields.YouTubeID || '';
            // 成功提取 YouTube ID (標準結構)
          } else if (fields.video && fields.video.fields) {
            // 備用處理方式：直接從 video.fields 讀取
            const videoFields = fields.video.fields;
            youtubeId = videoFields.youtubeId || videoFields.youTubeId || videoFields.YouTubeID || '';
            // 成功提取 YouTube ID (直接結構)
          } else {
            // 沒有找到 video 欄位或結構不正確
          }
          
          // 如果沒有縮圖但有 YouTube ID，自動生成 YouTube 縮圖
          if (!thumbnail && youtubeId) {
            thumbnail = `https://i.ytimg.com/vi/${youtubeId}/hqdefault.jpg`;
            // 自動生成 YouTube 縮圖成功
          }
          
          events[airDate].push({
            id: item.sys.id,
            title: fields.title || '未命名節目',
            time: time,
            duration: 30,
            category: '旅遊節目',
            description: cleanDescription,
            videoType: youtubeId ? 'YouTube' : 'MP4',
            youtubeId: youtubeId,
            thumbnail: thumbnail,
            status: 'published',
            published: true,
            publishedAt: item.sys.createdAt,
            contentfulId: item.sys.id
          });
        });

        // 按時間排序
        Object.keys(events).forEach(date => {
          events[date].sort((a, b) => a.time.localeCompare(b.time));
        });

        // 儲存到 localStorage 作為備份
        saveEvents();
        
        console.log('✅ 從 Contentful 載入節目成功');
        const allPrograms = Object.values(events).flat();
        console.log('Contentful 節目縮圖總結:', allPrograms.map(e => ({title: e.title, thumbnail: e.thumbnail, youtubeId: e.youtubeId})));
        console.log('有縮圖的節目數量:', allPrograms.filter(e => e.thumbnail).length);
        console.log('有 YouTube ID 的節目數量:', allPrograms.filter(e => e.youtubeId).length);
        showStatus('✅ 已從 Contentful 載入節目', 'success');
        
        return true;
      } catch (error) {
        console.error('❌ 從 Contentful 載入節目失敗:', error);
        console.error('錯誤詳情:', {
          message: error.message,
          status: error.status,
          statusText: error.statusText,
          details: error.details
        });
        showStatus('⚠️ 從 Contentful 載入失敗，使用本地資料', 'warning');
        throw error;
      }
    }

    // 轉換時段為具體時間
    function convertBlockToTime(block) {
      switch (block) {
        case '00-06': return '02:00';
        case '06-12': return '11:30'; // 修復：從 08:00 改為 11:30
        case '12-18': return '14:00';
        case '18-24': return '22:00';
        default: return '14:00';
      }
    }

    function debugEvents() {
      console.log('=== 節目資料調試 ===');
      console.log('所有節目資料:', events);

      const eventDates = Object.keys(events);
      console.log('有節目的日期:', eventDates);

      eventDates.forEach(date => {
        const dayEvents = events[date];
        console.log(`日期 ${date} (${new Date(date).toLocaleDateString('zh-TW')}):`, dayEvents);
      });

      const today = new Date();
      const todayString = today.getFullYear() + '-' +
                         String(today.getMonth() + 1).padStart(2, '0') + '-' +
                         String(today.getDate()).padStart(2, '0');
      const currentDateString = currentDate.getFullYear() + '-' +
                               String(currentDate.getMonth() + 1).padStart(2, '0') + '-' +
                               String(currentDate.getDate()).padStart(2, '0');
      console.log('今天日期:', todayString);
      console.log('當前顯示日期:', currentDateString);

      showStatus('調試資訊已輸出到控制台', 'info');
    }

    async function syncAllToContentful() {
      try {
        showStatus('正在檢查 Contentful 真實連線...', 'info');
        
        // 先清理測試資料
        const removedCount = clearOldTestData();
        if (removedCount > 0) {
          showStatus(`已清理 ${removedCount} 個測試節目，繼續同步...`, 'info');
        }

        // 檢查 Management SDK 是否載入
        if (typeof contentfulManagement === 'undefined') {
          throw new Error('Management SDK 未載入，請先載入 Management SDK');
        }

        if (typeof window.contentfulManagement === 'undefined') {
          throw new Error('window.contentfulManagement 不可用');
        }

        showStatus('✅ Contentful 真實連線成功，開始同步...', 'success');

        const calendarEvents = JSON.parse(localStorage.getItem('calendar_events') || '{}');
        const allPrograms = [];

        Object.keys(calendarEvents).forEach(date => {
          calendarEvents[date].forEach(event => {
            allPrograms.push({
              title: event.title,
              airDate: date,
              airTime: event.time,
              duration: event.duration,
              category: event.category,
              description: event.description || '',
              status: event.status,
              videoType: event.videoType || '',
              youtubeId: event.youtubeId || '',
              mp4File: event.mp4File || ''
            });
          });
        });

        if (allPrograms.length === 0) {
          showStatus('沒有節目需要同步', 'warning');
          return;
        }

        showStatus(`開始同步 ${allPrograms.length} 個節目到 Contentful...`, 'info');

        let successCount = 0;
        let failCount = 0;

        let skipCount = 0;
        
        for (const program of allPrograms) {
          try {
            console.log('正在上架節目:', program);
            const result = await uploadProgramSimple(program);
            if (result.success) {
              if (result.skipped) {
                skipCount++;
                console.log('⏭️ 節目已存在，跳過:', program.title, result.entryId);
              } else {
                successCount++;
                console.log('✅ 節目上架成功:', program.title, result.entryId);
              }
            } else {
              failCount++;
              console.error('❌ 同步節目失敗:', program.title, result.error);
            }
          } catch (error) {
            console.error('❌ 同步節目異常:', program.title, error);
            failCount++;
          }
        }

        if (failCount === 0) {
          if (skipCount > 0) {
            showStatus(`✅ 同步完成：${successCount} 個新節目上架成功，${skipCount} 個重複節目已跳過`, 'success');
          } else {
            showStatus(`✅ 所有 ${successCount} 個節目同步成功到 Contentful！`, 'success');
          }
        } else {
          showStatus(`⚠️ 同步完成：${successCount} 成功，${skipCount} 跳過，${failCount} 失敗`, 'warning');
        }

        console.log('同步結果:', { successCount, skipCount, failCount });

      } catch (error) {
        console.error('批量同步失敗:', error);
        showStatus('❌ 批量同步失敗：' + error.message, 'error');
      }
    }

    function showAllEventsForDay(dateString) {
      const dayEvents = events[dateString] || [];
      if (dayEvents.length === 0) {
        showStatus('該日期沒有節目', 'info');
        return;
      }

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'block';

      const date = new Date(dateString);
      const dateDisplay = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;

      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
            <h3>${dateDisplay} 的所有節目</h3>
            <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
          </div>
          <div style="max-height: 400px; overflow-y: auto;">
            ${dayEvents.map(event => `
              <div style="border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <span style="font-weight: 600; color: #2b71d2;">${event.time}</span>
                  <span style="background: ${event.status === '首播' ? '#ffc107' : '#28a745'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">
                    ${event.status}
                  </span>
                </div>
                <div style="font-weight: 600; margin-bottom: 5px;">${event.title}</div>
                <div style="color: #666; font-size: 0.9rem; margin-bottom: 5px;">
                  <span>${event.category}</span> • <span>${event.duration}分鐘</span>
                  ${event.videoType ? ` • <span>${event.videoType}</span>` : ''}
                </div>
                ${event.description ? `<div style="color: #666; font-size: 0.9rem; margin-bottom: 8px;">${event.description}</div>` : ''}
                <button class="btn" style="padding: 5px 12px; font-size: 0.8rem;" onclick="openEventModal('${dateString}', '${event.time}')">
                  編輯節目
                </button>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    function showStatus(message, type) {
      const statusBar = document.getElementById('statusBar');
      const statusMessage = document.getElementById('statusMessage');

      statusMessage.textContent = message;
      statusBar.style.display = 'block';

      statusBar.style.backgroundColor = type === 'success' ? '#4caf50' :
                                      type === 'error' ? '#f44336' :
                                      type === 'warning' ? '#ff9800' : '#333';

      setTimeout(() => {
        statusBar.style.display = 'none';
      }, 3000);
    }

    // 更新今日節目表顯示
    function updateCurrentScheduleForToday(programData) {
      const today = new Date();
      const todayString = today.getFullYear() + '-' +
                         String(today.getMonth() + 1).padStart(2, '0') + '-' +
                         String(today.getDate()).padStart(2, '0');
      
      // 獲取現有的今日節目表
      let currentSchedule = JSON.parse(localStorage.getItem('currentSchedule') || '{}');
      
      if (!currentSchedule.today) {
        currentSchedule.today = {
          date: todayString,
          dayOfWeek: getDayOfWeek(today),
          month: `${today.getMonth() + 1}月`,
          day: `${today.getDate()}日`,
          schedule: []
        };
      }
      
      // 轉換節目資料格式
      const scheduleItem = {
        time: programData.airTime,
        title: programData.title,
        duration: programData.duration.toString(),
        category: programData.category,
        description: programData.description,
        thumbnail: programData.youtubeId ? 
          `https://img.youtube.com/vi/${programData.youtubeId}/maxresdefault.jpg` : 
          'https://images.unsplash.com/photo-1485846234645-a62644f84728?w=400&h=225&fit=crop',
        youtubeId: programData.youtubeId || '',
        status: programData.status,
        tags: []
      };
      
      // 移除同時間的舊節目（如果有的話）
      currentSchedule.today.schedule = currentSchedule.today.schedule.filter(
        item => item.time !== programData.airTime
      );
      
      // 添加新節目
      currentSchedule.today.schedule.push(scheduleItem);
      
      // 按時間排序
      currentSchedule.today.schedule.sort((a, b) => a.time.localeCompare(b.time));
      
      // 過濾過去時間的節目
      currentSchedule.today.schedule = filterPastPrograms(currentSchedule.today.schedule);
      
      // 儲存到 localStorage
      localStorage.setItem('currentSchedule', JSON.stringify(currentSchedule));
      
      console.log('已更新今日節目表，新增節目:', scheduleItem);
    }

    // 過濾過去時間的節目
    function filterPastPrograms(programs) {
      const now = new Date();
      const currentTime = now.getHours() * 60 + now.getMinutes();
      
      return programs.filter(program => {
        const [programHour, programMinute] = program.time.split(':').map(Number);
        const programStartTime = programHour * 60 + programMinute;
        const programEndTime = programStartTime + parseInt(program.duration);
        
        // 只保留當前時間之後的節目（包括正在播放的節目）
        // 保留條件：當前時間 < 節目結束時間（這樣正在播放的節目會被保留）
        return currentTime < programEndTime;
      });
    }

    // 清理今日節目表中的過去節目
    function cleanupPastPrograms() {
      const currentSchedule = JSON.parse(localStorage.getItem('currentSchedule') || '{}');
      
      if (currentSchedule.today && currentSchedule.today.schedule) {
        const originalCount = currentSchedule.today.schedule.length;
        currentSchedule.today.schedule = filterPastPrograms(currentSchedule.today.schedule);
        const filteredCount = currentSchedule.today.schedule.length;
        
        if (originalCount !== filteredCount) {
          localStorage.setItem('currentSchedule', JSON.stringify(currentSchedule));
          console.log(`已清理 ${originalCount - filteredCount} 個過去時間的節目`);
        }
      }
    }

    // 判斷是否為現正播出的節目
    function isCurrentProgram(event) {
      const now = new Date();
      const currentTime = now.getHours() * 60 + now.getMinutes();
      
      const [programHour, programMinute] = event.time.split(':').map(Number);
      const programStartTime = programHour * 60 + programMinute;
      const programEndTime = programStartTime + parseInt(event.duration);
      
      const isCurrent = currentTime >= programStartTime && currentTime < programEndTime;
      
      console.log('檢查節目狀態:', {
        title: event.title,
        time: event.time,
        duration: event.duration,
        currentTime: `${now.getHours()}:${now.getMinutes()}`,
        programStartTime: `${programHour}:${programMinute}`,
        programEndTime: `${Math.floor(programEndTime / 60)}:${programEndTime % 60}`,
        isCurrent: isCurrent,
        youtubeId: event.youtubeId
      });
      
      return isCurrent;
    }

    // 獲取星期幾的輔助函數
    function getDayOfWeek(date) {
      const days = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
      return days[date.getDay()];
    }

    async function publishToContentful() {
      const date = document.getElementById('editDate').value;
      const time = document.getElementById('airTime').value;
      const title = document.getElementById('title').value;
      const duration = document.getElementById('duration').value;
      const category = document.getElementById('category').value;
      const description = document.getElementById('description').value;
      const status = document.getElementById('status').value;

      if (!title || !date || !time) {
        showStatus('請先填寫完整的節目資訊', 'warning');
        return;
      }

      const today = new Date();
      const currentHour = today.getHours();
      const currentMinute = today.getMinutes();
      const todayString = today.getFullYear() + '-' +
                         String(today.getMonth() + 1).padStart(2, '0') + '-' +
                         String(today.getDate()).padStart(2, '0');
      const isPastDate = date < todayString;
      const isPastTime = date === todayString &&
                        (parseInt(time.split(':')[0]) < currentHour ||
                         (parseInt(time.split(':')[0]) === currentHour && parseInt(time.split(':')[1]) <= currentMinute));

      if (isPastDate || isPastTime) {
        showStatus('無法上架過去的日期或時間的節目', 'warning');
        return;
      }

      showStatus('正在上架節目到 Contentful...', 'info');

      try {
        // 處理縮圖資料
        const thumbnailFile = document.getElementById('thumbnailFile').files[0];
        const thumbnailImage = document.getElementById('thumbnailImage');
        const thumbnailAssetId = document.getElementById('thumbnailAssetId').value;
        const youtubeThumbnailUrl = document.getElementById('thumbnailAssetId').getAttribute('data-youtube-url');
        let thumbnailUrl = null;
        
        // 如果有上傳的縮圖檔案
        if (thumbnailFile) {
          // 縮圖檔案會在 uploadProgramSimple 中處理
        } else if (thumbnailAssetId) {
          // 如果有 Contentful Asset ID（自訂縮圖已上傳）
          // 這個會在 uploadProgramSimple 中處理
        } else if (youtubeThumbnailUrl) {
          // 如果有 YouTube 縮圖 URL
          thumbnailUrl = youtubeThumbnailUrl;
        } else if (thumbnailImage.src && thumbnailImage.src.startsWith('http')) {
          // 如果是 YouTube 縮圖 URL（但未處理）
          thumbnailUrl = thumbnailImage.src;
        }
        
        const programData = {
          title: title,
          airDate: date,
          airTime: time,
          duration: parseInt(duration),
          category: category,
          description: description,
          status: status,
          videoType: document.getElementById('videoType').value,
          youtubeId: document.getElementById('videoType').value === 'YouTube' ? document.getElementById('youtubeId').value : null,
          mp4File: document.getElementById('videoType').value === 'MP4' ? (document.getElementById('mp4File').files[0] ? document.getElementById('mp4File').files[0].name : null) : null,
          thumbnailFile: thumbnailFile,
          thumbnailUrl: thumbnailUrl,
          thumbnailAssetId: thumbnailAssetId
        };

        // 使用簡化的上架功能
        const result = await uploadProgramSimple(programData);

        if (result.success) {
          const publishedPrograms = JSON.parse(localStorage.getItem('published_programs') || '[]');
          publishedPrograms.push({
            ...programData,
            publishedAt: new Date().toISOString(),
            contentfulId: result.entryId,
            simulated: result.simulated || false
          });
          localStorage.setItem('published_programs', JSON.stringify(publishedPrograms));

          // 同步到今日節目表顯示系統
          updateCurrentScheduleForToday(programData);

          const statusMessage = result.simulated ? 
            '✅ 節目已模擬上架（Management API 不可用）' : 
            '✅ 節目已成功上架到 Contentful！';
          showStatus(statusMessage, 'success');

          const event = getEvent(date, time);
          if (event) {
            event.published = true;
            event.publishedAt = new Date().toISOString();
            event.contentfulId = result.entryId;
            saveEvents();
            renderCurrentView();
          }

          // 關閉模態框
          closeModal();
        } else {
          throw new Error('上架失敗');
        }

      } catch (error) {
        console.error('上架失敗:', error);
        showStatus('❌ 上架失敗：' + error.message, 'error');
      }
    }

    window.addEventListener('click', function(e) {
      const eventModal = document.getElementById('eventModal');
      const timeSlotModal = document.getElementById('timeSlotModal');

      if (e.target === eventModal) {
        closeModal();
      }

      if (e.target === timeSlotModal) {
        closeTimeSlotModal();
      }
    });

    // 測試上架功能已移至統一測試與日誌查看器

    // 顯示測試日誌
    function showTestLogs() {
      const uploadHistory = window.contentfulRealIntegration.getUploadHistory();
      const publishedPrograms = JSON.parse(localStorage.getItem('published_programs') || '[]');
      
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'block';
      
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
          <div class="modal-header">
            <h3>📋 測試日誌和上架記錄</h3>
            <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
          </div>
          <div style="max-height: 60vh; overflow-y: auto;">
            <div style="margin-bottom: 20px;">
              <h4>🧪 上架測試記錄 (${uploadHistory.length} 筆)</h4>
              ${uploadHistory.length > 0 ? uploadHistory.map((item, index) => `
                <div style="border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-weight: 600; color: #2b71d2;">測試 #${index + 1}</span>
                    <span style="background: ${item.simulated ? '#ffc107' : '#28a745'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">
                      ${item.simulated ? '模擬模式' : '真實模式'}
                    </span>
                  </div>
                  <div style="font-weight: 600; margin-bottom: 5px;">${item.title}</div>
                  <div style="color: #666; font-size: 0.9rem; margin-bottom: 5px;">
                    <span>${item.airDate} ${item.airTime}</span> • 
                    <span>${item.category}</span> • 
                    <span>${item.duration}分鐘</span>
                  </div>
                  <div style="color: #666; font-size: 0.8rem;">
                    上架時間: ${new Date(item.uploadedAt).toLocaleString()}
                  </div>
                  ${item.contentfulId ? `<div style="color: #666; font-size: 0.8rem;">Contentful ID: ${item.contentfulId}</div>` : ''}
                </div>
              `).join('') : '<p style="color: #666; font-style: italic;">尚無測試記錄</p>'}
            </div>
            
            <div style="margin-bottom: 20px;">
              <h4>📺 已發布節目記錄 (${publishedPrograms.length} 筆)</h4>
              ${publishedPrograms.length > 0 ? publishedPrograms.map((item, index) => `
                <div style="border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-weight: 600; color: #2b71d2;">節目 #${index + 1}</span>
                    <span style="background: ${item.simulated ? '#ffc107' : '#28a745'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">
                      ${item.simulated ? '模擬發布' : '真實發布'}
                    </span>
                  </div>
                  <div style="font-weight: 600; margin-bottom: 5px;">${item.title}</div>
                  <div style="color: #666; font-size: 0.9rem; margin-bottom: 5px;">
                    <span>${item.airDate} ${item.airTime}</span> • 
                    <span>${item.category}</span> • 
                    <span>${item.duration}分鐘</span>
                  </div>
                  <div style="color: #666; font-size: 0.8rem;">
                    發布時間: ${new Date(item.publishedAt).toLocaleString()}
                  </div>
                  ${item.contentfulId ? `<div style="color: #666; font-size: 0.8rem;">Contentful ID: ${item.contentfulId}</div>` : ''}
                </div>
              `).join('') : '<p style="color: #666; font-style: italic;">尚無發布記錄</p>'}
            </div>
            
            <div style="margin-bottom: 20px;">
              <h4>🔧 系統狀態</h4>
              <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <div style="margin-bottom: 10px;">
                  <strong>Contentful 配置:</strong>
                  <div style="font-family: monospace; font-size: 0.8rem; color: #666; margin-top: 5px;">
                    Space ID: ${window.contentfulUploadFix.config.space}<br>
                    Environment: ${window.contentfulUploadFix.config.environment}<br>
                    Management Token: ${window.contentfulUploadFix.config.managementToken ? '已設置' : '未設置'}
                  </div>
                </div>
                <div>
                  <strong>瀏覽器支援:</strong>
                  <div style="font-family: monospace; font-size: 0.8rem; color: #666; margin-top: 5px;">
                    Contentful SDK: ${typeof contentful !== 'undefined' ? '✅ 已載入' : '❌ 未載入'}<br>
                    Management SDK: ${typeof contentfulManagement !== 'undefined' ? '✅ 已載入' : '❌ 未載入'}<br>
                    Local Storage: ${typeof Storage !== 'undefined' ? '✅ 支援' : '❌ 不支援'}
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="clearTestLogs()">🗑️ 清除測試記錄</button>
            <button class="btn" onclick="this.closest('.modal').remove()">關閉</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    // 清除測試日誌
    function clearTestLogs() {
      if (confirm('確定要清除所有測試記錄嗎？')) {
        window.contentfulRealIntegration.clearAllLogs();
        localStorage.removeItem('published_programs');
        showStatus('測試記錄已清除', 'success');
        // 關閉模態框
        document.querySelector('.modal').remove();
      }
    }

    // 重新初始化 Contentful
    async function reinitializeContentful() {
      try {
        showStatus('正在重新初始化 Contentful...', 'info');
        console.log('🔄 開始重新初始化 Contentful...');
        
        // 檢查 SDK 狀態
        console.log('📊 當前 SDK 狀態:');
        console.log('- Contentful SDK:', typeof contentful !== 'undefined' ? '✅ 已載入' : '❌ 未載入');
        console.log('- Management SDK:', typeof contentfulManagement !== 'undefined' ? '✅ 已載入' : '❌ 未載入');
        
        // 如果 Management SDK 未載入，嘗試載入
        if (typeof contentfulManagement === 'undefined') {
          console.log('📥 嘗試載入 Management SDK...');
          // Management SDK 應該已經載入，如果沒有則重新初始化
          await window.contentfulRealIntegration.init();
        }
        
        // 重新初始化
        const initResult = await window.contentfulRealIntegration.init();
        
        if (initResult) {
          showStatus('✅ Contentful 重新初始化成功！', 'success');
          console.log('✅ 重新初始化完成');
          
        // 測試連接
        const connectionTest = await window.contentfulRealIntegration.testConnection();
          console.log('🔗 連接測試結果:', connectionTest);
          
          if (connectionTest.success) {
            showStatus('✅ Contentful 連接正常，可以進行真實上架！', 'success');
          } else {
            showStatus('⚠️ Contentful 連接有問題：' + connectionTest.error, 'warning');
          }
        } else {
          showStatus('❌ Contentful 重新初始化失敗', 'error');
        }
        
      } catch (error) {
        console.error('❌ 重新初始化失敗:', error);
        showStatus('❌ 重新初始化失敗：' + error.message, 'error');
      }
    }

    // 強制載入 Management SDK
    async function forceLoadManagementSDK() {
      try {
        showStatus('正在強制修復載入 Management SDK...', 'info');
        console.log('🔧 開始強制修復載入 Management SDK...');
        
        if (!window.contentfulManagementFix) {
          showStatus('❌ Management 修復載入器不可用', 'error');
          return;
        }
        
        // 檢查當前狀態
        const status = window.contentfulManagementFix.checkStatus();
        console.log('📊 當前狀態:', status);
        
        // 強制重新載入
        await window.contentfulManagementFix.forceReload();
        
        // 檢查載入結果
        const newStatus = window.contentfulManagementFix.checkStatus();
        console.log('📊 載入後狀態:', newStatus);
        
        if (newStatus.sdkAvailable) {
          showStatus('✅ Management SDK 修復載入成功！', 'success');
          
          // 重新初始化 Contentful
          const initResult = await window.contentfulRealIntegration.init();
          if (initResult) {
            showStatus('✅ Contentful 重新初始化成功，現在可以真實上架！', 'success');
          } else {
            showStatus('⚠️ Management SDK 載入成功但初始化失敗', 'warning');
          }
        } else {
          showStatus('❌ Management SDK 修復載入失敗', 'error');
        }
        
      } catch (error) {
        console.error('❌ 強制修復載入 Management SDK 失敗:', error);
        showStatus('❌ 強制修復載入失敗：' + error.message, 'error');
        
        // 嘗試重試
        if (window.contentfulManagementFix && window.contentfulManagementFix.retryCount < 5) {
          console.log('🔄 嘗試重試載入...');
          try {
            await window.contentfulManagementFix.retryLoad();
            showStatus('✅ 重試載入成功！', 'success');
          } catch (retryError) {
            showStatus('❌ 重試載入也失敗：' + retryError.message, 'error');
          }
        }
      }
    }

    // 開啟統一測試與日誌查看器
    // 開啟 Contentful 主控台
    function openMainConsole() {
      window.open('contentful-main-console.html', '_blank', 'width=1400,height=900,scrollbars=yes,resizable=yes');
    }

    // 前往主控台
    function goToDashboard() {
      window.location.href = 'admin-dashboard.html';
    }

    // 從 Contentful 重新載入節目
    async function reloadFromContentful() {
      try {
        showStatus('正在從 Contentful 重新載入節目...', 'info');
        
        // 先測試連線
        await testContentfulConnection();
        
        await loadEventsFromContentful();
        renderCurrentView();
        showStatus('✅ 已從 Contentful 重新載入節目', 'success');
      } catch (error) {
        console.error('重新載入失敗:', error);
        showStatus('❌ 重新載入失敗：' + error.message, 'error');
      }
    }

    // 測試 Contentful 連線
    async function testContentfulConnection() {
      try {
        console.log('🔍 測試 Contentful 連線...');
        
        if (typeof contentful === 'undefined') {
          throw new Error('Contentful SDK 未載入');
        }

        const client = contentful.createClient({
          space: window.CONTENTFUL_CONFIG?.SPACE_ID || 'os5wf90ljenp',
          accessToken: window.CONTENTFUL_CONFIG?.DELIVERY_TOKEN
        });

        // 測試獲取空間資訊
        const space = await client.getSpace();
        console.log('✅ Contentful 連線成功，空間:', space.name);
        
        // 測試獲取內容類型
        const contentTypes = await client.getContentTypes();
        console.log('✅ 內容類型數量:', contentTypes.items.length);
        
        // 檢查是否有 scheduleItem 內容類型
        const scheduleItemType = contentTypes.items.find(ct => ct.sys.id === 'scheduleItem');
        if (scheduleItemType) {
          console.log('✅ 找到 scheduleItem 內容類型');
        } else {
          console.log('⚠️ 未找到 scheduleItem 內容類型');
        }
        
        return true;
      } catch (error) {
        console.error('❌ Contentful 連線測試失敗:', error);
        throw error;
      }
    }


    // 上架選中的節目到 Contentful
    async function uploadSelectedPrograms() {
      try {
        // 先檢查系統狀態
        if (typeof contentfulManagement === 'undefined') {
          alert('❌ Management SDK 未載入\n請重新載入頁面');
          return;
        }
        
        // 檢查是否有選中的節目
        const selectedPrograms = getSelectedPrograms();
        if (selectedPrograms.length === 0) {
          alert('請先選擇要上架的節目！\n\n選擇方式：\n1. 在日曆中點擊節目\n2. 或使用「調試節目」功能查看所有節目');
          return;
        }

        // 確認上架
        const confirmMessage = `確定要上架以下 ${selectedPrograms.length} 個節目到 Contentful 嗎？\n\n${selectedPrograms.map(p => `• ${p.title} (${p.airDate} ${p.airTime})`).join('\n')}`;
        if (!confirm(confirmMessage)) {
          return;
        }

        // 顯示進度
        const progressDiv = document.createElement('div');
        progressDiv.id = 'uploadProgress';
        progressDiv.style.cssText = `
          position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
          background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
          z-index: 10000; max-width: 500px; width: 90%;
        `;
        progressDiv.innerHTML = `
          <h3>📺 節目上架中...</h3>
          <div id="progressList" style="max-height: 300px; overflow-y: auto; margin: 10px 0;"></div>
          <button onclick="document.getElementById('uploadProgress').remove()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">關閉</button>
        `;
        document.body.appendChild(progressDiv);

        const progressList = document.getElementById('progressList');
        
        // 等待 Management SDK 載入
        let retryCount = 0;
        const maxRetries = 10;
        
        while (typeof contentfulManagement === 'undefined' && retryCount < maxRetries) {
          progressList.innerHTML += `<div>⏳ 等待 Management SDK 載入... (${retryCount + 1}/${maxRetries})</div>`;
          await new Promise(resolve => setTimeout(resolve, 1000));
          retryCount++;
        }
        
        if (typeof contentfulManagement === 'undefined') {
          throw new Error('Management SDK 載入失敗，請重新載入頁面');
        }
        
        progressList.innerHTML += '<div>✅ Management SDK 已載入</div>';

        let successCount = 0;
        let failCount = 0;

        // 逐個上架節目
        for (let i = 0; i < selectedPrograms.length; i++) {
          const program = selectedPrograms[i];
          progressList.innerHTML += `<div>📺 上架節目 ${i + 1}/${selectedPrograms.length}: ${program.title}</div>`;
          
          try {
            // 準備節目數據
            const programData = {
              contentType: 'scheduleItem',
              title: program.title,
              airDate: program.airDate,
              airTime: program.airTime,
              slotNumber: program.slotNumber || 0,
              isFirstBroadcast: program.isFirstBroadcast || false,
              notes: program.notes || '',
              videoReference: program.videoReference || '',
              category: program.category || '旅遊節目',
              duration: program.duration || 30
            };

            // 上架到 Contentful（使用簡化功能）
            const result = await uploadProgramSimple(programData);
            
            if (result.success) {
              progressList.innerHTML += `<div style="color: green;">✅ ${program.title} 上架成功 (ID: ${result.entryId})</div>`;
              successCount++;
            } else {
              progressList.innerHTML += `<div style="color: red;">❌ ${program.title} 上架失敗</div>`;
              failCount++;
            }
          } catch (error) {
            progressList.innerHTML += `<div style="color: red;">❌ ${program.title} 上架錯誤: ${error.message}</div>`;
            failCount++;
          }
        }

        // 顯示結果
        progressList.innerHTML += `<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
          <strong>上架完成！</strong><br>
          ✅ 成功: ${successCount} 個<br>
          ❌ 失敗: ${failCount} 個<br>
          📊 總計: ${selectedPrograms.length} 個節目
        </div>`;

        // 更新本地節目狀態
        if (successCount > 0) {
          updateLocalProgramStatus(selectedPrograms.slice(0, successCount), 'uploaded');
        }

      } catch (error) {
        alert(`節目上架失敗: ${error.message}\n\n請檢查：\n1. Contentful 系統是否已初始化\n2. 網路連線是否正常\n3. API Token 是否正確`);
        console.error('節目上架錯誤:', error);
      }
    }

    // 獲取選中的節目
    function getSelectedPrograms() {
      const selectedPrograms = [];
      
      // 從 localStorage 中獲取節目資料
      const calendarEvents = JSON.parse(localStorage.getItem('calendar_events') || '{}');
      
      // 從日曆事件中獲取節目
      Object.keys(calendarEvents).forEach(date => {
        calendarEvents[date].forEach(event => {
          if (event.selected) {
            selectedPrograms.push({
              title: event.title,
              airDate: date,
              airTime: event.time,
              slotNumber: event.slotNumber || 0,
              isFirstBroadcast: event.isFirstBroadcast || false,
              notes: event.notes || '',
              videoReference: event.videoReference || '',
              category: event.category || '旅遊節目',
              duration: event.duration || 30
            });
          }
        });
      });

      // 如果沒有選中的節目，返回今日所有節目
      if (selectedPrograms.length === 0) {
        const today = new Date().toISOString().split('T')[0];
        if (calendarEvents[today]) {
          calendarEvents[today].forEach(event => {
            selectedPrograms.push({
              title: event.title,
              airDate: today,
              airTime: event.time,
              slotNumber: event.slotNumber || 0,
              isFirstBroadcast: event.isFirstBroadcast || false,
              notes: event.notes || '',
              videoReference: event.videoReference || '',
              category: event.category || '旅遊節目',
              duration: event.duration || 30
            });
          });
        }
      }

      return selectedPrograms;
    }

    // 更新本地節目狀態
    function updateLocalProgramStatus(programs, status) {
      programs.forEach(program => {
        const eventKey = `${program.airDate}_${program.airTime}`;
        if (window.calendarEvents && window.calendarEvents[program.airDate]) {
          const event = window.calendarEvents[program.airDate].find(e => e.time === program.airTime);
          if (event) {
            event.uploadStatus = status;
            event.uploadedAt = new Date().toISOString();
          }
        }
      });
      
      // 保存到本地存儲
      if (window.calendarEvents) {
        localStorage.setItem('calendarEvents', JSON.stringify(window.calendarEvents));
      }
    }

    // 檢查系統狀態
    function checkSystemStatus() {
      const status = {
        contentful: typeof contentful !== 'undefined',
        contentfulManagement: typeof contentfulManagement !== 'undefined',
        windowContentfulManagement: typeof window.contentfulManagement !== 'undefined',
        uploadProgramSimple: typeof uploadProgramSimple === 'function'
      };
      
      console.log('系統狀態檢查:', status);
      
      let message = '系統狀態檢查結果:\n\n';
      message += status.contentful ? '✅ Contentful SDK 已載入\n' : '❌ Contentful SDK 未載入\n';
      message += status.contentfulManagement ? '✅ Management SDK 已載入\n' : '❌ Management SDK 未載入\n';
      message += status.windowContentfulManagement ? '✅ window.contentfulManagement 可用\n' : '❌ window.contentfulManagement 不可用\n';
      message += status.uploadProgramSimple ? '✅ 上架功能可用\n' : '❌ 上架功能不可用\n';
      
      // 診斷資訊
      message += '\n診斷資訊:\n';
      message += `- contentful: ${typeof contentful}\n`;
      message += `- contentfulManagement: ${typeof contentfulManagement}\n`;
      message += `- window.contentfulManagement: ${typeof window.contentfulManagement}\n`;
      message += `- uploadProgramSimple: ${typeof uploadProgramSimple}\n`;
      
      if (status.contentful && status.contentfulManagement && status.uploadProgramSimple) {
        message += '\n🎉 系統狀態正常，可以進行真實節目上架！';
        alert(message);
        return true;
      } else {
        message += '\n⚠️ 系統狀態異常，Management SDK 未載入';
        alert(message);
        return false;
      }
    }

    // 將時間轉換為時段範圍
    function getTimeBlock(timeString) {
      if (!timeString) return '12-18';
      
      const hour = parseInt(timeString.split(':')[0]);
      
      if (hour >= 0 && hour < 6) return '00-06';
      if (hour >= 6 && hour < 12) return '06-12';
      if (hour >= 12 && hour < 18) return '12-18';
      if (hour >= 18 && hour < 24) return '18-24';
      
      return '12-18'; // 預設值
    }

    // 清理舊的測試資料
    function clearOldTestData() {
      try {
        const calendarEvents = JSON.parse(localStorage.getItem('calendar_events') || '{}');
        let removedCount = 0;
        
        Object.keys(calendarEvents).forEach(date => {
          calendarEvents[date] = calendarEvents[date].filter(event => {
            // 檢查是否為測試資料
            const isTestData = 
              event.title.includes('加拿大') || 
              event.title.includes('極光') || 
              event.title.includes('寒冰') || 
              event.title.includes('捕魚') ||
              event.title.includes('測試') ||
              event.title.includes('demo') ||
              event.title.includes('Demo');
            
            if (isTestData) {
              removedCount++;
              console.log('移除測試資料:', event.title);
              return false;
            }
            return true;
          });
        });
        
        // 儲存清理後的資料
        localStorage.setItem('calendar_events', JSON.stringify(calendarEvents));
        
        if (removedCount > 0) {
          showStatus(`已清理 ${removedCount} 個測試節目資料`, 'success');
          console.log(`已清理 ${removedCount} 個測試節目資料`);
        } else {
          showStatus('沒有找到需要清理的測試資料', 'info');
        }
        
        return removedCount;
      } catch (error) {
        console.error('清理測試資料失敗:', error);
        showStatus('清理測試資料失敗: ' + error.message, 'error');
        return 0;
      }
    }

    // 檢查 Contentful 內容類型（供按鈕調用）
    async function checkContentfulContentTypes() {
      try {
        showStatus('正在檢查 Contentful 內容類型...', 'info');
        
        // 檢查 Management SDK
        if (typeof contentfulManagement === 'undefined') {
          throw new Error('Management SDK 未載入');
        }

        // 創建 Management 客戶端
        const managementClient = contentfulManagement.createClient({
          accessToken: window.CONTENTFUL_CONFIG?.MANAGEMENT_TOKEN || window.CONTENTFUL_MANAGEMENT_TOKEN
        });

        // 獲取 Space
        const space = await managementClient.getSpace(window.CONTENTFUL_CONFIG?.SPACE_ID || 'os5wf90ljenp');
        
        // 獲取 Environment
        const environment = await space.getEnvironment('master');
        
        // 檢查內容類型
        const contentTypes = await checkAvailableContentTypes(environment);
        
        // 顯示結果在頁面上
        let message = `找到 ${contentTypes.length} 個內容類型：\n\n`;
        contentTypes.forEach(ct => {
          message += `📋 ${ct.name} (${ct.sys.id})\n`;
          message += `   欄位: ${ct.fields.map(f => `${f.name}(${f.id}:${f.type})`).join(', ')}\n\n`;
        });
        
        console.log('Contentful 內容類型:', contentTypes);
        console.log('=== 內容類型詳細資訊 ===');
        console.log(message);
        
        // 在狀態欄顯示結果
        showStatus(`✅ 找到 ${contentTypes.length} 個內容類型，詳情請查看控制台`, 'success');
        
        // 在頁面上創建一個顯示區域
        let displayDiv = document.getElementById('contentTypesDisplay');
        if (!displayDiv) {
          displayDiv = document.createElement('div');
          displayDiv.id = 'contentTypesDisplay';
          displayDiv.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 20px;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
            z-index: 10000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            font-family: monospace;
            white-space: pre-line;
          `;
          document.body.appendChild(displayDiv);
        }
        
        displayDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; color: #007bff;">Contentful 內容類型</h3>
            <button onclick="document.getElementById('contentTypesDisplay').remove()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">關閉</button>
          </div>
          <div style="max-height: 400px; overflow-y: auto;">${message}</div>
        `;
        
      } catch (error) {
        console.error('檢查內容類型失敗:', error);
        showStatus('❌ 檢查內容類型失敗: ' + error.message, 'error');
        alert('檢查內容類型失敗: ' + error.message);
      }
    }

    // 檢查 Contentful 中可用的內容類型
    async function checkAvailableContentTypes(environment) {
      try {
        const contentTypes = await environment.getContentTypes();
        console.log('可用的內容類型:', contentTypes.items.map(ct => ({
          id: ct.sys.id,
          name: ct.name,
          fields: ct.fields.map(f => ({ id: f.id, name: f.name, type: f.type }))
        })));
        return contentTypes.items;
      } catch (error) {
        console.error('獲取內容類型失敗:', error);
        return [];
      }
    }

    // 創建或獲取預設影片 Entry
    async function createOrGetVideoEntry(managementClient, space, environment, programData) {
      try {
        // 先檢查可用的內容類型
        const contentTypes = await checkAvailableContentTypes(environment);
        
        // 尋找影片相關的內容類型
        const videoContentType = contentTypes.find(ct => 
          ct.sys.id === 'video' || 
          ct.sys.id === 'videoAsset' || 
          ct.name.toLowerCase().includes('video') ||
          ct.name.toLowerCase().includes('影片')
        );
        
        if (!videoContentType) {
          console.log('沒有找到影片內容類型，跳過 video 欄位');
          return null;
        }
        
        console.log('找到影片內容類型:', videoContentType.sys.id, videoContentType.name);
        
        // 獲取節目的 YouTube ID
        const youtubeId = programData.youtubeId || programData.youTubeId || '';
        const programTitle = programData.title || '未命名節目';
        
        if (!youtubeId) {
          console.log('節目沒有 YouTube ID，跳過 video 欄位');
          return null;
        }
        
        // 嘗試找到現有的影片 Entry（根據 YouTube ID）
        const existingVideos = await environment.getEntries({
          content_type: videoContentType.sys.id,
          'fields.youTubeId': youtubeId,
          limit: 1
        });
        
        if (existingVideos.items.length > 0) {
          console.log('找到現有影片 Entry (YouTube ID:', youtubeId, '):', existingVideos.items[0].sys.id);
          return existingVideos.items[0].sys.id;
        }
        
        // 如果沒有現有的，創建一個新的影片 Entry
        console.log('創建新的影片 Entry (YouTube ID:', youtubeId, ')...');
        const videoEntryData = {
          fields: {
            'title': { 'en-US': programTitle },
            'videoType': { 'en-US': 'YouTube' },
            'youTubeId': { 'en-US': youtubeId },
            'isHero': { 'en-US': false },
            'heroTitle': { 'en-US': '' },
            'heroText': { 'en-US': '' },
            'isFeatured': { 'en-US': false },
            'featuredText': { 'en-US': '' },
            'comingSoon': { 'en-US': false },
            'releaseDate': { 'en-US': new Date().toISOString() },
            'description': { 'en-US': programData.description || '' }
          }
        };
        
        // 根據內容類型添加必要的欄位
        videoContentType.fields.forEach(field => {
          if (field.required && !videoEntryData.fields[field.id]) {
            if (field.type === 'Text' || field.type === 'ShortText') {
              videoEntryData.fields[field.id] = { 'en-US': '預設值' };
            } else if (field.type === 'Number') {
              videoEntryData.fields[field.id] = { 'en-US': 0 };
            } else if (field.type === 'Boolean') {
              videoEntryData.fields[field.id] = { 'en-US': false };
            }
          }
        });
        
        const videoEntry = await environment.createEntry(videoContentType.sys.id, videoEntryData);
        await videoEntry.publish();
        
        console.log('創建新的影片 Entry 成功 (YouTube ID:', youtubeId, '):', videoEntry.sys.id);
        return videoEntry.sys.id;
        
      } catch (error) {
        console.error('創建或獲取影片 Entry 失敗:', error);
        // 如果創建失敗，返回 null，讓上架函數決定如何處理
        return null;
      }
    }

    // 縮圖相關功能
    function previewThumbnail() {
      const fileInput = document.getElementById('thumbnailFile');
      const imagePreview = document.getElementById('thumbnailImage');
      const placeholder = document.getElementById('thumbnailPlaceholder');
      
      if (fileInput.files && fileInput.files[0]) {
        const file = fileInput.files[0];
        
        // 檢查檔案類型
        if (!file.type.startsWith('image/')) {
          showStatus('請選擇圖片檔案', 'warning');
          return;
        }
        
        // 檢查檔案大小 (限制為 5MB)
        if (file.size > 5 * 1024 * 1024) {
          showStatus('圖片檔案大小不能超過 5MB', 'warning');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          imagePreview.src = e.target.result;
          imagePreview.style.display = 'block';
          placeholder.style.display = 'none';
        };
        reader.readAsDataURL(file);
      }
    }
    
    function clearThumbnail() {
      const fileInput = document.getElementById('thumbnailFile');
      const imagePreview = document.getElementById('thumbnailImage');
      const placeholder = document.getElementById('thumbnailPlaceholder');
      const thumbnailAssetId = document.getElementById('thumbnailAssetId');
      
      fileInput.value = '';
      imagePreview.src = '';
      imagePreview.style.display = 'none';
      placeholder.style.display = 'flex';
      
      // 清除隱藏欄位
      thumbnailAssetId.value = '';
      thumbnailAssetId.removeAttribute('data-youtube-url');
    }
    
    async function generateYouTubeThumbnail() {
      const youtubeId = document.getElementById('youtubeId').value.trim();
      
      if (!youtubeId) {
        showStatus('請先輸入 YouTube ID', 'warning');
        return;
      }
      
      // 驗證 YouTube ID 格式
      const youtubeIdPattern = /^[a-zA-Z0-9_-]{11}$/;
      if (!youtubeIdPattern.test(youtubeId)) {
        showStatus('YouTube ID 格式不正確，應該是 11 個字符', 'warning');
        return;
      }
      
      // 生成 YouTube 縮圖 URL
      const thumbnailUrl = `https://img.youtube.com/vi/${youtubeId}/maxresdefault.jpg`;
      
      // 預覽縮圖
      const imagePreview = document.getElementById('thumbnailImage');
      const placeholder = document.getElementById('thumbnailPlaceholder');
      
      // 先隱藏預覽
      imagePreview.style.display = 'none';
      placeholder.style.display = 'flex';
      placeholder.textContent = '載入中...';
      
      try {
        // 測試縮圖是否可用並上傳到 Contentful
        const testImage = new Image();
        testImage.crossOrigin = 'anonymous'; // 允許跨域
        
        testImage.onload = async function() {
          try {
            // 先顯示預覽
            imagePreview.src = thumbnailUrl;
            imagePreview.style.display = 'block';
            placeholder.style.display = 'none';
            
            // 上傳縮圖到 Contentful
            showStatus('正在上傳 YouTube 縮圖到 Contentful...', 'info');
            const uploadResult = await uploadYouTubeThumbnailToContentful(thumbnailUrl, youtubeId);
            
            if (uploadResult.success) {
              if (uploadResult.isYouTubeUrl) {
                showStatus('YouTube 縮圖已準備就緒，可跨裝置同步！', 'success');
                // 將 YouTube URL 存儲在隱藏欄位中，供上架時使用
                document.getElementById('thumbnailAssetId').value = '';
                // 將 URL 存儲在 data 屬性中
                document.getElementById('thumbnailAssetId').setAttribute('data-youtube-url', uploadResult.url);
              } else {
                showStatus('YouTube 縮圖已上傳到 Contentful，可跨裝置同步！', 'success');
                document.getElementById('thumbnailAssetId').value = uploadResult.assetId;
              }
            } else {
              showStatus('縮圖處理失敗，但預覽正常', 'warning');
            }
          } catch (error) {
            console.error('上傳縮圖失敗:', error);
            showStatus('縮圖預覽成功，但上傳失敗', 'warning');
          }
        };
        
        testImage.onerror = async function() {
          // 如果 maxresdefault 不可用，嘗試 hqdefault
          const fallbackUrl = `https://img.youtube.com/vi/${youtubeId}/hqdefault.jpg`;
          const fallbackImage = new Image();
          fallbackImage.crossOrigin = 'anonymous';
          
          fallbackImage.onload = async function() {
            try {
              // 先顯示預覽
              imagePreview.src = fallbackUrl;
              imagePreview.style.display = 'block';
              placeholder.style.display = 'none';
              
              // 上傳備用縮圖到 Contentful
              showStatus('正在上傳 YouTube 縮圖到 Contentful（備用解析度）...', 'info');
              const uploadResult = await uploadYouTubeThumbnailToContentful(fallbackUrl, youtubeId);
              
              if (uploadResult.success) {
                if (uploadResult.isYouTubeUrl) {
                  showStatus('YouTube 縮圖已準備就緒，可跨裝置同步！', 'success');
                  document.getElementById('thumbnailAssetId').value = '';
                  document.getElementById('thumbnailAssetId').setAttribute('data-youtube-url', uploadResult.url);
                } else {
                  showStatus('YouTube 縮圖已上傳到 Contentful，可跨裝置同步！', 'success');
                  document.getElementById('thumbnailAssetId').value = uploadResult.assetId;
                }
              } else {
                showStatus('縮圖處理失敗，但預覽正常', 'warning');
              }
            } catch (error) {
              console.error('上傳備用縮圖失敗:', error);
              showStatus('縮圖預覽成功，但上傳失敗', 'warning');
            }
          };
          
          fallbackImage.onerror = function() {
            placeholder.textContent = '無法載入 YouTube 縮圖';
            showStatus('無法載入 YouTube 縮圖，請檢查 ID 是否正確', 'error');
          };
          
          fallbackImage.src = fallbackUrl;
        };
        
        testImage.src = thumbnailUrl;
        
      } catch (error) {
        console.error('生成 YouTube 縮圖失敗:', error);
        showStatus('生成 YouTube 縮圖失敗', 'error');
      }
    }
    
    // 處理 YouTube 縮圖（直接存儲 URL，不上傳到 Contentful）
    async function uploadYouTubeThumbnailToContentful(thumbnailUrl, youtubeId) {
      try {
        // 直接返回成功，使用 YouTube 縮圖 URL
        // 這樣可以避免 Contentful 上傳的複雜性，同時確保跨裝置同步
        return {
          success: true,
          assetId: null, // 不使用 Asset ID
          url: thumbnailUrl, // 直接使用 YouTube 縮圖 URL
          isYouTubeUrl: true // 標記這是 YouTube URL
        };
        
      } catch (error) {
        console.error('處理 YouTube 縮圖失敗:', error);
        return {
          success: false,
          error: error.message
        };
      }
    }
    
    // 上傳縮圖到 Contentful
    async function uploadThumbnailToContentful(file) {
      try {
        if (typeof contentfulManagement === 'undefined') {
          throw new Error('Management SDK 未載入');
        }
        
        const managementClient = contentfulManagement.createClient({
          accessToken: window.CONTENTFUL_CONFIG?.MANAGEMENT_TOKEN || window.CONTENTFUL_MANAGEMENT_TOKEN
        });
        
        const space = await managementClient.getSpace(window.CONTENTFUL_CONFIG?.SPACE_ID || 'os5wf90ljenp');
        const environment = await space.getEnvironment('master');
        
        // 創建 Asset
        const asset = await environment.createAsset({
          fields: {
            title: {
              'en-US': `Thumbnail for ${document.getElementById('title').value || 'Program'}`
            },
            file: {
              'en-US': {
                contentType: file.type,
                fileName: file.name,
                upload: file
              }
            }
          }
        });
        
        // 處理 Asset
        await asset.processForAllLocales();
        
        // 發布 Asset
        await asset.publish();
        
        return {
          success: true,
          assetId: asset.sys.id,
          url: `https:${asset.fields.file['en-US'].url}`
        };
        
      } catch (error) {
        console.error('上傳縮圖失敗:', error);
        return {
          success: false,
          error: error.message
        };
      }
    }

    // 簡化的上架功能（不依賴 contentful-real-only.js）
    async function uploadProgramSimple(programData) {
      try {
        // 檢查 Management SDK
        if (typeof contentfulManagement === 'undefined') {
          throw new Error('Management SDK 未載入');
        }

        // 創建 Management 客戶端
        const managementClient = contentfulManagement.createClient({
          accessToken: window.CONTENTFUL_CONFIG?.MANAGEMENT_TOKEN || window.CONTENTFUL_MANAGEMENT_TOKEN
        });

        // 獲取 Space
        const space = await managementClient.getSpace(window.CONTENTFUL_CONFIG?.SPACE_ID || 'os5wf90ljenp');
        
        // 獲取 Environment
        const environment = await space.getEnvironment('master');
        
        // 檢查是否已存在相同的節目
        const airDate = programData.airDate || new Date().toISOString().split('T')[0];
        const block = getTimeBlock(programData.airTime);
        const slotIndex = programData.slotNumber || 0;
        const airTime = programData.airTime; // 具體時間，如 "23:00"
        
        console.log('檢查重複節目（同一個具體時間段只能有一個節目）:', { title: programData.title, airDate, airTime, block, slotIndex });
        
        // 查詢是否已存在相同日期、具體時間的節目（同一個具體時間段只能有一個節目）
        const existingEntries = await environment.getEntries({
          content_type: 'scheduleItem',
          'fields.airDate': airDate,
          limit: 100 // 增加限制以檢查所有該日期的節目
        });
        
        // 檢查是否有相同具體時間的節目
        const duplicateProgram = existingEntries.items.find(entry => {
          const entryNotes = entry.fields.notes?.['en-US'] || '';
          // 從備註中提取時間，格式為 [時間:XX:XX]
          const timeMatch = entryNotes.match(/\[時間:(\d{2}:\d{2})\]/);
          const entryAirTime = timeMatch ? timeMatch[1] : null;
          // 如果具體時間相同，則認為是重複
          return entryAirTime === airTime;
        });
        
        if (duplicateProgram) {
          console.log('⚠️ 發現重複時間段節目，跳過上架:', duplicateProgram.sys.id, duplicateProgram.fields.title?.['en-US'], '時間:', airTime, '時段區塊:', block);
          return {
            success: true,
            entryId: duplicateProgram.sys.id,
            message: `該時間段 ${airTime} 已有節目，跳過重複上架`,
            skipped: true
          };
        }
        
        // 準備 Entry 數據
        const entryData = {
          fields: {
            'title': { 'en-US': programData.title || '未命名節目' },
            'airDate': { 'en-US': airDate },
            'block': { 'en-US': block },
            'slotIndex': { 'en-US': slotIndex },
            'isPremiere': { 'en-US': programData.isFirstBroadcast || false },
            'notes': { 'en-US': (programData.description || '') + ` [時間:${airTime}]` } // 將具體時間存儲在備註中
          }
        };
        
        // 處理縮圖
        if (programData.thumbnailFile) {
          console.log('上傳縮圖到 Contentful...');
          const thumbnailResult = await uploadThumbnailToContentful(programData.thumbnailFile);
          
          if (thumbnailResult.success) {
            // 添加縮圖 Asset 連結
            entryData.fields['thumbnail'] = {
              'en-US': {
                sys: {
                  type: 'Link',
                  linkType: 'Asset',
                  id: thumbnailResult.assetId
                }
              }
            };
            console.log('縮圖上傳成功:', thumbnailResult.assetId);
          } else {
            console.warn('縮圖上傳失敗:', thumbnailResult.error);
          }
        } else if (programData.thumbnailAssetId) {
          // 如果有 Contentful Asset ID（自訂縮圖已上傳）
          entryData.fields['thumbnail'] = {
            'en-US': {
              sys: {
                type: 'Link',
                linkType: 'Asset',
                id: programData.thumbnailAssetId
              }
            }
          };
          console.log('使用已上傳的 Contentful 縮圖 Asset:', programData.thumbnailAssetId);
        } else if (programData.thumbnailUrl) {
          // 如果是 YouTube 縮圖 URL，直接存儲
          entryData.fields['thumbnailUrl'] = { 'en-US': programData.thumbnailUrl };
          console.log('使用 YouTube 縮圖 URL:', programData.thumbnailUrl);
        }

        // 創建或獲取影片 Entry（使用節目的 YouTube ID）
        const videoEntryId = await createOrGetVideoEntry(managementClient, space, environment, programData);
        
        if (videoEntryId) {
          // 添加 video 欄位
          entryData.fields['video'] = { 
            'en-US': { 
              sys: { 
                type: 'Link', 
                linkType: 'Entry', 
                id: videoEntryId 
              } 
            } 
          };
          console.log('使用影片 Entry ID:', videoEntryId);
        } else {
          console.log('無法創建影片 Entry，跳過 video 欄位');
        }
        
        console.log('準備上架的 Entry 資料:', entryData);

        // 創建 Entry
        const contentTypeId = programData.contentType || 'scheduleItem';
        const entry = await environment.createEntry(contentTypeId, entryData);
        
        // 發布 Entry
        await entry.publish();
        
        return {
          success: true,
          entryId: entry.sys.id,
          message: '節目已成功上架到 Contentful'
        };
        
      } catch (error) {
        console.error('上架失敗:', error);
        console.error('錯誤詳情:', {
          message: error.message,
          stack: error.stack,
          programData: programData
        });
        return {
          success: false,
          error: error.message,
          message: '節目上架失敗: ' + error.message
        };
      }
    }

    // === 全螢幕播放器功能 ===
    let fullscreenPlayerObject = null;

    window.openFullscreenPlayer = function(videoId) {
      console.log('openFullscreenPlayer 被調用，videoId:', videoId);
      
      const fullscreenPlayerEl = document.getElementById('fullscreenPlayer');
      if (!fullscreenPlayerEl) {
        console.error('找不到 fullscreenPlayer 元素');
        return;
      }

      // 防止頁面滾動
      document.body.style.overflow = 'hidden';
      
      // 顯示播放器
      fullscreenPlayerEl.classList.add('active');
      console.log('播放器容器已顯示');

      // 創建 YouTube 播放器
      if (window.YT && window.YT.Player) {
        console.log('YouTube API 已載入，直接創建播放器');
        createYouTubePlayer(videoId);
      } else {
        console.log('YouTube API 未載入，開始載入...');
        // 如果 YouTube API 還沒載入，先載入
        loadYouTubeAPI().then(() => {
          console.log('YouTube API 載入成功');
          createYouTubePlayer(videoId);
        }).catch(error => {
          console.error('YouTube API 載入失敗:', error);
          showStatus('無法載入影片播放器，請稍後再試', 'error');
        });
      }
    }

    window.createYouTubePlayer = function(videoId) {
      console.log('createYouTubePlayer 被調用，videoId:', videoId);
      
      const fullscreenPlayerEl = document.getElementById('fullscreenPlayer');
      const playerDiv = document.getElementById('main-player');
      
      if (!playerDiv) {
        console.error('找不到 main-player 元素');
        return;
      }
      
      if (fullscreenPlayerObject) {
        console.log('銷毀現有播放器');
        fullscreenPlayerObject.destroy();
      }

      console.log('創建新的 YouTube 播放器...');
      try {
        fullscreenPlayerObject = new YT.Player('main-player', {
          width: '100%',
          height: '100%',
          videoId: videoId,
          playerVars: {
            autoplay: 1,
            controls: 1,
            rel: 0,
            modestbranding: 1,
            fs: 1,
            enablejsapi: 1
          },
          events: {
            onReady: function(event) {
              console.log('YouTube 播放器準備就緒');
              event.target.setPlaybackQuality('highres');
              event.target.playVideo();
            },
            onError: function(event) {
              console.error('YouTube 播放器錯誤:', event.data);
              showStatus('影片播放失敗，請檢查影片 ID 是否正確', 'error');
            }
          }
        });
        console.log('YouTube 播放器創建成功');
      } catch (error) {
        console.error('創建 YouTube 播放器時發生錯誤:', error);
        showStatus('播放器創建失敗: ' + error.message, 'error');
      }
    }

    window.loadYouTubeAPI = function() {
      return new Promise((resolve, reject) => {
        console.log('loadYouTubeAPI 被調用');
        
        if (window.YT && window.YT.Player) {
          console.log('YouTube API 已經載入');
          resolve();
          return;
        }

        console.log('開始載入 YouTube IFrame API...');
        
        // 載入 YouTube IFrame API
        const tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // 設定全域回調
        window.onYouTubeIframeAPIReady = function() {
          console.log('YouTube API 載入完成');
          resolve();
        };

        // 設定超時
        setTimeout(() => {
          console.error('YouTube API 載入超時');
          reject(new Error('YouTube API 載入超時'));
        }, 10000);
      });
    }

    window.closeFullscreenPlayer = function() {
      const fullscreenPlayerEl = document.getElementById('fullscreenPlayer');
      if (!fullscreenPlayerEl) return;

      // 恢復頁面滾動
      document.body.style.overflow = '';
      
      // 隱藏播放器
      fullscreenPlayerEl.classList.remove('active');

      // 銷毀播放器
      if (fullscreenPlayerObject) {
        fullscreenPlayerObject.destroy();
        fullscreenPlayerObject = null;
      }
    }

    // 播放按鈕事件監聽
    document.addEventListener('click', function(e) {
      if (e.target && e.target.classList.contains('watch-btn')) {
        e.stopPropagation();
        const videoId = e.target.getAttribute('data-video-id');
        if (videoId) {
          console.log('播放影片 ID:', videoId);
          openFullscreenPlayer(videoId);
        } else {
          console.error('找不到影片 ID');
        }
      }
    });

    // 節目卡片點擊事件監聽
    document.addEventListener('click', function(e) {
      const eventCard = e.target.closest('.event');
      if (eventCard) {
        const videoId = eventCard.getAttribute('data-video-id');
        const isCurrent = eventCard.getAttribute('data-is-current') === 'true';
        const date = eventCard.getAttribute('data-date');
        const time = eventCard.getAttribute('data-time');
        
        console.log('點擊節目卡片:', { videoId, isCurrent, date, time });
        
        if (videoId && isCurrent) {
          console.log('播放現正播出的節目:', videoId);
          openFullscreenPlayer(videoId);
        } else if (date && time) {
          console.log('打開編輯模態框:', date, time);
          openEventModal(date, time);
        }
      }
    });

    // 關閉按鈕事件監聽
    document.addEventListener('click', function(e) {
      if (e.target && e.target.classList.contains('close-player-btn')) {
        closeFullscreenPlayer();
      }
    });

    // ESC 鍵關閉播放器
    window.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeFullscreenPlayer();
      }
    });

    // 點擊播放器背景關閉
    document.getElementById('fullscreenPlayer')?.addEventListener('click', function(e) {
      if (e.target === this) {
        closeFullscreenPlayer();
      }
    });

    // 測試播放功能
    window.testPlayback = function() {
      console.log('測試播放功能');
      const testVideoId = '3GZCJfIOg_k'; // 使用測試影片 ID
      openFullscreenPlayer(testVideoId);
    };
  </script>
</body>
</html>
