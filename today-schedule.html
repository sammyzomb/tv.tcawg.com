<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>今日節目表 - 航向世界旅遊頻道</title>
  
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  
  <!-- Contentful SDK -->
  <script src="https://cdn.jsdelivr.net/npm/contentful@latest/dist/contentful.browser.min.js"></script>
  <script src="browser-config.js"></script>
  <script>
    // 確保配置載入
    console.log('Contentful 配置:', window.CONTENTFUL_CONFIG);
    console.log('Contentful SDK 狀態:', typeof contentful);
  </script>
  <style>
    /* 今日節目表專用樣式 */
    .today-schedule-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
    }

    .schedule-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .calendar-icon {
      width: 40px;
      height: 40px;
      background: #2b71d2;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
    }

    .header-title {
      font-size: 28px;
      font-weight: 700;
      color: #2b71d2;
      margin: 0;
    }

    .header-right {
      text-align: right;
      color: #6c757d;
    }

    .time-info {
      font-size: 14px;
      margin-bottom: 5px;
    }

    .current-time {
      font-size: 18px;
      font-weight: 600;
      color: #2b71d2;
    }

    .schedule-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      position: relative;
    }

    .schedule-carousel {
      display: flex;
      gap: 20px;
      overflow-x: auto;
      scroll-behavior: smooth;
      padding: 10px 0;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .schedule-carousel::-webkit-scrollbar {
      display: none;
    }

    .program-card {
      min-width: 320px;
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      position: relative;
      border: 3px solid transparent;
    }

    .program-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    }

    .program-card.current {
      border-color: #dc3545;
      box-shadow: 0 0 20px rgba(220, 53, 69, 0.3);
    }

    .program-image {
      position: relative;
      height: 200px;
      overflow: hidden;
    }

    .program-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .program-card:hover .program-image img {
      transform: scale(1.05);
    }

    .time-badge {
      position: absolute;
      top: 15px;
      left: 15px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
    }

    .status-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      background: #dc3545;
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .program-info {
      padding: 20px;
    }

    .program-title {
      font-size: 18px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .program-description {
      color: #6c757d;
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 15px;
    }

    .program-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .category-tag {
      background: #dc3545;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .duration-info {
      display: flex;
      align-items: center;
      gap: 5px;
      color: #6c757d;
      font-size: 12px;
    }

    .scroll-indicators {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 30px;
    }

    .indicator-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #dee2e6;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .indicator-dot.active {
      background: #2b71d2;
      transform: scale(1.2);
    }

    /* 播放按鈕樣式 */
    .play-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .program-card:hover .play-overlay {
      opacity: 1;
    }
    
    .play-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(43, 113, 210, 0.9);
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    .play-btn:hover {
      background: rgba(43, 113, 210, 1);
      transform: scale(1.1);
    }
    
    /* 觀看按鈕樣式 */
    .watch-btn {
      background: #2b71d2;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
      width: 100%;
    }
    
    .watch-btn:hover {
      background: #1e5bb8;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(43, 113, 210, 0.3);
    }

    /* 全螢幕播放器樣式 */
    .fullscreen-player {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    
    .fullscreen-player.active {
      display: flex;
    }
    
    .close-player-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      font-size: 30px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s ease;
    }
    
    .close-player-btn:hover {
      background: rgba(0, 0, 0, 0.9);
    }
    
    #main-player {
      width: 100%;
      height: 100%;
    }

    .scroll-arrows {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.9);
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      z-index: 10;
    }

    .scroll-arrows:hover {
      background: white;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .scroll-left {
      left: 20px;
    }

    .scroll-right {
      right: 20px;
    }

    .scroll-arrows svg {
      width: 20px;
      height: 20px;
      color: #6c757d;
    }

    /* 響應式設計 */
    @media (max-width: 768px) {
      .schedule-header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
      }

      .header-title {
        font-size: 24px;
      }

      .program-card {
        min-width: 280px;
      }

      .scroll-arrows {
        display: none;
      }
    }

    @media (max-width: 480px) {
      .today-schedule-container {
        padding: 10px;
      }

      .schedule-content {
        padding: 20px;
      }

      .program-card {
        min-width: 250px;
      }

      .header-title {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>

  <!-- 導覽列 -->
  <div class="navbar">
    <a class="logo" href="index.html">
      <img src="logo.png" alt="航向世界旅遊頻道 LOGO" />
    </a>
    
    <nav class="desktop-nav">
      <a href="index.html">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9L12 2L21 9V20a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        <span class="nav-text">首頁</span>
      </a>
      <a href="videos.html">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><path d="M8 21h8m-4-4v4"/></svg>
        <span class="nav-text">所有節目</span>
      </a>
      <a href="schedule.html">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        <span class="nav-text">節目表</span>
      </a>
      <a href="topics.html">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <span class="nav-text">主題探索</span>
      </a>
    </nav>

    <div class="nav-actions">
      <a href="login.html" class="login-link">
        <svg class="nav-icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="7" r="4.5" stroke-width="2"/><ellipse cx="10" cy="15.2" rx="6.8" ry="3.2" stroke-width="2"/></svg>
        <span class="nav-text">會員登入</span>
      </a>
    </div>
  </div>

  <!-- 今日節目表主要內容 -->
  <div class="today-schedule-container">
    
    <!-- 頁面標題區塊 -->
    <div class="schedule-header">
      <div class="header-left">
        <div class="calendar-icon">
          📅
        </div>
        <h1 class="header-title">今日節目表</h1>
      </div>
      
      <div class="header-right">
        <div class="time-info">台灣時間</div>
        <div class="time-info" id="currentDate">9月2日 星期二</div>
        <div class="time-info">現在時間 <span class="current-time" id="currentTime">12:46</span></div>
        <button onclick="testPlayback()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-left: 10px; cursor: pointer;">測試播放</button>
      </div>
    </div>

    <!-- 節目表內容區塊 -->
    <div class="schedule-content">
      
      <!-- 滾動箭頭 -->
      <button class="scroll-arrows scroll-left" id="scrollLeft">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15,18 9,12 15,6"></polyline>
        </svg>
      </button>
      
      <button class="scroll-arrows scroll-right" id="scrollRight">
        <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="9,18 15,12 9,6"></polyline>
        </svg>
      </button>

      <!-- 節目輪播 -->
      <div class="schedule-carousel" id="scheduleCarousel">
        <!-- 節目卡片將由 JavaScript 動態生成 -->
      </div>

      <!-- 滾動指示器 -->
      <div class="scroll-indicators" id="scrollIndicators">
        <!-- 指示點將由 JavaScript 動態生成 -->
      </div>
    </div>
  </div>

  <script>
    // 今日節目表 JavaScript
    document.addEventListener('DOMContentLoaded', () => {
      let currentProgramIndex = 0;
      let programs = [];
      
      // 將 programs 設為全域變數，方便調試
      window.programs = programs;
      
      // 初始化
      initTodaySchedule();
      
      // 初始化今日節目表
      async function initTodaySchedule() {
        await loadPrograms();
        updateDateTime();
        renderPrograms();
        setupEventListeners();
        
        // 每分鐘更新時間
        setInterval(updateDateTime, 60000);
        
        // 每30秒檢查節目狀態
        setInterval(checkProgramStatus, 30000);
      }
      
      // 從 Contentful 載入節目數據
      async function loadProgramsFromContentful() {
        try {
          // 檢查 Contentful SDK 是否載入
          if (typeof contentful === 'undefined') {
            throw new Error('Contentful SDK 未載入');
          }
          
          // 創建 Contentful 客戶端
          const client = contentful.createClient({
            space: window.CONTENTFUL_CONFIG?.SPACE_ID || 'os5wf90ljenp',
            accessToken: window.CONTENTFUL_CONFIG?.DELIVERY_TOKEN || 'lODH-WLwHwVZv7O4rFdBWjSnrzaQWGD4koeOZ1Dypj0'
          });
          
          // 獲取台灣時間的今天日期
          const now = new Date();
          const taiwanTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
          const todayString = taiwanTime.toISOString().split('T')[0];
          
          console.log('從 Contentful 載入今日節目 (台灣時間):', todayString);
          
          // 查詢今日的節目 - 嘗試多種查詢方式
          let response;
          try {
            // 方式1：使用 airDate 欄位
            response = await client.getEntries({
              content_type: 'scheduleItem',
              'fields.airDate': todayString,
              include: 2
            });
            console.log('方式1 (airDate) 查詢結果:', response.items?.length || 0, '個節目');
          } catch (error) {
            console.log('方式1 查詢失敗，嘗試方式2:', error.message);
          }
          
          // 如果方式1沒有結果，嘗試方式2：查詢所有 scheduleItem
          if (!response || !response.items || response.items.length === 0) {
            try {
              response = await client.getEntries({
                content_type: 'scheduleItem',
                include: 2,
                limit: 100
              });
              console.log('方式2 (所有 scheduleItem) 查詢結果:', response.items?.length || 0, '個節目');
            } catch (error) {
              console.log('方式2 查詢也失敗:', error.message);
              throw error;
            }
          }
          
          console.log('Contentful 回應:', response);
          
          // 轉換 Contentful 資料格式
          programs = response.items.map(entry => {
            const fields = entry.fields;
            
            // 從備註中提取時間
            const notes = fields.notes?.['en-US'] || '';
            const timeMatch = notes.match(/\[時間:(\d{2}:\d{2})\]/);
            const airTime = timeMatch ? timeMatch[1] : '00:00';
            
            console.log('處理節目:', {
              title: fields.title?.['en-US'],
              airDate: fields.airDate?.['en-US'],
              notes: notes,
              extractedTime: airTime
            });
            
            // 處理縮圖
            let thumbnail = 'https://images.unsplash.com/photo-1485846234645-a62644f84728?w=400&h=225&fit=crop';
            
            console.log('處理節目縮圖:', fields.title?.['en-US'], {
              hasThumbnail: !!(fields.thumbnail && fields.thumbnail['en-US']),
              hasThumbnailUrl: !!(fields.thumbnailUrl && fields.thumbnailUrl['en-US']),
              thumbnailAsset: fields.thumbnail?.['en-US'],
              thumbnailUrl: fields.thumbnailUrl?.['en-US']
            });
            
            // 如果有縮圖 Asset
            if (fields.thumbnail && fields.thumbnail['en-US']) {
              const thumbnailAsset = fields.thumbnail['en-US'];
              if (thumbnailAsset.fields && thumbnailAsset.fields.file) {
                thumbnail = 'https:' + thumbnailAsset.fields.file['en-US'].url;
                console.log('使用 Contentful Asset 縮圖:', thumbnail);
              }
            }
            // 如果有縮圖 URL
            else if (fields.thumbnailUrl && fields.thumbnailUrl['en-US']) {
              thumbnail = fields.thumbnailUrl['en-US'];
              console.log('使用 YouTube URL 縮圖:', thumbnail);
            }
            // 如果有 video 欄位，嘗試從中提取 YouTube ID
            else if (fields.video && fields.video['en-US']) {
              const videoEntry = fields.video['en-US'];
              if (videoEntry.fields && videoEntry.fields.youTubeId && videoEntry.fields.youTubeId['en-US']) {
                const youtubeId = videoEntry.fields.youTubeId['en-US'];
                thumbnail = `https://img.youtube.com/vi/${youtubeId}/maxresdefault.jpg`;
                console.log('使用 Video Entry 中的 YouTube 縮圖:', thumbnail);
              }
            }
            // 從備註中提取 YouTube ID（如果有的話）
            else {
              const youtubeIdMatch = notes.match(/\[YouTube:([a-zA-Z0-9_-]+)\]/);
              if (youtubeIdMatch) {
                const youtubeId = youtubeIdMatch[1];
                thumbnail = `https://img.youtube.com/vi/${youtubeId}/maxresdefault.jpg`;
                console.log('從備註中提取 YouTube 縮圖:', thumbnail);
              }
            }
            
            // 提取 YouTube ID
            let youtubeId = '';
            const youtubeIdMatch = notes.match(/\[YouTube:([a-zA-Z0-9_-]+)\]/);
            if (youtubeIdMatch) {
              youtubeId = youtubeIdMatch[1];
            }
            
            return {
              time: airTime,
              title: fields.title?.['en-US'] || '未命名節目',
              duration: "30", // 預設 30 分鐘
              category: "旅遊節目",
              description: notes.replace(/\[時間:\d{2}:\d{2}\]/, '').replace(/\[YouTube:[a-zA-Z0-9_-]+\]/, '').trim() || '節目描述',
              thumbnail: thumbnail,
              youtubeId: youtubeId,
              status: "published"
            };
          });
          
          // 按時間排序
          programs.sort((a, b) => a.time.localeCompare(b.time));
          
          // 更新全域變數
          window.programs = programs;
          
          console.log('從 Contentful 載入節目成功:', programs.length, '個節目');
          console.log('節目縮圖資料:', programs.map(p => ({title: p.title, thumbnail: p.thumbnail})));
          
        } catch (error) {
          console.error('從 Contentful 載入節目失敗:', error);
          throw error;
        }
      }
      
      // 載入節目數據
      async function loadPrograms() {
        try {
          // 優先從 Contentful 載入節目數據
          await loadProgramsFromContentful();
          
          // 如果 Contentful 載入成功，保存到 localStorage 作為備份
          if (programs.length > 0) {
            localStorage.setItem('todayPrograms', JSON.stringify(programs));
            console.log('✅ 節目資料已保存到 localStorage 作為備份');
          }
          
        } catch (error) {
          console.error('從 Contentful 載入節目數據失敗:', error);
          
          // 嘗試從 localStorage 載入備份資料
          try {
            const backupData = localStorage.getItem('todayPrograms');
            if (backupData) {
              programs = JSON.parse(backupData);
              console.log('✅ 從 localStorage 載入備份節目資料:', programs.length, '個節目');
              return;
            }
          } catch (backupError) {
            console.error('從 localStorage 載入備份資料失敗:', backupError);
          }
          
          // 如果 localStorage 也沒有資料，嘗試從 schedule.json 載入
          try {
            const response = await fetch('schedule.json');
            const data = await response.json();
            const schedulePrograms = data.today.schedule || [];
            console.log('從 schedule.json 載入節目成功:', schedulePrograms.length, '個節目');
            
          // 生成完整的節目表（從當前時間開始的24個時段）
          const now = new Date();
          const taiwanTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
          const currentHour = taiwanTime.getUTCHours();
          const currentMinute = taiwanTime.getUTCMinutes();
          
          programs = [];
          const startHour = currentHour;
          const startMinute = currentMinute < 30 ? 0 : 1; // 計算當前時段（每30分鐘一個時段）
          
          // 生成24個時段的節目（12個小時）
          for (let i = 0; i < 24; i++) {
            const hour = (startHour + Math.floor(i / 2)) % 24;
            const minute = ((startMinute + i) % 2) * 30;
            const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            
            // 檢查是否有預設的節目安排
            const existingProgram = schedulePrograms.find(p => p.time === timeString);
            
            if (existingProgram) {
              programs.push(existingProgram);
            } else {
              programs.push({
                time: timeString,
                title: "目前暫無節目",
                duration: "30",
                category: "空檔",
                description: "此時段暫無節目安排",
                thumbnail: "https://images.unsplash.com/photo-1485846234645-a62644f84728?w=400&h=225&fit=crop",
                youtubeId: "",
                status: "空檔",
                tags: []
              });
            }
          }
          
          } catch (jsonError) {
            console.error('載入 schedule.json 失敗:', jsonError);
          }
          
          // 如果所有載入都失敗，使用預設數據
          const now = new Date();
          const taiwanTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
          const currentHour = taiwanTime.getUTCHours();
          const currentMinute = taiwanTime.getUTCMinutes();
          
          programs = [];
          const startHour = currentHour;
          const startMinute = currentMinute < 30 ? 0 : 1;
          
          for (let i = 0; i < 24; i++) {
            const hour = (startHour + Math.floor(i / 2)) % 24;
            const minute = ((startMinute + i) % 2) * 30;
            const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            
            programs.push({
              time: timeString,
              title: "目前暫無節目",
              duration: "30",
              category: "空檔",
              description: "此時段暫無節目安排",
              thumbnail: "https://images.unsplash.com/photo-1485846234645-a62644f84728?w=400&h=225&fit=crop",
              youtubeId: "",
              status: "空檔",
              tags: []
            });
          }
        }
        }
        
        // 更新全域變數
        window.programs = programs;
        console.log('最終載入的節目數據:', programs);
      }
      
      // 更新日期和時間
      function updateDateTime() {
        const now = new Date();
        const taiwanTime = new Date(now.getTime() + (8 * 60 * 60 * 1000)); // UTC+8
        
        const month = taiwanTime.getUTCMonth() + 1;
        const date = taiwanTime.getUTCDate();
        const day = ['日', '一', '二', '三', '四', '五', '六'][taiwanTime.getUTCDay()];
        const hours = String(taiwanTime.getUTCHours()).padStart(2, '0');
        const minutes = String(taiwanTime.getUTCMinutes()).padStart(2, '0');
        
        document.getElementById('currentDate').textContent = `${month}月${date}日 星期${day}`;
        document.getElementById('currentTime').textContent = `${hours}:${minutes}`;
      }
      
      // 渲染節目
      function renderPrograms() {
        const carousel = document.getElementById('scheduleCarousel');
        const indicators = document.getElementById('scrollIndicators');
        
        if (!carousel || !indicators) return;
        
        // 過濾節目：只顯示當前和未來的節目
        const visiblePrograms = programs.filter(shouldShowProgram);
        
        // 渲染節目卡片
        carousel.innerHTML = visiblePrograms.map((program, index) => {
          const isCurrent = isCurrentProgram(program);
          return createProgramCard(program, index, isCurrent);
        }).join('');
        
        // 渲染指示器
        indicators.innerHTML = visiblePrograms.map((_, index) => 
          `<div class="indicator-dot ${index === 0 ? 'active' : ''}" data-index="${index}"></div>`
        ).join('');
        
        // 更新當前節目索引
        currentProgramIndex = visiblePrograms.findIndex(p => isCurrentProgram(p));
        if (currentProgramIndex === -1) currentProgramIndex = 0;
        
        updateActiveIndicator();
      }
      
      // 創建節目卡片
      function createProgramCard(program, index, isCurrent) {
        return `
          <div class="program-card ${isCurrent ? 'current' : ''}" data-index="${index}">
            <div class="program-image">
              <img src="${program.thumbnail}" alt="${program.title}" onerror="this.src='https://via.placeholder.com/320x200/000000/ffffff?text=節目圖片'">
              <div class="time-badge">${program.time}</div>
              ${isCurrent ? '<div class="status-badge"><span class="status-dot"></span>現正播出</div>' : ''}
              ${program.youtubeId ? '<div class="play-overlay"><button class="play-btn" data-video-id="' + program.youtubeId + '">▶</button></div>' : ''}
            </div>
            <div class="program-info">
              <div class="program-title">${program.title}</div>
              <div class="program-description">${program.description}</div>
              <div class="program-meta">
                <span class="category-tag">${program.category}</span>
                <div class="duration-info">
                  <span>⏱</span>
                  <span>${program.duration}分鐘</span>
                </div>
              </div>
              ${program.youtubeId ? '<button class="watch-btn" data-video-id="' + program.youtubeId + '">立即觀看</button>' : ''}
            </div>
          </div>
        `;
      }
      
      // 檢查節目狀態
      function checkProgramStatus() {
        // 重新渲染節目表以過濾已結束的節目
        renderPrograms();
        
        // 更新當前節目索引
        const visiblePrograms = programs.filter(shouldShowProgram);
        currentProgramIndex = visiblePrograms.findIndex(p => isCurrentProgram(p));
        if (currentProgramIndex === -1) currentProgramIndex = 0;
        
        updateActiveIndicator();
      }
      
      // 判斷是否為當前節目
      function isCurrentProgram(program) {
        const now = new Date();
        const taiwanTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
        const currentTime = taiwanTime.getUTCHours() * 60 + taiwanTime.getUTCMinutes();
        
        const [programHour, programMinute] = program.time.split(':').map(Number);
        const programStartTime = programHour * 60 + programMinute;
        const programEndTime = programStartTime + parseInt(program.duration);
        
        return currentTime >= programStartTime && currentTime < programEndTime;
      }
      
      // 判斷是否應該顯示節目（只顯示當前和未來節目）
      function shouldShowProgram(program) {
        const now = new Date();
        const taiwanTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
        const currentTime = taiwanTime.getUTCHours() * 60 + taiwanTime.getUTCMinutes();
        
        const [programHour, programMinute] = program.time.split(':').map(Number);
        const programStartTime = programHour * 60 + programMinute;
        const programEndTime = programStartTime + parseInt(program.duration);
        
        // 只顯示當前時間 < 節目結束時間的節目（包括正在播放的節目）
        return currentTime < programEndTime;
      }
      
      // 設置事件監聽器
      function setupEventListeners() {
        // 滾動箭頭
        document.getElementById('scrollLeft')?.addEventListener('click', () => {
          scrollToProgram(currentProgramIndex - 1);
        });
        
        document.getElementById('scrollRight')?.addEventListener('click', () => {
          scrollToProgram(currentProgramIndex + 1);
        });
        
        // 指示器點擊
        document.getElementById('scrollIndicators')?.addEventListener('click', (e) => {
          if (e.target.classList.contains('indicator-dot')) {
            const index = parseInt(e.target.dataset.index);
            scrollToProgram(index);
          }
        });
        
        // 節目卡片點擊
        document.getElementById('scheduleCarousel')?.addEventListener('click', (e) => {
          const card = e.target.closest('.program-card');
          if (card) {
            const index = parseInt(card.dataset.index);
            const program = programs[index];
            console.log('點擊節目:', program.title);
            // 這裡可以添加播放節目的邏輯
          }
        });

        // 播放按鈕點擊事件
        document.addEventListener('click', (e) => {
          if (e.target.classList.contains('play-btn') || e.target.classList.contains('watch-btn')) {
            e.stopPropagation();
            const videoId = e.target.getAttribute('data-video-id');
            if (videoId) {
              console.log('播放影片 ID:', videoId);
              openFullscreenPlayer(videoId);
            } else {
              console.error('找不到影片 ID');
            }
          }
        });
      }
      
      // 滾動到指定節目
      function scrollToProgram(index) {
        if (index < 0) index = programs.length - 1;
        if (index >= programs.length) index = 0;
        
        const carousel = document.getElementById('scheduleCarousel');
        const card = carousel.querySelector(`[data-index="${index}"]`);
        
        if (card) {
          card.scrollIntoView({
            behavior: 'smooth',
            block: 'nearest',
            inline: 'center'
          });
          
          currentProgramIndex = index;
          updateActiveIndicator();
        }
      }
      
      // 更新活動指示器
      function updateActiveIndicator() {
        document.querySelectorAll('.indicator-dot').forEach((dot, index) => {
          dot.classList.toggle('active', index === currentProgramIndex);
        });
      }

      // === 全螢幕播放器功能 ===
      let fullscreenPlayerObject = null;

      function openFullscreenPlayer(videoId) {
        console.log('openFullscreenPlayer 被調用，videoId:', videoId);
        
        const fullscreenPlayerEl = document.getElementById('fullscreenPlayer');
        if (!fullscreenPlayerEl) {
          console.error('找不到 fullscreenPlayer 元素');
          return;
        }

        // 防止頁面滾動
        document.body.style.overflow = 'hidden';
        
        // 顯示播放器
        fullscreenPlayerEl.classList.add('active');
        console.log('播放器容器已顯示');

        // 創建 YouTube 播放器
        if (window.YT && window.YT.Player) {
          console.log('YouTube API 已載入，直接創建播放器');
          createYouTubePlayer(videoId);
        } else {
          console.log('YouTube API 未載入，開始載入...');
          // 如果 YouTube API 還沒載入，先載入
          loadYouTubeAPI().then(() => {
            console.log('YouTube API 載入成功');
            createYouTubePlayer(videoId);
          }).catch(error => {
            console.error('YouTube API 載入失敗:', error);
            showErrorMessage('無法載入影片播放器，請稍後再試');
          });
        }
      }

      function createYouTubePlayer(videoId) {
        console.log('createYouTubePlayer 被調用，videoId:', videoId);
        
        const fullscreenPlayerEl = document.getElementById('fullscreenPlayer');
        const playerDiv = document.getElementById('main-player');
        
        if (!playerDiv) {
          console.error('找不到 main-player 元素');
          return;
        }
        
        if (fullscreenPlayerObject) {
          console.log('銷毀現有播放器');
          fullscreenPlayerObject.destroy();
        }

        console.log('創建新的 YouTube 播放器...');
        try {
          fullscreenPlayerObject = new YT.Player('main-player', {
            width: '100%',
            height: '100%',
            videoId: videoId,
            playerVars: {
              autoplay: 1,
              controls: 1,
              rel: 0,
              modestbranding: 1,
              fs: 1,
              enablejsapi: 1
            },
            events: {
              onReady: function(event) {
                console.log('YouTube 播放器準備就緒');
                event.target.setPlaybackQuality('highres');
                event.target.playVideo();
              },
              onError: function(event) {
                console.error('YouTube 播放器錯誤:', event.data);
                showErrorMessage('影片播放失敗，請檢查影片 ID 是否正確');
              }
            }
          });
          console.log('YouTube 播放器創建成功');
        } catch (error) {
          console.error('創建 YouTube 播放器時發生錯誤:', error);
          showErrorMessage('播放器創建失敗: ' + error.message);
        }
      }

      function loadYouTubeAPI() {
        return new Promise((resolve, reject) => {
          console.log('loadYouTubeAPI 被調用');
          
          if (window.YT && window.YT.Player) {
            console.log('YouTube API 已經載入');
            resolve();
            return;
          }

          console.log('開始載入 YouTube IFrame API...');
          
          // 載入 YouTube IFrame API
          const tag = document.createElement('script');
          tag.src = 'https://www.youtube.com/iframe_api';
          const firstScriptTag = document.getElementsByTagName('script')[0];
          firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

          // 設定全域回調
          window.onYouTubeIframeAPIReady = function() {
            console.log('YouTube API 載入完成');
            resolve();
          };

          // 設定超時
          setTimeout(() => {
            console.error('YouTube API 載入超時');
            reject(new Error('YouTube API 載入超時'));
          }, 10000);
        });
      }

      function closeFullscreenPlayer() {
        const fullscreenPlayerEl = document.getElementById('fullscreenPlayer');
        if (!fullscreenPlayerEl) return;

        // 恢復頁面滾動
        document.body.style.overflow = '';
        
        // 隱藏播放器
        fullscreenPlayerEl.classList.remove('active');

        // 銷毀播放器
        if (fullscreenPlayerObject) {
          fullscreenPlayerObject.destroy();
          fullscreenPlayerObject = null;
        }
      }

      function showErrorMessage(message) {
        // 簡單的錯誤訊息顯示
        alert(message);
        closeFullscreenPlayer();
      }

      // 關閉按鈕事件監聽
      document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('close-player-btn')) {
          closeFullscreenPlayer();
        }
      });

      // ESC 鍵關閉播放器
      window.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeFullscreenPlayer();
        }
      });

      // 點擊播放器背景關閉
      document.getElementById('fullscreenPlayer')?.addEventListener('click', function(e) {
        if (e.target === this) {
          closeFullscreenPlayer();
        }
      });

      // 測試播放功能
      window.testPlayback = function() {
        console.log('測試播放功能');
        const testVideoId = '3GZCJfIOg_k'; // 使用預設的測試影片 ID
        openFullscreenPlayer(testVideoId);
      };
    });
  </script>

  <!-- 全螢幕播放器 -->
  <div class="fullscreen-player" id="fullscreenPlayer">
    <button class="close-player-btn" title="關閉播放器">&times;</button>
    <div id="main-player"></div>
  </div>
</body>
</html>
