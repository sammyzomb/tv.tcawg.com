<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç™»å…¥æ—¥èªŒç®¡ç† - èˆªå‘ä¸–ç•Œæ—…éŠé »é“</title>
  <script src="https://cdn.jsdelivr.net/npm/contentful@latest/dist/contentful.browser.min.js"></script>
  <script src="browser-config.js"></script>
  <script src="admin-login-audit.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: #f5f7fa;
      color: #333;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .stat-label {
      color: #666;
      font-size: 0.9rem;
    }
    
    .controls {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .search-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      align-items: end;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group label {
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
    }
    
    .form-group input, .form-group select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5a6fd8;
    }
    
    .btn-danger {
      background: #e74c3c;
      color: white;
    }
    
    .btn-danger:hover {
      background: #c0392b;
    }
    
    .btn-success {
      background: #27ae60;
      color: white;
    }
    
    .btn-success:hover {
      background: #229954;
    }
    
    .logs-table {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .table-header {
      background: #f8f9fa;
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .table-title {
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .table-actions {
      display: flex;
      gap: 10px;
    }
    
    .logs-container {
      max-height: 600px;
      overflow-y: auto;
    }
    
    .log-entry {
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr 100px 80px;
      gap: 15px;
      align-items: center;
      font-size: 14px;
    }
    
    .log-entry:hover {
      background: #f8f9fa;
    }
    
    .log-entry:last-child {
      border-bottom: none;
    }
    
    .log-timestamp {
      color: #666;
      font-size: 12px;
    }
    
    .log-email {
      font-weight: 500;
    }
    
    .log-ip {
      font-family: monospace;
      color: #667eea;
    }
    
    .log-password {
      font-family: monospace;
      color: #666;
    }
    
    .log-success {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      text-align: center;
    }
    
    .log-success.true {
      background: #d4edda;
      color: #155724;
    }
    
    .log-success.false {
      background: #f8d7da;
      color: #721c24;
    }
    
    .blocked-ips {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    
    .blocked-ip-entry {
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .blocked-ip-info {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .blocked-ip-address {
      font-family: monospace;
      font-weight: 500;
      color: #e74c3c;
    }
    
    .blocked-ip-details {
      font-size: 12px;
      color: #666;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    
    .pagination button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      border-radius: 4px;
    }
    
    .pagination button.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .pagination button:hover:not(.active) {
      background: #f8f9fa;
    }
    
    .no-logs {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .export-section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    
    .export-actions {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    @media (max-width: 768px) {
      .log-entry {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .search-form {
        grid-template-columns: 1fr;
      }
      
      .table-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ” ç™»å…¥æ—¥èªŒç®¡ç†ç³»çµ±</h1>
    <p>ç›£æ§å’Œç®¡ç†æ‰€æœ‰ç®¡ç†å“¡ç™»å…¥æ´»å‹•</p>
    <div id="userInfo" style="margin-top: 10px; font-size: 0.9rem; opacity: 0.9;"></div>
    <div style="margin-top: 15px;">
      <a href="admin-dashboard.html" class="btn btn-primary" style="text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5"/>
          <path d="M12 19l-7-7 7-7"/>
        </svg>
        è¿”å›ä¸»æ§å°
      </a>
    </div>
  </div>

  <div class="container">
    <!-- çµ±è¨ˆè³‡è¨Š -->
    <div class="stats-grid" id="statsGrid">
      <!-- çµ±è¨ˆå¡ç‰‡å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
    </div>

    <!-- æœå°‹å’Œæ§åˆ¶ -->
    <div class="controls">
      <form class="search-form" id="searchForm">
        <div class="form-group">
          <label for="searchEmail">é›»å­éƒµä»¶</label>
          <input type="email" id="searchEmail" placeholder="æœå°‹ç‰¹å®šéƒµä»¶">
        </div>
        <div class="form-group">
          <label for="searchIP">IP åœ°å€</label>
          <input type="text" id="searchIP" placeholder="æœå°‹ç‰¹å®š IP">
        </div>
        <div class="form-group">
          <label for="searchStatus">ç‹€æ…‹</label>
          <select id="searchStatus">
            <option value="">å…¨éƒ¨</option>
            <option value="true">æˆåŠŸ</option>
            <option value="false">å¤±æ•—</option>
          </select>
        </div>
        <div class="form-group">
          <label for="searchDateFrom">é–‹å§‹æ—¥æœŸ</label>
          <input type="datetime-local" id="searchDateFrom">
        </div>
        <div class="form-group">
          <label for="searchDateTo">çµæŸæ—¥æœŸ</label>
          <input type="datetime-local" id="searchDateTo">
        </div>
        <div class="form-group">
          <button type="submit" class="btn btn-primary">æœå°‹</button>
        </div>
      </form>
    </div>

    <!-- ç™»å…¥æ—¥èªŒè¡¨æ ¼ -->
    <div class="logs-table">
      <div class="table-header">
        <div class="table-title">ç™»å…¥æ—¥èªŒè¨˜éŒ„</div>
        <div class="table-actions">
          <button class="btn btn-primary" onclick="refreshLogs()">é‡æ–°æ•´ç†</button>
          <button class="btn btn-success" onclick="exportLogs()">åŒ¯å‡º CSV</button>
          <button class="btn btn-danger" onclick="clearOldLogs()">æ¸…ç†èˆŠæ—¥èªŒ</button>
        </div>
      </div>
      <div class="logs-container" id="logsContainer">
        <!-- æ—¥èªŒè¨˜éŒ„å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>

    <!-- åˆ†é  -->
    <div class="pagination" id="pagination">
      <!-- åˆ†é æŒ‰éˆ•å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
    </div>

    <!-- è¢«å°é–çš„ IP -->
    <div class="blocked-ips">
      <div class="table-header">
        <div class="table-title">è¢«å°é–çš„ IP åœ°å€</div>
        <div class="table-actions">
          <button class="btn btn-primary" onclick="refreshBlockedIPs()">é‡æ–°æ•´ç†</button>
        </div>
      </div>
      <div id="blockedIPsContainer">
        <!-- è¢«å°é–çš„ IP å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>

    <!-- åŒ¯å‡ºé¸é … -->
    <div class="export-section">
      <h3>åŒ¯å‡ºé¸é …</h3>
      <div class="export-actions">
        <button class="btn btn-success" onclick="exportAllLogs()">åŒ¯å‡ºæ‰€æœ‰æ—¥èªŒ</button>
        <button class="btn btn-success" onclick="exportFailedLogs()">åŒ¯å‡ºå¤±æ•—æ—¥èªŒ</button>
        <button class="btn btn-success" onclick="exportBlockedIPs()">åŒ¯å‡ºå°é–æ¸…å–®</button>
      </div>
    </div>
  </div>

  <script>
    let currentPage = 1;
    let logsPerPage = 50;
    let filteredLogs = [];

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      checkAdminAuth();
      displayUserInfo();
      loadStatistics();
      loadLogs();
      loadBlockedIPs();
      setupEventListeners();
    });

    // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
    function checkAdminAuth() {
      const user = JSON.parse(sessionStorage.getItem('adminUser') || '{}');
      if (!user.email || !user.role) {
        alert('éœ€è¦ç®¡ç†å“¡æ¬Šé™æ‰èƒ½è¨ªå•æ­¤é é¢');
        window.location.href = 'admin-login.html';
        return;
      }
      
      // æª¢æŸ¥æ˜¯å¦æœ‰ç®¡ç†å“¡æ¬Šé™ï¼ˆè¶…ç´šç®¡ç†å“¡æˆ–ä¸€èˆ¬ç®¡ç†å“¡ï¼‰
      const allowedRoles = ['super_admin', 'admin', 'manager'];
      if (!allowedRoles.includes(user.role)) {
        alert('æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•è¨ªå•æ­¤é é¢');
        window.location.href = 'admin-login.html';
        return;
      }
      
      // å„²å­˜ç•¶å‰ç”¨æˆ¶è³‡è¨Šä¾›å¾ŒçºŒä½¿ç”¨
      window.currentAdminUser = user;
    }

    // é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
    function displayUserInfo() {
      const user = window.currentAdminUser;
      const userInfoDiv = document.getElementById('userInfo');
      
      if (user) {
        const roleText = {
          'super_admin': 'è¶…ç´šç®¡ç†å“¡',
          'admin': 'ç®¡ç†å“¡',
          'manager': 'ç¶“ç†'
        }[user.role] || user.role;
        
        userInfoDiv.innerHTML = `
          <span>ğŸ‘¤ ${user.email} (${roleText})</span>
          ${user.role === 'super_admin' ? '<span style="margin-left: 10px;">ğŸ”‘ å®Œæ•´æ¬Šé™</span>' : '<span style="margin-left: 10px;">ğŸ‘ï¸ å”¯è®€æ¬Šé™</span>'}
        `;
      }
    }

    // è¼‰å…¥çµ±è¨ˆè³‡è¨Š
    function loadStatistics() {
      const stats = window.loginAuditSystem.getStatistics();
      const statsGrid = document.getElementById('statsGrid');
      
      statsGrid.innerHTML = `
        <div class="stat-card">
          <div class="stat-number">${stats.totalAttempts}</div>
          <div class="stat-label">ç¸½ç™»å…¥å˜—è©¦</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${stats.successfulLogins}</div>
          <div class="stat-label">æˆåŠŸç™»å…¥</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${stats.failedLogins}</div>
          <div class="stat-label">å¤±æ•—ç™»å…¥</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${stats.successRate}%</div>
          <div class="stat-label">æˆåŠŸç‡</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${stats.blockedIPsCount}</div>
          <div class="stat-label">è¢«å°é– IP</div>
        </div>
      `;
    }

    // è¼‰å…¥æ—¥èªŒ
    function loadLogs() {
      const allLogs = window.loginAuditSystem.getAllLogs();
      filteredLogs = allLogs;
      displayLogs();
    }

    // é¡¯ç¤ºæ—¥èªŒ
    function displayLogs() {
      const container = document.getElementById('logsContainer');
      const startIndex = (currentPage - 1) * logsPerPage;
      const endIndex = startIndex + logsPerPage;
      const pageLogs = filteredLogs.slice(startIndex, endIndex);

      if (pageLogs.length === 0) {
        container.innerHTML = '<div class="no-logs">æ²’æœ‰æ‰¾åˆ°æ—¥èªŒè¨˜éŒ„</div>';
        return;
      }

      const logsHTML = pageLogs.map(log => `
        <div class="log-entry">
          <div class="log-timestamp">${formatDateTime(log.timestamp)}</div>
          <div class="log-email">${log.email}</div>
          <div class="log-ip">${log.ipAddress}</div>
          <div class="log-password">${log.password}</div>
          <div class="log-success ${log.success}">${log.success ? 'æˆåŠŸ' : 'å¤±æ•—'}</div>
          <div class="log-reason">${log.reason || '-'}</div>
        </div>
      `).join('');

      container.innerHTML = logsHTML;
      updatePagination();
    }

    // æ›´æ–°åˆ†é 
    function updatePagination() {
      const totalPages = Math.ceil(filteredLogs.length / logsPerPage);
      const pagination = document.getElementById('pagination');
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }

      let paginationHTML = '';
      
      // ä¸Šä¸€é 
      if (currentPage > 1) {
        paginationHTML += `<button onclick="changePage(${currentPage - 1})">ä¸Šä¸€é </button>`;
      }

      // é ç¢¼
      for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
          paginationHTML += `<button class="active">${i}</button>`;
        } else {
          paginationHTML += `<button onclick="changePage(${i})">${i}</button>`;
        }
      }

      // ä¸‹ä¸€é 
      if (currentPage < totalPages) {
        paginationHTML += `<button onclick="changePage(${currentPage + 1})">ä¸‹ä¸€é </button>`;
      }

      pagination.innerHTML = paginationHTML;
    }

    // åˆ‡æ›é é¢
    function changePage(page) {
      currentPage = page;
      displayLogs();
    }

    // è¼‰å…¥è¢«å°é–çš„ IP
    function loadBlockedIPs() {
      // ç¢ºä¿ loginAuditSystem å·²åˆå§‹åŒ–
      if (!window.loginAuditSystem) {
        console.error('loginAuditSystem æœªåˆå§‹åŒ–');
        const container = document.getElementById('blockedIPsContainer');
        container.innerHTML = '<div class="no-logs">ç³»çµ±æœªåˆå§‹åŒ–</div>';
        return;
      }
      
      // é‡æ–°å¾ localStorage è®€å–ï¼Œç¢ºä¿è³‡æ–™æ˜¯æœ€æ–°çš„
      const blockedIPsData = localStorage.getItem('blockedIPs');
      let blockedIPs = [];
      
      if (blockedIPsData) {
        try {
          blockedIPs = JSON.parse(blockedIPsData);
          console.log('å¾ localStorage è®€å–è¢«å°é– IP:', blockedIPs);
        } catch (e) {
          console.error('è§£æè¢«å°é– IP è³‡æ–™å¤±æ•—:', e);
          blockedIPs = [];
        }
      } else {
        console.log('localStorage ä¸­æ²’æœ‰ blockedIPs è³‡æ–™');
      }
      
      // åŒæ­¥åˆ° loginAuditSystem
      window.loginAuditSystem.blockedIPs = blockedIPs;
      
      // éæ¿¾æ‰å·²éæœŸçš„å°é–ï¼ˆè¶…é15åˆ†é˜ï¼‰
      const now = new Date().getTime();
      const lockoutDuration = 15 * 60 * 1000; // 15åˆ†é˜
      const activeBlockedIPs = blockedIPs.filter(block => {
        const blockTime = new Date(block.blockedAt).getTime();
        const timeDiff = now - blockTime;
        const isActive = timeDiff < lockoutDuration;
        
        console.log(`æª¢æŸ¥ IP ${block.ipAddress}:`, {
          blockTime: new Date(block.blockedAt).toLocaleString(),
          now: new Date(now).toLocaleString(),
          timeDiff: Math.round(timeDiff / 1000 / 60) + ' åˆ†é˜',
          isActive: isActive
        });
        
        return isActive;
      });
      
      console.log(`æœ‰æ•ˆå°é– IP æ•¸é‡: ${activeBlockedIPs.length} / ${blockedIPs.length}`);
      
      // æ›´æ–° loginAuditSystem çš„ blockedIPsï¼ˆç§»é™¤å·²éæœŸçš„ï¼‰
      if (activeBlockedIPs.length !== blockedIPs.length) {
        window.loginAuditSystem.blockedIPs = activeBlockedIPs;
        localStorage.setItem('blockedIPs', JSON.stringify(activeBlockedIPs));
        console.log('å·²æ¸…ç†éæœŸçš„å°é–è¨˜éŒ„');
      }
      
      const container = document.getElementById('blockedIPsContainer');

      if (activeBlockedIPs.length === 0) {
        // å¦‚æœæ²’æœ‰æœ‰æ•ˆå°é–ï¼Œä½†åŸå§‹è³‡æ–™ä¸­æœ‰ï¼Œé¡¯ç¤ºæç¤º
        if (blockedIPs.length > 0) {
          container.innerHTML = '<div class="no-logs">æ‰€æœ‰å°é–å·²éæœŸï¼ˆè¶…é15åˆ†é˜ï¼‰</div>';
        } else {
          container.innerHTML = '<div class="no-logs">æ²’æœ‰è¢«å°é–çš„ IP</div>';
        }
        return;
      }

      const user = window.currentAdminUser;
      const isSuperAdmin = user && user.role === 'super_admin';
      
      const blockedHTML = activeBlockedIPs.map(block => `
         <div class="blocked-ip-entry">
           <div class="blocked-ip-info">
             <div class="blocked-ip-address">${block.ipAddress}</div>
             <div class="blocked-ip-details">
               å°é–æ™‚é–“: ${formatDateTime(block.blockedAt)} | 
               å˜—è©¦æ¬¡æ•¸: ${block.attempts} | 
               åŸå› : ${block.reason}
             </div>
           </div>
           ${isSuperAdmin ? `<button class="btn btn-success" onclick="unblockIP('${block.ipAddress}')">è§£é™¤å°é–</button>` : '<span style="color: #666; font-size: 0.9rem;">åƒ…è¶…ç´šç®¡ç†å“¡å¯è§£é™¤å°é–</span>'}
         </div>
       `).join('');

      container.innerHTML = blockedHTML;
    }

    // è§£é™¤ IP å°é–
    function unblockIP(ipAddress) {
      const user = window.currentAdminUser || JSON.parse(sessionStorage.getItem('adminUser') || '{}');
      
      // åªæœ‰è¶…ç´šç®¡ç†å“¡æ‰èƒ½è§£é™¤ IP å°é–
      if (user.role !== 'super_admin') {
        alert('åªæœ‰è¶…ç´šç®¡ç†å“¡æ‰èƒ½è§£é™¤ IP å°é–');
        return;
      }
      
      if (confirm(`ç¢ºå®šè¦è§£é™¤ IP ${ipAddress} çš„å°é–å—ï¼Ÿ`)) {
        const success = window.loginAuditSystem.unblockIP(ipAddress, user.email);
        if (success) {
          alert('IP å°é–å·²è§£é™¤');
          loadBlockedIPs();
          loadStatistics();
        } else {
          alert('è§£é™¤å°é–å¤±æ•—');
        }
      }
    }

    // æœå°‹æ—¥èªŒ
    function searchLogs() {
      const email = document.getElementById('searchEmail').value;
      const ip = document.getElementById('searchIP').value;
      const status = document.getElementById('searchStatus').value;
      const dateFrom = document.getElementById('searchDateFrom').value;
      const dateTo = document.getElementById('searchDateTo').value;

      const criteria = {};
      if (email) criteria.email = email;
      if (ip) criteria.ipAddress = ip;
      if (status !== '') criteria.success = status === 'true';
      if (dateFrom) criteria.dateFrom = dateFrom;
      if (dateTo) criteria.dateTo = dateTo;

      filteredLogs = window.loginAuditSystem.searchLogs(criteria);
      currentPage = 1;
      displayLogs();
    }

    // é‡æ–°æ•´ç†æ—¥èªŒ
    function refreshLogs() {
      loadLogs();
      loadStatistics();
    }

    // é‡æ–°æ•´ç†è¢«å°é–çš„ IP
    function refreshBlockedIPs() {
      loadBlockedIPs();
    }

    // åŒ¯å‡ºæ—¥èªŒ
    function exportLogs() {
      const csv = window.loginAuditSystem.exportLogsToCSV();
      downloadCSV(csv, 'login_logs.csv');
    }

    // åŒ¯å‡ºæ‰€æœ‰æ—¥èªŒ
    function exportAllLogs() {
      const csv = window.loginAuditSystem.exportLogsToCSV();
      downloadCSV(csv, 'all_login_logs.csv');
    }

    // åŒ¯å‡ºå¤±æ•—æ—¥èªŒ
    function exportFailedLogs() {
      const failedLogs = window.loginAuditSystem.searchLogs({ success: false });
      const csv = convertLogsToCSV(failedLogs);
      downloadCSV(csv, 'failed_login_logs.csv');
    }

    // åŒ¯å‡ºå°é–æ¸…å–®
    function exportBlockedIPs() {
      const blockedIPs = window.loginAuditSystem.blockedIPs;
      const headers = ['IPåœ°å€', 'é›»å­éƒµä»¶', 'å°é–æ™‚é–“', 'åŸå› ', 'å˜—è©¦æ¬¡æ•¸'];
      const csvContent = [
        headers.join(','),
        ...blockedIPs.map(block => [
          block.ipAddress,
          block.email,
          block.blockedAt,
          block.reason,
          block.attempts
        ].join(','))
      ].join('\n');
      
      downloadCSV(csvContent, 'blocked_ips.csv');
    }

    // æ¸…ç†èˆŠæ—¥èªŒ
    function clearOldLogs() {
      if (confirm('ç¢ºå®šè¦æ¸…ç†30å¤©å‰çš„èˆŠæ—¥èªŒå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
        const result = window.loginAuditSystem.cleanupOldLogs(30);
        alert(`æ¸…ç†å®Œæˆï¼šç§»é™¤äº† ${result.removedCount} æ¢èˆŠæ—¥èªŒ`);
        loadLogs();
        loadStatistics();
      }
    }

    // è¨­å®šäº‹ä»¶ç›£è½å™¨
    function setupEventListeners() {
      document.getElementById('searchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        searchLogs();
      });
    }

    // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
    function formatDateTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleString('zh-TW');
    }

    // è½‰æ›æ—¥èªŒç‚º CSV
    function convertLogsToCSV(logs) {
      const headers = ['æ™‚é–“', 'é›»å­éƒµä»¶', 'å¯†ç¢¼', 'IPåœ°å€', 'ç”¨æˆ¶ä»£ç†', 'æˆåŠŸ', 'åŸå› ', 'æœƒè©±ID'];
      return [
        headers.join(','),
        ...logs.map(log => [
          log.timestamp,
          log.email,
          log.password,
          log.ipAddress,
          `"${log.userAgent}"`,
          log.success ? 'æ˜¯' : 'å¦',
          log.reason,
          log.sessionId
        ].join(','))
      ].join('\n');
    }

    // ä¸‹è¼‰ CSV æª”æ¡ˆ
    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>
