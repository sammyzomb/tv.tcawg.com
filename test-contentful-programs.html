<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>測試 Contentful 節目載入</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 10px;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .program-item {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      background: #f9f9f9;
    }
    
    .program-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }
    
    .program-meta {
      font-size: 14px;
      color: #666;
      margin: 4px 0;
    }
    
    .status {
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    
    button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>測試 Contentful 節目載入</h1>
    <p>這個頁面使用與 today-schedule.html 相同的邏輯來載入節目</p>
    
    <div id="status" class="status info">準備載入節目...</div>
    
    <button onclick="loadPrograms()">載入節目</button>
    <button onclick="clearResults()">清除結果</button>
    
    <div id="results"></div>
  </div>

  <!-- Contentful SDK -->
  <script src="https://cdn.jsdelivr.net/npm/contentful@latest/dist/contentful.browser.min.js"></script>
  <script src="browser-config.js"></script>
  
  <script>
    let programs = [];
    
    function updateStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
    }
    
    function clearResults() {
      document.getElementById('results').innerHTML = '';
      programs = [];
    }
    
    async function loadPrograms() {
      try {
        updateStatus('正在載入節目...', 'info');
        
        // 檢查 Contentful SDK 是否載入
        if (typeof contentful === 'undefined') {
          throw new Error('Contentful SDK 未載入');
        }
        
        // 創建 Contentful 客戶端
        const client = contentful.createClient({
          space: window.CONTENTFUL_CONFIG?.SPACE_ID || 'os5wf90ljenp',
          accessToken: window.CONTENTFUL_CONFIG?.DELIVERY_TOKEN || 'lODH-WLwHwVZv7O4rFdBWjSnrzaQWGD4koeOZ1Dypj0'
        });
        
        // 獲取台灣時間的今天日期
        const now = new Date();
        const taiwanTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
        const todayString = taiwanTime.toISOString().split('T')[0];
        
        console.log('今天日期 (台灣時間):', todayString);
        
        // 查詢今日的節目 - 嘗試多種查詢方式
        let response;
        try {
          // 方式1：使用 airDate 欄位
          response = await client.getEntries({
            content_type: 'scheduleItem',
            'fields.airDate': todayString,
            include: 2
          });
          console.log('方式1 (airDate) 查詢結果:', response.items?.length || 0, '個節目');
        } catch (error) {
          console.log('方式1 查詢失敗，嘗試方式2:', error.message);
        }
        
        // 如果方式1沒有結果，嘗試方式2：查詢所有 scheduleItem
        if (!response || !response.items || response.items.length === 0) {
          try {
            response = await client.getEntries({
              content_type: 'scheduleItem',
              include: 2,
              limit: 100
            });
            console.log('方式2 (所有 scheduleItem) 查詢結果:', response.items?.length || 0, '個節目');
          } catch (error) {
            console.log('方式2 查詢也失敗:', error.message);
            throw error;
          }
        }
        
        console.log('Contentful 回應:', response);
        
        // 轉換 Contentful 資料格式
        programs = response.items.map(entry => {
          const fields = entry.fields;
          
          // 從備註中提取時間
          const notes = fields.notes?.['en-US'] || '';
          const timeMatch = notes.match(/\[時間:(\d{2}:\d{2})\]/);
          const airTime = timeMatch ? timeMatch[1] : '00:00';
          
          console.log('處理節目:', {
            title: fields.title?.['en-US'],
            airDate: fields.airDate?.['en-US'],
            notes: notes,
            extractedTime: airTime
          });
          
          // 處理縮圖
          let thumbnail = 'https://images.unsplash.com/photo-1485846234645-a62644f84728?w=400&h=225&fit=crop';
          
          // 如果有縮圖 Asset
          if (fields.thumbnail && fields.thumbnail['en-US']) {
            const thumbnailAsset = fields.thumbnail['en-US'];
            if (thumbnailAsset.fields && thumbnailAsset.fields.file) {
              thumbnail = 'https:' + thumbnailAsset.fields.file['en-US'].url;
              console.log('使用 Contentful Asset 縮圖:', thumbnail);
            }
          }
          // 如果有縮圖 URL
          else if (fields.thumbnailUrl && fields.thumbnailUrl['en-US']) {
            thumbnail = fields.thumbnailUrl['en-US'];
            console.log('使用 YouTube URL 縮圖:', thumbnail);
          }
          // 如果有 video 欄位，嘗試從中提取 YouTube ID
          else if (fields.video && fields.video['en-US']) {
            const videoEntry = fields.video['en-US'];
            if (videoEntry.fields && videoEntry.fields.youTubeId && videoEntry.fields.youTubeId['en-US']) {
              const youtubeId = videoEntry.fields.youTubeId['en-US'];
              thumbnail = `https://img.youtube.com/vi/${youtubeId}/maxresdefault.jpg`;
              console.log('使用 Video Entry 中的 YouTube 縮圖:', thumbnail);
            }
          }
          // 從備註中提取 YouTube ID（如果有的話）
          else {
            const youtubeIdMatch = notes.match(/\[YouTube:([a-zA-Z0-9_-]+)\]/);
            if (youtubeIdMatch) {
              const youtubeId = youtubeIdMatch[1];
              thumbnail = `https://img.youtube.com/vi/${youtubeId}/maxresdefault.jpg`;
              console.log('從備註中提取 YouTube 縮圖:', thumbnail);
            }
          }
          
          // 提取 YouTube ID
          let youtubeId = '';
          const youtubeIdMatch = notes.match(/\[YouTube:([a-zA-Z0-9_-]+)\]/);
          if (youtubeIdMatch) {
            youtubeId = youtubeIdMatch[1];
          }
          
          return {
            time: airTime,
            title: fields.title?.['en-US'] || '未命名節目',
            duration: "30", // 預設 30 分鐘
            category: "旅遊節目",
            description: notes.replace(/\[時間:\d{2}:\d{2}\]/, '').replace(/\[YouTube:[a-zA-Z0-9_-]+\]/, '').trim() || '節目描述',
            thumbnail: thumbnail,
            youtubeId: youtubeId,
            status: "published",
            airDate: fields.airDate?.['en-US'] || '',
            notes: notes
          };
        });
        
        // 按時間排序
        programs.sort((a, b) => a.time.localeCompare(b.time));
        
        console.log('從 Contentful 載入節目成功:', programs.length, '個節目');
        console.log('節目縮圖資料:', programs.map(p => ({title: p.title, thumbnail: p.thumbnail})));
        
        // 顯示結果
        displayResults();
        
        updateStatus(`成功載入 ${programs.length} 個節目`, 'success');
        
      } catch (error) {
        console.error('從 Contentful 載入節目失敗:', error);
        updateStatus(`載入失敗: ${error.message}`, 'error');
      }
    }
    
    function displayResults() {
      const resultsDiv = document.getElementById('results');
      
      if (programs.length === 0) {
        resultsDiv.innerHTML = '<p>沒有找到任何節目</p>';
        return;
      }
      
      resultsDiv.innerHTML = programs.map(program => `
        <div class="program-item">
          <div class="program-title">${program.title}</div>
          <div class="program-meta">時間: ${program.time}</div>
          <div class="program-meta">播出日期: ${program.airDate}</div>
          <div class="program-meta">YouTube ID: ${program.youtubeId || '無'}</div>
          <div class="program-meta">描述: ${program.description}</div>
          <div class="program-meta">備註: ${program.notes}</div>
          <div class="program-meta">縮圖: <a href="${program.thumbnail}" target="_blank">查看縮圖</a></div>
        </div>
      `).join('');
    }
    
    // 頁面載入完成後自動載入節目
    document.addEventListener('DOMContentLoaded', function() {
      console.log('頁面載入完成，準備載入節目');
      loadPrograms();
    });
  </script>
</body>
</html>
