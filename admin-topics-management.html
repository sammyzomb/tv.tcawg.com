<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸»é¡Œæ¢ç´¢ç®¡ç†ç³»çµ± | èˆªå‘ä¸–ç•Œæ—…éŠé »é“</title>
  
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  
  <style>
    :root {
      --admin-bg: #f8fafc;
      --admin-card: #ffffff;
      --admin-border: #e2e8f0;
      --admin-primary: #3b82f6;
      --admin-success: #10b981;
      --admin-warning: #f59e0b;
      --admin-danger: #ef4444;
      --admin-text: #1e293b;
      --admin-text-light: #64748b;
    }
    
    body {
      background: var(--admin-bg);
      color: var(--admin-text);
      font-family: 'Noto Sans TC', sans-serif;
      margin: 0;
      padding: 0;
    }
    
    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .admin-header {
      background: var(--admin-card);
      border: 1px solid var(--admin-border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .admin-title {
      font-size: 28px;
      font-weight: 700;
      margin: 0 0 8px 0;
      color: var(--admin-text);
    }
    
    .admin-subtitle {
      color: var(--admin-text-light);
      margin: 0;
    }
    
    .admin-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: var(--admin-primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: #2563eb;
    }
    
    .btn-success {
      background: var(--admin-success);
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .btn-warning {
      background: var(--admin-warning);
      color: white;
    }
    
    .btn-warning:hover {
      background: #d97706;
    }
    
    .btn-danger {
      background: var(--admin-danger);
      color: white;
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }
    
    .topics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }
    
    .topic-admin-card {
      background: var(--admin-card);
      border: 1px solid var(--admin-border);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .topic-preview {
      width: 100%;
      height: 200px;
      background-size: cover;
      background-position: center;
      border-radius: 8px;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }
    
    .topic-preview::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.7) 100%);
    }
    
    .topic-preview-content {
      position: absolute;
      bottom: 16px;
      left: 16px;
      right: 16px;
      z-index: 2;
      color: white;
    }
    
    .topic-preview-title {
      font-size: 18px;
      font-weight: 700;
      margin: 0 0 4px 0;
    }
    
    .topic-preview-desc {
      font-size: 14px;
      opacity: 0.9;
      margin: 0;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--admin-text);
    }
    
    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--admin-border);
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--admin-primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    .form-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    
    .tag {
      background: #e2e8f0;
      color: var(--admin-text);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .tag-remove {
      cursor: pointer;
      color: var(--admin-danger);
    }
    
    .image-upload {
      border: 2px dashed var(--admin-border);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .image-upload:hover {
      border-color: var(--admin-primary);
      background: rgba(59, 130, 246, 0.05);
    }
    
    .image-upload input {
      display: none;
    }
    
    .image-upload-text {
      color: var(--admin-text-light);
      font-size: 14px;
    }
    
    .topic-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-active {
      background: #dcfce7;
      color: #166534;
    }
    
    .status-draft {
      background: #fef3c7;
      color: #92400e;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: var(--admin-card);
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 700;
      margin: 0;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--admin-text-light);
    }
    
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--admin-primary);
      text-decoration: none;
      margin-bottom: 20px;
    }
    
    .back-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <a href="admin-dashboard.html" class="back-link">
      â† è¿”å›ç®¡ç†å¾Œå°
    </a>
    
    <!-- ç™»å…¥ç‹€æ…‹æª¢æŸ¥ -->
    <div id="login-status" style="display: none; background: #fee; color: #c33; padding: 10px; border-radius: 8px; margin-bottom: 20px;">
      âš ï¸ è«‹å…ˆç™»å…¥ç®¡ç†ç³»çµ±
    </div>
    
    <div class="admin-header">
      <h1 class="admin-title">ä¸»é¡Œæ¢ç´¢ç®¡ç†ç³»çµ±</h1>
      <p class="admin-subtitle">ç®¡ç†ä¸»é¡Œæ¢ç´¢é é¢çš„å…§å®¹ã€åœ–ç‰‡å’Œè¨­å®š</p>
      
      <div class="admin-actions">
        <button class="btn btn-primary" onclick="addNewTopic()">
          â• æ–°å¢ä¸»é¡Œ
        </button>
        <button class="btn btn-success" onclick="saveAllTopics()">
          ğŸ’¾ å„²å­˜æ‰€æœ‰è®Šæ›´
        </button>
        <button class="btn btn-warning" onclick="previewTopics()">
          ğŸ‘ï¸ é è¦½æ•ˆæœ
        </button>
        <button class="btn btn-danger" onclick="resetToDefault()">
          ğŸ”„ é‡ç½®ç‚ºé è¨­
        </button>
        <button class="btn btn-primary" onclick="testNotification()" style="background: #8b5cf6;">
          ğŸ§ª æ¸¬è©¦é€šçŸ¥
        </button>
      </div>
    </div>
    
    <div class="topics-grid" id="topics-grid">
      <!-- ä¸»é¡Œç®¡ç†å¡ç‰‡å°‡ç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
    </div>
  </div>
  
  <!-- æ–°å¢/ç·¨è¼¯ä¸»é¡Œçš„æ¨¡æ…‹æ¡† -->
  <div class="modal" id="topic-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-title">æ–°å¢ä¸»é¡Œ</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      
      <form id="topic-form">
        <div class="form-group">
          <label class="form-label">ä¸»é¡Œ ID</label>
          <input type="text" class="form-input" id="topic-id" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">ä¸»é¡Œæ¨™é¡Œ</label>
          <input type="text" class="form-input" id="topic-title" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">ä¸»é¡Œæè¿°</label>
          <textarea class="form-input form-textarea" id="topic-description" required></textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">åœ–ç¤º (Emoji)</label>
          <input type="text" class="form-input" id="topic-icon" placeholder="ğŸ™ï¸">
        </div>
        
        <div class="form-group">
          <label class="form-label">èƒŒæ™¯åœ–ç‰‡ URL</label>
          <input type="url" class="form-input" id="topic-background-image" placeholder="https://example.com/image.jpg">
        </div>
        
        <div class="form-group">
          <label class="form-label">æ¨™ç±¤ (ç”¨é€—è™Ÿåˆ†éš”)</label>
          <input type="text" class="form-input" id="topic-tags" placeholder="å°çœ¾æ™¯é», åœ¨åœ°ç”Ÿæ´», å¤œå¸‚">
        </div>
        
        <div class="form-group">
          <label class="form-label">ç¯€ç›®æ•¸é‡</label>
          <input type="number" class="form-input" id="topic-video-count" min="0" value="0">
        </div>
        
        <div class="form-group">
          <label class="form-label">ç‹€æ…‹</label>
          <select class="form-input" id="topic-status">
            <option value="active">å•Ÿç”¨</option>
            <option value="draft">è‰ç¨¿</option>
          </select>
        </div>
        
        <div class="topic-actions">
          <button type="submit" class="btn btn-primary">å„²å­˜ä¸»é¡Œ</button>
          <button type="button" class="btn btn-danger" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>
  
  <script type="module">
    // Firebase åˆå§‹åŒ–
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    
    // Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyB5MLyG5H1sCflHFU7WeKQCmC0Ft5TIqjM",
      authDomain: "tv-tcawg-com.firebaseapp.com",
      projectId: "tv-tcawg-com",
      storageBucket: "tv-tcawg-com.firebasestorage.app",
      messagingSenderId: "313251141126",
      appId: "1:313251141126:web:88ef97ce28798c0a2e9587",
      measurementId: "G-83Z5VTRTZH"
    };
    
    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    
    // å°‡ Firebase å¯¦ä¾‹è¨­ç‚ºå…¨åŸŸè®Šæ•¸
    window.firebaseAuth = auth;
    
    // ä¸»é¡Œè³‡æ–™ç®¡ç†
    let topicsData = [];
    let currentEditingTopic = null;
    
    // é è¨­ä¸»é¡Œè³‡æ–™
    const defaultTopics = [
      {
        id: 'city-secrets',
        title: 'åŸå¸‚ç§˜å¢ƒ',
        description: 'ã€Šç¹è‘—åœ°çƒè·‘/åŸå¸‚ç§˜å¢ƒ City Secretsã€‹- æ·±å…¥åŸå¸‚è§’è½ã€å¸‚é›†ã€æ–‡åŒ–æ™¯é»ï¼Œç”¨å¯¦åœ°é«”é©—å‘ˆç¾åŸå¸‚æ•…äº‹',
        icon: 'ğŸ™ï¸',
        tags: ['å°çœ¾æ™¯é»', 'åœ¨åœ°ç”Ÿæ´»', 'å¤œå¸‚', 'ç‰¹è‰²å’–å•¡é¤¨'],
        videoCount: 28,
        backgroundImage: 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80',
        status: 'active'
      },
      {
        id: 'taste-journal',
        title: 'å‘³è¦ºæ—¥èªŒ',
        description: 'ã€Šå‘³è¦ºæ—¥èªŒ Taste Journalã€‹- å“å˜—ç•¶åœ°æ–™ç†èˆ‡è¡—é ­å°åƒï¼Œè¨ªå•é¤å»³è€é—†æˆ–å»šå¸«ï¼Œåˆ†äº«é£Ÿç‰©èƒŒå¾Œçš„æ•…äº‹',
        icon: 'ğŸ½ï¸',
        tags: ['ç¾é£Ÿæ•…äº‹', 'è¡—é ­å°åƒ', 'åœ¨åœ°æ–™ç†', 'æ–‡åŒ–èƒŒæ™¯'],
        videoCount: 35,
        backgroundImage: 'https://images.unsplash.com/photo-1555939594-58d7cb561ad1?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80',
        status: 'active'
      },
      {
        id: 'travel-talk',
        title: 'æ—…é€”è«‡',
        description: 'ã€Šæ—…é€”è«‡ Travel Talkã€‹- é‚€è«‹æ—…éŠé”äººã€éƒ¨è½å®¢ã€åœ¨åœ°äººï¼Œåˆ†äº«æ—…è¡Œå¿ƒå¾—ã€æŠ€å·§èˆ‡è¶£è',
        icon: 'ğŸ’¬',
        tags: ['æ—…éŠæŠ€å·§', 'ç¯€çœé ç®—', 'äº’å‹•è¨è«–', 'å¯¦ç”¨è³‡è¨Š'],
        videoCount: 22,
        backgroundImage: 'https://images.unsplash.com/photo-1488646953014-85cb44e25828?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80',
        status: 'active'
      },
      {
        id: 'slow-town',
        title: 'æ…¢éŠå°é®',
        description: 'ã€Šæ…¢éŠå°é® Slow Townã€‹- èµ°è¨ªå°é®æˆ–é„‰æ‘ï¼Œä»‹ç´¹ç•¶åœ°æ–‡åŒ–ã€æ‰‹ä½œå·¥è—ã€å¸‚å ´èˆ‡ç‰¹è‰²ç¾é£Ÿ',
        icon: 'ğŸ˜ï¸',
        tags: ['æ…¢ç¯€å¥', 'è¼•æ—…è¡Œ', 'æ‰‹ä½œå·¥è—', 'åœ¨åœ°ç”Ÿæ´»'],
        videoCount: 18,
        backgroundImage: 'https://images.unsplash.com/photo-1513475382585-d06e58bcb0e0?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80',
        status: 'active'
      },
      {
        id: 'food-talk',
        title: 'é£Ÿè©±å¯¦èªª',
        description: 'ã€Šé£Ÿè©±å¯¦èªª Food Talkã€‹- è¨è«–ç‰¹å®šé£Ÿæã€æ–™ç†æˆ–ç¾é£Ÿæ–‡åŒ–ï¼Œçµåˆè¨è«–èˆ‡å¯¦åœ°ç¤ºç¯„',
        icon: 'ğŸ³',
        tags: ['é£Ÿæè¨è«–', 'æ–™ç†æ–‡åŒ–', 'æ•™è‚²æ€§', 'å¯¦åœ°ç¤ºç¯„'],
        videoCount: 25,
        backgroundImage: 'https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80',
        status: 'active'
      },
      {
        id: 'fun-for-kids',
        title: 'ç«¥è¶£æ—…ç¨‹',
        description: 'ã€Šç«¥è¶£æ—…ç¨‹ Fun for Kidsã€‹- å°ˆç‚ºå®¶åº­è¨­è¨ˆï¼Œæ¢ç´¢é©åˆè¦ªå­æ´»å‹•çš„æ™¯é»ã€éŠæ¨‚åœ’ã€å‹•ç‰©åœ’',
        icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦',
        tags: ['è¦ªå­æ´»å‹•', 'éŠæ¨‚åœ’', 'å‹•ç‰©åœ’', 'æ‰‹ä½œé«”é©—'],
        videoCount: 20,
        backgroundImage: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80',
        status: 'active'
      },
      {
        id: 'time-walk',
        title: 'æ™‚å…‰æ¼«éŠ',
        description: 'ã€Šæ™‚å…‰æ¼«éŠ Time Walkã€‹- èµ°è¨ªå¤è¹Ÿã€åšç‰©é¤¨ã€å‚³çµ±æ‘è½ï¼Œé€éæ­·å²æ•…äº‹å‘ˆç¾æ·±åº¦æ–‡åŒ–æ—…ç¨‹',
        icon: 'ğŸ›ï¸',
        tags: ['å¤è¹Ÿ', 'åšç‰©é¤¨', 'æ­·å²æ•…äº‹', 'æ–‡åŒ–æ—…ç¨‹'],
        videoCount: 30,
        backgroundImage: 'https://images.unsplash.com/photo-1520637836862-4d197d17c93a?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80',
        status: 'active'
      },
      {
        id: 'nature-secrets',
        title: 'è‡ªç„¶ç§˜å¢ƒ',
        description: 'ã€Šè‡ªç„¶ç§˜å¢ƒ Nature Secretsã€‹- æ¢ç´¢è‡ªç„¶æ™¯è§€ã€é‡ç”Ÿå‹•æ¤ç‰©ã€ç”Ÿæ…‹ä¿è‚²ï¼Œæ„Ÿå—åœ°çƒä¹‹ç¾',
        icon: 'ğŸŒ¿',
        tags: ['è‡ªç„¶æ™¯è§€', 'é‡ç”Ÿå‹•ç‰©', 'ç”Ÿæ…‹ä¿è‚²', 'ç’°å¢ƒä¿è­·'],
        videoCount: 26,
        backgroundImage: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80',
        status: 'active'
      }
    ];
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      // ç­‰å¾… Firebase èªè­‰ç‹€æ…‹åˆå§‹åŒ–
      onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log('Firebase ç”¨æˆ¶å·²ç™»å…¥:', user.email);
          window.firebaseAuth = auth;
        } else {
          console.log('Firebase ç”¨æˆ¶æœªç™»å…¥');
        }
        
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        checkLoginStatus();
      });
      
      loadTopicsData();
      renderTopicsGrid();
      setupEventListeners();
      
      // æ¸¬è©¦å‡½æ•¸æ˜¯å¦æ­£ç¢ºå®šç¾©
      console.log('å‡½æ•¸æ¸¬è©¦:', {
        updateTopic: typeof updateTopic,
        saveTopic: typeof saveTopic,
        testNotification: typeof testNotification
      });
    });
    
    // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    function checkLoginStatus() {
      // æª¢æŸ¥ Firebase èªè­‰ç‹€æ…‹
      let isLoggedIn = false;
      
      if (window.firebaseAuth) {
        const currentUser = window.firebaseAuth.currentUser;
        if (currentUser) {
          isLoggedIn = true;
        }
      }
      
      // æª¢æŸ¥ sessionStorage ä¸­çš„ç™»å…¥ç‹€æ…‹ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
      if (!isLoggedIn) {
        const user = sessionStorage.getItem('adminUser');
        const loginTime = sessionStorage.getItem('loginTime');
        
        if (user && loginTime) {
          // æª¢æŸ¥ç™»å…¥æ˜¯å¦è¶…é 8 å°æ™‚
          const loginDate = new Date(loginTime);
          const now = new Date();
          const hoursDiff = (now - loginDate) / (1000 * 60 * 60);
          
          if (hoursDiff < 8) {
            isLoggedIn = true;
          } else {
            // ç™»å…¥å·²éæœŸï¼Œæ¸…é™¤ session
            sessionStorage.removeItem('adminUser');
            sessionStorage.removeItem('loginTime');
          }
        }
      }
      
      const loginStatus = document.getElementById('login-status');
      
      if (!isLoggedIn) {
        loginStatus.style.display = 'block';
        // 3ç§’å¾Œè‡ªå‹•è·³è½‰åˆ°ç™»å…¥é é¢
        setTimeout(() => {
          window.location.href = 'admin-login.html';
        }, 3000);
      } else {
        loginStatus.style.display = 'none';
      }
    }
    
    // è¼‰å…¥ä¸»é¡Œè³‡æ–™
    function loadTopicsData() {
      const saved = localStorage.getItem('admin-topics-data');
      if (saved) {
        topicsData = JSON.parse(saved);
      } else {
        topicsData = [...defaultTopics];
        saveTopicsData();
      }
    }
    
    // å„²å­˜ä¸»é¡Œè³‡æ–™
    function saveTopicsData() {
      localStorage.setItem('admin-topics-data', JSON.stringify(topicsData));
    }
    
    // æ¸²æŸ“ä¸»é¡Œç¶²æ ¼
    function renderTopicsGrid() {
      const container = document.getElementById('topics-grid');
      if (!container) return;
      
      container.innerHTML = topicsData.map(topic => `
        <div class="topic-admin-card">
          <div class="topic-preview" style="background-image: url('${topic.backgroundImage.replace(/'/g, '&#39;').replace(/"/g, '&quot;')}')">
            <div class="topic-preview-content">
              <div class="topic-preview-title">${topic.title.replace(/'/g, '&#39;').replace(/"/g, '&quot;')}</div>
              <div class="topic-preview-desc">${topic.description.substring(0, 60).replace(/'/g, '&#39;').replace(/"/g, '&quot;')}...</div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">ä¸»é¡Œæ¨™é¡Œ</label>
            <input type="text" class="form-input" value="${topic.title.replace(/'/g, '&#39;').replace(/"/g, '&quot;')}" 
                   onchange="updateTopic('${topic.id.replace(/'/g, '&#39;')}', 'title', this.value)"
                   onblur="updateTopic('${topic.id.replace(/'/g, '&#39;')}', 'title', this.value)">
          </div>
          
          <div class="form-group">
            <label class="form-label">èƒŒæ™¯åœ–ç‰‡ URL</label>
            <input type="url" class="form-input" value="${topic.backgroundImage.replace(/'/g, '&#39;').replace(/"/g, '&quot;')}" 
                   onchange="updateTopic('${topic.id.replace(/'/g, '&#39;')}', 'backgroundImage', this.value); updatePreview('${topic.id.replace(/'/g, '&#39;')}')"
                   onblur="updateTopic('${topic.id.replace(/'/g, '&#39;')}', 'backgroundImage', this.value); updatePreview('${topic.id.replace(/'/g, '&#39;')}')">
          </div>
          
          <div class="form-group">
            <label class="form-label">ç¯€ç›®æ•¸é‡</label>
            <input type="number" class="form-input" value="${topic.videoCount}" 
                   onchange="updateTopic('${topic.id.replace(/'/g, '&#39;')}', 'videoCount', parseInt(this.value))"
                   onblur="updateTopic('${topic.id.replace(/'/g, '&#39;')}', 'videoCount', parseInt(this.value))">
          </div>
          
          <div class="form-group">
            <label class="form-label">ç‹€æ…‹</label>
            <select class="form-input" onchange="updateTopic('${topic.id.replace(/'/g, '&#39;')}', 'status', this.value)">
              <option value="active" ${topic.status === 'active' ? 'selected' : ''}>å•Ÿç”¨</option>
              <option value="draft" ${topic.status === 'draft' ? 'selected' : ''}>è‰ç¨¿</option>
            </select>
          </div>
          
          <div class="topic-actions">
            <button class="btn btn-success" onclick="saveTopic('${topic.id.replace(/'/g, '&#39;')}')" title="å„²å­˜æ­¤ä¸»é¡Œçš„è®Šæ›´">
              ğŸ’¾ å„²å­˜
            </button>
            <button class="btn btn-primary" onclick="editTopic('${topic.id.replace(/'/g, '&#39;')}')">ç·¨è¼¯</button>
            <button class="btn btn-warning" onclick="duplicateTopic('${topic.id.replace(/'/g, '&#39;')}')">è¤‡è£½</button>
            <button class="btn btn-danger" onclick="deleteTopic('${topic.id.replace(/'/g, '&#39;')}')">åˆªé™¤</button>
            <span class="status-indicator status-${topic.status}">
              ${topic.status === 'active' ? 'âœ… å•Ÿç”¨' : 'ğŸ“ è‰ç¨¿'}
            </span>
          </div>
        </div>
      `).join('');
    }
    
    // æ›´æ–°ä¸»é¡Œ
    function updateTopic(topicId, field, value) {
      try {
        const topic = topicsData.find(t => t.id === topicId);
        if (topic) {
          topic[field] = value;
          saveTopicsData();
          
          // é¡¯ç¤ºå„²å­˜æˆåŠŸæç¤º
          showSaveNotification(`å·²å„²å­˜ ${topic.title} çš„ ${getFieldDisplayName(field)}`);
          console.log(`å·²æ›´æ–°ä¸»é¡Œ ${topicId} çš„ ${field} ç‚º: ${value}`);
        }
      } catch (error) {
        console.error('updateTopic éŒ¯èª¤:', error);
      }
    }
    
    // å–å¾—æ¬„ä½é¡¯ç¤ºåç¨±
    function getFieldDisplayName(field) {
      const fieldNames = {
        'title': 'æ¨™é¡Œ',
        'description': 'æè¿°',
        'icon': 'åœ–ç¤º',
        'backgroundImage': 'èƒŒæ™¯åœ–ç‰‡',
        'tags': 'æ¨™ç±¤',
        'videoCount': 'ç¯€ç›®æ•¸é‡',
        'status': 'ç‹€æ…‹'
      };
      return fieldNames[field] || field;
    }
    
    // é¡¯ç¤ºå„²å­˜é€šçŸ¥
    function showSaveNotification(message) {
      console.log('é¡¯ç¤ºå„²å­˜é€šçŸ¥:', message);
      
      // ç§»é™¤ç¾æœ‰çš„é€šçŸ¥
      const existingNotification = document.querySelector('.save-notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      // å»ºç«‹æ–°çš„é€šçŸ¥
      const notification = document.createElement('div');
      notification.className = 'save-notification';
      notification.innerHTML = `
        <div style="
          position: fixed;
          top: 20px;
          right: 20px;
          background: #10b981;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 10000;
          font-size: 14px;
          font-weight: 600;
          display: flex;
          align-items: center;
          gap: 8px;
          max-width: 300px;
          word-wrap: break-word;
        ">
          <span style="font-size: 16px;">âœ…</span>
          <span>${message}</span>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 3000);
    }
    
    // ç·¨è¼¯ä¸»é¡Œ
    function editTopic(topicId) {
      const topic = topicsData.find(t => t.id === topicId);
      if (topic) {
        currentEditingTopic = topicId;
        document.getElementById('modal-title').textContent = 'ç·¨è¼¯ä¸»é¡Œ';
        document.getElementById('topic-id').value = topic.id;
        document.getElementById('topic-title').value = topic.title;
        document.getElementById('topic-description').value = topic.description;
        document.getElementById('topic-icon').value = topic.icon;
        document.getElementById('topic-background-image').value = topic.backgroundImage;
        document.getElementById('topic-tags').value = topic.tags.join(', ');
        document.getElementById('topic-video-count').value = topic.videoCount;
        document.getElementById('topic-status').value = topic.status;
        
        document.getElementById('topic-modal').classList.add('active');
      }
    }
    
    // è¤‡è£½ä¸»é¡Œ
    function duplicateTopic(topicId) {
      const topic = topicsData.find(t => t.id === topicId);
      if (topic) {
        const newTopic = {
          ...topic,
          id: topic.id + '-copy-' + Date.now(),
          title: topic.title + ' (è¤‡è£½)',
          status: 'draft'
        };
        topicsData.push(newTopic);
        saveTopicsData();
        renderTopicsGrid();
      }
    }
    
    // å„²å­˜å–®ä¸€ä¸»é¡Œ
    function saveTopic(topicId) {
      try {
        console.log('å„²å­˜ä¸»é¡Œ:', topicId);
        const topic = topicsData.find(t => t.id === topicId);
        if (topic) {
          saveTopicsData();
          showSaveNotification(`å·²å„²å­˜ã€Œ${topic.title}ã€çš„æ‰€æœ‰è®Šæ›´`);
          console.log('ä¸»é¡Œå„²å­˜æˆåŠŸ:', topic.title);
        } else {
          console.error('æ‰¾ä¸åˆ°ä¸»é¡Œ:', topicId);
          showSaveNotification('å„²å­˜å¤±æ•—ï¼šæ‰¾ä¸åˆ°ä¸»é¡Œ');
        }
      } catch (error) {
        console.error('saveTopic éŒ¯èª¤:', error);
        showSaveNotification('å„²å­˜å¤±æ•—ï¼šç™¼ç”ŸéŒ¯èª¤');
      }
    }
    
    // å„²å­˜æ‰€æœ‰è®Šæ›´
    function saveAllTopics() {
      console.log('å„²å­˜æ‰€æœ‰ä¸»é¡Œ');
      saveTopicsData();
      showSaveNotification('æ‰€æœ‰ä¸»é¡Œè®Šæ›´å·²å„²å­˜ï¼');
      console.log('æ‰€æœ‰ä¸»é¡Œå„²å­˜æˆåŠŸ');
    }
    
    // é è¦½æ•ˆæœ
    function previewTopics() {
      window.open('topics.html', '_blank');
    }
    
    // é‡ç½®ç‚ºé è¨­
    function resetToDefault() {
      if (confirm('ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­è¨­å®šå—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰è‡ªè¨‚å…§å®¹ã€‚')) {
        topicsData = [...defaultTopics];
        saveTopicsData();
        renderTopicsGrid();
        showSaveNotification('å·²é‡ç½®ç‚ºé è¨­è¨­å®šï¼');
      }
    }
    
    // æ¸¬è©¦é€šçŸ¥åŠŸèƒ½
    function testNotification() {
      try {
        console.log('æ¸¬è©¦é€šçŸ¥åŠŸèƒ½');
        showSaveNotification('æ¸¬è©¦é€šçŸ¥ï¼šå¦‚æœæ‚¨çœ‹åˆ°é€™å€‹è¨Šæ¯ï¼Œè¡¨ç¤ºé€šçŸ¥åŠŸèƒ½æ­£å¸¸ï¼');
      } catch (error) {
        console.error('testNotification éŒ¯èª¤:', error);
        alert('æ¸¬è©¦é€šçŸ¥åŠŸèƒ½ç™¼ç”ŸéŒ¯èª¤');
      }
    }
    
    // è¨­å®šäº‹ä»¶ç›£è½å™¨
    function setupEventListeners() {
      // è¡¨å–®æäº¤
      document.getElementById('topic-form').addEventListener('submit', (e) => {
        e.preventDefault();
        saveTopicFromForm();
      });
      
      // æ¨¡æ…‹æ¡†èƒŒæ™¯é»æ“Šé—œé–‰
      document.getElementById('topic-modal').addEventListener('click', (e) => {
        if (e.target.id === 'topic-modal') {
          closeModal();
        }
      });
    }
    
    // å¾è¡¨å–®å„²å­˜ä¸»é¡Œ
    function saveTopicFromForm() {
      const formData = {
        id: document.getElementById('topic-id').value,
        title: document.getElementById('topic-title').value,
        description: document.getElementById('topic-description').value,
        icon: document.getElementById('topic-icon').value,
        backgroundImage: document.getElementById('topic-background-image').value,
        tags: document.getElementById('topic-tags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
        videoCount: parseInt(document.getElementById('topic-video-count').value),
        status: document.getElementById('topic-status').value
      };
      
      if (currentEditingTopic) {
        // ç·¨è¼¯ç¾æœ‰ä¸»é¡Œ
        const index = topicsData.findIndex(t => t.id === currentEditingTopic);
        if (index !== -1) {
          topicsData[index] = formData;
        }
      } else {
        // æ–°å¢ä¸»é¡Œ
        topicsData.push(formData);
      }
      
      saveTopicsData();
      renderTopicsGrid();
      closeModal();
    }
    
    // åˆªé™¤ä¸»é¡Œ
    function deleteTopic(topicId) {
      const topic = topicsData.find(t => t.id === topicId);
      if (topic && confirm(`ç¢ºå®šè¦åˆªé™¤ä¸»é¡Œã€Œ${topic.title}ã€å—ï¼Ÿ`)) {
        topicsData = topicsData.filter(t => t.id !== topicId);
        saveTopicsData();
        renderTopicsGrid();
        showSaveNotification(`å·²åˆªé™¤ä¸»é¡Œã€Œ${topic.title}ã€`);
      }
    }
    
    // æ–°å¢ä¸»é¡Œ
    function addNewTopic() {
      currentEditingTopic = null;
      document.getElementById('modal-title').textContent = 'æ–°å¢ä¸»é¡Œ';
      document.getElementById('topic-form').reset();
      document.getElementById('topic-modal').classList.add('active');
    }
    
    // é—œé–‰æ¨¡æ…‹æ¡†
    function closeModal() {
      document.getElementById('topic-modal').classList.remove('active');
    }
    
    // æ›´æ–°é è¦½
    function updatePreview(topicId) {
      const topic = topicsData.find(t => t.id === topicId);
      if (topic) {
        const card = document.querySelector(`[data-topic-id="${topicId}"]`);
        if (card) {
          const preview = card.querySelector('.topic-preview');
          if (preview) {
            preview.style.backgroundImage = `url('${topic.backgroundImage.replace(/'/g, '&#39;')}')`;
          }
        }
      }
    }
  </script>
</body>
</html>
