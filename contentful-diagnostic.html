<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contentful è¨ºæ–·å·¥å…·</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .header { background: #2b71d2; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
    .btn { background: #2b71d2; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
    .btn:hover { background: #1e5bb8; }
    .btn-danger { background: #dc3545; }
    .btn-danger:hover { background: #c82333; }
    .btn-success { background: #28a745; }
    .btn-success:hover { background: #218838; }
    .result { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 10px; font-family: monospace; white-space: pre-wrap; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.warning { background: #fff3cd; color: #856404; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ”§ Contentful è¨ºæ–·å·¥å…·</h1>
      <p>è¨ºæ–·çµ±ä¸€ç¯€ç›®ç®¡ç†ä¸Šæ¶å¤±æ•—å•é¡Œ</p>
    </div>

    <div class="section">
      <h2>ğŸ“Š ç³»çµ±ç‹€æ…‹æª¢æŸ¥</h2>
      <button class="btn" onclick="checkSystemStatus()">æª¢æŸ¥ç³»çµ±ç‹€æ…‹</button>
      <div id="systemStatus" class="result"></div>
    </div>

    <div class="section">
      <h2>ğŸ—ï¸ Contentful å…§å®¹æ¨¡å‹æª¢æŸ¥</h2>
      <button class="btn" onclick="checkContentTypes()">æª¢æŸ¥å…§å®¹é¡å‹</button>
      <div id="contentTypes" class="result"></div>
    </div>

    <div class="section">
      <h2>ğŸ”‘ API æ¬Šé™æª¢æŸ¥</h2>
      <button class="btn" onclick="checkAPIPermissions()">æª¢æŸ¥ API æ¬Šé™</button>
      <div id="apiPermissions" class="result"></div>
    </div>

    <div class="section">
      <h2>ğŸ§ª æ¸¬è©¦ä¸Šæ¶åŠŸèƒ½</h2>
      <button class="btn btn-success" onclick="testUpload()">æ¸¬è©¦ä¸Šæ¶</button>
      <div id="testUpload" class="result"></div>
    </div>

    <div class="section">
      <h2>ğŸ”§ ä¿®å¾©å»ºè­°</h2>
      <button class="btn btn-danger" onclick="showFixSuggestions()">é¡¯ç¤ºä¿®å¾©å»ºè­°</button>
      <div id="fixSuggestions" class="result"></div>
    </div>
  </div>

  <!-- è¼‰å…¥å¿…è¦çš„è…³æœ¬ -->
  <script src="https://cdn.jsdelivr.net/npm/contentful@latest/dist/contentful.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/contentful-management@10.0.0/dist/contentful-management.browser.min.js"></script>
  <script src="browser-config.js"></script>

  <script>
    let managementClient = null;
    let space = null;
    let environment = null;

    // åˆå§‹åŒ– Management å®¢æˆ¶ç«¯
    async function initManagementClient() {
      try {
        if (typeof contentfulManagement === 'undefined') {
          throw new Error('Management SDK æœªè¼‰å…¥');
        }

        managementClient = contentfulManagement.createClient({
          accessToken: window.CONTENTFUL_CONFIG?.MANAGEMENT_TOKEN || window.CONTENTFUL_MANAGEMENT_TOKEN
        });

        space = await managementClient.getSpace(window.CONTENTFUL_CONFIG?.SPACE_ID || 'os5wf90ljenp');
        environment = await space.getEnvironment('master');

        return true;
      } catch (error) {
        console.error('åˆå§‹åŒ– Management å®¢æˆ¶ç«¯å¤±æ•—:', error);
        return false;
      }
    }

    // æª¢æŸ¥ç³»çµ±ç‹€æ…‹
    async function checkSystemStatus() {
      const resultDiv = document.getElementById('systemStatus');
      resultDiv.innerHTML = 'æ­£åœ¨æª¢æŸ¥ç³»çµ±ç‹€æ…‹...';
      
      const status = {
        contentful: typeof contentful !== 'undefined',
        contentfulManagement: typeof contentfulManagement !== 'undefined',
        config: !!window.CONTENTFUL_CONFIG,
        spaceId: window.CONTENTFUL_CONFIG?.SPACE_ID || 'æœªè¨­å®š',
        managementToken: window.CONTENTFUL_CONFIG?.MANAGEMENT_TOKEN ? 'å·²è¨­å®š' : 'æœªè¨­å®š'
      };

      let statusHtml = 'ç³»çµ±ç‹€æ…‹æª¢æŸ¥çµæœ:\n\n';
      statusHtml += `âœ… Contentful SDK: ${status.contentful ? 'å·²è¼‰å…¥' : 'âŒ æœªè¼‰å…¥'}\n`;
      statusHtml += `âœ… Management SDK: ${status.contentfulManagement ? 'å·²è¼‰å…¥' : 'âŒ æœªè¼‰å…¥'}\n`;
      statusHtml += `âœ… é…ç½®æª”æ¡ˆ: ${status.config ? 'å·²è¼‰å…¥' : 'âŒ æœªè¼‰å…¥'}\n`;
      statusHtml += `âœ… Space ID: ${status.spaceId}\n`;
      statusHtml += `âœ… Management Token: ${status.managementToken}\n\n`;

      if (status.contentful && status.contentfulManagement && status.config) {
        statusHtml += 'ğŸ‰ ç³»çµ±ç‹€æ…‹æ­£å¸¸ï¼';
        resultDiv.className = 'result success';
      } else {
        statusHtml += 'âš ï¸ ç³»çµ±ç‹€æ…‹ç•°å¸¸ï¼Œéœ€è¦ä¿®å¾©';
        resultDiv.className = 'result error';
      }

      resultDiv.innerHTML = statusHtml;
    }

    // æª¢æŸ¥å…§å®¹é¡å‹
    async function checkContentTypes() {
      const resultDiv = document.getElementById('contentTypes');
      resultDiv.innerHTML = 'æ­£åœ¨æª¢æŸ¥å…§å®¹é¡å‹...';
      
      try {
        const initialized = await initManagementClient();
        if (!initialized) {
          throw new Error('ç„¡æ³•åˆå§‹åŒ– Management å®¢æˆ¶ç«¯');
        }

        const contentTypes = await environment.getContentTypes();
        
        let html = `æ‰¾åˆ° ${contentTypes.items.length} å€‹å…§å®¹é¡å‹:\n\n`;
        
        contentTypes.items.forEach(ct => {
          html += `ğŸ“‹ ${ct.name} (${ct.sys.id})\n`;
          html += `   æè¿°: ${ct.description || 'ç„¡'}\n`;
          html += `   æ¬„ä½æ•¸é‡: ${ct.fields.length}\n`;
          
          // æª¢æŸ¥æ˜¯å¦æœ‰ scheduleItem ç›¸é—œçš„å…§å®¹é¡å‹
          if (ct.sys.id.includes('schedule') || ct.sys.id.includes('program')) {
            html += `   ğŸ¯ é€™å¯èƒ½æ˜¯ç¯€ç›®ç›¸é—œçš„å…§å®¹é¡å‹ï¼\n`;
            html += `   æ¬„ä½åˆ—è¡¨:\n`;
            ct.fields.forEach(field => {
              html += `     - ${field.name} (${field.id}): ${field.type}\n`;
            });
          }
          html += '\n';
        });

        resultDiv.innerHTML = html;
        resultDiv.className = 'result success';
        
      } catch (error) {
        resultDiv.innerHTML = `âŒ æª¢æŸ¥å…§å®¹é¡å‹å¤±æ•—: ${error.message}`;
        resultDiv.className = 'result error';
      }
    }

    // æª¢æŸ¥ API æ¬Šé™
    async function checkAPIPermissions() {
      const resultDiv = document.getElementById('apiPermissions');
      resultDiv.innerHTML = 'æ­£åœ¨æª¢æŸ¥ API æ¬Šé™...';
      
      try {
        const initialized = await initManagementClient();
        if (!initialized) {
          throw new Error('ç„¡æ³•åˆå§‹åŒ– Management å®¢æˆ¶ç«¯');
        }

        // å˜—è©¦ç²å–ç©ºé–“è³‡è¨Š
        const spaceInfo = await space.get();
        
        let html = `âœ… API æ¬Šé™æª¢æŸ¥é€šéï¼\n\n`;
        html += `ç©ºé–“åç¨±: ${spaceInfo.name}\n`;
        html += `ç©ºé–“ ID: ${spaceInfo.sys.id}\n`;
        html += `ç’°å¢ƒ: master\n\n`;

        // å˜—è©¦å‰µå»ºä¸€å€‹æ¸¬è©¦ Entryï¼ˆä¸ç™¼å¸ƒï¼‰
        try {
          const testEntry = await environment.createEntry('scheduleItem', {
            fields: {
              'title': { 'en-US': 'æ¸¬è©¦ç¯€ç›®' },
              'airDate': { 'en-US': '2024-01-01' },
              'block': { 'en-US': 'test' },
              'slotIndex': { 'en-US': 0 },
              'isPremiere': { 'en-US': false },
              'notes': { 'en-US': 'æ¸¬è©¦ç”¨' }
            }
          });
          
          html += `âœ… å¯ä»¥å‰µå»º scheduleItem Entry\n`;
          html += `æ¸¬è©¦ Entry ID: ${testEntry.sys.id}\n`;
          
          // åˆªé™¤æ¸¬è©¦ Entry
          await testEntry.delete();
          html += `âœ… å·²æ¸…ç†æ¸¬è©¦ Entry\n`;
          
        } catch (entryError) {
          html += `âŒ ç„¡æ³•å‰µå»º scheduleItem Entry: ${entryError.message}\n`;
          html += `é€™è¡¨ç¤ºå…§å®¹é¡å‹ 'scheduleItem' ä¸å­˜åœ¨æˆ–æ¬„ä½ä¸åŒ¹é…\n`;
        }

        resultDiv.innerHTML = html;
        resultDiv.className = 'result success';
        
      } catch (error) {
        resultDiv.innerHTML = `âŒ API æ¬Šé™æª¢æŸ¥å¤±æ•—: ${error.message}`;
        resultDiv.className = 'result error';
      }
    }

    // æ¸¬è©¦ä¸Šæ¶åŠŸèƒ½
    async function testUpload() {
      const resultDiv = document.getElementById('testUpload');
      resultDiv.innerHTML = 'æ­£åœ¨æ¸¬è©¦ä¸Šæ¶åŠŸèƒ½...';
      
      try {
        const initialized = await initManagementClient();
        if (!initialized) {
          throw new Error('ç„¡æ³•åˆå§‹åŒ– Management å®¢æˆ¶ç«¯');
        }

        // æ¸¬è©¦è³‡æ–™
        const testProgramData = {
          title: 'æ¸¬è©¦ç¯€ç›® - æ—¥æœ¬æ±äº¬æ™¨é–“æ¼«æ­¥',
          airDate: '2024-01-15',
          airTime: '14:30',
          duration: 30,
          category: 'äºæ´²æ—…éŠ',
          description: 'æ¸¬è©¦ç¯€ç›®æè¿°',
          status: 'scheduled',
          videoType: 'YouTube',
          youtubeId: 'dQw4w9WgXcQ'
        };

        resultDiv.innerHTML += `\næ¸¬è©¦è³‡æ–™: ${JSON.stringify(testProgramData, null, 2)}\n\n`;

        // å˜—è©¦ä¸Šæ¶
        const result = await uploadProgramSimple(testProgramData);
        
        if (result.success) {
          resultDiv.innerHTML += `âœ… æ¸¬è©¦ä¸Šæ¶æˆåŠŸï¼\n`;
          resultDiv.innerHTML += `Entry ID: ${result.entryId}\n`;
          resultDiv.className = 'result success';
        } else {
          resultDiv.innerHTML += `âŒ æ¸¬è©¦ä¸Šæ¶å¤±æ•—: ${result.error}\n`;
          resultDiv.className = 'result error';
        }
        
      } catch (error) {
        resultDiv.innerHTML += `âŒ æ¸¬è©¦ä¸Šæ¶ç•°å¸¸: ${error.message}\n`;
        resultDiv.className = 'result error';
      }
    }

    // é¡¯ç¤ºä¿®å¾©å»ºè­°
    function showFixSuggestions() {
      const resultDiv = document.getElementById('fixSuggestions');
      
      const suggestions = `
ğŸ”§ ä¿®å¾©å»ºè­°:

1. å…§å®¹é¡å‹å•é¡Œ:
   - æª¢æŸ¥ Contentful ä¸­æ˜¯å¦å­˜åœ¨ 'scheduleItem' å…§å®¹é¡å‹
   - å¦‚æœä¸å­˜åœ¨ï¼Œéœ€è¦å‰µå»ºæˆ–ä½¿ç”¨æ­£ç¢ºçš„å…§å®¹é¡å‹åç¨±

2. æ¬„ä½æ˜ å°„å•é¡Œ:
   - æª¢æŸ¥æ¬„ä½åç¨±æ˜¯å¦æ­£ç¢º (title, airDate, block, slotIndex, isPremiere, notes, video)
   - ç¢ºä¿æ‰€æœ‰å¿…å¡«æ¬„ä½éƒ½å·²è¨­å®š

3. æ¬Šé™å•é¡Œ:
   - ç¢ºèª Management Token æœ‰å‰µå»ºå’Œç™¼å¸ƒ Entry çš„æ¬Šé™
   - æª¢æŸ¥ Space ID æ˜¯å¦æ­£ç¢º

4. å»ºè­°çš„ä¿®å¾©æ­¥é©Ÿ:
   a) å…ˆé‹è¡Œã€Œæª¢æŸ¥å…§å®¹é¡å‹ã€åŠŸèƒ½
   b) æ ¹æ“šçµæœå‰µå»ºæˆ–ä¿®æ”¹å…§å®¹é¡å‹
   c) æ›´æ–°ç¨‹å¼ç¢¼ä¸­çš„æ¬„ä½æ˜ å°„
   d) é‡æ–°æ¸¬è©¦ä¸Šæ¶åŠŸèƒ½

5. ç·Šæ€¥ä¿®å¾©æ–¹æ¡ˆ:
   - å¦‚æœæ€¥éœ€ä¸Šæ¶ç¯€ç›®ï¼Œå¯ä»¥æš«æ™‚ä½¿ç”¨ç¾æœ‰çš„å…§å®¹é¡å‹
   - ä¿®æ”¹ uploadProgramSimple å‡½æ•¸ä¸­çš„æ¬„ä½æ˜ å°„
      `;
      
      resultDiv.innerHTML = suggestions;
      resultDiv.className = 'result warning';
    }

    // ç°¡åŒ–çš„ä¸Šæ¶åŠŸèƒ½ï¼ˆå¾ admin-calendar-unified.html è¤‡è£½ï¼‰
    async function uploadProgramSimple(programData) {
      try {
        console.log('ğŸš€ é–‹å§‹ä¸Šæ¶ç¯€ç›®:', programData);
        
        // æª¢æŸ¥ Management SDK
        if (typeof contentfulManagement === 'undefined') {
          throw new Error('Management SDK æœªè¼‰å…¥');
        }
        console.log('âœ… Management SDK å·²è¼‰å…¥');

        // æª¢æŸ¥ API Token
        const managementToken = window.CONTENTFUL_CONFIG?.MANAGEMENT_TOKEN || window.CONTENTFUL_MANAGEMENT_TOKEN;
        if (!managementToken) {
          throw new Error('Management Token æœªè¨­å®š');
        }
        console.log('âœ… Management Token å·²è¨­å®š');

        // å‰µå»º Management å®¢æˆ¶ç«¯
        const managementClient = contentfulManagement.createClient({
          accessToken: managementToken
        });

        // ç²å– Space å’Œ Environment
        const space = await managementClient.getSpace(window.CONTENTFUL_CONFIG?.SPACE_ID || 'os5wf90ljenp');
        const environment = await space.getEnvironment('master');
        console.log('âœ… å·²é€£æ¥åˆ° Contentful Space');

        // æº–å‚™è³‡æ–™
        const airDate = programData.airDate || new Date().toISOString().split('T')[0];
        const block = programData.airTime ? programData.airTime.split(':')[0] + ':00' : '12:00';
        const slotIndex = programData.airTime ? parseInt(programData.airTime.split(':')[1]) / 30 : 0;
        const notes = programData.description || '';

        // å‰µå»ºæˆ–ç²å–å½±ç‰‡ Entry
        let videoEntry = null;
        if (programData.videoType === 'YouTube' && programData.youtubeId) {
          try {
            // å˜—è©¦å‰µå»º video entry
            videoEntry = await environment.createEntry('video', {
              fields: {
                'title': { 'en-US': programData.title || 'æœªå‘½åå½±ç‰‡' },
                'youtubeId': { 'en-US': programData.youtubeId },
                'category': { 'en-US': programData.category || 'æ—…éŠç¯€ç›®' },
                'duration': { 'en-US': programData.duration || 30 }
              }
            });
            await videoEntry.publish();
            console.log('âœ… å½±ç‰‡ Entry å‰µå»ºæˆåŠŸ:', videoEntry.sys.id);
          } catch (error) {
            console.error('å‰µå»º video entry å¤±æ•—:', error);
            throw new Error('ç„¡æ³•å‰µå»ºå½±ç‰‡è³‡æ–™ï¼š' + error.message);
          }
        } else {
          throw new Error('å¿…é ˆæä¾› YouTube ID æ‰èƒ½ä¸Šæ¶ç¯€ç›®');
        }

        const entryData = {
          fields: {
            'title': { 'en-US': programData.title || 'æœªå‘½åç¯€ç›®' },
            'airDate': { 'en-US': airDate },
            'block': { 'en-US': block },
            'slotIndex': { 'en-US': slotIndex },
            'isPremiere': { 'en-US': programData.isFirstBroadcast || false },
            'notes': { 'en-US': notes },
            'video': { 
              'en-US': { 
                sys: { 
                  type: 'Link', 
                  linkType: 'Entry', 
                  id: videoEntry.sys.id 
                } 
              } 
            }
          }
        };
        
        console.log('æº–å‚™ä¸Šæ¶çš„ Entry è³‡æ–™:', entryData);

        // å‰µå»º Entry
        const contentTypeId = programData.contentType || 'scheduleItem';
        console.log('å‰µå»º Entryï¼ŒContent Type:', contentTypeId);
        const entry = await environment.createEntry(contentTypeId, entryData);
        console.log('âœ… Entry å‰µå»ºæˆåŠŸ:', entry.sys.id);
        
        // ç™¼å¸ƒ Entry
        console.log('ç™¼å¸ƒ Entry...');
        await entry.publish();
        console.log('âœ… Entry ç™¼å¸ƒæˆåŠŸ');
        
        return {
          success: true,
          entryId: entry.sys.id,
          message: 'ç¯€ç›®å·²æˆåŠŸä¸Šæ¶åˆ° Contentful'
        };
        
      } catch (error) {
        console.error('âŒ ä¸Šæ¶å¤±æ•—:', error);
        
        // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
        let errorMessage = error.message;
        if (error.message.includes('Management SDK')) {
          errorMessage = 'Management SDK æœªè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢';
        } else if (error.message.includes('Token')) {
          errorMessage = 'API Token è¨­å®šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é…ç½®';
        } else if (error.message.includes('Space')) {
          errorMessage = 'Space ID éŒ¯èª¤æˆ–ç„¡æ¬Šé™å­˜å–';
        } else if (error.message.includes('Content Type')) {
          errorMessage = 'Content Type ä¸å­˜åœ¨ï¼Œè«‹æª¢æŸ¥ Contentful è¨­å®š';
        }
        
        return {
          success: false,
          error: errorMessage,
          message: 'ç¯€ç›®ä¸Šæ¶å¤±æ•—: ' + errorMessage
        };
      }
    }

    // é é¢è¼‰å…¥å®Œæˆå¾Œè‡ªå‹•æª¢æŸ¥ç³»çµ±ç‹€æ…‹
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(checkSystemStatus, 1000);
    });
  </script>
</body>
</html>
