<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¿®å¾© Joanna å¸³è™Ÿ - ç®¡ç†å“¡ç³»çµ±</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      padding: 40px;
      max-width: 800px;
      margin: 0 auto;
    }
    
    .title {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
      font-size: 1.8rem;
    }
    
    .section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #e1e5e9;
      border-radius: 10px;
      background: #f8f9fa;
    }
    
    .section-title {
      color: #2b71d2;
      font-size: 1.2rem;
      margin-bottom: 15px;
      font-weight: 600;
    }
    
    .status {
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 0.9rem;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .btn {
      background: linear-gradient(135deg, #2b71d2, #1e5bb8);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      margin: 10px 5px;
      transition: all 0.3s ease;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(43, 113, 210, 0.3);
    }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
    }
    
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 1rem;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #2b71d2;
      box-shadow: 0 0 0 3px rgba(43, 113, 210, 0.1);
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(43, 113, 210, 0.3);
      border-radius: 50%;
      border-top-color: #2b71d2;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">ğŸ”§ ä¿®å¾© Joanna å¸³è™Ÿ</h1>
    
    <div class="section">
      <h2 class="section-title">å¸³è™Ÿè¨ºæ–·</h2>
      <div id="diagnosticStatus">
        <div class="status info">æ­£åœ¨è¨ºæ–·å¸³è™Ÿå•é¡Œ...</div>
      </div>
      <button class="btn" onclick="diagnoseAccount()">é‡æ–°è¨ºæ–·</button>
    </div>
    
    <div class="section">
      <h2 class="section-title">å¸³è™Ÿä¿®å¾©</h2>
      <div class="form-group">
        <label for="accountEmail">é›»å­éƒµä»¶ï¼š</label>
        <input type="email" id="accountEmail" value="joanna661229@yahoo.com.tw" readonly>
      </div>
      <div class="form-group">
        <label for="accountName">å§“åï¼š</label>
        <input type="text" id="accountName" value="ç¿å®›è±">
      </div>
      <div class="form-group">
        <label for="accountPassword">æ–°å¯†ç¢¼ï¼š</label>
        <input type="password" id="accountPassword" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼">
      </div>
      <div class="form-group">
        <label for="confirmPassword">ç¢ºèªå¯†ç¢¼ï¼š</label>
        <input type="password" id="confirmPassword" placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼">
      </div>
      <button class="btn" onclick="fixAccount()">ä¿®å¾©å¸³è™Ÿ</button>
      <div id="fixStatus" style="margin-top: 15px;"></div>
    </div>
    
    <div class="section">
      <h2 class="section-title">æ¸¬è©¦ç™»å…¥</h2>
      <button class="btn" onclick="testLogin()">æ¸¬è©¦ç™»å…¥</button>
      <div id="testStatus" style="margin-top: 15px;"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyB5MLyG5H1sCflHFU7WeKQCmC0Ft5TIqjM",
      authDomain: "tv-tcawg-com.firebaseapp.com",
      projectId: "tv-tcawg-com",
      storageBucket: "tv-tcawg-com.firebasestorage.app",
      messagingSenderId: "313251141126",
      appId: "1:313251141126:web:88ef97ce28798c0a2e9587",
      measurementId: "G-83Z5VTRTZH"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.firebaseApp = app;
    window.firebase9Loaded = true;
    
    // è¼‰å…¥ç®¡ç†å“¡å¸³è™Ÿæœå‹™
    const adminAccountsScript = document.createElement('script');
    adminAccountsScript.src = 'admin-accounts-firebase.js';
    adminAccountsScript.onload = () => {
      console.log('ç®¡ç†å“¡å¸³è™Ÿæœå‹™å·²è¼‰å…¥');
      // é é¢è¼‰å…¥å¾Œè‡ªå‹•è¨ºæ–·
      setTimeout(() => {
        diagnoseAccount();
      }, 1000);
    };
    document.head.appendChild(adminAccountsScript);
  </script>

  <script>
    // è¨ºæ–·å¸³è™Ÿå•é¡Œ
    async function diagnoseAccount() {
      const statusDiv = document.getElementById('diagnosticStatus');
      statusDiv.innerHTML = '<div class="status info">æ­£åœ¨è¨ºæ–·å¸³è™Ÿå•é¡Œ...</div>';
      
      try {
        const results = [];
        const targetEmail = 'joanna661229@yahoo.com.tw';
        
        // æª¢æŸ¥ Firebase é€£æ¥
        if (window.firebaseAuth && window.firebaseDb) {
          results.push('<div class="status success">âœ“ Firebase é€£æ¥æ­£å¸¸</div>');
        } else {
          results.push('<div class="status error">âœ— Firebase é€£æ¥å¤±æ•—</div>');
        }
        
        // æª¢æŸ¥ç®¡ç†å“¡å¸³è™Ÿæœå‹™
        if (window.adminAccountsService) {
          results.push('<div class="status success">âœ“ ç®¡ç†å“¡å¸³è™Ÿæœå‹™å·²è¼‰å…¥</div>');
          
          // æª¢æŸ¥å¸³è™Ÿæ˜¯å¦å­˜åœ¨
          const accountsData = await window.adminAccountsService.fetchAccountsData();
          const targetAccount = accountsData.accounts.find(acc => acc.email === targetEmail);
          
          if (targetAccount) {
            results.push(`<div class="status success">âœ“ æ‰¾åˆ°ç›®æ¨™å¸³è™Ÿ: ${targetAccount.name}</div>`);
            results.push(`<div class="status info">ç‹€æ…‹: ${targetAccount.status}</div>`);
            results.push(`<div class="status info">è§’è‰²: ${targetAccount.role}</div>`);
            results.push(`<div class="status info">å»ºç«‹æ™‚é–“: ${new Date(targetAccount.created_at).toLocaleString()}</div>`);
            
            // æª¢æŸ¥å¯†ç¢¼é›œæ¹Š
            if (targetAccount.password_hash) {
              results.push(`<div class="status success">âœ“ å¯†ç¢¼é›œæ¹Šå­˜åœ¨ (${targetAccount.password_hash.length} å­—ç¬¦)</div>`);
            } else {
              results.push(`<div class="status error">âœ— å¯†ç¢¼é›œæ¹Šä¸å­˜åœ¨</div>`);
            }
          } else {
            results.push(`<div class="status error">âœ— æ‰¾ä¸åˆ°ç›®æ¨™å¸³è™Ÿ: ${targetEmail}</div>`);
          }
        } else {
          results.push('<div class="status error">âœ— ç®¡ç†å“¡å¸³è™Ÿæœå‹™æœªè¼‰å…¥</div>');
        }
        
        // æª¢æŸ¥æœ¬åœ°å‚™ä»½
        const localBackup = localStorage.getItem('admin_accounts_backup');
        if (localBackup) {
          const backupData = JSON.parse(localBackup);
          const localAccount = backupData.accounts.find(acc => acc.email === targetEmail);
          if (localAccount) {
            results.push(`<div class="status success">âœ“ æœ¬åœ°å‚™ä»½ä¸­æ‰¾åˆ°å¸³è™Ÿ</div>`);
          } else {
            results.push(`<div class="status warning">âš  æœ¬åœ°å‚™ä»½ä¸­æ‰¾ä¸åˆ°å¸³è™Ÿ</div>`);
          }
        } else {
          results.push('<div class="status warning">âš  æœ¬åœ°å‚™ä»½ä¸å­˜åœ¨</div>');
        }
        
        statusDiv.innerHTML = results.join('');
        
      } catch (error) {
        statusDiv.innerHTML = `<div class="status error">âœ— è¨ºæ–·å¤±æ•—: ${error.message}</div>`;
      }
    }
    
    // ä¿®å¾©å¸³è™Ÿ
    async function fixAccount() {
      const email = document.getElementById('accountEmail').value;
      const name = document.getElementById('accountName').value;
      const password = document.getElementById('accountPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const statusDiv = document.getElementById('fixStatus');
      
      // é©—è­‰è¼¸å…¥
      if (!email || !name || !password || !confirmPassword) {
        statusDiv.innerHTML = '<div class="status error">è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½</div>';
        return;
      }
      
      if (password !== confirmPassword) {
        statusDiv.innerHTML = '<div class="status error">å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´</div>';
        return;
      }
      
      if (password.length < 8) {
        statusDiv.innerHTML = '<div class="status error">å¯†ç¢¼è‡³å°‘éœ€è¦8å€‹å­—ç¬¦</div>';
        return;
      }
      
      statusDiv.innerHTML = '<div class="status info">æ­£åœ¨ä¿®å¾©å¸³è™Ÿ...</div>';
      
      try {
        if (!window.adminAccountsService) {
          throw new Error('ç®¡ç†å“¡å¸³è™Ÿæœå‹™æœªè¼‰å…¥');
        }
        
        // ç²å–ç¾æœ‰å¸³è™Ÿè³‡æ–™
        const accountsData = await window.adminAccountsService.fetchAccountsData();
        let targetAccount = accountsData.accounts.find(acc => acc.email === email);
        
        if (targetAccount) {
          // æ›´æ–°ç¾æœ‰å¸³è™Ÿ
          console.log('æ›´æ–°ç¾æœ‰å¸³è™Ÿ:', targetAccount);
          targetAccount.name = name;
          targetAccount.password_hash = await window.adminAccountsService.hashPassword(password);
          targetAccount.updatedAt = new Date().toISOString();
          targetAccount.status = 'active';
          
          results.push(`<div class="status success">âœ“ å¸³è™Ÿå·²æ›´æ–°</div>`);
        } else {
          // å‰µå»ºæ–°å¸³è™Ÿ
          console.log('å‰µå»ºæ–°å¸³è™Ÿ');
          const newAccount = {
            id: `admin_${Date.now()}`,
            email: email,
            name: name,
            role: 'admin',
            permissions: ['read', 'write'],
            status: 'active',
            created_at: new Date().toISOString(),
            last_login: null,
            password_hash: await window.adminAccountsService.hashPassword(password)
          };
          
          accountsData.accounts.push(newAccount);
          results.push(`<div class="status success">âœ“ æ–°å¸³è™Ÿå·²å‰µå»º</div>`);
        }
        
        // æ›´æ–°è³‡æ–™
        accountsData.last_updated = new Date().toISOString();
        
        // å„²å­˜åˆ°æœ¬åœ°å‚™ä»½
        window.adminAccountsService.saveLocalBackup(accountsData);
        
        // åŒæ­¥åˆ° Firebase
        const syncResult = await window.adminAccountsService.syncToFirebase();
        if (syncResult) {
          statusDiv.innerHTML = `
            <div class="status success">âœ“ å¸³è™Ÿä¿®å¾©æˆåŠŸï¼å·²åŒæ­¥åˆ° Firebase</div>
            <div class="status info">å¸³è™Ÿ: ${email}</div>
            <div class="status info">å§“å: ${name}</div>
            <div class="status info">ç‹€æ…‹: å•Ÿç”¨</div>
          `;
        } else {
          statusDiv.innerHTML = `
            <div class="status warning">âš  å¸³è™Ÿä¿®å¾©æˆåŠŸï¼Œä½† Firebase åŒæ­¥å¤±æ•—</div>
            <div class="status info">å¸³è™Ÿ: ${email}</div>
            <div class="status info">å§“å: ${name}</div>
            <div class="status info">ç‹€æ…‹: å•Ÿç”¨ (åƒ…æœ¬åœ°)</div>
          `;
        }
        
        // æ¸…ç©ºå¯†ç¢¼æ¬„ä½
        document.getElementById('accountPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        
      } catch (error) {
        console.error('ä¿®å¾©å¸³è™Ÿå¤±æ•—:', error);
        statusDiv.innerHTML = `<div class="status error">âœ— ä¿®å¾©å¤±æ•—: ${error.message}</div>`;
      }
    }
    
    // æ¸¬è©¦ç™»å…¥
    async function testLogin() {
      const email = document.getElementById('accountEmail').value;
      const password = document.getElementById('accountPassword').value;
      const statusDiv = document.getElementById('testStatus');
      
      if (!password) {
        statusDiv.innerHTML = '<div class="status error">è«‹å…ˆè¼¸å…¥å¯†ç¢¼</div>';
        return;
      }
      
      statusDiv.innerHTML = '<div class="status info">æ­£åœ¨æ¸¬è©¦ç™»å…¥...</div>';
      
      try {
        if (!window.adminAccountsService) {
          throw new Error('ç®¡ç†å“¡å¸³è™Ÿæœå‹™æœªè¼‰å…¥');
        }
        
        const authResult = await window.adminAccountsService.authenticateUser(email, password);
        
        if (authResult) {
          statusDiv.innerHTML = `
            <div class="status success">âœ“ ç™»å…¥æ¸¬è©¦æˆåŠŸï¼</div>
            <div class="status info">ç”¨æˆ¶ ID: ${authResult.id}</div>
            <div class="status info">å§“å: ${authResult.name}</div>
            <div class="status info">è§’è‰²: ${authResult.role}</div>
            <div class="status info">æ¬Šé™: ${authResult.permissions.join(', ')}</div>
          `;
        } else {
          statusDiv.innerHTML = '<div class="status error">âœ— ç™»å…¥æ¸¬è©¦å¤±æ•—ï¼šå¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤</div>';
        }
        
      } catch (error) {
        console.error('æ¸¬è©¦ç™»å…¥å¤±æ•—:', error);
        statusDiv.innerHTML = `<div class="status error">âœ— æ¸¬è©¦å¤±æ•—: ${error.message}</div>`;
      }
    }
  </script>
</body>
</html>
